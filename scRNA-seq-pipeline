vi refdata-cellranger-GRCh38-3.0.0/star/genomeParameters.txt
### STAR   --runMode genomeGenerate   --runThreadN 1   --genomeDir /mnt/yard2/pat/cr/new-refs/reference_buildscripts2/GRCh38/star   --genomeFastaFiles /mnt/yard2/pat/cr/new-refs/reference_buildscripts2/GRCh38/fasta/genome.fa      --genomeSAindexNbases 14   --genomeChrBinNbits 18   --genomeSAsparseD 3   --limitGenomeGenerateRAM 17179869184   --sjdbGTFfile /mnt/yard2/pat/cr/new-refs/reference_buildscripts2/GRCh38/genes/genes.gtf
versionGenome   20201
genomeFastaFiles        /mnt/yard2/pat/cr/new-refs/reference_buildscripts2/GRCh38/fasta/genome.fa
genomeSAindexNbases     14  
genomeChrBinNbits       18  
genomeSAsparseD 3
sjdbOverhang    100 
sjdbFileChrStartEnd     -   
sjdbGTFfile     /mnt/yard2/pat/cr/new-refs/reference_buildscripts2/GRCh38/genes/genes.gtf
sjdbGTFchrPrefix        -   
sjdbGTFfeatureExon      exon
sjdbGTFtagExonParentTranscript  transcript_id
sjdbGTFtagExonParentGene        gene_id
sjdbInsertSave  Basic

cellranger6 count --id=run_count_1kpbmcs --fastqs=/lab/solexa_page/linyong/run_cellranger_count/pbmc_1k_v3_fastqs --sample=pbmc_1k_v3 --transcriptome=/lab/solexa_page/linyong/run_cellranger_count/refdata-cellranger-GRCh38-3.0.0

### Step 1:
### You had fastq files for each scRNA library. To generate single cell feature (gene) counts for a single library, run cellranger count. You can set the parameter --expect-cells=10000 and the option –nosecondary when running the count command.
### 
### Run cellranger count for each library. If you have 10 libraries, you need to run 10 times with 10 outputs. Often, one sample (or one donor) is one library.
### 
### Please note that, by default, --include-introns option is turned off, meaning that intronic reads were excluded from the UMI counting.
### 
### Step 2:
### Step1 will generate filtered_feature_bc_matrix directory, among other outputs, for each library. Then use an R package Seurat. The following web site gives a nice documentation to merge multiple library outputs from cellranger into a single Seurat object. ### 
### https://satijalab.org/seurat/archive/v3.1/merge_vignette.html
### 
### 
### 
### With the single Seurat object generated, you can continue the downstream traditional analysis with scRNA-seq data.

ls run_count_1kpbmcs/outs/filter*matrix/ -lh
total 12M

-rw-r--r-- 1 linyong input 6.9K Jan 22 21:03 barcodes.tsv.gz
-rw-r--r-- 1 linyong input 298K Jan 22 21:03 features.tsv.gz
-rw-r--r-- 1 linyong input 9.0M Jan 22 21:03 matrix.mtx.gz

pbmc.data <- Read10X(data.dir = "filtered_feature_bc_matrix")
pbmc <- CreateSeuratObject(counts = pbmc.data, project = "pbmc3k", min.cells = 3, min.features = 200)
dim(pbmc)
##[1] 15287  1183
###no filtering, [1] 33538  1225 
pbmc[["percent.mt"]] <- PercentageFeatureSet(pbmc, pattern = "^MT-")
# Show QC metrics for the first 5 cells
head(pbmc@meta.data, 10)
#                    orig.ident nCount_RNA nFeature_RNA percent.mt
# AAACCCAAGGAGAGTA-1     pbmc3k       8509         2660  10.706311
# AAACGCTTCAGCCCAG-1     pbmc3k       5572         1826   7.914573
# AAAGAACAGACGACTG-1     pbmc3k       4318         1574   6.160259
# AAAGAACCAATGGCAG-1     pbmc3k       2788         1236   5.989957
# AAAGAACGTCTGCAAT-1     pbmc3k       6662         1854   6.604623
# AAAGGATAGTAGACAT-1     pbmc3k       8942         2062   7.906509

# Visualize QC metrics as a violin plot
VlnPlot(pbmc, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

# FeatureScatter is typically used to visualize feature-feature relationships, but can be used
# for anything calculated by the object, i.e. columns in object metadata, PC scores etc.

plot1 <- FeatureScatter(pbmc, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(pbmc, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot1 + plot2

###based on plot1 + plot2
pbmc <- subset(pbmc, subset = nFeature_RNA > 200 & nFeature_RNA < 5000 & percent.mt < 20)
dim(pbmc)
# [1] 15287  1115 (94% of 1183 cells)
pbmc <- NormalizeData(pbmc, normalization.method = "LogNormalize", scale.factor = 10000)

pbmc <- FindVariableFeatures(pbmc, selection.method = "vst", nfeatures = 2000)

# Identify the 10 most highly variable genes
top10 <- head(VariableFeatures(pbmc), 10)

# plot variable features with and without labels
plot1 <- VariableFeaturePlot(pbmc)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot1 + plot2

all.genes <- rownames(pbmc)
pbmc <- ScaleData(pbmc, features = all.genes)

pbmc <- RunPCA(pbmc, features = VariableFeatures(object = pbmc))
DimPlot(pbmc, reduction = "pca")
ElbowPlot(pbmc)
pbmc <- FindNeighbors(pbmc, dims = 1:10)
pbmc <- FindClusters(pbmc, resolution = 0.5)
#Number of communities: 8
# Look at cluster IDs of the first 5 cells
head(Idents(pbmc), 5)
# If you haven't installed UMAP, you can do so via reticulate::py_install(packages =
# 'umap-learn')
pbmc <- RunUMAP(pbmc, dims = 1:10)
# note that you can set `label = TRUE` or use the LabelClusters function to help label
# individual clusters
DimPlot(pbmc, reduction = "umap")
DimPlot(pbmc, reduction = "umap", label=T)
saveRDS(pbmc, file = "../output/pbmc_tutorial.rds")

> install.packages("https://seurat.nygenome.org/src/contrib/ifnb.SeuratData_3.0.0.tar.gz", repos = NULL, type = "source")
> library(ifnb.SeuratData)
> LoadData("ifnb")

## Not run:
if (requireNamespace(Seurat, quietly = TRUE)) {
  url <- 'https://www.dropbox.com/s/79q6dttg8yl20zg/immune_alignment_expression_matrices.zip?dl=1'
  dl.name <- gsub(pattern = '\\?dl=1', replacement = '', x = basename(path = url))
  curl::curl_download(url = url, destfile = dl.name)
  unzip(zipfile = dl.name, exdir = tools::file_path_sans_ext(x = dl.name))
  ctrl.data <- read.table(file = file.path(tools::file_path_sans_ext(x = dl.name), 'immune_control_expression_matrix.txt.gz'), sep = '\t')
  stim.data <- read.table(file = file.path(tools::file_path_sans_ext(x = dl.name), 'immune_stimulated_expression_matrix.txt.gz'), sep = '\t')
  ctrl <- Seurat::CreateSeuratObject(counts = ctrl.data, project = 'IMMUNE_CTRL', min.cells = 5)
  ctrl$stim <- 'CTRL'
  ctrl <- subset(x = ctrl, subset = nFeature_RNA > 500)   
  stim <- Seurat::CreateSeuratObject(counts = stim.data, project = 'IMMUNE_STIM', min.cells = 5)
  stim$stim <- 'STIM'
  stim <- subset(x = stim, subset = nFeature_RNA > 500)
  ifnb <- merge(x = ctrl, y = stim) 
  Seurat::Project(object = ifnb) <- 'ifnb'
  # Annotations come from Seurat's stimulated/control guided clustering without the Mono/Mk doublets
  # https://satijalab.org/seurat/v3.0/immune_alignment.html
  annotations <- readRDS(file = system.file('extdata/annotations/annotations.Rds', package = 'ifnb.SeuratData'))
  ifnb <- Seurat::AddMetaData(object = ifnb, metadata = annotations)
  # Clean up downlaoded files
  file.remove(dl.name)
  unlink(x = tools::file_path_sans_ext(x = dl.name), recursive = TRUE)
}

## End(Not run)

library(SeuratData)
InstallData('pbmc3k')
  ..@ meta.data   :'data.frame':        2700 obs. of  4 variables:
  .. ..$ orig.ident        : Factor w/ 1 level "pbmc3k": 1 1 1 1 1 1 1 1 1 1 ...
  .. ..$ nCount_RNA        : num [1:2700] 2419 4903 3147 2639 980 ...
  .. ..$ nFeature_RNA      : int [1:2700] 779 1352 1129 960 521 781 782 790 532 550 ...
  .. ..$ seurat_annotations: Factor w/ 9 levels "Naive CD4 T",..: 2 4 2 3 7 2 5 5 1 6 ...
pbmc <- pbmc3k
# The [[ operator can add columns to object metadata. This is a great place to stash QC stats
pbmc[["percent.mt"]] <- PercentageFeatureSet(pbmc, pattern = "^MT-")
pbmc <- NormalizeData(pbmc, normalization.method = "LogNormalize", scale.factor = 10000)
pbmc <- FindVariableFeatures(pbmc, selection.method = "vst", nfeatures = 2000)
all.genes <- rownames(pbmc)
pbmc <- ScaleData(pbmc, features = all.genes)
pbmc <- RunPCA(pbmc, features = VariableFeatures(object = pbmc))
ElbowPlot(pbmc)
pbmc <- FindNeighbors(pbmc, dims = 1:10)
pbmc <- FindClusters(pbmc, resolution = 0.5)
# If you haven't installed UMAP, you can do so via reticulate::py_install(packages =
# 'umap-learn')
pbmc <- RunUMAP(pbmc, dims = 1:10)
# note that you can set `label = TRUE` or use the LabelClusters function to help label
# individual clusters
DimPlot(pbmc, reduction = "umap")
new.cluster.ids <- c("Naive CD4 T", "CD14+ Mono", "Memory CD4 T", "B", "CD8 T", "FCGR3A+ Mono",
    "NK", "DC", "Platelet")
names(new.cluster.ids) <- levels(pbmc)
pbmc <- RenameIdents(pbmc, new.cluster.ids)
DimPlot(pbmc, reduction = "umap", label = TRUE, pt.size = 0.5) + NoLegend()

> cluster5.markers <- FindMarkers(pbmc, ident.1 = 0, ident.2 = c(2), min.pct = 0.25)
  |++++++++++++++++++++++++++++++++++++++++++++++++++| 100% elapsed=00s
> head(cluster5.markers, n = 20)
                p_val avg_log2FC pct.1 pct.2    p_val_adj
S100A4   1.090806e-47 -1.0891751 0.700 0.929 1.495931e-43
MALAT1   2.781540e-37  0.5023381 1.000 1.000 3.814604e-33
B2M      9.190424e-32 -0.3039140 1.000 1.000 1.260375e-27
RPL32    1.601655e-29  0.3089689 0.999 1.000 2.196510e-25
VIM      4.413449e-28 -0.6620801 0.810 0.944 6.052605e-24
ACTB     3.144174e-27 -0.5397110 0.984 1.000 4.311920e-23
S100A11  2.612274e-25 -0.8518047 0.289 0.621 3.582473e-21

write.table( Idents(pbmc), "temp.txt", quote=F, sep="\t")
cp -i temp.txt   pbmc3k.clustering.annot.txt
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine  temp.txt      pbmc3k.azimuth.anno.txt  out
paste  temp.txt    out | cut -f 3,12,13 > temp.2.txt

> azh <- read.delim("temp.2.txt")
> pbmc$cell.azh <- azh$cell
> pbmc$azh.annot <- azh$predicted.celltype.l2
> pbmc$azh.annot.score <- azh$predicted.celltype.l2.score
> t <- data.frame(pbmc$nCount_RNA, pbmc$cell.azh)
> i = 2700
> rownames(t)[i] == t$pbmc.cell.azh[i]
[1] TRUE
> DimPlot(pbmc, reduction = "umap", label = F, pt.size = 0.5, group.by="azh.annot", cols=c(rep("gray", 5), "red", "green", "orange", "blue",  rep("gray", 15)))
> cluster5.markers <- FindMarkers(pbmc, ident.1 = "CD4 Naive", ident.2 = "CD4 TCM", group.by="azh.annot", min.pct = 0.25)
> write.table(cluster5.markers, "temp.3.txt", quote=F, sep="\t")

#############################################################################
###SingleR
> library(celldex)
> ref.data <- MonacoImmuneData()
> unique(ref.data$label.main)
 [1] "CD8+ T cells"    "T cells"         "CD4+ T cells"    "Progenitors"     "B cells"         "Monocytes"
 [7] "NK cells"        "Dendritic cells" "Neutrophils"     "Basophils"
> unique(ref.data$label.fine)
 [1] "Naive CD8 T cells"             "Central memory CD8 T cells"    "Effector memory CD8 T cells"
 [4] "Terminal effector CD8 T cells" "MAIT cells"                    "Vd2 gd T cells"
 [7] "Non-Vd2 gd T cells"            "Follicular helper T cells"     "T regulatory cells"
[10] "Th1 cells"                     "Th1/Th17 cells"                "Th17 cells"
[13] "Th2 cells"                     "Naive CD4 T cells"             "Progenitor cells"
[16] "Naive B cells"                 "Non-switched memory B cells"   "Exhausted B cells"
[19] "Switched memory B cells"       "Plasmablasts"                  "Classical monocytes"
[22] "Intermediate monocytes"        "Non classical monocytes"       "Natural killer cells"
[25] "Plasmacytoid dendritic cells"  "Myeloid dendritic cells"       "Low-density neutrophils"
[28] "Low-density basophils"         "Terminal effector CD4 T cells"

library(SingleR)
library(SeuratData)
InstallData('pbmc3k')
pbmc <- pbmc3k
m <- as.matrix(pbmc@assays$RNA@counts)
summary(m[,1:12])
ref.data <- celldex::HumanPrimaryCellAtlasData()
ref.data
# class: SummarizedExperiment
# dim: 19363 713
pred <- SingleR(test = m , ref = ref.data,  labels =  ref.data$label.fine, assay.type.test=1)
write.table(data.frame(cell=colnames(m), label= pred$labels), "temp2", quote=F, sep = "\t")
vi temp2
cut -f 2,3 temp2 > temp2.2
mv -i temp2.2 pbmc3k.CellAtlas.singleR.annot.txt
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine         pbmc3k.clustering.annot.txt pbmc3k.CellAtlas.singleR.annot.txt out

/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine   pbmc3k.clustering.annot.txt pbmc3k.Monaco.singleR.annot.txt  out
paste  pbmc3k.clustering.annot.txt out > temp.2
cat temp.2 | cut -f 2,4 | sort | uniq -c | sed 's/^ *//' | sed 's/  */\t/' | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 == "Naive CD4 T" ' | sort -nr | cut -f 1,3 | sed 's/^/ /'

pbmc.avg.exp <- AverageExpression(pbmc, group.by="ident", slot="data", verbose=T)
dim(pbmc.avg.exp$RNA)
###[1] 13714-RNA-features     9-clusters
summary(pbmc.avg.exp$RNA)
       0                  1                  2                   3                   4                  5
 Min.   :  0.0000   Min.   :  0.0000   Min.   :  0.00000   Min.   :  0.00000   Min.   :  0.0000   Min.   :  0.0000
 1st Qu.:  0.0179   1st Qu.:  0.0154   1st Qu.:  0.01832   1st Qu.:  0.01731   1st Qu.:  0.0165   1st Qu.:  0.0142
 Median :  0.0740   Median :  0.0686   Median :  0.07907   Median :  0.08325   Median :  0.0865   Median :  0.0678
 Mean   :  0.7292   Mean   :  0.7292   Mean   :  0.72918   Mean   :  0.72918   Mean   :  0.7292   Mean   :  0.7292
10000/13714
####[1] 0.7291819
ref.data <- MonacoImmuneData()
pred <- SingleR(test = pbmc.avg.exp$RNA , ref = ref.data,  labels =  ref.data$label.fine, assay.type.test=1)
> data.frame(pred$first.labels, pred$labels, pred$pruned.labels)
        pred.first.labels             pred.labels      pred.pruned.labels
1       Naive CD4 T cells               Th1 cells               Th1 cells
2     Classical monocytes     Classical monocytes     Classical monocytes
3               Th2 cells          Th1/Th17 cells          Th1/Th17 cells
4           Naive B cells           Naive B cells           Naive B cells
5          Vd2 gd T cells          Vd2 gd T cells          Vd2 gd T cells
6  Intermediate monocytes  Intermediate monocytes  Intermediate monocytes
7    Natural killer cells    Natural killer cells    Natural killer cells
8 Myeloid dendritic cells Myeloid dendritic cells Myeloid dendritic cells
9  Intermediate monocytes        Progenitor cells        Progenitor cells

###################################################################
###clustering on CD4/CD8 cells only
> pbmc.cd4.cd8 <- pbmc[,pbmc$RNA_snn_res.0.5 %in% c(0,2,4)]
> pbmc.cd4.cd8
An object of class Seurat
13714 features across 1502 samples within 1 assay
Active assay: RNA (13714 features, 2000 variable features)
 2 dimensional reductions calculated: pca, umap
> 696 + 467 + 339
[1] 1502

> pbmc.cd4.cd8 <- FindVariableFeatures(pbmc.cd4.cd8, selection.method = "vst", nfeatures = 2000)
all.genes <- rownames(pbmc.cd4.cd8)
pbmc.cd4.cd8 <- ScaleData(pbmc.cd4.cd8, features = all.genes)
pbmc.cd4.cd8 <- RunPCA(pbmc.cd4.cd8, features = VariableFeatures(object = pbmc.cd4.cd8))
ElbowPlot(pbmc.cd4.cd8)
pbmc.cd4.cd8 <- FindNeighbors(pbmc.cd4.cd8, dims = 1:10)
pbmc.cd4.cd8 <- FindClusters(pbmc.cd4.cd8, resolution = 0.5)
pbmc.cd4.cd8 <- RunUMAP(pbmc.cd4.cd8, dims = 1:10)
DimPlot(pbmc.cd4.cd8, reduction = "umap")
write.table( Idents(pbmc.cd4.cd8), "temp.txt", quote=F, sep="\t")
vi temp.txt
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine   temp.txt  pbmc3k.azimuth.anno.txt   out

https://satijalab.org/seurat/articles/integration_introduction.html
###copied from above website
###14053 features across 13999 samples within 1 assay

library(Seurat)
library(SeuratData)
library(patchwork)
# install dataset
InstallData("ifnb")
# load dataset
LoadData("ifnb")

# split the dataset into a list of two seurat objects (stim and CTRL)
ifnb.list <- SplitObject(ifnb, split.by = "stim")

# normalize and identify variable features for each dataset independently
ifnb.list <- lapply(X = ifnb.list, FUN = function(x) {
    x <- NormalizeData(x)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000)
})

# select features that are repeatedly variable across datasets for integration
features <- SelectIntegrationFeatures(object.list = ifnb.list)
immune.anchors <- FindIntegrationAnchors(object.list = ifnb.list, anchor.features = features)
# this command creates an 'integrated' data assay
immune.combined <- IntegrateData(anchorset = immune.anchors)
# specify that we will perform downstream analysis on the corrected data note that the
# original unmodified data still resides in the 'RNA' assay
DefaultAssay(immune.combined) <- "integrated"

# Run the standard workflow for visualization and clustering
immune.combined <- ScaleData(immune.combined, verbose = FALSE)
immune.combined <- RunPCA(immune.combined, npcs = 30, verbose = FALSE)
immune.combined <- RunUMAP(immune.combined, reduction = "pca", dims = 1:30)
immune.combined <- FindNeighbors(immune.combined, reduction = "pca", dims = 1:30)
immune.combined <- FindClusters(immune.combined, resolution = 0.5) 
###15 clusters, 
#1799 CD4 Memory T
#2525 CD4 Naive T
# 779 CD8 T

DimPlot(immune.combined, reduction = "umap", label = TRUE, repel = TRUE)
FeaturePlot(immune.combined, features = c("CD3D", "SELL", "CREM", "CD8A", "GNLY", "CD79A", "FCGR3A",
    "CCL2", "PPBP"), min.cutoff = "q9")
    
####azimuth query data mapped to reference
library(Seurat)
library(SeuratDisk)
library(ggplot2)
library(patchwork)

setwd("/Users/linyongmao/Documents/scRNA-seq-1")
reference <- LoadH5Seurat("./pbmc_multimodal.h5seurat")
DimPlot(object = reference, reduction = "wnn.umap", group.by = "celltype.l2", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()
library(SeuratData)
InstallData("ifnb")
LoadData("ifnb")
#########
ifnb1 <- subset( ifnb, subset= stim == "STIM" )

pbmc3k <- SCTransform(ifnb1, verbose = T)
###Set default assay to SCT
anchors <- FindTransferAnchors(
  reference = reference,
  query = pbmc3k,
  normalization.method = "SCT",
  reference.reduction = "spca",
  dims = 1:50
)
### Normalizing query using reference SCT model
### Projecting cell embeddings
### Finding neighborhoods
### Finding anchors
# [1] "CTRL" 6548 samples 
#     "STIM" 7451 samples
###ctrl         Found 3728 anchors
###STIM         Found 971 anchors
pbmc3k <- MapQuery(
  anchorset = anchors,
  query = pbmc3k,
  reference = reference,
  refdata = list(
    celltype.l1 = "celltype.l1",
    celltype.l2 = "celltype.l2",
    predicted_ADT = "ADT"
  ),
  reference.reduction = "spca",
  reduction.model = "wnn.umap"
)

DimPlot(pbmc3k, reduction = "ref.umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 ,repel = TRUE)
FeaturePlot(pbmc3k, features = c("CD4 Naive", "CD4 TCM"),  reduction = "ref.umap", cols = c("lightgrey", "darkred"), ncol = 2) & theme(plot.title = element_text(size = 10))
FeaturePlot(pbmc3k, features = c("CD8 Naive", "CD8 TCM", "CD8 TEM"),  reduction = "ref.umap", cols = c("lightgrey", "darkred"), ncol = 3) & theme(plot.title = element_text(size = 10))

###### gene expression per cell type per donor, azimuth ref data set
> ref.count <- CreateSeuratObject(counts = reference@assays$SCT@counts, meta.data = reference@meta.data)
> ref.1 <- subset(ref.count, subset = donor == "P1")
> ref.1 <- NormalizeData(ref.1, normalization.method = "LogNormalize", scale.factor = 10000)
> ref.1.avg <- AverageExpression(ref.1, group.by="celltype.l2", slot="data", verbose=T)
> dim(ref.1.avg$RNA)
###20729    31
> summary(ref.1.avg$RNA)
> write.table(ref.1.avg$RNA, "temp-P1.txt", quote = F, sep="\t")
> t1 = unique(ref.count$donor)
for(i in 1:length(t1)) {
 print(t1[i])
 ref.1 <- subset(ref.count, subset = donor == t1[i])
 ref.1 <- NormalizeData(ref.1, normalization.method = "LogNormalize", scale.factor = 10000)
 ref.1.avg <- AverageExpression(ref.1, group.by="celltype.l2", slot="data", verbose=T)
 dim(ref.1.avg$RNA)
 f <- paste("temp", t1[i], sep = "-")
 print(f)
 write.table(ref.1.avg$RNA, f, quote = F, sep="\t")
 }

#
ls temp-P[1-8] | while read ll
do
 cat "$ll" | awk 'NR == 1 ' | sed 's/^/gene     /' > "$ll".head
 cat "$ll" | awk 'NR > 1' >> "$ll".head
done

paste temp-P1.head temp-P2.head    temp-P3.head    temp-P4.head    temp-P5.head    temp-P6.head    temp-P7.head temp-P8.head > temp.1.txt
% cat temp-scr2
#
cat temp.1.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"}
 {
  for(i = 33; i <= NF; i = i+32)
  {
   if($1 == $i)
     print "eq";
   else
     print "not";
  }
  print "line"
 }'

% bash temp-scr2 |  uniq -c | sort | uniq -c
#20730    1 line
#20730    7 eq
mv -i temp.1.txt azimuth.8donors.celltype.avg-expression.txt
> par(pin=c(12,3))
> boxplot(as.numeric( t3$V2) ~ t3$V1, las =2, xlab = "")

t1 <- read.delim("azimuth.8donors.celltype.avg-expression.txt", header = F)
par(pin=c(12,3))

gene = "CD8A"
t2 <- as.data.frame( t(rbind(t1[1,], t1[t1$V1 == gene,])))
t3 <- t2[ t2[,1] != "gene",]
boxplot( as.numeric(t3[,2]) ~ t3[,1], las=2, xlab = "")
abline(h = seq(0,200,1), lty = 5, lwd = 0.5, col = "gray")
tit <- paste(gene, "average expression per donor", sep = " ")
title(main = tit, cex = 0.5)

#############################################################################
### mouse scRNA-seq microglia
ls *mtx.gz | sed 's/-filtered-matrix.mtx.gz//' | while read dir
do
 mkdir dir-"$dir"
 ls "$dir"*
 mv "$dir"* dir-"$dir"
done

mv *-barcodes.tsv.gz barcodes.tsv.gz
mv *features.tsv.gz features.tsv.gz
mv *matrix.mtx.gz matrix.mtx.gz

ls  | grep dir- | grep -v dir-GSM4039241_f-ctrl-1 | while read dir
do
 cd "$dir"
 mv *-barcodes.tsv.gz barcodes.tsv.gz
 mv *features.tsv.gz features.tsv.gz
 mv *matrix.mtx.gz matrix.mtx.gz

 cd ..
done

ls | grep dir-GSM | while read dir
do
 echo -n "$dir\t"
 echo "$dir" | sed 's/dir-GSM[0-9]*_//'
done

cat nameDir-id 
dir-GSM4039241_f-ctrl-1	f-ctrl-1
dir-GSM4039242_f-ctrl-2	f-ctrl-2
dir-GSM4039243_f-tumor-1	f-tumor-1
dir-GSM4039244_f-tumor-2	f-tumor-2
dir-GSM4039245_m-ctrl-1	m-ctrl-1
dir-GSM4039246_m-ctrl-2	m-ctrl-2
dir-GSM4039247_m-tumor-1	m-tumor-1
dir-GSM4039248_m-tumor-2	m-tumor-2

setwd("/Users/linyongmao/Documents/microglia-mouse")

t1 <- read.delim("nameDir-id", header=F)
ss <- list()
for(i in 1:dim(t1)[1])
{
 mic.data <- Read10X(data.dir = t1[i, 1])
 ss[[i]] <- CreateSeuratObject(counts = mic.data, project = t1[i, 2], min.cells = 5)
}

t2 <- ss[[2]]
for(i in 3:8)
{
 t2 <- c(t2, ss[[i]])
}

mg <- merge(ss[[1]], y = t2, project = "microglia")
Warning message:
#In CheckDuplicateCellNames(object.list = objects) :
#  Some cell names are duplicated across objects provided. Renaming to enforce unique cell names.

mg
# An object of class Seurat 
# 14618 features across 41059 samples within 1 assay 
# Active assay: RNA (14618 features, 0 variable features)

for(i in 1:8)
{
 print(ss[[i]])
}
 
-rw-r--r--@ 1 linyongmao  staff   1.7M Jul  4 14:26 Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip
2022 July downloaded

-rw-r--r--  1 linyongmao  staff   765M Jul  4 13:58 gencode.vM10.annotation.gtf
Release M10 (GRCm38.p4)
https://www.gencodegenes.org/mouse/release_M10.html
2022 July downloaded

#13 MT protein coding genes
mg[["percent.mt"]] <- PercentageFeatureSet(mg, pattern = "^mt-")
> # Visualize QC metrics as a violin plot
> VlnPlot(mg, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
> plot(mg$nCount_RNA, mg$percent.mt, ylim=c(0,25), cex=0.3 )
mg[ , mg$percent.mt < 10]
> plot(mg$nCount_RNA, mg$nFeature_RNA,  cex=0.3 )
> abline(h = seq(0,10000,500), lty = 5, lwd = 0.5, col = "gray")
> abline(v = seq(0,50000,5000), lty = 5, lwd = 0.5, col = "gray")
> mg[, mg$nFeature_RNA > 200 & mg$nFeature_RNA < 3000 & mg$percent.mt < 5 ]
> mg[, mg$nFeature_RNA > 500 & mg$nFeature_RNA < 3000 & mg$percent.mt < 5 ]

mg.1 <- mg[, mg$nFeature_RNA > 200 & mg$nFeature_RNA < 3000 & mg$percent.mt < 5 ]
## 14618 features across 40401 samples within 1 assay
ifnb.list <- SplitObject(mg.1, split.by = "orig.ident")
# normalize and identify variable features for each dataset independently
ifnb.list <- lapply(X = ifnb.list, FUN = function(x) {
    x <- NormalizeData(x)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000)
})
# select features that are repeatedly variable across datasets for integration
features <- SelectIntegrationFeatures(object.list = ifnb.list)
immune.anchors <- FindIntegrationAnchors(object.list = ifnb.list, anchor.features = features)
##Retained 5826 anchors
##  |++++++++++++++++++++++++++++++++++++++++++++++++++| 100% elapsed=59m 29s
# this command creates an 'integrated' data assay
immune.combined <- IntegrateData(anchorset = immune.anchors)
# specify that we will perform downstream analysis on the corrected data note that the
# original unmodified data still resides in the 'RNA' assay
DefaultAssay(immune.combined) <- "integrated"

# Run the standard workflow for visualization and clustering
immune.combined <- ScaleData(immune.combined, verbose = FALSE)
immune.combined <- RunPCA(immune.combined, npcs = 30, verbose = TRUE)
immune.combined <- RunUMAP(immune.combined, reduction = "pca", dims = 1:30)
immune.combined <- FindNeighbors(immune.combined, reduction = "pca", dims = 1:30)
immune.combined <- FindClusters(immune.combined, resolution=0.3)
# Number of nodes: 40401
# Number of edges: 1652874
# Number of communities: 19

DimPlot(immune.combined, reduction = "umap", label = TRUE, repel = TRUE)

> saveRDS(immune.anchors, file="anchors.rds")
> DefaultAssay(immune.combined) <- "RNA"
>  ref.1.avg <- AverageExpression(immune.combined, group.by="integrated_snn_res.0.1", slot="data", verbose=T)
>  write.table(ref.1.avg$RNA, "avg-exp-allgenes-reso-0.1-10clusters.txt", quote = F, sep="\t")
> sum((ref.1.avg$RNA[,1]))
[1] 10000
> sum((ref.1.avg$RNA[,2]))
[1] 10000
> summary(ref.1.avg$RNA)
       0                  1                  2                  3                   4                  5                  6                  7                  8            
 Min.   :  0.0000   Min.   :  0.0000   Min.   :  0.0000   Min.   :  0.00000   Min.   :  0.0000   Min.   :  0.0000   Min.   :  0.0000   Min.   :  0.0000   Min.   :   0.0000  
 1st Qu.:  0.0093   1st Qu.:  0.0106   1st Qu.:  0.0100   1st Qu.:  0.00780   1st Qu.:  0.0137   1st Qu.:  0.0078   1st Qu.:  0.0086   1st Qu.:  0.0196   1st Qu.:   0.0000  
 Median :  0.0995   Median :  0.0880   Median :  0.1034   Median :  0.06687   Median :  0.0936   Median :  0.0678   Median :  0.0859   Median :  0.1214   Median :   0.0293  
 Mean   :  0.6841   Mean   :  0.6841   Mean   :  0.6841   Mean   :  0.68409   Mean   :  0.6841   Mean   :  0.6841   Mean   :  0.6841   Mean   :  0.6841   Mean   :   0.6841  
 3rd Qu.:  0.3751   3rd Qu.:  0.3284   3rd Qu.:  0.3895   3rd Qu.:  0.28298   3rd Qu.:  0.3332   3rd Qu.:  0.2903   3rd Qu.:  0.3149   3rd Qu.:  0.3938   3rd Qu.:   0.1900  
 Max.   :789.5800   Max.   :518.9368   Max.   :642.9373   Max.   :301.27950   Max.   :390.8133   Max.   :382.9453   Max.   :825.4658   Max.   :644.5161   Max.   :1423.5979  

> t1 <- ref.1.avg$RNA
g1 <- scan(what="", sep = "\n")
Tmem119
Cd14
P2ry12
Tgfbi
Ifitm2
Ifitm3
S100a6
Ly6c2
Ccr2
Mrc1
Cd163
Cd24a
Ncam1
Klrk1
Ncr1
Cd2
Cd3d
Cd4
Cd8b1
Ms4a1
Lgals3

#####P2ry12, Sparc, Tmem119, Gpr34, Selplg, and Cx3cr1 (refs. 19,42) in MG, Mo—Ly6i and Ly6c2, and MΦ genes—Ifitm3 (ref. 10) in Mo/MΦ, and BAM genes—Apoe, Ms4a7, and Mrc1
P2ry12
Sparc
Tmem119
Gpr34
Selplg
Cx3cr1
Ly6i
Ly6c2
Ifitm3
Apoe
Ms4a7
Mrc1
Lgals3

t1.g <- t1[ rownames(t1) %in% g1, ]
dim(t1.g)

mat <- as.matrix(t1.g)
write.table(immune.combined@meta.data, "temp-meta-data.txt", quote=F, sep="\t" )
DefaultAssay(immune.combined) <- "RNA"
ref.1.avg <- AverageExpression(immune.combined, group.by="integrated_snn_res.0.6", slot="data", verbose=T)
sum(ref.1.avg$RNA[,1])
[1] 10000
ref.data <- MouseRNAseqData()
pred <- SingleR(test = ref.1.avg$RNA , ref = ref.data,  labels =  ref.data$label.fine, assay.type.test=1)
data.frame(pred$first.labels, pred$labels, pred$pruned.labels)
### install.packages("pheatmap")
library(pheatmap)
### install.packages("viridis")
library(viridis)
plotScoreHeatmap(pred)
plotDeltaDistribution(pred, ncol = 3)
####column #15 for cluster 14
pred <- SingleR(test = ref.1.avg$RNA[,c(15, 9, 8,18)] , ref = ref.data,  labels =  ref.data$label.fine, assay.type.test=1)
plotScoreHeatmap(pred)
> ref.data <- celldex::ImmGenData()

> ref.tam.avg <- AverageExpression(immune.combined, group.by="orig.ident", slot="data", verbose=T)
sum(ref.tam.avg$RNA[,1:8])
###[1] 80000

for g in `echo REL  RELB    NFKB2   NFKBIE  NFKBIA  NFKB1`
do
awk '$2 == "'$g'"' Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip
done > temp.1

cat temp.1 | cut -f 1 | while read g
do
###grep 1 gene 1 minute
grep -w $g gencode.vM10.annotation.gtf  | awk '$3 == "gene"'
done > temp.2

cat temp.2 | cut -f 9 | awk 'BEGIN {FS = ";"} {print $4}' | sed 's/ gene_name //' | sed 's/"//g' | sed 's/ *//'

g1 <- scan(what="", sep = "\n")
ref.tam.avg$RNA[ rownames(ref.tam.avg$RNA) %in% g1, ]
t1 <- ref.tam.avg$RNA[ rownames(ref.tam.avg$RNA) %in% g1, ]
for(i in 1:dim(t1)[1])
{
 t2 <- t.test(t1[i, 1:2], t1[i, 3:4])
 t3 <- t.test(t1[i, 5:6], t1[i, 7:8])
 str <- paste(rownames(t1)[i], t2$p.value, log2(t2$estimate[2] / t2$estimate[1]), 
 t3$p.value, log2(t3$estimate[2] / t3$estimate[1]), sep = "\t" )
 cat(str)
 cat("\n")
}

### t.test
sink("mouse.clusts.micro.female.tum.t.test.txt")
for(i in 1:dim(t1)[1])
{
 t2 <- t.test(t1[i, 1:2], t1[i, 3:4])
 str <- paste(rownames(t1)[i], t2$p.value, log2(t2$estimate[2] / t2$estimate[1]),
  sep = "\t" )
 cat(str)
 cat("\n")
}
sink()

######t.test result to .rnk file. ###cat te-script-ttest-op2rnk 
# 
 echo "geneID	p-value	logFC" > temp
 cat mouse.clusts.micro.female.tum.t.test.txt | sed 's/	Inf/123456789/' | sed 's/	-Inf/-123456789/' >> temp
 mv temp mouse.clusts.micro.female.tum.t.test.txt
 /Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine mouse.clusts.micro.female.tum.t.test.txt  M10.geneID-name-chr-type.2.name-first.txt out
paste mouse.clusts.micro.female.tum.t.test.txt   out | grep -vw notApplicable |
awk 'BEGIN {FS = "\t"; OFS = "\t"; ORS = ""}
{
print $6;
for(i = 1; i <= NF; i++)
{
 if(i != 6)
 {
  print "\t" $i;
 }
}
print "\n"
}' > mouse.clusts.micro.female.tum.t.test.geneID.txt
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine  mouse.clusts.micro.female.tum.t.test.geneID.txt Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip out
paste mouse.clusts.micro.female.tum.t.test.geneID.txt out | grep -vw notApplicable > mouse.clusts.micro.female.tum.t.test.human.gene.name.txt 
cat mouse.clusts.micro.female.tum.t.test.human.gene.name.txt  | awk 'BEGIN {FS = "\t"; OFS = "\t"; ORS = ""}
{
print $2, $4,$5,$6, $3, $7, $8, $10, $11 "\n"}' > temp
/Users/linyongmao/Documents/microglia/make-rnk-genesymble temp mouse.clusts.micro.female.tum.t.test.human.gene.name.rnk

> Heatmap(matrix =log2(mat+1), name = "log2(expr)", clustering_distance_columns="spearman", clustering_method_columns="complete", column_names_side = "top")
######################################################################################
### voom DEG testing, scRNA-seq psuedo-bulk, cluster #0, male mouse, tumor vs control
immune.0 <- immune.combined[, immune.combined$integrated_snn_res.0.6 == 0] ###5748 cells in cluster 0
DefaultAssay(immune.0) <- "RNA"
ref.0.avg <- AverageExpression(immune.0, group.by="orig.ident", slot="data", verbose=T)
sum(ref.0.avg$RNA[,1])
###[1] 10000
t1 <-  ref.0.avg$RNA[,5:8] * 100 ### * 100, turn to tpm
keep <-rowSums(t1 >= 1) >= 2
t1 <- t1[keep,]
dim(t1)
g <- c("m-c","m-c","m-t", "m-t")
mm <- model.matrix(~g)
y <- voom(counts = as.matrix(t1), design=mm, plot=T)
fit <- lmFit(y, mm)
tmp <- contrasts.fit(fit, coef = 2) # test "gm-t" coefficient
tmp <- eBayes(tmp)
top.table <- topTable(tmp, sort.by = "P", n = Inf)
head(top.table, 20)
write.table(top.table, "temp.clust.0.m.tum.txt", quote=F, sep="\t")

sed '1 s/^/geneID   /' temp.clust.0.m.tum.txt > temp
mv temp temp.clust.0.m.tum.txt
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine  temp.clust.0.m.tum.txt  M10.geneID-name-chr-type.2.name-first.txt out
paste temp.clust.0.m.tum.txt   out | grep -vw notApplicable |
awk 'BEGIN {FS = "\t"; OFS = "\t"; ORS = ""}
{
print $10;
for(i = 1; i <= NF; i++)
{
 if(i != 10)
 {
  print "\t" $i;
 }
}
print "\n"
}' > temp.clust.0.m.tum.geneID.txt

/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine    temp.clust.0.m.tum.geneID.txt  Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip out
paste  temp.clust.0.m.tum.geneID.txt  out | grep -vw notApplicable > temp.clust.0.m.tum.human.gene.name.txt
cat temp.clust.0.m.tum.human.gene.name.txt | cut -f 2-6,7,10,14 > temp
/Users/linyongmao/Documents/microglia/make-rnk-genesymble temp temp.clust.0.m.tum.human.gene.rnk


####################################### cluster #0, female mouse, tumor vs control
DefaultAssay(immune.0) <- "RNA"
ref.0.avg <- AverageExpression(immune.0, group.by="orig.ident", slot="data", verbose=T)
sum(ref.0.avg$RNA[,1])
###[1] 10000
t1 <-  ref.0.avg$RNA[,1:4] * 100 ### * 100, turn to tpm 
keep <-rowSums(t1 >= 1) >= 2
t1 <- t1[keep,]
dim(t1)
# 10989     4 
g <- c("f-c","f-c","f-t", "f-t")
mm <- model.matrix(~g)
y <- voom(counts = as.matrix(t1), design=mm, plot=T)
fit <- lmFit(y, mm)
tmp <- contrasts.fit(fit, coef = 2) # test "gf-t" coefficient
tmp <- eBayes(tmp)
top.table <- topTable(tmp, sort.by = "P", n = Inf)
head(top.table, 20)
#               logFC   AveExpr         t      P.Value    adj.P.Val         B
# Ifitm3    3.8488483  5.321071 15.543203 5.729872e-08 0.0006296556 6.7523914
# Rtp4      2.8398411  5.457652 13.469757 2.060527e-07 0.0011321568 6.7137824
# Ifi27l2a  3.7520950  5.648972 12.471517 4.074820e-07 0.0014926065 6.0981774
# H2-D1     1.0923742  9.961997  9.635695 3.830362e-06 0.0085751606 4.5733087


write.table(top.table, "temp.clust.0.f.tum.txt", quote=F, sep="\t")
###add geneID as header in 1st line 1st column
vi temp.clust.0.f.tum.txt
cat gencode.vM10.annotation.gtf | awk 'BEGIN{FS = "\t"} $3 == "gene"' | cut -f 1,9 | sed 's/;/       /g' | cut -f 1,2,3,4,5 > temp-1

awk 'BEGIN {FS = "\t"; OFS = "\t"; ORS = ""} 
{
 print $5, $1, $2, $3, $4 "\n";
}' M10.geneID-name-chr-type.2.txt > M10.geneID-name-chr-type.2.name-first.txt

/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine  temp.clust.0.f.tum.txt  M10.geneID-name-chr-type.2.name-first.txt out
paste temp.clust.0.f.tum.txt   out | grep -vw notApplicable | 
awk 'BEGIN {FS = "\t"; OFS = "\t"; ORS = ""}
{
print $10;
for(i = 1; i <= NF; i++)
{
 if(i != 10)
 {
  print "\t" $i;
 }
}
print "\n"
}' > temp.clust.0.f.tum.geneID.txt  

/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine    temp.clust.0.f.tum.geneID.txt  Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip out
paste  temp.clust.0.f.tum.geneID.txt  out | grep -vw notApplicable > temp.clust.0.f.tum.human.gene.name.txt
cat temp.clust.0.f.tum.human.gene.name.txt | cut -f 2-6,7,10,14 > temp
/Users/linyongmao/Documents/microglia/make-rnk-genesymble temp temp.clust.0.f.tum.human.gene.rnk

bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx   /Users/linyongmao/Documents/h.all.v7.4.symbols.gmt    -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk  temp.clust.0.m.tum.human.gene.rnk  -rpt_label   "temp.mice.clust.0.m_TAM.prerank_p.v7.4"  -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"
### -set_min 15

#############################################################################
### scRNA-seq whole pathway level z-score
mic <- c(0:5,7,9,14)
immune.mic <- immune.combined[, immune.combined$integrated_snn_res.0.6 %in% mic] ###5748 cells in cluster 0
immune.mic
# 16618 features across 31165 (out of 40401) samples within 2 assays
DefaultAssay(immune.mic) <- "RNA"
ref.0.avg <- AverageExpression(immune.mic, group.by="orig.ident", slot="data", verbose=T)
sum(ref.0.avg$RNA[,1])
t1 <-  ref.0.avg$RNA * 100 ### * 100, turn to tpm
summary(t1)
t2 <- as.matrix(t1)
summary(t2)
med <- data.frame( t2[,1])
med$logic <- TRUE
for(i in 1:dim(t2)[1]) {
 med$logic[i] <- median(t2[i,]) >= 1
}
t2<-t2[med$logic,]
dim(t2)
# [1] 10941     8
a <- t2
b = log10(a+1)
for(i in 1:dim(b)[1])
{
 a[i, ] <- (b[i, ] - mean(as.numeric(b[i,]))) / var(as.numeric(b[i,]))^(1/2)
}
###a is z-score of log10(cpm+1)
x1 <- read.delim("Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip")
head(x1)
#                   ID Gene.Symbol                                                                Gene.Title
# 1 ENSMUSG00000000001       GNAI3             G protein subunit alpha i3 [Source:HGNC Symbol;Acc:HGNC:4387]
x2 <- read.delim("M10.geneID-name-chr-type.2.txt")
a2 <- as.data.frame(a)
a2$name <- rownames(a2)
###################################################
#############x2, geneID is not unique, duplicated gene names
a2.x <- merge(a2, x2, by.x="name", by.y = "geneID")
a3.x <- merge(a2.x, x1, by.x="ID", by.y="ID")
f <- read.delim("/Users/linyongmao/Documents/microglia/temp-files-2", header=F)
dim(f)
# [1] 50 pathways,  1
i = 25
f[i,1]
p <- read.delim(paste("/Users/linyongmao/Documents/microglia/", f[i,1], sep=""), header=F)
p.exp <- a3.x[ a3.x$Gene.Symbol %in% p$V1, ]
length(p.exp$Gene.Symbol)
# [1] 120 genes in the inflamm pathway through mouse-human gene  mapping
mat <- as.matrix(p.exp[, c(3:10)])
res <- data.frame(id = colnames(mat), mean = colMeans(mat))
info <- c("f-ctrl", "f-ctrl", "f-tumor", "f-tumor", "m-ctrl", "m-ctrl", "m-tumor", "m-tumor")
res$group <- info
boxplot(res$mean ~ res$group, xlab = "", ylab = "z-score avg of all genes")
title(main=paste(length(mic), "microglia", "clusters\n", f[i,1]))
beeswarm(res$mean ~ res$group, pch = c(16,16,17,17), col = c("green", "red", "green", "red" ), cex = 2, add = T)
abline(h = seq(-10,10,0.05), lty = 5, lwd = 0.5, col = "gray")

################################################################################
### aggregate counts per sample, edgeR
> BiocManager::install("SingleCellExperiment")
Warning message:
package(s) not installed when version(s) same as current; use `force = TRUE` to re-install: 'SingleCellExperiment'
> library(SingleCellExperiment)
#Attaching package: ‘SingleCellExperiment’
#The following object is masked from ‘package:edgeR’:
#    cpm

counts <- immune.mic@assays$RNA@counts
metadata <- immune.mic@meta.data
metadata$cluster_id <- metadata$integrated_snn_res.0.6
# Create single cell experiment object
sce <- SingleCellExperiment(assays = list(counts = counts),
                           colData = metadata)
# Identify groups for aggregation of counts
# groups: character class
groups <- colData(sce)[, c("orig.ident")]
# Aggregate across cluster-sample groups
pb <- aggregate.Matrix(t(counts(sce)),
                       groupings = groups, fun = "sum")

class(pb)

dim(pb)
# [1]     8 14618
pb[1:8, 1:6] # 8 samples
t1 <- as.data.frame(t(pb))
head(t1)
dim(t1)
group <- factor(rep(1, 8))
y <- DGEList(counts=t1,group=group)
y <- calcNormFactors(y)
# $samples
#           group lib.size norm.factors
# f-ctrl-1      1 10341169    1.0646442
# f-ctrl-2      1 10532754    1.0679185
# f-tumor-1     1  8254301    0.9430448
# f-tumor-2     1 10370699    0.9643678
# m-ctrl-1      1  8868850    1.0664425
# m-ctrl-2      1  9519282    1.0567604
# m-tumor-1     1  7168687    0.9162843
# m-tumor-2     1  8580658    0.9365655

mds <- plotMDS(y, top=98765)

#############################################################################
###aggregate counts of scRNA-seq per sample, then using edgeR ,female DEG
t2 <- t1[, 1:4]
head(t2)
#         f-ctrl-1 f-ctrl-2 f-tumor-1 f-tumor-2
# Sox17          0        0         0         0
# Mrpl15       652      618       475       626
group <- factor(rep(1, 4))
y <- DGEList(counts=t2,group=group)
y <- calcNormFactors(y)
keep <-rowSums(edgeR::cpm(y)>=1) >= 2
y<-y[keep,]
dim(y)
# 11195  genes in female after filtering;
g <- c("f-c","f-c","f-t", "f-t")
design <- model.matrix(~g)
y <- estimateDisp(y,design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, coef=2)
top2v1 <- topTags(qlf, n = 91234)
write.table(top2v1, "diff2-1.txt", sep="\t", quote = F)

sed '1 s/^/geneID   /' mouse.clusts.micro.female.diff2-1.edgeR.txt > temp 
mv temp mouse.clusts.micro.female.diff2-1.edgeR.txt
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine  mouse.clusts.micro.female.diff2-1.edgeR.txt  M10.geneID-name-chr-type.2.name-first.txt out
paste mouse.clusts.micro.female.diff2-1.edgeR.txt   out | grep -vw notApplicable |
awk 'BEGIN {FS = "\t"; OFS = "\t"; ORS = ""}
{
print $9;
for(i = 1; i <= NF; i++)
{
 if(i != 9)
 {
  print "\t" $i;
 }
}
print "\n"
}' > mouse.clusts.micro.female.diff2-1.edgeR.geneID.txt

/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine    mouse.clusts.micro.female.diff2-1.edgeR.geneID.txt  Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip out
paste  mouse.clusts.micro.female.diff2-1.edgeR.geneID.txt  out | grep -vw notApplicable > mouse.clusts.micro.female.diff2-1.edgeR.human.gene.name.txt
cat mouse.clusts.micro.female.diff2-1.edgeR.human.gene.name.txt | cut -f 2-8,13 > temp
head -3 temp       
/Users/linyongmao/Documents/microglia/make-rnk-genesymble temp mouse.clusts.micro.female.diff2-1.edgeR.human.gene.rnk

bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx   /Users/linyongmao/Documents/h.all.v7.4.symbols.gmt    -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk  mouse.clusts.micro.female.diff2-1.edgeR.human.gene.rnk  -rpt_label   "mouse.clusts.micro.female.edgeR_TAM.prerank_p.v7.4"  -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

###male DEG
t2 <- t1[, 5:8]
head(t2)
group <- factor(rep(1, 4))
y <- DGEList(counts=t2,group=group)
y <- calcNormFactors(y)
y
keep <-rowSums(edgeR::cpm(y)>=1) >= 2
y<-y[keep,]
dim(y)
# 11150 genes in male after filtering;
g <- c("m-c","m-c","m-t", "m-t")
design <- model.matrix(~g)
y <- estimateDisp(y,design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, coef=2)
top2v1 <- topTags(qlf, n = 91234)
write.table(top2v1, "diff2-1.txt", sep="\t", quote = F)

sed '1 s/^/geneID   /' mouse.clusts.micro.male.diff2-1.edgeR.txt > temp
mv temp mouse.clusts.micro.male.diff2-1.edgeR.txt
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine  mouse.clusts.micro.male.diff2-1.edgeR.txt  M10.geneID-name-chr-type.2.name-first.txt out
paste mouse.clusts.micro.male.diff2-1.edgeR.txt   out | grep -vw notApplicable |
awk 'BEGIN {FS = "\t"; OFS = "\t"; ORS = ""}
{
print $9;
for(i = 1; i <= NF; i++)
{
 if(i != 9)
 {
  print "\t" $i;
 }
}
print "\n"
}' > mouse.clusts.micro.male.diff2-1.edgeR.geneID.txt

/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine    mouse.clusts.micro.male.diff2-1.edgeR.geneID.txt  Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip out
paste  mouse.clusts.micro.male.diff2-1.edgeR.geneID.txt  out | grep -vw notApplicable > mouse.clusts.micro.male.diff2-1.edgeR.human.gene.name.txt
cat mouse.clusts.micro.male.diff2-1.edgeR.human.gene.name.txt | cut -f 2-8,13 > temp
head -3 temp
/Users/linyongmao/Documents/microglia/make-rnk-genesymble temp mouse.clusts.micro.male.diff2-1.edgeR.human.gene.rnk

bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx   /Users/linyongmao/Documents/h.all.v7.4.symbols.gmt    -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk  mouse.clusts.micro.male.diff2-1.edgeR.human.gene.rnk  -rpt_label   "mouse.clusts.micro.male.edgeR_TAM.prerank_p.v7.4"  -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

#############################################################################
###make .gmt file 
echo -n "female-noCereb.noOcci-upreg-pe2\tmicroglia-p-value-0.01" > temp-1
cat ../microglia/female-noCereb.noOcci-diff2-1.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 >= -log(0.01)/log(10)' |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} {print "\t" $1}' >> temp-1
echo >> temp-1

echo -n "female-tumResecOnly-upreg-pe2\tmicroglia-p-value-0.01" >> temp-1
cat ../microglia/female-14samps.tumResecOnly.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 >= -log(0.01)/log(10)' |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} {print "\t" $1}' >> temp-1
echo >> temp-1

echo -n "female-all39samples-upreg-pe2\tmicroglia-p-value-0.01" >> temp-1
cat ../microglia/female-diff2-1-filtgenesFirst.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 >= -log(0.01)/log(10)' |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} {print "\t" $1}' >> temp-1
echo >> temp-1

echo -n "male-noCereb.noOcci-upreg-pe2\tmicroglia-p-value-0.01" >> temp-1
cat ../microglia/male-noCereb.noOcci-diff2-1.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 >= -log(0.01)/log(10)' |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} {print "\t" $1}' >> temp-1
echo >> temp-1

echo -n "male-tumResecOnly-upreg-pe2\tmicroglia-p-value-0.01" >> temp-1
cat ../microglia/M-17samps.tumResecOnly.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 >= -log(0.01)/log(10)' |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} {print "\t" $1}' >> temp-1
echo >> temp-1

echo -n "male-all39samples-upreg-pe2\tmicroglia-p-value-0.01" >> temp-1
cat ../microglia/male-diff2-1-filtgenesFirst.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 >= -log(0.01)/log(10)' |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} {print "\t" $1}' >> temp-1
echo >> temp-1

cat ../microglia/onco-supp-genes-glio.gmt >> temp-1
cat ../DDX3X_targets.gmt >> temp-1

mv -i  temp-1 microglia-TAM.gmt

bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx    microglia-TAM.gmt   -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk  mouse.clusts.micro.female.diff2-1.edgeR.human.gene.rnk  -rpt_label   "mouse.clusts.micro.female.edgeR_TAM.prerank.human.geneSet.v7.4"  -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

########### .gmt file - down-reg-genes
echo -n "female-noCereb.noOcci-downreg-pe2\tmicroglia-p-value-0.01" > temp-1
cat ../microglia/female-noCereb.noOcci-diff2-1.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 <= log(0.01)/log(10)' |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} {print "\t" $1}' >> temp-1
echo >> temp-1

echo -n "female-tumResecOnly-downreg-pe2\tmicroglia-p-value-0.01" >> temp-1
cat ../microglia/female-14samps.tumResecOnly.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 <= log(0.01)/log(10)' |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} {print "\t" $1}' >> temp-1
echo >> temp-1

echo -n "female-all39samples-downreg-pe2\tmicroglia-p-value-0.01" >> temp-1
cat ../microglia/female-diff2-1-filtgenesFirst.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 <= log(0.01)/log(10)' |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} {print "\t" $1}' >> temp-1
echo >> temp-1

echo -n "male-noCereb.noOcci-downreg-pe2\tmicroglia-p-value-0.01" >> temp-1
cat ../microglia/male-noCereb.noOcci-diff2-1.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 <= log(0.01)/log(10)' |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} {print "\t" $1}' >> temp-1
echo >> temp-1

echo -n "male-tumResecOnly-downreg-pe2\tmicroglia-p-value-0.01" >> temp-1
cat ../microglia/M-17samps.tumResecOnly.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 <= log(0.01)/log(10)' |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} {print "\t" $1}' >> temp-1
echo >> temp-1

echo -n "male-all39samples-downreg-pe2\tmicroglia-p-value-0.01" >> temp-1
cat ../microglia/male-diff2-1-filtgenesFirst.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 <= log(0.01)/log(10)' |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} {print "\t" $1}' >> temp-1
echo >> temp-1

cat  temp-1 >> microglia-TAM.gmt

bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx    microglia-TAM.gmt   -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk  mouse.clusts.micro.male.diff2-1.edgeR.human.gene.rnk  -rpt_label   "mouse.clusts.micro.male.edgeR_TAM.prerank.human.geneSet"  -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

cat mouse.clusts.micro.female.diff2-1.edgeR.human.gene.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 >= -log(0.01)/log(10)'  | wc -l
cat mouse.clusts.micro.female.diff2-1.edgeR.human.gene.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 <= log(0.01)/log(10)'  | wc -l
cat mouse.clusts.micro.male.diff2-1.edgeR.human.gene.rnk   | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 >= -log(0.01)/log(10)'  | wc -l
cat mouse.clusts.micro.male.diff2-1.edgeR.human.gene.rnk   | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 <= log(0.01)/log(10)'  | wc -l

#############################################################################
###hypergeometric testing; human_DEG\tmouse_DEG\t#ofbg_genes\toverlap_genes\
echo "human_DEG\tmouse_DEG\t#ofbg_genes\toverlap_genes\texpected_overlap\tenrichment\tenrich_p-value" > temp-res
cat ../microglia/female-diff2-1-filtgenesFirst.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 >= - log(0.01)/log(10)' | cut -f 1 | sort | uniq > temp-human
cat mouse.clusts.micro.female.diff2-1.edgeR.human.gene.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 >= - log(0.01)/log(10)' | cut -f 1 | sort | uniq > temp-mouse
cat ../microglia/female-diff2-1-filtgenesFirst.rnk | cut -f 1 | sort | uniq > temp-1
cat mouse.clusts.micro.female.diff2-1.edgeR.human.gene.rnk | cut -f 1 | sort | uniq > temp-2
cat temp-1 temp-2| sort | uniq -d > temp-bg

cat temp-human temp-bg | sort | uniq -d > temp-3
mv temp-3 temp-human
cat temp-mouse temp-bg | sort | uniq -d > temp-4
mv temp-4 temp-mouse

h=`wc -l temp-human | awk '{print $1}' `
m=`wc -l temp-mouse | awk '{print $1}' `
ov=`cat temp-human temp-mouse | sort | uniq -d | wc -l | awk '{print $1}' `
bg=`wc -l temp-bg | awk '{print $1}' `
ep=` echo "$h\t$m\t$bg" | awk '{print $1 * $2 / $3}'  `
rich=` echo "$ep\t$ov" | awk '{print  $2 / $1}' `
echo "$h\t$m\t$bg\t$ov\t$ep\t$rich" > temp-res-r-ip
###must after temp-res-r-ip file generated
p_val=`Rscript R-script-hypergeo-1 | awk '{print $2}' `
echo "$h\t$m\t$bg\t$ov\t$ep\t$rich\t$p_val" >> temp-res

cat temp-res

####
cat ../microglia/female-diff2-1-filtgenesFirst.rnk | cut -f 1 | sort | uniq > temp-1
cat mouse.clusts.micro.female.diff2-1.edgeR.human.gene.rnk | cut -f 1 | sort | uniq > temp-2
wc -l temp-1 temp-2
cat temp-1 temp-2| sort | uniq -d | wc -l
#   16835 temp-1
#   10037 temp-2
#   26872 total
#    9418

#############################################################################
### make female logFC (tumor vs control, only two samples per group, median) based gene rank file
immune.anchors <- readRDS("anchors.rds")
......
> immune.combined <- FindClusters(immune.combined, resolution=0.6)
Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck

Number of nodes: 40401
Number of edges: 1650579

Maximum modularity in 10 random starts: 0.8882
Number of communities: 22

####temp-1, female 4 samples, cpm, filtered out low expr genes
write.table(edgeR::cpm(y), "temp-1", quote=F, sep="\t")
vi temp-1
cat temp-1 | awk '
BEGIN {FS = "\t"; OFS = "\t"} 
{
 if(NR == 1)
 {
  print $0, "log2FC";
 }
 else
 {
  c=($2 + $3 + 0.5*2) /2;
  t=($4 + $5 + 0.5*2) /2;
  fc= log(t/c) / log(2);
  print $0, fc;
 }
}
' > temp-2
###how many identical logFC
cat temp-2 | cut -f 6 | sort | uniq -c | awk '$1 > 2'
cat temp-2 | awk 'NR > 1' | sort -t '       ' +5 -6g | tail -n 20
wl=`cat temp-2 | awk 'NR > 1' | wc -l | awk '{print $1}'`
echo $wl
cat temp-2 | awk 'NR > 1' | sort -t '	' +5 -6g | awk '
{
 print $0 "\t" NR "\t"  1- NR/'$wl';
}
' > temp-3 
echo "geneID	rank" > temp-4
cat temp-3 | cut -f 1,8 >> temp-4
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine    temp-4 M10.geneID-name-chr-type.2.name-first.txt out
paste    temp-4  out | grep -vw notApplicable | awk 'BEGIN {FS = "\t"; OFS = "\t"; ORS = ""}
{
print $5;
for(i = 1; i <= NF; i++)
{
 if(i != 5)
 {
  print "\t" $i;
 }
}
print "\n"
}' > temp-4.tum.geneID.txt
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine   temp-4.tum.geneID.txt Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip out
paste   temp-4.tum.geneID.txt  out | grep -vw notApplicable  > temp-5
cat temp-5 | awk 'BEGIN {FS = "\t"; OFS = "\t"; ORS = ""}
NR > 1 {print $9,$3,$10 "\n"}' > mouse-female-logFC-rank-scRNA-edgeR

##SERBP1	0.170076	SERPINE1 mRNA binding protein 1 [Source:HGNC Symbol;Acc:HGNC:17860]
./make-rnk-genesymble.logFC mouse-female-logFC-rank-scRNA-edgeR mouse-female-logFC-rank-scRNA-edgeR.combDupGenes

#############################################################################
# F vs M t-test mouse scRNA-seq
f <- read.delim("mouse-female-logFC-rank-scRNA-edgeR.combDupGenes", header=F)
m <- read.delim("mouse-male-logFC-rank-scRNA-edgeR.combDupGenes", header=F)
paths <- read.delim("temp-path-files", header=F)
sink("temp-res.txt")
str <- paste("pathway", "female-rank-mean", "male-rank-mean", "mean diff (f-m)", "numOfUnionDEGS", "t-test p-value", sep = "\t" )
cat(str)
cat("\n")
for(i in 1:dim(paths)[1]) {
 genes <- read.delim(file=paths[i,1], header=F)
 f.rnk <- f[ f$V1 %in% genes$V1, ]$V2
 m.rnk <- m[ m$V1 %in% genes$V1, ]$V2
 res <- t.test(f.rnk, m.rnk)

 m1 <- mean(f.rnk, na.rm=T)
 m2 <- mean(m.rnk, na.rm=T)
 str <- paste(paths[i,1],m1,m2,m1-m2,length(f.rnk), res$p.value, sep = "\t" )
 cat(str)
 cat("\n")
}

sink()

###paired t-test
f <- read.delim("mouse-female-logFC-rank-scRNA-edgeR.combDupGenes", header=F)
m <- read.delim("mouse-male-logFC-rank-scRNA-edgeR.combDupGenes", header=F)
paths <- read.delim("temp-path-files", header=F)
sink("temp-res.txt")
str <- paste("pathway", "female-rank-mean", "male-rank-mean", "mean diff (f-m)", "numOfAllexpressedGenesF-MIntersect", "paired t-test p-value", sep = "\t" )
cat(str)
cat("\n")
for(i in 1:dim(paths)[1]) {
genes <- read.delim(file=paths[i,1], header=F)
 f.rnk <- f[ f$V1 %in% genes$V1, ]
 m.rnk <- m[ m$V1 %in% genes$V1, ]
t2 <- merge(f.rnk, m.rnk, by.x = "V1", by.y= "V1")
res <- t.test(t2$V2.x, t2$V2.y, paired=T)

 m1 <- mean(t2$V2.x, na.rm=T)
 m2 <- mean(t2$V2.y, na.rm=T)
 str <- paste(paths[i,1],m1,m2,m1-m2,dim(t2)[1], res$p.value, sep = "\t" )
 cat(str)
 cat("\n")
}

sink()

###using gene ranks that are based edgeR signed log10 p-values; vs logFC of medians(cpm+0.01) of two groups derived gene ranks
file <- read.delim("/Users/linyongmao/gsea_home/output/microgliaSex/mouse.clusts.micro.female.edgeR_TAM.prerank_p.v7.4.GseaPreranked.1658354084959/HALLMARK_E2F_TARGETS.tsv")
f <- file$RANK.IN.GENE.LIST / 10037
file <- read.delim("/Users/linyongmao/gsea_home/output/microgliaSex/mouse.clusts.micro.male.edgeR_TAM.prerank_p.v7.4.GseaPreranked.1658355450441/HALLMARK_E2F_TARGETS.tsv")
m <- file$RANK.IN.GENE.LIST / 10001
t.test(f,m)
###probably wilcox test more robust, median of ttest and ks test
wilcox.test(f,m)
ks.test(f,m)


#############################################################################
# sex:tumor interaction, mouse scRNA-seq 
group <- factor(rep(1, 8))
y <- DGEList(counts=t1,group=group)
y <- calcNormFactors(y)
keep <-rowSums(edgeR::cpm(y)>=1) >= 4
y<-y[keep,]
dim(y)
# 11032     8
des1 <- c("f", "f", "f", "f", "m","m","m","m")
des2 <- c("c", "c", "t", "t", "c", "c", "t", "t")
design <- model.matrix(~des1 + des2 + des1 : des2)
y <- estimateDisp(y,design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, coef=4)
top2v1 <- topTags(qlf, n = 91234)
write.table(top2v1, "diff2-1.txt", sep="\t", quote = F)
topTags(qlf, n = 10)
# Coefficient:  des1m:des2t
#               logFC   logCPM        F       PValue       FDR
# Ifitm2   -1.4925433 4.962871 53.30529 3.215702e-05 0.3547562
# Fn1      -3.3368331 1.670871 30.13782 3.055510e-04 0.8827167
# Dab2     -1.1156088 3.846605 30.11171 3.065431e-04 0.8827167
#

ls -l mouse.clusts.micro.sex-tum-interaction.diff2-1.edgeR.human.gene.rnk 
cat mouse.clusts.micro.sex-tum-interaction.diff2-1.edgeR.human.gene.rnk |awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, (-1)*$2 } ' > mouse.clusts.micro.sex-tum-interaction.diff2-1.edgeR.human.gene.2.rnk
bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx   /Users/linyongmao/Documents/h.all.v7.4.symbols.gmt    -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk  mouse.clusts.micro.sex-tum-interaction.diff2-1.edgeR.human.gene.2.rnk  -rpt_label   "mouse.clusts.micro.sex-tum-interaction.edgeR_TAM.prerank.v7.4"  -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

#############################################################################
### mouse scRNA-seq gene pseudobulk boxplot
        f-ctrl-1  f-ctrl-2 f-tumor-1 f-tumor-2  m-ctrl-1 m-ctrl-2 m-tumor-1 m-tumor-2
Ifitm2  6.176391  6.401068  67.05913  64.79243  9.938551 13.12179  47.04231  39.19691
t2 <- edgeR::cpm(y)[c("Myc", "Ifitm2"),][2,]

df <- data.frame(log2_cpm = log2(t2), sex = des1, tumor = des2)
df$group <- paste(df$sex, df$tumor, sep="_")
for(i in 1:dim(df)[1])
{
 if(df$sex[i] == "f" & df$tumor[i] == "t")
   df$group[i] = "Female Tumor"
 else if(df$sex[i] == "f" & df$tumor[i] == "c")
   df$group[i] = "Female Ctrl"
 else if(df$sex[i] == "m" & df$tumor[i] == "c")
   df$group[i] = "Male Ctrl"
 else if(df$sex[i] == "m" & df$tumor[i] == "t")
   df$group[i] = "Male Tumor"
 else
   temp=1
}

boxplot(df$log2_cpm ~ df$group, xlab="", ylab="log2(cpm)", outcol="white")
beeswarm(df$log2_cpm ~ df$group,  pch = c(1,1,2,2), col = c("green", "red", "green", "red" ), cex = 1, add = T )
abline(h = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
tex="mouse scRNA  pseudobulk \n Ifitm2"
title(tex)

res <- lm(log2(t2) ~ des1 + des2 + des1 * des2)
summary(res)

#############################################################################
f1="/Users/linyongmao/gsea_home/output/microgliaSex/mouse.clusts.micro.sex-tum-interaction.edgeR_TAM.prerank.v7.4.GseaPreranked.1659319902010/gsea_report_for_na_neg_1659319902010.tsv"
f2="/Users/linyongmao/gsea_home/output/microgliaSex/mouse.clusts.micro.sex-tum-interaction.edgeR_TAM.prerank.v7.4.GseaPreranked.1659319902010/gsea_report_for_na_pos_1659319902010.tsv"
cat "$f1" > temp-1
cat "$f2" | awk 'NR > 1' >> temp-1
cat temp-1 | cut -f 1,4,5,6,7,8  > temp-2
vi temp-2 

f1="/Users/linyongmao/gsea_home/output/microgliaSex/mouse.clusts.micro.male.edgeR_TAM.prerank_p.v7.4.GseaPreranked.1658355450441/gsea_report_for_na_pos_1658355450441.tsv"
f2="/Users/linyongmao/gsea_home/output/microgliaSex/mouse.clusts.micro.male.edgeR_TAM.prerank_p.v7.4.GseaPreranked.1658355450441/gsea_report_for_na_neg_1658355450441.tsv"
cat "$f1" > temp-1
cat "$f2" | awk 'NR > 1' >> temp-1
cat temp-1 | cut -f 1,4,5,6,7,8  > temp-2

f1="/Users/linyongmao/gsea_home/output/microgliaSex/mouse.clusts.micro.female.edgeR_TAM.prerank_p.v7.4.GseaPreranked.1658354084959/gsea_report_for_na_pos_1658354084959.tsv"
f2="/Users/linyongmao/gsea_home/output/microgliaSex/mouse.clusts.micro.female.edgeR_TAM.prerank_p.v7.4.GseaPreranked.1658354084959/gsea_report_for_na_neg_1658354084959.tsv"
cat "$f1" > temp-1
cat "$f2" | awk 'NR > 1' >> temp-1
cat temp-1 | cut -f 1,4,5,6,7,8  > temp-2
vi temp-2

#############################################################################
### pathway level z-score;
immune.combined <- readRDS("immune.combined.rds")
mic <- c(0:5,7,9,14)
immune.mic <- immune.combined[, immune.combined$integrated_snn_res.0.6 %in% mic] ###5748 cells in cluster 0
immune.mic
# 16618 features across 31165 (out of 40401) samples within 2 assays
counts <- immune.mic@assays$RNA@counts
metadata <- immune.mic@meta.data
metadata$cluster_id <- metadata$integrated_snn_res.0.6
# Create single cell experiment object
sce <- SingleCellExperiment(assays = list(counts = counts),
                           colData = metadata)
# Identify groups for aggregation of counts
# groups: character class
groups <- colData(sce)[, c("orig.ident")]
# Aggregate across cluster-sample groups
pb <- aggregate.Matrix(t(counts(sce)),
                       groupings = groups, fun = "sum")

class(pb)

dim(pb)
# [1]     8 14618
t1 <- as.data.frame(t(pb))
head(t1)
dim(t1)
group <- factor(rep(1, 8))
y <- DGEList(counts=t1,group=group)
y <- calcNormFactors(y)

keep <-rowSums(edgeR::cpm(y)>=1) >= 4
y<-y[keep,]
dim(y)
# 11032     8
d = edgeR::cpm(y)
a <- d
b = log10(a+1)
for(i in 1:dim(b)[1])
{
 a[i, ] <- (b[i, ] - mean(as.numeric(b[i,]))) / var(as.numeric(b[i,]))^(1/2)
}
###a is z-score of log10(cpm+1)
head(a)
#                f-ctrl-1   f-ctrl-2  f-tumor-1  f-tumor-2   m-ctrl-1    m-ctrl-2  m-tumor-1  m-tumor-2
# Mrpl15        -0.1030297 -0.9063680  0.2181332  0.4909031 -0.3570053 -1.64152623  0.6940354  1.6048575
# Lypla1        -0.8168726  0.2955806 -0.2745238 -0.2532889  0.2742311  0.08644561  2.0451242 -1.3566962

a.df <- as.data.frame(a)
a.df$id <- row.names(a.df)
g <- read.delim("M10.geneID.Human_Orthologs_MSigDB.v7.4.txt")
a2 <- merge(a.df, g, by.x="id", by.y="geneID")
write.table(a2$Gene.Symbol, "temp-1", quote=F, sep="\t")
system("cat temp-1 | cut -f 2 | sort | uniq -c | awk '$1 <= 6' | sed 's/^ *[0-9][0-9]* *//' > temp-2")
g3 <- read.delim("temp-2", header=F)
a5 <- a2[ a2$Gene.Symbol %in% g3$V1, ]
dim(a5)
# [1] 10049    16
paths <- read.delim("temp-path-files", header=F)
i = 25 #inflamm pathway
 genes <- read.delim(file=paths[i,1], header=F)
 p.g <- a5[ a5$Gene.Symbol %in% genes$V1, ]
 mat <- as.matrix(p.g[, 2:9])
 res <- data.frame(id = colnames(mat), mean = colMeans(mat))
res$group <- res$id
res$group <- gsub("-1", "", res$group)
res$group <- gsub("-2", "", res$group)
boxplot(res$mean ~ res$group, xlab = "", ylab = "z-score avg of all genes")
beeswarm(res$mean ~ res$group, pch = c(16,16,17,17), col = c("green", "red", "green", "red" ), cex = 2, add = T)
abline(h = seq(-10,10,0.05), lty = 5, lwd = 0.5, col = "gray")
title(main=paste(length(mic), "microglia", "clusters (mouse scRNA)\n", gsub("../microglia/", "", paths[i,1])))
t1 <- res[res$group == "f-ctrl",]
text(1, t1$mean, t1$id, pos = 4, cex = 0.5, col = "black")
t1 <- res[res$group == "f-tumor",]
text(2, t1$mean, t1$id, pos = 4, cex = 0.5, col = "black")
t1 <- res[res$group == "m-ctrl",]
text(3, t1$mean, t1$id, pos = 4, cex = 0.5, col = "black")
t1 <- res[res$group == "m-tumor",]
text(4, t1$mean, t1$id, pos = 4, cex = 0.5, col = "black")

#############################heatmap for a set of genes#####
genes <- scan(what="", sep = "\n")
p.g <- a5[ a5$Gene.Symbol %in% genes, ]
p.g$"f-ctrl" <- ( p.g$"f-ctrl-1" + p.g$"f-ctrl-2")/2
p.g$"f-tumor" <- ( p.g$"f-tumor-1" + p.g$"f-tumor-2")/2
p.g$"m-ctrl" <- ( p.g$"m-ctrl-1" + p.g$"m-ctrl-2")/2
p.g$"m-tumor" <- ( p.g$"m-tumor-1" + p.g$"m-tumor-2")/2
p.g.1 <- p.g[, 17:20]
rownames(p.g.1) <- p.g$id
mat <- as.matrix(p.g.1)
Heatmap(matrix=mat, name="z-score", cluster_columns=F, row_names_gp = gpar(fontsize = 5.0))

#############################heatmap for a set of genes (human mg data)#####
p.g.mouse <- p.g
# a is z-score of log10(cpm+1)
# mg 39 samples gene level z-score, mean of each group (XX-ctrl, XX-TAM,..)
a.df.g <- merge(a.df, g, by.x="id", by.y="geneID")
head(a.df.g)
info <- read.delim("../microglia/microglia-39-sample-sampInfo.txt")
a8 <- a.df.g[ a.df.g$name %in% genes, ] ###genes a set of genes (e.g. NF-kB members + DDX3X)
info$group <- paste(info$XX, info$Tumor, sep="_")
sort(unique(info$group))
# [1] "XX_Control" "XX_Tumor"   "XY_Control" "XY_Tumor"  
g5 <- sort(unique(info$group))
c1 = numeric()
c2 = numeric()
c3 = numeric()
c4 = numeric()
for(i in 2:40) ###a8 column sample ID - group
{
 id <- colnames(a8)[i]
 gr <- info[ info$id1 == id,]$group
 if(gr == "XX_Control")
   c1 <- c(c1, i)
 else if (gr == "XX_Tumor")
   c2 <- c(c2, i)
 else if (gr == "XY_Control")
   c3 <- c(c3, i)
 else if (gr == "XY_Tumor")
   c4 <- c(c4, i)
 else
   c5 = ""
} 

a8$"human-f-ctrl" = 1
a8$"human-f-tumor" = 1
a8$"human-m-ctrl" = 1
a8$"human-m-tumor" = 1
for(i in 1:dim(a8)[1])
{
 a8$"human-f-ctrl"[i]  = mean(as.numeric(a8[i,c1]))
 a8$"human-f-tumor"[i] = mean(as.numeric(a8[i,c2]))
 a8$"human-m-ctrl"[i]  = mean(as.numeric(a8[i,c3]))
 a8$"human-m-tumor"[i] = mean(as.numeric(a8[i,c4]))
}
a9 <- a8[,42:45]
rownames(a9) <- a8$name
mat <- as.matrix(a9)
a9$name <- a8$name
a10 <- merge(a9, p.g.mouse, by.x="name", by.y="Gene.Symbol")
a11 <- a10[, c(2:5, 21:24)]
rownames(a11) <- paste(a10$name, a10$id, sep="_")
mat <- as.matrix(a11)
Heatmap(matrix=mat, name="z-score", cluster_columns=F, )
h.m <- c(rep("human", 4), rep("mouse",4))
Heatmap(matrix=mat, name="z-score", cluster_columns=F, column_split=h.m)

###barplot NES of human, mouse, interaction
cat temp-1
id      mouse   human
sex : tumor interaction 1.679   2.343
Male tumor vs ctrl      1.996   1.658
Female tumor vs ctrl    2.005   2.444

t1 <- read.delim("temp-1", row.names=1)
barplot(as.matrix( t1), horiz=T, beside=T, xlim=c(0,3), xlab="GSEA NES",  col=c("grey","green", "red"), main ="HALLMARK_INFLAMMATORY_RESPONSE")
legend("bottomright", rev(rownames(t1)), fill=rev(c( "grey", "green", "red")), cex = 0.8, inset=0.02)
abline(v = seq(0,3,0.5), lty = 5, lwd = 0.5, col = "gray")

#############################################################################
#########all cells in scRNA, all CD11b+ populations
> keep <-rowSums(edgeR::cpm(y)>=1) >= 4
> y<-y[keep,]
> dim(y)
[1] 11535     8

###$samples
          group lib.size norm.factors
f-ctrl-1      1 11282149    1.1076945
f-ctrl-2      1 11484539    1.1158320
f-tumor-1     1 17008502    0.9084570
f-tumor-2     1 15620489    0.9403983
m-ctrl-1      1  9949507    1.1079039
m-ctrl-2      1 11113173    1.0956012
m-tumor-1     1 14852877    0.8650514
m-tumor-2     1 14459209    0.9019210

cat mouse.allcells40401.sex-tum-interaction.diff2-1.edgeR.human.gene.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, (-1)*$2 } ' >  mouse.allcells40401.sex-tum-interaction.diff2-1.edgeR.human.gene.2.rnk

#############################################################################
###pca plot  of microglia-9-clusters
keep <-rowSums(edgeR::cpm(y)>=1) >= 4
y<-y[keep,]
dim(y)
# 11032     8
mds <- plotMDS(y, top=98765)
x <- cbind( colnames(y$counts), mds$x, mds$y)
x <- as.data.frame(x)
pca.info <- x
plot(pca.info$V2, pca.info$V3, cex=0.05, xlab="PC1 (66%)", ylab = "PC2 (12%)")
points(pca.info[ pca.info$V1 == "f-ctrl-1" | pca.info$V1 == "f-ctrl-2",]$V2, pca.info[ pca.info$V1 == "f-ctrl-1" | pca.info$V1 == "f-ctrl-2",]$V3, col = "green", pch = 16 , cex = 1.6)
points(pca.info[ pca.info$V1 == "f-tumor-1" | pca.info$V1 == "f-tumor-2",]$V2, pca.info[ pca.info$V1 == "f-tumor-1" | pca.info$V1 == "f-tumor-2",]$V3, col = "red", pch = 16 , cex = 1.6)
points(pca.info[ pca.info$V1 == "m-ctrl-1" | pca.info$V1 == "m-ctrl-2",]$V2, pca.info[ pca.info$V1 == "m-ctrl-1" | pca.info$V1 == "m-ctrl-2",]$V3, col = "green", pch = 17 , cex = 1.6)
points(pca.info[ pca.info$V1 == "m-tumor-1" | pca.info$V1 == "m-tumor-2",]$V2, pca.info[ pca.info$V1 == "m-tumor-1" | pca.info$V1 == "m-tumor-2",]$V3, col = "red", pch = 17 , cex = 1.6)
legend(0,0.2, c("XX control", "XX tumor", "XY control", "XY tumor"), pch=c(16,16,17,17), col = c("green", "red", "green", "red" ))
abline(h = seq(-1,1,0.1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(-1,1,0.1), lty = 5, lwd = 0.5, col = "gray")
pca.info$group = pca.info$V1
pca.info$group <- gsub("-1", "", pca.info$group)
pca.info$group <- gsub("-2", "", pca.info$group)
boxplot(as.numeric( pca.info$V2) ~ pca.info$group, xlab="", ylab = "PC1 (66%)")
beeswarm(as.numeric( pca.info$V2) ~ pca.info$group, pch = c(16,16,17,17), col = c("green", "red", "green", "red" ), cex = 2, add = T)
abline(h = seq(-1,1,0.1), lty = 5, lwd = 0.5, col = "gray")

#############################################################################
###gene-gene correlation over female samples, male samples
keep <-rowSums(edgeR::cpm(y)>=1) >= 4 
y<-y[keep,]
dim(y)
# 11032     8 
d = edgeR::cpm(y)
a <- log2(d+1)
head(a)
a.df <- as.data.frame(a)
a.df$id <- row.names(a.df)
g <- read.delim("M10.geneID.Human_Orthologs_MSigDB.v7.4.txt")
a2 <- merge(a.df, g, by.x="id", by.y="geneID")
write.table(a2$Gene.Symbol, "temp-1", quote=F, sep="\t")
system("cat temp-1 | cut -f 2 | sort | uniq -c | awk '$1 <= 6' | sed 's/^ *[0-9][0-9]* *//' > temp-2")
g3 <- read.delim("temp-2", header=F)
a5 <- a2[ a2$Gene.Symbol %in% g3$V1, ]
dim(a5)
# [1] 10049    16
genes <- scan(what="", sep = "\n")
a6 <- a5[ a5$Gene.Symbol %in% genes, ]
sink("temp.2.txt")
str <- paste("mouseID", "human", "mID2", "human2", "f-r","f-p", "m-r","m-p", "a-r", "a-p", "gene-title",  "mouse-chr", "type", "known", "id", 
 "gene-title",  "mouse-chr", "type", "known", "id", sep="\t")
cat(str)
cat("\n")
for(i in 1:dim(a6)[1]) {
 for(j in 1:dim(a6)[1]) {
t1 <- cor.test(as.numeric(a6[i,2:9]), as.numeric(a6[j,2:9]))
t2 <- cor.test(as.numeric(a6[i,2:5]), as.numeric(a6[j,2:5]))
t3 <- cor.test(as.numeric(a6[i,6:9]), as.numeric(a6[j,6:9]))
corRes <- paste(a6[i,]$id, a6[i,]$"Gene.Symbol", a6[j,]$id, a6[j,]$"Gene.Symbol", 
 round(t2$estimate, digits = 2), format(t2$p.value, digits = 3), 
 round(t3$estimate, digits = 2) , format(format(t3$p.value, digits = 3), digits = 3), round(t1$estimate , digits = 2) , format(format(t1$p.value, digits = 3), digits = 3),
 a6[i,]$"Gene.Title", a6[i,]$chr, a6[i,]$type, a6[i,]$known, a6[i,]$ID,
 a6[j,]$"Gene.Title", a6[j,]$chr, a6[j,]$type, a6[j,]$known, a6[j,]$ID,sep = "\t")
cat(corRes)
cat("\n")
}
}
sink()

##################################################small network
cat te-nfkb-ddx3x-ppp2ca-corr.mouse-mg-clusters.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $1 <  $3 && $9 > 0.5 && $10 < 0.05' | cut -f 1,3,5-10 | cut -f 1,2,7,8 >> te-nfkb-ddx3x-ppp2ca-corr.mouse-mg-clusters.net
cat te-nfkb-ddx3x-ppp2ca-corr.39samples.txt | cut -f 2-5 | awk 'BEGIN {FS = "\t"; OFS = "\t"} $3 > 0.5 && $4 < 0.005 && $1 < $2' | sort +2 -3g > te-nfkb-ddx3x-ppp2ca-corr.39samples.female.net

#############################################################################
##############mouse ddx3x knockout, infection RNA-seq,
paste GSM*.txt > temp-1    
###check gene orders in each file identical
awk 'BEGIN {FS = "\t"; OFS = "\t"} 
{
 for(i = 1; i <= NF; i=i+7)
 {
  if($1 != $i)
    print NR, 1, i;
 }
}   
' temp-1

awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""}
{
 print $1;
 for(i = 5; i <= NF; i=i+7)
 {
  print "\t" $i;
 }
 print "\n";
}' temp-1 > temp-2

ls GSM*.txt | awk '
BEGIN {FS = "\t"; OFS = ""; ORS = "";
   print "geneID" ;}
{
 print "\t" $1;
}
END {print "\n";}
'  > temp-3

vi temp-3
cat temp-2 >> temp-3
vi temp-3
mv -i temp-3 mouse-ddx3x-ko-16samples.txt
mv -i  mouse-ddx3x-ko-16samples.txt  mouse-ddx3x-ko-infect-16samples.txt

t <- read.delim("mouse-ddx3x-ko-infect-16samples.txt", header = T, row.names = 1)
dim(t)
# [1] 24411    16
rawCount <- t
group <- factor(rep(1, 16))
y <- DGEList(counts=rawCount,group=group)
y <- calcNormFactors(y)
sort(y$samples$norm.factors)
#  [1] 0.7025797 0.7369683 0.7615953 0.8683144 0.8701827 0.8751881 0.9522696 0.9931409 1.0730275 1.1502053 1.1745915 1.1905353 1.2058200 1.2346446 1.2499452 1.2625279
med <- data.frame(y$counts[,1])
med$logic <- TRUE
d <- edgeR::cpm(y)
for(i in 1:dim(y)[1]) {
 med$logic[i] <- median(d[i,]) >= 1
}
y<-y[med$logic,]
dim(y)
# 11404    16

mds <- plotMDS(y, top=98765)
x <- cbind( colnames(y$counts), mds$x, mds$y)
x <- as.data.frame(x)

pca.info <- x
#f-wt-c green circle 16
#f-wt-l green square 15
#f-wt-h green triangle 17
#f-ko-c red circle 16
#f-ko-l red square 15
#f-ko-h red triangle 17
#m-wt-c green circle 1 (non-filled circle)
#m-wt-l green square 0
#m-wt-h green triangle 2
#m-ko-c red circle 1
#m-ko-l red square 0
#m-ko-h red triangle 2
1  GSM2306442_fKOh -0.398030561860996   0.463723368875836
2  GSM2306443_fKOc  0.335170332438942   0.554766726573618
3  GSM2306444_fWTh -0.763848976210092  -0.202290249653096
4  GSM2306445_fWTc  0.520873082565794  -0.243104136674508
5  GSM2306446_fKOl -0.175135082736795   0.601011945810428
6  GSM2306447_fKOc  0.430314554989837   0.590175133866312
7  GSM2306448_fWTl -0.439689271212108  -0.195417871094616
8  GSM2306449_fWTc  0.567415871865775  -0.253405263262447
9  GSM2306450_mKOh -0.869659902380943 -0.0129432389931189
10 GSM2306451_mKOc  0.638499270869316 -0.0730359897148057
11 GSM2306452_mWTh -0.865691580959139  -0.297476697797767
12 GSM2306453_mWTc   0.66961257271551  -0.323718383002413
13 GSM2306454_mKOl -0.423144214915911   0.034059583020039
14 GSM2306455_mKOc  0.621951259126233 -0.0602663034551374
15 GSM2306456_mWTl   -0.5546042440519  -0.267613117796934
16 GSM2306457_mWTc  0.705966889756476  -0.314465506701391

plot(pca.info$V2, pca.info$V3, cex=0.05, xlab="PC1 (62%)", ylab = "PC2 (20%)")

points( pca.info[1,]$V2,  pca.info[1,]$V3, col = "red", pch = 17 , cex = 1.6)
points( pca.info[2,]$V2,  pca.info[2,]$V3, col = "red", pch = 16 , cex = 1.6)
points( pca.info[3,]$V2,  pca.info[3,]$V3, col = "green", pch = 17 , cex = 1.6)
points( pca.info[4,]$V2,  pca.info[4,]$V3, col = "green", pch = 16 , cex = 1.6)
points( pca.info[5,]$V2,  pca.info[5,]$V3, col = "red", pch = 15 , cex = 1.6)
points( pca.info[6,]$V2,  pca.info[6,]$V3, col = "red", pch = 16 , cex = 1.6)
points( pca.info[7,]$V2,  pca.info[7,]$V3, col = "green", pch = 15 , cex = 1.6)
points( pca.info[8,]$V2,  pca.info[8,]$V3, col = "green", pch = 16 , cex = 1.6)
points( pca.info[9,]$V2,  pca.info[9,]$V3, col = "red", pch = 2 , cex = 1.6)
points( pca.info[10,]$V2,  pca.info[10,]$V3, col = "red", pch = 1 , cex = 1.6)
points( pca.info[11,]$V2,  pca.info[11,]$V3, col = "green", pch = 2 , cex = 1.6)
points( pca.info[12,]$V2,  pca.info[12,]$V3, col = "green", pch = 1 , cex = 1.6)
points( pca.info[13,]$V2,  pca.info[13,]$V3, col = "red", pch = 0 , cex = 1.6)
points( pca.info[14,]$V2,  pca.info[14,]$V3, col = "red", pch = 1 , cex = 1.6)
points( pca.info[15,]$V2,  pca.info[15,]$V3, col = "green", pch = 0 , cex = 1.6)
points( pca.info[16,]$V2,  pca.info[16,]$V3, col = "green", pch = 1 , cex = 1.6)
abline(h = seq(-1,1,0.1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(-1,1,0.1), lty = 5, lwd = 0.5, col = "gray")
legend("topleft", inset = 0.05, c("f-wt-c", "f-wt-l", "f-wt-h", "f-ko-c", "f-ko-l", "f-ko-h",
    "m-wt-c", "m-wt-l", "m-wt-h", "m-ko-c", "m-ko-l", "m-ko-h"),
    pch = c(16,15,17,16,15,17,1,0,2,1,0,2),
    col = c("green","green","green", "red","red","red","green","green","green", "red","red","red"))

#############################################################################
###F infection ddx3x-ko vs ctrl
rawCount <- t[, c(1,3,5,7)]
group <- factor(rep(1, 4))
y <- DGEList(counts=rawCount,group=group)
y <- calcNormFactors(y)
sort(y$samples$norm.factors)
#                 group lib.size norm.factors
# GSM2306442_fKOh     1 17016314    0.9819120
# GSM2306444_fWTh     1 15670581    0.8659679
# GSM2306446_fKOl     1 13847601    1.1130666
# GSM2306448_fWTl     1 14473364    1.0565851
keep <-rowSums(edgeR::cpm(y)>=1) >= 2
y<-y[keep,]
dim(y)
# [1] 11570     4
g1 <- c("h", "h", "l", "l")
g2 <- c("t", "c", "t", "c")
design <- model.matrix(~g1 + g2)
y <- estimateDisp(y,design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, coef=3)
top2v1 <- topTags(qlf, n = 91234)
write.table(top2v1, "diff2-1.txt", sep="\t", quote = F)
topTags(qlf, n = 20) 
# Coefficient:  g2t 
#              logFC   logCPM        F       PValue        FDR
# Cfp      -2.904899 7.600794 346.1904 2.336917e-05 0.01979237
vi mouse-infect-ddx3x-KOvWT-diff2-1.txt 
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine  mouse-infect-ddx3x-KOvWT-diff2-1.txt ../../M10.geneID-name-chr-type.2.name-first.txt           out
paste mouse-infect-ddx3x-KOvWT-diff2-1.txt   out | grep -vw notApplicable |
awk 'BEGIN {FS = "\t"; OFS = "\t"; ORS = ""}
{
print $9;
for(i = 1; i <= NF; i++)
{
 if(i != 9)
 {
  print "\t" $i;
 }
}
print "\n"
}' > mouse-infect-ddx3x-KOvWT-diff2-1.geneID.txt
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine    mouse-infect-ddx3x-KOvWT-diff2-1.geneID.txt  ../../Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip out
paste  mouse-infect-ddx3x-KOvWT-diff2-1.geneID.txt  out | grep -vw notApplicable > mouse-infect-ddx3x-KOvWT-diff2-1.human.gene.name.txt
cat mouse-infect-ddx3x-KOvWT-diff2-1.human.gene.name.txt | cut -f 2-8,13 > temp
head -3 temp       
/Users/linyongmao/Documents/microglia/make-rnk-genesymble temp mouse-infect-ddx3x-KOvWT-diff2-1.human.gene.rnk
   10655 unique genes  mouse-infect-ddx3x-KOvWT-diff2-1.human.gene.rnk
bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx   /Users/linyongmao/Documents/h.all.v7.4.symbols.gmt    -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk  mouse-infect-ddx3x-KOvWT-diff2-1.human.gene.rnk  -rpt_label   "mouse-infect-ddx3x-KOvWT.F.prerank_h.all.v7.4"  -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

NAME	ORIGINAL SIZE	AFTER RESTRICTING TO DATASET
HALLMARK_TNFA_SIGNALING_VIA_NFKB	200	181
HALLMARK_INFLAMMATORY_RESPONSE	200	160

### male
rawCount <- t[, c(9,11,13,15)]
...
$samples
                group lib.size norm.factors
GSM2306450_mKOh     1 22415399    0.9001071
GSM2306452_mWTh     1 18860185    0.9238811
GSM2306454_mKOl     1 18656682    1.1076929
GSM2306456_mWTl     1 17826641    1.0856013

keep <-rowSums(edgeR::cpm(y)>=1) >= 2
y<-y[keep,]
dim(y)
[1] 11289     4
g1 <- c("h", "h", "l", "l")
g2 <- c("t", "c", "t", "c")

NAME	ORIGINAL SIZE	AFTER RESTRICTING TO DATASET
HALLMARK_TNFA_SIGNALING_VIA_NFKB	200	179
HALLMARK_INFLAMMATORY_RESPONSE	200	161

/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine  mouse-infect-ddx3x-KOvWT-diff2-1.M.txt ../../M10.geneID-name-chr-type.2.name-first.txt           out
paste mouse-infect-ddx3x-KOvWT-diff2-1.M.txt   out | grep -vw notApplicable |
awk 'BEGIN {FS = "\t"; OFS = "\t"; ORS = ""}
{
print $9;
for(i = 1; i <= NF; i++)
{
 if(i != 9)
 {
  print "\t" $i;
 }
}
print "\n"
}' > mouse-infect-ddx3x-KOvWT-diff2-1.M.geneID.txt
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine    mouse-infect-ddx3x-KOvWT-diff2-1.M.geneID.txt  ../../Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip out
paste  mouse-infect-ddx3x-KOvWT-diff2-1.M.geneID.txt  out | grep -vw notApplicable > mouse-infect-ddx3x-KOvWT-diff2-1.M.human.gene.name.txt
cat mouse-infect-ddx3x-KOvWT-diff2-1.M.human.gene.name.txt | cut -f 2-8,13 > temp
head -3 temp       
/Users/linyongmao/Documents/microglia/make-rnk-genesymble temp mouse-infect-ddx3x-KOvWT-diff2-1.M.human.gene.rnk

bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx   /Users/linyongmao/Documents/h.all.v7.4.symbols.gmt    -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk  mouse-infect-ddx3x-KOvWT-diff2-1.M.human.gene.rnk  -rpt_label   "mouse-infect-ddx3x-KOvWT.M.prerank_h.all.v7.4"  -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

#############################################################################
> t <- read.delim("mouse-ddx3x-ko-infect-16samples.txt", header = T, row.names = 1)
...
d <- edgeR::cpm(y)
info <- read.table("mouse-ddx3x-ko-infect-sample-info.txt", header=T)
gene = "Ddx3x"
t2 <- d[rownames(d) == gene,]
df <- data.frame(log2_cpm = log2(t2), group = info[,2], name = info[,1])
a1 <- df[1:8,] # female only
a1$group <- factor(a1$group, levels=c("fWTc", "fWTl", "fKOc", "fKOl"))
boxplot(a1$log2_cpm ~ a1$group, xlab="", ylab="log2(cpm)", outcol="white", col=c("grey", "grey","white", "white"))
beeswarm(a1$log2_cpm ~ a1$group, col = c("green", "red", "green", "red" ),  cex = 1, add = T )
text(2, a1$log2_cpm[3], "h", cex = 0.5, col = "red", pos=2)
text(4, a1$log2_cpm[1], "h", cex = 0.5, col = "red", pos=2)
text = paste("mouse BMDM ", gene, sep="" )
title(text)
abline(h = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")

#### mg anti-viral signature
###both M & F samples, adjusted by sex
###ctrl vs infection, mouse BMDM
rawCount <- t[, c(3,4,7,8,11,12,15,16)]
.....
$samples
                group lib.size norm.factors
GSM2306444_fWTh     1 15670581    0.7438589
GSM2306445_fWTc     1 14651126    1.2275609
GSM2306448_fWTl     1 14473364    0.9218971
GSM2306449_fWTc     1 14906881    1.2484673
GSM2306452_mWTh     1 18860185    0.7142349
GSM2306453_mWTc     1 19447194    1.2406120
GSM2306456_mWTl     1 17826641    0.8392081
GSM2306457_mWTc     1 17979197    1.2795582
.....
keep <-rowSums(edgeR::cpm(y)>=1) >= 4
y<-y[keep,]
dim(y)
# [1] 11602     8
g1 <- c(rep('f', 4), rep('m',4))
g2 <- c('t','c','t','c','t','c','t','c')
design <- model.matrix(~g1 + g2)
y <- estimateDisp(y,design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, coef=3)
top2v1 <- topTags(qlf, n = 91234)
write.table(top2v1, "diff2-1.txt", sep="\t", quote = F)
topTags(qlf, n = 20) 

cat mouse-infect-BMDM-vsCtrl-diff2-1.txt | head 
geneID  logFC   logCPM  F       PValue  FDR
Tpst1   3.14100714732866        6.35962041809877        816.8945510757  4.6671522030767e-09     1.11720898337967e-05
Pald1   -3.44110844606262       5.91034230249713        630.169416822635        1.24836224087595e-08    1.11720898337967e-05

   10685 unique human-homolog genes mouse-infect-BMDM-vsCtrl-diff2-1.human.gene.rnk

#############################################################################
### boxplot pathway-level z-scores, human vs mouse scRNA-seq, same y axis scale
> file
                                         V1
1        HALLMARK_ALLOGRAFT_REJECTION.genes
2                  HALLMARK_APOPTOSIS.genes
3                 HALLMARK_COMPLEMENT.genes
4                HALLMARK_E2F_TARGETS.genes
5             HALLMARK_G2M_CHECKPOINT.genes
6                 HALLMARK_GLYCOLYSIS.genes
7                    HALLMARK_HYPOXIA.genes
8        HALLMARK_IL2_STAT5_SIGNALING.genes
9    HALLMARK_IL6_JAK_STAT3_SIGNALING.genes
10     HALLMARK_INFLAMMATORY_RESPONSE.genes
11 HALLMARK_INTERFERON_ALPHA_RESPONSE.genes
12 HALLMARK_INTERFERON_GAMMA_RESPONSE.genes
13         HALLMARK_KRAS_SIGNALING_UP.genes
14          HALLMARK_MTORC1_SIGNALING.genes
15               HALLMARK_P53_PATHWAY.genes
16   HALLMARK_PI3K_AKT_MTOR_SIGNALING.genes
17   HALLMARK_TNFA_SIGNALING_VIA_NFKB.genes
18 HALLMARK_UNFOLDED_PROTEIN_RESPONSE.genes
> index = 10
p <- read.delim(file[index,1], header=F)
 p.exp <- a.df.g.human[ a.df.g.human$name %in% p$V1, ]
 length(p.exp$name)
 ###[1] 185
 mat <- as.matrix(p.exp[, 2:40])
 res <- data.frame(id = colnames(mat), mean = colMeans(mat))
 ###> res        
 ###             id        mean
 ###MGB_009 MGB_009  0.16357008
 ###MGB_011 MGB_011  0.04620055
 res.info <- merge(res, info, by.x="id", by.y="id1")
 res.info$grape3 <- paste(res.info$XX, res.info$Tumor)
 ### par(cex = 0.4)
 boxplot(as.numeric(res.info$mean) ~ res.info$grape3 ,  ylab = "z-score avg of all genes", xlab = "", ylim = c(-0.6,1.2))
 beeswarm(as.numeric(res.info$mean) ~ res.info$grape3 ,add =T,pch = c(16,16,17,17), col=c("green", "red", "green", "red"), cex = 1.5)
 title(main = paste("human\n", file[index,1], sep=""))
abline(h = seq(-100,100,0.25), lty = 5, lwd = 0.5, col = "gray")

genes <- p
 p.g <- a5[ a5$Gene.Symbol %in% genes$V1, ]
mat <- as.matrix(p.g[, 2:9])
 res <- data.frame(id = colnames(mat), mean = colMeans(mat))
res$group <- res$id
res$group <- gsub("-1", "", res$group)
res$group <- gsub("-2", "", res$group)
boxplot(res$mean ~ res$group, xlab = "", ylab = "z-score avg of all genes", ylim=c(-1,1.5))
beeswarm(res$mean ~ res$group, pch = c(16,16,17,17), col = c("green", "red", "green", "red" ), cex = 2, add = T)
abline(h = seq(-10,10,0.25), lty = 5, lwd = 0.5, col = "gray")
title(main=paste( "microglial", "clusters (mouse scRNA)\n", file[index,1]))
t1 <- res[res$group == "f-ctrl",]
text(1, t1$mean, t1$id, pos = 4, cex = 0.5, col = "black")
t1 <- res[res$group == "f-tumor",]
text(2, t1$mean, t1$id, pos = 4, cex = 0.5, col = "black")
t1 <- res[res$group == "m-ctrl",]
text(3, t1$mean, t1$id, pos = 4, cex = 0.5, col = "black")
t1 <- res[res$group == "m-tumor",]
text(4, t1$mean, t1$id, pos = 4, cex = 0.5, col = "black")

##################################################################
### corr pathway ~ gene mouse scRNA-seq 8 samples
###gene log2(cpm+1) score
y <- DGEList(counts=t1,group=group)
y <- calcNormFactors(y)

keep <-rowSums(edgeR::cpm(y)>=1) >= 2
y<-y[keep,]
dim(y)
#11472     8
d = edgeR::cpm(y)
a <- log2(d+1)

str <- "geneID\tpathway\tf-r\tf-p\tm-r\tm-p\ta-r\ta-p"
cat(str)
cat("\n")
p <- res$mean
p.f <- p[1:4]
p.m <- p[5:8]
for(geneID2 in 1:dim(a)[1]) {
g <- a[geneID2, ]
g.f <- g[1:4]
g.m <- g[5:8]
t1 <- cor.test(p, g)
t2 <- cor.test(p.f, g.f)
t3 <- cor.test(p.m, g.m)
corRes <- paste(rownames(a)[geneID2], file[index,1],  t2$estimate, t2$p.value, t3$estimate, t3$p.value, t1$estimate, t1$p.value, sep = "\t")
cat(corRes)
cat("\n")
}

##########################################################################################################
###################pathway ~ gene correlation figure
name <- "Sat1"
g <- a[rownames(a) == name,]
t1 <- cor.test(p, g)
plot(p, g, xlab="inflamm pathway z-score", ylab="gene expr log2(cpm+1)", col="white")
abline(lm(g ~ p)) 
points(p[1:2], g[1:2], col = "green", pch = 16 , cex = 2)
points(p[3:4], g[3:4], col = "red", pch = 16 , cex = 2)
points(p[5:6], g[5:6], col = "green", pch = 17, cex = 2)
points(p[7:8], g[7:8], col = "red", pch = 17, cex = 2)
title(main = paste(name, ", r=", round(t1$estimate, digits = 3), " p=", format(t1$p.value, digits=3), sep=""))
legend(-0.4,10.55, c("XX control", "XX tumor", "XY control", "XY tumor"), pch=c(16,16,17,17), col = c("green", "red", "green", "red" ))
abline(h = seq(0,200,0.1), lty = 5, lwd = 0.5, col = "gray")

#######FindMarkers between microglia and monocyte
> setwd("/Users/linyongmao/Documents/microglia-mouse/")
immune.combined <- readRDS("immune.combined.rds")
mic <- c(0:5,7,9,14)
mono <- c(6,11,12,15)
DefaultAssay(immune.combined) <- "RNA"
markers <- FindMarkers(immune.combined, ident.1 = mic, ident.2 = mono)
g1 <- scan(what="", sep = "\n")
g2 <- unique(g1)
length(g2)
# [1] 28
markers[rownames(markers) %in% g2,]
        p_val avg_log2FC pct.1 pct.2 p_val_adj
Gpr34       0   3.869356 0.968 0.138         0
P2ry12      0   4.173291 0.988 0.246         0
S100a6      0  -3.223847 0.009 0.739         0
Tmem119     0   3.592275 0.971 0.192         0
Selplg      0   2.797299 0.988 0.639         0
Klrk1       0  -1.448147 0.002 0.346         0
Apoe        0  -2.236243 0.547 0.853         0
Ifitm2      0  -3.621467 0.047 0.840         0
Ifitm3      0  -4.027222 0.224 0.960         0
Lgals3      0  -4.215205 0.053 0.901         0
Cx3cr1      0   3.082532 0.963 0.259         0
Ccr2        0  -2.175161 0.011 0.470         0
Sparc       0   3.684193 0.968 0.147         0
Tgfbi       0  -2.874752 0.066 0.730         0
Ly6i        0  -4.295157 0.032 0.697         0
Ly6c2       0  -4.889621 0.029 0.787         0
Ms4a7       0  -2.569811 0.016 0.458         0

mark2 <- markers[ (markers$avg_log2FC)^2 > 2^2,]
dim(mark2)
# [1] 135   5
write.table(markers, "temp.1.txt", sep="\t", quote=F)
mark2 <- markers[ (markers$avg_log2FC)^2 > (log2(2))^2 & markers$p_val_adj < 0.005 ,]
dim(mark2)
# [1] 457   5
immune.mic <- immune.combined[, immune.combined$integrated_snn_res.0.6 %in% mic] ###5748 cells in cluster 0
immune.mic
immune.mic$id_1 = 1
ref.0.avg <- AverageExpression(immune.mic, group.by="id_1", slot="data", verbose=T)
sum(ref.0.avg$RNA[,1])
# [1] 10000
t1 <-  ref.0.avg$RNA * 100 ### * 100, turn to tpm
summary(t1)
t2 <- as.matrix(t1)
summary(t2)
mic.avg <- data.frame(id = rownames(t2), avg = t2[,1])

immune.mic <- immune.combined[, immune.combined$integrated_snn_res.0.6 %in% mono] ###5748 cells in cluster 0
immune.mic
# 16618 features across 5392 samples within 2 assays 
immune.mic$id_1 = 1
ref.0.avg <- AverageExpression(immune.mic, group.by="id_1", slot="data", verbose=T)
sum(ref.0.avg$RNA[,1])
# [1] 10000
t1 <-  ref.0.avg$RNA * 100 ### * 100, turn to tpm
summary(t1)
t2 <- as.matrix(t1)
summary(t2)
mono.avg <- data.frame(id = rownames(t2), avg = t2[,1])

mic.mono.avg <- merge(mic.avg, mono.avg, by.x="id", by.y="id")
mark2$id <- rownames(mark2)
mic.mono.2 <- merge(mic.mono.avg, mark2, by.x="id", by.y="id")
plot(log2(mic.mono.2$avg.x), log2(mic.mono.2$avg.y), xlab = "log2(microglia avg exp)", ylab="log2(monocyte avg exp)")
a <- 1:6
b = a
abline(lm(b ~ a))
abline(h = seq(0,200,1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(0,200,1), lty = 5, lwd = 0.5, col = "gray")
title("457 marker genes between microglia and monocyte (mouse scRNA)")
gene = "Ccr2"
t3 <- mic.mono.2[ mic.mono.2$id ==gene, ]
text( log2(t3$avg.x), log2(t3$avg.y), gene, pos = 4, cex = 0.7, col = "red" ) #Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified (x,y) coordinates.
gene = "Cx3cr1"
t3 <- mic.mono.2[ mic.mono.2$id ==gene, ]
text( log2(t3$avg.x), log2(t3$avg.y), gene, pos = 4, cex = 0.7, col = "red" )

#############
P2ry12
Tmem119
Cx3cr1
Ccr2
Aif1
Actb
Gapdh

ref.0.avg <- AverageExpression(immune.mic, group.by="orig.ident", slot="data", verbose=T)
t1 <-  ref.0.avg$RNA * 100 ### * 100, turn to tpm
sum(t1)
# [1] 8e+06 eight samples
summary(t1)
t2 <- as.data.frame(t1)
t3 <- t2[ rownames(t2) %in% g1,  ]
dim(t3)
t4 <- as.data.frame( t(t3))
boxplot(t4, ylab = "Tpm", outcol = "white")
beeswarm(t4, add=T, cex = 1)
title("mouse microglia scRNA pseudobulk")
boxplot(log2(t4+1), ylab = "log2(Tpm+1)", outcol = "white")
beeswarm(log2(t4+1), add=T, cex = 1, col = "red")
title("mouse microglia scRNA pseudobulk")
abline(h = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
###monocyte
###only use samples from tumors
...
t5 <- t4[c(3,4,7,8),]
t4 <- t5
boxplot(log2(t4+1), ylab = "log2(Tpm+1)", outcol = "white")
beeswarm(log2(t4+1), add=T, cex = 1, col = "red")
title("mouse monocyte scRNA pseudobulk")
abline(h = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")

#####################reorder genes in x-axis of boxplot
t5 <- data.frame( t4$Actb, t4$Itgam, t4$P2ry12, t4$Tmem119, t4$Ccr2, t4$Cx3cr1 ) 
rownames(t5) <- rownames(t4)
colnames(t5) <- gsub("t4.", "", colnames(t5))
t4 <- t5
boxplot(log2(t4+1), ylab = "log2(Tpm+1)", outcol = "white", ylim = c(0, 14) ) 

P2ry12  Tmem119 Cx3cr1  Ccr2    Actb    Itgam
###human ortholog
P2RY12  TMEM119 CX3CR1  CCR2    ACTB    ITGAM

h1 <- read.delim("../microglia/microglia-39-sample-tpm.genename.txt")
sum(h1[,2:40])
# [1] 3.9e+07 /39 samples = 1e6 per sample
t3 <- h1[ h1$name %in% g2, ] 
rownames(t3) <- t3$name
t3 <- t3[, 2:40]
dim(t3)
# [1]  6 39
t4 <- as.data.frame( t(t3))
t5 <- data.frame( t4$ACTB, t4$ITGAM, t4$P2RY12, t4$TMEM119, t4$CCR2, t4$CX3CR1 ) 
rownames(t5) <- rownames(t4)
colnames(t5) <- gsub("t4.", "", colnames(t5))
t4 <- t5
boxplot(log2(t4+1), ylab = "log2(Tpm+1)", outcol = "white", ylim = c(0,14))
beeswarm(log2(t4+1), add=T, cex = 1, col = "red")
abline(h = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
title("human microglia 39 samples")
info <- read.delim("../microglia/microglia-39-sample-sampInfo.txt")
t5 <- t4
t5$id <- rownames(t4)
t6 <- merge(t5, info, by.x="id", by.y="id1")
write.table(t6, "human.tpm.ccr2.cx3cr1.marker.txt", sep="\t", quote=F)

################add  "Cd3d"    "Ms4a1", order them
#################mouse-human side by side boxplot for gene markers
h1 <- read.delim("../microglia/microglia-39-sample-tpm.genename.txt")
sum(h1[,2:40])
# [1] 3.9e+07 /39 samples = 1e6 per sample
t3 <- h1[ h1$name %in% g2, ]
rownames(t3) <- t3$name
t3 <- t3[, 2:40]
dim(t3)
# [1]  6 39
t4 <- as.data.frame( t(t3))
t5 <- data.frame( t4$ACTB, t4$ITGAM, t4$P2RY12, t4$TMEM119, t4$CX3CR1, t4$CCR2, t4$CD3D, t4$MS4A1 )
colnames(t5) <- gsub("t4.", "", colnames(t5))
t4 <- t5

t4.human <- t4

immune.mic <- immune.combined[, immune.combined$integrated_snn_res.0.6 %in% c(19)] ###B cell cluster
immune.mic
# An object of class Seurat
# 16618 features across 189 samples within 2 assays
ref.0.avg <- AverageExpression(immune.mic, group.by="orig.ident", slot="data", verbose=T)
t1 <-  ref.0.avg$RNA * 100 ### * 100, turn to tpm
sum(t1)
# [1] 8e+06 eight samples
summary(t1)
t2 <- as.data.frame(t1)
t3 <- t2[ rownames(t2) %in% g1,  ]
dim(t3)
t4 <- as.data.frame( t(t3))
####f-tumor-1 2nd row
#### change values for other cell types. e.g. t4[c(3,4,7,8),]
t4 <- t4[c(2),] ##only from f-tumor-1
t5 <- data.frame( t4$Actb, t4$Itgam, t4$P2ry12, t4$Tmem119, t4$Cx3cr1, t4$Ccr2, t4$Cd3d, t4$Ms4a1 )
rownames(t5) <- rownames(t4)
colnames(t5) <- gsub("t4.", "", colnames(t5))
t4 <- t5

li <- list()
# 1,2,3,4,5,6
# 1,2,3,4,5,6
# 1,1,2,2,3,3,4,4,5,5,6,6
# 1,3,5,7,9,11
for( i in seq(1,dim(t4)[2] * 2, 2)) {
 li[[i]] = log2(t4[,(i+1)/2]+1)
 li[[i+1]] = log2(t4.human[, (i+1)/2]+1)
 }
length(li)
par(pin=c(9,5))
boxplot(li, ylab = "log2(Tpm+1)",  xaxt="n", ylim = c(0,14), col = c("grey", "red"), outcol = c("black", "red"))
axis(1, at = seq(1,15,2), labels= colnames(t4.human), las = 1, cex.axis = 0.8)
abline(h = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(2.5, 14.5, 2), lty = 5, lwd = 0.5, col = "blue")
legend(0.5, 2, legend=c("mouse B_cell scRNA", "human microglia"), pch = 22, cex = 1, pt.bg = c("grey", "red"), pt.cex = 2, bg = "white")


################add  "Cd3d"    "Ms4a1", order them
P2RY12
TMEM119
CX3CR1
CCR2
ACTB
ITGAM
CD3D
MS4A1
"P2ry12"  "Tmem119" "Cx3cr1"  "Ccr2"    "Actb"    "Itgam"   "Cd3d"    "Ms4a1"

> t5 <- data.frame( t4$ACTB, t4$ITGAM, t4$P2RY12, t4$TMEM119, t4$CX3CR1, t4$CCR2, t4$CD3D, t4$MS4A1 )
> t5 <- data.frame( t4$Actb, t4$Itgam, t4$P2ry12, t4$Tmem119, t4$Cx3cr1, t4$Ccr2, t4$Cd3d, t4$Ms4a1 )
...
par(pin=c(9,5))
boxplot(log2(t4+1), ylab = "log2(Tpm+1)", outcol = "white", ylim = c(0,14))
beeswarm(log2(t4+1), add=T, cex = 1, col = c("red", "black"))
abline(h = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
title("human microglia 39 samples")

#################mouse-human side by side boxplot for gene markers
li <- list()
# 1,2,3,4,5,6
# 1,2,3,4,5,6
# 1,1,2,2,3,3,4,4,5,5,6,6
# 1,3,5,7,9,11
for( i in seq(1,dim(t4)[2] * 2, 2)) {
 li[[i]] = log2(t4[,(i+1)/2]+1)
 li[[i+1]] = log2(t4.human[, (i+1)/2]+1)
 }
length(li)
par(pin=c(9,5))
boxplot(li, ylab = "log2(Tpm+1)",  xaxt="n", ylim = c(0,14), col = c("grey", "red"), outcol = c("black", "red"))
axis(1, at = seq(1,15,2), labels= colnames(t4.human), las = 1, cex.axis = 0.8)
abline(h = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(2.5, 14.5, 2), lty = 5, lwd = 0.5, col = "blue")
legend(0.5, 3, legend=c("mouse microglia scRNA", "human microglia"), pch = 22, cex = 1, pt.bg = c("grey", "red"), pt.cex = 2, bg = "white")

###only use specified samples for NKT clusters
> immune.mic <- immune.combined[, immune.combined$integrated_snn_res.0.6 %in% c(10)] ###5748 cells in cluster 0
> immune.mic
# cluster 10: NKT cells
# 16618 features across 1016 samples within 2 assays
> summary(factor(immune.mic$orig.ident))
 f-ctrl-1  f-ctrl-2 f-tumor-1 f-tumor-2  m-ctrl-1  m-ctrl-2 m-tumor-1 m-tumor-2
       58        37       475        37        83       161       131        34 
...
> t4 <- t5[c(3,7),]

#############mouse scRNA pseudobulk tpm four group boxplot
setwd("../microglia-mouse/")
immune.combined <- readRDS("immune.combined.rds")
mic <- c(0:5,7,9,14)
mono <- c(6,11,12,15)
immune.mic <- immune.combined[, immune.combined$integrated_snn_res.0.6 %in% mono] ###5748 cells in cluster 0
immune.mic
ref.0.avg <- AverageExpression(immune.mic, group.by="orig.ident", slot="data", verbose=T)
t1 <-  ref.0.avg$RNA * 100 ### * 100, turn to tpm
sum(t1)
# [1] 8e+06 eight samples
summary(t1)
t2 <- as.data.frame(t1)
t3 <- t2[ rownames(t2) %in% c("Ptprc"),  ]
dim(t3)
des1 <- c("f", "f", "f", "f", "m","m","m","m")
des2 <- c("c", "c", "t", "t", "c", "c", "t", "t")
df <- data.frame(tpm = as.numeric(t3[1,]), sex = des1, tumor = des2)
df$group <- paste(df$sex, df$tumor, sep="_")
for(i in 1:dim(df)[1])
{
 if(df$sex[i] == "f" & df$tumor[i] == "t")
   df$group[i] = "Female Tumor"
 else if(df$sex[i] == "f" & df$tumor[i] == "c")
   df$group[i] = "Female Ctrl"
 else if(df$sex[i] == "m" & df$tumor[i] == "c")
   df$group[i] = "Male Ctrl"
 else if(df$sex[i] == "m" & df$tumor[i] == "t")
   df$group[i] = "Male Tumor"
 else
   temp=1
}
boxplot(df$tpm ~ df$group, xlab="", ylab="Tpm", outcol="white")
beeswarm(df$tpm ~ df$group,  pch = c(1,1,2,2), col = c("green", "red", "green", "red" ), cex = 1, add = T )
abline(h = seq(0,1000,10), lty = 5, lwd = 0.5, col = "gray")
tex="mouse monocyte scRNA pseudobulk \n Ptprc"
title(tex)
   abline(h = seq(-100,1000,100), lty = 5, lwd = 0.5, col = "gray")

##########enrichr 
cat  mouse-infect-ddx3x-KOvWT-diff2-1.human.gene.name.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $7 < 0.05 && $3 > 1.5 ' | cut -f 2,3,6,7,13 | cut -f 5 | sort | uniq
cat  mouse-infect-ddx3x-KOvWT-diff2-1.human.gene.name.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $7 < 0.05 && $3 < -1.5 ' | cut -f 2,3,6,7,13  | cut -f 5 | sort | uniq

ls -lh ~/Downloads | grep "Dec  8" | awk '{print $9}' | awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} {print "\""  $1  "\"" "  " }'
ls -lh ~/Downloads | grep "Dec  8"  | grep 13: | awk '{print $9}'  | grep -v temp | awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} {print "\""  $1  "\"" "  " }'

cat temp-1
cat "Descartes_Cell_Types_and_Tissue_2021_table.txt"  "ENCODE_Histone_Modifications_2015_table.txt"  "GO_Biological_Process_2021_table.txt"  "MSigDB_Hallmark_2020_table.txt"  "Mouse_Gene_Atlas_table.txt"  "TRRUST_Transcription_Factors_2019_table(1).txt"  > temp.down.txt
cat temp-2
cat "Descartes_Cell_Types_and_Tissue_2021_table(1).txt"  "ENCODE_Histone_Modifications_2015_table(1).txt"  "GO_Biological_Process_2021_table(1).txt"  "MSigDB_Hallmark_2020_table(1).txt"  "Mouse_Gene_Atlas_table(1).txt"  "TRRUST_Transcription_Factors_2019_table(2).txt"  > temp.up.txt

#########
cat  mouse-infect-ddx3x-KOvWT-diff2-1.human.gene.name.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $7 < 0.05 && $3 < -1.5 ' | cut -f 2,3,6,7,13  | cut -f 5 | sort | uniq > temp-1
cat  trrust_rawdata.human.tsv | grep "^RELA    "  | cut -f 2 | sort | uniq | wc -l
     301
cat  trrust_rawdata.human.tsv | grep "^RELA    "  | cut -f 2 | sort | uniq > temp-2
cat temp-1 temp-2 | sort | uniq -d | wc -l
      33
33/301
        rela    non-rela-target
inputset  33    366
non-input 301-33   n-399-(301-33)

n = 2e4
a <- c(33, 399-33, 301-33,   n-399-(301-33))
m <- matrix(a,  nrow=2, ncol = 2, byrow=T )
fisher.test(m)

        Fisher's Exact Test for Count Data

data:  m
p-value = 1.921e-15
alternative hypothesis: true odds ratio is not equal to 1
95 percent confidence interval:
 4.321985 9.517047
sample estimates:
odds ratio
  6.502676
> m
     [,1]  [,2]
[1,]   33   366
[2,]  268 19333
> 33/366 / (268/19333)
[1] 6.504251
> 33/366
[1] 0.09016393
> 268/19333
[1] 0.01386231

######mouse scRNA clustering on 8 mice, using DEGs from human, or from mouse itself
> library(SingleCellExperiment)
library(Matrix.utils)
setwd("/Users/linyongmao/Documents/microglia-mouse")
immune.combined <- readRDS("immune.combined.rds")
mic <- c(0:5,7,9,14)
immune.mic <- immune.combined[, immune.combined$integrated_snn_res.0.6 %in% mic] ###5748 cells in cluster 0
immune.mic
# 16618 features across 31165 (out of 40401) samples within 2 assays
DefaultAssay(immune.mic) <- "RNA"
counts <- immune.mic@assays$RNA@counts
metadata <- immune.mic@meta.data
metadata$cluster_id <- metadata$integrated_snn_res.0.6
# Create single cell experiment object
sce <- SingleCellExperiment(assays = list(counts = counts),
                           colData = metadata)
# Identify groups for aggregation of counts
# groups: character class
groups <- colData(sce)[, c("orig.ident")]
# Aggregate across cluster-sample groups
pb <- aggregate.Matrix(t(counts(sce)),
                       groupings = groups, fun = "sum")

class(pb)

dim(pb)
# [1]     8 14618
pb[1:8, 1:6] # 8 samples
#           Sox17 Mrpl15 Lypla1 Tcea1 Atp6v1h Rb1cc1
# f-ctrl-2      .    618    542   968     453    511
# m-tumor-2     .    558    341   683     363    299
t1 <- as.data.frame(t(pb))
head(t1)
dim(t1)
group <- factor(rep(1, 8))
y <- DGEList(counts=t1,group=group)
y <- calcNormFactors(y)
keep <-rowSums(edgeR::cpm(y)>=1) >= 2
y<-y[keep,]
dim(y)
# [1] 11472     8
d = edgeR::cpm(y)
a <- d
b = log10(a+1)
for(i in 1:dim(b)[1])
{
 a[i, ] <- (b[i, ] - mean(as.numeric(b[i,]))) / var(as.numeric(b[i,]))^(1/2)
}
a.df <- as.data.frame(a)
a.df$id <- row.names(a.df)
geneid <- read.delim("M10.geneID-name-chr-type.2.name-first.txt")
a.gene <- merge(a.df, geneid, by.x="id", by.y="geneID")
dim(a.gene)
#  [1] 11125    13
chip <- read.delim("Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip")
a.chip <- merge(a.gene, chip, by.x="ID", by.y="ID")
dim(a.chip)
# [1] 10385    15
g2 <- read.delim("../microglia/all39samp.tumVSctrl.diff2-1.name-type-chr.txt")
g3 <- g2[ g2$FDR < 0.1,]
dim(g3)
# 414  10
a.df.g.filt <- a.chip[ a.chip$Gene.Symbol %in% g3$symbol, ]
dim(a.df.g.filt)
# 282  15
t1 <- a.df.g.filt[, 3:10]
rownames(t1) <- a.df.g.filt$id
mat1 <- t(as.matrix(t1))
mat <- as.data.frame(mat1)
dim(mat)
#  8 282
Heatmap(matrix = as.matrix(mat), show_column_names=F, name="z-socre", row_names_gp = gpar(fontsize = 12),  row_dend_width=unit(30, "mm"), clustering_distance_columns="pearson" )
> g3 <- g2[ g2$FDR < 0.1 & g2$logFC > 0,]
> dim(g3)
[1] 212  10

###########mouse scRNA-seq mg clusters; TAM vs ctrl; F+M;
> keep <-rowSums(edgeR::cpm(y)>=1) >= 2
> y<-y[keep,]
> dim(y)
[1] 11472     8
s <- c( rep("f", 4), rep("m",4) )
tc <- c("c", "c", "t", "t", "c", "c", "t", "t")
design <- model.matrix(~s + tc)
y <- estimateDisp(y,design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, coef=3)
top2v1 <- topTags(qlf, n = 91234)
write.table(top2v1, "diff2-1.txt", sep="\t", quote = F)
mv -i diff2-1.txt mouse.clusts.micro.8samples.diff2-1.edgeR.txt
vi mouse.clusts.micro.8samples.diff2-1.edgeR.txt

/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine   mouse.clusts.micro.8samples.diff2-1.edgeR.txt M10.geneID-name-chr-type.2.name-first.txt out
paste  mouse.clusts.micro.8samples.diff2-1.edgeR.txt  out | grep -vw notApplicable |
awk 'BEGIN {FS = "\t"; OFS = "\t"; ORS = ""}
{
print $9;
for(i = 1; i <= NF; i++)
{
 if(i != 9)
 {
  print "\t" $i;
 }
}
print "\n"
}' > mouse.clusts.micro.8samples.diff2-1.edgeR.geneID.txt

/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine    mouse.clusts.micro.8samples.diff2-1.edgeR.geneID.txt  Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip out
paste  mouse.clusts.micro.8samples.diff2-1.edgeR.geneID.txt  out | grep -vw notApplicable > mouse.clusts.micro.8samples.diff2-1.edgeR.human.gene.name.txt
cat mouse.clusts.micro.8samples.diff2-1.edgeR.human.gene.name.txt | cut -f 2-8,13 > temp
head -3 temp       
/Users/linyongmao/Documents/microglia/make-rnk-genesymble temp mouse.clusts.micro.8samples.diff2-1.edgeR.human.gene.rnk
rm -f temp-1
echo -n "all39samp.tumVSctrl.upreg-fdr0d1\tfdr0d1" >> temp-1
cat "../microglia/all39samp.tumVSctrl.diff2-1.name-type-chr.txt" |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} $2 > 0 && $6 < 0.1 {print "\t" $8}' >> temp-1
echo >> temp-1
echo -n "all39samp.tumVSctrl.downreg-fdr0d1\tfdr0d1" >> temp-1
cat "../microglia/all39samp.tumVSctrl.diff2-1.name-type-chr.txt" |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} $2 < 0 && $6 < 0.1 {print "\t" $8}' >> temp-1
echo >> temp-1

echo -n "all39samp.tumVSctrl.upreg-fdr0d05\tfdr0d05" >> temp-1
cat "../microglia/all39samp.tumVSctrl.diff2-1.name-type-chr.txt" |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} $2 > 0 && $6 < 0.05 {print "\t" $8}' >> temp-1
echo >> temp-1
echo -n "all39samp.tumVSctrl.downreg-fdr0d05\tfdr0d05" >> temp-1
cat "../microglia/all39samp.tumVSctrl.diff2-1.name-type-chr.txt" |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} $2 < 0 && $6 < 0.05 {print "\t" $8}' >> temp-1
echo >> temp-1
cat temp-1 >> microglia-TAM.gmt
cp -i microglia-TAM.gmt microglia-TAM.july-2-2023.gmt

bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx    microglia-TAM.gmt   -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk   mouse.clusts.micro.8samples.diff2-1.edgeR.human.gene.rnk -rpt_label   "mouse.clusts.micro.8samples.fAm.edgeR_TAM.prerank.custom.gmt"  -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx   /Users/linyongmao/Documents/h.all.v7.4.symbols.gmt    -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk  mouse.clusts.micro.8samples.diff2-1.edgeR.human.gene.rnk -rpt_label "mouse.clusts.micro.8samples.fAm.edgeR_TAM.prerank.h.all.7.4" -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

##################mouse scRNA-seq mg clusters; TAM only; 4samples; M vs F;
> t1 <- as.data.frame(t(pb[c(3,4,7,8),]))
head(t1)
dim(t1)
group <- factor(rep(1, 4))
y <- DGEList(counts=t1,group=group)
y <- calcNormFactors(y)
keep <-rowSums(edgeR::cpm(y)>=1) >= 2
y<-y[keep,]
dim(y)
# [1] 11122     4
s <- c( rep("f", 2), rep("m",2) )
design <- model.matrix(~s )
y <- estimateDisp(y,design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, coef=2)
top2v1 <- topTags(qlf, n = 91234)
write.table(top2v1, "diff2-1.txt", sep="\t", quote = F)
linyongmao@Linyong-Mao-MBP16-2019 microglia-mouse % mv -i diff2-1.txt mouse.clusts.micro.4TAMs.MvF.diff2-1.edgeR.txt
vi mouse.clusts.micro.4TAMs.MvF.diff2-1.edgeR.txt
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine   mouse.clusts.micro.4TAMs.MvF.diff2-1.edgeR.txt M10.geneID-name-chr-type.2.name-first.txt out
paste   mouse.clusts.micro.4TAMs.MvF.diff2-1.edgeR.txt out | grep -vw notApplicable |awk 'BEGIN {FS = "\t"; OFS = "\t";} !($8 == "chrX" || $8 == "chrY") ' |  awk 'BEGIN {FS = "\t"; OFS = "\t"; ORS = ""}
{
print $9;
for(i = 1; i <= NF; i++)
{
 if(i != 9)
 {
  print "\t" $i;
 }
}
print "\n"
}' > mouse.clusts.micro.4TAMs.MvF.diff2-1.edgeR.geneID.txt
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine   mouse.clusts.micro.4TAMs.MvF.diff2-1.edgeR.geneID.txt Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip out
paste  mouse.clusts.micro.4TAMs.MvF.diff2-1.edgeR.geneID.txt out | grep -vw notApplicable > mouse.clusts.micro.4TAMs.MvF.diff2-1.edgeR.human.gene.name.txt
cat mouse.clusts.micro.4TAMs.MvF.diff2-1.edgeR.human.gene.name.txt | cut -f 2-8,13 > temp
head  temp
/Users/linyongmao/Documents/microglia/make-rnk-genesymble temp mouse.clusts.micro.4TAMs.MvF.noXY.diff2-1.edgeR.human.gene.rnk

bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx   /Users/linyongmao/Documents/h.all.v7.4.symbols.gmt    -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk  mouse.clusts.micro.4TAMs.MvF.noXY.diff2-1.edgeR.human.gene.rnk  -rpt_label "mouse.clusts.micro.4TAMs.MvF.Mpos.noXY.edgeR.human.gene.prerank.h.all.7.4" -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

####################################################################################################
cellranger cellranger-7.1.0
cellranger count --id=run_count_1kpbmcs  --fastqs=/lab/solexa_page/linyong/pbmc_1k_v3_fastqs  --sample=pbmc_1k_v3 --transcriptome=/lab/solexa_page/linyong/refdata-gex-GRCh38-2020-A
Cores per node: 6
CPU Utilized: 03:47:09
CPU Efficiency: 51.78% of 07:18:42 core-walltime
Job Wall-clock time: 01:13:07
Memory Utilized: 15.19 GB
linyong@fry /lab/solexa_page/linyong/run_count_1kpbmcs$ ls outs/filtered_feature_bc_matrix/ -lh
total 15M
-rw-r--r-- 1 linyong systemd-timesync 7.0K Nov  4 13:24 barcodes.tsv.gz
-rw-r--r-- 1 linyong systemd-timesync 326K Nov  4 13:24 features.tsv.gz
-rw-r--r-- 1 linyong systemd-timesync  15M Nov  4 13:24 matrix.mtx.gz

#######pbmc3k data
 counts <- pbmc@assays$RNA$counts
 dim(counts)
#  [1] 13714  2638
 metadata <- pbmc@meta.data
 dim(metadata)
#  [1] 2638-cells    6
 metadata$cluster_id <- metadata$RNA_snn_res.0.5
 identical(metadata$RNA_snn_res.0.5, metadata$seurat_clusters)
#  [1] TRUE
# Create single cell experiment object
sce <- SingleCellExperiment(assays = list(counts = counts),
                           colData = metadata)
 # Identify groups for aggregation of counts
 # groups: character class
 groups <- colData(sce)[, c("RNA_snn_res.0.5")]
 groups[1:11]
 head(colData(sce), n=11)
 pb <- aggregate.Matrix(t(counts(sce)),
                       groupings = groups, fun = "sum")
 class(pb)
 dim(pb)
#  [1]     9-cluster 13714
t1 <- as.data.frame(t(pb))
head(t1)
dim(t1)
group <- factor(rep(1, 9))
y <- DGEList(counts=t1,group=group)
y <- calcNormFactors(y)

#######################################################################
scRNA clustering in Seurat v5
Seurat_5.1.0 
R version 4.4.1 (2024-06-14)
Platform: x86_64-apple-darwin20
Running under: macOS Ventura 13.2.1
> mg <- merge(ss[[1]], y = t2, project = "microglia")
Warning: Some cell names are duplicated across objects provided. Renaming to enforce unique cell names.
> mg
An object of class Seurat 
14618 features across 41059 samples within 1 assay 
Active assay: RNA (14618 features, 0 variable features)
 8 layers present: counts.f-ctrl-1, counts.f-ctrl-2, counts.f-tumor-1, counts.f-tumor-2, counts.m-ctrl-1, counts.m-ctrl-2, counts.m-tumor-1, counts.m-tumor-2

> mg.1
An object of class Seurat 
14618 features across 40401 samples within 1 assay 
 ..@ meta.data   :'data.frame': 40401 obs. of  4 variables:
  .. ..$ orig.ident  : chr [1:40401] "f-ctrl-1" "f-ctrl-1" "f-ctrl-1" "f-ctrl-1" ... 
  .. ..$ nCount_RNA  : num [1:40401] 1863 3705 2471 2030 2074 ... 
  .. ..$ nFeature_RNA: int [1:40401] 988 1679 1219 978 1094 1182 1081 953 1074 576 ... 
  .. ..$ percent.mt  : num [1:40401] 2.201 0.999 0.405 2.266 2.363 ... 
  ..@ active.assay: chr "RNA"
  ..@ active.ident: Factor w/ 8 levels "f-ctrl-1","f-ctrl-2",..: 1 1 1 1 1 1 1 1 1 1 ... 
# run standard anlaysis workflow
mg.1 <- NormalizeData(mg.1)
mg.1 <- FindVariableFeatures(mg.1)
mg.1 <- ScaleData(mg.1)
mg.1 <- RunPCA(mg.1)
# After preprocessing, we integrate layers.
mg.1 <- IntegrateLayers(object = mg.1, method = CCAIntegration, orig.reduction = "pca", new.reduction = "integrated.cca",   dims = 1:30, verbose = T)
mg.1[["RNA"]] <- JoinLayers(mg.1[["RNA"]])
#  14618 features across 40401 samples within 1 assay
#  Active assay: RNA (14618 features, 2000 variable features)
# before joinlayers, 17 layers 
#   3 layers present: data, counts, scale.data
#   2 dimensional reductions calculated: pca, integrated.cca
mg.1 <- FindNeighbors(mg.1, reduction = "integrated.cca", dims = 1:30)
mg.1 <- FindClusters(mg.1, resolution = 0.6)
#  Number of nodes: 40401
#  Number of edges: 1590270
#  Running Louvain algorithm...
#  Maximum modularity in 10 random starts: 0.8659
#  Number of communities: 22
#  5 singletons identified. 17 final clusters.

>  saveRDS(mg.1, file="mouse.scRNA.mg.1.seurat5.nov2024.rds")
-rw-r--r--  1 linyongmao  staff   354M Nov  8 19:10 mouse.scRNA.mg.1.seurat5.nov2024.rds

mg.1 <- RunUMAP(mg.1, dims = 1:30, reduction = "integrated.cca")
# Visualization
 DimPlot(mg.1, reduction = "umap", group.by = c( "RNA_snn_res.0.6"), label=T)

 FeaturePlot(mg.1, features = c("Ccr2", "Cx3cr1", "Cd3d"),  max.cutoff = 3, cols = c("grey", "red"), reduction = "umap")
 counts <- mg.1@assays$RNA$counts
 metadata <- mg.1@meta.data
 metadata$cluster_id <- metadata$RNA_snn_res.0.6
# Create single cell experiment object
sce <- SingleCellExperiment(assays = list(counts = counts),
                           colData = metadata)
# Identify groups for aggregation of counts
# groups: character class
groups <- colData(sce)[, c("RNA_snn_res.0.6")]

# Aggregate across cluster-sample groups
pb <- aggregate.Matrix(t(counts(sce)),
                       groupings = groups, fun = "sum")

class(pb)

dim(pb)
# [1]    17 14618
t1 <- as.data.frame(t(pb))
head(t1)
dim(t1)
group <- factor(rep(1, 17))
y <- DGEList(counts=t1,group=group)
y <- calcNormFactors(y)
> g1 <- scan(what="", sep = "\n")
 g2 <- unique( sort(g1))
 length(g2)
#  [1] 28
 [1] "Apoe"    "Ccr2"    "Cd14"    "Cd163"   "Cd2"     "Cd24a"   "Cd3d"    "Cd4"     "Cd8b1"   "Cx3cr1"  "Gpr34"   "Ifitm2"  "Ifitm3"  "Klrk1"   "Lgals3"
[16] "Ly6c2"   "Ly6i"    "Mrc1"    "Ms4a1"   "Ms4a7"   "Ncam1"   "Ncr1"    "P2ry12"  "S100a6"  "Selplg"  "Sparc"   "Tgfbi"   "Tmem119"

 d = edgeR::cpm(y)
 a <- d
 a.df <- as.data.frame(a)
 t1 <- a.df[ rownames(a.df) %in% g2,]
 dim(t1)
#  [1] 28 17
> Heatmap(log10(t1+1), name="log10 (cpm+1)", column_names_side="top", clustering_distance_columns="pearson", clustering_method_columns="complete", column_dend_height=unit(15*3, "mm"))

#####################################################################################
> mg.1 <- SetIdent(mg.1, value="RNA_snn_res.0.6")
 mic <- c(0, 1, 2, 3, 5, 8)
 x <- c(13)
 markers <- FindMarkers(mg.1, ident.1 = x, ident.2 = mic)
#x cluster:  Astrocyte Brain Mouse	2.185e-58	4.370e-56	42.96 (odds ratio)

>  x <- c(6,12)
  markers <- FindMarkers(mg.1, ident.1 = x, ident.2 = mic, min.pct= 0.05)
 write.table(markers[ markers$avg_log2FC > 2 & markers$p_val < 1e-320,], "temp", sep="\t")
# Ifitm2	0	2.963490964	0.259	0.037	0
# Lgals3	0	4.280857808	0.353	0.036	0
# Isg15	0	3.451949179	0.586	0.108	0
> markers[ c("Tgfbi","Ifitm2", "Ifitm3", "S100a6", "Ly6c2", "Ccr2"),]
               p_val avg_log2FC pct.1 pct.2     p_val_adj
Tgfbi   1.977447e-29  0.4678874 0.122 0.061  2.890631e-25
Ifitm2  0.000000e+00  2.9634910 0.259 0.037  0.000000e+00
Ifitm3  0.000000e+00  2.7727462 0.710 0.190  0.000000e+00
S100a6 3.353127e-176  3.2363519 0.095 0.013 4.901602e-172
Ly6c2   3.598587e-56  1.7105822 0.092 0.031  5.260415e-52

Ccr2 3.088182e-20   1.545681 0.033 0.011 4.514304e-16
clusters 6/12:  intMoMΦ intermediate monocyte–macrophage

> t1 <- as.data.frame( mg.1@meta.data)
> dim(t1)
[1] 40401     8
> write.table(t1, "temp1", quote=F, sep="\t" )
linyongmao@Linyong-Mao-MBP16-2019 autism % cat ../microglia-mouse/temp1 | cut -f 2,6 |grep ctrl |cut -f 2 |sort -g | uniq -c
5221 0
3704 1
3270 2
2629 3
 287 4
2219 5
 553 6
 664 7
 732 8
  64 9
  50 10
 117 11
  60 12
 221 13
 134 14
  44 15
  44 16
5221 + 3704 + 3270 + 2629 + 2219 + 732 = 17775
17775 / 20013 = 0.8881727
linyongmao@Linyong-Mao-MBP16-2019 autism % cat ../microglia-mouse/temp1 | cut -f 2,6 |grep tumor |cut -f 2 |sort -g | uniq -c
4148 0
2703 1
1964 2
1828 3
3857 4
1091 5
1587 6
 537 7
 363 8
 641 9
 641 10
 460 11
 329 12
 118 13
  76 14
  27 15
  18 16
4148 + 2703 + 1964 + 1828 + 1091 + 363 = 12097
12097 / 20388 = 0.5933392

################################################################################
> ref <- fetchReference("hpca", "2024-02-26")
> ref <- fetchReference("mouse_rnaseq", "2024-02-26")
ref <- fetchReference("monaco_immune", "2024-02-26")

 mg.1 <- readRDS("mouse.scRNA.mg.1.seurat5.nov2024.rds")
DefaultAssay(immune.combined) <- "RNA"
 ref.1.avg <- AverageExpression(mg.1, group.by="RNA_snn_res.0.6", slot="data", verbose=T)
 sum(ref.1.avg$RNA[,1])
#  [1] 10000
# un-log first
# x11, x12, x13
# x21, x22, x23
# x31, x32, x33
#1/3(x11 + ... + x33) = 1/3(10k + 10k + 10k) = 10k

 ref.data <-celldex::MouseRNAseqData()
 pred <- SingleR(test = ref.1.avg$RNA , ref = ref.data,  labels =  ref.data$label.fine, assay.type.test=1)
 t1 <- as.data.frame(ref.1.avg$RNA)
 data.frame(colnames(t1), pred$labels, pred$delta.next, pred$pruned.labels)
#     colnames.t1.       pred.labels pred.delta.next pred.pruned.labels
#  1            g0         Microglia      0.11343338          Microglia
#  6           g13         Microglia      0.08559813               <NA>

> t2 <-as.data.frame( pred$scores)
 rownames(t2) <- pred@rownames
 t3 <- t2[ rownames(t2) %in% c("g0","g1", "g2", "g3", "g5", "g8", "g6", "g12", "g13"),]
 eatmap(t3, name="corr", column_names_side="top", column_dend_height=unit(25, "mm"))
 dim(t3)
#  [1]  9 28

#######################################################################
 mg.2 <- mg.1[, grep("tumor", mg.1$orig.ident)]
 mg.2
#  14618 features across 20388 samples within 1 assay
 mg.2 <- mg.2[, mg.2$RNA_snn_res.0.6 %in% c(10)]
 mg.2
#  14618 features across 641 samples within 1 assay

 mg.3 <- CreateSeuratObject(counts = mg.2@assays$RNA$counts)
 mg.3$stim <-  mg.2$orig.ident

 identical(mg.3@assays$RNA$counts[, 1:100], mg.2@assays$RNA$counts[,1:100])
 identical(mg.3@meta.data$stim, mg.2@meta.data$orig.ident)

 mg.2 <- 1
 unique(mg.3@meta.data$stim)

 mg.3[["RNA"]] <- split(mg.3[["RNA"]], f = mg.3$stim)
 mg.3
#  14618 features across 641 samples within 1 assay
#  Active assay: RNA (14618 features, 0 variable features)
#   4 layers present: counts.f-tumor-1, counts.f-tumor-2, counts.m-tumor-1, counts.m-tumor-2

mg.3 <- NormalizeData(mg.3)
 mg.3 <- FindVariableFeatures(mg.3, nfeatures=400)

mg.3 <- ScaleData(mg.3)
mg.3 <- RunPCA(mg.3)
# After preprocessing, we integrate layers.
 mg.3 <- IntegrateLayers(object = mg.3, method = CCAIntegration, orig.reduction = "pca", new.reduction = "integrated.cca",    verbose = T, dims=1:10, k.weight=40)

mg.3[["RNA"]] <- JoinLayers(mg.3[["RNA"]])
 mg.3 <- FindNeighbors(mg.3, reduction = "integrated.cca", dims = 1:10)
 mg.3 <- FindClusters(mg.3, resolution = 0.2)
 mg.3 <- RunUMAP(mg.3, dims = 1:10, reduction = "integrated.cca")
 DimPlot(mg.3, reduction = "umap", group.by = c( "RNA_snn_res.0.2"), label=T)
 VlnPlot(mg.3, features = c("Ms4a1", "Cd3d"),  group.by = "RNA_snn_res.0.2", pt.size = 0.1, combine = T)
 FeaturePlot(mg.3, features = c( "Ms4a1", "Cd3d"),   cols = c("grey", "red"), reduction = "umap", label=T)

#################################################################
Dec 20, 2025
no data integration among 8 mice
> mg.1[["RNA"]] <- JoinLayers(mg.1[["RNA"]])
mg.1 <- NormalizeData(mg.1)
mg.1 <- FindVariableFeatures(mg.1)
mg.1 <- ScaleData(mg.1)
mg.1 <- RunPCA(mg.1)
 mg.1 <- FindNeighbors(mg.1, reduction = "pca", dims = 1:30)
 mg.1 <- FindClusters(mg.1, resolution = 0.6)

#  Number of nodes: 40401
#  Number of edges: 1286671
#  Maximum modularity in 10 random starts: 0.8789
#  Number of communities: 22
 mg.1 <- RunUMAP(mg.1, dims = 1:30)
 DimPlot(mg.1, reduction = "umap", label=T)
 mg.1$tum <- "tumor"
 t22 <- grep("ctrl", mg.1$orig.ident)
 mg.1$tum[t22] <- "ctrl"
 mg.1@meta.data[ sample(1:40401, 20), c(1,7)]
 DimPlot(mg.1, reduction = "umap", label=F, group.by= "tum", shuffle=TRUE)
#######
>  mg.1 <- readRDS("mouse.scRNA.mg.1.seurat5.nov2024.rds")
mg.1 <- SetIdent(mg.1, value="RNA_snn_res.0.6")
mg.1 <- RunUMAP(mg.1, dims = 1:30, reduction = "integrated.cca")
 # Visualization
  DimPlot(mg.1, reduction = "umap", group.by = c( "RNA_snn_res.0.6"), label=T)
mg.1$tum <- "tumor"
 t22 <- grep("ctrl", mg.1$orig.ident)
 mg.1$tum[t22] <- "ctrl"
 mg.1@meta.data[ sample(1:40401, 20), c(1,7)]
 DimPlot(mg.1, reduction = "umap", label=F, group.by= "tum", shuffle=TRUE)
> ta <- table(mg.1$RNA_snn_res.0.6, mg.1$tum)
 write.table(ta, "temp2", sep="\t", quote=F)
 t1 <- read.delim("temp2")
 t1$cluster <- rownames(t1)
 sc <- sum(t1$ctrl)
 st <- sum(t1$tumor)
 t1$ctrl.freq <- t1$ctrl / sc
 t1$tumor.freq <- t1$tumor / st

##################################
 dim(pb)
 # [1]    17 14618
 t1 <- as.data.frame(t(pb))
 head(t1)
#             0    1  10  11  12 13 14  15 16   2   3    4   5   6   7   8   9   
#  Sox17      1    0   0   0   0  0  1 139  0   0   1    0   0   0   0   0   0   
#  Mrpl15  1115 1021 132  84 139 49 10  12  7 602 684 1218 297 617 150 137 214 
 dim(t1)
#  [1] 14618    17  
 group <- factor(rep(1, 17))
 y <- DGEList(counts=t1,group=group)
 y <- calcNormFactors(y)
 y
 d = edgeR::cpm(y)
 a.df <- as.data.frame(d)
 a.df[1:6,1:6]

 j=6 
a.2 <- a.df[, c(1:(j-1),(j+1):17)]
a.df$ratio = -999
 colnames(a.df)
for( i in 1:dim(a.df)[1]) {
a.df$ratio[i] <- (a.df[i,j]+1) / (max(a.2[i,]) + 1)
}
  dim(a.df[ a.df$ratio > 50,])

# 6th column, cluster #13
# 23 marker gene
# Term  Overlap P-value Adjusted P-value        Old P-value     Old Adjusted P-value    Odds Ratio      Combined Score  Genes
# Astrocyte Brain Mouse 15/582  3.007170870993788E-18   2.706453783894409E-16   0       0       64.18650793650794       2589.638806524734       ENTPD2;TTYH1;NRXN1;SLC1A2;AQP4;GPR37L1;SLC4A4;BCAN;CLDN10;PTPRZ1;GJB6;GPC5;ALDOC;PLPP3;FJX1

> (a.df[ a.df$ratio > 20,c(6,18)])
                13     ratio
Gpr37l1  295.78960 122.72827
Fjx1      95.11256  47.26700
Slc1a2   367.90791  28.22175
...

###
 a.2 <- a.df[, c(1:3,5:11, 13:16)]
 a.df$ratio = -999
 colnames(a.df)
# clusters 4,9,11 mean vs remaining-clusters-mean 
for( i in 1:dim(a.df)[1]) {
 a.df$ratio[i] <- (mean(as.numeric(a.df[i,c(4,12,17)]))+1) / (mean(as.numeric(a.2[i,])) + 1)
}
> (a.df[ a.df$ratio > 20,c(4,12,17,18)])
                 11           4           9     ratio
Ifi205  1994.082057  705.095636 1657.267955  81.29818
###
> identical(mg.1$RNA_snn_res.0.6, Idents(mg.1))
[1] TRUE
> x=c(4,9,11)
> y=c(0:3,5:8,10,12:16)
> markers <- FindMarkers(mg.1, ident.1 = x, ident.2 = y, min.pct= 0.25)
> dim(markers)
[1] 1764    5
> markers[c("Ccr2", "Cx3cr1", "Tmem119", "P2ry12", "Itgam"),]
                p_val avg_log2FC pct.1 pct.2     p_val_adj
Ccr2     0.000000e+00   5.378586 0.532 0.016  0.000000e+00
Cx3cr1   0.000000e+00  -3.339229 0.310 0.894  0.000000e+00
Tmem119  0.000000e+00  -4.414243 0.209 0.894  0.000000e+00
P2ry12   0.000000e+00  -4.993260 0.257 0.923  0.000000e+00
Itgam   3.690344e-110  -1.531314 0.217 0.324 5.394545e-106
> dim(markers[ markers$p_val == 0 & markers$avg_log2FC > 0,])
[1] 488   5   

##########
dim(pb)
# [1]    17 14618
t1 <- as.data.frame(t(pb))
head(t1)
dim(t1)
 sce1 <- SingleCellExperiment(assays = list(counts = t1))
 sce1@assays@data$counts[1:11,1:17]
 celldex::
 ref.data <-celldex::MouseRNAseqData()
#  It is perfectly satisfactory to provide the raw counts for the test dataset to SingleR(), 
#  which is the reason for setting assay.type.test=1 in our previous SingleR() call for the Grun dataset. 
# The exception to this rule occurs when comparing data from full-length technologies to the celldex references.  
# Thus, when annotating Smart-seq2 test datasets against the celldex references, 
# better performance can often be achieved by processing the test counts to transcripts-per-million values.
pred <- SingleR(test = sce1 , ref = ref.data,  labels =  ref.data$label.fine, assay.type.test=1)
 data.frame(colnames(t1), pred$labels, pred$delta.next, pred$pruned.labels)
#    colnames.t1.       pred.labels pred.delta.next pred.pruned.labels
# 1             0         Microglia      0.11154070          Microglia
# 2             1         Microglia      0.08699047          Microglia
# 3            10          NK cells      0.08801227           NK cells

> s1 <- as.data.frame(pred$scores)
 rownames(s1) <- colnames(sce1)
  col_fun = colorRamp2(c(-0.2, 0.5, 0.8), c( "blue", "white",  "red"))
eatmap(s1, row_order=c(1,2,10,11,13,16, 14, 12, 17, 4, 15, 3,5,6,7,8,9), name="corr.", col=col_fun)

library(celldex)
surveyReferences()
###########################
> sum(mg.1$RNA_snn_res.0.6 == mg.1$seurat_clusters)
[1] 40401
> ta <- table( mg.1$seurat_clusters, mg.1$orig.ident)
> ta

     f-ctrl-1 f-ctrl-2 f-tumor-1 f-tumor-2 m-ctrl-1 m-ctrl-2 m-tumor-1 m-tumor-2
  0      1397     1651      1037      1256     1233      940       764      1091
  1       997      822       715       778      868     1017       522       688
  2       788      671       559       621      830      981       316       468
 
 write.table(ta, "temp1", quote=F, sep="\t")
 t1 <- read.table("temp1")
#  t1
 t2 <- data.frame(colSums(t1))
 t3 <- t1[rownames(t1) %in% c("4","9", "11"),]
 t2$monocyte <-(colSums(t3))
 t2$mono.freq <- t2[,2] / t2[,1]
 tum <- t2$mono.freq[c(3,4,7,8)]
 ct  <- t2$mono.freq[c(1,2,5,6)]
 t.test(ct, tum)
 wilcox.test(ct, tum)
######
> t1 <- data.frame(cl=(mg.1$RNA_snn_res.0.6))
 head(t1, n=10)
 t1$cell.type <- "microglia"
 t1[ t1$cl %in% c("13"),]$cell.type <- "Astrocyte"
#  t1[ t1$cl %in% c("6"),]$cell.type <- "TAM"
 t1[ t1$cl %in% c("12"),]$cell.type <- "Basal"
 t1[ t1$cl %in% c("7"),]$cell.type <- "Macrophage"
 t1[ t1$cl %in% c("4","9","11"),]$cell.type <- "Monocyte"
 t1[ t1$cl %in% c("10"),]$cell.type <- "NK"
 t1[ t1$cl %in% c("14"),]$cell.type <- "Neutrophil"
 t1[ t1$cl %in% c("15"),]$cell.type <- "Endothelial"
 t1[ t1$cl %in% c("16"),]$cell.type <- "Ependymal"
 mg.1$cell.type <- t1$cell.type
 imPlot(mg.1, reduction = "umap", group.by = c( "cell.type"), label=T, shuffle=TRUE)
 my_colors <- c("TAM" = "red")
 DimPlot(mg.1, reduction = "umap", group.by = c( "cell.type"), label=T, shuffle=TRUE, cols = my_colors )

######
 str(mg.1@meta.data)
 mg.2 <- mg.1[, mg.1$cell.type %in% c("microglia", "Monocyte", "Macrophage")]
 mg.2
counts <- mg.2@assays$RNA$counts
 metadata <- mg.2@meta.data
 metadata$cluster_id <- metadata$RNA_snn_res.0.6
# Create single cell experiment object
sce <- SingleCellExperiment(assays = list(counts = counts),
                           colData = metadata)
# Identify groups for aggregation of counts
# groups: character class
groups <- colData(sce)[, c("cell.type","orig.ident")]

# Aggregate across cluster-sample groups
pb <- aggregate.Matrix(t(counts(sce)),
                       groupings = groups, fun = "sum")

class(pb)

dim(pb)
# [1]    24 14618
t1 <- as.data.frame(t(pb))
head(t1)
dim(t1)
 t2 <- t1[ , !grepl("Monocyte.*ctrl", colnames(t1))]
 dim(t2)
# [1] 14618    20  
 sort(colnames(t2))
#  [1] "Macrophage_f-ctrl-1"  "Macrophage_f-ctrl-2"  "Macrophage_f-tumor-1" "Macrophage_f-tumor-2" "Macrophage_m-ctrl-1"  "Macrophage_m-ctrl-2"  "Macrophage_m-tumor-1"
# [15] "microglia_m-tumor-1"  "microglia_m-tumor-2"  "Monocyte_f-tumor-1"   "Monocyte_f-tumor-2"   "Monocyte_m-tumor-1"   "Monocyte_m-tumor-2"  

 group <- factor(rep(1, 20))
 y <- DGEList(counts=t2,group=group)
 y <- calcNormFactors(y)
 d = edgeR::cpm(y)
  a <- log2(d+1)
  a.df <- as.data.frame(a)
 g1 <-  scan(what="", sep = "\n")
Actb
Itgam
P2ry12
Tmem119
Cx3cr1
Ccr2
Gpr141
F10
> a.df.orig <- a.df
 a.2 <- a.df[ rownames(a.df) %in% g1,]
 a.3 <- as.data.frame(t(a.2))
 a.3$cell.type <- gsub("_[fm].*", "", rownames(a.3), ignore.case=F)
 a.3
#                          Ccr2     Plac8       Ly6i    Ms4a4c  cell.type
# Macrophage_f-ctrl-1  1.811660  1.811660  2.5899841  4.398055 Macrophage
# microglia_f-ctrl-1   2.508328  1.629274  0.8103908  2.175430  microglia
# Monocyte_f-tumor-1   8.979941 12.387852 11.2959707 11.587453   Monocyte

 a.3$col <- "black"
 a.3[ a.3$cell.type == "Macrophage",]$col <- "green"
 a.3[ a.3$cell.type == "Monocyte",]$col <- "red"
 boxplot(a.3[,c(1:5)], outcol="white", ylab="log2(CPM+1)", ylim=c(5, 15)) 
beeswarm(a.3[, c(1:4)], add=T, pwcol= rep(a.3$col,4), cex=2)
 legend(1/2, 12, c("microglia", "Monocyte", "Macrophage"), pch=c(20), col = c( "black", "red", "green" ))

######
> gene = "Kdm5c"
 a.2 <- a.df[rownames(a.df) %in% gene,]
 a.3 <- as.data.frame(t(a.2))

 a.3$sex <- c(rep("female", 4), rep("male", 4))
 g1 <- gsub("[fm]-", "", rownames(a.3))
 g2 <- gsub("-[12]", "", g1)
 a.3$tum <- g2
 a.3
 a.3$col = "red"
 a.3[ a.3$tum == "ctrl",]$col <- "green"
 boxplot(a.3[,1] ~ a.3$sex, ylab="CPM", outcol="white", main=paste(gene, ", p=", format(df[ rownames(df) == gene,]$PValue, digits=3),sep=""))
 beeswarm(a.3[,1] ~ a.3$sex, add=T, pwcol=a.3$col, cex=2)
 legend(1/2, 12, c("ctrl", "tumor"), pch=c(20), col = c( "green", "red" ), cex=2)

> a.3
#              Kdm5c    sex   tum   col
# f-ctrl-1  17.48153 female  ctrl green
# f-ctrl-2  17.83679 female  ctrl green
# f-tumor-1 16.90144 female tumor   red
# f-tumor-2 14.72528 female tumor   red
# m-ctrl-1  11.33010   male  ctrl green
