linyong@tak /lab/solexa_page/linyong/cyno-data$ head -50 script*
==> script-cyno-atac-seq-bwa <==
#
cat ~/cyno-atac-seq-info |grep -i atac | grep -i pu.1 | cut -f 1 | while read id 
do 
 ls -lh "/lab/solexa_public/Page/230215_WIGTC-NOVASEQ1A_AHW33KDRX2/FASTQ/$id"* 
 echo 
 f1=`ls "/lab/solexa_public/Page/230215_WIGTC-NOVASEQ1A_AHW33KDRX2/FASTQ/$id"* | head -1`
 f2=`ls "/lab/solexa_public/Page/230215_WIGTC-NOVASEQ1A_AHW33KDRX2/FASTQ/$id"* | awk 'NR == 2' `
 bwa mem -t 4 /lab/solexa_page/linyong/cyno-genome/GCF_012559485_plus_Y.fna "$f1" "$f2" > "$id".sam
done



==> script-sam2bam <==
#

ls L16_620*.mapQ.paired.sam | while read f
do
 id=`echo "$f" | sed 's/.sam//' `
 samtools view -b -S  -t /lab/solexa_page/linyong/cyno-genome/GCF_012559485_plus_Y.fna.fai -o "$id".bam  "$f"
 ls -lh "$id".bam "$f" 
done


==> script-select-readss <==
#

ls L16_620*.sam | while read f
do
 id=`echo "$f" | sed 's/.sam//' `
 echo "$id"
 awk 'BEGIN {FS = "\t";} !($2 != 99 && $2 != 147 && $2 != 83 && $2 != 163) && $5 == 60'  "$f" > "$id".kept.sam
 ls -lh "$f"  "$id".kept.sam
 wc -l "$f"  "$id".kept.sam

done

==> script-select-readss-2 <==
#

ls L16_620*.kept.sam | while read f
do
 id=`echo "$f" | sed 's/.kept.sam//' `
 echo "$id"
 cut -f 1 "$f" | sort | uniq -d > temp.paired.reads-ID
 /lab/solexa_page/linyong/getSam-ID  temp.paired.reads-ID "$f" > "$id".mapQ.paired.sam
 ls -lh  "$id".sam  "$id".kept.sam "$id".mapQ.paired.sam
 wc -l "$id".sam  "$id".kept.sam "$id".mapQ.paired.sam
 
done

==>   linyong@tak /lab/solexa_page/linyong/cyno-data$ cat   script-macs2-01   
#
ls L16_620*.mapQ.paired.bam | while read f
do
 id=`echo "$f" | sed 's/.bam//' `
 macs2 callpeak -f BAMPE -t "$f" -g 2.53e9 --keep-dup all --outdir dir-macs2-defalt-param  -n "$id" --tempdir "/tmp"   

done

####################################################################################
ls /lab/solexa_public/Page/230215_WIGTC-NOVASEQ1A_AHW33KDRX2/FASTQ/
ls /lab/solexa_public/Page/230217_WIGTC-NOVASEQ1B_BHW3Y5DRX2/FASTQ/

grep -iw spi1 /lab/page_genomes/Macaca_fascicularis/genome/assemblies/GCF_012559485/GCF_012559485.2_MFA1912RKSv2_genomic.gtf | grep 107415874
grep ">" /lab/page_genomes/Macaca_fascicularis/genome/assemblies/GCF_012559485_plus_Y/GCF_012559485_plus_Y.fna | grep -v place | wc

     23     259    2329
cat L16_6209.mapQ.paired_peaks.xls | awk 'NR > 22' | awk 'BEGIN {FS = "\t"; OFS = "\t";}  
    {
     a=$2-100;
     if(a < 1) 
     {
      a = 1;
     }
     print $1, a, $3+100, $10 }' > temp-L16_6209.bed

cat L16_6204.mapQ.paired_peaks.xls | awk 'NR > 22' | awk 'BEGIN {FS = "\t"; OFS = "\t";}  {print $1, $2, $3, $10 }' > temp-L16_6204.bed
bedtools intersect -a temp-L16_6209.bed -b temp-L16_6204.bed -wa -wb
bedtools intersect -a temp-L16_6209.bed -b temp-L16_6204.bed -wa -wb | wc
 102875  823000 12963239
bedtools intersect -a temp-L16_6209.bed -b temp-L16_6204.bed -wa -wb  | cut -f 4 | sort | uniq | wc -l
98106

chr     start   end     length  abs_summit      pileup  -log10(pvalue)  fold_enrichment -log10(qvalue)  name

macs3 callpeak -f BAMPE -t ATAC.bam -g hs -n test -B -q 0.01

macs2 callpeak -f BAMPE -t L16_6204.mapQ.paired.bam -g 2.53e9 --keep-dup all --outdir dir-macs2peaks -n NAME --tempdir "/tmp"   -B --SPMR  --call-summits
macs2 callpeak -f BAMPE -t L16_6204.mapQ.paired.bam -g 2.53e9 --keep-dup all --outdir dir-macs2peaks -n NAME --tempdir "/tmp"

=====================>cat ../script-peak-overlap
#

t="$1" ####L16_6204

cat "$t".mapQ.paired_peaks.xls | awk 'NR > 22' | awk 'BEGIN {FS = "\t"; OFS = "\t";}  
    {
     a=$2-100;
     if(a < 1) 
     {
      a = 1;
     }
     print $1, a, $3+100, $10 }' > temp-target.bed

for q in `echo L16_6204 L16_6205 L16_6208 L16_6209`
do
  if [ "$q" != "$t" ]
  then
    cat "$q".mapQ.paired_peaks.xls | awk 'NR > 22' | awk 'BEGIN {FS = "\t"; OFS = "\t";}  {print $1, $2, $3, $10 }' > temp-"$q".bed
    bedtools intersect -a temp-target.bed -b temp-"$q".bed -wa -wb  > temp-"$t"."$q".overlap
    echo -n "$t	$q	"
    cat temp-"$t"."$q".overlap | cut -f 4 | sort | uniq | wc -l
  fi
done
#########################################
ls temp-L16_6209.*.overlap -lh
cat temp-L16_6209.*.overlap  |  cut -f 1-4 | sort | uniq -c | awk '$1 > 2' | wc
# 29291  146455 2087263

for q in `echo L16_6204 L16_6205 L16_6208 L16_6209`; do bash  ../script-peak-overlap $q; done
# peak overlapped with  other 2 or more peaks of diff samples
cat temp-*.overlap | cut -f 1-4 | sort | uniq -c | awk '$1 >= 2' |  awk 'BEGIN {OFS = "\t";} {print $5}' > conserved.3samp.peaks

wc -l conserved.3.peaks
296476 conserved.3.peaks
cat temp-*.overlap | cut -f 1-4 | sort | uniq -c | awk '$1 >= 2' |  awk 'BEGIN {OFS = "\t";} {print $5}' > conserved.3samp.peaks
cat *.mapQ.paired_peaks.xls | awk 'BEGIN {FS = "\t";} NF > 5' | sort -t '        ' +9 -10 > temp-1
sort +0 -1 conserved.3samp.peaks > temp-2
join -t '        ' -1 1 -2 10 temp-2 temp-1 -o "2.1,2.2,2.3,2.10" > conserved.3samp.peaks.coord
cat conserved.3samp.peaks.coord | cut -f 4 | sed 's/paired_peak_[0-9][0-9]*//' | sort | uniq -c
  59902 L16_6204.mapQ.
  80950 L16_6205.mapQ.
  69803 L16_6208.mapQ.
  85821 L16_6209.mapQ.

cat /lab/page_genomes/Macaca_fascicularis/genome/assemblies/GCF_012559485_plus_Y/GCF_012559485.2_MFA1912RKSv2_genomic_plus_Y.gtf | awk 'BEGIN {FS = "\t"; OFS = "\t";} NF > 6 && $3 == "gene"' > temp-gene
wc -l temp-gene
35591 temp-gene

cat temp-gene |  awk 'BEGIN {FS = "\t"; OFS = "\t";} 
  {
   if($7 == "+")
   {
    a = $4 - 2000;
    b = $4 + 2000;
   }
   else if ($7 == "-")
   {
    a = $5 - 2000;
    b = $5 + 2000;
   }
   else
   {t=0
   }
   if(a < 1) a= 1;
   print $1,a,b,$9;
  }' > temp-gene.bed
bedtools intersect -a temp-gene.bed -b conserved.3samp.peaks.coord -wa -wb  > temp.gene.2kbp.peak
cut -f 4 temp.gene.2kbp.peak | sort | uniq | wc -l
17722


######################################### peak also overlaped/nearby of two or more diff samples
cat temp-*.overlap | sed 's/.mapQ.paired_peak_[0-9]*$//' | cut -f 4,8 | sort | uniq | cut -f 1 | uniq -c |  awk '$1 >= 2' |  awk 'BEGIN {OFS = "\t";} {print $2}' > conserved.3samp.peaks
wc -l conserved.3samp.peaks
273130 conserved.3samp.peaks
cat *.mapQ.paired_peaks.xls | awk 'BEGIN {FS = "\t";} NF > 5' | sort -t '       ' +9 -10 > temp-1
sort +0 -1 conserved.3samp.peaks > temp-2
join -t '       ' -1 1 -2 10 temp-2 temp-1 -o "2.1,2.2,2.3,2.10" > conserved.3samp.peaks.coord
cat conserved.3samp.peaks.coord | cut -f 4 | sed 's/paired_peak_[0-9][0-9]*//' | sort | uniq -c
  55991 L16_6204.mapQ.
  73778 L16_6205.mapQ.
  62183 L16_6208.mapQ.
  81178 L16_6209.mapQ.
cat /lab/page_genomes/Macaca_fascicularis/genome/assemblies/GCF_012559485_plus_Y/GCF_012559485.2_MFA1912RKSv2_genomic_plus_Y.gtf | awk 'BEGIN {FS = "\t"; OFS = "\t";} NF > 6 && $3 == "gene"' > temp-gene
wc -l temp-gene
35591 temp-gene

cat temp-gene |  awk 'BEGIN {FS = "\t"; OFS = "\t";}
  {
   if($7 == "+")
   {
    a = $4 - 2000;
    b = $4 + 2000;
   }
   else if ($7 == "-")
   {
    a = $5 - 2000;
    b = $5 + 2000;
   }
   else
   {t=0
   }
   if(a < 1) a= 1;
   print $1,a,b,$9;
  }' > temp-gene.bed
bedtools intersect -a temp-gene.bed -b conserved.3samp.peaks.coord -wa -wb  > temp.gene.2kbp.peak
cut -f 4 temp.gene.2kbp.peak | sort | uniq | wc -l
16914


cat temp.gene.2kbp.peak |  awk 'BEGIN {FS = "\t"; OFS = "\t";} {print $8, $4}' | sed 's/;.*//' | sort -t '  ' +0 -1 > temp.gene.2kbp.peak.geneID
rm temp-2
cat  *.mapQ.paired_peaks.xls | awk 'BEGIN {FS = "\t"; OFS = "\t";} NF > 6' | sort -t '      ' +9 -10 > temp-2
join -t '        ' -1 1 -2 10 temp.gene.2kbp.peak.geneID temp-2 > temp.gene.2kbp.peak.geneID.peak.pvalue
wc -l  temp.gene.2kbp.peak.geneID temp-2 temp.gene.2kbp.peak.geneID.peak.pvalue
    97853 temp.gene.2kbp.peak.geneID
  2108351 temp-2
    97853 temp.gene.2kbp.peak.geneID.peak.pvalue

cat temp.gene.2kbp.peak.geneID.peak.pvalue | sort -t '   ' +1 -2 > temp.gene.2kbp.peak.geneID.peak.pvalue.sortbygeneID
cat /lab/page_genomes/Macaca_fascicularis/genome/assemblies/GCF_012559485_plus_Y/GCF_012559485.2_MFA1912RKSv2_genomic_plus_Y.gtf | awk 'BEGIN {FS = "\t"; OFS = "\t";} NF > 6 && $3 == "gene"' > temp-gene
cat  temp-gene | sed 's/;.*//' | awk 'BEGIN {FS = "\t"; OFS = "\t";} {print $9, $1, $4, $5, $7}' | sort -t '        ' +0 -1 > temp-gene-coord
join -t '        ' -1 1 -2 2 temp-gene-coord temp.gene.2kbp.peak.geneID.peak.pvalue.sortbygeneID > temp.gene.2kbp.peak.6
cd /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param
cyno.gene.2kbp.promoter.atac.peaks.ge3samples.txt

sort -t '        ' +0 -1 +1 -2n  conserved.3samp.peaks.coord > conserved.3samp.peaks.coord.sorted
bedtools merge -d 100 -i conserved.3samp.peaks.coord.sorted > conserved.3samp.peaks.coord.merged
wc -l conserved.3samp.peaks.coord.merged
79513 conserved.3samp.peaks.coord.merged

# The output will be named the following way:
# chr1    pfurio     peak     724705  724804   .      +       .      peak_id="chr1_724705_724804"
# chr1    pfurio     peak     724805  725050   .      +       .      peak_id="chr1_724805_725050"
# chr1    pfurio     peak     725051  725150   .      +       .      peak_id="chr1_725051_725150"

rm -f conserved.3samp.peaks.coord.merged.gtf
cat conserved.3samp.peaks.coord.merged |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""}
 {
   print $1 "\t" "macs2" "\t" "peak" "\t"  $2 "\t" $3 "\t" "." "\t" "+"  "\t" "."  "\t" "peak_id=\"" $1 "@@@" $2 "@@@" $3  "\"" "\n";
 }' > conserved.3samp.peaks.coord.merged.gtf

 
===================> cat ../script-peak-read-count
#
ls ../L16_620*.mapQ.paired.bam | while read f
do
 id=`echo "$f" | sed 's/.bam//' | sed 's/..\///' `
 echo "$id"
 ###testing bam sorted by read names
 samtools view "$f" | head -1000000 | cut -f 1 | uniq -d | wc -l
 ## --nonunique=default: none
 htseq-count  --mode=intersection-strict   --stranded=no --idattr=peak_id  --format=bam  --order=name --type=peak "$f"   conserved.3samp.peaks.coord.merged.gtf > "$id".conserved.3samp.peaks.readcount


done

=======>cat temp-s1
#
b=`ls L16_62*readcount | awk 'NR == 1' `
id=`echo "$b" | sed 's/.mapQ.paired.conserved.3samp.peaks.readcount//'`
echo "peak	$id" > s
cat "$b" >> s

ls  L16_62*readcount | awk 'NR > 1' | while read f
do
 id=`echo "$f" | sed 's/.mapQ.paired.conserved.3samp.peaks.readcount//'`
 echo "$id" > f2
 cut -f 2 "$f" >> f2
 paste s f2 > m
 mv m s
done

=============
 mv -i s L16.4samples.mapQ.paired.conserved.3samp.peaks.readcount
paste L16_620*.mapQ.paired.conserved.3samp.peaks.readcount | awk '$1 != $3' | wc -l
0
paste L16_620*.mapQ.paired.conserved.3samp.peaks.readcount | awk '$1 != $5' | wc -l
0
paste L16_620*.mapQ.paired.conserved.3samp.peaks.readcount | awk '$1 != $7' | wc -l
0

========================> cat temp-s2
#

ls -lh L16.4samples.mapQ.paired.conserved.3samp.peaks.readcount 
wc -l L16.4samples.mapQ.paired.conserved.3samp.peaks.readcount

head -1 L16.4samples.mapQ.paired.conserved.3samp.peaks.readcount > temp-1338
cat L16.4samples.mapQ.paired.conserved.3samp.peaks.readcount | awk 'NR > 1' |  awk 'BEGIN {FS = "\t"; OFS = ""; }
 {
  a=0;
  for(i = 2; i <= NF; i++)
  {
   if($i >= 6) a++
  }
  if(a >= 3) print $0;
 }' >> temp-1338

mv temp-1338 L16.4samples.mapQ.paired.conserved.3samp.peaks.readcount.2
wc -l L16.4samples.mapQ.paired.conserved.3samp.peaks.readcount.2
======================= 

  79519 L16.4samples.mapQ.paired.conserved.3samp.peaks.readcount
  70645 L16.4samples.mapQ.paired.conserved.3samp.peaks.readcount.2

vi L16.4samples.mapQ.paired.conserved.3samp.peaks.readcount.2
###no --no-features
tail L16.4samples.mapQ.paired.conserved.3samp.peaks.readcount.2
head L16.4samples.mapQ.paired.conserved.3samp.peaks.readcount.2
cat L16.4samples.mapQ.paired.conserved.3samp.peaks.readcount.2 | awk 'NR % 2000 == 0'

> setwd("~")
setwd("Documents/autism/")
rawCount <- read.delim("L16.4samples.mapQ.paired.conserved.3samp.peaks.readcount.2", header = T, row.names = 1)
group <- factor(rep(1, 4))
y <- DGEList(counts=rawCount,group=group)
y <- calcNormFactors(y)

$samples
         group lib.size norm.factors
L16_6204     1 14816318    0.6526096
L16_6205     1 11782753    1.0855438
L16_6208     1 10390876    1.5565286
L16_6209     1 14568029    0.9068638
## [1]libsize*normfactor  9669271 12790695 16173696 13211218

plotMDS(y, top=98765)
 sex <- c("F", "F", "F", "M")
 design <- model.matrix(~sex)
 design
y <- estimateDisp(y,design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, coef=2)
top2v1 <- topTags(qlf, n = 91234)
write.table(top2v1, "diff2-1.txt", sep="\t", quote = F)

........
d <- cpm(y)
write.table(d, "temp.txt", quote=F, sep = "\t")

###########################################################compare normalization effect with diff lib size
> head(cpm(y))
                                       L16_6204    L16_6205    L16_6208  L16_6209
NC_012670.1@@@15968@@@16390         3968.137629 2536.062438 3283.355913 1.5895582
NC_012670.1@@@6438@@@6546           1813.270011 1511.098551 1249.374302 0.3027730
NC_052255.1@@@100007185@@@100007879   42.609208   20.014550   12.798559 2.3464906
NC_052255.1@@@100008227@@@100008850   72.601126   28.849098   17.497547 8.5533368
NC_052255.1@@@100020525@@@100020806    2.688931    1.485455    3.771556 0.2270797
NC_052255.1@@@100027827@@@100028240   35.990302    8.365457    5.379104 4.9957542
> 
> rawCount <- read.delim("L16.4samples.mapQ.paired.conserved.3samp.peaks.readcount.2", header = T, row.names = 1)
> t <- rawCount$L16_6208 / 1.25
> rawCount$L16_6208 <- t
> y <- DGEList(counts=rawCount,group=group)
> y <- calcNormFactors(y)
> y
An object of class "DGEList"
$counts
                                    L16_6204 L16_6205 L16_6208 L16_6209
NC_012670.1@@@15968@@@16390            38369    32438  42483.2       21
NC_012670.1@@@6438@@@6546              17533    19328  16165.6        4
NC_052255.1@@@100007185@@@100007879      412      256    165.6       31
NC_052255.1@@@100008227@@@100008850      702      369    226.4      113
NC_052255.1@@@100020525@@@100020806       26       19     48.8        3
70639 more rows ...

$samples
         group lib.size norm.factors
L16_6204     1 14816318    0.6514786
L16_6205     1 11782753    1.0836626
L16_6208     1  8312701    1.5646491
L16_6209     1 14568029    0.9052922

> 
> head(cpm(y))
                                       L16_6204    L16_6205    L16_6208  L16_6209
NC_012670.1@@@15968@@@16390         3975.026288 2540.465024 3266.315462 1.5923176
NC_012670.1@@@6438@@@6546           1816.417835 1513.721807 1242.890113 0.3032986
NC_052255.1@@@100007185@@@100007879   42.683177   20.049295   12.732135 2.3505641
NC_052255.1@@@100008227@@@100008850   72.727161   28.899180   17.406735 8.5681853
NC_052255.1@@@100020525@@@100020806    2.693599    1.488034    3.751982 0.2274739
NC_052255.1@@@100027827@@@100028240   36.052781    8.379979    5.351187 5.0044268
#######################################################################################

head -20 L16.4samples.conserved.3samp.peaks.readcount.2.diff2-1.txt | while read ll
do
 echo "$ll" | cut -f 1-5
 id=`echo "$ll" | cut -f 1`
 grep -w "$id" L16.4samples.mapQ.paired.conserved.3samp.peaks.readcount.2     L16.4samples.conserved.3samp.peaks.readcount.2.cpm.txt
 echo
done

ls -lh temp-gene.bed 
-rw-r--r-- 1 linyong input 5.5M May  9 12:56 temp-gene.bed
cat  conserved.3samp.peaks.coord.merged | awk '{print $0 "\t" $1 "@@@" $2 "@@@" $3 }' > conserved.3samp.peaks.coord.merged.bed
bedtools intersect -a temp-gene.bed -b   conserved.3samp.peaks.coord.merged.bed -wa -wb  > temp1
cut -f 4 temp1 | sort | uniq | wc -l
16914
cat temp1  |  awk 'BEGIN {FS = "\t"; OFS = "\t";} {print $8, $4}' | sed 's/;.*//' | sort -t '       ' +0 -1 > temp2
head temp2
NC_012670.1@@@15968@@@16390	gene_id "KEG98_p01"
cat  temp2 |   sort -t ' ' +1 -2  > temp2-sorted
## -rw-r--r-- 1 linyong input 1.8M May  9 13:20 temp-gene-coord
join -t '        ' -1 1 -2 2 temp-gene-coord temp2-sorted > temp2-genes
wc -l temp-gene-coord temp2-sorted temp2-genes
  35591 temp-gene-coord
  21582 temp2-sorted
  21582 temp2-genes
head temp2-genes
gene_id "AAAS"	NC_052265.1	50081541	50095684	-	NC_052265.1@@@50095425@@@50096224
gene_id "AAR2"	NC_052264.1	32415598	32448062	+	NC_052264.1@@@32415026@@@32415838

linyongmao@Linyong-Mao-MBP16-2019 autism % sort -t '    ' +5 -6 temp2-genes > temp2-genes-sorted
sort -t '    ' +0 -1  L16.4samples.conserved.3samp.peaks.readcount.2.diff2-1.txt > temp3
join -t '    ' -1 6  -2 1 temp2-genes-sorted  temp3 > temp4
wc -l  temp3 temp2-genes-sorted temp4                  
   70645 temp3
   21582 temp2-genes-sorted
   20919 temp4  ##less peaks because requiring peak with >= 6 reads in >= 3 samples
> t1 <- read.delim("L16.4samples.conserved.3samp.peaks.readcount.2.diff2-1.txt")
> t1$id <- rownames(t1)
> t2 <- read.delim("temp2-genes-sorted", header=F)
> t3 <- merge(t2, t1, by.x="V6", by.y="id")
> dim(t3)
[1] 20919    11

#########################
cat cyno.gene.2kbp.promoter.atac.peaksGe3samplesMerged.diff2-1.txt| awk 'BEGIN {FS = "\t"; OFS = "\t";}  {print $2, $3, $4,$5,$6, $1, $7,$8,  $9, $10,  $11} ' > temp
mv -i temp cyno.gene.2kbp.promoter.atac.peaksGe3samplesMerged.diff2-1.txt
head cyno.gene.2kbp.promoter.atac.peaksGe3samplesMerged.diff2-1.txt
gene_id "KEG98_p01"	NC_012670.1	14749	15889	+	NC_012670.1@@@15968@@@16390	-10.9944210770356	11.2570560748315	15.038964625472	0.00154878829710883	0.999991100521646
gene_id "KEG98_p02"	NC_012670.1	14148	14675	-	NC_012670.1@@@15968@@@16390	-10.9944210770356	11.2570560748315	15.038964625472	0.00154878829710883	0.999991100521646

cat cyno.gene.2kbp.promoter.atac.peaksGe3samplesMerged.diff2-1.txt | sed 's/@@@/     /g' > temp.xls
cat temp.xls | awk 'BEGIN {FS = "\t"; OFS = "\t";} $12 < 0.05 && $9 < 0' |  grep -v NC_012670.1 | cut -f 1,2 | grep -v "LOC[0-9][0-9][0-9]*" | cut -f 1 | sort | uniq | sed 's/gene_id "//' | sed 's/"//'
cat cyno.female.enrichment.PMID-3.tsv cyno.female.enrichment.Process-4.tsv > temp1
cat temp1 | grep -w "NLGN3" | cut -f 1-2
cat temp1 | grep -w "NLGN4X" | cut -f 1-2
cat temp1 | grep -w "GPR173" | cut -f 1-2
cat temp.xls | awk 'BEGIN {FS = "\t"; OFS = "\t";} $12 < 0.05 && $9 > 0' |  grep -v NC_012670.1 | cut -f 1,2 | grep -v "LOC[0-9][0-9][0-9]*" | cut -f 1 | sort | uniq | sed 's/gene_id "//' | sed 's/"//'| wc -l
     109

Microglia Pathogen Phagocytosis Pathway WP3937

ls -lh ~/Downloads | grep -iw "may 13" | awk '{print $9}' | sort
ARCHS4_Kinases_Coexp_table.txt
CORUM_table.txt
HDSigDB_Human_2021_table.txt
MSigDB_Hallmark_2020_table.txt
WikiPathway_2021_Human_table.txt
WikiPathways_2016_table.txt
WikiPathways_2019_Mouse_table.txt

ls -lh ~/Downloads | grep -iw "may 13" | awk '{print $9}' | sort | while read f
do
 echo "$f"
 head -1  ~/Downloads/"$f" | cut -f 1-4,7,9
 cat ~/Downloads/"$f" | awk 'BEGIN {FS = "\t"; OFS = "\t";} $4 < 0.05' | cut -f 1-4,7,9
 echo
 echo
done

f="MSigDB_Hallmark_2020_table.txt"
cat ~/Downloads/"$f" | awk 'BEGIN {FS = "\t"; OFS = "\t";} $4 < 0.05' | cut -f 9 | awk 'BEGIN {FS = ";"; } {for (i = 1; i <= NF; i++) print $i;}' | sort | uniq  # | awk 'BEGIN {ORS = " " } {print $1}' 

### Inflammation (Allograft Rejection, IL-6/JAK/STAT3 Signaling, NF-kB, Interferon Gamma. GENES with stronger promoter open chromatin in male : B4GALT1 CASP7 CCR5 CD40 HELZ2 ICOSLG IL4R ITGB2 ITGB3 KLF2 MAP3K8 PIK3R5 RELB TGFB1 TLR6 TNIP2 TRIM25)

f="ARCHS4_Kinases_Coexp_table.txt"
CSF1R human kinase ARCHS4 coexpression	15/299	8.435036230126662E-11	3.019742970385345E-8	11.01681899910099	SLC37A2;OLFML2B;TGFB1;PLXND1;UNC93B1;KCNK13;ITGB2;RHBDF2;CARD9;ADCY7;PIK3R5;KCNQ1;CTSH;KCTD12;CCR5
based on co-expression analysis, male up-reg genes co-expressed with CSF1R (Macrophage Colony-Stimulating Factor 1 Receptor), which regulates proliferation and activation of microglial cells 


cat temp-gene | grep ^Ycons | cut -f 9 | sed 's/;.*//' | sed 's/gene_name "//' | sed 's/"//' | sort | uniq > Y-gene-ids
q=L16_6209
cat "$q".mapQ.paired_peaks.xls | awk 'NR > 22' | awk 'BEGIN {FS = "\t"; OFS = "\t";}  {print $1, $2, $3, $10 }' > temp-1
bedtools intersect -a temp-gene.bed -b  temp-1 -wa -wb  > temp1
head temp1
NC_052255.1	7616	11616	gene_id "LOC123572819"; transcript_id ""; db_xref "GeneID:123572819"; gbkey "Gene"; gene "LOC123572819"; gene_biotype "protein_coding"; 	NC_052255.1	9009	9121	L16_6209.mapQ.paired_peak_13
cat temp1 | grep ^Ycons > Y-gene.2kbp.promoter.atac.peaks.L16_6209.bed.intersect
cut -f 4 Y-gene.2kbp.promoter.atac.peaks.L16_6209.bed.intersect | sed 's/;.*//' | sed 's/gene_name "//' | sed 's/"//' | sort | uniq > temp2

bamCoverage --bam a.bam -o a.SeqDepthNorm.bw \
    --binSize 10
    --normalizeUsing RPGC
    --effectiveGenomeSize 2150570000
    --ignoreForNormalization chrX
    --extendReads

bamCoverage --bam ../L16_6209.mapQ.paired.bam -o L16_6209.bw -p 4 --verbose
samtools sort -@ 4 -o temp.bam ../L16_6209.mapQ.paired.bam
samtools index temp.bam
bamCoverage --bam temp.bam -o temp.bw -p 4 --verbose
# defaultFragmentLength: read length
# maxPairedFragmentLength: 1000
# minMappingQuality: None
# ignoreDuplicates: False

linyong@tak /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param2$ cat ../script-macs2-02
#
ls L16_620*.mapQ.paired.bam | while read f
do
 id=`echo "$f" | sed 's/.bam//' `
 macs2 callpeak -f BAMPE -t "$f" -g 2.53e9 --keep-dup all --outdir dir-macs2-defalt-param2  -n "$id".B.SPMR  --tempdir "/tmp"   -B --SPMR

done
==========
cat ../../cyno-genome/GCF_012559485_plus_Y.fna.fai | cut -f 1-2 > chrom.sizes

for q in `echo L16_6204 L16_6205 L16_6208 L16_6209`
do
 bedGraphToBigWig "$q".mapQ.paired.B.SPMR_treat_pileup.bdg  chrom.sizes    "$q".mapQ.paired.B.SPMR_treat_pileup.bw
 echo $q
done

cat /usr/local/bin/igv
####increase memory for igv
vi "$HOME/.igv/java_arguments"

###temp contains a list of genes
cat temp | sort | uniq -d | while read g
do
grep -iw "$g" cyno.gene.2kbp.promoter.atac.peaksGe3samplesMerged.diff2-1.txt
echo "$g"
echo "-----------------------------------------"
done | cut -f 6 > temp-1

###head temp-1
NC_052255.1@@@70059047@@@70059587
BATF3
-----------------------------------------
NC_052269.1@@@106789169@@@106789431
CARD9
-----------------------------------------

###
linyongmao@Linyong-Mao-MBP16-2019 autism % cat temp-1 | grep -v '\------------' | while read g
do
grep -w "$g" L16.4samples.mapQ.paired.conserved.3samp.peaks.readcount.2 L16.4samples.conserved.3samp.peaks.readcount.2.cpm.txt
echo "$g"
echo ";;;"
done

male up-regulated promoter, "Microglia in Cerebellum", "MACROPHAGE" (Azimuth Cell Types), genes with non-small reads in all 4 samples
=========
CARD9
ITGB2
ITGB3
KCNK13
PIK3R5
RHBDF2
SLC22A18
SLC37A2
SNAI3

####overlapping with CSF1R human kinase ARCHS4 coexpression
linyongmao@Linyong-Mao-MBP16-2019 autism % cat temp-3 | sort | uniq -d
CARD9
ITGB2
KCNK13
PIK3R5
RHBDF2
SLC37A2

##############################
> d <- cpm(y)
t1 <- as.data.frame(log10(d + 1))
t2 <- cor(t1)
t3 <- as.data.frame(t2)
F.F.corr <- c(t3[1, 2], t3[1,3], t3[2,3] )
F.M.corr <- c(t3[4,1], t3[4,2], t3[4,3] )
t4 <- list(F.F.corr, F.M.corr)

boxplot(t4, ylab="log(cpm + 1) Pearson correlation between samples", ylim = c(0.2, 0.9))
abline(h = seq(-100,100,0.02), lty = 5, lwd = 0.5, col = "gray")
beeswarm(t4, add=T, cex=2, col=c("green", "red"))
mds <- plotMDS(y, top=98765)
x <- as.data.frame( cbind(  mds$x, mds$y))
plot(x$V1, x$V2, xlab = "PC1 (62%)", ylab= "PC2 (21%)", cex=0.05, xlim=c(-2,2))
x$sex <- c("F", "F", "F", "M")
points(x[ x$sex == "F",]$V1, x[ x$sex == "F",]$V2, cex=2, col="green")
points(x[ x$sex == "M",]$V1, x[ x$sex == "M",]$V2, cex=2, col="red")
text( x$V1, x$V2, colnames(y$counts), pos=4) # text at right
legend("topleft", inset = 0.05, c("XX", "XY"),  pch = c(1,1), col = c("green", "red" ))

#################################
dim(y)
# [1] 70644     4
y <- y[ !grepl("NC_052275.1", rownames(y)) ,]
dim(y)
# [1] 69418     4
1226/70644 chrX peaks
# [1] 0.01735462

#########human_data/SFARI , rna-seq, autism
linyong@fry /lab/page_human_data/linyong2$ ls /lab/page_human_data/SFARI/hg38/RNA/* | grep -i microglia | tail -n 18 | sed 's/\*$//'
# 18 postnatal samples
# 17 fetal samples
linyong@fry /lab/solexa_page/linyong/autism$ cat microglia-18-fq-files-read-len | awk 'NR % 3 == 1' | sort -g | uniq -c
     10 50bp read len
      1 54
      3 75
      4 76
cat /lab/page_human_data/linyong2/dir-gtex-500/slurm-gtexv8-pipeline-download-genecount > slurm-human-mg-rna-seq
linyong@fry /lab/solexa_page/linyong/autism$ sbatch slurm-human-mg-rna-seq
Submitted batch job 372687

#########human Microglia RNA-seq 18samples
cat /lab/solexa_page/linyong/script-genecount-merge-2 > temp-merge
vi temp-merge
bash temp-merge
linyong@fry /lab/solexa_page/linyong/autism$ cp temp-merge script-merge-june-25-2023
> setwd("~/Documents/autism/")
raw <- read.delim("human_Microglia_RNA-18samp.gene.count.txt")
raw.samp <- raw[, 3:20]
rownames(raw.samp) <- raw$geneID
dim(raw.samp)
# [1] 62703    18
summary( raw.samp[,1] - raw[, 3]  )
y <- DGEList(counts=raw.samp)
y <- calcNormFactors(y)
dim(y)
###########
> summary(y$samples$norm.factors)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.8655  0.9622  0.9917  1.0026  1.0548  1.1373 
d <- edgeR::cpm(y)
df <- as.data.frame(d)
df.2 <- df[, 4:18] ###rm A17 A27, A41 samples, whose ages >= 37
gene.name <- raw[, 1:2]
df.2$geneID <- rownames(df.2)
df.gene <- merge(df.2, gene.name, by.x="geneID", by.y="geneID")
g1 <- scan(what="", sep = "\n")

# "ACTB"    "ITGAM"   "P2RY12"  "TMEM119" "CX3CR1"  "CCR2"    "CD3D"    "MS4A1"  
df.gene.filt <-  df.gene[ df.gene$name %in% g1,]
rownames(df.gene.filt) <- df.gene.filt$name
t4 <- as.data.frame( t(df.gene.filt[, 2:16]))
t5 <- data.frame( t4$ACTB, t4$ITGAM, t4$P2RY12, t4$TMEM119, t4$CX3CR1, t4$CCR2, t4$CD3D, t4$MS4A1 )
colnames(t5) <- gsub("t4.", "", colnames(t5))
rownames(t5) <- rownames(t4)
boxplot(log2(t5+1), outcol = "white", ylab = "log2(cpm+1)")
beeswarm(log2(t5+1), add=T, cex = 0.6, col = "red" )
abline(h = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
###########
linyong@fry /lab/solexa_page/linyong/autism$ head human*.STAR.log | grep "==> " | sed 's/.*polyA_//' | sed 's/.STAR.log <==//' > temp1
head human*.STAR.log | grep "Number of input reads" | awk '{print $6}'  > temp2
head human*.STAR.log | grep "Uniquely mapped reads number" | awk '{print $6}' > temp3
paste temp1 temp2 temp3 > temp11



b=`ls human*counts_gene  | awk 'NR == 1' `
echo "$b" | sed 's/.*polyA_//' | sed 's/.counts_gene//' > s
tail -n 5 "$b" | awk '{print $1 "\t" $2}' | sed 's/__//' >> s
ls human*counts_gene  | awk 'NR > 1' | while read f
do
  echo "$f" | sed 's/.*polyA_//' | sed 's/.counts_gene//' > f2
  tail -n 5 "$f" | awk '{print  $2}' | sed 's/__//' >> f2       
  paste s f2 > m
  mv m s
done
ls -lh s

> t1 <- read.delim("temp11", header=F)
t2 <- as.data.frame( y$samples)
rownames(t2) <- gsub("human_Microglia_RNA_polyA_", "", rownames(t2))
t2$V1 <- rownames(t2)
t3 <- merge(t1, t2, by.x="V1", by.y="V1")
t3$uniq.map.ratio <- t3$V3 / t3$V2
t3$lib.size.ratio <- t3$lib.size / t3$V3
t4 <- read.delim("s")
t5 <- as.data.frame( t(t4))
t5$id <- rownames(t5)
map.res <- merge(t3, t5, by.x="V1", by.y="id")
summary(map.res)
# > write.table(map.res, "map.res.human.postnatal.18samp.txt", quote=F, sep="\t")
data.frame(map.res, map.res$no_feature / map.res$V2)
sort(map.res$ambiguous / map.res$lib.size)
sort(map.res$ambiguous / map.res$V2)

> summary((map.res$V3 + map.res$alignment_not_unique + map.res$not_aligned) / map.res$V2)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
      1       1       1       1       1       1

###########18 samples including 3 adults
> map <- read.delim("map.res.human.postnatal.18samp.txt")
summary(map)
par( mar=c(8,5,2,2))
plot(0,0, xlim=c(0,20), ylim=c(0, 7e7), col="white", xlab="", ylab="reads", xaxt = "n" )
points(1:dim(map)[1], map$V2, pch = 1, col = "black", cex = 1 )
lines(1:dim(map)[1], map$V2,  col = "black")
points(1:dim(map)[1], map$V3, pch = 1, col = "red", cex = 1 )
lines(1:dim(map)[1], map$V3,  col = "red")
points(1:dim(map)[1], map$lib.size, pch = 1, col = "blue", cex = 1 )
lines(1:dim(map)[1], map$lib.size,  col = "blue")
points(1:dim(map)[1], map$no_feature, pch = 1, col = "green", cex = 1 )
lines(1:dim(map)[1], map$no_feature,  col = "green")
abline(h = seq(0, 7e7,1e7), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
axis(1, at = seq(1, dim(map)[1], by=1), labels=map$V1, las = 2)
# legend(10, 7e7, legend=c("raw read", "uniq mapped read", "uniq read in non-overlap exon"), col = c("black", "red", "blue"), lty = 1, cex = 0.8 )
legend(10, 7e7, legend=c("raw read", "uniq mapped read", "uniq read in non-overlap exon", "no_feature"), col = c("black", "red", "blue", "green"), lty = 1, cex = 0.8 )

par( mar=c(8,5,2,2))
plot(0,0, xlim=c(0,20), ylim=c(0, 1), col="white", xlab="", ylab="% of uniq mapped read", xaxt = "n" )
points(1:dim(map)[1], map$lib.size / map$V3, pch = 1, col = "blue", cex = 1 )
lines(1:dim(map)[1], map$lib.size/map$V3,  col = "blue")
points(1:dim(map)[1], map$no_feature/map$V3, pch = 1, col = "green", cex = 1 )
lines(1:dim(map)[1], map$no_feature/map$V3,  col = "green")
abline(h = seq(0, 1, 0.1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
axis(1, at = seq(1, dim(map)[1], by=1), labels=map$V1, las = 2)
legend(10, 1, legend=c( "uniq read in non-overlap exon", "no_feature"), col = c( "blue", "green"), lty = 1, cex = 0.8 )

###########13 samples (using P8_Occipital)
raw <- read.delim("human_Microglia_RNA-18samp.gene.count.txt")
#remove 3 adult samples, and only keep P17_Temporal & P8_Occipital
raw.samp <- raw[, c(6:7,9:19)]
rownames(raw.samp) <- raw$geneID
dim(raw.samp)
# [1] 62703    13
summary( raw.samp[,1] - raw[, 6]  )
y <- DGEList(counts=raw.samp)
y <- calcNormFactors(y)
dim(y)
summary(y$samples$norm.factors)
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
#  0.8735  0.9490  1.0113  1.0025  1.0579  1.1458
d <- edgeR::cpm(y)
med <- data.frame(y$counts[,1])
med$logic <- TRUE
for(i in 1:dim(y)[1]) {
 med$logic[i] <- median(d[i,]) >= 1
}
####median >= 1 for pathway genes
y<-y[med$logic,]
dim(y)
# [1] 15223    13
d <- edgeR::cpm(y)
df <- as.data.frame(d)
df.2 <- df
gene.name <- raw[, 1:2]
df.2$geneID <- rownames(df.2)
df.gene <- merge(df.2, gene.name, by.x="geneID", by.y="geneID")

chr <- read.delim("gencode.v42.primary_assembly.noPar.gene-chr-type")
df.cpm.gene <- merge(df.gene, chr, by.x="geneID", by.y="geneID")
df.cpm.noX.Y <- df.cpm.gene[ df.cpm.gene$chr != "chrX" & df.cpm.gene$chr != "chrY",]
dim(df.cpm.noX.Y)
# [1] 14760    18   minus 463 chrX gene

y <- y[ rownames(y) %in% df.cpm.noX.Y$geneID, ]  
dim(y)
# [1] 14760    13
mds <- plotMDS(y, top=98765)
x <- data.frame( patient = colnames(y$counts), pc1 = mds$x, pc2 = mds$y )
info <- read.delim("human.postnatal.18samp.info")
x$patient <- gsub("human_Microglia_RNA_polyA_", "", x$patient)
pca.info <- merge(x, info, by.x="patient", by.y="Patient.ID")
plot(pca.info$pc1, pca.info$pc2, cex=0.05, xlab="PC1 (32%)", ylab = "PC2 (17%)")
pca.f <- pca.info[ pca.info$Sex == "F", ]
pca.m <- pca.info[ pca.info$Sex == "M", ]
points(pca.f$pc1, pca.f$pc2, col = "red", cex = 1.6)
points(pca.m$pc1, pca.m$pc2, col = "blue", cex = 1.6)
legend(-0.85, -0.45, legend=c("F", "M"), pch = c(1,1), col=c("red", "blue"), cex=1.2)

#########
t9 <- as.data.frame( df.cpm.noX.Y[, 2:14])
t10 <- log10(t9 + 1)
colnames(t10) <- gsub("human_Microglia_RNA_polyA_", "", colnames(t10))
t11 <- cor(t10)
t12 <- as.data.frame(t11)

####keep the order of patients in rows & columns of t12
info.2 <- info[1:13,]
for(i in 1:13) {
 info.2[i,] = info[ info$Patient.ID == colnames(t12)[i], ]
 }
dim(info.2)
identical(info.2$Patient.ID, colnames(t12))
col_fun = colorRamp2(c(0.8,0.9,1), c( "blue", "white",  "red"))
col.age <- colorRamp2(c(0,20), c("white", "black"))
brain <- c("yellow", "green", "pink")
names(brain) <- unique(info.2$Brain.Region)
brain
#   Temporal    Frontal Occipital
#   "yellow"    "green"     "pink"
ca <- HeatmapAnnotation( sex = info.2$Sex, age = info.2$Age, region = info.2$Brain.Region,  which="row", col=list(age = col.age, region = brain, sex = c("F" = "white", "M" = "black")))
Heatmap(t12, name = "correlation", column_split=info.2$Sex, row_split=info.2$Sex, col = col_fun, right_annotation=ca)

Heatmap(t12, name = "correlation",  col = col_fun, right_annotation=ca, row_dend_width=unit(15, "mm"))

###########13 samples (using P8_Parietal)
> raw.samp <- raw[, c(6:7,9:18, 20)]
[1] 14808 genes with >= 1cpm; no chrX genes; no chrY;    13 samples
> plot(pca.info$pc1, pca.info$pc2, cex=0.05, xlab="PC1 (26%)", ylab = "PC2 (18%)")
> legend(-0.6, -0.3, legend=c("F", "M"), pch = c(1,1), col=c("red", "blue"), cex=1.2)
##################
setwd("~/Documents/autism/")
raw <- read.delim("human_Microglia_RNA-18samp.gene.count.txt")
raw.samp <- raw[, c(6:7,9:18, 20)]
# P8_Parietal
rownames(raw.samp) <- raw$geneID
dim(raw.samp)
# [1] 62703    13
summary( raw.samp[,1] - raw[, 6]  )
y <- DGEList(counts=raw.samp)
y <- calcNormFactors(y)
dim(y)
summary(y$samples$norm.factors)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.8766  0.9510  1.0106  1.0024  1.0569  1.1434 
#5 male samples
keep <-rowSums(edgeR::cpm(y)>=1) >= 4
y<-y[keep,]
dim(y)
# [1] 16790    13
info <- read.delim("human.postnatal.18samp.info")
info.2 <- info[1:13,]
cna <- gsub("human_Microglia_RNA_polyA_", "", colnames(y))
for(i in 1:13) {
 info.2[i,] = info[ info$Patient.ID == cna[i], ]
 }
identical(info.2$Patient.ID, cna)
design <- model.matrix(~info.2$Sex + info.2$Age)
y <- estimateDisp(y,design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, coef=2)
top2v1 <- topTags(qlf, n = 91234)
write.table(top2v1, "diff2-1.txt", sep="\t", quote = F)
diff <- as.data.frame(top2v1)
diff$geneID <- rownames(diff)
gene.name <- raw[, 1:2]
df.gene <- merge(diff, gene.name, by.x="geneID", by.y="geneID")
chr <- read.delim("gencode.v42.primary_assembly.noPar.gene-chr-type")
df.cpm.gene <- merge(df.gene, chr, by.x="geneID", by.y="geneID")
df.cpm.noX.Y <- df.cpm.gene[ df.cpm.gene$chr != "chrX" & df.cpm.gene$chr != "chrY",]
dim(df.cpm.noX.Y)
# [1] 16259    10
# > write.table(df.cpm.gene, "human_Microglia_rna-postnatal-MvF-diff2-1.name-type-chr.txt", sep="\t", quote=F)
# > write.table(df.cpm.noX.Y, "human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.name-type-chr.txt", sep="\t", quote=F)
linyongmao@Linyong-Mao-MBP16-2019 autism % vi human_Microglia_rna-postnatal-MvF-diff2-1.name-type-chr.txt   
linyongmao@Linyong-Mao-MBP16-2019 autism % vi human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.name-type-chr.txt
cat  human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.name-type-chr.txt | awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} 
{for(i = 1; i <= 7; i++) 
   print $i "\t";

 print $7 "\n"; 
}' > temp
../microglia/make-rnk-genesymble  temp  human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.rnk

bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx   /Users/linyongmao/Documents/h.all.v7.4.symbols.gmt    -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk  human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.rnk -rpt_label   "human_Microglia_rna-postnatal-MvF.prerank.v7.4"  -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

##################
> filt <- df.cpm.noX.Y[ df.cpm.noX.Y$PValue < 1.513847e-02, ]
dim(filt)
# [1] 200  10
d = edgeR::cpm(y)
a <- d
b = log10(a+1)
for(i in 1:dim(b)[1])
{
 a[i, ] <- (b[i, ] - mean(as.numeric(b[i,]))) / var(as.numeric(b[i,]))^(1/2)
}
a.df <- as.data.frame(a)
a.df$id <- row.names(a.df)
a.df.g.filt <- a.df[ a.df$id %in% filt$geneID,]
t1 <- a.df.g.filt[, 1:13]
mat <- t(as.matrix(t1))
dim(mat)
# [1]  13 200
mat.df <- as.data.frame(mat)
mat.df$sample <- gsub("human_Microglia_RNA_polyA_", "", rownames(mat.df))
info <- read.delim("human.postnatal.18samp.info")
mat.df.info <- merge(mat.df, info, by.x="sample", by.y="Patient.ID")
dim(mat.df.info)
# [1]  13 204
mat <- as.matrix(mat.df.info[, c(2:201)])
rownames(mat) <- mat.df.info$sample
dim(mat)
# [1]  13 200
# each of 200 genes is z-scored (log10(d+1)) over 13 samples
col.age <- colorRamp2(c(0,10,20), c("blue","white", "red"))
brain <- c("yellow", "green", "pink", "black")
names(brain) <-  unique(mat.df.info$Brain.Region)
brain
#   Temporal    Frontal Occipital   Parietal
#   "yellow"    "green"     "pink"    "black" 
ca <- HeatmapAnnotation( sex = mat.df.info$Sex, age = mat.df.info$Age, region = mat.df.info$Brain.Region,  which="row", col=list(age = col.age, region = brain, sex = c("F" = "white", "M" = "black")))

# Heatmap(matrix = mat, show_column_names=F, name="z-socre",  right_annotation=ca, row_dend_width=unit(15, "mm"), )
Heatmap(matrix = mat, show_column_names=F, name="z-socre",  right_annotation=ca, row_dend_width=unit(15, "mm"), clustering_distance_rows="pearson", clustering_distance_columns ="pearson")

##########################HALLMARK_INTERFERON_GAMMA_RESPONSE DEGs heatmap
linyongmao@Linyong-Mao-MBP16-2019 human_Microglia_rna-postnatal-MvF.prerank.v7.4.GseaPreranked.1688667308546 % cat "$f".tsv | awk 'NR > 1' | awk 'BEGIN {FS = "\t"; OFS = "\t"}  $6 == "Yes" ' | awk '$4 < -1.30103' | wc -l
      39 genes with p < 0.05 HALLMARK_INTERFERON_GAMMA_RESPONSE
> a.df.name <- merge( a.df, gene.name, by.x="id", by.y="geneID")
 g <- read.delim("temp-IFR.genes", header=F)
 a.df.g <- a.df.name[ a.df.name$name %in% g$V1,]
 dim(a.df.g)
# [1] 39 15
 t1 <- a.df.g[ , c(2:14)]
 rownames(t1) <- a.df.g$name
 mat <- as.matrix(t(t1))
 dim(mat)
# [1] 13 39
mat.df <- as.data.frame(mat)
mat.df$sample <- gsub("human_Microglia_RNA_polyA_", "", rownames(mat.df))
info <- read.delim("human.postnatal.18samp.info")
mat.df.info <- merge(mat.df, info, by.x="sample", by.y="Patient.ID")
dim(mat.df.info)
 mat <- as.matrix(mat.df.info[, c(2:40)])
rownames(mat) <- mat.df.info$sample
dim(mat)
# each of 39 genes is z-scored (log10(d+1)) over 13 samples, no sex chr genes
col.age <- colorRamp2(c(0,10,20), c("blue","white", "red"))
brain <- c("yellow", "green", "pink", "black")
names(brain) <-  unique(mat.df.info$Brain.Region)
brain
#   Temporal    Frontal Occipital   Parietal
#   "yellow"    "green"     "pink"    "black"
ca <- HeatmapAnnotation( sex = mat.df.info$Sex, age = mat.df.info$Age, region = mat.df.info$Brain.Region,  which="row", col=list(age = col.age, region = brain, sex = c("F" = "white", "M" = "black")))
 Heatmap(matrix = mat, show_column_names=T, name="z-socre",  right_annotation=ca, row_dend_width=unit(15, "mm"),  clustering_distance_columns ="pearson", column_names_gp = gpar(fontsize = 7), column_names_side = c("top"))

##################heatmap using DEGs' log10(cpm+1)
> a <- d
a.df <- as.data.frame(log10(a+1))
......
Heatmap(matrix = mat, show_column_names=F, name="log10(cpm+1)",  right_annotation=ca, row_dend_width=unit(15, "mm"), clustering_distance_rows="pearson", clustering_distance_columns ="pearson")

########################heatmap of INTERFERON_GAMMA_RESPONSE DEGs (p < 0.05, model includes interaction term, genes in rows, sample in col)
> keep <-rowSums(edgeR::cpm(y)>=1) >= 4
> y<-y[keep,]
> dim(y)
[1] 16790    13
d = edgeR::cpm(y)
a <- d
b = log10(a+1)
for(i in 1:dim(b)[1])
{
 a[i, ] <- (b[i, ] - mean(as.numeric(b[i,]))) / var(as.numeric(b[i,]))^(1/2)
}
a.df <- as.data.frame(a)
a.df$id <- row.names(a.df)
 gene.name <- raw[, 1:2]
a.df.name <- merge( a.df, gene.name, by.x="id", by.y="geneID")
 dim(a.df.name)
# [1] 16790    15
linyongmao@Linyong-Mao-MBP16-2019 autism % f="/Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF.withInteraction.prerank.v7.4.GseaPreranked.1691634088087/HALLMARK_INTERFERON_GAMMA_RESPONSE.tsv"
linyongmao@Linyong-Mao-MBP16-2019 autism % cat "$f" | awk 'NR > 1' | awk 'BEGIN {FS = "\t"; OFS = "\t"}  $6 == "Yes" ' | awk '$4 < -1.30103' | cut -f 2 > "temp-IFR.genes"
105 genes temp-IFR.genes

 g <- read.delim("temp-IFR.genes", header=F)
 a.df.g <- a.df.name[ a.df.name$name %in% g$V1,]
 dim(a.df.g)
 t1 <- a.df.g[ , c(2:14)]
 rownames(t1) <- a.df.g$name
 mat <- as.matrix(t(t1))
 dim(mat)
# [1]  13 105
 mat.df <- as.data.frame(mat)
 mat.df$sample <- gsub("human_Microglia_RNA_polyA_", "", rownames(mat.df))
 info <- read.delim("human.postnatal.18samp.info")
 mat.df.info <- merge(mat.df, info, by.x="sample", by.y="Patient.ID")
 dim(mat.df.info)
# [1]  13 109
  mat <- as.matrix(mat.df.info[, c(2:106)])
 rownames(mat) <- mat.df.info$sample
 dim(mat)
# [1]  13 105
# each of 105 genes is z-scored (log10(d+1)) over 13 samples, no sex chr genes
##row genes, column samples
 mat2 <- t(mat)
col.age <- colorRamp2(c(0,10,20), c("blue","white", "red"))
brain <- c("yellow", "green", "pink", "black")
names(brain) <-  unique(mat.df.info$Brain.Region)
brain
 ca <- HeatmapAnnotation( sex = mat.df.info$Sex, age = mat.df.info$Age, region = mat.df.info$Brain.Region,  which="column", col=list(age = col.age, region = brain, sex = c("F" = "white", "M" = "black")))
> Heatmap(matrix = mat2, show_column_names=T, name="z-socre",  top_annotation=ca, row_dend_width=unit(15, "mm"),  row_names_gp = gpar(fontsize = 3.6), column_names_side = c("top"), clustering_distance_rows="pearson",  column_order = order(mat.df.info$Age),column_split=mat.df.info$Sex )
##check
 sum(mat2[11,])
 sd(mat2[11,])
 identical(colnames(mat2),  mat.df.info$sample)

###########################genes annotated with safari genes
> saf1 <- read.delim("/Users/linyongmao/Documents/autism/safari.genes.syndrome")
 saf2 <- read.delim("/Users/linyongmao/Documents/autism/safari.genes.cater1")
 saf <- data.frame(gene = rownames(mat2), safari = "N")
 saf[ saf$gene %in% c(saf1$gene.symbol, saf2$gene.symbol), ]$safari = "Y"
 ca.r <- HeatmapAnnotation(safari = saf$safari, which="row", col=list(safari = c("N" = "white", "Y" = "green")) )
 ca <- HeatmapAnnotation( sex = mat.df.info$Sex, age = mat.df.info$Age, region = mat.df.info$Brain.Region,  which="column", col=list(age = col.age, region = brain, sex = c("F" = "white", "M" = "black")))
 Heatmap(matrix = mat2, show_column_names=T, name="z-socre",  top_annotation=ca, right_annotation=ca.r, row_dend_width=unit(15, "mm"),  row_names_gp = gpar(fontsize = 3.6), column_names_side = c("top"), clustering_distance_rows="pearson",  column_order = order(mat.df.info$Age),column_split=mat.df.info$Sex )

##########################pathway z-score, including sex chr genes if pathway contains sex chr genes
> keep <-rowSums(edgeR::cpm(y)>=1) >= 4
> y<-y[keep,]
> dim(y)
[1] 16790    13
d = cpm(y)
a <- d
b = log10(a+1)
for(i in 1:dim(b)[1])
{
 a[i, ] <- (b[i, ] - mean(as.numeric(b[i,]))) / var(as.numeric(b[i,]))^(1/2)
}
###a is z-score of log10(cpm+1)
info <- read.delim("human.postnatal.18samp.info")
gene.name <- raw[, 1:2]
a.df <- as.data.frame(a)
a.df$id <- row.names(a.df)
a.df.g <- merge(a.df, gene.name, by.x="id", by.y="geneID")
dim(a.df.g)
# [1] 16790    15
file <- "../microglia/HALLMARK_INTERFERON_GAMMA_RESPONSE.genes"
p <- read.delim(file, header=F)
p.exp <- a.df.g[ a.df.g$name %in% p$V1, ]
length(p.exp$name)
# [1] 200 pathway genes ->  179 with cpm >= 1 in >= 4 samples
mat <- as.matrix(p.exp[, 2:14])
res <- data.frame(id = colnames(mat), mean = colMeans(mat))
res$id <- gsub("human_Microglia_RNA_polyA_", "", res$id)
res.info <- merge(res, info, by.x="id", by.y="Patient.ID")
boxplot(res.info$mean ~ res.info$Sex,   ylab = "z-score avg of all pathway genes", outcol = "white")
beeswarm(res.info$mean ~ res.info$Sex, pch = c(16,16), col = c("red", "blue" ), cex = 1.5, add = T)
abline(h = seq(-100,100,0.1), lty = 5, lwd = 0.5, col = "gray")
title(main = gsub(".*microglia/", "", file))
r.m <- res.info[ res.info$Sex == "M",]
r.f <- res.info[ res.info$Sex == "F",]

>  g <- read.delim("temp-IFR.genes", header=F)
>  dim(g)
[1] 39  1
> p.exp <- a.df.g[ a.df.g$name %in% g$V1, ]

##########################sex:age interaction term, collinear
>  length(p.exp$name)
[1] 179 INTERFERON_GAMMA_RESPONSE genes with expression in some samples
 res.info$a <- res.info$Age - mean(res.info$Age)
 design <- model.matrix(~res.info$Sex + res.info$a + res.info$Sex : res.info$a)
 lm.res <- lm(res.info$mean ~ res.info$Sex + res.info$Age + res.info$Sex : res.info$Age)
 lm.sum <- summary(lm.res)
 temp <- as.data.frame(model.matrix(lm.res))[,2:4]
 cor(temp)
 cor.test(temp[,3], temp[,1])
# t = 2.9109, df = 11, p-value = 0.01417
#       cor
# 0.6596387

> library(car)
> vif(lm.res)
             res.info$Sex              res.info$Age res.info$Sex:res.info$Age
                 2.479788                  1.806497                  3.192558

lm.res.0 <- lm(res.info$mean ~ res.info$Sex + res.info$Age)
anova(lm.res.0, lm.res)
# Analysis of Variance Table
# Model 1: res.info$mean ~ res.info$Sex + res.info$Age
# Model 2: res.info$mean ~ res.info$Sex + res.info$Age + res.info$Sex:res.info$Age
#   Res.Df    RSS Df Sum of Sq      F  Pr(>F)
# 1     10 2.6623
# 2      9 1.4919  1    1.1704 7.0604 0.02617 *

vif(lm.res.0)
# res.info$Sex res.info$Age
#     1.001716     1.001716

##########HALLMARK_MTORC1_SIGNALING
> file <- "../microglia/HALLMARK_MTORC1_SIGNALING.genes"
187 expressed genes in the pathway
Analysis of Variance Table

Model 1: res.info$mean ~ res.info$Sex + res.info$Age
Model 2: res.info$mean ~ res.info$Sex + res.info$Age + res.info$Sex:res.info$Age
  Res.Df     RSS Df Sum of Sq      F  Pr(>F)
1     10 2.05981
2      9 0.92042  1    1.1394 11.141 0.00869 **

########################sex:age interaction DEGs
design <- model.matrix(~info.2$Sex + info.2$Age + info.2$Sex : info.2$Age)
......
> write.table(df.cpm.gene, "human_Microglia_rna-postnatal-MvF-diff2-1.withInteraction.name-type-chr.txt", sep="\t", quote=F)
> write.table(df.cpm.noX.Y, "human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.withInteraction.name-type-chr.txt", sep="\t", quote=F)
#first output coef=2 (Sex)  DEGs,
> qlf <- glmQLFTest(fit, coef=4)
>  top2v1 <- topTags(qlf, n = 91234)
>  write.table(top2v1, "diff2-1.txt", sep="\t", quote = F)
>  head(top2v1)
Coefficient:  info.2$SexM:info.2$Age
                        logFC   logCPM        F       PValue        FDR
ENSG00000105697.9   0.5093262 5.305854 42.20916 1.273518e-05 0.08475107
ENSG00000184588.18  0.2629259 6.222199 40.43680 1.606822e-05 0.08475107
ENSG00000059804.16  0.3937261 7.208920 38.54832 2.076388e-05 0.08475107
ENSG00000145147.20 -0.2303984 4.430572 37.29202 2.475525e-05 0.08475107
ENSG00000171051.10  0.2498092 8.846108 37.15575 2.523856e-05 0.08475107
ENSG00000137193.14  0.3768706 6.660542 35.64695 3.137641e-05 0.08780165





cat  human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.withInteraction.name-type-chr.txt | awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""}
{for(i = 1; i <= 7; i++)
   print $i "\t";

 print $7 "\n";
}' > temp
../microglia/make-rnk-genesymble  temp  human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.withInteraction.rnk
bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx   /Users/linyongmao/Documents/h.all.v7.4.symbols.gmt    -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk  human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.withInteraction.rnk -rpt_label   "human_Microglia_rna-postnatal-MvF.withInteraction.prerank.v7.4"  -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

head -1 human_Microglia_rna-postnatal-MvF-diff2-1.name-type-chr.txt human_Microglia_rna-postnatal-MvF-diff2-1.withInteraction.name-type-chr.txt
for g in `echo KDM6A    KDM5C   SMC1A   ZFX     RBBP7   DDX3X   CDK16   DLG3    USP9X   BCOR    UTY     ZFY     XIST    GLA     TIMP1   SAT1    MPP1`
do
 grep -iw $g human_Microglia_rna-postnatal-MvF-diff2-1.name-type-chr.txt
 grep -iw $g human_Microglia_rna-postnatal-MvF-diff2-1.withInteraction.name-type-chr.txt | cut -f 2-20
 grep -iw $g human_Microglia_rna-postnatal-interaction-M-Age-diff2-1.name-type-chr.txt | cut -f 2-20
 echo
done

##################age test between F & M
info <- read.delim("human.postnatal.18samp.info")
info.2 <- info[1:13,]
cna <- gsub("human_Microglia_RNA_polyA_", "", colnames(y))
for(i in 1:13) {
 info.2[i,] = info[ info$Patient.ID == cna[i], ]
 }
identical(info.2$Patient.ID, cna)
boxplot(info.2$Age ~ info.2$Sex, outcol = "white")
beeswarm(info.2$Age ~ info.2$Sex, add=T)
abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
 f <- info.2[info.2$Sex =="F",]$Age
 m <- info.2[info.2$Sex =="M",]$Age
 wilcox.test(f,m, paired=F, exact=F, conf.int = T)
 t.test(f,m)
 t.test(log2(f),log2(m))
##################
> info.2$col <- "red"
> info.2[ info.2$Sex == "M",]$col = "blue"
boxplot(info.2$Age, ylab="Age", xlab = "postnatal donor")
beeswarm(info.2$Age, add=T, pwcol=info.2$col, cex = 2)
 legend("topleft", inset = 0.05, legend=c("F", "M"), pch = c(1,1), col=c("red", "blue"), cex=2)
 abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")

####################
install.packages("vioplot")
library(vioplot)
> df.cpm.gene$sign.log10.p <- log10(df.cpm.gene$PValue)
for( i in 1:dim(df.cpm.gene)[1]) {
 if(df.cpm.gene$logFC[i] < 0)
   df.cpm.gene$sign.log10.p[i] = -df.cpm.gene$sign.log10.p[i]
 }
 df.x <- df.cpm.gene[ df.cpm.gene$chr == "chrX",]
 dim(df.x)
# [1] 514  11
 df.x <- df.cpm.gene[ df.cpm.gene$chr == "chrX" & df.cpm.gene$name != "XIST",]
# g1 <- scan(what="", sep = "\n")
 length(g1)
# [1] 10
 df.x.2 <- df.x[ df.x$name %in% g1,]$sign.log10.p
 df.x.1 <- df.x[ !(df.x$name %in% g1),]$sign.log10.p
 df.x.3 <- df.x[ df.x$name %in% g1,]
 df.x.4 <- df.x.3[ df.x.3$PValue < 0.05,]

 vioplot(df.x.1, df.x.2, names=c("X chr genes excluding XIST & 10 genes", "10 X chr genes likely driving sex difference"))
 title("", ylab="signed log10 PValue (F vs. M)")
 text(c(2.1,  2.1, 2.1, 1.9), df.x.4$sign.log10.p, df.x.4$name, col="blue")
 abline(h = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")

######################hallmark pathway LEGs overlap hypergeom testing, model included interaction term
linyongmao@Linyong-Mao-MBP16-2019 autism % bash script-geneset-overlap-p-value-2 > temp.net
cp temp.net out
cat out | awk 'BEGIN {FS = "\t"; OFS = "\t"} ($1 > $2 && $8 <= 1e-10) || NR == 1'   | sed 's/HALLMARK_//g' | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $0, -log($8)/log(10)}' > temp2.txt

##########################
linyongmao@Linyong-Mao-MBP16-2019 autism % bash         script-geneset-overlap-p-value > out
cat out | awk 'BEGIN {FS = "\t"; OFS = "\t"} $1 > $2 || NR == 1' > temp.txt
> dat <- read.delim("temp.txt")
 plot(dat$overlap2minRatio, -log10(dat$p.value), xlim=c(0, 0.6), ylim=c(0, 60))
 abline(h = seq(-100, 100, 5), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100, 100, 0.05), lty = 5, lwd = 0.5, col = "gray")
linyongmao@Linyong-Mao-MBP16-2019 autism %  cat out | awk 'BEGIN {FS = "\t"; OFS = "\t"} ($1 > $2 && $8 <= 1e-10) || NR == 1'   | sed 's/HALLMARK_//g' | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $0, -log($8)/log(10)}' > temp2.txt
ls -lh out temp.txt
##########################Microbiome Influences Prenatal and Adult Microglia in a Sex-Specific Manner. 
###DEGs (logFC, FDR) downloaded from the above paper
linyongmao@Linyong-Mao-MBP16-2019 autism % cat mouse-A2M-SPF-FvsM.diff2-1.txt  | awk 'BEGIN {FS = "\t"; OFS = "\t"} 2^($2) > 1.5 && $3 < 0.05 ' | sort -t '     ' +2 -3g | head -400  | cut -f 4
linyongmao@Linyong-Mao-MBP16-2019 autism % cat mouse-A2M-SPF-FvsM.diff2-1.txt  | awk 'BEGIN {FS = "\t"; OFS = "\t"} 2^($2) > 1.5 && $3 < 0.05 ' |cut -f 4 > temp
cat mouse-A2M-SPF-FvsM.diff2-1.txt  | awk 'BEGIN {FS = "\t"; OFS = "\t"} 2^(-$2) > 1.5 && $3 < 0.05 ' | cut -f 4 > temp-2
##mouse fdr < 0.05, FC > 1.5
##human raw p-value < 0.05
cat human_Microglia_rna-postnatal-MvF-diff2-1.name-type-chr.txt |  awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 < 0 && $5 < 0.05 ' |cut -f 7 > temp-3

########################NESs MvF and sex:age interaction
> t1 <- read.delim("temp-1")
 t2 <- t1[ t1$contrast == "MvFwithInterac", ]
 t3 <- t1[ t1$contrast == "sex.age.interact", ]
 dim(t2)
# [1] 49  9
 dim(t3)
# [1] 49  9
 t4 <- merge(t2, t3, by.x="NAME", by.y="NAME")
 t5 <- t4[ t4$NES.x < -1.8 & t4$FDR.q.val.x < 0.05,]
 dim(t5)
# [1] 32 17
 t6 <- data.frame( MvF=t5$NES.x, interac = t5$NES.y )
 rownames(t6) <- t5$NAME
 summary(t6$MvF - t5$NES.x)
> Heatmap(as.matrix(t6), name = "NES", cluster_rows=F, cluster_columns=F, column_labels=c("M vs. F", "sex:age \n interaction"), row_order= order(t6$MvF), row_names_gp = gpar(fontsize = 6), width=unit(30, "mm") )

############
linyongmao@Linyong-Mao-MBP16-2019 autism % cat human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.name-type-chr.txt| awk 'BEGIN {FS = "\t"} NR > 1 && $5 < 0.05' | wc -l
     804
linyongmao@Linyong-Mao-MBP16-2019 autism % cat human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.withInteraction.name-type-chr.txt | awk 'BEGIN {FS = "\t"} NR > 1 && $5 < 0.05' | wc -l
    3231 includes  513/804 genes from DEGs without interaction term
linyongmao@Linyong-Mao-MBP16-2019 autism %  cat human_Microglia_rna-postnatal-MvF-diff2-1.name-type-chr.txt|  awk 'BEGIN {FS = "\t"}  $8 == "chrX" || $8 == "chrY" ' | awk 'BEGIN {FS = "\t"}  $5 < 0.05' | wc -l
      52
linyongmao@Linyong-Mao-MBP16-2019 autism %  cat  human_Microglia_rna-postnatal-MvF-diff2-1.withInteraction.name-type-chr.txt |  awk 'BEGIN {FS = "\t"}  $8 == "chrX" || $8 == "chrY" '  | awk 'BEGIN {FS = "\t"}  $5 < 0.05' | wc -l
     119
cat human_Microglia_rna-postnatal-MvF-diff2-1.name-type-chr.txt|  awk 'BEGIN {FS = "\t"}  $8 == "chrX" || $8 == "chrY" ' | awk 'BEGIN {FS = "\t"}  $5 < 0.05' | grep -w chrY | wc -l
      17
cat  human_Microglia_rna-postnatal-MvF-diff2-1.withInteraction.name-type-chr.txt |  awk 'BEGIN {FS = "\t"}  $8 == "chrX" || $8 == "chrY" '  | awk 'BEGIN {FS = "\t"}  $5 < 0.05' |  grep -w chrY | wc -l
      12 genes contained in 17 genes (without interaction term)

#################
> setwd("~/Documents/autism/")
 raw <- read.delim("human_Microglia_RNA-18samp.gene.count.txt")
 gene.name <- raw[, 1:2]
 chr <- read.delim("gencode.v42.primary_assembly.noPar.gene-chr-type")
 g.chr <- merge(gene.name, chr, by.x="geneID", by.y="geneID")
 dim(g.chr)
# [1] 62703     5
> write.table(g.chr, "gencode.v42.primary_assembly.noPar.gene-chr-type-name", quote=F, sep="\t")

linyongmao@Linyong-Mao-MBP16-2019 autism % cat gencode.v42.primary_assembly.noPar.gene-chr-type-name | grep -iw protein_coding | cut -f 2 | sort | uniq > gencode.v42.primary_assembly.noPar.protein_coding.names
   20025 gencode.v42.primary_assembly.noPar.protein_coding.names
linyongmao@Linyong-Mao-MBP16-2019 autism % bash script-safari-geneset-overlap-2 > temp
###safari geneset overlap with hallmark pathway genes (in 20025 protein coding bg)

###########ggplot2
> ggplot(res.info, aes(x=Age, y=mean, color = Sex)) + geom_point(size=3) + geom_smooth(se=T, method="lm") + labs(title=gsub(".*microglia/", "", file), y="z-score avg of all pathway genes")
>  ggplot(res.info, aes(x=Age, y=mean, color = Sex)) + geom_point(size=3) + geom_smooth(se=F) + labs(title=gsub(".*microglia/", "", file), y="z-score avg of all pathway genes")

###############################stranded gene level counting vs un-stranded
> t1 <- read.delim("p8-pari-stranded-nostrand.counts", header=F)
 raw <- t1[, c(3,6)]
 rownames(raw) <- t1[, 1]
y <- DGEList(counts=raw)
y <- calcNormFactors(y)
dim(y)
###V3 stranded, V6 treat as un-stranded
# $samples
#    group lib.size norm.factors
# V3     1 18760700    0.9839285
# V6     1 18162519    1.0163341

 t2 <- t1[ t1$V3 + t1$V6 > 15,]
 dim(t2)
# [1] 17818     6
 plot(log10(t2$V3+1) , log10(t2$V6+1), xlab="log10(count+1), stranded", ylab = "log10(count+1)")
y = 1:5
x = y
abline(lm(y~x), lwd = 1, col="blue") 
 abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
 hm.g <- read.delim("../microglia/temp-uniq", header=F)
 t2.hm <- t2[ t2$V2 %in% hm.g$V1,]
 dim(t2.hm)
# [1] 3386 expr hallmark genes out of 4383 hm genes;     6
 plot(log10(t2.hm$V3+1) , log10(t2.hm$V6+1), xlab="log10(count+1), stranded", ylab = "log10(count+1)")
 dim( t2.hm[ t2.hm$V3 < 10 & t2.hm$V6 > 20,])
# [1] 38  6
 dim( t2.hm[ t2.hm$V6 < 10 & t2.hm$V3 > 20,])
# [1] 4 6

  dim( t2[ t2$V3 < 10 & t2$V6 > 20,])
# [1] 680   6
  dim( t2[ t2$V6 < 10 & t2$V3 > 20,])
# [1] 90  6
  dim( t2[ t2$V3 < 20 & t2$V6 > 20,])
# [1] 867   6
  dim( t2[ t2$V6 < 20 & t2$V3 > 20,])
# [1] 196   6

#  write.table( t2.hm[ t2.hm$V3 < 10 & t2.hm$V6 > 20, 2], "temp-nostrand", sep="\t", quote=F)
#  write.table( t2.hm[ t2.hm$V6 < 10 & t2.hm$V3 > 20, 2], "temp-strand", sep="\t", quote=F)
lm(log10(t2.hm$V6+1) ~ log10(t2.hm$V3+1) )
linyongmao@Linyong-Mao-MBP16-2019 autism % vi temp-nostrand 
cat temp-nostrand | while read g
do
 echo "$g"
 grep -iw "$g" ../microglia/HALLMARK*.genes | grep -v temp.gene
done

cat temp-nostrand | while read g
do
 echo "$g"
 grep -iw "$g" human_Microglia_RNA-18samp.gene.count.txt
 echo
done

####################strand specific mapping
linyong@fry /lab/solexa_page/linyong/autism$ sbatch slurm-human-mg-rna-seq-2
linyong@fry /lab/solexa_page/linyong/autism$ bash temp-merge
linyong@fry /lab/solexa_page/linyong$ cp -i script-paste-files temp-script-paste-files
bash temp-script-paste-files
linyong@fry /lab/solexa_page/linyong$ cat temp-script-paste-files
#

b=`ls temp-gtexv8-* | awk 'NR == 1' `
cp "$b" s
ls temp-gtexv8-* | awk 'NR > 1' | while read f
do
 cut -f 3 "$f" > f2
 paste s f2 > m
 mv m s
done
linyong@fry /lab/solexa_page/linyong/autism$ ls -lh human_Microglia_RNA-18samp.gene.count.stranded.txt
-rw-r--r-- 1 linyong systemd-timesync 4.4M Aug 17 10:38 human_Microglia_RNA-18samp.gene.count.stranded.txt
linyong@fry /lab/solexa_page/linyong/autism$ cp -i ../script-get-feature-count-02 script-get-feature-count-02-map-stat
linyong@fry /lab/solexa_page/linyong/autism$ bash script-get-feature-count-02-map-stat
mv -i s-tr human_Microglia_RNA-18samp.stranded.map-stat
-rw-r--r-- 1 linyong systemd-timesync 1.8K Aug 17 11:50 /lab/solexa_page/linyong/autism/human_Microglia_RNA-18samp.stranded.map-stat
> map <- read.delim("human_Microglia_RNA-18samp.stranded.map-stat")
 dim(map)
# [1] 18  9
par( mar=c(8,5,2,2))
plot(0,0, xlim=c(0,20), ylim=c(0, 7e7), col="white", xlab="", ylab="reads", xaxt = "n" )
points(1:dim(map)[1], map$inputreads, pch = 1, col = "black", cex = 1 )
lines(1:dim(map)[1], map$inputreads,  col = "black")
points(1:dim(map)[1], map$Uniqreads, pch = 1, col = "red", cex = 1 )
lines(1:dim(map)[1], map$Uniqreads,  col = "red")
points(1:dim(map)[1], map$lib.size, pch = 1, col = "blue", cex = 1 )
lines(1:dim(map)[1], map$lib.size,  col = "blue")
points(1:dim(map)[1], map$no_feature, pch = 1, col = "green", cex = 1 )
lines(1:dim(map)[1], map$no_feature,  col = "green")
abline(h = seq(0, 7e7,1e7), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
axis(1, at = seq(1, dim(map)[1], by=1), labels=gsub(".*polyA_", "", map$feature), las = 2)
legend(10, 7e7, legend=c("raw read", "uniq mapped read", "uniq read in non-overlap exon", "no_feature"), col = c("black", "red", "blue", "green"), lty = 1, cex = 0.8 )


par( mar=c(8,5,2,2))
plot(0,0, xlim=c(0,20), ylim=c(0, 1), col="white", xlab="", ylab="% of uniq mapped read", xaxt = "n" )
points(1:dim(map)[1], map$lib.size / map$Uniqreads, pch = 1, col = "blue", cex = 1 )
lines(1:dim(map)[1], map$lib.size/map$Uniqreads,  col = "blue")
points(1:dim(map)[1], map$no_feature/map$Uniqreads, pch = 1, col = "green", cex = 1 )
lines(1:dim(map)[1], map$no_feature/map$Uniqreads,  col = "green")
abline(h = seq(0, 1, 0.1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
axis(1, at = seq(1, dim(map)[1], by=1), labels=gsub(".*polyA_", "", map$feature), las = 2)
legend(10, 1, legend=c( "uniq read in non-overlap exon", "no_feature"), col = c( "blue", "green"), lty = 1, cex = 0.8 )

################################
> raw <- read.delim("human_Microglia_RNA-18samp.gene.count.stranded.txt")
##################normalized with 18 samples
> df2 <- df.gene[ df.gene$name %in% c("XIST", "DDX3Y"),]
 df3 <- df2[, c(2:16)]
 rownames(df3) <- df2[, 17]
 df4 <- as.data.frame( t(df3))
 df4$id <- gsub(".*polyA_", "", rownames(df4))
 info <- read.delim("human.postnatal.18samp.info")
 df5 <- merge(df4, info, by.x="id", by.y="Patient.ID")
 ggplot(df5, aes(x=log2(DDX3Y+1), y=log2(XIST+1), color=Sex)) + geom_point(size=2)
 dim(df5)
# [1] 15  6
 dim(y)
# [1] 62703    18
###########################13 samples
linyongmao@Linyong-Mao-MBP16-2019 autism % mv -i human_Microglia_RNA-18samp.gene.count.txt Microglia_RNA-18samp.gene.count.txt
> raw <- read.delim("human_Microglia_RNA-18samp.gene.count.stranded.txt")
#remove 3 adult samples, and only keep P17_Temporal & P8_Parietal
#search raw.samp
 raw.samp <- raw[, c(6:7,9:18, 20)]
 dim(raw.samp)
# [1] 62703    13

> ggplot(pca.info, aes(x=pc1, y = pc2, color = Sex, label=patient)) + geom_point(size=2) + labs(y="PC2 (18%)", x="PC1 (23%)") + geom_text( hjust = -0.3, size=2.5)
> Heatmap(t12, name = "correlation",  col = col_fun, right_annotation=ca, row_dend_width=unit(15, "mm"))

########################13 samples, 5 Males, DEGs, stranded mapping
> keep <-rowSums(edgeR::cpm(y)>=1) >= 4
> y<-y[keep,]
> dim(y)
[1] 15089    13
.......
> dim(df.cpm.noX.Y)
[1] 14603    10
##  14586 uniq gene symbols
linyongmao@Linyong-Mao-MBP16-2019 autism % ls -lh *rnk
-rw-r--r--  1 linyongmao  staff   243K Aug 18 13:15 human_Microglia_rna-postnatal-M.age.interac-diff2-1.noX.Y.interac.strand.rnk
-rw-r--r--  1 linyongmao  staff   243K Aug 18 13:09 human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk
-rw-r--r--  1 linyongmao  staff   246K Aug 18 13:50 human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.strand.rnk

########################pathway DEGs overlap with safari genes
linyongmao@Linyong-Mao-MBP16-2019 autism % vi scr-safari-geneset-overlap-1
linyongmao@Linyong-Mao-MBP16-2019 autism % bash scr-safari-geneset-overlap-1
cat human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 < 0.05 && NR > 1' | wc -l
    2921
cat human_Microglia_rna-postnatal-MvF-diff2-1.strand.name-type-chr.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 < 0.05 && NR > 1' | wc -l
     797
cat human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 < 0.05 && NR > 1' | grep -w "chr[XY]"|wc -l
     103
cat human_Microglia_rna-postnatal-MvF-diff2-1.strand.name-type-chr.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 < 0.05 && NR > 1' | grep -w "chr[XY]"| wc -l
      45
linyongmao@Linyong-Mao-MBP16-2019 autism % cat human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 < 0.05 && NR > 1 && $2 > 0' | cut -f 1 > temp-MvF
cat human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 < 0.05 && NR > 1 && $2 < 0' | cut -f 1 > temp-FvM
cat human_Microglia_rna-postnatal-M.age.interac-diff2-1.interac.strand.name-type-chr.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 < 0.05 && NR > 1 && $2 > 0' | cut -f 1 > temp-M:age
cat human_Microglia_rna-postnatal-M.age.interac-diff2-1.interac.strand.name-type-chr.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 < 0.05 && NR > 1 && $2 < 0' | cut -f 1 > temp-F:age

########################F biased gene, but NOT male led interaction
> m.f <- read.delim("human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.name-type-chr.txt")
 m.age <- read.delim("human_Microglia_rna-postnatal-M.age.interac-diff2-1.noX.Y.interac.strand.name-type-chr.txt")
 b <- merge(m.f, m.age, by.x="geneID", by.y="geneID")
 dim(b)
# [1] 14603    19
 f.b <- b[ b$logFC.x < 0 & b$PValue.x < 0.05,]
 summary(f.b)
### F biased, but NOT male led interaction
 f.b <- b[ b$logFC.x < 0 & b$PValue.x < 0.05 & !(b$logFC.y > 0 & b$PValue.y < 0.05),]
 dim(f.b)
# [1] 724  19
# F led interaction, or if M-led-interaction, p > 0.1
 f.b.1 <- f.b[ f.b$logFC.y < 0 | f.b$PValue.y > 0.1, ]
 dim(f.b.1)
# [1] 355  19
 head(f.b.1, n = 40)[,1:14]
 summary(f.b.1$logFC.y)
#     Min.  1st Qu.   Median     Mean  3rd Qu.     Max.
# -0.02772  0.05059  0.06547  0.07523  0.08738  0.28064
 summary(f.b.1$logFC.x)
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
# -4.0889 -1.4802 -0.9827 -1.2533 -0.7861 -0.5071
> write.table(f.b.1$name.x, "temp", quote=F, sep="\t")
 f.b.m.int <- b[ b$logFC.x < 0 & b$PValue.x < 0.05 & (b$logFC.y > 0 & b$PValue.y < 0.01),]
 dim(f.b.m.int)
#[1] 292  19
> write.table(f.b.m.int$name.x, "temp-1", quote=F, sep="\t")
 summary(f.b.1$PValue.x)
#     Min.  1st Qu.   Median     Mean  3rd Qu.     Max.
# 0.001537 0.021219 0.032304 0.030264 0.040980 0.049933
 summary(f.b.m.int$PValue.x)
#      Min.   1st Qu.    Median      Mean   3rd Qu.      Max.
# 1.149e-05 7.261e-04 2.155e-03 5.531e-03 5.583e-03 4.283e-02
> t.test(log10(f.b.1$PValue.x), log10(f.b.m.int$PValue.x))

        Welch Two Sample t-test

data:  log10(f.b.1$PValue.x) and log10(f.b.m.int$PValue.x)
t = 25.471, df = 360.23, p-value < 2.2e-16
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 1.046040 1.221078
sample estimates:
mean of x mean of y
-1.581678 -2.715237

> f.b.1 <- f.b[ f.b$logFC.y < 0 | f.b$PValue.y > 0.25, ]
>  dim(f.b.1)
[1] 85 19

> f.b.m.int <- b[ b$logFC.x < 0 & b$PValue.x < 0.05 & (b$logFC.y > 0 & b$PValue.y < 0.005),]
>  dim(f.b.m.int)
[1] 162  19

########################
> f.b <- b[ b$logFC.x < 0 & b$PValue.x < 0.05 & (b$logFC.y <= 0 | b$PValue.y > 0.25), ]
> dim(f.b)
[1] 85 19
> summary(f.b)
f.b.no-interac.85genes
linyongmao@Linyong-Mao-MBP16-2019 autism % ls ../microglia/HA* | grep -v temp > temp-file
linyongmao@Linyong-Mao-MBP16-2019 autism % bash script-inputset-pathways-overlap-fisher f.b.no-interac.85genes f.b.no-interac.85genes temp-file human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk

m.f <- read.delim("human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.name-type-chr.txt")
 m.age <- read.delim("human_Microglia_rna-postnatal-M.age.interac-diff2-1.noX.Y.interac.strand.name-type-chr.txt")
 b <- merge(m.f, m.age, by.x="geneID", by.y="geneID")
 dim(b)
# [1] 14603    19
 t <- read.delim("human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.strand.name-type-chr.txt")
 b.1 <- merge(b, t, by.x="geneID", by.y="geneID")
 b.2 <- b.1[ b.1$logFC < 0 & b.1$PValue < 0.05,]
 dim(b.2)
# [1] 466  28
 summary(b.2$logFC.x)
####check M vs. F resulting from the interact model
#     Min.  1st Qu.   Median     Mean  3rd Qu.     Max.
# -8.94950 -1.83108 -1.23873 -1.52103 -0.82108 -0.09201
 summary(b.2$PValue.x)
#      Min.   1st Qu.    Median      Mean   3rd Qu.      Max.
# 0.0000115 0.0040002 0.0210210 0.0746520 0.0782002 0.9998948
 b.3 <- b.2[ b.2$PValue.x >= 0.05,]
# only F biased by non-interact model
 dim(b.3)
# [1] 157  28
#in b.3, PValue.x increase, logFC.y likely becomes negative
#PValue.y increase, logFC.y likely becomes positive 
 b.4 <- b.3[ b.3$PValue.y < 0.25,]
 summary(b.4$logFC.y)
# F:age interaction, not M:age
#     Min.  1st Qu.   Median     Mean  3rd Qu.     Max.
# -0.62985 -0.16385 -0.11082 -0.15860 -0.07944 -0.06070
> write.table(b.3$name.x, "temp-157g", quote=F, sep="\t")
linyongmao@Linyong-Mao-MBP16-2019 autism % cat   temp-157g   f.b.no-interac.85genes  >  temp-242g
>  f.b.m.int <- b[ b$logFC.x < 0 & b$PValue.x < 0.05 & (b$logFC.y > 0 & b$PValue.y < 0.005),]
>  dim(f.b.m.int)
[1] 162  19
> write.table(f.b.m.int$name.x, "temp-m.int.162g", quote=F, sep="\t")

########################
bash  script-inputset-pathways-overlap-fisher male.age.int.162g male.age.int.162g temp-file human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk > temp-1
bash  script-inputset-pathways-overlap-fisher f-b.242g f-b.242g  temp-file human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk > temp-2
> t1 <- read.delim("temp-1")
 t2 <- read.delim("temp-2")
 sum(t1[12, 3:6])
# [1] 14586
 t3 <- merge(t1, t2, by.x="pathway", by.y="pathway")
 dim(t3)
# [1] 50 17
 t4 <- t3[ t3$P.value.x < 0.005 | t3$P.value.y < 0.005,]
 dim(t4)
# [1] 23 17
 t4$m.int.vs.f.b.pval = 1
 t4$m.int.vs.f.odds = 1
for(i in 1:dim(t4)[1]) {
 m <- matrix(1:4,  nrow=2, ncol = 2, byrow=T )
 m[1,] <-as.numeric( t4[i,c(3,4)])
 m[2,] <-as.numeric( t4[i,c(11,12)])
 fi <- fisher.test(m)
 t4$m.int.vs.f.b.pval[i] <- fi$p.value
 t4$m.int.vs.f.odds[i] <- fi$estimate
}

########################NES across three 
 f1="/Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF.noX.Y.interac.strand.prerank.v7.4.GseaPreranked.1692378724023/gsea_report_for_na_neg_1692378724023.tsv"
  gsea1 <- read.delim(f1)
 f1="/Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF.noX.Y.interac.strand.prerank.v7.4.GseaPreranked.1692378724023/gsea_report_for_na_pos_1692378724023.tsv"
 gsea2 <- read.delim(f1)
 gs1 <- bind_rows(gsea1, gsea2)
 gs1$compare <- "MvF.noX.Y.interac.strand"

 f1="/Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-M.age.interac.noX.Y.strand.prerank.v7.4.GseaPreranked.1692379080419/gsea_report_for_na_pos_1692379080419.tsv"
 gsea1 <- read.delim(f1)
 f1="/Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-M.age.interac.noX.Y.strand.prerank.v7.4.GseaPreranked.1692379080419/gsea_report_for_na_neg_1692379080419.tsv"
 gsea2 <- read.delim(f1)
 gs2 <- bind_rows(gsea1, gsea2)
 gs2$compare <- "M.age.interac.noX.Y.strand"

 f1="/Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF.noX.Y.strand.prerank.v7.4.GseaPreranked.1692381192086/gsea_report_for_na_pos_1692381192086.tsv"
 gsea1 <- read.delim(f1)
 f1="/Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF.noX.Y.strand.prerank.v7.4.GseaPreranked.1692381192086/gsea_report_for_na_neg_1692381192086.tsv"
 gsea2 <- read.delim(f1)
 gs3 <- bind_rows(gsea1, gsea2)
 gs3$compare <- "MvF.noX.Y.strand"

 gs.m.1 <- merge(gs1,gs2, by.x="NAME", by.y="NAME")
 gs.m.2 <- merge(gs.m.1, gs3, by.x="NAME", by.y="NAME")
 dim(gs.m.2)
# [1] 49 37
 colnames(gs.m.2)
 gs.m.2[, c(1,6,8,13,18,20,25,30,32,37)]
###NES, fdr, 
 gs.m.3 <- gs.m.2[, c(1,6,8,18,20,30,32)]
 write.table(gs.m.3, "temp-1", quote=F, sep="\t")
#  gs.m.3[ abs(gs.m.3$NES.x) > 1.8 | abs(gs.m.3$NES.y) > 1.8 | abs(gs.m.3$NES) > 1.8, ]
 dim(gs.m.3[ abs(gs.m.3$NES.x) > 1.8 | abs(gs.m.3$NES.y) > 1.8 | abs(gs.m.3$NES) > 1.8, ])
# [1] 31  7

####M-age interact, NOT F biased
 f.b.m.int <- b[ b$PValue.x > 0.25 & (b$logFC.y > 0 & b$PValue.y < 0.05),]
 dim(f.b.m.int)
# [1] 21 19
> ggplot(res.info, aes(x=Age, y=mean, color = Sex)) + geom_point(size=3) + geom_smooth(se=F) + labs(title=genename, y="log2(cpm+1)")

for g in `echo KDM6A    KDM5C   ZFX     DDX3X     SAT1    MPP1`
do
 grep -iw $g human_Microglia_rna-postnatal-MvF-diff2-1.strand.name-type-chr.txt
 echo
done

awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 == "X" '  safari.genes.* | cut -f 2| sort | uniq > temp
> t1 <- read.delim("human_Microglia_rna-postnatal-MvF-diff2-1.strand.name-type-chr.txt")
 g <- read.delim("temp", header=F)
 t2 <- t1[ t1$name %in% g$V1,]

########################
> t1 <- read.delim("../../Downloads/ChEA_2022_table(7).txt")
 t2 <- read.delim("../../Downloads/ChEA_2022_table(8).txt")
 t3 <- merge(t1, t2, by.x="Term", by.y="Term")
 dim(t3)
# [1] 717  17
> t4 <- t3[ t3$P.value.x < 1e-4,c(1,2,3,4,7,10:12,15)]

#############################################################################
########################pathway level z-score
raw <- read.delim("human_Microglia_RNA-18samp.gene.count.stranded.txt")
#remove 3 adult samples, and only keep P17_Temporal & P8_Parietal
#search raw.samp
 raw.samp <- raw[, c(6:7,9:18, 20)]
 dim(raw.samp)
# [1] 62703    13
rownames(raw.samp) <- raw$geneID
dim(raw.samp)
# [1] 62703    13
summary( raw.samp[,1] - raw[, 6]  )
y <- DGEList(counts=raw.samp)
y <- calcNormFactors(y)
dim(y)
summary(y$samples$norm.factors)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
# 0.8766  0.9510  1.0106  1.0024  1.0569  1.1434
#5 male samples
keep <-rowSums(edgeR::cpm(y)>=1) >= 4
y<-y[keep,]
dim(y)
# [1] 15089    13
d = edgeR::cpm(y)
a <- d
b = log10(a+1)
for(i in 1:dim(b)[1])
{
 a[i, ] <- (b[i, ] - mean(as.numeric(b[i,]))) / var(as.numeric(b[i,]))^(1/2)
}
###a is z-score of log10(cpm+1)
info <- read.delim("human.postnatal.18samp.info")
gene.name <- raw[, 1:2]
a.df <- as.data.frame(a)
a.df$id <- row.names(a.df)
a.df.g <- merge(a.df, gene.name, by.x="id", by.y="geneID")
dim(a.df.g)
 file <- "../microglia/HALLMARK_MITOTIC_SPINDLE.genes"
p <- read.delim(file, header=F)
p.exp <- a.df.g[ a.df.g$name %in% p$V1, ]
length(p.exp$name)
# [1] 200 pathway genes ->  179 with cpm >= 1 in >= 4 samples
mat <- as.matrix(p.exp[, 2:14])
res <- data.frame(id = colnames(mat), mean = colMeans(mat))
res$id <- gsub("human_Microglia_RNA_polyA_", "", res$id)
res.info <- merge(res, info, by.x="id", by.y="Patient.ID")
 ggplot(res.info, aes(x=Age, y=mean, color = Sex)) + geom_point(size=3) + geom_smooth(se=F) + labs(title=gsub(".*microglia/", "", file), y="z-score avg of all pathway genes")

############################no chrX / chrY genes, p-value < 0.05 F bias
 chr <- read.delim("../autism/gencode.v42.primary_assembly.noPar.gene-chr-type")
 t3 <- merge(a.df.g, chr, by.x="id", by.y="geneID")
 dim(t3)
 t4 <- t3[ t3$chr != "chrX" & t3$chr != "chrY",]
 dim(t4)
# [1] 14603    18
 a.df.g.all <- a.df.g
 a.df.g <- t4

 t2 <- read.delim("human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk", header=F)
 t3 <- t2
 file <- "../microglia/HALLMARK_OXIDATIVE_PHOSPHORYLATION.genes"
 p <- read.delim(file, header=F)
 t4 <- t3[ t3$V1 %in% p$V1,]
 dim(t4)
 genes <- (t4[t4$V2 < log10(0.05) ,])$V1
 dim(t4[t4$V2 < log10(0.05) ,])

 p.exp <- a.df.g[ a.df.g$name %in% genes, ]
 length(p.exp$name)
# [1] 200 pathway genes ->  179 with cpm >= 1 in >= 4 samples
 mat <- as.matrix(p.exp[, 2:14])
 res <- data.frame(id = colnames(mat), mean = colMeans(mat))
 res$id <- gsub("human_Microglia_RNA_polyA_", "", res$id)
 res.info <- merge(res, info, by.x="id", by.y="Patient.ID")
 summary(res.info$mean)
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
# -1.0007 -0.7732  0.1306  0.0000  0.6763  1.0476

 gplot(res.info, aes(x=Age, y=mean, color = Sex)) + geom_point(size=3, shape=21) + geom_smooth(se=F) + labs(title=gsub(".*microglia/", "", file), y="z-score avg of all pathway genes")


#############################################################################
t1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF.noX.Y.strand.prerank.v7.4.GseaPreranked.1692381192086/HALLMARK_INTERFERON_GAMMA_RESPONSE.tsv")

 t2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-M.age.interac.noX.Y.strand.prerank.v7.4.GseaPreranked.1692379080419/HALLMARK_INTERFERON_GAMMA_RESPONSE.tsv")
 MvF.m.age <- merge(t1, t2, by.x="SYMBOL", by.y = "SYMBOL")
 dim(MvF.m.age)
# [1] 178  13
 plot(MvF.m.age$RANK.METRIC.SCORE.x, MvF.m.age$RANK.METRIC.SCORE.y, xlab="MvF.noX.Y.strand.no-interact-in-model", ylab="M.age.interact")
 abline(h = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100, 100, 0.5), lty = 5, lwd = 0.5, col = "gray")
 abline(h = 0)
 abline(v = 0)
 abline(h = -log10(0.25), col="blue", lty = 5, lwd = 0.5)
 abline(v = log10(0.05), col="blue")
 abline(h = -log10(0.05), col="blue")
 t1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF.noX.Y.interac.strand.prerank.v7.4.GseaPreranked.1692378724023/HALLMARK_INTERFERON_GAMMA_RESPONSE.tsv")
MvF.m.age.mVf2 <- merge(MvF.m.age, t1 , by.x="SYMBOL", by.y = "SYMBOL")
 sort(MvF.m.age.mVf2[ MvF.m.age.mVf2$RANK.METRIC.SCORE < -2 & MvF.m.age.mVf2$RANK.METRIC.SCORE.y > 2,]$SYMBOL)
#  [1] "B2M"     "BST2"    "CASP1"   "CD40"    "CD69"    "CDKN1A"  "CXCL10"  "FPR1"    "HLA-A"   "HLA-B"   "ICAM1"   "IFIT1"   "IFIT2"   "IFITM3"  "IL6"     "IRF1"
# [17] "ISG15"   "LAP3"    "LY6E"    "MARCHF1" "MTHFD2"  "OASL"    "P2RY14"  "PDE4B"   "PIM1"    "PSME1"   "PTPN2"   "SOCS3"   "TNFSF10" "TRIM21"  "VAMP8"
 t3 <- sort(MvF.m.age.mVf2[ MvF.m.age.mVf2$RANK.METRIC.SCORE < -2 & MvF.m.age.mVf2$RANK.METRIC.SCORE.y > 2,]$SYMBOL)
 length(t3)
# [1] 31
 t4 <- MvF.m.age.mVf2[ (MvF.m.age.mVf2$RANK.METRIC.SCORE.x < log10(0.05) | MvF.m.age.mVf2$RANK.METRIC.SCORE < -2) & MvF.m.age.mVf2$RANK.METRIC.SCORE.y < -log10(0.25),]
 length(sort(t4$SYMBOL))
# [1] 11
#############################################################################

linyong@fry /lab/solexa_page/linyong/cyno-data$ cat script-cyno-atac-seq-bwa-feb-20-2024
#
#

for id in `echo L16_6692  L16_6701   L16_6704   L16_6707   L16_6720   L16_6723`
do
 ls -lh "/lab/solexa_public/Page/231129_WIGTC-NOVASEQ1B_BHNFK2DRX3/FASTQ/$id"*fastq.gz
 echo
  f1=`ls "/lab/solexa_public/Page/231129_WIGTC-NOVASEQ1B_BHNFK2DRX3/FASTQ/$id"*fastq.gz | head -1`
  f2=`ls "/lab/solexa_public/Page/231129_WIGTC-NOVASEQ1B_BHNFK2DRX3/FASTQ/$id"*fastq.gz | awk 'NR == 2' `
  bwa mem -t 14 /lab/solexa_page/linyong/cyno-genome/GCF_012559485_plus_Y.fna "$f1" "$f2" > "$id".sam
done


#######################################################################################
linyong@fry /lab/solexa_page/linyong/cyno-data$ cat script-select-readss
#

ls L*.sam | while read f
do
 id=`echo "$f" | sed 's/.sam//' `
 echo "$id"
 awk 'BEGIN {FS = "\t";} !($2 != 99 && $2 != 147 && $2 != 83 && $2 != 163) && $5 == 60'  "$f" > "$id".kept.sam
 ls -lh "$f"  "$id".kept.sam
 wc -l "$f"  "$id".kept.sam

done

#########################################################################################
linyong@fry /lab/solexa_page/linyong/cyno-data$ cat script-select-readss-2
#

ls L*.kept.sam | while read f
do
 id=`echo "$f" | sed 's/.kept.sam//' `
 echo "$id"
 cut -f 1 "$f" | sort | uniq -d > temp.paired.reads-ID
 /lab/solexa_page/linyong/getSam-ID  temp.paired.reads-ID "$f" > "$id".mapQ.paired.sam
 ls -lh  "$id".sam  "$id".kept.sam "$id".mapQ.paired.sam
 wc -l "$id".sam  "$id".kept.sam "$id".mapQ.paired.sam
 
done

####################################################################################
linyong@fry /lab/solexa_page/linyong/cyno-data$ cat script-sam2bam
#

ls L*.mapQ.paired.sam | while read f
do
 id=`echo "$f" | sed 's/.sam//' `
 samtools view -b -S  -t /lab/solexa_page/linyong/cyno-genome/GCF_012559485_plus_Y.fna.fai -o "$id".bam  "$f"
 ls -lh "$id".bam "$f" 
done

########################################################################################
linyong@fry /lab/solexa_page/linyong/cyno-data$ cat   script-macs2-01 
#
ls L*.mapQ.paired.bam | while read f
do
 id=`echo "$f" | sed 's/.bam//' `
 macs2 callpeak -f BAMPE -t "$f" -g 2.74e9 --keep-dup all --outdir dir-macs2-defalt-param-2024-2-22  -n "$id" --tempdir "/tmp"   

done


########################################################################################
for each sample, overlap with the other samples' peaks. peak 2 peak overlap
linyong@fry /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22$ cat ../script-peak-overlap

#############################################################################
linyong@fry /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22$ ls temp-*.overlap |wc -l
90
cat temp-*.overlap | sed 's/.mapQ.paired_peak_[0-9]*$//' | cut -f 4,8 | sort | uniq | cut -f 1 | uniq -c |  awk '$1 >= 5' |  awk 'BEGIN {OFS = "\t";} {print $2}' > conserved.6samp.peaks
wc -l conserved.6samp.peaks
425221 conserved.6samp.peaks
cat  conserved.6samp.peaks | sed 's/.mapQ.paired_peak.*//' | sort | uniq -c | head -20

cat temp-*.overlap | sed 's/.mapQ.paired_peak_[0-9]*$//' | cut -f 4,8 | sort | uniq | cut -f 1 | uniq -c |  awk '$1 >= 9' |  awk 'BEGIN {OFS = "\t";} {print $2}' | wc -l
121417

###cat temp-*.overlap | field 1-8
NC_052256.1	60449112	60449474	L16_6723.mapQ.paired_peak_9997	NC_052256.1	60449120	60449290	L16_6208.mapQ.paired_peak_48463
NC_052256.1	60449112	60449474	L16_6723.mapQ.paired_peak_9997	NC_052256.1	60448984	60449201	L16_6209.mapQ.paired_peak_116051
NC_052256.1	60449112	60449474	L16_6723.mapQ.paired_peak_9997	NC_052256.1	60449316	60449402	L16_6209.mapQ.paired_peak_116052

###
ls L*.mapQ.paired_peaks.xls | wc -l
cat L*.mapQ.paired_peaks.xls  | awk 'BEGIN {FS = "\t";} NF > 5' | sort -t '    ' +9 -10 > temp-1
sort +0 -1  conserved.10samp.peaks > temp-2
join -t '      ' -1 1 -2 10 temp-2 temp-1 -o "2.1,2.2,2.3,2.10" > conserved.10samp.peaks.coord
wc -l conserved.10samp.peaks.coord
# 121417 conserved.10samp.peaks.coord
####make gene promoter (+/- 2kbp from TSS) in bed format
linyong@fry /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22$ bash script-gene-bed

-rw-r--r-- 1 linyong systemd-timesync 5738540 Feb 24 12:52 temp-gene.bed

bedtools intersect -a temp-gene.bed -b conserved.10samp.peaks.coord -wa -wb  > temp.gene.2kbp.peak
cat temp.gene.2kbp.peak | cut -f 4 | sort | uniq -c | wc -l
10590 genes whose promoters overlap with conserv peaks 

###
linyong@fry /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22$ sort -t '      ' +0 -1 +1 -2n conserved.10samp.peaks.coord > conserved.10samp.peaks.coord.sorted

bedtools merge -d 100 -i  conserved.10samp.peaks.coord.sorted >  conserved.10samp.peaks.coord.sorted.merged
wc -l conserved.10samp.peaks.coord.sorted.merged
12504 conserved.10samp.peaks.coord.sorted.merged

cat  conserved.10samp.peaks.coord.sorted.merged |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""}
 {
   print $1 "\t" "macs2" "\t" "peak" "\t"  $2 "\t" $3 "\t" "." "\t" "+"  "\t" "."  "\t" "peak_id=\"" $1 "@@@" $2 "@@@" $3  "\"" "\n";
 }' > conserved.10samp.peaks.coord.sorted.merged.gtf

head conserved.10samp.peaks.coord.sorted.merged.gtf
NC_052255.1     macs2   peak    35206   36313   .       +       .       peak_id="NC_052255.1@@@35206@@@36313"
NC_052255.1     macs2   peak    59400   60663   .       +       .       peak_id="NC_052255.1@@@59400@@@60663"

cat ../script-peak-read-count

######
linyong@fry /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22$ cat out-cyno-atac-seq-peakreadcount-2024-2-24-149p  | awk 'NF == 1'  | sort | uniq -c
     10 500000 read pairs next to each other in the bam file

linyong@fry /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22$ bash temp-s1
vi s
mv -i s cyno-atac-mg-10samp-conserv10.readcount

> setwd("../autism/")
 t <- read.delim("cyno-atac-mg-10samp-conserv10.readcount", row.names=1)
rawCount <- t
group <- factor(rep(1, 10))
y <- DGEList(counts=rawCount,group=group)
y <- calcNormFactors(y)
 d = cpm(y)
 a <- log10(d+1)
 a.df <- as.data.frame(a)
 c1 <- as.data.frame(cor(a.df))
 summary(c1)

###
 col_fun = colorRamp2(c(0.4,0.7,1), c( "blue", "white",  "red"))
 Heatmap(c1, name = "correlation")
> t1 <- data.frame(id = rownames(a.df), var = a.df[,1])
for(i in 1:dim(a.df)[1])
{
 t1$var[i] = var(as.numeric(a.df[i,]))
}

 info <- data.frame(sex = c(1,1,1,0,0,1,0,1,0,1))
t1$sex.cor = -999
for(i in 1:dim(a.df)[1])
{
  d1 <-  data.frame(y = t(a.df[i,]), sex = info$sex )
  d2 <-  lm(d1[,1] ~ d1$sex)
  d3 <- summary(d2)
  t1$sex.cor[i] = d3$r.squared
}

> sum(t1$var)
[1] 694.7368
> sum(t1$var * t1$sex.cor)
[1] 62.14254
> sum(t1$var * t1$sex.cor) / sum(t1$var)
[1] 0.08944761
> info$id <- colnames(a.df)
> info$batch <- c(rep(0,4), rep(1, 6))
> info
   sex       id batch
1    1 L16_6204     0
2    1 L16_6205     0
3    1 L16_6208     0
4    0 L16_6209     0
5    0 L16_6692     1
6    1 L16_6701     1
7    0 L16_6704     1
8    1 L16_6707     1
9    0 L16_6720     1
10   1 L16_6723     1

t1$batch.cor = -999
for(i in 1:dim(a.df)[1])
{
  d1 <-  data.frame(y = t(a.df[i,]), sex = info$batch)
  d2 <-  lm(d1[,1] ~ d1$sex)
  d3 <- summary(d2)
  t1$batch.cor[i] = d3$r.squared
}

###
 resid2 <- a.df
for(i in 1:dim(a.df)[1] ) {
d1 <-  data.frame(y = t(a.df[i,]), sex = info$sex )
d2 <-  lm(d1[,1] ~ d1$sex)
d3 <- resid(d2)
resid2[i,] <- d3
}

 r3 <- t(resid2)

                            PC1      PC2      PC3      PC4      PC5      PC6      PC7      PC8          PC9         PC10
Standard deviation     68.65411 46.58700 43.16860 36.31121 30.18019 26.51366 21.35069 19.19798 1.628669e-13 9.795077e-14
Proportion of Variance  0.37695  0.17357  0.14903  0.10545  0.07284  0.05622  0.03646  0.02948 0.000000e+00 0.000000e+00
Cumulative Proportion   0.37695  0.55052  0.69956  0.80500  0.87785  0.93407  0.97052  1.00000 1.000000e+00 1.000000e+00

> identical(colnames(a.df), p1$id)
[1] TRUE
p1= PC1..10 coordinates 

t1$pc1.cor = -999
for(i in 1:dim(a.df)[1])
{
  d1 <-  data.frame(y = t(a.df[i,]), sex = p1$PC1)
  d2 <-  lm(d1[,1] ~ d1$sex)
  d3 <- summary(d2)
  t1$pc1.cor[i] = d3$r.squared
}

t1$pc2.cor = -999
for(i in 1:dim(a.df)[1])
{
  d1 <-  data.frame(y = t(a.df[i,]), sex = p1$PC2)
  d2 <-  lm(d1[,1] ~ d1$sex)
  d3 <- summary(d2)
  t1$pc2.cor[i] = d3$r.squared
}

> write.table(p2, "cyno-atac-mg-10samp-conserv10.sex.batch.PCA.txt", sep="\t", quote=F)

> identical(colnames(y), p2$id)
design <- model.matrix( ~ p2$sex + p2$batch + p2$PC1 + p2$PC2)
 y <- estimateDisp(y,design)
 fit <- glmQLFit(y, design)
 qlf <- glmQLFTest(fit, coef=2)
 top2v1 <- topTags(qlf, n = 91234)
 y[,1:10]
head(top2v1)
 t2 <- read.delim("cyno-atac-mg-10samp-conserv10.overlap.promoter.gene", header=F)
 diff <- as.data.frame(top2v1)
 diff$geneID <- rownames(diff)
 df.gene <- merge(diff, t2, by.x="geneID", by.y="V6")
 dim(diff)
# [1] 12504 peaks     6
 dim(df.gene)
# [1] 10853    11
# 10590 genes whose promoters overlap with merged conserv peaks
  write.table(df.gene, "diff2-1.txt", sep="\t", quote=F)

linyongmao@Linyong-Mao-MBP16-2019 autism % vi diff2-1.txt                                                         
linyongmao@Linyong-Mao-MBP16-2019 autism % cat diff2-1.txt| awk 'NR > 1' | cut -f 1 | sort | uniq | wc -l          
    8544 uniq peaks overlapped with gene promoter
linyongmao@Linyong-Mao-MBP16-2019 autism %  cat diff2-1.txt| awk 'NR > 1' | cut -f 7 | sort | uniq | wc -l  
   10590 uniq genes
cat diff2-1.txt| awk 'NR > 1' |wc -l
   10853
linyongmao@Linyong-Mao-MBP16-2019 autism %  cat diff2-1.txt| awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 < 0 && $5 < 0.05' | cut -f 7 > temp-1
linyongmao@Linyong-Mao-MBP16-2019 autism %  cat diff2-1.txt| awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 > 0 && $5 < 0.05' | cut -f 7 | sort | uniq > temp-2


######
t <- read.delim("cyno-atac-mg-10samp-conserv10.readcount", row.names=1)
rawCount <- t
group <- factor(rep(1, 10))
y <- DGEList(counts=rawCount,group=group)
y <- calcNormFactors(y)
###filter low read count peaks?
identical(colnames(y), p2$id)
design <- model.matrix( ~ p2$sex +  p2$PC1 + p2$PC2)
 y <- estimateDisp(y,design)
 fit <- glmQLFit(y, design)
 qlf <- glmQLFTest(fit, coef=2)
 top2v1 <- topTags(qlf, n = 91234)
y[,1:10]
head(top2v1)
 t2 <- read.delim("cyno-atac-mg-10samp-conserv10.overlap.promoter.gene", header=F)
 diff <- as.data.frame(top2v1)
 diff$geneID <- rownames(diff)
 df.gene <- merge(diff, t2, by.x="geneID", by.y="V6")
 dim(df.gene)
 dim(df.gene[ df.gene$PValue < 0.05,])
  write.table(df.gene, "diff2-1.txt", sep="\t", quote=F)

linyongmao@Linyong-Mao-MBP16-2019 autism %  cat  cyno-atac-mg-10samp-conserv10.pc1_3.covar.diff2-1.txt|  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""}
{for(i = 1; i <= 7; i++)
   print $i "\t";

 print $7 "\n";
}' | grep -v "^NC_052275\.1@@@" > temp
../microglia/make-rnk-genesymble  temp   cyno-atac-mg-10samp-conserv10.pc1_3.covar.noX.Y.rnk
vi cyno-atac-mg-10samp-conserv10.pc1_3.covar.noX.Y.rnk

 cat  cyno-atac-mg-10samp-conserv10.pc1_3.covar.diff2-1.txt| awk 'NR > 1' | sort -t '   ' +4 -5g | head -500 | awk 'BEGIN {FS = "\t";} $2 > 0' | grep -v "^NC_052275\.1@@@"  | cut -f 7 | sed 's/gene_id //' |sort | uniq > temp-f

cat  cyno-atac-mg-10samp-conserv10.pc1_3.covar.diff2-1.txt| awk 'NR > 1' | sort -t '    ' +4 -5g | head -500 | awk 'BEGIN {FS = "\t";} $2 < 0' | grep -v "^NC_052275\.1@@@"  | cut -f 7 | sed 's/gene_id //' |sort | uniq > temp-m

######
> diff.pc1..3 <- diff
 t2 <- merge(diff.batch, diff.pc1..3, by.x="geneID", by.y="geneID")
 dim(t2)
# [1] 12504    11
 t3 <- lm(t2$logFC.y ~ t2$logFC.x)
 summary(t3)

Coefficients:
             Estimate Std. Error t value Pr(>|t|)
(Intercept) -0.006634   0.002444  -2.714  0.00666 **
t2$logFC.x   0.939330   0.005950 157.864  < 2e-16 ***

R = 0.8160434
Multiple R-squared:  0.6659,    Adjusted R-squared:  0.6659
F-statistic: 2.492e+04 on 1 and 12502 DF,  p-value: < 2.2e-16

> plot(t2$logFC.x, t2$logFC.y, xlab="logFC (F vs M, batch as covar)", ylab="logFC (F vs M, PC1+PC2+PC3 as covar)")
abline(lm(t2$logFC.y ~ t2$logFC.x), lwd = 1, col="blue")
 abline(h = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
abline(h = 0)
 abline(v = 0)

#########boxplot peak cpm with batch effect
 t <- read.delim("cyno-atac-mg-10samp-conserv10.readcount", row.names=1)
 rawCount <- t
 group <- factor(rep(1, 10))
 y <- DGEList(counts=rawCount,group=group)
 y <- calcNormFactors(y)
d = cpm(y)
a <- d ##a <- log2(d+1)
###a is log2(cpm+1)
a.df <- as.data.frame(a)
a.df$id <- row.names(a.df)
 t2 <- read.delim("cyno-atac-mg-10samp-conserv10.overlap.promoter.gene", header=F)
 a.df.g <- merge(a.df, t2, by.x="id", by.y="V6")
 dim(a.df.g)
# [1] 10853    16
 geneid <- "ZFX"
 p.exp <- a.df.g[ a.df.g$V1 == paste("gene_id", geneid, sep=" "),]
 head( p.exp)
 mat <- as.matrix(p.exp[, 2:11])

 res <- data.frame(id = colnames(mat), mean = colMeans(mat))
 info <- read.delim("cyno-atac-mg-10samp-conserv10.sex.batch.PCA.txt")
 res.info <- merge(res, info, by.x="id", by.y="id")
 res.info$SEX <- factor(res.info$sex, levels=c(1, 0), labels=c("F", "M"))
 res.info$col <- factor(res.info$batch, levels=c(1, 0), labels=c("green", "red"))

 boxplot(res.info$mean ~ res.info$SEX, xlab="sex", ylab = "norm. peak read count")
 beeswarm(res.info$mean ~ res.info$SEX, pwcol=res.info$col, add=T)
 df.gene <- read.delim("cyno-atac-mg-10samp-conserv10.pc1_3.covar.diff2-1.txt")
 
 t1 <- df.gene[ df.gene$V1  == paste("gene_id", geneid, sep=" "),]
 head(t1)
 str <- paste(geneid, ", F/M=", round( 2^t1$logFC[1], digits= 2 ), ", p=", format(t1$PValue[1], digits=3), sep="")
 str
 title(main=str)

##########################################################################
linyong@fry /lab/solexa_page/linyong/cyno-data$ cat script-macs2-02 
#
ls L*.mapQ.paired.bam | while read f
do
 id=`echo "$f" | sed 's/.bam//' `
## macs2 callpeak -f BAMPE -t "$f" -g 2.53e9 --keep-dup all --outdir dir-macs2-defalt-param2  -n "$id".B.SPMR  --tempdir "/tmp"   -B --SPMR  
 macs2 callpeak -f BAMPE -t "$f" -g 2.74e9 --keep-dup all --outdir dir-macs2-defalt-param-2024-2-22 -n "$id".B.SPMR --tempdir "/tmp"   -B --SPMR


done

#######
ls *up.bdg | sed 's/.mapQ.paired.B.SPMR_treat_pileup.bdg//' | while read q
do
  bedGraphToBigWig "$q".mapQ.paired.B.SPMR_treat_pileup.bdg  ../dir-macs2-defalt-param/chrom.sizes "$q".mapQ.paired.B.SPMR_treat_pileup.bw
  echo $q
done

######
linyong@fry /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22$ cat  igv_session.xml
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Session genome="../../cyno-genome/GCF_012559485_plus_Y.fna" locus="NC_052275.1:23690494-23762844" nextAutoscaleGroup="4" version="8">
    <Resources>
        <Resource path="L16_6720.mapQ.paired.B.SPMR_treat_pileup.bw" type="bw"/>
        <Resource path="../../../../page_genomes/Macaca_fascicularis/genome/assemblies/GCF_012559485/GCF_012559485.2_MFA1912RKSv2_genomic.gtf" type="gtf"/>
    </Resources>
    <Panel height="464" name="DataPanel" width="1214">
        <Track attributeKey="L16_6204.mapQ.paired.B.SPMR_treat_pileup.bw" autoScale="true" clazz="org.broad.igv.track.DataSourceTrack" fontSize="10" id="/lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22/L16_6204.mapQ.paired.B.SPMR_treat_pileup.bw" name="L16_6204.mapQ.paired.B.SPMR_treat_pileup.bw" renderer="BAR_CHART" visible="true" windowFunction="mean">
            <DataRange baseline="0.0" drawBaseline="true" flipAxis="false" maximum="7.8648944" minimum="0.0" type="LINEAR"/>
        </Track>
    <Panel height="460" name="FeaturePanel" width="1214">
        <Track attributeKey="Reference sequence" clazz="org.broad.igv.track.SequenceTrack" fontSize="10" id="Reference sequence" name="Reference sequence" sequenceTranslationStrandValue="POSITIVE" shouldShowTranslation="false" visible="true"/>
        <Track attributeKey="GCF_012559485.2_MFA1912RKSv2_genomic.gtf" clazz="org.broad.igv.track.FeatureTrack" colorScale="ContinuousColorScale;0.0;12534.0;255,255,255;0,0,178" displayMode="EXPANDED" fontSize="10" groupByStrand="false" id="/lab/page_genomes/Macaca_fascicularis/genome/assemblies/GCF_012559485/GCF_012559485.2_MFA1912RKSv2_genomic.gtf" name="GCF_012559485.2_MFA1912RKSv2_genomic.gtf" visible="true"/>

############################
linyongmao@Linyong-Mao-MBP16-2019 autism % cat  human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt | awk 'NR > 1' | sort -t '   '  +4 -5g | head -500 | awk 'BEGIN {FS = "\t";} $2 < 0 && $8 != "chrX" && $8 != "chrY" ' | cut -f 7 | sort | uniq > temp-f-model.interac
grep "^RP[LS][0-9]" temp-f-model.interac | wc
      18      18     110
grep -v "^RP[LS][0-9]" temp-f-model.interac > temp-f-model.interac.2
cat  human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt | awk 'NR > 1' | sort -t '   '  +4 -5g | head -500 | awk 'BEGIN {FS = "\t";} $2 > 0 && $8 != "chrX" && $8 != "chrY" ' | cut -f 7 | sort | uniq > temp-m-model.interac
 167 temp-m-model.interac

cat human_Microglia_rna-postnatal-MvF-diff2-1.strand.name-type-chr.txt |  awk 'NR > 1' | sort -t '   '  +4 -5g | head -500 | awk 'BEGIN {FS = "\t";} $2 < 0 && $8 != "chrX" && $8 != "chrY" ' | cut -f 7 | sort | uniq > temp-f-model.no-interac
grep -v "^RP[LS][0-9]"  temp-f-model.no-interac > temp-f-model.no-interac.2

     305 temp-f-model.interac
     287 temp-f-model.interac.2
     292 temp-f-model.no-interac
     285 temp-f-model.no-interac.2

    167 temp-m-model.interac
    176 temp-m-model.no-interac

linyongmao@Linyong-Mao-MBP16-2019 autism % cat human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt |   awk 'NR > 1 && $8 != "chrX" && $8 != "chrY" ' |  cut -f 7 | sort | uniq > temp-bg1
   14586 temp-bg1
 bash ../Whitehead-main/script-inputset-pathways-overlap-fisher  temp-f-model.interac f-bias-human-mg-rnaseq.305genes  temp-hall-files  temp-bg1 > temp11
mv -i  temp11 human-mg-rnaseq.f.bias.305genes.hallmark.overlap.txt

#############################################
#####gene promoter only peaks
> t1 <- read.delim("cyno-atac-mg-10samp-conserv10.pc1_3.covar.diff2-1.txt")
> t2 <- t1[ grep("NC_052275.1@@@", t1$geneID),]
> dim(t2)
[1] 286  11
> t3 <- t2[ t2$logFC >= 0,]
> dim(t3)
[1] 172  11
> t3$rat <- 2^t3$logFC
 t4 <- t2[ t2$logFC < 0,]
 dim(t4)
# [1] 114  11
 t4$rat <- -2^(-t4$logFC)
 head(t4, n = 20)
 t5 <- rbind(t3, t4)
> hist(t5$rat, breaks=seq(-3,3, 0.1),  xlab="", ylab="# of peaks on X chr", main="cyno-atac-mg-10samp-conserv10.pc1_3.covar.diff2-1.txt")

#########
> t1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-M.age.interac.noX.Y.strand.prerank.v7.4.GseaPreranked.1692379080419/HALLMARK_INTERFERON_GAMMA_RESPONSE.tsv")
 t2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF.noX.Y.interac.strand.prerank.v7.4.GseaPreranked.1692378724023/HALLMARK_INTERFERON_GAMMA_RESPONSE.tsv")
 t3 <- merge(t2, t1, by.x="SYMBOL", by.y="SYMBOL")
 par( mar=c(8,8,2,2))
 plot(t3$RANK.METRIC.SCORE.x, t3$RANK.METRIC.SCORE.y, xlab="signed log10(p-val) \n(sex bias; negative being F bias)", ylab="signed log10(p-val) \n (sex:age interaction; M:age biased)")
 abline(v=0)
 abline(h=0)
 y= t3$RANK.METRIC.SCORE.y
 x =  t3$RANK.METRIC.SCORE.x
 abline(lm(y~x), lwd = 1, col="blue")

#############################################################################
 t <- read.delim("cyno-atac-mg-10samp-conserv10.readcount", row.names=1)
 t1 <- t[, c(5:10)]
 rawCount <- t1
 group <- factor(rep(1, 6))
 y <- DGEList(counts=rawCount,group=group)
 y <- calcNormFactors(y)
 p1 <- read.delim("cyno-atac-mg-10samp-conserv10.sex.batch.PCA.txt")
 p2 <- p1[ p1$batch == 1,]
 identical( colnames(y), p2$id)
# [1] TRUE
 age <- c(24, 24, 24,13, 13, 22)
 p2$age = age
 d = cpm(y)
 a <- log10(d+1)
 a.df <- as.data.frame(a)
 t1 <- data.frame(id = rownames(a.df), var = a.df[,1])
t1$sex.cor = -999
for(i in 1:dim(a.df)[1])
{
  d1 <-  data.frame(y = t(a.df[i,]), sex = p2$age )
  d2 <-  lm(d1[,1] ~ d1$sex)
  d3 <- summary(d2)
  t1$sex.cor[i] = d3$r.squared
}
 summary(t1$sex.cor)

                            PC1      PC2      PC3      PC4          PC5          PC6
Standard deviation     67.96100 63.55768 46.95310 40.51086 1.447262e-13 8.859638e-14
Proportion of Variance  0.36938  0.32306  0.17631  0.13125 0.000000e+00 0.000000e+00
Cumulative Proportion   0.36938  0.69244  0.86875  1.00000 1.000000e+00 1.000000e+00

> p1 <- as.data.frame( pca$x[,1:6])
  p1$id <- rownames(p1)
 identical(p1$id, p2$id)
 colnames(p1) <- paste("six", colnames(p1), sep=".")
 p3 <- cbind(p2, p1)


> design <- model.matrix( ~ p2$sex + p2$age )

#############################################################################
 a.df$id <- row.names(a.df)
 t2 <- read.delim("cyno-atac-mg-10samp-conserv10.overlap.promoter.gene", header=F)
  a.df.g <- merge(a.df, t2, by.x="id", by.y="V6")
  dim(a.df.g)
# [1] 10853    12
# [1] 10853    16
  geneid <- "ZFX"
  p.exp <- a.df.g[ a.df.g$V1 == paste("gene_id", geneid, sep=" "),]
  head( p.exp)
  mat <- as.matrix(p.exp[, 2:7])
 
  res <- data.frame(id = colnames(mat), mean = colMeans(mat))
  info <- p2
  res.info <- merge(res, info, by.x="id", by.y="id")
  res.info$SEX <- factor(res.info$sex, levels=c(1, 0), labels=c("F", "M"))
 boxplot(res.info$mean ~ res.info$SEX, xlab="sex", ylab = "norm. peak read count")
 beeswarm(res.info$mean ~ res.info$SEX,  add=T)
 df.gene <- read.delim("cyno-atac-mg-10samp-conserv10.6samplesOnly.age.covar.diff2-1.txt")

 t1 <- df.gene[ df.gene$V1  == paste("gene_id", geneid, sep=" "),]
 head(t1)
 str <- paste(geneid, ", F/M=", round( 2^t1$logFC[1], digits= 2 ), ", p=", format(t1$PValue[1], digits=3), sep="")
 str
 title(main=str)
######
 plot(df.gene$logFC, -log10(df.gene$PValue), xlab = "logFC (F vs. M)", ylab="-log10(PValue)")
 abline(h = seq(-100, 100, 0.5), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100, 100, 0.5), lty = 5, lwd = 0.5, col = "gray")
 abline(h = -log10(0.05), col = "blue")
 abline(v = 0)
 text(1.7, -log10(0.05) + 0.03, "p=0.05", col="blue" )
#############################################################################
nine samples excluding L16_6208
>  t <- read.delim("cyno-atac-mg-10samp-conserv10.readcount", row.names=1)
 rawCount <- t[, c(1:2, 4:10)]
 group <- factor(rep(1, 9))
y <- DGEList(counts=rawCount,group=group)
y <- calcNormFactors(y)
 d = cpm(y)
 a <- log10(d+1)
 a.df <- as.data.frame(a)
 p1 <- read.delim("cyno-atac-mg-10samp-conserv10.sex.batch.PCA.txt")
 p2 <- p1[ p1$id != "L16_6208", c(1,12,13)]
 identical( colnames(y), p2$id)
 identical( colnames(a.df), p2$id)
......
> identical(p2$id, rownames(pca$x))
 p3 <- cbind(p2, pca$x[,1:3])
 age <- c(31, 29, 26, c(24, 24, 24,13, 13, 22))
 p3$age <- age
#####sample swap, not sure about the age of first two samples
 age <- c(29, 31, 26, c(24, 24, 24,13, 13, 22))
 p3$age2 <- age
 cor(p3[,c(2:8)])
> write.table(p3, "cyno-atac-mg-10samp-conserv10.sex.batch.age.9samps.3PCA.txt", sep="\t", quote=F)

 identical(colnames(y),p3$id)
 design <- model.matrix( ~ p3$sex + p3$PC1 + p3$PC2)

> t1 <- read.delim("cyno-atac-mg-10samp-conserv10.6samplesOnly.age.covar.noX.Y.rnk", header=F)
 t2 <- read.delim("cyno-atac-mg-10samp-conserv10.9samplesOnly.pc1_2.covar.noX.Y.rnk", header=F)
 t3 <- merge(t1, t2, by.x="V1", by.y="V1")
 dim(t3)
# [1] 10308     3
 plot(t3$V2.x, t3$V2.y)
  abline(h = seq(-100, 100, 0.5), lty = 5, lwd = 0.5, col = "gray")
  abline(v = seq(-100, 100, 0.5), lty = 5, lwd = 0.5, col = "gray")
 abline(h = 0, col="blue")
  abline(v = 0, col="blue")
data:  t3$V2.x and t3$V2.y
t = 72.278, df = 10306, p-value < 2.2e-16
      cor
0.5799888

#############################################################################
> a
[1]  6  8  2 12
> m <- matrix(a,  nrow=2, ncol = 2, byrow=T )
>  fi <- fisher.test(m)
linyongmao@Linyong-Mao-MBP16-2019 autism % vi temp-hd-human
linyongmao@Linyong-Mao-MBP16-2019 autism % vi temp-hd-mouse
     305 temp-f-model.interac
ls  temp-1 temp-2 > temp-paths
   14586 temp-3
bash ../Whitehead-main/script-inputset-pathways-overlap-fisher temp-f-model.interac F-biased-microglia   temp-paths temp-3

cat temp-hd-human | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 < 0' | awk '$5 < -0.1' | cut -f 1  | awk 'NR > 1' | sort | uniq > temp-1
     407 temp-1
cat temp-hd-human | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 > 0' | awk '$5 > 0.1' | cut -f 1  | awk 'NR > 1' | sort | uniq > temp-2
     453 temp-2

cat  human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt | awk 'NR > 1' |  awk 'BEGIN {FS = "\t";} $8 != "chrX" && $8 != "chrY" ' | cut -f 7 | sort | uniq >  temp-3
   14586 temp-3
                       pathway-genes         non-pathway-genes
sig-genes-input        28                    277   (sum=305)
non-sig-gens-in        349                   13932 (sum=14281)
                       377(temp-1 && bg genes)

######
> t1 <- read.delim("../autism/HD-snRNA-test.dat")
 lm1 <- lm(t1$zfx ~ t1$disease + t1$sex)
 summary(lm1)
t1$diseasehd  6.714e-15  1.187e+00    0.00        1

>  lm1 <- lm(t1$zfx ~ t1$disease)
t1$diseasehd   -5.714      3.539  -1.615    0.118

######
linyongmao@Linyong-Mao-MBP16-2019 autism % cat  safari.genes | cut -f 2 | awk 'NR > 1' | sort | uniq > temp-safari.genes
cat safari.genes.cater1 | cut -f 2 | awk 'NR > 1' | sort | uniq > temp-safari.genes.cater1
cat safari.genes.syndrome  | cut -f 2 | awk 'NR > 1' | sort | uniq > temp-safari.genes.syndrome
ls temp-safari.genes  temp-safari.genes.cater1 temp-safari.genes.syndrome >  temp-paths 
bash ../Whitehead-main/script-inputset-pathways-overlap-fisher temp-m-model.interac M-biased-microglia   temp-paths temp-3

#############################################################################
> t1 <- read.delim("human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.name-type-chr.txt")
t2 <- t1[1,]
 t2$logFC = -8
 t2$PValue = 0.04
 t2$name="PValue = 0.05"
ggplot(t1, aes(x=logFC, y = -log10(PValue), label = name))  + geom_point(size=1) + labs( x = "log2FC (M vs. F)") + geom_hline(yintercept=-log10(0.05), col="blue") + geom_text(data=t2, col="blue")

> g <- read.delim("../microglia/temp", header=F)
 t3 <- t1[ t1$name %in% g$V1,]
 dim(t3)
# [1] 3097   10
 t4 <- t1[ !(t1$name %in% g$V1),]
 dim(t4)
# [1] 11506    10
 t3$class <- "HALLMARK genes"
 t4$class <- "others"
 t5 <- rbind(t3, t4)
 dim(t5)
# [1] 14603    11
 ggplot(t5, aes(x=logFC, y = -log10(PValue), label = name, col=class))  + geom_point(shape=21, size=1) + labs( x = "log2FC (M vs. F)") + geom_hline(yintercept=-log10(0.05), col="blue") + geom_text(data=t2, col="blue") + theme(legend.position = "bottom")

#######################################################################
mapping mouse microglia prenatal and 2-month-old mice RNA-seq
  --readFilesCommand zcat
@1/1
CTCTAGAGGGAGCCCAGCCTCCTGAGGAAGCCTGGGAAACAGCTGTTCAG
+
BBBFFFFFFFFFFFIFIIIIIIIIIIIIIIIIIIIIIIIIIIIIIFIIII

linyong@fry /lab/solexa_page/linyong/autism/dir-mouse-rna-seq/paired$ sbatch slurm-mouse-heart-rnaseq-genecount-03

######
> t1 <- read.delim("../autism/mouse-mg-rnaseq-Thion.txt")
 raw.samp <- t1[, c(9:12)]
 dim(raw.samp)
# [1] 56980     4
 rownames(raw.samp) <- t1$geneID
 y <- DGEList(counts=raw.samp)
 y <- calcNormFactors(y)
 y$samples
           group lib.size norm.factors
SRR6366231     1 22568111    0.9800655
SRR6366232     1 21573099    0.9772444
SRR6366236     1 24785582    1.0270853
SRR6366237     1 29217740    1.0165652

 keep <-rowSums(edgeR::cpm(y)>=0.5) >= 2
 y<-y[keep,]
 dim(y)
# [1] 15238     4
 
> info <- data.frame(sex = c(1,1,0,0))
  design <- model.matrix( ~ info$sex)
y <- estimateDisp(y,design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, coef=2)
top2v1 <- topTags(qlf, n = 91234)
diff <- as.data.frame(top2v1)
diff$geneID <- rownames(diff)
 t1 <- read.delim("../autism/mouse-mg-rnaseq-Thion.txt")
 gene.name <- t1[, 1:2]
 df.gene <- merge(diff, gene.name, by.x="geneID", by.y="geneID")
 t2 <- read.delim("../dir-GTExV8/gencode.vM31.mouse-id-chr-name")
 t3 <- merge(df.gene, t2, by.x="geneID", by.y="geneID")
 dim(t3)
# [1] 15238    11
  head(top2v1)
  write.table(t3, "diff2-1.txt", sep="\t", quote=F)
 y

> t4 <- read.delim("../microglia-mouse/M10.geneID-name-chr-type.2.name-first.txt")
 dim(t4)
# [1] 48440     5
 df.cpm.gene <- t3
 t5 <- merge(df.cpm.gene, t4, by.x="name.x", by.y="geneID")
 dim(t5)
# [1] 13857    15
     name.x                geneID      logFC    logCPM          F       PValue          FDR chr.x strand         type.x name.y chr.y                 ID
8239  Nfkb1 ENSMUSG00000028163.18 -0.1996375  8.087156   4.178701 7.371070e-02 1.802606e-01  chr3      - protein_coding  Nfkb1  chr3 ENSMUSG00000028163
8240  Nfkb2 ENSMUSG00000025225.16  0.4853682  5.947340  21.449084 1.505069e-03 1.377432e-02 chr19      + protein_coding  Nfkb2 chr19 ENSMUSG00000025225

 t6 <- read.delim("../microglia-mouse/Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip")
 dim(t6)
# [1] 19341     3
#                   ID Gene.Symbol                                                                Gene.Title
# 1 ENSMUSG00000000001       GNAI3             G protein subunit alpha i3 [Source:HGNC Symbol;Acc:HGNC:4387]
 t7 <- merge(t5, t6, by.x="ID", by.y="ID")
 dim(t7)
# [1] 11847    17

 df.cpm.gene$id <- gsub("\\.[0-9][0-9]*", "", df.cpm.gene$geneID)
 t8 <- merge(df.cpm.gene, t6, by.x="id", by.y="ID")
 dim(t8)
# [1] 12380    14
 t9 <- t8[ t8$chr != "chrX" & t8$chr != "chrY", c(1,3:7,2,13)]
 dim(t9)
# [1] 11992     8
 write.table(t9, "temp", quote=F, sep="\t")
linyongmao@Linyong-Mao-MBP16-2019 autism % vi ../dir-GTExV8/temp
 ../microglia/make-rnk-genesymble  ../dir-GTExV8/temp out
  11817 out
cat out | grep -i xist
cat out | grep -i ddx3y
mv -i  out  mouse-mg-rnaseq-Thion.diff2-1.noXY.rnk

linyongmao@Linyong-Mao-MBP16-2019 autism % mv -i  ../dir-GTExV8/diff2-1.txt mouse-mg-rnaseq-Thion.diff2-1.name-type-chr.txt
linyongmao@Linyong-Mao-MBP16-2019 autism % cat  mouse-mg-rnaseq-Thion.diff2-1.name-type-chr.txt| awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 < 1e-8 '|grep -w chrY
cat  mouse-mg-rnaseq-Thion.diff2-1.name-type-chr.txt| awk 'BEGIN {FS = "\t"; OFS = "\t"} $6 < 0.005 && $8 != "chrX" && $8 != "chrY" ' | wc -l
     889
&& $2 > 0' | wc -l
     788
 && $2 < 0' | wc -l
     101
cat  mouse-mg-rnaseq-Thion.diff2-1.name-type-chr.txt| awk 'BEGIN {FS = "\t"; OFS = "\t"} $6 < 0.0005 && $8 != "chrX" && $8 != "chrY" && $2 > 0' | cut -f 7 > temp-f
     380 temp-f

#########
d = cpm(y)
 a <- as.data.frame(d)
 b = log2(a+1)
 t2 <- read.delim("../dir-GTExV8/gencode.vM31.mouse-id-chr-name")
 b$id <- rownames(b)
 t3 <- merge(b, t2, by.x="id", by.y="geneID")
> g1 <- <- scan(what="", sep = "\n")
Actb
Itgam
P2ry12
Tmem119
Cx3cr1
Ccr2
Cd3d
Ms4a1
> t4 <- t3[ t3$name %in% g1,]
 t5 <- t4[,c(2:5)]
 rownames(t5) <- t4[,9]
 t6 <- as.data.frame( t(t5))
 t7 <- t6[, c(2,3,5,8,7,6,4,1)]
 boxplot(t7, outcol="white", ylab="log2(cpm+1)")
 beeswarm(t7, add=T, cex = 1, col = "red" )
 abline(h = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")

#######################################################################
linyong@fry /lab/solexa_page/linyong/mouse-genome$  cat gencode.vM31.primary_assembly.annotation.gtf | awk '$3 == "gene"' | cut -f 1,7 > temp-1
linyong@fry /lab/solexa_page/linyong/mouse-genome$  cat gencode.vM31.primary_assembly.annotation.gtf | awk '$3 == "gene"' | cut -f 9 | awk 'BEGIN {FS = ";"; OFS = "\t"} {print $1, $2, $3}' > temp-2
paste temp-1 temp-2 > temp-3
cat temp-3 | awk '{print NF}' | uniq
5
mv temp-3  gencode.vM31.mouse-id-chr-name
cat  gencode.vM31.mouse-id-chr-name | cut -f 1 | sort | uniq -c

########################################################################
linyongmao@Linyong-Mao-MBP16-2019 autism % cat  mouse-mg-rnaseq-Thion.diff2-1.name-type-chr.humanname.txt   |  awk 'NR > 1' | sort -t ' ' +5 -6g | head -500 | awk 'BEGIN {FS = "\t";} $3 > 0 && $9 != "chrX" && $9 != "chrY" '  |  cut -f 13 | sort | uniq > temp-f-bias-mouse-mg-rnaseq-Thion.459genes.txt
     459 temp-f-bias-mouse-mg-rnaseq-Thion.459genes.txt
     305 temp-f-model.interac
cat temp-f-bias-mouse-mg-rnaseq-Thion.459genes.txt temp-f-model.interac | sort | uniq -d | wc
      28

 cat  mouse-mg-rnaseq-Thion.diff2-1.name-type-chr.humanname.txt   | awk 'BEGIN {FS = "\t";} $3 > 0 && $9 != "chrX" && $9 != "chrY" && $7 < 0.01' |  cut -f 13 | sort | uniq > temp-f-bias-mouse-mg-rnaseq-Thion.981genes.txt
cat temp-f-bias-mouse-mg-rnaseq-Thion.981genes.txt temp-f-model.interac | sort | uniq -d | wc
      40   
     37 chrM
   2645 chrX
   1594 chrY

#######################################################################
>  gs1$compare <- "MvF.noX.Y.interac.strand"

> f1="file:///Users/linyongmao/gsea_home/output/microgliaSex/mouse-mg-rnaseq-Thion.diff2-1.noXY.FvsM.h.all.v7.4.GseaPreranked.1715381458566/gsea_report_for_na_pos_1715381458566.tsv"
 gsea1 <- read.delim(f1)
 f1="file:///Users/linyongmao/gsea_home/output/microgliaSex/mouse-mg-rnaseq-Thion.diff2-1.noXY.FvsM.h.all.v7.4.GseaPreranked.1715381458566/gsea_report_for_na_neg_1715381458566.tsv"
 gsea2 <- read.delim(f1)
 gs2 <- rbind(gsea1,gsea2)
 gs2$compare <- "mouse-mg-rnaseq-Thion.FvsM"
 gs2$NES <- -gs2$NES

 gs3 <- merge(gs1, gs2, by.x="NAME", by.y="NAME")
 dim(gs3)
# [1] 49 25
 dim(gs1)
# [1] 49 13
 dim(gs2)
# [1] 50 13
 data.frame(1:25, colnames(gs3))
 gs4 <- gs3[, c(1,4,6,8,13,16,18,20,25)]
 head(gs4)
 plot(gs4$NES.y, gs4$NES.x, xlab = "mouse-mg-rnaseq-Thion.MvsF", ylab="human.MvF.noX.Y.interac.strand")
> gs4[ gs4$NES.x * gs4$NES.y < 0 & (gs4$FDR.q.val.x < 0.05 & gs4$FDR.q.val.y < 0.05),]
 dim(gs4[  gs4$NES.x < -1.8 & gs4$NES.y < -1.8,])
# [1] 7 9
 dim(gs4[  !gs4$NES.x < -1.8 & gs4$NES.y < -1.8,])
# [1] 4 9
 dim(gs4[  gs4$NES.x < -1.8 & !gs4$NES.y < -1.8,])
# [1] 22  9
 dim(gs4[  !gs4$NES.x < -1.8 & !gs4$NES.y < -1.8,])
# [1] 16  9
                     
                     f-bias-human       other-human-pathways
f-bias-path-mouse       7                    4
other-mouse-paths       22                  16->17
  fis <- matrix(c(7,4,22,17), nrow=2, ncol=2, byrow=T )
  fisher.test(fis)
p-value = 0.7412
odds ratio   1.344243

        Spearman's rank correlation rho
data:  gs4$NES.x and gs4$NES.y
S = 19636, p-value = 0.9902
         rho -0.001836735

################
> gs5 <- gs4[ gs4$NES.x < -1.8 & gs4$NES.y < -1.8,]
# 7 pathways
 gs6 <- gs5[, c(3,7)]
 rownames(gs6) <- gs5[, 1]
 gs7 <- as.data.frame( t(gs6))

 t1 <- read.delim("human-mg-rnaseq.f.bias.305genes.hallmark.overlap.txt")
 t2 <- read.delim("mouse-mg-rnaseq-Thion.f.bias.459genes.hallmark.overlap.txt")
 t3 <- merge(t1, t2, by.x="pathway", by.y="pathway")
 dim(t3)
# [1] 50 17
 t3[c(45,27),]
 t3$pathway <- gsub("../microglia/", "", t3$pathway)
 t3$pathway <- gsub(".genes$", "", t3$pathway)
 gs6$id <- rownames(gs6)
 t4 <- merge(gs6, t3, by.x="id", by.y="pathway")
 gs7 <- t4[ , c(2,3)]
 rownames(gs7) <- t4[, c(1)]
  gs8 <- as.data.frame( t(gs7))
 t5 <- data.frame(log10(t4$P.value.x), log10(t4$P.value.y))
 rownames(t5) <- t4$id
 t6 <- as.data.frame(t(t5))

> par( mar=c(6,2,2,16))
 barplot(as.matrix(gs8), horiz=T, beside=T, yaxt="n", xlim=c(-3,0), col=c("orange", "blue"), ylim=c(0,24), xlab="GSEA NES (M vs. F)")

 abline(v=0)
 abline(v = seq(-1000, 15, 0.5), lty = 5, lwd = 0.5, col = "gray")
 nam <- gsub("HALLMARK", "h", colnames(gs8))
 axis(side=4, at = seq(2, 20, by=3), labels=nam, las =1, cex.axis = 0.7)
 legend(-2.5, 24, c( "mouse", "human"), fill=c("blue", "orange"), cex = 0.7, inset = 0.05)

par( mar=c(6,2,2,12))
  barplot(as.matrix(t6), horiz=T, beside=T, yaxt="n", col=c("orange", "blue"), ylim=c(0,24), xlab="GO enrichment log10P (top F biased genes)", xlim=c(-56,0))
 axis(side=4, at = seq(2, 20, by=3), labels=nam, las =1, cex.axis = 0.7)
  abline(v = seq(-1000, 0, 5), lty = 5, lwd = 0.5, col = "gray")
 abline(v=0)
 legend(-40, 24, c( "mouse", "human"), fill=c("blue", "orange"), cex = 0.7, inset = 0.05)


#######################################################################
    459 temp-f-bias-mouse-mg-rnaseq-Thion.459genes.txt
    305 temp-f-model.interac

cat  human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt | awk 'NR > 1 && $8 != "chrX" && $8 != "chrY" '  | cut -f 7 | sort | uniq  > temp
cat  mouse-mg-rnaseq-Thion.diff2-1.name-type-chr.humanname.txt   |  awk 'NR > 1 && $9 != "chrX" && $9 != "chrY" ' | cut -f 13 | sort  | uniq  > temp1
wc -l temp temp1
   14586 temp
   11817 temp1
cat temp temp1  | sort | uniq -d > temp-3
    9980 temp-3
ls temp-f-model.interac > temp-4

bash ../Whitehead-main/script-inputset-pathways-overlap-fisher temp-f-bias-mouse-mg-rnaseq-Thion.459genes.txt  f-bias-mouse-mg-rnaseq-Thion.459genes  temp-4  temp-3
test.set        pathway input.overlap   input.notoverlap        noninput.overlap        noninput.nonoverlap     P.value log10P  oddsratio
f-bias-mouse-mg-rnaseq-Thion.459genes   temp-f-model.interac    28      294     240     9418    3.70029032520492e-08    7.43176419980113        3.73667041037106

cat temp temp1  | sort | uniq  > temp-3
   16423 temp-3
test.set        pathway input.overlap   input.notoverlap        noninput.overlap        noninput.nonoverlap     P.value log10P  oddsratio
f-bias-mouse-mg-rnaseq-Thion.459genes   temp-f-model.interac    28      431     277     15687   3.64613873298997e-08    7.43816681076998        3.67890702012615

linyongmao@Linyong-Mao-MBP16-2019 autism % ls ../microglia/HALL* | grep -v temp > temp-hall-files
 cp -i  temp1 temp-bg
wc -l temp-bg
   11817 temp-bg
bash ../Whitehead-main/script-inputset-pathways-overlap-fisher temp-f-bias-mouse-mg-rnaseq-Thion.459genes.txt  f-bias-mouse-mg-rnaseq-Thion.459genes temp-hall-files temp-bg > mouse-mg-rnaseq-Thion.f.bias.459genes.hallmark.overlap.txt

###
linyongmao@Linyong-Mao-MBP16-2019 autism % cat  mouse-mg-rnaseq-Thion.diff2-1.name-type-chr.humanname.txt   |  awk 'NR > 1' | sort -t $tab +5 -6g | head -500 | awk 'BEGIN {FS = "\t";} $3 < 0 && $9 != "chrX" && $9 != "chrY" '  |  cut -f 13 | sort | uniq > temp-strand
      23 temp-strand
 cat  mouse-mg-rnaseq-Thion.diff2-1.name-type-chr.humanname.txt   |  awk 'NR > 1' | sort -t $tab +5 -6g | head -1000 | awk 'BEGIN {FS = "\t";} $3 < 0 && $9 != "chrX" && $9 != "chrY" '  |  cut -f 13 | sort | uniq > temp-strand
     151 temp-strand

mv -i temp-strand temp-m-bias-mouse-mg-rnaseq-Thion.151genes.txt
bash ../Whitehead-main/script-inputset-pathways-overlap-fisher temp-m-bias-mouse-mg-rnaseq-Thion.151genes.txt m-bias-mouse-mg-rnaseq-Thion.151genes temp-hall-files temp-bg > mouse-mg-rnaseq-Thion.m.bias.151genes.hallmark.overlap.txt

########################pathway-genes corr between mouse and human
> t1 <- read.delim("human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt")
 t2 <- read.delim("mouse-mg-rnaseq-Thion.diff2-1.name-type-chr.humanname.txt")
 t3 <- merge(t1, t2, by.x="name", by.y="Gene.Symbol")
 dim(t2)
# [1] 12380    14
 length(t3$name)
# [1] 10475
 length(unique( t3$name))
# [1] 10304
 pg <- read.delim("../microglia/HALLMARK_INTERFERON_GAMMA_RESPONSE.genes", header=F)
 t4 <- t3[ t3$name %in% pg$V1,]
 dim(t4)
# [1] 172  23
 length(unique( t4$name))
# [1] 166
 length(( t4$name))
# [1] 172
data:  t4$logFC.x and -t4$logFC.y
t = 3.4487, df = 170, p-value = 0.0007102
      cor 0.2557107 
rho 0.2459734 

t4$pv1 <- log10(t4$PValue.x)
t4$pv2 <- log10(t4$PValue.y)
for (i in 1:dim(t4)[1])
{
## male bias, 
 if(t4$logFC.x[i] > 0)
   t4$pv1[i] <- -log10(t4$PValue.x[i])
## male bias, mouse RNA-seq, M 0, F 1
 if(t4$logFC.y[i] < 0)
   t4$pv2[i] <- -log10(t4$PValue.y[i])
}

data:  t4$pv1 and t4$pv2
t = 2.3735, df = 170, p-value = 0.01874
      cor 
0.1790961 
       rho 
0.09331131 

 t5 <- t4[ t4$logFC.x < -1 & t4$logFC.y >1 & t4$PValue.x < 0.05 & t4$PValue.y < 0.05, ]
 dim(t5)
# [1] 28 23
 t6 <- t4[ t4$logFC.x < -1 & t4$logFC.y < -1 & t4$PValue.x < 0.05 & t4$PValue.y < 0.05, ]
 dim(t6)
# [1]  1 25
 t7 <- t4[ t4$logFC.x > 1 & t4$logFC.y > 1 & t4$PValue.x < 0.05 & t4$PValue.y < 0.05, ]
  dim(t7)
# [1]  1 25
> ggplot(t4, aes(x=logFC.x, y=-logFC.y, label = name)) + geom_point(size=2, shape=21) + geom_hline(yintercept=0) + geom_vline(xintercept=0) + scale_y_continuous(breaks=seq(-10, 10, 2), ) + geom_text_repel(show.legend=T, data=t5 , size=2.2, max.overlaps=100, min.segment.length = 0.1, col="blue") + geom_text_repel(show.legend=T, data=t6 , size=2.2, max.overlaps=100, min.segment.length = 0.1, col="red") + geom_text_repel(show.legend=T, data=t7 , size=2.2, max.overlaps=100, min.segment.length = 0.1, col="red") + labs(x="human mg logFC (M vs. F)", y="mouse mg logFC (M vs. F)", title="HALLMARK_INTERFERON_GAMMA_RESPONSE pathway")

#########
 g1="HLA-A"
 t4[ t4$name == g1,]
 na <- t4[ t4$name == g1,]$name.x
 a.g[ a.g$name == na,]
 t5 <- a.g[ a.g$name == na,]
 boxplot(as.numeric( t5[,c(2:5)]) ~ info$sex, col=c("red", "cyan"), ylab = "cpm", main=na)
 abline(h = seq(0,10000,50), lty = 5, lwd = 0.5, col = "gray")

########
 length(t3$name)
# [1] 10475
for(i in 1:length(paths7)) {
 file <- paste("../microglia/", paths7[i], ".genes", sep="")
 pg <- read.delim(file, header=F)
 t4 <- t3[ t3$name %in% pg$V1,]
 dim(t4)
 t5 <- cor.test(t4$logFC.x , -t4$logFC.y)
 corRes <- paste(paths7[i], t5$estimate, t5$p.value, sep="\t")
 cat(corRes)
 cat("\n")

}
#######################################################################
cat /Users/linyongmao/Downloads/biosample_result-full-60samp.txt | grep "Accession:" | awk '{print $2}'  > temp-1

cat /Users/linyongmao/Downloads/biosample_result-full-60samp.txt | grep "^[0-9][0-9]*:" |awk 'BEGIN {OFS = "\t";} {print $2, $3}' > temp-2
paste temp-1  temp-2 >  /Users/linyongmao/Documents/autism/mouse-mg-rnaseq-Hanamsagar.metadata.txt

#######################################################################
linyong@fry /lab/solexa_page/linyong/dir-temp$ grep -iw actb SAMN*.same.counts_gene | grep -v ps1 |awk '{print $3}' |sort -g | uniq -c
     33 0
      9 1
      5 2
      5 3
      4 4
      1 5
      1 6
      1 8
      1 9
60 strand specific rna-seq samples

linyong@fry /lab/solexa_page/linyong/dir-temp$ grep -iw actb SAMN*.stranded.counts_gene | grep -v ps1 |awk '{print $3}' |sort -g
1427
2084
2105
...
12547
13052
14338
linyong@fry /lab/solexa_page/linyong$ bash script-paste-files-2 | awk '{print $1}' | sort | uniq -c
     59 __alignment_not_unique
     59 __ambiguous
     59 __no_feature
     59 __not_aligned
     59 __too_low_aQual
checked gene order identical in each gene_count file

#######################################################################
linyongmao@Linyong-Mao-MBP16-2019 autism % bash script-meta-data > temp    
linyongmao@Linyong-Mao-MBP16-2019 autism % vi temp
mv -i temp mouse-mg-rnaseq-Hanamsagar.metadata.2.txt
> meta <- read.delim("mouse-mg-rnaseq-Hanamsagar.metadata.2.txt")
 dim(meta[ meta$EorP == "E",])
# [1] 7 7
 dim(meta)
# [1] 60  7
 raw <- read.delim("mouse-mg-rnaseq-60samp-stranded-Hanamsagar.counts_gene")
 dim(raw)
# [1] 56980    62
 t2 <- meta[ meta$EorP != "E",]
 raw2 <- raw[ , colnames(raw) %in% t2$id]
 rownames(raw2) <- raw[, 1]
 dim(raw2)
# [1] 56980    53
 y <- DGEList(counts=raw2)
 y <- calcNormFactors(y)
 med <- data.frame(y$counts[,1])
 med$logic <- TRUE
 d <- cpm(y)
 for(i in 1:dim(y)[1]) {
  med$logic[i] <- median(d[i,]) >= 1
 }
 ####median >= 1 for pathway genes
 y<-y[med$logic,]
 print(dim(y))
# [1] 13688    53

y.cn <- colnames(y)
info.2 <- head(meta, n= dim(y)[2])
for(i in 1:dim(y)[2]) {
 t1 <- meta[ meta$id == y.cn[i],]
 info.2[i,] <- t1[1,]
 }
 identical(info.2$id, y.cn)

d = cpm(y)
a <- d
a.df <- as.data.frame(a)
a.df$id <- row.names(a.df)
 g <- raw[, c(1,2)]
a.df.g <- merge(a.df, g, by.x="id", by.y="geneID")
dim(a.df.g)

 p.exp <- a.df.g[ a.df.g$name %in% "Xist", ]
 length(p.exp$name)
 mat <- as.matrix(p.exp[, 2:54])
 res <- data.frame(id = colnames(mat), mean = colMeans(mat))
 identical(res$id, info.2$id)

 info.2$expr <- res$mean
 t3 <- info.2[ info.2$lps != "LPS",]
 dim(t3)
# [1] 40  8
gplot(t3, aes(x=age, y=expr, color=sex, group=sex)) + geom_point(size=2, shape=21) + geom_smooth(se=T) + labs(title=g, y="gene expression (CPM)", x="age (day)") + geom_smooth(aes(fill = sex))

 t4 <- info.2[ info.2$age == 60,]
 t4$sl <- paste(t4$sex, t4$lps, sep="_")
 t4$sl1 <- factor(t4$sl, levels=c("F_sal", "F_LPS", "M_sal", "M_LPS"))
 boxplot(t4$expr ~ t4$sl1,  outcol="white", main=g, col=c("orange", "orange", "purple", "purple"))
 beeswarm(t4$expr ~ t4$sl1, add=T)
 abline(h = seq(0, 1000, 5), lty = 5, lwd = 0.5, col = "grey")

 t5 <- t4[ t4$sl =="F_sal",]
 t6 <- t4[ t4$sl =="F_LPS",]
 wilcox.test(t5$expr, t6$expr)

#####################
d = cpm(y)
a <- log10(d+1)
a.df <- as.data.frame(a)
a.df[1:6,1:6]

 t1 <- as.data.frame(cor(a.df))
 dim(t1)
# [1] 53 53
for(i in 1:dim(t1)[1]) {
 t1[i, i] = NA
}
 t2 <-boxplot(t1, xlab="53 samples", ylab="Sample-S cor" )
 boxplot(t2$stats[3,], xlab="53 samples", ylab="median of Sample-S cor" )
 beeswarm(t2$stats[3,], add=T)
 abline(h = seq(0, 1000, 0.02), lty = 5, lwd = 0.5, col = "blue")

 identical(info.2$id, colnames(a.df))
 ll <- info.2[ info.2$lps == "LPS",]$id
 l2 <- a.df[, !(colnames(a.df) %in% ll)]
 dim(l2)
# [1] 13688    40

>  r3 <- t(a.df)
>  pca <- prcomp(r3, center = TRUE, scale. = TRUE)
 boxplot(pca$x[,1:20])
 s <- summary(pca)
 s$importance[,1:10]
 p1 <- as.data.frame( pca$x[,1:2])
 p1$id <- rownames(p1)
> identical(info.2$id, p1$id)
 info.2$pc1 <- p1$PC1
 info.2$pc2 <- p1$PC2
 info.2$ag.lp <- paste(info.2$age, info.2$lps, sep="_")
> t1 <- info.2[ info.2$id %in% c("SAMN07189885", "SAMN07189830"),]

> gplot(info.2, aes(x=pc1, y = pc2, color = sex, shape=as.factor( age), label=id)) + geom_point(size=3) + labs(y="PC2 (20.1%)", x="PC1 (22.6%)") + geom_text_repel(show.legend=F, data=t1 , size=4.0, max.overlaps=100, min.segment.length = 0.1, col="red")

######boxplot lat.pc.1, lat.pc.2
> info.2$donor <- "black"
 info.2[ info.2$id == "SAMN07189885",]$donor = "red"
 info.2[ info.2$id == "SAMN07189830",]$donor = "green"
 colnames(info.2)
 boxplot(info.2[, c(8,9)], outcol="white", xaxt="n")
 axis(1, at = seq(1, 2, by = 1), labels=c("latent.var.#1", "latent.var.#2"), las=1)
 beeswarm(info.2[, c(8,9)], pwcol=c(info.2$donor, info.2$donor), add=T, cex=2, pch=20)
 legend(0.5, 170, c("SAMN07189885", "SAMN07189830"), pch=c(20), col=c("red", "green"))

################################
>  t1 <- as.data.frame(cor(a.df))

 col_fun = colorRamp2(c(0.7,0.85,1), c( "blue", "white",  "red"))
 info.2$age_ <- factor(info.2$age)
 ca <- HeatmapAnnotation( sex = info.2$sex, which="row",  age = info.2$age_, LPS=info.2$lps )
 Heatmap(t1, name = "correlation",   right_annotation=ca, row_dend_width=unit(15, "mm"), row_names_gp = gpar(fontsize = 6), column_names_gp=gpar(fontsize = 6), col = col_fun,)

 t1 <- as.data.frame(cor(a.df))
 info.3 <- info.2[ info.2$lps !=  "LPS",]
t2 <- t1[ rownames(t1) %in% info.3$id, colnames(t1) %in% info.3$id,]
 dim(t2)
#[1] 40 40
 identical(rownames(t2), info.3$id)
 identical(colnames(t2), info.3$id)
 col_fun = colorRamp2(c(0.7,0.9,1), c( "blue", "white",  "red"))
 col.sex <- c("blue", "red")
 names(col.sex) <- c("M", "F")
 col.lps <- c("white", "black")
 names(col.lps) <- c("sal", "LPS")
 col.age <- colorRamp2(c(4,14,60), c("blue","yellow", "red"))
 ca <- HeatmapAnnotation( sex = info.3$sex, which="row",  age = info.3$age, lps = info.3$lps, col=list(sex = col.sex, age = col.age, lps=col.lps) )
 Heatmap(t2, name = "correlation",   right_annotation=ca, row_dend_width=unit(15, "mm"), row_names_gp = gpar(fontsize = 6), column_names_gp=gpar(fontsize = 6), col = col_fun,)

> ca2 <-  HeatmapAnnotation( sex = info.2$sex, which="column",  age = info.2$age,  col=list(sex = col.sex, age = col.age) )

####################################
> t2 <- meta[ meta$EorP != "E" & meta$lps != "LPS",]


+  a[i, ] <- (b[i, ] - mean(as.numeric(b[i,]))) / var(as.numeric(b[i,]))^(1/2)
+ }
> a.df <- as.data.frame(a)
[1] 13862 genes;   40
> a.df$id <- row.names(a.df)
 a.df$id2 <-  gsub("\\.[0-9][0-9]*", "", a.df$id)
t6 <- read.delim("../microglia-mouse/Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip")
 dim(t6)
# [1] 19341     3
 a.df.g <- merge(a.df, t6, by.x="id2", by.y="ID")
 dim(a.df.g)
# [1] 12750    44
 file <- "../microglia/HALLMARK_INTERFERON_GAMMA_RESPONSE.genes"
 p <- read.delim(file, header=F)
 p.exp <- a.df.g[ a.df.g$Gene.Symbol %in% p$V1, ]
 length(p.exp$Gene.Symbol)
# [1] 184 INTERFERON_GAMMA genes in mouse mg
 mat <- as.matrix(p.exp[, 2:41])
 res <- data.frame(id = colnames(mat), mean = colMeans(mat))
 identical(res$id, info.2$id)
# [1] TRUE
 info.2$expr <- res$mean
 t3 <- info.2
 dim(t3)
# [1] 40  8
 g <- gsub(".*/","", file)
 ggplot(t3, aes(x=age, y=expr, color=sex, group=sex)) + geom_point(size=2, shape=21) + geom_smooth(se=T) + labs(title=g, y="pathway Z-score", x="age (day)") + geom_smooth(aes(fill = sex))
 t.test(t3[ t3$sex=="F" & t3$age == 60,]$expr, t3[ t3$sex=="M" & t3$age == 60,]$expr)
 wilcox.test(t3[ t3$sex=="F" & t3$age == 60,]$expr, t3[ t3$sex=="M" & t3$age == 60,]$expr)

#########################################
# P60 M vs. F
> t2 <- meta[ meta$EorP != "E" & meta$age == 60 & meta$lps != "LPS",]
+   med$logic[i] <- median(d[i,]) >= 1
[1] 13461    12

>  t6 <- read.delim("../microglia-mouse/Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip")
13461 expressed mouse genes -> 12348 human genes (0.9173167)
>  t9 <- t8[ t8$chr != "chrX" & t8$chr != "chrY", c(1,3:7,2,13)]
>  dim(t9)
[1] 11934     8

##################
linyongmao@Linyong-Mao-MBP16-2019 autism % cat temp-s
#
cat mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.noXY.rnk  | sort -t '	' +1 -2g | head  -500 | awk '$2 < -1.3010' | cut -f 1 > temp-f-bias
 bash ../Whitehead-main/script-inputset-pathways-overlap-fisher temp-f-bias 40samp3ages-f-bias temp-hall-files mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.noXY.rnk  |  awk '$7 < 0.005 && $9 > 1' | sed 's#../microglia/##' | cut -f 1-7,9

echo
echo
echo

cat mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.noXY.rnk  | sort -t '	' +1 -2gr | head  -500 | awk '$2 > 1.3010' | cut -f 1 > temp-m-bias
 bash ../Whitehead-main/script-inputset-pathways-overlap-fisher temp-m-bias 40samp3ages-m-bias temp-hall-files mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.noXY.rnk  |  awk '$7 < 0.005 && $9 > 1' | sed 's#../microglia/##' | cut -f 1-7,9

#######################################################################
linyongmao@Linyong-Mao-MBP16-2019 microglia % cat GOBP_OXIDATIVE_PHOSPHORYLATION.v2023.2.Hs.gmt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print  $i}'  | awk 'NR > 2' > GOBP_OXIDATIVE_PHOSPHORYLATION.genes
     148 GOBP_OXIDATIVE_PHOSPHORYLATION.genes
cat  KEGG_ALLOGRAFT_REJECTION.v2023.2.Hs.gmt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print  $i}'  | awk 'NR > 2' >  KEGG_ALLOGRAFT_REJECTION.genes
      37 KEGG_ALLOGRAFT_REJECTION.genes
cat  KEGG_OXIDATIVE_PHOSPHORYLATION.v2023.2.Hs.gmt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print  $i}'  | awk 'NR > 2' >  KEGG_OXIDATIVE_PHOSPHORYLATION.genes
     132 KEGG_OXIDATIVE_PHOSPHORYLATION.genes
cat ../dir-GTExV8/fao.gmt | grep -i fao | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print  $i}'  | awk 'NR > 2' >  FAO.genes

     158 HALLMARK_FATTY_ACID_METABOLISM.genes
cat ../dir-GTExV8/fao.gmt | grep -i GOBP_FATTY_ACID_BIOSYNTHETIC_PROCESS  | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print  $i}'  | awk 'NR > 2' >  GOBP_FATTY_ACID_BIOSYNTHETIC_PROCESS.genes
     168 GOBP_FATTY_ACID_BIOSYNTHETIC_PROCESS.genes


cat  GOBP_OXIDATIVE_PHOSPHORYLATION.v2023.2.Hs.gmt > to-be-tested-geneset.gmt
echo >> to-be-tested-geneset.gmt
cat   KEGG_OXIDATIVE_PHOSPHORYLATION.v2023.2.Hs.gmt >> to-be-tested-geneset.gmt
echo >> to-be-tested-geneset.gmt
cat  KEGG_ALLOGRAFT_REJECTION.v2023.2.Hs.gmt  >> to-be-tested-geneset.gmt
echo >> to-be-tested-geneset.gmt
cat ../dir-GTExV8/fao.gmt | grep -i fao >> to-be-tested-geneset.gmt
cat ../dir-GTExV8/fao.gmt | grep -i GOBP_FATTY_ACID_BIOSYNTHETIC_PROCESS  >> to-be-tested-geneset.gmt
cat ../dir-GTExV8/fao.gmt | grep -i fatty_acid_meta >> to-be-tested-geneset.gmt 
cat ../dir-GTExV8/fao.gmt | grep -i allograft >> to-be-tested-geneset.gmt
cat ../dir-GTExV8/fao.gmt | grep -i oxidative  >> to-be-tested-geneset.gmt

##############################################################
> f <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.noXY-weight0-hallmark.GseaPreranked.1717816582258/gsea_report_for_na_neg_1717816582258.tsv")

 t1 <- f[ f$FDR.q.val < 0.01,]
 t2 <- t1[, c(1,6)]
 t3 <- data.frame(t2$NES)
 rownames(t3) <- t2$NAME
 l <- order(-t3$t2.NES)
 t4 <- data.frame(NES = t3[l,])
 rownames(t4) <- rownames(t3)[l]
 gs8 <- as.data.frame( t(t4))
 par( mar=c(6,2,2,16))
 barplot(as.matrix(gs8), horiz=T, beside=T, yaxt="n",   xlab="GSEA NES (M vs. F)", col="orange")
  nam <- gsub("HALLMARK", "h", colnames(gs8))
  axis(side=4, at = seq(1.5, 1.5+2*6, by=2), labels=nam, las =1, cex.axis = 0.7)
  abline(v = seq(-1000, 15, 1), lty = 5, lwd = 0.5, col = "gray")

> f1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/mouse-mg-rnaseq-Hanamsagar.P4.MvF-diff2-1.resid.pc1-pc2-covar.name-type-chr.humanname.noXY-weight0-hallmark.GseaPreranked.1718115710217/gsea_report_for_na_pos_1718115710217.tsv")
 f2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/mouse-mg-rnaseq-Hanamsagar.P4.MvF-diff2-1.resid.pc1-pc2-covar.name-type-chr.humanname.noXY-weight0-hallmark.GseaPreranked.1718115710217/gsea_report_for_na_neg_1718115710217.tsv")
 t1 <- rbind(f1, f2)
 t2 <- t1[, c(1,6, 8)]
 f1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/mouse-mg-rnaseq-Hanamsagar.P14.MvF-diff2-1.resid.pc1-pc2-covar.name-type-chr.humanname.noXY-weight0-hallmark.GseaPreranked.1717969422447/gsea_report_for_na_pos_1717969422447.tsv")
 f2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/mouse-mg-rnaseq-Hanamsagar.P14.MvF-diff2-1.resid.pc1-pc2-covar.name-type-chr.humanname.noXY-weight0-hallmark.GseaPreranked.1717969422447/gsea_report_for_na_neg_1717969422447.tsv")
 t1 <- rbind(f1[, 1:11], f2)
 t.p14 <- t1[, c(1,6, 8)]

 f1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/mouse-mg-rnaseq-Hanamsagar.P60.MvF-diff2-1.resid.pc1-pc2-covar.name-type-chr.humanname.noXY-weight0-hallmark.GseaPreranked.1717881403611/gsea_report_for_na_pos_1717881403611.tsv")
 f2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/mouse-mg-rnaseq-Hanamsagar.P60.MvF-diff2-1.resid.pc1-pc2-covar.name-type-chr.humanname.noXY-weight0-hallmark.GseaPreranked.1717881403611/gsea_report_for_na_neg_1717881403611.tsv")
 t1 <- rbind(f1, f2)
 t.p60 <- t1[, c(1,6, 8)]

 t3 <- merge(t2, t.p14, by.x="NAME", by.y="NAME")
 t4 <- merge(t3, t.p60, by.x="NAME", by.y="NAME")
 t5 <- t4[ 1:dim(t4.3ages)[1],]

for(i in 1:dim(t4.3ages)[1]) {
 l <- t4[ t4$NAME == rownames(t4.3ages)[i],]
 t5[i,] <- l[1,]
 }

 t6 <- t5[ , c(2,4,6)]
 rownames(t6) <- t5$NAME
 t6.1 <- t6[, c(3,2,1)]
  gs1 <- as.data.frame( t(t6.1))
 barplot(as.matrix(gs1), horiz=T, beside=T, yaxt="n",   xlab="GSEA NES (M vs. F)", col=c("blue", "orange", "green"), xlim=c(-7, 7))
 nam <- gsub("HALLMARK", "h", colnames(gs1))
 axis(side=4, at = seq(2.5, 2.5+4*6, by=4), labels=nam, las =1, cex.axis = 0.9)
 legend(-6, 2.5+4*2+2, c( "P4", "P14", "P60"), fill=c("green", "orange", "blue"), cex = 0.7, inset = 0.05)
  abline(v = seq(-10, 10, 1), lty = 5, lwd = 0.5, col = "gray")

############
 f1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.noXY-weight0-hallmark.GseaPreranked.1717816582258/gsea_report_for_na_pos_1717816582258.tsv")
 f2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.noXY-weight0-hallmark.GseaPreranked.1717816582258/gsea_report_for_na_neg_1717816582258.tsv")
 t1 <- rbind(f1, f2)
 t2 <- t1[, c(1,6, 8)]
 t.p4.p14.p60.3ages <-  merge(t4, t2, by.x="NAME", by.y="NAME")
 colnames(t.p4.p14.p60.3ages) <- c("NAME", "P4.NES", "P4.FDR", "P14.NES", "P14.FDR", "P60.NES", "P60.FDR", "P.3ages.NES", "P.3ages.FDR")

 f1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF.noX.Y.interac.strand.prerank.v7.4.GseaPreranked.1692378724023/gsea_report_for_na_pos_1692378724023.tsv")
 f2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF.noX.Y.interac.strand.prerank.v7.4.GseaPreranked.1692378724023/gsea_report_for_na_neg_1692378724023.tsv")
  t1 <- rbind(f1, f2)
  t2 <- t1[, c(1,6, 8)]
 t5 <- merge(t.p4.p14.p60.3ages, t2, by.x="NAME", by.y="NAME")

 f1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF.noX.Y.strand.prerank.v7.4.GseaPreranked.1692381192086/gsea_report_for_na_pos_1692381192086.tsv")
 f2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF.noX.Y.strand.prerank.v7.4.GseaPreranked.1692381192086/gsea_report_for_na_neg_1692381192086.tsv")
  t1 <- rbind(f1, f2)
   t2 <- t1[, c(1,6, 8)]
 t6 <- merge(t5, t2, by.x="NAME", by.y="NAME")
 colnames(t6)[10:13] <- c("human.interact.NES", "human.interact.FDR", "human.no-interact.NES", "human.no-interact.FDR")

 t7 <- t6[, c(2,4,6,8,10,12)]
#      P4.NES    P14.NES   P60.NES P.3ages.NES human.interact.NES human.no-interact.NES
 cor(t7, method="spearman")

 f1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand-weight0-hallmark.GseaPreranked.1718816546930/gsea_report_for_na_pos_1718816546930.tsv")
 f2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand-weight0-hallmark.GseaPreranked.1718816546930/gsea_report_for_na_neg_1718816546930.tsv")
t1 <- rbind(f1, f2)
   t2 <- t1[, c(1,6, 8)]
dim(t2)
t8 <- merge(t6, t2, by.x="NAME", by.y="NAME")
head(t8)

 f1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.no-interac.strand-weight0-hallmark.GseaPreranked.1718816589477/gsea_report_for_na_pos_1718816589477.tsv")
f2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.no-interac.strand-weight0-hallmark.GseaPreranked.1718816589477/gsea_report_for_na_neg_1718816589477.tsv")
t1 <- rbind(f1, f2)
   t2 <- t1[, c(1,6, 8)]
dim(t2)
t9 <- merge(t8, t2, by.x="NAME", by.y="NAME")
head(t9)
colnames(t9)[14:17] <- c("human.inter-GSEAwt0.NES", "human.inter-GSEAwt0.FDR", "human.no-inter-GSEAwt0.NES", "human.no-inter-GSEAwt0.FDR")
t10 <- t9[, c(2,4,6,8,10,12,14,16)]
cor(t10, method="spearman")

###p4, p14, p60, 3ages, human, combined NES, FDR
> write.table(t9, "temp-t9-jun19.txt", sep="\t", quote=F)

#################################################human mg
"human_Microglia_RNA-18samp.gene.count.stranded.txt"
> dim(y)
[1] 15089    13

info <- read.delim("human.postnatal.18samp.info")
info.2 <- info[1:13,]
cna <- gsub("human_Microglia_RNA_polyA_", "", colnames(y))
for(i in 1:13) {
 info.2[i,] = info[ info$Patient.ID == cna[i], ]
 }
identical(info.2$Patient.ID, cna)
> design <- model.matrix(~info.2$Sex + info.2$Age + info.2$Sex : info.2$Age)
> des <- as.data.frame(design)
d = cpm(y)
a <- log10(d+1)
a.df <- as.data.frame(a)
a.df[1:6,1:6]
 identical(info.2$Patient.ID, gsub("human_Microglia_RNA_polyA_", "", colnames(a.df)))
t1 <- data.frame(id = rownames(a.df), var = a.df[,1])

t1$sex.cor = -999
for(i in 1:dim(a.df)[1])
{
  d1 <-  data.frame(y = t(a.df[i,]), sex =  des$"info.2$SexM:info.2$Age" )
  d2 <-  lm(d1[,1] ~ d1$sex)
  d3 <- summary(d2)
  t1$sex.cor[i] = d3$r.squared
}

 summary(t1$sex.cor)
#######################################################################
f1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand-weight0-hallmark.GseaPreranked.1718816546930/gsea_report_for_na_pos_1718816546930.tsv")
 f2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand-weight0-hallmark.GseaPreranked.1718816546930/gsea_report_for_na_neg_1718816546930.tsv")
t1 <- rbind(f1, f2)
   t2 <- t1[, c(1,6, 8)]
dim(t2)

 f1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.no-interac.strand-weight0-hallmark.GseaPreranked.1718816589477/gsea_report_for_na_pos_1718816589477.tsv")
f2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.no-interac.strand-weight0-hallmark.GseaPreranked.1718816589477/gsea_report_for_na_neg_1718816589477.tsv")
t3 <- rbind(f1, f2)
   t4 <- t3[, c(1,6, 8)]
dim(t4)
######
> nes.act.no <- merge(t2, t4, by.x="NAME", by.y="NAME")
 d1 <- cor.test(nes.act.no$NES.y, nes.act.no$NES.x)
 str <- paste("Pearson r=", round(d1$estimate, digits = 3), ", p=", format(d1$p.value, digits=3), sep ="")
 str
 plot(nes.act.no$NES.y, nes.act.no$NES.x, xlab="GSEA NES (model 1, M vs. F)", ylab="GSEA NES (model 2, M vs. F)")
 abline(lm(nes.act.no$NES.x ~ nes.act.no$NES.y))
   abline(v = seq(-10, 10, 2), lty = 5, lwd = 0.5, col = "gray")
 abline(h = seq(-10, 10, 2), lty = 5, lwd = 0.5, col = "gray")
 text(-5.5,0, str, col="blue")

> dim(nes.act.no[ nes.act.no$NES.x < -3 & nes.act.no$NES.y < -3 & nes.act.no$FDR.q.val.x < 0.01 & nes.act.no$FDR.q.val.y < 0.01,])
[1] 17  5
 t1 <- nes.act.no[ nes.act.no$NES.x < -3 & nes.act.no$NES.y < -3 & nes.act.no$FDR.q.val.x < 0.01 & nes.act.no$FDR.q.val.y < 0.01,]
 gs7 <- t1[ , c(2,4)]
  rownames(gs7) <- t1[, c(1)]
 d <- order(-gs7$NES.x)
 gs8 <- as.data.frame( t(gs7[d,]))
 par( mar=c(6,2,2,16))
 barplot(as.matrix(gs8), horiz=T, beside=T, yaxt="n",  col=c("orange", "blue"),  xlab="GSEA NES (M vs. F)")
 abline(v=0)
  nam <- gsub("HALLMARK", "h", colnames(gs8))
  axis(side=4, at = seq(2, 2+16*3, by=3), labels=nam, las =1, cex.axis = 0.7)
  legend(-8, 12, c( "model 1", "model 2"), fill=c("blue", "orange"), cex = 0.7, inset = 0.05)

#######################################################################
linyongmao@Linyong-Mao-MBP16-2019 autism % cat human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt | awk '$8 == "chrM" ' |cut -f 7,8  | wc
      19      38     230
   14586 human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk
cat human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 > 0' | wc -l
    6762
cat human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 < 0' | wc -l
    7824
cat human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk |grep "^MT-" | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 > 0' | wc -l
       2
cat human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk |grep "^MT-" | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 < 0' | wc -l
      17

dhyper(x, m, n, k, log = FALSE)
x, q	
vector of quantiles representing the number of white balls drawn without replacement from an urn which contains both black and white balls.

m	
the number of white balls in the urn.

n	
the number of black balls in the urn.

k	
the number of balls drawn from the urn, hence must be in 0,1,, m+n.

x=17
m=7824
n=6762
k=19
# hypergeometric hyperg fisher
sum(dhyper(x:k, m, n, k))
[1] 0.001046018

fisher
        Fbia  Mbia
MT-ge    17   2
non MT   7824-17  6762-2
> a=17
 b=2
 c=7824-17
 d=6762-2
fis <- matrix(c(a,b,c,d), nrow=2, ncol=2, byrow=T )
fis
 fisher.test(fis) 
p-value = 0.001836
odds ratio   7.359304 

###################
> t1 <- read.delim("human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt")
 t2 <- t1[ t1$chr == "chrM",]
 t3 <- t2[ t2$PValue < 0.1,]
> gplot(t2, aes(x=logFC, y=-log10(PValue), label=name)) + geom_point(size=1.5, shape=21) +geom_text_repel(show.legend=F, data=t3, size=2.2, max.overlaps=100, min.segment.length = 0.1) +  geom_hline(yintercept=0, col="blue") + geom_vline(xintercept=0, col="blue") + labs(x="logFC (M vs. F)")

t1 <- read.delim("mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.txt")
 dim(t1[ t1$chr == "chrM",])
# [1] 12 14
 t2 <- t1[ t1$chr == "chrM",]
 t3 <- t2[ t2$PValue < 0.1,]

label=name.x

> t2$type
 [1] "Mt_rRNA"        "Mt_rRNA"        "protein_coding" "Mt_tRNA"        "protein_coding" "Mt_tRNA"        "protein_coding" "protein_coding" "protein_coding" "protein_coding" "protein_coding" "Mt_tRNA"

########################################
t6: mouse, t2: human
> t8 <- merge(t6, t2, by.x="NAME", by.y="NAME")
> head(t8)
                          NAME     NES.x  FDR.q.val.x      NES.y  FDR.q.val.y
1        HALLMARK_ADIPOGENESIS -1.995551 0.0178291480 -4.5545583 0.0000000000
2 HALLMARK_ALLOGRAFT_REJECTION -2.663592 0.0002631579 -5.5502653 0.0000000000

> t8$nam <- gsub("HALLMARK", "h", t8$NAME)
> t3 <- t8[ t8$FDR.q.val.x < 0.01 & t8$FDR.q.val.y < 0.01 & t8$NES.x * t8$NES.y > 0,]
> gplot(t8, aes(x= NES.x, y= NES.y, label = nam)) + geom_point(size=2, shape=21) + geom_smooth(se=T, method="lm") +  geom_text_repel(show.legend=T, data=t3 , size=2, max.overlaps=100, min.segment.length = 0.1, col="red") + labs(x="mouse NES (M vs. F)", y="human NES (M vs. F)")

#######################################################################
> t1 <- read.delim("human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk", header=F)
t2 <- read.delim("mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.noXY.rnk", header=F)
 t3 <- merge(t1, t2, by.x="V1", by.y="V1")
 dim(t3)
# [1] 10021     3
 dim(t1)
# [1] 14586     2
 dim(t2)
# [1] 12171     2
	Pearson's product-moment correlation
data:  t3$V2.x and t3$V2.y
t = 30.294, df = 10019, p-value < 2.2e-16
      cor 
0.2896781 

	Spearman's rank correlation rho
S = 1.1552e+11, p-value < 2.2e-16
      rho 0.3112167 , p.value= 5.932117e-224

 t4 <- t3[ abs( t3$V2.x) > -log10(0.05) | abs( t3$V2.y) > -log10(0.05),]
 dim(t4)
# [1] 2844    3
file <- "../microglia/HALLMARK_OXIDATIVE_PHOSPHORYLATION.genes"
 p <- read.delim(file, header=F)
 t4 <- t3[ t3$V1 %in% p$V1,]

Spearman's rank correlation rho
data:  t4$V2.x and t4$V2.y
S = 704002, p-value = 4.185e-06
      rho = 0.3328513 

 dim(t4)
# [1] 185   3
> dim(t4[t4$V2.x < log10(0.05) & t4$V2.y < log10(0.05),])
[1] 19  3
> dim(t4[t4$V2.x < log10(0.05) ,])
[1] 83  3
> dim(t4[t4$V2.y < log10(0.05) ,])
[1] 27  3
> x= 19
> m=83
> n= 185 - 83
> k= 27
> sum(dhyper(x:k, m, n, k))
[1] 0.003677595
> x= 19
> m=27
> n= 185 - 27
> k= 83
> sum(dhyper(x:k, m, n, k))
[1] 0.003677595

######
> file <- "../microglia/HALLMARK_ALLOGRAFT_REJECTION.genes"
......
> dim(t4)
[1] 120   3
> dim(t4[t4$V2.x < log10(0.05) & t4$V2.y < log10(0.05),])
[1] 7 3
> dim(t4[t4$V2.x < log10(0.05) ,])
[1] 45  3
> dim(t4[t4$V2.y < log10(0.05) ,])
[1] 13  3
> x=7
> m=45
> n=120-45
> k=13
>  sum(dhyper(x:k, m, n, k))
[1] 0.1619061

> 13*45/120
[1] 4.875
> cor.test(t4$V2.x, t4$V2.y, method="s")
S = 188630, p-value = 0.0001251
      rho 0.3449892 

#########################################
t6: mouse, t2: human
> t8 <- merge(t6, t2, by.x="NAME", by.y="NAME")
> head(t8)
                          NAME     NES.x  FDR.q.val.x      NES.y  FDR.q.val.y
1        HALLMARK_ADIPOGENESIS -1.995551 0.0178291480 -4.5545583 0.0000000000
2 HALLMARK_ALLOGRAFT_REJECTION -2.663592 0.0002631579 -5.5502653 0.0000000000

> t8$nam <- gsub("HALLMARK", "h", t8$NAME) 
t3 <- t8[ c(2,17,26,27, 31,32,36),]
 d <- cor.test(t8$NES.x, t8$NES.y)
 t4 <- t3[1,]
 t4$NES.x = -6
 t4$NES.y = 0
 str <- paste("Pearson r= ", round(d$estimate, digits=3), ", p=", format(d$p.value, digits=3), sep="" )
 t4$nam <- str

> gplot(t8, aes(x= NES.x, y= NES.y, label = nam)) + geom_point(size=2, shape=21) + geom_smooth(se=T, method="lm") +  geom_text_repel(show.legend=T, data=t3 , size=3, max.overlaps=100, min.segment.length = 0.1, col="red") + labs(x="mouse P14 NES (M vs. F)", y="human NES (M vs. F)") + geom_text(data=t4, size=4, hjust=-0.3)

################################pathway genes with pvalue < 0.05, F biased
 t2 <- read.delim("mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.noXY.rnk", header=F)
 t3 <- t2
 file <- "../microglia/HALLMARK_OXIDATIVE_PHOSPHORYLATION.genes"
 p <- read.delim(file, header=F)
 t4 <- t3[ t3$V1 %in% p$V1,]
 dim(t4)
 genes <- (t4[t4$V2 < log10(0.05) ,])$V1
 dim(t4[t4$V2 < log10(0.05) ,])

 p.exp <- a.df.g[ a.df.g$Gene.Symbol %in% genes, ]
 length(p.exp$Gene.Symbol)
mat <- as.matrix(p.exp[, 3:42])
 res <- data.frame(id = colnames(mat), mean = colMeans(mat))
 identical(res$id, info.2$id)
# [1] TRUE
 info.2$expr <- res$mean
 t3 <- info.2
 dim(t3)
# [1] 40  8
 g <- gsub(".*/","", file)
 summary(t3$expr)
 gplot(t3, aes(x=age, y=expr, color=sex, group=sex)) + geom_point(size=3, shape=21) + geom_smooth(se=F) + labs(title=g, y="pathway Z-score", x="age (day)") ## + geom_smooth(aes(fill = sex))

#######################################################################
> t1 <- read.delim("HD-control-snRNA-mg.txt")
 dim(t1)
# [1] 13298     6
  t2 <- t1[ t1$FDR < 0.001 & abs( t1$summary.logFC) > (0.1), ]
 dim(t2)
# [1] 860   6
# > write.table(t2,"HD-control-snRNA-mg.deg.txt", sep="\t", quote=F)

linyongmao@Linyong-Mao-MBP16-2019 autism % cat temp-s-HD
#
cat HD-control-snRNA-mg.deg.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 < 0' | awk '$5 < -0.1' | cut -f 1  | awk 'NR > 1' | sort | uniq > Ctrl-UP.vs.HD
cat HD-control-snRNA-mg.deg.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 > 0' | awk '$5 > 0.1'  | cut -f 1  | awk 'NR > 1' | sort | uniq > HD-UP.vs.Ctrl

ls Ctrl-UP.vs.HD HD-UP.vs.Ctrl > temp-f1

tab="   "
cat  human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk | sort -t "$tab"  +1 -2g | head  -500 | awk '$2 < -1.3010' | cut -f 1 > temp-f-bias
cat  human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk | sort -t "$tab"  +1 -2gr | head  -500 | awk '$2 > 1.3010' | cut -f 1 > temp-m-bias
cut -f 1 human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk | sort | uniq > temp-1
cut -f 1 HD-control-snRNA-mg.txt | awk 'NR > 1' | sort | uniq > temp-2
cat temp-1 temp-2 | sort | uniq -d > temp-bg-genes

 bash   script-inputset-pathways-overlap-fisher-fdr   temp-f-bias human-mg-f-bias.interact   temp-f1   temp-bg-genes

echo
echo
echo

bash   script-inputset-pathways-overlap-fisher-fdr  temp-m-bias human-mg-m-bias.interact temp-f1   temp-bg-genes

#################################################################################
linyongmao@Linyong-Mao-MBP16-2019 autism % cat  script-HD-UP.vs.Ctrl-hallmark-fisher
#
cat HD-control-snRNA-mg.deg.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 < 0' | awk '$5 < -0.1' | cut -f 1  | awk 'NR > 1' | sort | uniq > Ctrl-UP.vs.HD
cat HD-control-snRNA-mg.deg.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 > 0' | awk '$5 > 0.1'  | cut -f 1  | awk 'NR > 1' | sort | uniq > HD-UP.vs.Ctrl

ls ../microglia/HALLMARK*  | grep -v temp | wc -l
ls ../microglia/HALLMARK*  | grep -v temp > temp-f1 

tab="	"
cut -f 1 HD-control-snRNA-mg.txt | awk 'NR > 1' | sort | uniq > temp-bg-genes
wc -l temp-bg-genes

bash   script-inputset-pathways-overlap-fisher-fdr   Ctrl-UP.vs.HD Ctrl-UP.vs.HD temp-f1 temp-bg-genes
echo
echo
echo

bash   script-inputset-pathways-overlap-fisher-fdr   HD-UP.vs.Ctrl HD-UP.vs.Ctrl temp-f1 temp-bg-genes

#######################################################################################
###temp1 temp2 two files
linyongmao@Linyong-Mao-MBP16-2019 autism % bash script-HD-UP.vs.Ctrl-hallmark-fisher    
 t1 <- read.delim("temp1")
 t1$pathway <- gsub("../microglia/", "", t1$pathway)
 head(t1)
 t2 <- read.delim("temp2")
 t2$pathway <- gsub("../microglia/", "", t2$pathway)
 head(t2)
 t3 <- merge(t1, t2, by.x="pathway", by.y="pathway")
 dim(t3)
 t4 <- t3[ t3$fdr.x < 0.01 | t3$fdr.y < 0.01,c(1,2,8,9,10,16,17)]
# > t4
#                                     pathway    test.set.x oddsratio.x        fdr.x    test.set.y oddsratio.y        fdr.y
# 2        HALLMARK_ALLOGRAFT_REJECTION.genes Ctrl-UP.vs.HD    7.930838 5.882812e-10 HD-UP.vs.Ctrl    1.366706 0.7571699322
 t4$logFDR.x <- 999
 t4$logFDR.y <- 999
for(i in 1:dim(t4)[1]) {
 t4$logFDR.x[i] <- -log10(t4$fdr.x[i])
 t4$logFDR.y[i] <- -log10(t4$fdr.y[i])
 if(t4$oddsratio.x[i] < 1) ###depleted
   t4$logFDR.x[i] <- log10(t4$fdr.x[i])
 if(t4$oddsratio.y[i] < 1) ###depleted
   t4$logFDR.y[i] <- log10(t4$fdr.y[i])

}

 t5 <- data.frame(t4$logFDR.x, t4$logFDR.y)
 rownames(t5) <- gsub("HALLMARK", "h", t4$pathway)
 colnames(t5) <- c("Ctrl-UP", "HD-UP")
 gs7 <- t5
 d <- order(gs7$"Ctrl-UP")
 gs8 <- as.data.frame( t(gs7[d,]))
  par( mar=c(6,16,2,2))
  barplot(as.matrix(gs8), horiz=T, beside=T, yaxt="n",  col=c("orange", "blue"),  xlab="-log10(FDR)")
  nam <- gsub("HALLMARK", "h", colnames(gs8))
 axis(side=2, at = seq(2, 2+6*3, by=3), labels=nam, las =1, cex.axis = 0.8)
 abline(v = seq(-10, 10, 2), lty = 5, lwd = 0.5, col = "gray")
 legend(4, 9, c( "HD Up genes", "Ctrl Up genes"), fill=c("blue", "orange"), cex = 0.7, inset = 0.05)

> t5 <- data.frame(t4$oddsratio.x, t4$oddsratio.y)
 rownames(t5) <- gsub("HALLMARK", "h", t4$pathway)
 colnames(t5) <- c("Ctrl-UP", "HD-UP")
 gs7 <- t5
### d from previous order
 gs8 <- as.data.frame( t(gs7[d,]))
 par( mar=c(6,16,2,2))
   barplot(as.matrix(gs8), horiz=T, beside=T, yaxt="n",  col=c("orange", "blue"),  xlab="odds ratio")
   nam <- gsub("HALLMARK", "h", colnames(gs8))
  axis(side=2, at = seq(2, 2+6*3, by=3), labels=nam, las =1, cex.axis = 0.8)
  abline(v = seq(-10, 10, 1), lty = 5, lwd = 0.5, col = "gray")
  legend(4, 9, c( "HD Up genes", "Ctrl Up genes"), fill=c("blue", "orange"), cex = 0.7, inset = 0.05)
 
#######################################################################
AD vs ctrl
linyongmao@Linyong-Mao-MBP16-2019 autism % cp -i  script-AD-degs-pathway temp-s
linyongmao@Linyong-Mao-MBP16-2019 autism % vi temp-s
linyongmao@Linyong-Mao-MBP16-2019 autism % bash temp-s

t1 <- read.delim("temp1")
 t1$pathway <- gsub("../microglia/", "", t1$pathway)
 head(t1)
 t2 <- read.delim("temp2")
 t2$pathway <- gsub("../microglia/", "", t2$pathway)
 head(t2)
 t3 <- merge(t1, t2, by.x="pathway", by.y="pathway")
 dim(t3)
 t4 <- t3[ t3$fdr.x < 0.01 | t3$fdr.y < 0.01,c(1,2,8,9,10,16,17)]
 t4$logFDR.x <- 999
 t4$logFDR.y <- 999
for(i in 1:dim(t4)[1]) {
 t4$logFDR.x[i] <- -log10(t4$fdr.x[i])
 t4$logFDR.y[i] <- -log10(t4$fdr.y[i])
}
 t5 <- data.frame(t4$logFDR.x, t4$logFDR.y)
 rownames(t5) <- gsub("HALLMARK", "h", t4$pathway)
 colnames(t5) <- c("Ctrl-UP", "AD-UP")
 gs7 <- t5
 d <- order(gs7$"Ctrl-UP")
 gs8 <- as.data.frame( t(gs7[d,]))

 par( mar=c(6,16,2,2))
   barplot(as.matrix(gs8), horiz=T, beside=T, yaxt="n",  col=c("orange", "blue"),  xlab="-log10(FDR)")
   nam <- gsub("HALLMARK", "h", colnames(gs8))
  axis(side=2, at = seq(2, 2+2*3, by=3), labels=nam, las =1, cex.axis = 0.8)
  abline(v = seq(-10, 10, 2), lty = 5, lwd = 0.5, col = "gray")
  legend(1.5, 6.5, c( "AD Up genes", "Ctrl Up genes"), fill=c("blue", "orange"), cex = 0.7, inset = 0.0)

t5 <- data.frame(t4$oddsratio.x, t4$oddsratio.y)
 rownames(t5) <- gsub("HALLMARK", "h", t4$pathway)
 colnames(t5) <- c("Ctrl-UP", "AD-UP")
 gs7 <- t5
### d from previous order
 gs8 <- as.data.frame( t(gs7[d,]))
 par( mar=c(6,16,2,2))
   barplot(as.matrix(gs8), horiz=T, beside=T, yaxt="n",  col=c("orange", "blue"),  xlab="odds ratio")
   nam <- gsub("HALLMARK", "h", colnames(gs8))
  axis(side=2, at = seq(2, 2+2*3, by=3), labels=nam, las =1, cex.axis = 0.8)
  abline(v = seq(-10, 10, 1), lty = 5, lwd = 0.5, col = "gray")
  legend(4, 6.5, c( "AD Up genes", "Ctrl Up genes"), fill=c("blue", "orange"), cex = 0.7, inset = 0.05)


#######################################################################
###including chrX / chrY genes
> t1 <- read.delim("human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt")
 g1 <- read.delim("../microglia/HALLMARK_ALLOGRAFT_REJECTION.genes", header=F)
 g2 <- read.delim("../microglia/HALLMARK_INTERFERON_GAMMA_RESPONSE.genes", header = F)
 g3 <- unique( c(g1$V1, g2$V1))
 length(g3)
# [1] 363 / 400 
# F biased human mg
 t2 <- t1[ t1$name %in% g3 & t1$PValue < 0.05 & t1$logFC < 0,] 
 dim(t2)
# [1] 134  10  
 t3 <- t2[, c(1,2,5,7,8)]
# include mouse chrX / chrY genes
 t4 <- read.delim("mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.txt")
 t5 <- t4[, c(8,9,13, 14,3,6)]
 t6 <- merge(t3, t5, by.x="name", by.y="Gene.Symbol")
 dim(t6)
# [1] 127  10  
 t7 <- t6[ t6$logFC.y < 0,] 
 dim(t7)
# [1] 87 10
 t8 <- t7[ t7$PValue.y <= 0.05,]
 dim(t8)
# [1] 12 10
 t8$name
#  [1] "B2M"     "CCR1"    "CCR5"    "CD69"    "CD80"    "CD86"    "CTSS"    "IFIT2"   "LY86"    "MARCHF1" "OASL"    "SRGN"   
 t9 <- read.delim("HD-control-snRNA-mg.txt")
 t10 <- merge(t8, t9, by.x="name", by.y="gene")
 dim(t10)
# [1]  6 15
## B2M  2.03E-54        -0.283515525
## CD86 0.54641739      -0.013207086
## CTSS 0.000997343     -0.049023759
## IFIT2        1.03E-06        -0.017175202
## LY86 4.29E-62        -0.315435568
## SRGN 8.47E-116       0.606247879

> t11 <- t10[ t10$PValue.y < 0.25,]
> dim(t11)
[1] 25 15
> head(t11, n=1)
> data.frame(colnames(t11))
> t12 <- t11[, c(3,9,15)]
> rownames(t12) <- t11[, 1]
> colnames(t12) <- c("logFC (human, M vs F)", "logFC (mice, M vs F)", "logFC (HD vs Ct)")

#######################################################################
t1 <- read.delim("human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt")
 g2 <- read.delim("../microglia/HALLMARK_INTERFERON_GAMMA_RESPONSE.genes", header = F)
# F biased human mg, including chrX / chrY genes
 t2 <- t1[ t1$name %in% g2$V1 & t1$PValue < 0.05 & t1$logFC < 0,]
 dim(t2)
 t3 <- t2[, c(1,2,5,7,8)]
# include mouse chrX / chrY genes
 t4 <- read.delim("mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.txt")
 t5 <- t4[, c(8,9,13, 14,3,6)]
 t6 <- merge(t3, t5, by.x="name", by.y="Gene.Symbol")
 dim(t6)
 t7 <- t6[ t6$logFC.y < 0,]
 dim(t7)
 t8 <- t7[ t7$PValue.y <= 0.25,]
 dim(t8)
 t8$name
 t12 <- t8[, c(3,9)]
 rownames(t12) <- t8[, 1]
 head(t12)
 colnames(t12) <- c("logFC (human, M vs F)", "logFC (mice, M vs F)")
 col_fun = colorRamp2(c(-6, -1, 0), c( "blue", "white",  "orange"))
 eatmap(t12, cluster_columns=F, col=col_fun, name="logFC")

########################
HALLMARK_OXIDATIVE_PHOSPHORYLATION.genes
> t8 <- t7[ t7$PValue.y <= 0.25 & t7$name.x != "Mpc1-ps",]
>   dim(t8)
[1] 50 10
>  col_fun = colorRamp2(c(-2, -1, 0), c( "blue", "white",  "orange"))
>   eatmap(t12, cluster_columns=F, col=col_fun, name="logFC", row_names_gp = gpar(fontsize = 7))

##################################################################################################
linyongmao@Linyong-Mao-MBP16-2019 autism % cat script-human.mg-mouse-overlap-fisher
#

tab="	"

mouse="mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.noXY.rnk"
cat "$mouse"  | sort -t "$tab"  +1 -2g | head  -500 | awk '$2 < -1.3010' | cut -f 1 > mice-mg-f-bias
cat "$mouse"  | sort -t "$tab"  +1 -2gr | head  -500 | awk '$2 > 1.3010' | cut -f 1 > mice-mg-m-bias
ls mice-mg-f-bias mice-mg-m-bias > temp-f1


cat  human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk | sort -t "$tab"  +1 -2g | head  -500 | awk '$2 < -1.3010' | cut -f 1 > temp-f-bias
cat  human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk | sort -t "$tab"  +1 -2gr | head  -500 | awk '$2 > 1.3010' | cut -f 1 > temp-m-bias
cut -f 1 human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk | sort | uniq > temp-1
cut -f 1 "$mouse"   | sort | uniq  > temp-2
cat temp-1 temp-2 | sort | uniq -d > temp-bg-genes

 bash   script-inputset-pathways-overlap-fisher-fdr   temp-f-bias human-mg-f-bias.interact   temp-f1   temp-bg-genes 

echo
echo
echo

bash   script-inputset-pathways-overlap-fisher-fdr  temp-m-bias human-mg-m-bias.interact temp-f1   temp-bg-genes

###################################################
> r1 <- read.delim("mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.noXY.rnk", header=F)
 r2 <- read.delim("human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk", header=F)
 dim(r1)
#  [1] 12171     2
 dim(r2)
#  [1] 14586     2
 r3 <- merge(r1, r2, by.x="V1", by.y="V1")
 dim(r3)
#  [1] 10021     3
 write.table(r3, "temp1", quote=F, sep="\t")

linyongmao@Linyong-Mao-MBP16-2019 autism % vi temp1
cat temp1 | awk 'NR > 1' |cut -f 1-2 | sort -t "$tab"  +1 -2g | awk '$2 < -1' |head  -500 | cut -f 1  >  mice-mg-f-bias
cat temp1 | awk 'NR > 1' |cut -f 1-2 | sort -t "$tab"  +1 -2gr | awk '$2 > 1' |head  -500 | cut -f 1  > mice-mg-m-bias
ls mice-mg-f-bias mice-mg-m-bias > temp-f1

cat temp1 | awk 'NR > 1' |cut -f 1,3 | sort -t "$tab"  +1 -2g | awk '$2 < -1' |head  -500   | cut -f 1 > temp-f-bias
cat temp1 | awk 'NR > 1' |cut -f 1,3 | sort -t "$tab"  +1 -2gr | awk '$2 > 1' |head  -500   | cut -f 1 > temp-m-bias

cat temp1 | awk 'NR > 1' |cut -f 1 > temp-bg-genes

wc -l mice-mg-f-bias mice-mg-m-bias temp-f-bias temp-m-bias temp-bg-genes
bash   script-inputset-pathways-overlap-fisher-fdr   temp-f-bias human-mg-f-bias.interact   temp-f1   temp-bg-genes
echo
echo
echo

bash   script-inputset-pathways-overlap-fisher-fdr  temp-m-bias human-mg-m-bias.interact temp-f1   temp-bg-genes

###########################################oxphos pathway Z-score ~ Esrrb gene log2(cpm+1)
> t1 <- read.delim("mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.noXY.rnk", header=F)

 file <- "../microglia/HALLMARK_OXIDATIVE_PHOSPHORYLATION.genes"
 p <- read.delim(file, header=F)
 dim(p)
# [1] 200   1
 t2 <- t1[ t1$V1 %in% p$V1,]
 dim(t2)
# [1] 187   2
 t3 <- t2[ t2$V2 < log10(0.25),]
 dim(t3)
# [1] 85  2, no chrX/chrY genes
......
> info.oxphos <- info.2
> head(info.oxphos)
pathway z-scroe
            id      info replicateNum sex EorP age lps        expr
1 SAMN07189830 F_P60_Sal            6   F    P  60 sal  3.15159242

> a.df.g.z.score.log10 <-  a.df.g
...
gene expr log2(cpm+1)
> p.exp <- a.df.g[ a.df.g$Gene.Symbol == "ESRRB",]
...
info.2 - log2(cpm+1) of a gene
> identical(info.2$id, info.oxphos$id)
[1] TRUE
> plot(info.2$expr, info.oxphos$expr, col="red", main="mice OXPHOS pathway Z-score ~ Esrrb", xlab="log2(CPM+1)")

        Pearson's product-moment correlation

data:  info.2$expr and info.oxphos$expr
t = 0.74919, df = 38, p-value = 0.4584
      cor
0.1206469

Spearman's rank correlation rho

data:  info.2$expr and info.oxphos$expr
S = 6685.3, p-value = 0.01781
      rho
0.3728655

########################robust linear regression
> d1 <- rlm(info.oxphos$expr ~ info.oxphos$Esrrb)
> summary(d1)

Coefficients:
                  Value   Std. Error t value
(Intercept)       -0.1017  0.0693    -1.4670
info.oxphos$Esrrb  0.1839  0.0702     2.6191

t=2.6191, Two-tailed, The p-value is 0.012599

########################excluding one example
> t1 <- info.oxphos[ info.oxphos$id != "SAMN07189830",]
> d1 <- lm(t1$expr ~ t1$Esrrb)
> summary(d1)

Coefficients:
            Estimate Std. Error t value Pr(>|t|)
(Intercept) -0.09334    0.06828  -1.367 0.179892
t1$Esrrb     0.26292    0.07153   3.676 0.000747 ***

Residual standard error: 0.4259 on 37 degrees of freedom
Multiple R-squared:  0.2675,    Adjusted R-squared:  0.2477 

p-value = 0.0007474, cor = 0.5172108 
p-value = 0.002239, rho = 0.4751253, Spearman's rank correlation rho

#################################################
Esrrb binding genes, corr, sex diff
###84 oxphos genes targeted by Esrrb
linyongmao@Linyong-Mao-MBP16-2019 autism % cat Esrrb-oxphos.genes-targets
file <- "../microglia/HALLMARK_OXIDATIVE_PHOSPHORYLATION.genes"
 p <- read.delim(file, header=F)
 dim(p)
# [1] 200   1
 dim(a.df.g)
 p.exp <- a.df.g[ a.df.g$Gene.Symbol %in% c(p$V1, "ESRRB"), ]
  length(p.exp$Gene.Symbol)
# [1] 188 mouse expressed oxphos genes plus Esrrb, ###a is z-score of log10(cpm+1)

 mat <- as.data.frame(p.exp[, 3:42])
 rownames(mat) <- p.exp$name
 identical(mat$SAMN07189830, p.exp$SAMN07189830)
# [1] TRUE
 mat2 <- as.data.frame(t(mat))
 c1 <- as.data.frame(cor(mat2, method="spearman"))
 c2 <- data.frame(1:189, colnames(c1))
 c2[ c2$colnames.c1. == "Esrrb",]
#    X1.189 colnames.c1.
# 50     50        Esrrb
 summary(sort(c1[,50])[1:188])
#     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
# -0.59636  0.07478  0.26178  0.22664  0.41743  0.74686 
 head(c1[,49:50])
 head(c1[,50])
 c3 <- c1[, 49:50]
 c3$id <- rownames(c3)
identical(c3$id, p.exp$name)
 c4 <- cbind(c3, p.exp)
 colnames(c4)
 c5 <- c4[,c(2:3,46:51)]
 dim(c5)
# [1] 189   8

t1 <- read.delim("mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.noXY.rnk", header=F)
 file <- "../microglia/HALLMARK_OXIDATIVE_PHOSPHORYLATION.genes"
 p <- read.delim(file, header=F)
 dim(p)
# [1] 200   1
 t2 <- t1[ t1$V1 %in% c(p$V1, "ESRRB"),]
 dim(t2)
# [1] 188 mouse-converted human genes,   2
 corr1 <- merge(c5, t2, by.x="Gene.Symbol", by.y="V1")
 dim(corr1)
# [1] 189   9
# two mouse genes -> 1 human gene
 corr1[ corr1$Gene.Symbol == "MPC1",]
 plot(corr1$V2, corr1$Esrrb, col="red", xlab="signed logPVal (M vs. F)", ylab="Esrrb ~ oxphos gene Spearman's corr")
 abline(h = seq(-100, 100, 1/4), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
 abline(h=0)
 abline(v=0)

 t3 <- read.delim("Esrrb-oxphos.genes-targets", header=F)
 dim(t3)
# [1] 84  1
 t4 <- corr1[ corr1$Gene.Symbol %in% t3$V1 & corr1$Gene.Symbol != "ESRRB",]
 dim(t4)
# [1] 84  9
 t5 <- corr1[ !(corr1$Gene.Symbol %in% t3$V1) & corr1$Gene.Symbol != "ESRRB",]
 dim(t5)
# [1] 104   9

 wilcox.test(t4$Esrrb, t5$Esrrb)
# W = 4828, p-value = 0.2154
 t.test(t4$Esrrb, t5$Esrrb)
# t = 2.1314, df = 180.1, p-value = 0.03442
# mean of x mean of y 
# 0.2729310 0.1892528 
 t4$Esrrb.bind <- "oxphos.yes"
 t5$Esrrb.bind <- "oxphos.no"
 t6 <- rbind(t4, t5)
 t6.orig <- t6

##############################################################random genes
 t1 <- read.delim("mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.noXY.rnk", header=F)
  file <- "../microglia/HALLMARK_OXIDATIVE_PHOSPHORYLATION.genes"
  p <- read.delim(file, header=F)
  dim(p)
# [1] 200   1
  t2 <- t1[ !(t1$V1 %in% c(p$V1, "ESRRB")),]
  dim(t2)
# [1] 11983 expressed mouse genes with human ortholog     
 t3 <- t2[ sample(1:dim(t2)[1], 100 ),]
> write.table(t3, "random100-non-oxphos", quote=F, sep="\t")
# 8 genes in t3 have Esrrb binding /1081, p=0.173029719, odds=1.525750638
# THAP4;NDUFA12;PRDX1;AGL;MIB2;CSNK1D;NCAPD2;MLLT6
 dim(a.df.g)
 p.exp <- a.df.g[ a.df.g$Gene.Symbol %in% c(t3$V1, "ESRRB"), ]
 length(p.exp$Gene.Symbol)
# 102 mouse expressed non-oxphos genes plus Esrrb, ###a is z-score of log10(cpm+1)
mat <- as.data.frame(p.exp[, 3:42])
 rownames(mat) <- p.exp$name
 identical(mat$SAMN07189830, p.exp$SAMN07189830)
# [1] TRUE
 mat2 <- as.data.frame(t(mat))
 c1 <- as.data.frame(cor(mat2, method="spearman"))
 c2 <- data.frame(1:dim(c1)[1], colnames(c1))
 c2[ c2$colnames.c1. == "Esrrb",]
# one column Esrrb gene, and nearby gene
 c3 <- c1[, 13:14]
 c3$id <- rownames(c3)
identical(c3$id, p.exp$name)
 c4 <- cbind(c3, p.exp)
 colnames(c4)
 c5 <- c4[,c(2:3,46:51)]
 dim(c5)
# [1] 102   8
 c6 <- c5[ c5$Gene.Symbol != "ESRRB",]
 c6$Esrrb.bind <- "randomgenes.no"
g1 <- scan(what="", sep = "\n")
THAP4
NDUFA12
PRDX1
AGL
MIB2
CSNK1D
NCAPD2
MLLT6

for(i in 1:dim(c6)[1]) {
if(c6$Gene.Symbol[i] %in% g1)
  c6$Esrrb.bind[i] <- "randomgenes.yes"

}

dim(c6)
# 101 
t1 <- read.delim("mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.noXY.rnk", header=F)
 t2 <- t1[ t1$V1 %in% c6$Gene.Symbol,]
 dim(t2)
# [1] 100   mouse-converted human genes,   2
 corr2 <- merge(c6, t2, by.x="Gene.Symbol", by.y="V1")
 dim(corr2)
# 101  10
# two mouse genes -> 1 human gene
 corr2[ corr2$Gene.Symbol == "MPC1",]
 plot(corr2$V2, corr2$Esrrb, col="red", xlab="signed logPVal (M vs. F)", ylab="Esrrb ~ random gene Spearman's corr")
 abline(h = seq(-100, 100, 1/4), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
 abline(h=0)
 abline(v=0)

 t7 <- t6[, c(1:8,10,9)]
 dim(t7)
# [1] 188  10
 identical(colnames(t7),colnames(corr2))
# [1] TRUE
 corr3 <- rbind(t7, corr2)
# 289 gens;
 t11 <- corr3[ corr3$Esrrb.bind == "oxphos.yes",]
 t12 <- corr3[ corr3$Esrrb.bind == "oxphos.no",]
 t13 <- corr3[ corr3$Esrrb.bind == "randomgenes.yes",]
 t14 <- corr3[ corr3$Esrrb.bind == "randomgenes.no",]
 t.test(t11$Esrrb, t14$Esrrb)
# t = 5.1333, df = 145.5, p-value = 8.976e-07
#  mean of x  mean of y 
# 0.27293097 0.03208394 

 t.test(t11$Esrrb, t13$Esrrb)
# t = 1.1611, df = 7.5732, p-value = 0.2809
# mean of x mean of y 
# 0.2729310 0.1345468 

> corr3$caterg <- factor( corr3$Esrrb.bind, levels=c("oxphos.no", "oxphos.yes", "randomgenes.no", "randomgenes.yes"), labels=c("OXPHOS.genes.NO", "OXPHOS.genes.YES", "random.genes.NO", "random.genes.YES"))
 boxplot(corr3$Esrrb ~ corr3$caterg, outcol="white", xlab="mouse Esrrb targets", ylab="Esrrb ~ gene Spearman's corr", col=c("white", "orange"), ylim=c(-1,1))
 beeswarm(corr3$Esrrb ~ corr3$caterg, add=T)
 abline(h = seq(-100, 100, 1/10), lty = 5, lwd = 0.5, col = "gray")
 lines(2:3,  c(0.8, 0.8), col="blue", lwd = 2)
#################
> t10 <- merge(t8, corr3, by.x="name.x", by.y="id")
> colnames(t10)[1] <- "mouse.name"
> dim(t10)
[1] 47 20
> t10[ t10$Esrrb >= 0.3 & t10$caterg =="OXPHOS.genes.YES",c(1,2,4,5,9,10,12)]

########################################################
human ESRRB corr with OXPHOS genes

> raw <- read.delim("human_Microglia_RNA-18samp.gene.count.stranded.txt")
......
> dim(a.df.g)
[1] 15089    
> t1 <- corr3[ , c(1,4,11)]
#    Gene.Symbol                                                                  Gene.Title           caterg
# 6        ACAT1             acetyl-CoA acetyltransferase 1 [Source:HGNC Symbol;Acc:HGNC:93] OXPHOS.genes.YES
 dim(t1)
# [1] 289   3
 t2 <- unique(t1)
 dim(t2)
# [1] 287   3
 t3 <- merge(a.df.g, t2, by.x="name", by.y="Gene.Symbol")
 dim(t3)
# [1] 269 expressed human genes with possible chrX/Y genes, 17
  p.exp <- a.df.g[ a.df.g$name %in% c(t2$Gene.Symbol, "ESRRB"), ]
 dim(p.exp)
# [1] 270  15
 mat <- as.data.frame(p.exp[, 2:14])
 rownames(mat) <- p.exp$name
 identical(mat$human_Microglia_RNA_polyA_P11, p.exp$human_Microglia_RNA_polyA_P11)
 mat2 <- as.data.frame(t(mat))
 c1 <- as.data.frame(cor(mat2, method="spearman"))
 c1$name <- rownames(c1)
 c2 <- merge(c1, t2, by.x="name", by.y="Gene.Symbol", all.x = TRUE)
 c3 <- c2[ , colnames(c2) %in% c("name", "ESRRB", "caterg")]
 dim(c3)
# [1] 270   2

###############################################################################
###corr between TF ~ targets in a pathway; in random genes
 f1 <- read.delim("random100-non-oxphos")
### genes among random that are bound by the TF
 f2 <- read.delim("temp-11", header=F)
> a.df.g <- merge(a.df, gene.name, by.x="id", by.y="geneID")
> dim(a.df.g)
[1] 15089    15
p.exp <- a.df.g[ a.df.g$name %in% c(f1$V1, "VDR"), ]
length(p.exp$name)
mat <- as.data.frame(p.exp[, 2:14])
 rownames(mat) <- p.exp$name
 identical(mat$human_Microglia_RNA_polyA_P14, p.exp$human_Microglia_RNA_polyA_P14)
 mat2 <- as.data.frame(t(mat))
 c1 <- as.data.frame(cor(mat2, method="spearman"))
 c2 <- data.frame(1:dim(c1)[1], colnames(c1))
 i <- c2[ c2$colnames.c1. == "VDR",1]
 c3 <- c1[, (i-1):i]
c3$id <- rownames(c3)
 identical(c3$id, p.exp$name)
 c4 <- cbind(c3, p.exp)
 colnames(c4)
 c5 <- c4[,c(2,4,18)]
 head(c5)
#               VDR                 id    name
# NDUFAB1 0.4725275 ENSG00000004779.10 NDUFAB1
# MDH1    0.5934066 ENSG00000014641.21    MDH1
 c5$VDR.binding = "randomgenes.no"
 corr1 <- c5
 corr1[ corr1$name %in% f2$V1, ]$VDR.binding <- "randomgenes.yes"
 corr1.rand <- corr1
######HALLMARK_OXIDATIVE_PHOSPHORYLATION.genes and VDR- targets
 file <- "../microglia/HALLMARK_OXIDATIVE_PHOSPHORYLATION.genes"
f1 <- read.delim(file, header=F)
f2 <- read.delim("temp-12", header=F)
p.exp <- a.df.g[ a.df.g$name %in% c(f1$V1, "VDR"), ]
length(p.exp$name)
mat <- as.data.frame(p.exp[, 2:14])
 rownames(mat) <- p.exp$name
 identical(mat$human_Microglia_RNA_polyA_P14, p.exp$human_Microglia_RNA_polyA_P14)
 mat2 <- as.data.frame(t(mat))
 c1 <- as.data.frame(cor(mat2, method="spearman"))
 c2 <- data.frame(1:dim(c1)[1], colnames(c1))
 i <- c2[ c2$colnames.c1. == "VDR",1]
 c3 <- c1[, (i-1):i]
c3$id <- rownames(c3)
 identical(c3$id, p.exp$name)
 c4 <- cbind(c3, p.exp)
 colnames(c4)
 c5 <- c4[,c(2,4,18)]
 head(c5)
#               VDR                 id    name
# NDUFAB1 0.4725275 ENSG00000004779.10 NDUFAB1
# MDH1    0.5934066 ENSG00000014641.21    MDH1
 c5$VDR.binding = "oxphos.no"
 corr1 <- c5
 corr1[ corr1$name %in% f2$V1, ]$VDR.binding <- "oxphos.yes"
corr1.ox <- corr1
 identical(colnames(corr1.rand), colnames(corr1.ox))
 t1 <- rbind(corr1.rand, corr1.ox)
 t2 <- t1[t1$name != "VDR",]
 dim(t2[ t2$VDR.binding == "randomgenes.yes",])
# [1] 12  4
 dim(t2[ t2$VDR.binding == "randomgenes.no",])
# [1] 72  4
 dim(t2[ t2$VDR.binding == "oxphos.yes",])
# [1] 45  4
 dim(t2[ t2$VDR.binding == "oxphos.no",])
# [1] 152   4

 t2$caterg <- factor( t2$VDR.binding, levels=c("oxphos.no", "oxphos.yes", "randomgenes.no", "randomgenes.yes"), labels=c("OXPHOS.genes.NO", "OXPHOS.genes.YES", "random.genes.NO", "random.genes.YES"))

 boxplot(t2$VDR ~ t2$caterg, outcol="white", xlab="VDR CD4+ Human  targets", ylab="human mg VDR ~ gene Spearman's corr", col=c("white", "orange"), ylim=c(-1,1))
 beeswarm(t2$VDR ~ t2$caterg,add=T)
  abline(h = seq(-100, 100, 1/10), lty = 5, lwd = 0.5, col = "gray")
  lines(2:3,  c(0.8, 0.8), col="blue", lwd = 2)

t3 <- t2[ t2$VDR.binding == "randomgenes.yes",]
t4 <- t2[ t2$VDR.binding == "randomgenes.no",]
t5 <- t2[ t2$VDR.binding == "oxphos.yes",]
t6 <- t2[ t2$VDR.binding == "oxphos.no",]

 t.test(t5$VDR,t4$VDR)
 t.test(t5$VDR,t6$VDR)

######################################################
linyongmao@Linyong-Mao-MBP16-2019 autism % cat  chea.human.mg.f.bias.oxphos.83genes.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $4 < 5e-4 && NR > 1' | cut -f 1 > temp1
cat chea.mouse.mg.f.bias.oxphos.85genes.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $4 < 5e-4 && NR > 1' | cut -f 1 > temp2
wc -l temp1 temp2
      22 temp1
      18 temp2

cat temp1 temp2 | sort | uniq -c | wc
      31  regulators in cell types
cat temp1 temp2 | awk '{print $1}' |sort | uniq -c | wc
      25 uniq regulators
cat temp1 | grep -i human | awk '{print $1}' | sort | uniq > temp3
cat temp2 | grep -i mouse | awk '{print $1}' | sort | uniq > temp4
wc -l temp3 temp4
       9 temp3
      14 temp4

cat temp3 temp4 | sort | uniq -d
MYC
YY1

################################################
#chrY gene expr, mouse mg
#a.df is log10(cpm+1) 
a.df$id <- row.names(a.df)
 a.df$id2 <-  gsub("\\.[0-9][0-9]*", "", a.df$id)
 t2 <- read.delim("../dir-GTExV8/gencode.vM31.mouse-id-chr-name")
t3 <- merge(a.df, t2, by.x="id", by.y="geneID")

 t4 <- t3[ t3$chr == "chrY",]
 dim(t4)
# [1]  6 46
 t5 <- t4[ , c(2:41)]
 rownames(t5) <- t4$name
 t6 <- as.data.frame(t(t5))
 dim(t6)
# [1] 40  6
 identical(info.2$id, rownames(t6))
# [1] TRUE
 t7 <- cbind(info.2, t6)
 boxplot((10^t7$Uty) - 1 ~ t7$sex, outcol="white")
 beeswarm((10^t7$Uty) - 1 ~ t7$sex,  add=T)
 abline(h = seq(-100, 100, 2), lty = 5, lwd = 0.5, col = "gray")

########################################################
cp  chea.human.mg.f.bias.myc.81genes.txt temp.mouse.mg.f.bias.pathway.44genes.txt
cp ../microglia/HALLMARK_MYC_TARGETS_V1.genes temp-pathway-200genes-list
cp chea.myc.200genes.txt temp.pathway.alltargetgenes.txt
execute R-TF-target-correlate-boxplot-human-generalfiles         

cp chea.human.mg.f.bias.oxphos.83genes.txt     temp.mouse.mg.f.bias.pathway.44genes.txt
cp ../microglia/HALLMARK_OXIDATIVE_PHOSPHORYLATION.genes temp-pathway-200genes-list
cp chea.oxphos.200genes.txt temp.pathway.alltargetgenes.txt
# execute R-TF-target-correlate-boxplot-human-generalfiles
Rscript R-TF-target-correlate-boxplot-human-generalfiles
cat temp1 | wc
cat temp1 | sed 's/^[0-9][0-9]*      //'

cp chea.human.mg.f.bias.infg.102genes.txt temp.mouse.mg.f.bias.pathway.44genes.txt
cp  ../microglia/HALLMARK_INTERFERON_GAMMA_RESPONSE.genes temp-pathway-200genes-list
cp chea.infg.200genes.txt       temp.pathway.alltargetgenes.txt
# execute R-TF-target-correlate-boxplot-human-generalfiles
Rscript R-TF-target-correlate-boxplot-human-generalfiles
cat temp1 | wc

cp  chea.human.mg.f.bias.fatty.32genes.txt     temp.mouse.mg.f.bias.pathway.44genes.txt
cp ../microglia/HALLMARK_FATTY_ACID_METABOLISM.genes  temp-pathway-200genes-list
cp chea.fatty.158genes.txt       temp.pathway.alltargetgenes.txt
# execute R-TF-target-correlate-boxplot-human-generalfiles
Rscript R-TF-target-correlate-boxplot-human-generalfiles
cat temp1 | wc
cat temp1 | sed 's/^[0-9][0-9]*      //'

cp      chea.mouse.mg.f.bias.oxphos.85genes.txt  temp.mouse.mg.f.bias.pathway.44genes.txt
cp ../microglia/HALLMARK_OXIDATIVE_PHOSPHORYLATION.genes temp-pathway-200genes-list
cp chea.oxphos.200genes.txt  temp.pathway.alltargetgenes.txt
Rscript R-TF-target-correlate-boxplot.mouse.generalfiles
cat temp1 | wc
cat temp1 | sed 's/^[0-9][0-9]* //'


cp    chea.mouse.mg.f.bias.infg.45genes.txt temp.mouse.mg.f.bias.pathway.44genes.txt
cp ../microglia/HALLMARK_INTERFERON_GAMMA_RESPONSE.genes  temp-pathway-200genes-list
cp chea.infg.200genes.txt   temp.pathway.alltargetgenes.txt
Rscript R-TF-target-correlate-boxplot.mouse.generalfiles
cat temp1 | wc
cat temp1 | sed 's/^[0-9][0-9]* //'

###############################################
cp chea.human.mg.f.bias.infg.102genes.withBackg.txt temp.mouse.mg.f.bias.pathway.44genes.txt
cp  ../microglia/HALLMARK_INTERFERON_GAMMA_RESPONSE.genes temp-pathway-200genes-list
cp chea.infg.200genes.txt       temp.pathway.alltargetgenes.txt

> r2 <- res[ res$ox.yes != -999,]
 r2$fdr <- p.adjust(r2$ox.yes.rand.no.P, method = "fdr")
 r3 <- r2[ r2$fdr < 0.01,]

> box1 <- t10[ t10$VDR.binding %in% c("oxphos.yes.sex.biased", "randomgenes.no"),]
 dim(box1)
 box1$caterg <- factor(box1$VDR.binding, levels=c("oxphos.yes.sex.biased", "randomgenes.no"), labels=c("INFG.F.biased.yes", "randomgenes.no"))
 boxplot(box1[,1] ~ box1$caterg, outcol="white",  xlab="TF target", ylab="TF-gene Spearman corr", main=t3$Term[i], col=c( "grey", "white"), ylim=c(-1,1.1), cex.main=1)
 beeswarm(box1[,1] ~ box1$caterg,add=T)
 abline(h = seq(-100, 100, 1/10), lty = 5, lwd = 0.5, col = "gray")
 text(1.5, 1, paste("pValue=", format(test1$p.value, digits=3), sep=""), pos=3, col="blue")

############
cp chea.human.mg.f.bias.oxphos.83genes.withBackg.txt temp.mouse.mg.f.bias.pathway.44genes.txt
cp  ../microglia/HALLMARK_OXIDATIVE_PHOSPHORYLATION.genes temp-pathway-200genes-list                       
cp  chea.oxphos.200genes.txt  temp.pathway.alltargetgenes.txt              
FDR calc

#######################################################################
heatmap TF-targets
> f1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF.noX.Y.interac.strand.prerank.v7.4.GseaPreranked.1692378724023/HALLMARK_INTERFERON_GAMMA_RESPONSE.tsv")
 t1 <- f1[ f1$RANK.METRIC.SCORE < log10(0.05),]
 dim(t1)
# [1] 102   7
 head(t1)
 t2 <- t1[, 1:6]
 t3 <- read.delim("chea.infg.200genes.txt")
 t4 <- t3[ t3$Term == "IRF1 21803131 ChIP-Seq MONOCYTES Human",]
 t4
 genes <- strsplit( t4$Genes, ';')[[1]]
 t2$IRF1 <- 0
###TF-target postive corr
 t2[ t2$SYMBOL %in% genes,]$IRF1 = 1

 t4 <- t3[ t3$Term == "IRF1 21803131 ChIP-Seq PrimaryMonocytes Human Connective",]
 t4
 genes <- strsplit( t4$Genes, ';')[[1]]
 t2[ t2$SYMBOL %in% genes,]$IRF1 = 1

t4 <- t3[ t3$Term == "STAT1 19122651 ChIP-Seq HeLaS3 Human CervicalCancer",]
 t4
 genes <- strsplit( t4$Genes, ';')[[1]]
 t2$STAT1 <- 0
 t2[ t2$SYMBOL %in% genes,]$STAT1 = 1

 t4 <- t3[ t3$Term == "IRF8 22096565 ChIP-ChIP GC-B Mouse",]
 t4
 genes <- strsplit( t4$Genes, ';')[[1]]
 t2$IRF8 <- 0
 t2[ t2$SYMBOL %in% genes,]$IRF8 = 1

 rownames(t2) <- t2$SYMBOL
 colnames(t2)
 t3 <- t2[, c(7:9)]
 t4 <- t3[  rowMeans(t3, na.rm=T) > 0,]
 dim(t4)
# [1] 65  3
 col_fun = colorRamp2(c(0,1), c( "white",  "red"))
 eatmap(t4, col=col_fun, row_names_gp = gpar(fontsize = 7), name="TF target")

################
> f1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand-weight0-hallmark.GseaPreranked.1718816546930/HALLMARK_OXIDATIVE_PHOSPHORYLATION.tsv")
 t1 <- f1[ f1$RANK.METRIC.SCORE < log10(0.05),]
 dim(t1)
# [1] 83  7
 head(t1)
 t2 <- t1[, 1:6]
 t3 <- read.delim("chea.oxphos.200genes.txt")
 t3[1:41, 1:7]

 t4 <- t3[ t3$Term == "STAT1 19122651 ChIP-Seq HeLaS3 Human CervicalCancer",]
 t4
 genes <- strsplit( t4$Genes, ';')[[1]]
 t2$STAT1 <- 0
 t2[ t2$SYMBOL %in% genes,]$STAT1 = 1

 t4 <- t3[ t3$Term == "VDR 23849224 ChIP-Seq CD4+ Human",]
 t4
 genes <- strsplit( t4$Genes, ';')[[1]]
 t2$VDR <- 0 
 t2[ t2$SYMBOL %in% genes,]$VDR = 1 
 rownames(t2) <- t2$SYMBOL
 colnames(t2)
 t3 <- t2[, c(7:8)]
 t4 <- t3[  rowMeans(t3, na.rm=T) > 0,]
 dim(t4)
 col_fun = colorRamp2(c(0,1), c( "white",  "red"))
 eatmap(t4, col=col_fun, row_names_gp = gpar(fontsize = 7), name="TF target")

#######################################################################
# STAT1 19122651 ChIP-Seq HeLaS3 Human CervicalCancer
# are targets F biased
> f1 <- read.delim("/Users/linyongmao/Documents/autism/human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk", header=F)
##p=0.8629 in gtex AA tissue, no sex diff
 f1 <- read.delim("/Users/linyongmao/Documents/dir-GTExV8/diff2-1-Heart-Atrial-Appendage-FvsM.age-bmi-RIN-ischem-PC1-21-covar.noX.Y.rnk", header=F)
# random genes drawn from mouse mg data
 t1 <- read.delim("random100-non-oxphos", header=T)
 f2 <- f1[ f1$V1 %in% t1$V1,]
 dim(f2)
# [1] 84  2
 dim(t1)
# [1] 100   2
 summary(f2$V2)
# log10(p) = -0.10, p=0.79
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
# -3.7622 -0.7719 -0.1001 -0.1466  0.5169  2.7276
 summary(f1$V2)
#     Min.  1st Qu.   Median     Mean  3rd Qu.     Max.
# -4.93980 -0.65792 -0.05434 -0.10218  0.45778  4.90685
t3 <- read.delim("chea.random100-non-oxphos.txt")
t4 <- t3[ t3$Term == "STAT1 19122651 ChIP-Seq HeLaS3 Human CervicalCancer",]
 t4
 genes <- strsplit( t4$Genes, ';')[[1]]

 f2$stat1.targets = "no"
 f2[ f2$V1 %in% genes,]$stat1.targets = "yes"
 boxplot(f2$V2 ~ f2$stat1.targets, outcol="white", ylab="signed log10(pVal) (F vs. M)", main="diff2-1-Heart-Atrial-Appendage-FvsM.age-bmi-RIN-ischem-PC1-21-covar.noX.Y.rnk", cex.main=0.8)
 beeswarm(f2$V2 ~ f2$stat1.targets, add=T)
 abline(h = seq(-100, 100, 10/10), lty = 5, lwd = 0.5, col = "gray")
 t6 <- f2[ f2$stat1.targets == "yes",]
 dim(t6)
# [1] 21  3
 t7 <- f2[ f2$stat1.targets == "no",]
 dim(t7)
# [1] 74  3
 wilcox.test(t6$V2, t7$V2)

#######################################################
 % cat chea.human.mg.f.bias.infg.102genes.withBackg.txt | grep -i human | awk 'BEGIN {FS = "\t"; OFS = "\t"} $4 < 0.01' |cut -f 1-7 | awk '{print $1}' > temp1
 % cat chea.human.mg.f.bias.oxphos.83genes.withBackg.txt | grep -i human | awk 'BEGIN {FS = "\t"; OFS = "\t"} $4 < 0.01' |cut -f 1-7 | awk '{print $1}' >> temp1
      24 temp1
cat temp1 | while read g
do
grep -i "       $g      " gencode.v42.primary_assembly.noPar.gene-chr-type-name
done | wc
      23
EST1 TF found no human genes
cat temp1 | while read g
do
grep -i "       $g      " gencode.v42.primary_assembly.noPar.gene-chr-type-name
done  | grep -i "chr[xy]"
ENSG00000049768.18      FOXP3   chrX    -       protein_coding

###########################################################
linyongmao@Linyong-Mao-MBP16-2019 autism % cat ~/Documents/Whitehead-main/autism | grep "Term == " | sed 's#.*"\(.*\)".*#\1#' | sort | uniq | while read ll
do
echo "$ll"
grep -i "$ll"  chea.vdr.4tf.txt
echo
done

linyongmao@Linyong-Mao-MBP16-2019 autism % cat ~/Documents/Whitehead-main/autism | grep "Term == " | sed 's#.*"\(.*\)".*#\1#' | sort | uniq
IRF1 21803131 ChIP-Seq MONOCYTES Human
IRF1 21803131 ChIP-Seq PrimaryMonocytes Human Connective
IRF8 22096565 ChIP-ChIP GC-B Mouse
STAT1 19122651 ChIP-Seq HeLaS3 Human CervicalCancer
VDR 23849224 ChIP-Seq CD4+ Human

########################################################
cat temp1
CEBPB 24764292 ChIP-Seq MC3T3 Mouse
ESRRB 18555785 ChIP-Seq MESCs Mouse
IRF8 21731497 ChIP-ChIP J774 Mouse
IRF8 22096565 ChIP-ChIP GC-B Mouse
IRF8 27001747 Chip-Seq BMDM Mouse
YY1 23942234 ChIP-Seq MYOBLASTS AND MYOTUBES Mouse

cat temp1 | while read ll
do
echo "$ll"
grep -i "$ll" chea.esrrb.4tf.mouse.txt
echo
done

IRF8 27001747 Chip-Seq BMDM Mouse       1/1500  0.26792322930856893     0.33363242784772584     0       0       4.11318656882366        5.417292102708492       IRF8
YY1 23942234 ChIP-Seq MYOBLASTS AND MYOTUBES Mouse      1/1173  0.21477048652613595     0.33363242784772584     0       0       5.353811149032992       8.235153745330903       YY1

######
cat temp-s3
###
cat temp1 | while read ll
do
 echo "$ll"
 tf=`echo "$ll" | awk '{print $1}' `
 awk 'BEGIN {FS = "\t"; OFS = "\t"} toupper($1) ~ /'$tf'.*MOUSE/ ' chea.esrrb.4tf.mouse.txt
 echo
done


######################################################
linyongmao@Linyong-Mao-MBP16-2019 autism % cat mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.noXY.rnk | cut -f 1 | sort | uniq > temp1
wc -l temp1
   12171 temp1

chea.mouse.mg.f.bias.oxphos.85genes.withBackg12171.txt

cp chea.mouse.mg.f.bias.oxphos.85genes.withBackg12171.txt temp.mouse.mg.f.bias.pathway.44genes.txt
cp  ../microglia/HALLMARK_OXIDATIVE_PHOSPHORYLATION.genes temp-pathway-200genes-list
cp chea.oxphos.200genes.txt temp.pathway.alltargetgenes.txt

cp chea.mouse.mg.f.bias.infg.45genes.withBackg12171.txt  temp.mouse.mg.f.bias.pathway.44genes.txt
cp ../microglia/HALLMARK_INTERFERON_GAMMA_RESPONSE.genes  temp-pathway-200genes-list
cp chea.infg.200genes.txt         temp.pathway.alltargetgenes.txt

cp  chea.mouse.mg.f.bias.infg.110genes.withBackg12171.txt temp.mouse.mg.f.bias.pathway.44genes.txt

########################################################
linyongmao@Linyong-Mao-MBP16-2019 autism % cat script-AD-degs-pathway
#

tab="	"
cat AD.nature.2024.aggregated_fullset.Mic_Immune_Mic.tsv | grep  "nrad${tab}allregions" | awk 'BEGIN {FS = "\t"; OFS = "\t"} $4 == 2 && $6 > 0 && $7 > 0 ' | cut -f 1 | sort | uniq  > temp-ad-up.genes
wc -l temp-ad-up.genes
cat AD.nature.2024.aggregated_fullset.Mic_Immune_Mic.tsv | grep  "nrad${tab}allregions" | awk 'BEGIN {FS = "\t"; OFS = "\t"} $4 == 1 && $6 < 0 && $7 < 0' | cut -f 1 | sort | uniq  > temp-ad-down.genes
wc -l temp-ad-down.genes

ls ../microglia/HALLMARK*  | grep -v temp | wc -l
ls ../microglia/HALLMARK*  | grep -v temp > temp-f1 
cat AD.nature.2024.aggregated_fullset.Mic_Immune_Mic.tsv | grep  "nrad${tab}allregions" | cut -f 1 |  sort | uniq  > temp-bg-genes
wc -l temp-bg-genes
bash   script-inputset-pathways-overlap-fisher-fdr  temp-ad-down.genes Ctrl-UP.vs.AD temp-f1 temp-bg-genes

echo
echo
echo
bash   script-inputset-pathways-overlap-fisher-fdr  temp-ad-up.genes AD-UP.vs.Ctrl temp-f1 temp-bg-genes

################################################################
cat HD-control-snRNA-mg.deg.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 < 0' | awk '$5 < -0.1' | cut -f 1  | awk 'NR > 1' | sort | uniq > Ctrl-UP.vs.HD
cat AD.nature.2024.aggregated_fullset.Mic_Immune_Mic.tsv | grep  "nrad${tab}allregions" | awk 'BEGIN {FS = "\t"; OFS = "\t"} $4 == 1 && $6 < 0 && $7 < 0' | cut -f 1 | sort | uniq  > temp-ad-down.genes
cat  human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk | sort -t "$tab"  +1 -2g  | awk '$2 < -1.3010' | cut -f 1 > temp-f-bias
wc -l Ctrl-UP.vs.HD temp-ad-down.genes temp-f-bias
     406 Ctrl-UP.vs.HD
     305 temp-ad-down.genes
    1660 temp-f-bias

cat Ctrl-UP.vs.HD ../microglia/HALLMARK_INTERFERON_GAMMA_RESPONSE.genes | sort | uniq -d > temp-Ctrl-UP.vs.HD.infr
cat temp-ad-down.genes ../microglia/HALLMARK_INTERFERON_GAMMA_RESPONSE.genes | sort | uniq -d > temp-Ctrl-UP.vs.AD.infr
      14 temp-Ctrl-UP.vs.HD.infr
      15 temp-Ctrl-UP.vs.AD.infr
cat temp-Ctrl-UP.vs.HD.infr temp-Ctrl-UP.vs.AD.infr | sort | uniq | wc -l
      21 (no chrX/chrY genes)
cat temp-Ctrl-UP.vs.HD.infr temp-Ctrl-UP.vs.AD.infr | sort | uniq -d| wc -l
       8
cat temp-Ctrl-UP.vs.HD.infr temp-Ctrl-UP.vs.AD.infr | sort | uniq -d > temp-both

######################################################################
> f1 <- read.delim("HD-control-snRNA-mg.deg.txt")
 g1 <- scan(what="", sep = "\n")
# figures.xlsx
 g2 <- scan(what="", sep = "\n")
 t1 <- f1[ f1$gene %in% g1, c(1,3,5)]
 t1$overlap="y"
 t2 <- f1[ f1$gene %in% g2, c(1,3,5)]
 t2$overlap="n"
 t3 <- rbind(t1, t2)
 f2 <- read.delim("AD.nature.2024.aggregated_fullset.Mic_Immune_Mic.tsv")
 t4 <- merge(t3, f2, by.x="gene", by.y="gene")
 t5 <- t4[ t4$path == "nrad" & t4$region == "allregions",]
 f3 <- read.delim("human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt")
 t6 <- merge(t5, f3, by.x="gene", by.y="name")
 colnames(t6)
 write.table(t6, "temp.txt", sep="\t")
### figures.xlsx

########################################################cyno RNA-seq
/lab/solexa_page/linyong/cyno-genome/GCF_012559485_plus_Y.fna
/lab/page_genomes/Macaca_fascicularis/genome/assemblies/GCF_012559485_plus_Y/GCF_012559485.2_MFA1912RKSv2_genomic_plus_Y.gtf 

linyong@fry /lab/solexa_public/Page/240703_WIGTC-NOVASEQ1B_BHKL2LDSXC$ ls /lab/solexa_public/Page/240703_WIGTC-NOVASEQ1B_BHKL2LDSXC/FASTQ/*R1_001.fastq.gz | wc
     33      33    3234
linyong@fry /lab/solexa_public/Page/240703_WIGTC-NOVASEQ1B_BHKL2LDSXC$ ls /lab/solexa_public/Page/240703_WIGTC-NOVASEQ1B_BHKL2LDSXC/FASTQ/*R2_001.fastq.gz | wc
     33      33    3234

linyong@fry /lab/solexa_page/linyong/cyno-rna-seq-2024$ cp -i /lab/page_genomes/Macaca_fascicularis/genome/assemblies/GCF_012559485_plus_Y/GCF_012559485.2_MFA1912RKSv2_genomic_plus_Y.gtf ../
linyong@fry /lab/solexa_page/linyong$ vi /lab/solexa_page/linyong/GCF_012559485.2_MFA1912RKSv2_genomic_plus_Y.gtf

######
linyong@fry /lab/solexa_page/linyong$ cat ./slurm-cyno-star-genome-index-151bp
#!/bin/bash
# Configuration values for SLURM job submission.
# One leading hash ahead of the word SBATCH is not a comment, but two are.
#SBATCH --job-name="stargenomeindex" # friendly name for job.
#SBATCH --nodes=1                      # ensure cores are on one node
#SBATCH --ntasks=1                     # run a single task
#SBATCH --cpus-per-task=20              # number of cores/threads requested.
#SBATCH --mem=128gb                      # memory requested.
#SBATCH --partition=20                 # partition (queue) to use
#SBATCH --output star-genome-index-cyno-9-23-359pm   # name of output file.  %j is jobid
#SBATCH --mail-type=ALL               # send email on job start/finish.
#SBATCH --mail-user=linyong@wi.mit.edu

# This is the actual section for commands to run


STAR  --runMode genomeGenerate  --genomeDir /lab/solexa_page/linyong/dir-star-genome-index-cyno-oh150  --genomeFastaFiles /lab/solexa_page/linyong/cyno-genome/GCF_012559485_plus_Y.fna   --sjdbGTFfile /lab/solexa_page/linyong/GCF_012559485.2_MFA1912RKSv2_genomic_plus_Y.gtf   --sjdbOverhang 150 --runThreadN 16
linyong@fry /lab/solexa_page/linyong$ 

####################################################################
linyong@fry /lab/solexa_page/linyong/cyno-rna-seq-2024$ cat slurm-cyno-rna-seq 
#!/bin/bash
# Configuration values for SLURM job submission.
# One leading hash ahead of the word SBATCH is not a comment, but two are.
#SBATCH --job-name="star-map-cyno-rna" # friendly name for job.
#SBATCH --nodes=1                      # ensure cores are on one node
#SBATCH --ntasks=1                     # run a single task
#SBATCH --cpus-per-task=5              # number of cores/threads requested.
#SBATCH --mem=80gb                      # memory requested.
#SBATCH --partition=20                 # partition (queue) to use
#SBATCH --output "out-star-map-cyno-rna-9-24-1209pm"   # name of output file.  %j is jobid
#SBATCH --mail-type=ALL               # send email on job start/finish.
#SBATCH --mail-user=linyong@wi.mit.edu

#

ls /lab/solexa_public/Page/240703_WIGTC-NOVASEQ1B_BHKL2LDSXC/FASTQ/*R1_001.fastq.gz | wc

ls /lab/solexa_public/Page/240703_WIGTC-NOVASEQ1B_BHKL2LDSXC/FASTQ/*R1_001.fastq.gz | head | while read ll
do
 pre=`echo "$ll" | sed 's/R1_001.fastq.gz//' `
 rm Aligned.out.bam

 STAR --runThreadN 4 --outFilterMultimapNmax 20  --genomeDir /lab/solexa_page/linyong/dir-star-genome-index-cyno-oh150  --readFilesIn "$pre"R1_001.fastq.gz "$pre"R2_001.fastq.gz --readFilesCommand zcat   --outSAMtype BAM Unsorted --outSAMunmapped Within --outSAMattributes Standard

 f=`echo "$ll" | sed 's/R1_001.fastq.gz//' | sed 's#/lab/solexa_public/Page/240703_WIGTC-NOVASEQ1B_BHKL2LDSXC/FASTQ/##'  `
 cat Log.final.out > "$f.STAR.log"
 htseq-count  --mode=union --stranded=no --idattr=gene_id --format=bam  --order=name --type=exon  Aligned.out.bam /lab/solexa_page/linyong/GCF_012559485.2_MFA1912RKSv2_genomic_plus_Y.gtf  > "$f.counts_gene"
 htseq-count  --mode=union --stranded=reverse --idattr=gene_id --format=bam  --order=name --type=exon  Aligned.out.bam  /lab/solexa_page/linyong/GCF_012559485.2_MFA1912RKSv2_genomic_plus_Y.gtf  > "$f.stranded.counts_gene"
 htseq-count  --mode=union --stranded=yes --idattr=gene_id --format=bam  --order=name --type=exon  Aligned.out.bam  /lab/solexa_page/linyong/GCF_012559485.2_MFA1912RKSv2_genomic_plus_Y.gtf  > "$f.stranded.same.counts_gene"
 echo -n "un-strand	" >> "$f.STAR.log"
 grep -iw ACTB  "$f.counts_gene" | grep -v ps1 >> "$f.STAR.log"
 echo -n "strand-reverse	" >> "$f.STAR.log"
 grep -iw ACTB  "$f.stranded.counts_gene" | grep -v ps1 >> "$f.STAR.log"
 echo -n "strand-yes	"  >> "$f.STAR.log"
 grep -iw ACTB  "$f.stranded.same.counts_gene" | grep -v ps1 >> "$f.STAR.log"

 rm Aligned.out.bam

done
linyong@fry /lab/solexa_page/linyong/cyno-rna-seq-2024$ 

#################################################################################
linyong@fry /lab/page_human_data/linyong2/temp-dir-01$ ~/C++/reSeqPrintChrRegion.fq /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa  out chrX 73850723  73852723   > xist.dna.1stexon.fa
linyong@fry /lab/page_human_data/linyong2/temp-dir-01$ bwa bwasw  -f xist.dna.1stexon.sam  -t 10  /lab/solexa_page/linyong/cyno-genome/GCF_012559485_plus_Y.fna xist.dna.1stexon.fa
[M::bwa_idx_load_from_disk] read 0 ALT contigs
[bsw2_aln] read 1 sequences/pairs (2001 bp) ...

XIST in cyno   NC_052275.1     69487373Type:transcript gene_id:LOC102139757 transcript_id:XR_001487868.2 db_xref:GeneID:102139757 experiment:COORDINATES: gbkey:ncRNA gene:LOC102139757 model_evidence:Supporting product:uncharacterized transcript_biotype:lnc_RNA

######################################################################################
cd /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22
linyong@fry /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22$ bash  ../script-peak-overlap-6samples  L16_6692
###  linyong@fry /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22$ bedtools intersect -a temp-target.bed -b temp-L16_6723.bed  -wa -wb | head
###  NC_012670.1        15942   16494   L16_6692.mapQ.paired_peak_1     NC_012670.1     16197   16377   L16_6723.mapQ.paired_peak_1
###  NC_052255.1        34907   35536   L16_6692.mapQ.paired_peak_2     NC_052255.1     34933   35423   L16_6723.mapQ.paired_peak_3
###  NC_052255.1        35712   36180   L16_6692.mapQ.paired_peak_3     NC_052255.1     35788   36034   L16_6723.mapQ.paired_peak_4

ls temp-*.overlap -lh | grep "Oct 12" | awk '{print $9}' | wc
     30      30     930
linyong@fry /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22$ cat temp-*.overlap | sed 's/.mapQ.paired_peak_[0-9]*$//' | cut -f 4,8 | sort | uniq | cut -f 1 | uniq -c |  awk '$1 >= 5' |  awk 'BEGIN {OFS = "\t";} {print $2}' > conserved.6samp.6samp.peak.id
wc -l conserved.6samp.6samp.peak.id
179342 conserved.6samp.6samp.peak.id

linyong@fry /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22$ cat temp-s
#
cat L16_6692.mapQ.paired_peaks.xls L16_6701.mapQ.paired_peaks.xls L16_6704.mapQ.paired_peaks.xls L16_6707.mapQ.paired_peaks.xls L16_6720.mapQ.paired_peaks.xls L16_6723.mapQ.paired_peaks.xls | awk 'BEGIN {FS = "\t";} NF > 5' | sort -t '     ' +9 -10 > temp-1

sort +0 -1 conserved.6samp.6samp.peak.id > temp-2

join -t '       ' -1 1 -2 10 temp-2 temp-1 -o "2.1,2.2,2.3,2.10" > conserved.6samp.6samp.peak.coord

wc -l conserved.6samp.6samp.peak.coord conserved.6samp.6samp.peak.id


#####
  179342 conserved.6samp.6samp.peak.coord

linyong@fry /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22$ bash script-gene-bed-2
###using /lab/solexa_page/linyong/GCF_012559485.2_MFA1912RKSv2_genomic_plus_Y.gtf (modified by me)

bedtools intersect -a temp-gene.bed -b conserved.6samp.6samp.peak.coord -wa -wb  > temp.gene.2kbp.peak
cat temp.gene.2kbp.peak | cut -f 4 | sort | uniq -c | wc -l
13476 genes whose promoters overlap with conserv peaks

sort -t '      ' +0 -1 +1 -2n conserved.6samp.6samp.peak.coord > conserved.6samp.6samp.peak.coord.sorted
###  NC_012670.1        15972   16412   L16_6720.mapQ.paired_peak_1
###  NC_012670.1        15974   16393   L16_6707.mapQ.paired_peak_1
###  NC_012670.1        15974   16412   L16_6704.mapQ.paired_peak_1

bedtools merge -d 100 -i   conserved.6samp.6samp.peak.coord.sorted > conserved.6samp.6samp.peak.coord.sorted.merged
29211 conserved.6samp.6samp.peak.coord.sorted.merged

cat conserved.6samp.6samp.peak.coord.sorted.merged |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""}
 {
   print $1 "\t" "macs2" "\t" "peak" "\t"  $2 "\t" $3 "\t" "." "\t" "+"  "\t" "."  "\t" "peak_id=\"" $1 "@@@" $2 "@@@" $3  "\"" "\n";
 }' > conserved.6samp.6samp.peak.coord.sorted.merged.gtf
#  NC_012670.1  macs2   peak    15972   16412   .       +       .       peak_id="NC_012670.1@@@15972@@@16412"

cat ../script-peak-read-count-2
#
ls ../L*.mapQ.paired.bam | awk 'NR > 4' |  while read f
do
 id=`echo "$f" | sed 's/.bam//' | sed 's/..\///' `
 echo "$id"
 ###testing bam sorted by read names
 samtools view "$f" | head -1000000 | cut -f 1 | uniq -d | wc -l
 ## --nonunique=default: none
 htseq-count  --mode=intersection-strict   --stranded=no --idattr=peak_id  --format=bam  --order=name --type=peak "$f"   conserved.6samp.6samp.peak.coord.sorted.merged.gtf > "$id".conserved.6samp.6samp.peaks.readcount


done

cat out-peak-rp-count-1012-245pm | awk 'NF == 1'  | sort | uniq -c
      6 500000
cat temp-s1 > temp-s2
cat temp-s2
#
b=`ls L*.6samp.6samp.peaks.readcount | awk 'NR == 1' `
id=`echo "$b" | sed 's/.mapQ.paired.conserved.6samp.6samp.peaks.readcount//'`
echo "peak      $id" > s
cat "$b" >> s

ls  L*.6samp.6samp.peaks.readcount  | awk 'NR > 1' | while read f
do
 id=`echo "$f" | sed 's/.mapQ.paired.conserved.6samp.6samp.peaks.readcount//'`
 echo "$id" > f2
 cut -f 2 "$f" >> f2
 paste s f2 > m
 mv m s
done

linyong@fry /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22$
vi s
mv -i s  cyno-atac-mg-6samp-conserv6.readcount
paste L*.6samp.6samp.peaks.readcount | awk '$1 != $3' | head -20
paste L*.6samp.6samp.peaks.readcount | awk '$1 != $11' | head -20
linyong@fry /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22$ cat temp-s3
#

cat cyno-atac-mg-6samp-conserv6.readcount | awk 'BEGIN {FS = "\t";}
{
 if(NR == 1)
   print $0;
 else
  {
   t=0;
   for(i = 2; i < 8; i++)
   {
    if($i >= 6)
      t++;
   }  
   if((t>= 3))
     print $0; 
  }
}
'

linyong@fry /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22$ wc -l cyno-atac-mg-6samp-conserv6.readcount*
  29212 cyno-atac-mg-6samp-conserv6.readcount
  29211 cyno-atac-mg-6samp-conserv6.readcount.filt

> setwd("../autism/")
  t <- read.delim("cyno-atac-mg-6samp-conserv6.readcount.filt", row.names=1)
 rawCount <- t
 group <- factor(rep(1, 6))
 y <- DGEList(counts=rawCount,group=group)
 y <- calcNormFactors(y)

###
$samples
         group lib.size norm.factors
L16_6692     1 10737223    1.0642708
L16_6701     1 14750574    0.9898500
L16_6704     1  3350929    1.1853365
L16_6707     1 14721931    1.0563823
L16_6720     1 11925351    0.8863467
L16_6723     1 22163906    0.8552874
###

 d = cpm(y)
 a <- log10(d+1)
 a.df <- as.data.frame(a)
 c1 <- as.data.frame(cor(a.df))
 summary(c1)
 dim(y)
#  [1] 29210     6
t1 <- data.frame(id = rownames(a.df), var = a.df[,1])
for(i in 1:dim(a.df)[1])
{
 t1$var[i] = var(as.numeric(a.df[i,]))
}

 info <- data.frame(sex = c(0,1,0,1,0,1))
t1$sex.cor = -999
for(i in 1:dim(a.df)[1])
{
  d1 <-  data.frame(y = t(a.df[i,]), sex = info$sex )
  d2 <-  lm(d1[,1] ~ d1$sex)
  d3 <- summary(d2)
  t1$sex.cor[i] = d3$r.squared
}

 sum(t1$var * t1$sex.cor) / sum(t1$var)
#  [1] 0.1285352

> design <- model.matrix( ~ info$sex)
  y <- estimateDisp(y,design)
  fit <- glmQLFit(y, design)
  qlf <- glmQLFTest(fit, coef=2)
  top2v1 <- topTags(qlf, n = 91234)
 head(top2v1)
> write.table(top2v1, "temp", quote=F, sep="\t")

cat script-gene-bed-2 > script-gene-bed-3

bash script-gene-bed-3
vi temp-gene.bed
head temp-gene.bed
NC_052255.1     7616    11616   +       9616    14912   LOC123572819
NC_052255.1     18645   22645   -       19115   20645   LOC102116409
NC_052255.1     33558   37558   -       32432   35558   LOC123572833

cat temp-gene.bed | awk '{print NF}' | uniq -c | head
  35591 7
bedtools intersect -a conserved.6samp.6samp.peak.coord.sorted.merged -b temp-gene.bed -wa -wb > temp
cat temp |  awk 'BEGIN {FS = "\t"; OFS = "\t";}
{
 print $1 "@@@" $2 "@@@"  $3, $0
}' > conserved.6samp.6samp.peak.coord.sorted.merged-gene-intersect

linyong@fry /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22$ cat ../dir-macs2-defalt-param/chrom.sizes
NC_012670.1     16575
Ycons   11253475
NC_052275.1     149803873

> top.df <- as.data.frame(top2v1)
 top.df$id <- rownames(top.df)
 t1 <- read.delim("conserved.6samp.6samp.peak.coord.sorted.merged-gene-intersect", header=F)
 top.df.2 <- merge(top.df, t1, by.x="id", by.y="V1")
 dim(top.df.2)
#  [1] 14258    16
> t2 <-top.df.2[ top.df.2$V11 %in% g1, c(1,2,5,16,10, 14,15,13 )]

> t2 <-top.df.2[ top.df.2$logFC > log2(1.5) & top.df.2$PValue < 0.05, ]
> dim(t2)
[1] 50 16
> write.table(t2, "temp", quote=F, sep="\t")

############################################################################################################
linyong@fry /lab/solexa_page/linyong/cyno-rna-seq-2024$ head -20 L*.STAR.log | grep "==>" | awk '{print $2}' | sed 's/_S.*//'
cat script-paste-count
#

b=`ls L*.stranded.counts_gene | awk 'NR == 1' `
id=`echo "$b" | sed 's/_S.*//'`
echo "peak      $id" > s
cat "$b" >> s

ls  L*.stranded.counts_gene  | awk 'NR > 1' | while read f
do
 id=`echo "$f" | sed 's/_S.*//'`
 echo "$id" > f2
 cut -f 2 "$f" >> f2
 paste s f2 > m
 mv m s
done

linyong@fry /lab/solexa_page/linyong/cyno-rna-seq-2024

 mv -i s cyno-33samp-rnaseq-oct-2024.gene.counts.txt
vi cyno-33samp-rnaseq-oct-2024.gene.counts.txt
ls  L*.stranded.counts_gene  | awk 'NR > 1' | while read f; do paste L16_7217_S43_L002_.stranded.counts_gene "$f" | awk '$1 != $3' |head; done

setwd("~/Documents/autism/")
raw <- read.delim("cyno-33samp-rnaseq-oct-2024.gene.counts.txt")
raw.samp <- raw[, 2:34]
rownames(raw.samp) <- raw[,1]
dim(raw.samp)
summary( raw.samp[,1] - raw[, 2]  )
y <- DGEList(counts=raw.samp)
y <- calcNormFactors(y)
dim(y)
 summary(y$samples$norm.factors)
#     Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
#   0.8941  0.9531  0.9923  1.0018  1.0490  1.1156

###########################################################################
oct 19, 2024

> sessionInfo()
R version 4.4.1 (2024-06-14)
Platform: x86_64-apple-darwin20
Running under: macOS Ventura 13.2.1

other attached packages:
 [1] ggrepel_0.9.5         Matrix.utils_0.9.8    Matrix_1.7-0          vioplot_0.5.0         zoo_1.8-12            sm_2.2-6.0            MASS_7.3-61          
 [8] ggplot2_3.5.1         patchwork_1.2.0       Seurat_5.1.0          SeuratObject_5.0.2    sp_2.1-4              dplyr_1.1.4           circlize_0.4.16      
[15] edgeR_4.2.1           limma_3.60.3          beeswarm_0.4.0        ComplexHeatmap_2.20.0

##############################################################################
> t1 <- read.delim("cyno-atac-mg-10samp-conserv10.6samplesOnly.age.covar.diff2-1.txt")
 df.gene.old <- t1[ t1$V2 == "NC_052275.1",]
 t2 <- df.gene.old[1,]
 t2$PValue = 0.045
 t2$logFC = -0.7
 t2$V1 = "PValue=0.05"
 t3 <- df.gene.old[ df.gene.old$PValue < 0.1, ]

ggplot(df.gene.old, aes(x=logFC, y = -log10(PValue), label = gsub("gene_id ", "", V1) ) ) + geom_point(shape=21, size=1)  + labs( x = "log2FC (F vs. M)") + geom_hline(yintercept=-log10(0.05), col="blue") + geom_text(data=t2, col="blue") + geom_text_repel(show.legend=T, data=t3 , size=2.2, max.overlaps=100, min.segment.length = 0.1, col="red")   

t1 <- read.delim("cyno-atac-mg-10samp-conserv10.6samplesOnly.age.covar.oct24.diff2-1.txt")
 df.gene <- t1[ t1$V2 == "NC_052275.1",]
 t2 <- df.gene[1,]
 t2$PValue = 0.045
 t2$logFC = -0.7
 t2$V1 = "PValue=0.05"
 t3 <- df.gene[ df.gene$PValue < 0.1, ]

gplot(df.gene, aes(x=logFC, y = -log10(PValue), label = gsub("gene_id ", "", V1) ) ) + geom_point(shape=21, size=1)  + labs( x = "log2FC (F vs. M)") + geom_hline(yintercept=-log10(0.05), col="blue") + geom_text(data=t2, col="blue") + geom_text_repel(show.legend=T, data=t3 , size=2.2, max.overlaps=100, min.segment.length = 0.1, col="red")    

##############################################################################
linyongmao@Linyong-Mao-MBP16-2019 autism % cat GCF_012559485.2_MFA1912RKSv2_genomic_plus_Y.gtf| awk 'BEGIN {FS = "\t"; OFS = "\t"} $3 == "gene" ' |cut -f 1,4,5,7,9  > temp1
cat temp1 | cut -f 5 | sort | uniq -c | awk '$1 > 1' |head
   2 CDY
   2 RBMY
cat temp1 |  cut -f 5 | sort | uniq > temp2
cat cyno-33samp-rnaseq-oct-2024.gene.counts.txt | cut -f 1|sort | uniq > temp3
cat temp2 temp3 | sort | uniq -d | wc -l
   30535
wc -l temp2 temp3
   35589 temp2
   30538 temp3
cat temp2 temp3 | sort | uniq -d > temp4
cat temp3 temp4 | sort | uniq -u 
RBMY1   Ycons   geneblast       mRNA    6271572 6284072 .       -       .       gene_id "RBMY1";
XKRY    Ycons   geneblast       exon    7641599 7672456 .       -       .       gene_id "XKRY"; gene_source "testis RNA-seq SRR8474208"
peak

cat temp2 temp4 | sort | uniq -u 
cat temp2 temp4 | sort | uniq -u | head
AOX3P
CYP2A27P
HTR3D
IRGMP
LOC102114770
LOC102114771
LOC102114778
cat temp2 temp4 | sort | uniq -u | tail
LOC123575553
LOC123575554
LOC123575555
VHLL
NC_052266.1     Curated Genomic gene    85564609        85636450        .       +       .       gene_id "AOX3P"; transcript_id ""; db_xref "GeneID:102131887"; description "aldehyde oxidase 3 pseudogene"; gbkey "Gene"; gene "AOX3P"; gene_biotype "pseudogene"; pseudo "true";
"AOX3P" no exon info, pseudogene

linyongmao@Linyong-Mao-MBP16-2019 autism % mv -i temp1 GCF_012559485.2_MFA1912RKSv2_genomic_plus_Y.chr.coord.id

#####################################################################################################
> t1 <- read.delim("cyno-33samp-rnaseq-oct-2024.info.1")
 t2 <-unique( t1[, c(2,4,6)])
 dim(t2)
#  [1] 10  3
 t2$age <- 0
 t2$age <- c(18 + 23/365, 10+5/12 , 3+7/12 , 3+7/12, 3+9/12, 4+10/12, 4+1/12, 4+2/12, 3+2/12, 4+1/12)
 t2
 t3 <- t2[ t2$age < 5,]
 dim(t3)
#  [1] 8 4
 boxplot(t3$age ~ t3$Sex, outcol="white")
 beeswarm(t3$age ~ t3$Sex, add=T, cex=1.6, col="red")
 t4 <- merge(t1, t2, by.x="Animal.ID", by.y="Animal.ID")
 t5 <- read.delim("cyno-33samp-rnaseq-oct-2024.mapping.1")
 t6 <- merge(t4, t5, by.x="FASTQ.ID", by.y="sample")
 dim(t6)
#  [1] 33 16
 t7 <- t6[ t6$age < 10,]
 t8 <- t7[, c(10,11,15)]
 boxplot(t8, outcol="white", ylab="read pairs", main="28 samples with age < 5")
 beeswarm(t8, add=T)
 abline(h = seq(4e7, 40e7, 1e7), lty = 5, lwd = 0.5, col = "gray")
 summary(t6$age)
#     Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
#    3.167   3.750   4.083   5.395   4.833  18.063

 info <- t7
 r1 <- read.delim("cyno-33samp-rnaseq-oct-2024.gene.counts.txt")
 r2 <- r1[, colnames(r1) %in% info$FASTQ.ID]
 dim(r2)
#  [1] 30537    28
 rownames(r2) <- r1[, 1]
 y <- DGEList(counts=r2)
 y <- calcNormFactors(y)
med <- data.frame(y$counts[,1])
med$logic <- TRUE
d <- cpm(y)
for(i in 1:dim(y)[1]) {
 med$logic[i] <- median(d[i,]) >= 0.1
}
####median >= 1 for pathway genes
y<-y[med$logic,]
print(dim(y))
#  [1] 15033    28
d = cpm(y)
a <- log10(d+1)
a.df <- as.data.frame(a)
a.df[1:6,1:6]

 t1 <- read.delim("GCF_012559485.2_MFA1912RKSv2_genomic_plus_Y.chr.coord.id", header=F)
 t2 <- t1[ t1$V1 == "NC_052275.1" | t1$V1 == "Ycons",]
 a.df.2 <- a.df[!(rownames(a.df) %in% t2$V5),]
 dim(a.df.2)
#  [1] 14422    28
 r3 <- t(a.df.2)
 pca <- prcomp(r3, center = TRUE, scale. = TRUE)
 boxplot(pca$x[,1:20])
 s <- summary(pca)
 s$importance[,1:10]
#                              PC1      PC2      PC3      PC4      PC5      PC6
#  Standard deviation     52.26151 47.64917 41.43746 39.12836 37.11105 32.68347
#  Proportion of Variance  0.18938  0.15743  0.11906  0.10616  0.09550  0.07407
#  Cumulative Proportion   0.18938  0.34681  0.46587  0.57203  0.66752  0.74159
 p1 <- as.data.frame( pca$x[,1:2])
 p1$id <- rownames(p1)
 identical(info$FASTQ.ID, p1$id)
#  [1] TRUE
 info$pc1 <- p1$PC1
 info$pc2 <- p1$PC2
gplot(info, aes(x=pc1, y = pc2, color = Animal.ID, shape= Sex.x)) + geom_point(size=3) + labs(y="PC2 (15.7%)", x="PC1 (18.9%)") 

 g1 <- c("ACTB" ,   "ITGAM",   "P2RY12" , "TMEM119" ,"CX3CR1",  "CCR2" ,   "CD3D"  ,  "MS4A1" )
 a.df.3 <- a.df.2[ rownames(a.df.2) %in% g1,]
 t4 <- as.data.frame( t(a.df.3))
 t5 <- data.frame( t4$ACTB, t4$ITGAM, t4$P2RY12, t4$TMEM119, t4$CX3CR1, t4$CCR2, t4$CD3D, t4$MS4A1 )
 colnames(t5) <- gsub("t4.", "", colnames(t5))
 rownames(t5) <- rownames(t4)
 boxplot(t5, outcol = "white", ylab = "log10(cpm+1)")
 beeswarm(t5, add=T, cex = 0.6, col = "red" )
 abline(h = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
 abline(h = seq(-100, 100, 1/2), lty = 5, lwd = 0.5, col = "gray")

 boxplot(t4$CX3CR1, outcol = "white", ylab = "log10(cpm+1)", xlab="CX3CR1")
 beeswarm(t4$CX3CR1,  add=T, cex = 1.5, col = "red")
 abline(h = seq(-100, 100, 1/2), lty = 5, lwd = 0.5, col = "gray")
 t4$ratio <- (10^(t4$CX3CR1) - 1) / (10^(t4$CCR2) - 1)
 boxplot(log2(t4$ratio), outcol = "white", ylab = "log2FC(CX3CR1 : CCR2)", xlab="")
beeswarm(log2(t4$ratio),add=T, cex = 1.5, col = "red")
 abline(h = seq(-1000, 1000, 1), lty = 5, lwd = 0.5, col = "gray")

 t4$ratio.ms <- (10^(t4$CX3CR1) - 1) / (10^(t4$MS4A1) - 1)
 identical(info$FASTQ.ID, rownames(t4))
#  [1] TRUE
 info$ratio <- t4$ratio
 info$ratio.ms <- t4$ratio.ms

 ggplot(info, aes(x=pc1, y = pc2, size = log2(ratio), color = Animal.ID, label=round(ratio, digits=0)))  + labs(y="PC2 (15.7%)", x="PC1 (18.9%)") + geom_point() + geom_text_repel(show.legend=F, data=info , size=2.2, max.overlaps=100, min.segment.length = 0.1, col="black")

 plot(log2(t4$ratio), log2(t4$ratio.ms), xlab="log2(CX3CR1/CCR2)", ylab="log2(CX3CR1/MS4A1)")
  abline(h = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
  abline(v = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
 m1 <- as.data.frame (cor(a.df.2))
 dim(a.df.2)
#  [1] 14422 autosomal genes,   28
 identical(rownames(m1), info$FASTQ.ID)
#  [1] TRUE
 donor <- c("red", "green", "blue", "yellow", "white", "black", "grey", "orange")
 names(donor) <- unique(info$Animal.ID)
 col.ra.cc <- colorRamp2(c(4,8), c("white", "red"))
 ca <- HeatmapAnnotation( sex = info$Sex.x, donor=info$Animal.ID, ra.CC = log2(info$ratio), ra.MS = log10(info$ratio.ms), which="row",  col=list(donor=donor, ra.CC = col.ra.cc, sex=c("XX"="red", "XY"="blue")))
 Heatmap(m1, name="correlation", right_annotation=ca)

> raw <- read.delim("human_Microglia_RNA-18samp.gene.count.stranded.txt")
 raw.samp <- raw[, c(6:7,8,9:18, 19,20)]
 dim(raw.samp)
#  [1] 62703    15
 rownames(raw.samp) <- raw$geneID
y <- DGEList(counts=raw.samp)
y <- calcNormFactors(y)
dim(y)
 d <- log10(cpm(y) + 1)
df <- as.data.frame(d)
df.2 <- df
gene.name <- raw[, 1:2]
df.2$geneID <- rownames(df.2)
df.gene <- merge(df.2, gene.name, by.x="geneID", by.y="geneID")
 g1 <- c("ACTB" ,   "ITGAM",   "P2RY12" , "TMEM119" ,"CX3CR1",  "CCR2" ,   "CD3D"  ,  "MS4A1" )
 df.gene.filt <-  df.gene[ df.gene$name %in% g1,]
 rownames(df.gene.filt) <- df.gene.filt$name
 t4 <- as.data.frame( t(df.gene.filt[, 2:16]))
 dim(t4)
#  [1] 15  8
  t5 <- data.frame( t4$ACTB, t4$ITGAM, t4$P2RY12, t4$TMEM119, t4$CX3CR1, t4$CCR2, t4$CD3D, t4$MS4A1 )
  colnames(t5) <- gsub("t4.", "", colnames(t5))
  rownames(t5) <- rownames(t4)
 t5.human <- t5
 identical(colnames(t5.cyno), colnames(t5.human))
#  [1] TRUE
 li <- list()
# 1,2,3,4,5,6
# 1,2,3,4,5,6
# 1,1,2,2,3,3,4,4,5,5,6,6
# 1,3,5,7,9,11
for( i in seq(1,dim(t5.human)[2] * 2, 2)) {
 li[[i]] = t5.cyno[,(i+1)/2]
 li[[i+1]] = t5.human[, (i+1)/2]
 }
length(li)
#  [1] 16
 boxplot(li, ylab = "log10(cpm+1)",  xaxt="n", col = c("grey", "red"), outcol = c("black", "red"))
 axis(1, at = seq(1,15,2), labels= colnames(t5.human), las = 1, cex.axis = 0.8)
 abline(h = seq(-100, 100, 1/2), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(2.5, 14.5, 2), lty = 5, lwd = 0.5, col = "blue")
 legend(0.5, 1.5, legend=c("cyno microglia", "human microglia"), pch = 22, cex = 1, pt.bg = c("grey", "red"), pt.cex = 2, bg = "white")
#cex font size of the text "cyno micr"
#pt.cex     shape(rectangle) size
#bg="white"  
 l2 <- list()
 l2[[1]] <- log2( (10^(t5.cyno$CX3CR1)-1) / (10^(t5.cyno$CCR2)-1) )
 l2[[2]] <- log2( (10^(t5.human$CX3CR1)-1) / (10^(t5.human$CCR2)-1) )
# inf -> 16
 l2[[2]][1] = 16

 names(l2) <- c("cyno", "human")
 boxplot(l2, ylab="log2FC(CX3CR1 / CCR2)", col=c("grey", "red"), outcol="white")
 beeswarm(l2, add=T, col=c("black", "black"), cex=1.6 )
 abline(h = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")

################################################################################################
 mg.cx = 2^11 -1
#  [1] 2047
 mg.cc = 2^2.5-1
#  [1] 4.656854
 mo.cx=2^7-1
#  [1] 127
 mo.cc = 2^8.5 -1
#  [1] 361.0387
 t1 <- data.frame(f1=seq(5e-5, 0.5, 1e-5))
 t1$f2 <- 1-t1$f1
 t1$cx3cr1 <- mo.cx * t1$f1 + mg.cx * t1$f2
 t1$ccr2 <- mo.cc * t1$f1 + mg.cc * t1$f2
 t1$ratio <- t1$cx3cr1 / t1$ccr2
 head(t1, n=20)
#          f1      f2   cx3cr1     ccr2    ratio
#  1  0.00005 0.99995 2046.904 4.674673 437.8710
#  2  0.00006 0.99994 2046.885 4.678237 437.5334
#  3  0.00007 0.99993 2046.866 4.681801 437.1962
 tail(t1, n=20)
#             f1      f2   cx3cr1     ccr2    ratio
#  49994 0.49998 0.50002 1087.038 182.8406 5.945278
#  49995 0.49999 0.50001 1087.019 182.8442 5.945057
#  49996 0.50000 0.50000 1087.000 182.8478 5.944836
 plot(t1$f1, log2(t1$ratio), xlab="ccr2 fraction", ylab="log2(cx3cr1/ccr2)")
  abline(h = seq(-100, 100, 1/2), lty = 5, lwd = 0.5, col = "gray")
  abline(v = seq(0,1,0.02), lty = 5, lwd = 0.5, col = "grey")
######################################################
> mg.cx = 10^3.5
 mo.cx = 10^3.5
 mg.cc = 0.18356 ###median of 15 human mg ccr2 cpm; they are all high purity
 ### t4.450pm, 28 cyno mg bulk RNA-seq
 ### t5, have mixed with monocyte, assume 20% of monocyte based on the curve of log2(cx3cr1/ccr2) ~ ccr2 fraction
 t5 <- t4.450pm[ t4.450pm$ratio <= 32,]
 ### Median of t5$ccr2
 mo.cc <- 111.98/0.2

###################################################################################################################
> print(dim(y))
[1] 15033    28
> identical(colnames(y), info$FASTQ.ID)
[1] TRUE
 design <- model.matrix( ~ info$Sex.x + info$age + info$Animal.ID)
# 9 variables, 8 monkeys, 8*4 - 2 - 2 = 28
> y <- estimateDisp(y,design)
Error in glmFit.default(sely, design, offset = seloffset, dispersion = 0.05,  : 
  Design matrix not of full rank.  The following coefficients not estimable:
 info$Animal.IDN-FA4306 info$Animal.IDV220142
 design <- model.matrix( ~ info$Sex.x + info$age + info$Animal.ID)
 d1 <- as.data.frame(design)
 colnames(d1) <- gsub("info\\$", "", colnames(d1))
> l1 <- lm(d1$"Animal.IDN-FA4306" ~ d1$Sex.xXY + d1$age + d1$Animal.ID3552764464 + d1$Animal.ID5071 + d1$Animal.ID5430 + d1$Animal.ID6411814342 + d1$Animal.ID8074406366)
> summary(l1)
Multiple R-squared:      1,	Adjusted R-squared:      1 
l1 <- lm(d1$Animal.IDV220142 ~ d1$Sex.xXY + d1$age + d1$Animal.ID3552764464 + d1$Animal.ID5071 + d1$Animal.ID5430 + d1$Animal.ID6411814342 + d1$Animal.ID8074406366)
summary(l1)
Multiple R-squared:      1,	Adjusted R-squared:      1 

 
> identical(colnames(y), info$FASTQ.ID)
 design <- model.matrix( ~ info$Sex.x + info$age + info$Animal.ID)
 d1 <- as.data.frame(design)
 colnames(d1) <- gsub("info\\$", "", colnames(d1))
 design <- model.matrix(~ d1$Sex.xXY + d1$age +  d1$Animal.ID3552764464 + d1$Animal.ID5071 + d1$Animal.ID5430 + d1$Animal.ID6411814342 + d1$Animal.ID8074406366 )
 y <- estimateDisp(y,design)
using 28 cyno RNA-seq samples with ages < 5
               logFC   logCPM            F       PValue          FDR  geneID
ZFX     -0.637892795 4.273633 41.323883826 9.918657e-07 0.0000115587     ZFX
KDM5C   -0.374251366 5.929103 17.302397719 3.287771e-04 0.0016200764   KDM5C
SLC25A6  0.396679262 9.289789 16.477689184 4.257421e-04 0.0020126354 SLC25A6
KDM6A   -0.383891338 4.732303 15.456735642 5.910185e-04 0.0026665011   KDM6A
USP9X   -0.292293780 6.605873  4.507019046 4.383956e-02 0.0955268946   USP9X
RBBP7   -0.092018518 6.330361  1.891316328 1.812589e-01 0.2948988049   RBBP7
DLG3     0.362863443 1.156192  1.370490939 2.528171e-01 0.3796423970    DLG3
CDK16    0.072334167 4.743852  0.684108689 4.160045e-01 0.5493495211   CDK16
DDX3X    0.034651006 8.673167  0.307519969 5.841359e-01 0.6998178533   DDX3X
BCOR    -0.071322611 5.613166  0.157015105 6.952831e-01 0.7887850930    BCOR
SMC1A    0.005479371 5.958991  0.001767982 9.667951e-01 0.9802209990   SMC1A

 info$ratio <- t4$ratio
 f1 <- info[ info$ratio > 32,]$FASTQ.ID
 length(f1)
#  [1] 18 samples 
......
  r2 <- r1[, colnames(r1) %in% f1]
 dim(r2)
#  [1] 30537    18
......
> print(dim(y))
[1] 14923    18
 info.2 <- info[ info$FASTQ.ID %in% f1,]
 identical(colnames(y), info.2$FASTQ.ID)
#  [1] TRUE
 design <- model.matrix( ~ info.2$Sex.x + info.2$age + info.2$Animal.ID)
 d1 <- as.data.frame(design)
 colnames(d1) <- gsub("info.2\\$", "", colnames(d1))
 design <- model.matrix(~ d1$Sex.xXY + d1$age + d1$Animal.ID5430 + d1$Animal.ID6411814342 + d1$Animal.ID8074406366)
 identical(d1$age, info.2$age)
#  [1] TRUE
 t1 <- data.frame(d1$Sex.xXY, info.2$Sex.x)
 t1[ t1$d1.Sex.xXY == 0,]
 unique(t1[ t1$d1.Sex.xXY == 0,])

y <- estimateDisp(y,design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, coef=2)
top2v1 <- topTags(qlf, n = 91234)
 write.table(top2v1, "diff2-1.txt", sep="\t", quote = F)
diff <- as.data.frame(top2v1)
diff$geneID <- rownames(diff)
using 18 cyno RNA-seq samples with ages < 5 && CX3CR1/CCR2 ratio > 32
3 XX monkeys & 3 XY monkeys

             logFC   logCPM           F       PValue          FDR  geneID
ZFX     -2.6261974 4.466991 32.19888072 3.004003e-05 0.0003172593     ZFX
SLC25A6  2.3065303 9.257460 23.14068762 1.740829e-04 0.0013288180 SLC25A6
KDM5C   -1.1057100 6.069906  4.92199400 4.077320e-02 0.1011624611   KDM5C
SMC1A   -1.5227002 6.071394  4.26767491 5.482162e-02 0.1269163976   SMC1A
KDM6A   -0.7940600 4.826618  2.82684805 1.114195e-01 0.2155449264   KDM6A
DLG3    -2.3566005 1.035716  2.41098307 1.394566e-01 0.2550069066    DLG3
DDX3X   -0.5060345 8.604289  2.36951475 1.425732e-01 0.2594026142   DDX3X
CDK16    0.4833024 4.779311  0.93068489 3.485327e-01 0.4959619527   CDK16
USP9X   -0.4632183 6.689221  0.40601223 5.326926e-01 0.6649411218   USP9X
RBBP7   -0.1415194 6.406427  0.15088427 7.026294e-01 0.8029819786   RBBP7
BCOR    -0.2172755 5.728830  0.04215405 8.398235e-01 0.9006601704    BCOR

using 18 cyno RNA-seq samples with ages < 5 && CX3CR1/CCR2 ratio > 32
$design
  (Intercept) d1$Sex.xXY   d1$age
              logFC   logCPM           F       PValue          FDR  geneID
ZFX     -0.89179779 4.467237 55.86508658 6.346877e-07 0.0001503404     ZFX
KDM6A   -0.61112049 4.826850 45.85997970 2.406725e-06 0.0003702635   KDM6A
KDM5C   -0.47871969 6.069908 24.32596290 1.074269e-04 0.0042768379   KDM5C
USP9X   -0.63314625 6.689286 24.01700874 1.150169e-04 0.0044351332   USP9X
DDX3X   -0.38707072 8.604288 16.89457989 6.564826e-04 0.0123379528   DDX3X
SLC25A6  0.46156085 9.257450 10.45748339 4.604917e-03 0.0402928749 SLC25A6
SMC1A   -0.43975186 6.071449  8.10459738 1.070071e-02 0.0675763944   SMC1A
CDK16   -0.13636283 4.779291  1.80156233 1.962024e-01 0.3874382475   CDK16
DLG3    -0.26782612 1.023168  0.22361744 6.419864e-01 0.7833154269    DLG3
RBBP7    0.01988550 6.406379  0.05301327 8.204959e-01 0.9003794352   RBBP7
BCOR    -0.04589084 5.728955  0.04881779 8.276192e-01 0.9046982504    BCOR

identical(colnames(y), info.2$FASTQ.ID)
#  [1] TRUE
# no intercept, no age as covariant
design <- model.matrix( ~  0 + info.2$Animal.ID)
y <- estimateDisp(y,design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, contrast= c(-1/3, -1/3, 1/3, 1/3, 1/3, -1/3) )

              logFC   logCPM            F       PValue          FDR  geneID
ZFX     -0.92310927 4.466991 151.06889886 9.343185e-10 7.619036e-08     ZFX
KDM6A   -0.73287354 4.826618  92.92062324 3.287321e-08 1.229491e-06   KDM6A
DDX3X   -0.34590442 8.604289  42.73743392 5.709974e-06 7.567490e-05   DDX3X
KDM5C   -0.47418270 6.069906  34.82364783 1.923292e-05 2.050092e-04   KDM5C
USP9X   -0.62297087 6.689221  28.76746370 5.595526e-05 4.796211e-04   USP9X
SLC25A6  0.38848136 9.257460  25.37343742 1.088654e-04 8.231113e-04 SLC25A6
CDK16   -0.22055874 4.779311   7.51403866 1.414432e-02 4.019722e-02   CDK16
SMC1A   -0.29955799 6.071394   6.27061028 2.303574e-02 5.906570e-02   SMC1A
DLG3    -0.47815699 1.035716   2.82016347 1.119218e-01 1.989529e-01    DLG3
BCOR    -0.07371434 5.728830   0.18524177 6.724437e-01 7.652978e-01    BCOR
RBBP7    0.01314820 6.406427   0.04931479 8.269695e-01 8.812580e-01   RBBP7

  identical(colnames(y), info.2$FASTQ.ID)
 #  [1] TRUE
  design <- model.matrix( ~ info.2$Sex.x + info.2$age )
 fit <- voomLmFit(y, design, block=info.2$Animal.ID, plot=TRUE)
 fit <- eBayes(fit)
 topTable(fit, coef="info.2$Sex.xXY")
 t1 <- as.data.frame(topTable(fit, coef="info.2$Sex.xXY", number=91234))
              logFC   AveExpr           t      P.Value  adj.P.Val          B
ZFX     -0.88877200 4.3757643 -4.25641965 0.0004190636 0.07680536 -0.2376914
KDM6A   -0.62431724 4.7667112 -3.25240875 0.0041532763 0.22549278 -2.5093340
DDX3X   -0.39353050 8.5851987 -2.63542355 0.0162208134 0.36787720 -3.8579825
KDM5C   -0.47162994 6.0415677 -2.22082142 0.0385994841 0.48939686 -4.6597897
SLC25A6  0.48372965 9.2173109  2.15231459 0.0443141602 0.51543275 -4.7698767
USP9X   -0.64542214 6.6384755 -2.13973096 0.0454441391 0.52222210 -4.8170687
DLG3    -0.65692955 0.4523541 -0.72637011 0.4763851746 0.90262125 -5.7201908
SMC1A   -0.44573196 6.0252588 -1.36557953 0.1878759556 0.76090563 -6.0137153
CDK16   -0.14228235 4.7598592 -0.69162935 0.4974589426 0.90727543 -6.6309445
BCOR    -0.09824431 5.6766676 -0.21197210 0.8343654823 0.97532620 -6.9087464
RBBP7    0.01474879 6.3989385  0.09386111 0.9261932381 0.98918577 -6.9473626

> print(dim(y))
[1] 14923    18
median(d[i,]) >= 0.1
using 18 cyno RNA-seq samples with ages < 5 && CX3CR1/CCR2 ratio > 32
3 XX monkeys & 3 XY monkeys
>  t1 <- as.data.frame(topTable(fit, coef="info.2$Sex.xXY", number=91234))
> rna.block <- t1
 rna.block$geneID <- rownames(rna.block)
 t1 <- read.delim("cyno-atac-mg-10samp-conserv10.6samplesOnly.age.covar.oct24.diff2-1.txt")
 df.gene <- t1[ t1$V2 == "NC_052275.1",]
 dim(df.gene)
#  [1] 286  11
 df.gene$gene <- gsub("gene_id ", "", df.gene$V1)
 t2 <- merge(df.gene, rna.block, by.x="gene", by.y="geneID")
 dim(t2)
#  [1] 260  18
 t3 <- t2[t2$logFC.x > 0.5 | t2$logFC.x < -0.5 | t2$logFC.y > 1 | t2$logFC.y < -1,]
 dim(t3)
#  [1] 53 18
 gplot(t2, aes(x = logFC.x, y = -logFC.y, label = gene)) +   geom_point(shape=21, size=1) + labs(x="open chromatin log2 FC (F vs. M)" , y="gene expression log2 FC (F vs. M)") + geom_hline(yintercept=0, col="black") + geom_vline(xintercept=0) + geom_text_repel(show.legend=T, data=t3 , size=2, max.overlaps=100, min.segment.length = 0.1, col="red")

######
> mean(y$samples$lib.size)
[1] 73974787
> mean(y$samples$norm.factors)
[1] 1.001162
> saveRDS(y, "cyno-18samp-14923g.rds")
-rw-r--r--  1 linyongmao  staff   628K Nov 20 13:12 cyno-18samp-14923g.rds

> y <- readRDS("cyno-18samp-14923g.rds")
 info.2 <- read.table("cyno-18samp-rnaseq-oct-2024.info.2.txt", header=T, sep="\t")
cor.test(y$samples$lib.size , info.2$lib.size)
 identical(colnames(y), info.2$FASTQ.ID)
design <- model.matrix( ~ info.2$Sex.x + info.2$age )
 logy <- log2(as.data.frame(edgeR::cpm(y)) + 0.5)
 dupcor <- duplicateCorrelation(logy,design,block=info.2$Animal.ID)
 dupcor$consensus.correlation
#  [1] 0.6701205
fit <- lmFit(logy,design,block=info.2$Animal.ID,correlation=dupcor$consensus)
fit <- eBayes(fit)
 topTable(fit,coef=2)
 t1 <- as.data.frame(topTable(fit, coef="info.2$Sex.xXY", number=91234))
###derived from voomLmFit pipeline
t1.vlf
 t1.vlf$id <- rownames(t1.vlf)
 t1$id <- rownames(t1)
         id      logFC  AveExpr         t     P.Value adj.P.Val
2560  DDX3X -0.3948391 8.587075 -2.448440 0.024567748 0.4225018
4982  KDM5C -0.4667628 6.052526 -2.076905 0.052066725 0.5501950
4984  KDM6A -0.6042588 4.793672 -2.956281 0.008303508 0.2915592
14007 USP9X -0.6378822 6.645855 -2.006858 0.059674231 0.5750747
14462   ZFX -0.8442531 4.411410 -3.855879 0.001117443 0.1089908

t2 <- merge(t1.vlf, t1, by.x="id", by.y="id")
 dim(t2)
#  [1] 14923    13
> cor.test(t2$logFC.x, t2$logFC.y)
        Pearson's product-moment correlation
t = 230.28, df = 14921, p-value < 2.2e-16
      cor
0.8834076

> 0.8834076 ^2
[1] 0.780409

##########################################################################################################
## mouse scRNA-seq
## tumor mg
## scRNA-seq-cluster-DEG-mouse ##
linyongmao@Linyong-Mao-MBP16-2019 microglia-mouse % mv -i diff2-1.txt mouse.seurat.oct2024.clusts.micro.8samples.diff2-1.edgeR.txt

diff <- as.data.frame(top2v1)
diff$geneID <- rownames(diff)
t6 <- read.delim("../microglia-mouse/Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip")
 dim(t6)
# [1] 19341     3
 raw <- read.delim("../autism/mouse-mg-rnaseq-60samp-stranded-Hanamsagar.counts_gene")
 gene.name <- raw[, 1:2]
 dim(gene.name)
#  [1] 56980     2
 gene.name$id <- gsub("\\.[0-9][0-9]*$", "", gene.name$geneID)
 t7 <- merge(t6, gene.name, by.x="ID", by.y="id")
 dim(t7)
#  [1] 19341     5
 diff.2 <- merge(diff, t7, by.x="geneID", by.y="name")
 dim(diff)
#  [1] 14618     6
 dim(diff.2)
#  [1] 12589    10
   t2 <- read.delim("../dir-GTExV8/gencode.vM31.mouse-id-chr-name")
 dim(t2)
#  [1] 56980     5
 diff.3 <- merge(diff.2, t2, by.x="geneID.y", by.y="geneID")
 dim(diff.3)
#  [1] 12589    14
  write.table(diff.3, "temp", quote=F, sep="\t")

linyongmao@Linyong-Mao-MBP16-2019 microglia-mouse % mv -i temp  mouse.seurat.oct2024.clusts.micro.8samples.diff2-1.edgeR.humangene.txt
vi  mouse.seurat.oct2024.clusts.micro.8samples.diff2-1.edgeR.humangene.txt
cat  mouse.seurat.oct2024.clusts.micro.8samples.diff2-1.edgeR.humangene.txt |awk 'BEGIN {FS = "\t"; OFS = "\t"} $11 != "chrX" && $11 != "chrY" ' | wc -l
   12187
 cat  mouse.seurat.oct2024.clusts.micro.8samples.diff2-1.edgeR.humangene.txt |awk 'BEGIN {FS = "\t"; OFS = "\t"} $11 != "chrX" && $11 != "chrY" ' | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $8, $3, $4, $5,$6,$7, $8, $9}' >  mouse.seurat.oct2024.clusts.micro.8samples.diff2-1.edgeR.humangene.noXY.txt
 ../microglia/make-rnk-genesymble  mouse.seurat.oct2024.clusts.micro.8samples.diff2-1.edgeR.humangene.noXY.txt  mouse.seurat.oct2024.clusts.micro.8samples.diff2-1.edgeR.humangene.noXY.rnk
   11970 mouse.seurat.oct2024.clusts.micro.8samples.diff2-1.edgeR.humangene.noXY.rnk
cat mouse.seurat.oct2024.clusts.micro.8samples.diff2-1.edgeR.humangene.noXY.rnk | grep -i ddx3y
cat mouse.seurat.oct2024.clusts.micro.8samples.diff2-1.edgeR.humangene.noXY.rnk | grep -i xist

linyongmao@Linyong-Mao-MBP16-2019 autism % bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx    /Users/linyongmao/Documents/h.all.v7.4.symbols.gmt    -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk  mouse.seurat.oct2024.clusts.micro.8samples.diff2-1.edgeR.humangene.noXY.rnk  -scoring_scheme classic  -rpt_label  "mouse.seurat.oct2024.clusts.micro.8samples.diff2-1.edgeR.humanname.noXY-weight0-hallmark"    -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

f3 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/mouse.seurat.oct2024.clusts.micro.8samples.diff2-1.edgeR.humanname.noXY-weight0-hallmark.GseaPreranked.1731610323635/gsea_report_for_na_pos_1731610323635.tsv")
f4 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/mouse.seurat.oct2024.clusts.micro.8samples.diff2-1.edgeR.humanname.noXY-weight0-hallmark.GseaPreranked.1731610323635/gsea_report_for_na_neg_1731610323635.tsv")
t3 <- rbind(f3, f4)
   t4 <- t3[, c(1,6, 8)]
dim(t4)
t8 <- merge(t4, t2, by.x="NAME", by.y="NAME")
 t8$nam <- gsub("HALLMARK", "h", t8$NAME)
 t3 <- t8[ t8$FDR.q.val.x < 0.01 & t8$FDR.q.val.y < 0.01 & t8$NES.x * t8$NES.y < 0,]
> gplot(t8, aes(x= -NES.x, y= NES.y, label = nam)) + geom_point(size=2, shape=21) + geom_smooth(se=T, method="lm") +  geom_text_repel(show.legend=T, data=t3 , size=2, max.overlaps=100, min.segment.length = 0.1, col="red") + labs(x="mouse scRNA-seq NES (baseline vs. GAM)", y="human NES (M vs. F)")

######################################################################################
> t1 <- read.delim("../microglia-mouse/mouse.seurat.oct2024.clusts.micro.8samples.diff2-1.edgeR.humangene.noXY.rnk", header=F)
 t2 <- read.delim("/Users/linyongmao/Documents/autism/human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk", header=F)
 t3 <- merge(t1, t2, by.x="V1", by.y="V1")
 dim(t3)
#  [1] 9873    3
# t1 [1] 11970     2
# t2 [1] 14586     2
 cor.test(t3$V2.x, t3$V2.y)
# signed log10Pvalue
#         cor -0.3387741
#    Spearman -0.3110818
 f1 <- read.delim("../microglia/HALLMARK_OXIDATIVE_PHOSPHORYLATION.genes", header=F)
 dim(f1)
#  [1] 200   1
 t4 <- merge(t3, f1, by.x="V1", by.y="V1")
 dim(t4)
#  [1] 182   3
# df = 180, Pearson's r=-0.4164898, p-value = 4.977e-09
# Spearman's rank correlation rho=-0.4124338, p-value = 1e-08
 plot(-t4$V2.x, t4$V2.y, xlab="signed log10Pvalue (mouse scRNA-seq: baseline vs. GAM)", ylab="signed log10Pvalue (human mg: M vs. F)")
 abline(h=0)
 abline(v=0)
 abline(h = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
 y=t4$V2.y
 x=-t4$V2.x
 abline(lm(y~x), lwd = 1, col="blue") 

>  f1 <- read.delim("../microglia/HALLMARK_INTERFERON_GAMMA_RESPONSE.genes", header=F)
> dim(f1)
[1] 200   1
>  t4 <- merge(t3, f1, by.x="V1", by.y="V1")
>  dim(t4)
[1] 170 IFN genes in both human mg & mouse scrna-seq,  3
t = -4.3824, df = 168, p-value = 2.062e-05, Pearson's r= -0.3202984
S = 1095352,           p-value = 7.567e-06, Spearman's rho = -0.3377446 

###################################################################################################
# You are computing correlations between pairs of spots for the same gene across different
genes. ......The duplicateCorrelation() function on the other hand computes a
correlation across technical replicates for the same gene.
# # Estimate the within-block correlation
>   identical(colnames(y), info.2$FASTQ.ID)
[1] TRUE
>   design <- model.matrix( ~ info.2$Sex.x + info.2$age )
> dim(y)
[1] 14923    18
> y.1 <- y
>  fit <- voomLmFit(y, design, block=info.2$Animal.ID, plot=TRUE)
First intra-block correlation  0.6576184
Final intra-block correlation  0.6567963

> logy <- log2(as.data.frame(edgeR::cpm(y)) + 0.5)
> dupcor <- duplicateCorrelation(logy,design,block=info.2$Animal.ID)
> dupcor$consensus.correlation
[1] 0.6701205

> design <- model.matrix( ~  info.2$age )
> dupcor <- duplicateCorrelation(logy,design,block=info.2$Sex.x)
> dupcor$consensus.correlation
[1] 0.1351476

design <- model.matrix( ~ info.2$Sex.x + info.2$age )
 t1 <- runif(18)
dupcor <- duplicateCorrelation(logy,design,block=info.2$Animal.ID[order(t1)])
dupcor$consensus.correlation
# run [1] -0.1481612
# run [2] -0.04484423
# no permuting animal IDs: 0.6701205

# The function is analogous to calling voom followed by duplicateCorrelation and lmFit
#########################################################################
> write.table(info.2, "cyno-18samp-rnaseq-oct-2024.info.2.txt", quote=F, sep="\t")
  t1 <- read.delim("cyno-atac-mg-10samp-conserv10.6samplesOnly.age.covar.oct24.diff2-1.txt")
  df.gene <- t1 ####[ t1$V2 == "NC_052275.1",]
  dim(df.gene)
#  [1] 10853    11
  df.gene$gene <- gsub("gene_id ", "", df.gene$V1)
 t2 <- read.delim("human_Microglia_rna-postnatal-MvF-diff2-1.strand.name-type-chr.txt")    
                ###human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt")
 t3 <- merge(t2, df.gene, by.x="name", by.y="gene")
 dim(t3)
# 7951
 t4 <- t3[ t3$chr == "chrX",]
 dim(t4)
#  [1] 211  21
 t4.2 <- t4[ t4$logFC.y > 0.5 | t4$logFC.y < -0.5 | t4$logFC.x > 1 | t4$logFC.x < -1,]
 dim(t4.2)
# [1] 31 21
 t5 <- t4[ sample(1:dim(t4)[1], 211),]
 dim(t5)
 t6 <- cor.test(t5$logFC.y, -t5$logFC.x)
 paste("Pearson ", "r=",round(t6$estimate, digits = 3), ", p=", format(t6$p.value, digits=3),  sep ="")
 t6 <- cor.test(t5$logFC.y, -t5$logFC.x, method = "s")
 paste("Spearman ", "r=",round(t6$estimate, digits = 3), ", p=", format(t6$p.value, digits=3),  sep ="")
#######################################################################
cyno-18samp-14923g.rds
lmFit(logy,design,block=info.2$Animal.ID,correlation=dupcor$consensus)
cyno-atac-mg-10samp-conserv10.6samplesOnly.age.covar.oct24.diff2-1.txt

> t3 <-  merge(cyno.rnaseq, df.gene, by.x="id", by.y="gene")
 dim(t3)
#  [1] 9427   18
 t4 <- t3[ t3$V2 == "NC_052275.1", ]
 dim(t4)
#  [1] 260  18
 write.table(t4, "temp", quote=F, sep="\t")
 system(" bash script-atac-peak-gene-pair-sel.1 > temp-res")
 t5 <- read.table("temp-res", sep="\t")
 dim(t5)
#  [1] 225  18
 t6 <- t5[ abs( t5$logFC.y) > 0.5 | abs(t5$logFC.x) > 1, ]
 dim(t6)
#  [1] 35 18
gplot(t5, aes(x = logFC.y, y = -logFC.x, label = id)) +   geom_point(shape=21, size=1) + labs(x="cyno. open chromatin log2 FC (F vs. M)" , y="gene expression log2 FC (F vs. M)") + geom_hline(yintercept=0, col="black") + geom_vline(xintercept=0) + geom_smooth(se=T, ) + geom_text_repel(show.legend=T, data=t6 , size=2, max.overlaps=100, min.segment.length = 0.1, col="red")

linyongmao@Linyong-Mao-MBP16-2019 autism % cat script-atac-peak-gene-pair-sel.1
#
# 18 (header line) or 19 columns (body)

cat temp | awk 'NR > 1' | cut -f 9 | sort | uniq -d > peak-dup
cat temp | awk 'NR > 1' | cut -f 9 | sort | uniq -u > peak-single

cat temp | head -1
cat peak-single | while read ll
do
 awk 'BEGIN {FS = "\t"; OFS = "\t"} $9 == "'$ll'" ' temp
done

cat peak-dup | while read ll
do
 awk 'BEGIN {FS = "\t"; OFS = "\t"} $9 == "'$ll'" ' temp > temp2
 ##1 peak controls 3 genes
 a=0
 awk 'BEGIN {FS = "\t"; OFS = "\t"} $3 * $10 < 0 ' temp2 > temp3 ####same sex bias
 a=`wc -l temp3 | awk '{print $1}' `
 if [ "$a" -gt 0 ]
 then
   head -1 temp3
 else
   head -1 temp2
 fi
done

 rm temp temp2 temp3 peak-dup peak-single
linyongmao@Linyong-Mao-MBP16-2019 autism %  

######
> t4 <- t3[ t3$V2 != "NC_052275.1", ]
> dim(t4)
[1] 9167   18
t5 <- t4[ sample(1:dim(t4)[1], 225),]
 dim(t5)
 t6 <- cor.test(t5$logFC.y, -t5$logFC.x)
 paste("Pearson ", "r=",round(t6$estimate, digits = 3), ", p=", format(t6$p.value, digits=3),  sep ="")
 t6 <- cor.test(t5$logFC.y, -t5$logFC.x, method = "s")
 paste("Spearman ", "r=",round(t6$estimate, digits = 3), ", p=", format(t6$p.value, digits=3),  sep ="")

set.seed(1234)
p10 <- list()
for(i in 1:10) {
t5 <- t4[ sample(1:dim(t4)[1], 225),]
 dim(t5) 
p10[[i]] <- ggplot(t5, aes(x = logFC.y, y = -logFC.x, label = id)) +   geom_point(shape=21, size=1) + labs(x="cyno. open chromatin log2 FC (F vs. M)" , y="gene expression log2 FC (F vs. M)") + geom_hline(yintercept=0, col="black") + geom_vline(xintercept=0) + geom_smooth(se=T, )
}
> grid.arrange(p10[[1]],p10[[2]],p10[[3]],p10[[4]],p10[[5]],p10[[6]],p10[[7]],p10[[8]],p10[[9]],p10[[10]], nrow=2)

linyongmao@Linyong-Mao-MBP16-2019 autism % cat mouse-mg-rnaseq-Thion.diff2-1.name-type-chr.humanname.txt | head | awk 'BEGIN {ORS = ""} {print "p10[[" NR "]]" ","}'

######################################################################################
using 18 cyno RNA-seq samples with ages < 5 && CX3CR1/CCR2 ratio > 32
> fit <- lmFit(logy,design,block=info.2$Animal.ID,correlation=dupcor$consensus)
......
>  t1 <- as.data.frame(topTable(fit, coef="info.2$Sex.xXY", number=91234))
 t1$id <- rownames(t1)
 t2 <- read.delim("GCF_012559485.2_MFA1912RKSv2_genomic_plus_Y.chr.coord.id", header=F)
 dim(t2)
#  [1] 35591     5
 t3 <- merge(t1, t2, by.x="id", by.y="V5")
 dim(t3)
#  [1] 14923    11
 t4 <- t3[ t3$V1 != "NC_052275.1" & t3$V1 != "Ycons", ]
 dim(t4)
#  [1] 14317    11
 write.table(t4, "temp", sep="\t", quote=F)
 t3.block <- t3

linyongmao@Linyong-Mao-MBP16-2019 autism % vi temp
cat temp | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, $2,  $3, $4, $5,$6,$7, $1}' > temp1
 ../microglia/make-rnk-genesymble temp1 out
mv out out.rnk
 bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx    /Users/linyongmao/Documents/h.all.v7.4.symbols.gmt    -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk out.rnk  -scoring_scheme classic  -rpt_label  "temp-block"    -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

 -rnk temp-block.rnk   -rpt_label  "temp-block-weighted1"   

> design <- model.matrix( ~ info.2$Sex.x + info.2$age )
each of 18 samples treated as independent
no block effect
> t1 <- as.data.frame(top2v1)
         logFC   logCPM        F       PValue          FDR  id
ZFX -0.8917978 4.467237 55.86509 6.346877e-07 0.0001503404 ZFX
 t3.nob <- t3
 colnames(t3.nob) <- paste("noblock", colnames(t3.nob), sep="_")
 identical(t3.block$id, t3.nob$noblock_id)
#  [1] TRUE
 t4 <- cbind(t3.block, t3.nob)
 t5 <- t4[ t4$V1 == "NC_052275.1",]
 dim(t5)
#  [1] 595  21
 t6 <- t5[ t5$P.Value < 0.05 | t5$noblock_PValue < 0.05,]
 dim(t6)
#  [1] 183  21

################
> f3 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/temp-block.GseaPreranked.1732737026231/gsea_report_for_na_pos_1732737026231.tsv")
f4 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/temp-block.GseaPreranked.1732737026231/gsea_report_for_na_neg_1732737026231.tsv")
 t3 <- rbind(f3,f4)
 t4 <- t3[, c(1,6,8)]
t8 <- merge(t4, t2, by.x="NAME", by.y="NAME")
 head(t8)
t8$nam <- gsub("HALLMARK", "h", t8$NAME)
 t9 <- t8[ t8$FDR.q.val.x < 0.01 & t8$FDR.q.val.y < 0.01, ]  

 t1 <- read.delim("human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk", header=F)
 t2 <- read.delim("mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.noXY.rnk", header=F)
  t3 <- merge(t1, t2, by.x="V1", by.y="V1")
  dim(t3)
#  [1] 10021     3
 t4 <- read.delim("temp-block.rnk", header=F)
 t5 <- merge(t3, t4, by.x="V1", by.y="V1")
 dim(t5)
#  [1] 9177    5
file <- "../microglia/HALLMARK_OXIDATIVE_PHOSPHORYLATION.genes"
 p <- read.delim(file, header=F)
 t6 <- t5[ t5$V1 %in% p$V1,]
 dim(t6)
#  [1] 156   5
 colnames(t6) <-c("id", "MvF human mg", "MvF mouse 40samp3ages", "cyno 3Mv.3F,age=4")
t7 <- t6[, c(2:4)]
> cor(t7, method="spearman")
                      MvF human mg MvF mouse 40samp3ages cyno 3Mv.3F,age=4
MvF human mg            1.00000000            0.28209764        0.01235953
MvF mouse 40samp3ages   0.28209764            1.00000000        0.08885271
cyno 3Mv.3F,age=4       0.01235953            0.08885271        1.00000000
> cor(t7)
                      MvF human mg MvF mouse 40samp3ages cyno 3Mv.3F,age=4
MvF human mg            1.00000000             0.2176979        0.03503532
MvF mouse 40samp3ages   0.21769789             1.0000000        0.11234267
cyno 3Mv.3F,age=4       0.03503532             0.1123427        1.00000000

HALLMARK_INTERFERON_GAMMA_RESPONSE.genes
>  dim(t6)
[1] 149   5
>  cor(t7, method="spearman")
                      MvF human mg MvF mouse 40samp3ages cyno 3Mv.3F,age=4
MvF human mg             1.0000000             0.2748268        -0.2834391
MvF mouse 40samp3ages    0.2748268             1.0000000        -0.1915110
cyno 3Mv.3F,age=4       -0.2834391            -0.1915110         1.0000000
> cor(t7)
                      MvF human mg MvF mouse 40samp3ages cyno 3Mv.3F,age=4
MvF human mg             1.0000000             0.3267523        -0.2931218
MvF mouse 40samp3ages    0.3267523             1.0000000        -0.1950356
cyno 3Mv.3F,age=4       -0.2931218            -0.1950356         1.0000000

##############################################################################
linyongmao@Linyong-Mao-MBP16-2019 autism % for g in `echo TYROBP  C1QC    CD68    CYBB    MFGE8   P2RY12  C1QB    C1QA    GPR34   ITGAM   TREM2   C3      CX3CR1`
do
grep -iw "$g" human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt
done > temp

###################################################
cp chea.human.mg.f.bias.infg.102genes.withBackg.txt temp-chea.human.mg.f.bias.infg.102genes.withBackg.txt
cp chea_2022.allterms.14586humangenes.txt temp-chea_2022.allterms.14586humangenes.txt
cp ../microglia/HALLMARK_INTERFERON_GAMMA_RESPONSE.genes temp-pathway-200genes-list
head  temp-chea.human.mg.f.bias.infg.102genes.withBackg.txt temp-chea_2022.allterms.14586humangenes.txt temp-pathway-200genes-list | cut -f 1-6
Rscript /Users/linyongmao/Documents/Whitehead-main/R-TF-target-correlate-boxplot-human-generalfiles
cat temp1 | sed 's/^[0-9]*      //' > temp2

cp  chea.human.mg.f.bias.oxphos.83genes.withBackg.txt  temp-chea.human.mg.f.bias.infg.102genes.withBackg.txt
cp chea_2022.allterms.14586humangenes.txt temp-chea_2022.allterms.14586humangenes.txt
cp  ../microglia/HALLMARK_OXIDATIVE_PHOSPHORYLATION.genes  temp-pathway-200genes-list
head  temp-chea.human.mg.f.bias.infg.102genes.withBackg.txt temp-chea_2022.allterms.14586humangenes.txt temp-pathway-200genes-list | cut -f 1-6
Rscript /Users/linyongmao/Documents/Whitehead-main/R-TF-target-correlate-boxplot-human-generalfiles
cat temp1 | sed 's/^[0-9]*      //' > temp2

cat temp2 | grep "not expre or 1 gene name" | awk '{print $1}' | while read g
do
  grep -i "$g" human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt
done


> t20 <- rbind(t15, t12)
 t20$caterg2 <- as.character(t20$caterg)
 t20$caterg2 <- factor(t20$caterg2, levels=c( "path.sex.bias.YES", "random.genes.NO"), labels=c("IFN.F.biased.IRF1.targets", "random genes"))
 boxplot(t20[,1] ~ t20$caterg2, outcol="white",  xlab="", ylab="TF-gene Spearman corr", main=t3$Term[i], col=c( "orange", "white"), ylim=c(-1,1), cex.main=1)
  beeswarm(t20[,1] ~ t20$caterg2,add=T)
  abline(h = seq(-100, 100, 1/10), lty = 5, lwd = 0.5, col = "gray")
 text(1.3, 0.9, paste( "pValue=",format( test1$p.value, digits=3)), pos=4, col="blue")
 wilcox.test(t15$IRF1, mu=0)
 wilcox.test(t12$IRF1, mu=0)

################################################################################
bash script-stat1-targets-allgenes
wc -l temp-targ*
grep " " temp-targ*
gencode.v42.primary_assembly.noPar.protein_coding.names as bg
ls temp-targ* > temp-pathway-files
bash ~/Documents/Whitehead-main/script-inputset-pathways-overlap-fisher-2 temp-targets-chea-STAT1_19122651_ChIP-Seq_HeLaS3_Human_CervicalCancer chea-STAT1_19122651_ChIP-Seq_HeLaS3 temp-pathway-files gencode.v42.primary_assembly.noPar.protein_coding.names

#########################################################################################
Simply typing "findMotifs.pl" should work before running Homer.
linyong@fry ~$ perl ./configureHomer.pl -install hg19

linyong@fry ~$ vi /lab/solexa_page/linyong/dir-temp/genes-infg-irf1-21genes

# find known motifs, and de novo motifs
# de novo motif discovery maybe not necessary if only want to check known motifs like irf1, stat1
#       Checking de novo motifs against known motifs...
#               1 of 33 (1e-25) similar to Irf1/MA0050.4/Jaspar(0.982)
#               2 of 33 (1e-8) similar to Prdm15/MA1616.2/Jaspar(0.671)
linyong@fry ~$  findMotifs.pl  /lab/solexa_page/linyong/dir-temp/genes-infg-irf1-21genes human /lab/solexa_page/linyong/dir-temp/ -start -500 -end 100 -len 8,10,12 -p 4
!!! human not found in /home/linyong//config.txt
        Try typing "perl /home/linyong//configureHomer.pl -list" to see available promoter sets
        If avaliable, type "perl /home/linyong//configureHomer.pl -install human" to install


### to save space under $HOME
linyong@fry ~/data/genomes$ mv -i hg18/   /lab/solexa_page/linyong/
linyong@fry ~/data/genomes$ mv -i hg19/   /lab/solexa_page/linyong/
linyong@fry ~/data/genomes$ ln -s /lab/solexa_page/linyong/hg18/ ./
linyong@fry ~/data/genomes$ ln -s /lab/solexa_page/linyong/hg19/ ./

#install  human promoter
# --2024-12-19 14:16:02--  http://homer.ucsd.edu/homer/data/promoters/human.v5.5.zip
linyong@fry ~$ perl ./configureHomer.pl -install  human-p

#############################
linyong@fry ~$ vi /lab/solexa_page/linyong/dir-temp/genes-infg-stat1-42genes
linyong@fry ~$ mkdir /lab/solexa_page/linyong/dir-temp-1/dir-infg-stat1-42g

# cat slurm-find-motif-homer-12-20-2024
findMotifs.pl  /lab/solexa_page/linyong/dir-temp/genes-infg-stat1-42genes  human  /lab/solexa_page/linyong/dir-temp-1/dir-infg-stat1-42g/ -start -500 -end 100 -len 8,10,12 -p 8

linyong@fry ~$ sbatch slurm-find-motif-homer-12-20-2024
Selected Options:
        Input file = /lab/solexa_page/linyong/dir-temp/genes-infg-stat1-42genes
        Promoter Set = human
        Output Directory = /lab/solexa_page/linyong/dir-temp-1/dir-infg-stat1-42g/
        New start is -500 relative to the TSS
        New end is 100 relative to the TSS
        Motif length set at 8, 10, 12,
        Using 8 CPUs
        Found mset for "human", will check against vertebrates motifs

        Progress: Step1 - Convert input file to refseq IDs
        Percentage of IDs converted into refseq: 100.0% (42 out of 42)

        Progress: Step2 - prepare sequence files

        Progress: Step3 - creating foreground/background file

        Progress: Step4 - removing redundant promoters
                Kept 47797 of 53293

        Progress: Step5 - adjusting background sequences for GC/CpG content...
        Progress: Step6 - Gene Ontology Enrichment Analysis

        Progress: Step7 - Known motif enrichment

        Reading input files...
        44881 total sequences read
        472 motifs loaded
        Cache length = 11180
        Using hypergeometric scoring
        Checking enrichment of 472 motif(s)
        Progress: Step8 - De novo motif finding (HOMER)

############################################################
linyongmao@Linyong-Mao-MBP16-2019 temp-122024 % cat     GSM320736_HeLa_STAT1_peaks.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, $2, $3, "peak_" NR,$6, "+" }' | head  -100 > temp-peaks
#  chr4 184505570       184508116       peak_1  14.268423408896 +
#  chr19        55219872        55221447        peak_2  7.40194575291536        +
#  chr21        35181531        35184550        peak_3  6.97093250755022        +

linyong@fry ~/data/genomes$ cp -r /lab/solexa_page/linyong/hg18 ./
#  i.e. findMotifsGenome.pl ERpeaks.txt hg18 ER_MotifOutput/ -size 200 -mask
findMotifsGenome.pl temp-peaks   hg18 /lab/solexa_page/linyong/dir-temp-1/dir-infg-stat1-hela-31genes/ -size 200 -mask
###
Motif Name      Consensus       P-value Log P-value     q-value (Benjamini)     # of Target Sequences with Motif(of 80) % of Target Sequences with Motif        # of Background Sequences with Motif(of 97439)  % of Background Sequences with Motif
ISRE(IRF)/ThioMac-LPS-Expression(GSE23622)/Homer        AGTTTCASTTTC    1e-3    -7.971e+00      0.1630  4.0     5.00%   399.5   0.41%
...
STAT1(Stat)/HelaS3-STAT1-ChIP-Seq(GSE12782)/Homer       NATTTCCNGGAAAT  1e-2    -5.014e+00      0.4170  6.0     7.50%   2035.7  2.09%

findMotifsGenome.pl temp-peaks   hg18 /lab/solexa_page/linyong/dir-temp-1/dir-infg-stat1-hela-31genes/ -size given -p 8
###
STAT1(Stat)/HelaS3-STAT1-ChIP-Seq(GSE12782)/Homer       NATTTCCNGGAAAT  1e-20   -4.732e+01      0.0000  80.0    80.00%  31621.7 33.73%
STAT5(Stat)/mCD4+-Stat5-ChIP-Seq(GSE12346)/Homer        RTTTCTNAGAAA    1e-16   -3.864e+01      0.0000  79.0    79.00%  34888.8 37.21%
Stat3(Stat)/mES-Stat3-ChIP-Seq(GSE11431)/Homer  CTTCCGGGAA      1e-11   -2.601e+01      0.0000  86.0    86.00%  50142.3 53.48%
Stat3+il21(Stat)/CD4-Stat3-ChIP-Seq(GSE19198)/Homer     SVYTTCCNGGAARB  1e-10   -2.436e+01      0.0000  94.0    94.00%  61991.3 66.12%

#################################################################
/Users/linyongmao/Downloads/temp-122024/GSM320736_HeLa_STAT1_peaks.txt

linyong@fry /lab/solexa_page/linyong$ cut -f 2- refGene.txt  | genePredToGtf file stdin out.gp

linyong@fry /lab/solexa_page/linyong$ wget "https://s3.amazonaws.com/igv.broadinstitute.org/genomes/seq/hg18/hg18.fasta"
-rw-r--r-- 1 linyong systemd-timesync 3.0G Dec  6  2013 hg18.fasta

linyongmao@Linyong-Mao-MBP16-2019 autism % cat /Users/linyongmao/Downloads/temp-122024/GSM320736_HeLa_STAT1_peaks.txt  | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, $2, $3, "peak_" $1 "-" $2 "-" $3 "_" NR,$6, "+" }'  > temp-peaks
linyongmao@Linyong-Mao-MBP16-2019 autism % head temp-peaks
chr4    184505570       184508116       peak_chr4-184505570-184508116_1 14.268423408896 +
chr19   55219872        55221447        peak_chr19-55219872-55221447_2  7.40194575291536        +
linyongmao@Linyong-Mao-MBP16-2019 autism % wc -l temp-peaks
   36998 temp-peaks

linyong@fry /lab/solexa_page/linyong$ homerTools extract temp-peaks hg18.fasta -fa > temp-peaks.fa

linyong@fry /lab/solexa_page/linyong$ bwa bwasw -t 8 /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa  temp-peaks.fa >  temp-peaks.sam

linyong@fry /lab/solexa_page/linyong$ cat temp-peaks.sam | awk 'NF > 9' | cut -f 2 | sort | uniq -c | head
  35635 0
     64 16 read reverse strand
   1302 4 read unmapped
cat temp-peaks.sam | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 == 0' | cut -f 1 | sort | uniq -d | wc -l
2
cat temp-peaks.sam | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 == 0 && $5 >= 20' | wc -l
34982
cat temp-peaks.sam | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 == 0 && $5 >= 20' | cut -f 6 | grep "^[0-9]*M$" |wc -l
34916
cat temp-peaks.sam | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 == 0 && $5 >= 20' | awk 'BEGIN {FS = "\t"; OFS = "\t"}  $6 ~ /^[0-9]*M$/' | cut -f 5 | awk '$1 > 50' | wc -l
34385
cat temp-peaks.sam | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 == 0 && $5 >= 20' | awk 'BEGIN {FS = "\t"; OFS = "\t"}  $6 ~ /^[0-9]*M$/ && $5 > 50' > temp-peaks.2.sam

#############################################################
29211 conserved.6samp.6samp.peak.coord.sorted.merged
 For the PU.1 (microglia samples) there are 11 replicates, most of which look pretty good and show the expected patterns of acetylation at microglia specific genes (e.g., CSF1R, TREM2, SPI1).

linyong@fry /lab/solexa_page/linyong/cyno-data/dir-macs2-defalt-param-2024-2-22$ cat  conserved.6samp.6samp.peak.coord.sorted.merged | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, $2, $3, "peak_" NR}' > conserved.6samp.6samp.peak.coord.sorted.merged.bed

##################################################################
        Add this line to .bashrc file (or other depending on your shell):
                PATH=$PATH:/lab/solexa_page/linyong/homer//bin/
        Simply typing "findMotifs.pl" should work before running Homer.

linyong@fry /lab/solexa_page/linyong/homer$ perl ./configureHomer.pl -list
linyongmao@Linyong-Mao-MBP16-2019 autism % cat chea.human.mg.f.bias.infg.102genes.withBackg.txt|head | grep ^IRF1  | head -1 | cut -f 9 | awk 'BEGIN {FS = ";"; OFS = "\t"} {for(i = 1; i <= NF; i++) print $i}' > temp-human.mg.f.bias.infg.21-genes.irf1-chip-seq

linyong@fry /lab/solexa_page/linyong/homer$ perl ./configureHomer.pl -list
linyong@fry /lab/solexa_page/linyong/homer$ perl ./configureHomer.pl -install hg38
        Installing: hg38
linyong@fry /lab/solexa_page/linyong/homer$ perl ./configureHomer.pl -install hg18

linyong@fry /lab/solexa_page/linyong/homer$ perl ./configureHomer.pl -install human-p
linyong@fry /lab/solexa_page/linyong/homer$ findMotifs.pl temp-human.mg.f.bias.infg.21-genes.irf1-chip-seq  human dir-output/ -start -500 -end 100  -p 4
                2 of 472 (1e-19) IRF1(IRF)/PBMC-IRF1-ChIP-Seq(GSE43036)/Homer; 80.95% vs. 4.44%

linyongmao@Linyong-Mao-MBP16-2019 autism % cat chea.human.mg.f.bias.infg.102genes.withBackg.txt|head -20| grep -i "^stat1"   | cut -f 9 | awk 'BEGIN {FS = ";"; OFS = "\t"} {for(i = 1; i <= NF; i++) print $i}' > temp-human.mg.f.bias.infg.42-genes.stat1-chip-seq

$ findMotifs.pl  temp-human.mg.f.bias.infg.42-genes.stat1-chip-seq   human dir-output-2/ -start -2000 -end 2000  -p 8
                2 of 472 (1e-12) IRF1(IRF)/PBMC-IRF1-ChIP-Seq(GSE43036)/Homer; 69.05% vs. 16.94%
                6 of 472 (1e-3) STAT1(Stat)/HelaS3-STAT1-ChIP-Seq(GSE12782)/Homer; 59.52% vs. 32.41%

linyong@fry /lab/solexa_page/linyong/homer$ annotatePeaks.pl tss hg38 -size -2000,2000 -hist 50 -m dir-output-2/knownResults//known6.motif -list temp-human.mg.f.bias.infg.42-genes.stat1-chip-seq > temp1
        Peak file = tss
        Genome = hg38
        Organism = human
        Peak Region set to 4001
        -----------------------------------------------------
        Histogram mode activated (bin size = 50 bp)
        -----------------------------------------------------
linyong@fry /lab/solexa_page/linyong/homer$ annotatePeaks.pl tss hg38 -size -2000,2000  -m dir-output-2/knownResults//known6.motif -list temp-human.mg.f.bias.infg.42-genes.stat1-chip-seq > temp2

############################
linyongmao@Linyong-Mao-MBP16-2019 autism % cat /Users/linyongmao/Downloads/temp-122024/GSM320736_HeLa_STAT1_peaks.txt  |  awk 'BEGIN {FS = "\t"; OFS = "\t"} $8 < 1e-300 && $6 > 4' | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, $2, $3, "peak_" $1 "-" $2 "-" $3 "_" NR,$6, "+" }'  > temp-peaks
###Q-value == 0 && Ratio of fold enrichment of sample over control > 4

linyongmao@Linyong-Mao-MBP16-2019 autism % wc -l temp-peaks
     144 temp-peaks
linyong@fry /lab/solexa_page/linyong/homer$  homerTools extract temp-peaks data/genomes/hg18/ -fa > temp-peaks.fa
        Custom genome sequence directory: data/genomes/hg18/
linyong@fry /lab/solexa_page/linyong/homer$ bwa bwasw -t 8 /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa  temp-peaks.fa >  temp-peaks.sam
linyong@fry /lab/solexa_page/linyong/homer$ cat temp-peaks.sam | awk 'NF > 9' | cut -f 2 | sort | uniq -c | head
    144 0 read forward mapped

linyong@fry /lab/solexa_page/linyong/homer$ cat temp-peaks.sam | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 == 0 && $5 >= 20' | awk 'BEGIN {FS = "\t"; OFS = "\t"}  $6 ~ /^[0-9]*M$/ && $5 > 50' > temp-peaks.2.sam
linyong@fry /lab/solexa_page/linyong/homer$ wc -l  temp-peaks.2.sam
143 temp-peaks.2.sam

cat temp-peaks.2.sam | cut -f 1-6 | sed 's/M$//' | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $3, $4, $4+$6, $1, $5, "+" }' > temp-peaks.2.sam.peaks

findMotifsGenome.pl temp-peaks.2.sam.peaks hg38  /lab/solexa_page/linyong/homer/dir-output-3/  -size given -p 8
###unmasked sequences
STAT1(Stat)/HelaS3-STAT1-ChIP-Seq(GSE12782)/Homer       NATTTCCNGGAAAT  1e-60   -1.396e+02      0.0000  124.0   86.71%  20903.3 21.85%
STAT5(Stat)/mCD4+-Stat5-ChIP-Seq(GSE12346)/Homer        RTTTCTNAGAAA    1e-51   -1.179e+02      0.0000  121.0   84.62%  23316.7 24.37%
Stat3(Stat)/mES-Stat3-ChIP-Seq(GSE11431)/Homer  CTTCCGGGAA      1e-41   -9.540e+01      0.0000  130.0   90.91%  34945.7 36.52%
Stat3+il21(Stat)/CD4-Stat3-ChIP-Seq(GSE19198)/Homer     SVYTTCCNGGAARB  1e-36   -8.309e+01      0.0000  137.0   95.80%  45324.8 47.37%
STAT4(Stat)/CD4-Stat4-ChIP-Seq(GSE22104)/Homer  NYTTCCWGGAAR    1e-24   -5.532e+01      0.0000  136.0   95.10%  54930.9 57.41%

        Background fragment size set to 2113 (avg size of targets)
        Background files for 2113 bp fragments found.
linyong@fry /lab/solexa_page/linyong/homer$ ls -lh /lab/solexa_page/linyong/homer//data/genomes/hg38//preparsed/
total 1.6G
-rw-r--r-- 1 linyong systemd-timesync  25M Feb  6 19:47 hg38.2113.cgbins
-rw-r--r-- 1 linyong systemd-timesync 1.5G Feb  6 19:46 hg38.2113.seq


linyong@fry ~$ mv -i bin binnib
             ### make those perl programs in $HOME/bin disappear
linyong@fry ~$ mkdir bin
             ###now it's empty $HOME/bin/

#########
findMotifs.pl  human.mg.f.bias.infg.102-genes  human dir-output-4/   -start -2000 -end 2000  -p 8 -nomask
###     Using non-repeat masked sequences
/lab/solexa_page/linyong/homer/dir-output-4/ contains result files
/lab/solexa_page/linyong/homer/out-homer-infn102g-2p-27 slurm output
linyongmao@Linyong-Mao-MBP16-2019 autism % du -sh dir-temp-1/dir-output-4
 21M    dir-temp-1/dir-output-4

IRF1(IRF)/PBMC-IRF1-ChIP-Seq(GSE43036)/Homer    GAAAGTGAAAGT    1e-19   -4.474e+01      0.0000  67.0    65.69%  10535.7 22.79%
STAT1(Stat)/HelaS3-STAT1-ChIP-Seq(GSE12782)/Homer       NATTTCCNGGAAAT  1e-2    -5.428e+00      0.2072  54.0    52.94%  18308.3 39.61%

/lab/solexa_page/linyong/homer$ findMotifs.pl  human.mg.f.bias.infg.102-genes  human dir-output-5/   -start -2000 -end 2000  -p 8
#default: -mask
/lab/solexa_page/linyong/homer/dir-output-5/ contains result files
/lab/solexa_page/linyong/homer/out-homer-infn102g-401p-2.7 slurm output
linyongmao@Linyong-Mao-MBP16-2019 autism % du -sh dir-temp-1/dir-output-5
 20M	dir-temp-1/dir-output-5

IRF1(IRF)/PBMC-IRF1-ChIP-Seq(GSE43036)/Homer    GAAAGTGAAAGT    1e-23   -5.300e+01      0.0000  63.0    61.76%  7882.2  17.08%
STAT1(Stat)/HelaS3-STAT1-ChIP-Seq(GSE12782)/Homer       NATTTCCNGGAAAT  1e-2    -6.287e+00      0.0878  48.0    47.06%  15107.4 32.74%

linyong@fry /lab/solexa_page/linyong/homer$ findMotifs.pl  human.mg.f.bias.infg.102-genes  human dir-output-6/   -start -1500 -end 500  -p 8  -nomotif
## #default: -mask
## Will not run homer for de novo motifs
IRF1(IRF)/PBMC-IRF1-ChIP-Seq(GSE43036)/Homer    GAAAGTGAAAGT    1e-21   -4.981e+01      0.0000  47.0    46.08%  4190.8  9.09%
STAT1(Stat)/HelaS3-STAT1-ChIP-Seq(GSE12782)/Homer       NATTTCCNGGAAAT  1e-2    -6.607e+00      0.0531  31.0    30.39%  8207.0  17.79%

linyong@fry /lab/solexa_page/linyong/homer$  findMotifs.pl  human.mg.f.bias.infg.102-genes  human dir-output-6/   -start -1000 -end 500  -p 8  -nomotif
## #default: -mask
## Will not run homer for de novo motifs
IRF1(IRF)/PBMC-IRF1-ChIP-Seq(GSE43036)/Homer    GAAAGTGAAAGT    1e-25   -5.867e+01      0.0000  47.0    46.08%  3387.9  7.36%
STAT1(Stat)/HelaS3-STAT1-ChIP-Seq(GSE12782)/Homer       NATTTCCNGGAAAT  1e-3    -8.104e+00      0.0119  28.0    27.45%  6470.0  14.05%


linyong@fry /lab/solexa_page/linyong/homer$  findMotifs.pl  human.mg.f.bias.infg.102-genes  human dir-output-6/   -start -500 -end 200  -p 8  -nomotif
## #default: -mask
## Will not run homer for de novo motifs
IRF1(IRF)/PBMC-IRF1-ChIP-Seq(GSE43036)/Homer    GAAAGTGAAAGT    1e-26   -6.165e+01      0.0000  40.0    39.22%  2001.0  4.39%
STAT1(Stat)/HelaS3-STAT1-ChIP-Seq(GSE12782)/Homer       NATTTCCNGGAAAT  1e-2    -6.028e+00      0.0758  17.0    16.67%  3570.4  7.83%

linyongmao@Linyong-Mao-MBP16-2019 autism % cat chea.human.mg.f.bias.infg.102genes.withBackg.txt|head -20| grep -i "^irf1"  | head -1 |  cut -f 9  | awk 'BEGIN {FS = ";"; OFS = "\t"} {for(i = 1; i <= NF; i++) print $i}' > temp-human.mg.f.bias.infg.21-genes.IRF1ChIP-SeqMONOCYTES
linyong@fry /lab/solexa_page/linyong/homer$  findMotifs.pl  temp-human.mg.f.bias.infg.21-genes.IRF1ChIP-SeqMONOCYTES   human dir-output-temp/  -start -2000 -end 2000  -p 8  -nomotif
## #default: -mask
## Will not run homer for de novo motifs

linyongmao@Linyong-Mao-MBP16-2019 autism % cat chea.human.mg.f.bias.oxphos.83genes.withBackg.txt | grep -i "^stat1" | head -1 |  cut -f 9  | awk 'BEGIN {FS = ";"; OFS = "\t"} {for(i = 1; i <= NF; i++) print $i}' > temp-human.mg.f.bias.oxphos.37-genes.STAT1ChIP-SeqHeLaS3
linyong@fry /lab/solexa_page/linyong/homer$  findMotifs.pl temp-human.mg.f.bias.oxphos.37-genes.STAT1ChIP-SeqHeLaS3    human dir-output-temp/  -start -2000 -end 2000  -p 8  -nomotif

linyong@fry /lab/solexa_page/linyong/homer$  findMotifs.pl temp-human.mg.f.bias.oxphos.83-genes  human dir-output-temp/  -start -2000 -end 2000  -p 8  -nomotif

#############################################################
linyong@fry /lab/solexa_page/linyong/homer$ rm -f temp1
annotatePeaks.pl tss hg38 -size -2000,2000  -m dir-output-2/knownResults//known6.motif -list temp-human.mg.f.bias.infg.42-genes.stat1-chip-seq > temp1
cat temp1 | cut -f 22 | awk 'NR > 1 && $1 != "" ' | wc -l
# 26, 26 / 42 = 0.6190476

annotatePeaks.pl tss hg38 -size -2000,2000  -m dir-output-2/knownResults//known6.motif -list temp-human.mg.f.bias.infg.42-genes.stat1-chip-seq  -mask > temp1
cat temp1 | cut -f 22 | awk 'NR > 1 && $1 != "" ' | wc -l
#  25

linyong@fry /lab/solexa_page/linyong/homer$  findMotifs.pl   temp-human.mg.f.bias.infg.42-genes.stat1-chip-seq    human dir-output-temp/  -start -2000 -end 2000  -p 8  -nomotif
# 25 / 42 = 0.5952381, STAT1(Stat)/HelaS3-STAT1-ChIP-Seq(GSE12782)/Homer

-rw-r--r--  1 linyong systemd-timesync 111K Mar  7 19:05 temp-bg1
linyong@fry /lab/solexa_page/linyong/homer$ sbatch slurm-homer-5
#SBATCH --output "out-homer-14586g-3-7-707p"   # name of output file.  %j is jobid
annotatePeaks.pl tss hg38 -size -2000,2000  -m dir-output-2/knownResults//known6.motif -list temp-bg1 -mask > human-mg-14586genes-stat1-motif-occur
#       Will use repeat-masked sequences
                Total Peaks: 11884
        11817 total sequences read
linyong@fry /lab/solexa_page/linyong/homer$ cat human-mg-14586genes-stat1-motif-occur | wc -l
11885
cat human-mg-14586genes-stat1-motif-occur |cut -f 22 | awk 'NR > 1 && $1 != "" ' | wc -l
3789
cat human-mg-14586genes-stat1-motif-occur |cut -f 22 | awk 'NR > 1 && $1 == "" ' | wc -l
8095
> 3789 / 11884
[1] 0.318832
> 3789/11817
[1] 0.3206398

linyongmao@Linyong-Mao-MBP16-2019 autism % cat human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt |   awk 'NR > 1 && $8 != "chrX" && $8 != "chrY" ' |  cut -f 7 | sort | uniq > temp-bg1
linyongmao@Linyong-Mao-MBP16-2019 autism % wc -l temp-bg1
   14586 temp-bg1

##########################################################
linyongmao@Linyong-Mao-MBP16-2019 autism % ls *.rnk | grep -i resid > temp-1
 ls human_Microglia_rna-postnatal-MvF-diff2-1.noX.Y.interac.strand.rnk >> temp-1
> t1 <- read.delim("temp-1", header=F)
 f1 <- read.delim(t1$V1[5], header=F)
 f2 <- read.delim(t1$V1[1], header=F)
 h.m <- merge(f1, f2, by.x="V1", by.y="V1")
 dim(h.m)
  p <- read.delim("../microglia/HALLMARK_INTERFERON_GAMMA_RESPONSE.genes", header=F)
 h2 <- h.m[ h.m$V1 %in% p$V1,]
 dim(h2)
 lm1 <- cor.test(h2$V2.x, h2$V2.y, method="spearman")
 str4 <- paste(t1$V1[1], lm1$estimate, lm1$p.value, sep="\t")
cat (str4)
 cat("\n")

for(i in 1:4) {
f1 <- read.delim(t1$V1[5], header=F)
 f2 <- read.delim(t1$V1[i], header=F)
 h.m <- merge(f1, f2, by.x="V1", by.y="V1")
 dim(h.m)
  p <- read.delim("../microglia/HALLMARK_INTERFERON_GAMMA_RESPONSE.genes", header=F)
 h2 <- h.m[ h.m$V1 %in% p$V1,]
 dim(h2)
 lm1 <- cor.test(h2$V2.x, h2$V2.y, method="pearson")
 str4 <- paste(t1$V1[i], lm1$estimate, lm1$p.value, sep="\t")
cat (str4)
 cat("\n")

 }

> h3 <- h2[ abs(h2$V2.x) > abs(log10(0.05)) &  abs(h2$V2.y) > abs(log10(0.05)) & h2$V2.x * h2$V2.y > 0,]
> gplot(h2, aes(x=V2.y, y=V2.x, label=V1)) + geom_point(shape=21, size=2, color="red") + geom_smooth(method="lm") + labs( x = "mouse-mg signed log10 Pval (M vs. F)", y="human-mg signed log10 Pval (M vs. F)", title="HALLMARK_INTERFERON_GAMMA_RESPONSE.genes") + geom_hline(yintercept=0, col="black") + geom_vline(xintercept=0)  + scale_x_continuous(breaks=seq(-12, 12, 1)) + scale_y_continuous(breaks=seq(-12, 12, 1)) + geom_text_repel(show.legend=T, data=h3, size=2.2, max.overlaps=100, min.segment.length = 0.1)  

######################################################################
> y.orig <- y
 y <- y[, grepl("F", info.2$Sex)]
 y
 t1 <- data.frame(dum= 1:8)
 design <- model.matrix(~t1$dum)
y <- estimateDisp(y,design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, coef=2)
top2v1 <- topTags(qlf, n = 91234)
# write.table(top2v1, "diff2-1.txt", sep="\t", quote = F)
diff <- as.data.frame(top2v1)
 diff$geneID <- rownames(diff)
 diff.f <- diff[, c(2,6)]
 colnames(diff.f)[1] <- "log2CPM.female"

 y <- y.orig 
 y <- y[, grepl("M", info.2$Sex)]
 y
 t1 <- data.frame(dum= 1:5)
 design <- model.matrix(~t1$dum)
y <- estimateDisp(y,design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, coef=2)
top2v1 <- topTags(qlf, n = 91234)
# write.table(top2v1, "diff2-1.txt", sep="\t", quote = F)
diff <- as.data.frame(top2v1)
 diff$geneID <- rownames(diff)
 diff.m <- diff[, c(2,6)]
 colnames(diff.m)[1] <- "log2CPM.male"
 
 t2 <- read.delim("human_Microglia_rna-postnatal-MvF-diff2-1.interac.strand.name-type-chr.txt")
 t3 <- merge(diff.f, diff.m, by.x="geneID", by.y="geneID")
 dim(t3)
#  [1] 15089     3
 t4 <- merge(t3, t2,  by.x="geneID", by.y="geneID")
 dim(t4)
#  [1] 15089    12
#   write.table(t4, "temp1.txt", quote=F, sep="\t")
linyongmao@Linyong-Mao-MBP16-2019 autism % mv -i "temp1.txt" autism-collab-fatir-human_Microglia_rna-postnatal-MvF.interac.strand.name-type-chr.txt 

###############################################################
# 40 samples, 3 ages
>  design <- model.matrix( ~ info.2$sex + info.2$age + info.2$pc1 + info.2$pc2) 
linyongmao@Linyong-Mao-MBP16-2019 autism % wc -l mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.txt
   12751 mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.txt

>  identical(info.2$id, y.cn)
 y.0 <- y
 samp <- info.2[ info.2$sex == "F",]
 y <- y[, colnames(y) %in% samp$id]
 dim(y)
#  [1] 13862    21
 t1 <- data.frame(dum= 1:21)
 design <- model.matrix(~t1$dum)
y <- estimateDisp(y,design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, coef=2)
top2v1 <- topTags(qlf, n = 91234)
# write.table(top2v1, "diff2-1.txt", sep="\t", quote = F)
diff <- as.data.frame(top2v1)
diff$geneID <- rownames(diff)
gene.name <- raw[, 1:2]
df.gene <- merge(diff, gene.name, by.x="geneID", by.y="geneID")
t6 <- read.delim("../microglia-mouse/Mouse_ENSEMBL_Gene_ID_Human_Orthologs_MSigDB.v7.4.chip")
 dim(t6)
# [1] 19341     3
  t2 <- read.delim("../dir-GTExV8/gencode.vM31.mouse-id-chr-name")
  t3 <- merge(df.gene, t2, by.x="geneID", by.y="geneID")
  dim(t3)
 df.cpm.gene <- t3
 df.cpm.gene$id <- gsub("\\.[0-9][0-9]*", "", df.cpm.gene$geneID)
 t8 <- merge(df.cpm.gene, t6, by.x="id", by.y="ID")
 dim(t8)
 diff.f <- t8[, c(2,4)]
  colnames(diff.f)[2] <- "log2CPM.female"

y <- y.0 
......
> head(diff.m)
> head(t8)

>  t2 <- read.delim("mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF-diff2-1.age-residPC1-residPC2-covar.name-type-chr.humanname.txt")
 t3 <- merge(diff.f, diff.m, by.x="geneID", by.y="geneID")
 dim(t3)
#  [1] 12750     3
  t4 <- merge(t3, t2,  by.x="geneID", by.y="geneID")
 dim(t4)
#  [1] 12750    16
 t5 <- t4[ t4$PValue < 0.01,]
 dim(t5)
#  [1] 482  16
 plot(t5$log2CPM.male - t5$log2CPM.female, t5$logFC)
 y1 <- t5$logFC
 x1 <- t5$log2CPM.male - t5$log2CPM.female
 abline(lm(y1 ~ x1))
  abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
  abline(v = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
 abline(h=0)
 abline(v=0)
 t6 <- t5[ t5$logFC > -2 & t5$logFC < 2,]
 dim(t6)
#  [1] 477  16
 plot(t6$log2CPM.male - t6$log2CPM.female, t6$logFC)
 y1 <- t6$logFC
 x1 <- t6$log2CPM.male - t6$log2CPM.female
 lm <- lm(y1 ~ x1)
 summary(lm)
#  write.table(t4, "temp1.txt", quote=F, sep="\t")
linyongmao@Linyong-Mao-MBP16-2019 autism % mv -i "temp1.txt" autism-collab-fatir-mouse-mg-rnaseq-Hanamsagar.40samp3ages.MvF.age-residPC1-residPC2-covar.name-type-chr.humanname.txt 

