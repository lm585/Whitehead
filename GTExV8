linyong@tak ~$ h | grep pfb
  540  pfb
  543  pip install pypfb==0.5.0
  544  pfb
  546  /home/linyong/.local/bin/pfb
  551  # pfb to -i <PATH_to_export_pfb.avro> tsv
  552  pfb to -i  export_2023-01-26T20.avro tsv
  553  /home/linyong/.local/bin/pfb to -i  export_2023-01-26T20.avro tsv
  563  #/home/linyong/.local/bin/pfb to -i  export_2023-01-26T20.avro tsv
  564  /home/linyong/.local/bin/pfb to -i export_2023-01-26T20\ 39\ 38.avro tsv
  578  /home/linyong/.local/bin/pfb to -i "export_2023-01-26T21 12 10.avro" tsv
##from tak cluster only
/home/linyong/.local/bin/pfb to -i "export_2023-01-26T21 12 10.avro" tsv
-rw-r--r-- 1 linyong input 22M Jan 26 16:18 export_2023-01-26T21 12 10.avro


./gen3-client |not exec this cmd### configure --profile=gtexv8 --cred=credentials.json --apiendpoint=https://gen3.theanvil.io
# 2023/01/27 15:22:22 Profile 'gtexv8' has been configured successfully.
./gen3-client configure --profile=gtexv8expire_3_29  --cred=credentials_expire_3_29.json --apiendpoint=https://gen3.theanvil.io
2023/02/27 12:27:17 A new version of gen3-client is available! The latest version is 2023.2.0. You are using version 2022.12
2023/02/27 12:27:17 Please download the latest gen3-client release from https://github.com/uc-cdis/cdis-data-client/releases/latest
2023/02/27 12:27:17 Profile 'gtexv8expire_3_29' has been configured successfully.

linyong@tak /lab/solexa_page/linyong$ /lab/page_human_data/linyong2/dir-gtex-118/gen3-client  configure --profile=gtexv8expire_4_26 --cred=credentials_expire_4_26.json  --apiendpoint=https://gen3.theanvil.io
2023/03/27 16:32:08 A new version of gen3-client is available! The latest version is 2023.4.0. You are using version 2022.12
2023/03/27 16:32:08 Please download the latest gen3-client release from https://github.com/uc-cdis/cdis-data-client/releases/latest
2023/03/27 16:32:08 Profile 'gtexv8expire_4_26' has been configured successfully.

linyong@fry /lab/solexa_page/linyong$ /lab/page_human_data/linyong2/dir-gtex-118/gen3-client  configure --profile=gtexv8expire_5_26 --cred=credentials-5-26-5pm.json  --apiendpoint=https://gen3.theanvil.io 
2023/04/26 17:36:24 A new version of gen3-client is available! The latest version is 2023.4.0. You are using version 2022.12
2023/04/26 17:36:24 Please download the latest gen3-client release from https://github.com/uc-cdis/cdis-data-client/releases/latest
2023/04/26 17:36:24 Profile 'gtexv8expire_5_26' has been configured successfully.

linyong@fry /lab/solexa_page/linyong$ /lab/page_human_data/linyong2/dir-gtex-118/gen3-client  configure --profile=gtexv8expire_5_26 --cred=credentials_6_26.json  --apiendpoint=https://gen3.theanvil.io 
2023/05/27 15:31:01 A new version of gen3-client is available! The latest version is 2023.6.0. You are using version 2022.12
2023/05/27 15:31:01 Please download the latest gen3-client release from https://github.com/uc-cdis/cdis-data-client/releases/latest
2023/05/27 15:31:01 Profile 'gtexv8expire_5_26' has been configured successfully.

linyong@fry /lab/solexa_page/linyong$ /lab/page_human_data/linyong2/dir-gtex-118/gen3-client  configure --profile=gtexv8expire_7_26_825 --cred=credentials_july_26_8pm.json  --apiendpoint=https://gen3.theanvil.io  
2023/06/26 20:25:38 A new version of gen3-client is available! The latest version is 2023.6.0. You are using version 2022.12
2023/06/26 20:25:38 Please download the latest gen3-client release from https://github.com/uc-cdis/cdis-data-client/releases/latest
2023/06/26 20:25:39 Profile 'gtexv8expire_7_26_825' has been configured successfully.

linyong@fry /lab/solexa_page/linyong$ /lab/page_human_data/linyong2/dir-gtex-118/gen3-client  configure --profile=gtexv8expire_oct27 --cred=credentials_expire_oct27.json   --apiendpoint=https://gen3.theanvil.io 
2023/09/27 12:11:58 A new version of gen3-client is available! The latest version is 2023.10.0. You are using version 2022.12
2023/09/27 12:11:58 Please download the latest gen3-client release from https://github.com/uc-cdis/cdis-data-client/releases/latest
2023/09/27 12:11:58 Profile 'gtexv8expire_oct27' has been configured successfully.

    Important: “--protocol” tag is important to this command as it will determine which bucket the files will be downloaded from. The “s3” value will download from the egress free Cleversafe bucket for the datasets in the “Downloadable” tab.

    Note: With larger manifests containing more than 100,000 files such as GTEx v8, the initial process of reading and parsing the manifest into the gen3-client can take anywhere from 30 - 240 mins.

cp -i  file-manifest.json file-manifest.test.json
vi file-manifest.test.json

./gen3-client download-multiple --profile=gtexv8  --manifest=file-manifest.test.json --download-path=dir-gtexv8-bam-files --protocol=s3
#
2023/01/27 15:36:19 A new version of gen3-client is available! The latest version is 2023.2.0. You are using version 2022.12
2023/01/27 15:36:19 Please download the latest gen3-client release from https://github.com/uc-cdis/cdis-data-client/releases/latest
2023/01/27 15:36:19 Reading manifest...
 1.86 KiB / 1.86 KiB [===========================================================================================] 100.00% 0s
WARNING: flag "rename" was set to false in "original" mode, duplicated files under "dir-gtexv8-bam-files/" will be overwritten
Proceed? [y/n]: y
2023/01/27 15:36:42 Total number of objects in manifest: 8
2023/01/27 15:36:42 Preparing file info for each file, please wait...
 8 / 8 [=========================================================================================================] 100.00% 0s
2023/01/27 15:36:42 File info prepared successfully  
GTEX-1CB4F-2326-SM-7MKFO.Aligned.sortedByCoord.out.patched.md.bam  4.77 GiB / 4.77 GiB [============================] 100.00%
GTEX-1GMRU-0011-R5a-SM-CKZNS.Aligned.sortedByCoord.out.patched.md.bam  4.83 GiB / 4.83 GiB [========================] 100.00%
GTEX-1I1CD-1226-SM-CNPQ2.Aligned.sortedByCoord.out.patched.md.bam  4.77 GiB / 4.77 GiB [============================] 100.00%
GTEX-S341-0008-SM-4AD6D.Aligned.sortedByCoord.out.patched.md.bam  4.79 GiB / 4.79 GiB [=============================] 100.00%
GTEX-RM2N-1426-SM-2TF4H.Aligned.sortedByCoord.out.patched.md.bam  6.45 GiB / 6.45 GiB [=============================] 100.00%
GTEX-1HCVE-1026-SM-ACKXR.Aligned.sortedByCoord.out.patched.md.bam  5.15 GiB / 5.15 GiB [============================] 100.00%
GTEX-1GN2E-1526-SM-7P8TD.Aligned.sortedByCoord.out.patched.md.bam  4.55 GiB / 4.55 GiB [============================] 100.00%
GTEX-17JCI-1526-SM-7IGOQ.Aligned.sortedByCoord.out.patched.md.bam  2.29 GiB / 2.29 GiB [============================] 100.00%
2023/01/27 15:43:44 8 files downloaded.

/lab/page_human_data/linyong2/dir-gtex-118/gen3-client download-multiple --profile=gtexv8expire_3_29  --manifest=temp.json --protocol=s3 --no-prompt  

##############################rm _PAR_Y lines from gtf
sort gencode.v42.primary_assembly.annotation.gtf | uniq -d | wc -l
0
cat gencode.v42.primary_assembly.annotation.gtf | grep -iw "transcript" | wc -l
252475
cat rsemindex_gencode_01.ti | grep ENST | awk 'NF == 2' | wc -l
252475
cat rsemindex_gencode_01.ti | grep ENST | awk 'NF == 2' | cut -f 1 | sort | uniq -d | wc -l
0
cat rsemindex_gencode_01.ti | grep ENST | awk 'NF == 2' | cut -f 1 | sed 's/_PAR_Y//' | sort | uniq -d | wc -l
174
cat gencode.v42.primary_assembly.annotation.gtf | grep PAR_Y | cut -f 3 | sort |uniq -c
    450 CDS
    937 exon
     47 gene
     71 start_codon
     58 stop_codon
    174 transcript
    214 UTR
450 + 937 + 47 + 71 + 58 + 174 + 214
[1] 1951
cat gencode.v42.primary_assembly.annotation.gtf | grep "_PAR_Y\"; " > temp-1
wc -l temp-1
1951 temp-1
cat temp-1 | grep "tag \"PAR\";" | wc -l
1951
grep -v "_PAR_Y\"; " gencode.v42.primary_assembly.annotation.gtf > gencode.v42.primary_assembly.noPar.annotation.gtf
grep -i "par.y" gencode.v42.primary_assembly.noPar.annotation.gtf | wc -l
0
diff gencode.v42.primary_assembly.annotation.gtf  gencode/gencode.v42.primary_assembly.annotation.gtf | wc
      0       0       0
(from helen) -r-xr-xr-x 1 linyong input 1561033529 Jan 13 20:43 gencode/gencode.v42.primary_assembly.annotation.gtf*
(download  ) -rw-r--r-- 1 linyong input 1561033529 Feb  2 14:01 gencode.v42.primary_assembly.annotation.gtf

##################

java -jar /usr/local/share/picard-tools/picard.jar SamToFastq I=GTEX-RM2N-1426-SM-2TF4H.Aligned.sortedByCoord.out.patched.md.bam FASTQ="r3.fq" SECOND_END_FASTQ="r4.fq"

[Thu Feb 02 14:45:09 EST 2023] picard.sam.SamToFastq done. Elapsed time: 14.32 minutes.
Runtime.totalMemory()=2,016,411,648

  196335196 r3.fq (49083799 read pairs)
  196335196 r4.fq
  392670392 total
awk 'NR % 4 == 1'  r3.fq | sort | uniq -d | wc
(no dup read)      0       0       0
/lab/solexa_page/linyong/dir-gtexv8-bam-files$ awk 'NR % 4 == 1'  r3.fq | sort | uniq -u | wc -l
49083799

##########################
cat slurm-wi-star-genome-index
#!/bin/bash
# Configuration values for SLURM job submission.
# One leading hash ahead of the word SBATCH is not a comment, but two are.
#SBATCH --job-name="satrgenomeindex" # friendly name for job.
#SBATCH --nodes=1                      # ensure cores are on one node
#SBATCH --ntasks=1                     # run a single task
#SBATCH --cpus-per-task=20              # number of cores/threads requested.
#SBATCH --mem=128gb                      # memory requested.
#SBATCH --partition=20                 # partition (queue) to use
#SBATCH --output star-genome-index-%j.out   # name of output file.  %j is jobid
##SBATCH --mail-type=ALL               # send email on job start/finish.
##SBATCH --mail-user=linyong@wi.mit.edu

# This is the actual section for commands to run
STAR  --runMode genomeGenerate  --genomeDir /lab/solexa_page/linyong/dir-star-genome-index-oh75  --genomeFastaFiles   /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa    --sjdbGTFfile  /lab/solexa_page/linyong/gencode/gencode.v42.primary_assembly.noPar.annotation.gtf  --sjdbOverhang 75 --runThreadN 16

# Uncomment the last line to email output file to specified address.
# Slurm doesn't do this automatically, regardless of the mail-type setting above.
#/usr/bin/mail -s "$SLURM_JOB_NAME $SLURM_JOB_ID" your_username@wi.mit.edu < friendlyname-${SLURM_JOB_ID}.out

##################bsub script-gtexv8-pipeline-download-genecount 
###pipeline QA cmds
cd /lab/solexa_page/linyong/
date
df -h | grep -i page
du -sh .
grep -in error dir-gtex-*/out-*
# dir-gtex-02/out-01:23403:  [Exception type: ValueError, raised in libcalignmentfile.pyx:947]
# check if still running
ls dir-gtex-*/out-* -lh
tail dir-gtex-*/out-*

rm -f temp1
cat dir-gtex-*/out-* > temp1
cat temp1 | grep "Uniquely mapped reads" | grep "%" | wc -l
cat temp1 | grep "Uniquely mapped reads" | grep "%" | sort +5 -6g
cat temp1 | grep "Uniquely mapped reads" | grep -v "%" | sort +5 -6g | sort | uniq -d
ls dir-gtex-*/*counts_gene -lh | grep "Feb  9 18"
# -rw-r--r-- 1 linyong input    0 Feb  9 18:26 dir-gtex-01/GTEX-WFON-2226-SM-3TW8W.Aligned.sortedByCoord.out.patched.md.bam.counts_gene
head dir-gtex-*/script-gtexv8-pipeline-download-genecount
h | grep script-make-gtexv8-pipeline
# issue pipeline cmd
# disc space used
ls -lh dir-gtex-* | grep total
# total 97G

-rw-r--r-- 1 linyong input  48G Feb  9 18:52 GTEX-14BMU-1526-SM-5TDE6.Aligned.sortedByCoord.out.patched.md.bam
-rw-r--r-- 1 linyong input  61G Feb  9 21:06 r3.fq
-rw-r--r-- 1 linyong input  61G Feb  9 21:06 r4.fq
                          Number of input reads |       334353824
                      Average input read length |       152
                   Uniquely mapped reads number |       309927931
                        Uniquely mapped reads % |       92.69%


######pipeline QC cmds; version Feb 13, 2023
cd /lab/solexa_page/linyong/
date
df -h | grep -i page
du -sh . /lab/page_human_data/linyong2/
grep -in error dir-gtex-*/out-*  /lab/page_human_data/linyong2/dir-gtex-*/out-*
# dir-gtex-02/out-01:23403:  [Exception type: ValueError, raised in libcalignmentfile.pyx:947]
# dir-gtex-41/out-dir-gtex-41-Tue_Feb_14_15:21:42_EST_2023:1867:  [Exception type: ValueError, raised in libcalignmentfile.pyx:947]

# check if still running
ls dir-gtex-*/out-*  /lab/page_human_data/linyong2/dir-gtex-*/out-* -lh
tail dir-gtex-*/out-* /lab/page_human_data/linyong2/dir-gtex-*/out-*
###avoid dup directory such as out-dir-gtex-34
bjobs -w -u  linyong | grep linyong | awk '{print $10}' | sort | sed 's/-[A-Z].*//' | sort | uniq -d
# out-dir-gtex-16
# out-dir-gtex-17
# out-dir-gtex-18

ls dir-gtex-10/*counts_gene | while read f; do grep -iw ddx3y "$f"; grep -iw xist "$f"; echo; done
# ENSG00000067048.17    DDX3Y   4
# ENSG00000229807.13    XIST    14641

#MT- genes at the end of orig/downloaded bam file
grep "MT-CO1" dir-gtex-24/*counts_gene  | sort +2 -3g | wc -l
# dir-gtex-24/GTEX-P4QS-1126-SM-3NMD5.Aligned.sortedByCoord.out.patched.md.bam.counts_gene:ENSG00000198804.2    MT-CO1  3848681

rm -f temp1
cat dir-gtex-*/out-*  /lab/page_human_data/linyong2/dir-gtex-*/out-*  > temp1
cat temp1 | grep "Uniquely mapped reads" | grep "%" | wc -l
cat temp1 | grep "Uniquely mapped reads" | grep "%" | sort +5 -6g
cat temp1 | grep "Uniquely mapped reads" | grep -v "%" | sort +5 -6g | sort | uniq -d
cat temp1 | grep "Uniquely mapped reads" | grep -v "%" | sort +5 -6g | sort  | uniq | awk 'NR == 450'
###median uniq read coverage                   Uniquely mapped reads number |   37274465

ls dir-gtex-*/*counts_gene /lab/page_human_data/linyong2/dir-gtex-*/*counts_gene  -lh | grep "Feb  9 18"
# -rw-r--r-- 1 linyong input    0 Feb  9 18:26 dir-gtex-01/GTEX-WFON-2226-SM-3TW8W.Aligned.sortedByCoord.out.patched.md.bam.counts_gene
head dir-gtex-*/script-gtexv8-pipeline-download-genecount
h | grep script-make-gtexv8-pipeline
# issue pipeline cmd
# disc space used
ls -lh dir-gtex-* | grep total
# total 97G

# error message before Fri Feb 17 12:51:13 EST 2023
# dir-gtex-02/out-01:23403:  [Exception type: ValueError, raised in libcalignmentfile.pyx:947]
# dir-gtex-38/out-dir-gtex-38-Tue_Feb_14_15:14:38_EST_2023:54102:2023/02/17 06:41:20 Error occurred when checking for latest version: Get "https://api.github.com/repos/uc-cdis/cdis-data-client/tags": dial tcp 140.82.114.6:443: connect: connection refused
### for dir-gtex-38/GTEX-146FR-0526-SM-5Q5EX.Aligned.sortedByCoord.out.patched.md.bam
### 2023/02/17 06:42:54 1 files downloaded.
### -rw-r--r-- 1 linyong input 9.9G Feb 17 07:01 r3.fq
###                    Uniquely mapped reads number |       51774649
### result ok
### -rw-r--r-- 1 linyong input 1.9M Feb 17 09:29 dir-gtex-38/GTEX-146FR-0526-SM-5Q5EX.Aligned.sortedByCoord.out.patched.md.bam.counts_gene
### next bam file 2023/02/17 09:29:54 1 files downloaded.
### -rw-r--r-- 1 linyong input 1.9M Feb 17 11:59 dir-gtex-38/GTEX-17JCI-2326-SM-7IGPC.Aligned.sortedByCoord.out.patched.md.bam.counts_gene

# dir-gtex-41/out-dir-gtex-41-Tue_Feb_14_15:21:42_EST_2023:1867:  [Exception type: ValueError, raised in libcalignmentfile.pyx:947]
# /lab/page_human_data/linyong2/dir-gtex-44/out-dir-gtex-44-Wed_Feb_15_15:26:05_EST_2023:13062:  [Exception type: ValueError, raised in libcalignmentfile.pyx:947]  
### dir-gtex-44/GTEX-1GTWX-0003-SM-EYYVV.Aligned.sortedByCoord.out.patched.md.bam  files have encountered an error during downloading
### INFO    2023-02-16 15:27:08     SamToFastq

# GTEX-XGQ4-1026-SM-4AT4L.Aligned.sortedByCoord.out.patched.md.bam
###EXITING: fatal error trying to allocate genome arrays, exception thrown: std::bad_alloc
###Possible cause 1: not enough RAM. Check if you have enough RAM 31588312371 bytes
###Possible cause 2: not enough virtual memory allowed with ulimit. SOLUTION: run ulimit -v 31588312371
### -rw-r--r-- 1 linyong page_hd 6.1G Feb 19 03:02 r4.fq
### -rw-r--r-- 1 linyong page_hd    0 Feb 19 03:02 /lab/page_human_data/linyong2/dir-gtex-54/GTEX-XGQ4-1026-SM-4AT4L.Aligned.sortedByCoord.out.patched.md.bam.counts_gene

# /lab/page_human_data/linyong2/dir-gtex-62/out-dir-gtex-62-Fri_Feb_17_13:22:32_EST_2023:218:  [Exception type: ValueError, raised in libcalignmentfile.pyx:947] GTEX-18465-0526-SM-7LG4K.Aligned.sortedByCoord.out.patched.md.bam, Error occurred when getting download URL for object; INFO    2023-02-17 13:22:40     SamToFastq; next bam file , "GTEX-11OC5-0626-SM-5HL6M.Aligned.sortedByCoord.out.patched.md.bam", to be downloaded 2023/02/17 13:27:52 A new version of gen3-client is available! The latest version is 2023.2.0. You are using version 2022.12;
head ../dir-gtex-84/GTEX-1ICLZ-0726-SM-ARL84.Aligned.sortedByCoord.out.patched.md.bam.counts_gene
ENSG00000000003.15      TSPAN6  757
ENSG00000000005.6       TNMD    24
ENSG00000000419.14      DPM1    620
ENSG00000000457.14      SCYL3   440
ENSG00000000460.17      C1orf112        194
ENSG00000000938.13      FGR     273
ENSG00000000971.17      CFH     3229
ENSG00000001036.14      FUCA2   520
ENSG00000001084.13      GCLC    399
ENSG00000001167.15      NFYA    630

head ../dir-gtex-84/GTEX-XMK1-0326-SM-4B652.Aligned.sortedByCoord.out.patched.md.bam.counts_gene
ENSG00000000003.15      TSPAN6  634
ENSG00000000005.6       TNMD    0
ENSG00000000419.14      DPM1    681
ENSG00000000457.14      SCYL3   347
ENSG00000000460.17      C1orf112        66
ENSG00000000938.13      FGR     75
ENSG00000000971.17      CFH     97
ENSG00000001036.14      FUCA2   733
ENSG00000001084.13      GCLC    717
ENSG00000001167.15      NFYA    463

head dir-gtex-97/GTEX-1B933-0011-R11a-SM-7P8PM.Aligned.sortedByCoord.out.patched.md.bam.counts_gene
ENSG00000000003.15      TSPAN6  95
ENSG00000000005.6       TNMD    0
ENSG00000000419.14      DPM1    1297
ENSG00000000457.14      SCYL3   622
ENSG00000000460.17      C1orf112        141
ENSG00000000938.13      FGR     125
ENSG00000000971.17      CFH     25
ENSG00000001036.14      FUCA2   281
ENSG00000001084.13      GCLC    861
ENSG00000001167.15      NFYA    1014

tail -n 15 dir-gtex-107/GTEX-13O3P-0626-SM-5L3D5.Aligned.sortedByCoord.out.patched.md.bam.counts_gene
ENSG00000291292.1       ENSG00000291292 0
ENSG00000291293.1       ENSG00000291293 0
ENSG00000291294.1       ENSG00000291294 0
ENSG00000291295.1       ENSG00000291295 0
ENSG00000291296.1       ENSG00000291296 4
ENSG00000291297.1       ENSG00000291297 0
ENSG00000291298.1       ENSG00000291298 0
ENSG00000291299.1       ENSG00000291299 48
ENSG00000291300.1       PRSS30P 0
ENSG00000291301.1       ENSG00000291301 0
__no_feature            2245732
__ambiguous             4096397
__too_low_aQual         0
__not_aligned           731747
__alignment_not_unique          1859550

dir-gtex-118/GTEX-ZAB5-2426-SM-5CVMW.Aligned.sortedByCoord.out.patched.md.bam.counts_gene <==
ENSG00000000003.15      TSPAN6  1901
ENSG00000000005.6       TNMD    2
ENSG00000000419.14      DPM1    1456
ENSG00000000457.14      SCYL3   443
ENSG00000000460.17      C1orf112        437
ENSG00000000938.13      FGR     144
ENSG00000000971.17      CFH     147
ENSG00000001036.14      FUCA2   223
ENSG00000001084.13      GCLC    574
ENSG00000001167.15      NFYA    2663

#######################################################################################################
###### Mar 2, 2023 gene count table for 1st 3k samples
rm -f dir-list
ls  /lab/solexa_page/linyong/ | grep dir-gtex- | awk '{print "/lab/solexa_page/linyong/" $0}' > dir-list
ls /lab/page_human_data/linyong2/ | grep "dir-gtex-[0-7][0-9]\/" | awk '{print "/lab/page_human_data/linyong2/" $0}' >> dir-list
wc -l dir-list
# 79 dir-list
bash  /lab/solexa_page/linyong/script-genecount-merge-2
ls  /lab/solexa_page/linyong/temp-gtexv8-* | wc -l
# 3127
cd /lab/solexa_page/linyong/
rm -f temp1
bsub "bash script-paste-files"
ls -lh m s
# -rw-r--r-- 1 linyong input 490M (3127 samples) Mar  2 19:21 s
grep -n '__no_feature' s | cut -f 1-10
# 62705:__no_feature
awk 'NR < 62705' s > temp1
# mv -i  temp1 gtex-comb-3127samp.gene.count.txt
awk '{print NF}' gtex-comb-3127samp.gene.count.txt | uniq -c | head
#  62704 3129
awk '{print NF}' s | uniq -c | head
#  62704 3129
#      5 3128 (lack gene_name column)
rm -f s

mkdir dir-gtex-141
cd dir-gtex-141
cp -i ../dir-gtex-131/slurm-gtexv8-pipeline-download-genecount .
grep -Ei "file_name|error"  ../dir-gtex-131/out-dir-gtex-131-Thu_16_Mar_2023_07\:50\:40_PM_EDT  | awk '{print NR, $0}'

grep -w chrM  /lab/solexa_page/linyong/gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | grep -w gene  | sort +3 -4gr
# PEER with covariates
echo "PEER with known covariates included in inference. Output in peer_our_covs/"
./peertool -f data/expression.csv -c data/covs.csv -n 20 -i 100 -o peer_out_covs


linyong@fry /lab/page_human_data/linyong2/test-dir$ samtools view  GTEX-ZP4G-0002-SM-6WBSI.cram | head
[W::cram_populate_ref] Creating reference cache directory /home/linyong/.cache/hts-ref
This may become large; see the samtools(1) manual page REF_CACHE discussion
H032JALXX140919:1:2207:24517:7181	1189	chr1	9996	0	*	=	9996	0	TGCCGTGCTTACTCCGCCCAACACCGCAACCACGCACCCCCCCCCCCCCACCCCCCACCCCACAAACCCCACACACCCACCAAACCCCCCACACCCCCCCCCCACACACACACAACACCCACACCACACAACAACACACAACACCAGCCAA	#######################################################################################################################################################	MC:Z:45S106M	PG:Z:MarkDuplicates	OQ:Z:#######################################################################################################################################################	RG:Z:H032J.1

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat MGB_100.gtex-orig.counts | wc -l
   57604
cat MGB_100.gtex-orig.counts | cut -f 1,3,5 > temp1
> setwd("/Users/linyongmao/Documents/dir-GTExV8")
t1 <- read.delim("temp1", row.names=1)
rawCount <- t1
group <- factor(rep(1, 2))
y <- DGEList(counts=rawCount,group=group)
y <- calcNormFactors(y)
#           group lib.size norm.factors
#count.gtex     1 30359242    1.0070915
#MGB_100        1 30791351    0.9929585
# 30359242 / 30791351 = 0.9859665
keep <-rowSums(cpm(y)>=1) >= 1
y<-y[keep,]
dim(y)
# [1] 11778     2
design <- model.matrix(~c("gtex", "mg"))
# error  No residual df
df <- as.data.frame( cpm(y))
> m <- lm( log10(df$MGB_100 + 1) ~ log10(df$count.gtex + 1) )
> summary(m)

Call:
lm(formula = log10(df$MGB_100 + 1) ~ log10(df$count.gtex + 1))

Residuals:
     Min       1Q   Median       3Q      Max 
-1.96619 -0.05109 -0.01576  0.01960  2.49084 

Coefficients:
                         Estimate Std. Error t value Pr(>|t|)    
(Intercept)              0.110140   0.004036   27.29   <2e-16 ***
log10(df$count.gtex + 1) 0.931960   0.002700  345.15   <2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.192 on 11776 degrees of freedom
Multiple R-squared:   0.91,	Adjusted R-squared:   0.91 
F-statistic: 1.191e+05 on 1 and 11776 DF,  p-value: < 2.2e-16

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat ../microglia/HALLMARK_INFLAMMATORY_RESPONSE.temp.genes | while read g
do
grep  " $g      "  MGB_100.gtex-orig.counts
done > temp2
cat temp2 | wc -l
     200
cat temp2 | awk '$3 == $5' | wc -l
      82
cat temp2 | awk '$3 != $5' | awk '{print $0 "\t" $5/$3}' | sort +5 -6g
geneID	name	count.gtex	geneID	MGB_100

ENSG00000136634	IL10	1621	ENSG00000136634	191	0.117829
ENSG00000105835	NAMPT	161214	ENSG00000105835	85591	0.530915
ENSG00000160223	ICOSLG	28	ENSG00000160223	16	0.571429
ENSG00000101017	CD40	877	ENSG00000101017	509	0.580388
ENSG00000109320	NFKB1	1717	ENSG00000109320	1471	0.856727
ENSG00000177272	KCNA3	357	ENSG00000177272	306	0.857143
ENSG00000080815	PSEN1	2402	ENSG00000080815	2097	0.873022
ENSG00000196352	CD55	39632	ENSG00000196352	35701	0.900812
ENSG00000163251	FZD5	741	ENSG00000163251	680	0.917679
ENSG00000137462	TLR2	49892	ENSG00000137462	46511	0.932234
ENSG00000125347	IRF1	16177	ENSG00000125347	15223	0.941027
ENSG00000175591	P2RY2	198	ENSG00000175591	187	0.944444
ENSG00000103313	MEFV	2301	ENSG00000103313	2181	0.947849
ENSG00000119535	CSF3R	65724	ENSG00000119535	63554	0.966983
ENSG00000136867	SLC31A2	430	ENSG00000136867	416	0.967442
ENSG00000185885	IFITM1	407	ENSG00000185885	395	0.970516
ENSG00000054523	KIF1B	3795	ENSG00000054523	3685	0.971014
ENSG00000142166	IFNAR1	4331	ENSG00000142166	4224	0.975294
ENSG00000197405	C5AR1	29213	ENSG00000197405	28578	0.978263
ENSG00000157227	MMP14	879	ENSG00000157227	864	0.982935
ENSG00000136244	IL6	654	ENSG00000136244	646	0.987768
ENSG00000169429	CXCL8	159116	ENSG00000169429	157368	0.989014
ENSG00000115009	CCL20	2666	ENSG00000115009	2640	0.990248
ENSG00000110324	IL10RA	8973	ENSG00000110324	8892	0.990973
ENSG00000100906	NFKBIA	72042	ENSG00000100906	71421	0.99138
ENSG00000159128	IFNGR2	10443	ENSG00000159128	10362	0.992244
ENSG00000167207	NOD2	11985	ENSG00000167207	11898	0.992741
ENSG00000060558	GNA15	2537	ENSG00000060558	2520	0.993299
ENSG00000100385	IL2RB	170	ENSG00000100385	169	0.994118
ENSG00000187764	SEMA4D	2386	ENSG00000187764	2372	0.994132
ENSG00000070961	ATP2B1	6385	ENSG00000070961	6361	0.996241
ENSG00000019169	MARCO	3951	ENSG00000019169	3938	0.99671
ENSG00000099985	OSM	34374	ENSG00000099985	34280	0.997265
ENSG00000162493	PDPN	467	ENSG00000162493	466	0.997859
ENSG00000077238	IL4R	3617	ENSG00000077238	3610	0.998065
ENSG00000043462	LCP2	48979	ENSG00000043462	48901	0.998407
ENSG00000174437	ATP2A2	1295	ENSG00000174437	1293	0.998456
ENSG00000163421	PROK2	17667	ENSG00000163421	17644	0.998698
ENSG00000185507	IRF7	810	ENSG00000185507	809	0.998765
ENSG00000142227	EMP3	2475	ENSG00000142227	2472	0.998788
ENSG00000159388	BTG2	114719	ENSG00000159388	114585	0.998832
ENSG00000110911	SLC11A2	879	ENSG00000110911	878	0.998862
ENSG00000184588	PDE4B	10684	ENSG00000184588	10672	0.998877
ENSG00000106546	AHR	1787	ENSG00000106546	1785	0.998881
ENSG00000126262	FFAR2	7445	ENSG00000126262	7437	0.998925
ENSG00000085117	CD82	6040	ENSG00000085117	6034	0.999007
ENSG00000106366	SERPINE1	1059	ENSG00000106366	1058	0.999056
ENSG00000028137	TNFRSF1B	14024	ENSG00000028137	14012	0.999144
ENSG00000171522	PTGER4	5910	ENSG00000171522	5905	0.999154
ENSG00000177105	RHOG	4320	ENSG00000177105	4317	0.999306
ENSG00000115594	IL1R1	1462	ENSG00000115594	1461	0.999316
ENSG00000108688	CCL7	1483	ENSG00000108688	1482	0.999326
ENSG00000132334	PTPRE	26749	ENSG00000132334	26731	0.999327
ENSG00000121797	CCRL2	4789	ENSG00000121797	4786	0.999374
ENSG00000067082	KLF6	64070	ENSG00000067082	64033	0.999423
ENSG00000134470	IL15RA	1907	ENSG00000134470	1906	0.999476
ENSG00000011422	PLAUR	34886	ENSG00000011422	34868	0.999484
ENSG00000130303	BST2	2276	ENSG00000130303	2275	0.999561
ENSG00000131979	GCH1	4609	ENSG00000131979	4607	0.999566
ENSG00000167995	BEST1	2848	ENSG00000167995	2847	0.999649
ENSG00000123610	TNFAIP6	2953	ENSG00000123610	2952	0.999661
ENSG00000090104	RGS1	9073	ENSG00000090104	9070	0.999669
ENSG00000173391	OLR1	9401	ENSG00000173391	9398	0.999681
ENSG00000055332	EIF2AK2	3153	ENSG00000055332	3152	0.999683
ENSG00000113070	HBEGF	19847	ENSG00000113070	19841	0.999698
ENSG00000169403	PTAFR	7301	ENSG00000169403	7299	0.999726
ENSG00000125538	IL1B	109046	ENSG00000125538	109017	0.999734
ENSG00000108691	CCL2	14478	ENSG00000108691	14475	0.999793
ENSG00000010327	STAB1	5178	ENSG00000010327	5177	0.999807
ENSG00000038945	MSR1	6574	ENSG00000038945	6573	0.999848
ENSG00000165168	CYBB	13244	ENSG00000165168	13242	0.999849
ENSG00000170458	CD14	40572	ENSG00000170458	40567	0.999877
ENSG00000188404	SELL	18160	ENSG00000188404	18158	0.99989
ENSG00000102265	TIMP1	24905	ENSG00000102265	24903	0.99992
ENSG00000171051	FPR1	35289	ENSG00000171051	35291	1.00006
ENSG00000059728	MXD1	27615	ENSG00000059728	27619	1.00014
ENSG00000124762	CDKN1A	43669	ENSG00000124762	43677	1.00018
ENSG00000184371	CSF1	4722	ENSG00000184371	4723	1.00021
ENSG00000136754	ABI1	8227	ENSG00000136754	8229	1.00024
ENSG00000124882	EREG	6708	ENSG00000124882	6710	1.0003
ENSG00000169508	GPR183	16071	ENSG00000169508	16076	1.00031
ENSG00000141506	PIK3R5	11983	ENSG00000141506	11988	1.00042
ENSG00000258227	CLEC5A	2258	ENSG00000258227	2259	1.00044
ENSG00000090339	ICAM1	20197	ENSG00000090339	20206	1.00045
ENSG00000137393	RNF144B	5743	ENSG00000137393	5746	1.00052
ENSG00000078401	EDN1	1700	ENSG00000078401	1701	1.00059
ENSG00000073008	PVR	1676	ENSG00000073008	1677	1.0006
ENSG00000139514	SLC7A1	1308	ENSG00000139514	1309	1.00076
ENSG00000135124	P2RX4	2431	ENSG00000135124	2433	1.00082
ENSG00000125384	PTGER2	7900	ENSG00000125384	7911	1.00139
ENSG00000115008	IL1A	575	ENSG00000115008	576	1.00174
ENSG00000174600	CMKLR1	558	ENSG00000174600	559	1.00179
ENSG00000049249	TNFRSF9	554	ENSG00000049249	555	1.00181
ENSG00000164136	IL15	490	ENSG00000164136	491	1.00204
ENSG00000161638	ITGA5	2377	ENSG00000161638	2382	1.0021
ENSG00000254087	LYN	13961	ENSG00000254087	13992	1.00222
ENSG00000148926	ADM	6856	ENSG00000148926	6880	1.0035
ENSG00000198121	LPAR1	1704	ENSG00000198121	1710	1.00352
ENSG00000104312	RIPK2	6503	ENSG00000104312	6526	1.00354
ENSG00000171596	NMUR1	262	ENSG00000171596	263	1.00382
ENSG00000103569	AQP9	9587	ENSG00000103569	9628	1.00428
ENSG00000131871	SELENOS	853	ENSG00000131871	857	1.00469
ENSG00000017260	ATP2C1	1108	ENSG00000017260	1114	1.00542
ENSG00000117091	CD48	1686	ENSG00000117091	1703	1.01008
ENSG00000170425	ADORA2B	76	ENSG00000170425	77	1.01316
ENSG00000175040	CHST2	530	ENSG00000175040	539	1.01698
ENSG00000089041	P2RX7	2101	ENSG00000089041	2137	1.01713
ENSG00000173039	RELA	3131	ENSG00000173039	3203	1.023
ENSG00000164023	SGMS2	911	ENSG00000164023	954	1.0472
ENSG00000065135	GNAI3	5256	ENSG00000065135	6072	1.15525
ENSG00000136997	MYC	1945	ENSG00000136997	2347	1.20668
ENSG00000122641	INHBA	161	ENSG00000122641	200	1.24224
ENSG00000100644	HIF1A	11259	ENSG00000100644	14210	1.2621
ENSG00000121989	ACVR2A	161	ENSG00000121989	216	1.34161
ENSG00000172575	RASGRP1	249	ENSG00000172575	389	1.56225
ENSG00000132155	RAF1	5473	ENSG00000132155	8798	1.60753
ENSG00000231925	TAPBP	6543	ENSG00000231925	11503	1.75806
ENSG00000162711	NLRP3	1562	ENSG00000162711	12689	8.12356

cat temp2 | awk '$3 == $5 && $3 > 0'  | sort +2 -3g
ENSG00000064989	CALCRL	2	ENSG00000064989	2
ENSG00000110436	SLC1A2	2	ENSG00000110436	2
ENSG00000105855	ITGB8	3	ENSG00000105855	3
ENSG00000124875	CXCL6	6	ENSG00000124875	6
ENSG00000057019	DCBLD2	11	ENSG00000057019	11
ENSG00000115604	IL18R1	21	ENSG00000115604	21
ENSG00000105246	EBI3	23	ENSG00000105246	23
ENSG00000169245	CXCL10	25	ENSG00000169245	25
ENSG00000105711	SCN1B	58	ENSG00000105711	58
ENSG00000164342	TLR3	68	ENSG00000164342	68
ENSG00000196639	HRH1	103	ENSG00000196639	103
ENSG00000172215	CXCR6	117	ENSG00000172215	117
ENSG00000160013	PTGIR	122	ENSG00000160013	122
ENSG00000134070	IRAK2	126	ENSG00000134070	126
ENSG00000074660	SCARF1	173	ENSG00000074660	173
ENSG00000168685	IL7R	181	ENSG00000168685	181
ENSG00000117090	SLAMF1	206	ENSG00000117090	206
ENSG00000146242	TPBG	222	ENSG00000146242	222
ENSG00000167601	AXL	227	ENSG00000167601	227
ENSG00000102962	CCL22	269	ENSG00000102962	269
ENSG00000123700	KCNJ2	287	ENSG00000123700	287
ENSG00000271503	CCL5	289	ENSG00000271503	289
ENSG00000135503	ACVR1B	405	ENSG00000135503	405
ENSG00000145623	OSMR	478	ENSG00000145623	478
ENSG00000204681	GABBR1	484	ENSG00000204681	484
ENSG00000150782	IL18	524	ENSG00000150782	524
ENSG00000115607	IL18RAP	560	ENSG00000115607	560
ENSG00000130706	ADRM1	641	ENSG00000130706	641
ENSG00000125657	TNFSF9	935	ENSG00000125657	935
ENSG00000128342	LIF	1058	ENSG00000128342	1058
ENSG00000174837	ADGRE1	1164	ENSG00000174837	1164
ENSG00000143333	RGS16	1338	ENSG00000143333	1338
ENSG00000160932	LY6E	1527	ENSG00000160932	1527
ENSG00000136868	SLC31A1	1904	ENSG00000136868	1904
ENSG00000075142	SRI	1969	ENSG00000075142	1969
ENSG00000123609	NMI	2047	ENSG00000123609	2047
ENSG00000165029	ABCA1	2666	ENSG00000165029	2666
ENSG00000130164	LDLR	2980	ENSG00000130164	2980
ENSG00000183484	GPR132	2982	ENSG00000183484	2982
ENSG00000176170	SPHK1	3753	ENSG00000176170	3753
ENSG00000121858	TNFSF10	4348	ENSG00000121858	4348
ENSG00000171860	C3AR1	7615	ENSG00000171860	7615
ENSG00000110848	CD69	7968	ENSG00000110848	7968
ENSG00000174125	TLR1	9152	ENSG00000174125	9152

chr1    HAVANA  exon    247423847       247425599       .       +       .       gene_id "ENSG00000162711.18"; transcript_id "ENST00000697350.1"; gene_type "protein_coding"; gene_name "NLRP3"; transcript_type "protein_coding"; transcript_name "NLRP3-210"; exon_number 4; exon_id "ENSE00001067929.1"; level 2; protein_id "ENSP00000513275.1"; hgnc_id "HGNC:16400"; tag "alternative_5_UTR"; tag "upstream_ATG"; tag "RNA_Seq_supported_only"; tag "basic"; tag "appris_principal_1"; havana_gene "OTTHUMG00000040647.7";

chr1    HAVANA  exon    247423847       247425599       .       +       .       gene_id "ENSG00000289728.1"; transcript_id "ENST00000697408.1"; gene_type "lncRNA"; gene_name "ENSG00000289728"; transcript_type "lncRNA"; transcript_name "ENST00000697408"; exon_number 7; exon_id "ENSE00003970522.1"; level 2; tag "RNA_Seq_supported_only"; tag "basic"; tag "Ensembl_canonical"; tag "readthrough_transcript";

cat /lab/solexa_page/linyong/Homo_sapiens.GRCh38.90.gtf| grep "24742[0-9][0-9][0-9][0-9]"  | awk '$1 == 1'  | grep -v NLRP3 | wc -l
0

for d in  `echo "dir-gtex-433 dir-gtex-436 dir-gtex-437 dir-gtex-438 dir-gtex-439" `
do
 tail -n 1 $d/out*
 cd  $d
 rm -f [GL]*
 sbatch slurm-gtexv8-pipeline-download-genecount 
 cd ..
 sleep 30
done

#####################################check stuck then rerun results
cd ../dir-gtex-433
ls -lh *counts_gene | sort  +5 -6 +6 -7g +7 -8 | awk '{print $7}' | uniq -c
ls -lh *counts_gene | sort  +5 -6 +6 -7g +7 -8
ls *counts_gene | while read f; do grep -iw ddx3y "$f"; grep -iw xist "$f"; echo; done

scontrol show job | grep linyong | grep StdOut | grep -o "dir-gtex-[0-9]*" | sort | uniq | while read d
do
echo $d
cat $d/out* | tail
echo
done

#########################merge gene count files; combine
ls  /lab/solexa_page/linyong/ | grep "^dir-gtex-[0-9]*/"  | awk '{print "/lab/solexa_page/linyong/" $0}' > dir-list
ls /lab/page_human_data/linyong2/ | grep "^dir-gtex-[0-9]*/" | awk '{print "/lab/page_human_data/linyong2/" $0}' >> dir-list
wc -l dir-list*
cat dir-list* | sort | uniq -d | wc -l
cat dir-list* | sort | uniq -u | wc -l
cat dir-list* | sort | uniq -u > temp
mv temp dir-list
###rm dir-gtex-462 from dir-list because dir-gtex-462 is still running
bash  /lab/solexa_page/linyong/script-genecount-merge-2
cat  /lab/solexa_page/linyong/temp-error | grep -v "cannot access" |head
ls  /lab/solexa_page/linyong/temp-gtexv8-* | wc -l
# 6402
cd /lab/solexa_page/linyong/
rm -f temp1
bsub "bash script-paste-files"
# 8 hour running on LSF
ls -lh s  f2 m
grep -n '__no_feature' s | cut -f 1-10
# 62705:__no_feature            1875341 3762916 3548239 3767337 2554672 3159592 2963935 2526148
awk 'NR < 62705' s > temp1
mv -i temp1 gtex-comb-6402samp.gene.count.txt
chmod -w gtex-comb-6402samp.gene.count.txt
awk '{print NF}' gtex-comb-6402samp.gene.count.txt | uniq -c | head
#  62704 6404
rm -f s

##########################################################
-r--r--r-- 1 linyong systemd-timesync  513411552 Mar  2 22:21 gtex-comb-3127samp.gene.count.txt
-r--r--r-- 1 linyong systemd-timesync  719148199 Mar 27 11:39 gtex-comb-4388samp.gene.count.txt
-r--r--r-- 1 linyong systemd-timesync 1048559353 Apr 27 23:40 gtex-comb-6402samp.gene.count.txt
-r--r--r-- 1 linyong input 380514586 May 27 01:44 gtex-comb-2317samp.gene.count.txt

################################################select 10 random samples within top half
linyongmao@Linyong-Mao-MBP16-2019 dir-gtex-website-data % cat  GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct | awk '{print NF}' | uniq -c
   1 1
   1 2
56201 17384
awk 'NR > 2'  GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct  > temp
mv temp  GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct 
head -1 GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct  | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print i, $i}' > GTEx_Analysis_2017-06-05_header
cut -f 1,7    GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt > sample-tissue.2colum
cut -f 2 sample-tissue.2colum | sort | uniq -c | wc
      56 
cat   GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt | cut -f 7,17 | sort | uniq -c   
 432 Heart - Left Ventricle	RNASEQ
 429 Heart - Atrial Appendage	RNASEQ
 803 Muscle - Skeletal	RNASEQ

> setwd("/Users/linyongmao/Documents/dir-GTExV8/dir-gtex-website-data")
t1 <- read.delim("sample-tissue.2colum", header=F)
t2 <- t1[ t1$V2 == "Heart - Left Ventricle", ]
t3 <- read.delim("GTEx_Analysis_2017-06-05_header", header=F)
head(t3)
#  V1                       V2
#1  1                     Name
#2  2              Description
#3  3 GTEX-1117F-0226-SM-5GZZ7

t4 <- merge(t3, t2, by.x="V2", by.y="V1")
dim(t4)
# [1] 432   3
head(t4)
#                         V2  V1                   V2.y
# 1 GTEX-111FC-0826-SM-5GZWO  40 Heart - Left Ventricle
# 2 GTEX-111YS-0426-SM-5987O  65 Heart - Left Ventricle
raw <- read.delim("GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct", header=T)
dim(raw)
###[1] 56200genes  17384
raw2 <- raw[, t4$V1 ]
rownames(raw2) <- raw$Name
y <- DGEList(counts=raw2)
y <- calcNormFactors(y)
med <- data.frame(y$counts[,1])
med$logic <- TRUE
d <- cpm(y)
for(i in 1:dim(y)[1]) {
 med$logic[i] <- median(d[i,]) >= 1
}
####median >= 1 for pathway genes
y<-y[med$logic,]
dim(y)
# [1] 13615   432
d = cpm(y)
t9 <- as.data.frame(d)
t10 <- log10(t9 + 1)
t11 <- cor(t10)
t12 <- as.data.frame(t11)
mat <- as.matrix(t12)
res <- data.frame(id = colnames(mat), mean = colMeans(mat))
summary( res$mean)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  0.7060  0.8903  0.9091  0.8977  0.9158  0.9291 
med <- median(res$mean)
r2 <- res[ res$mean > med, ]
dim(r2)
##[1] 216   2
set.seed(1234)
r3 <- r2[ sample(1:dim(r2)[1], 10 ), ]
write.table(r3, "Heart - Left Ventricle.10.samples", quote=F, sep='\t')

#########################merge gene count files; combine; May 25, 2023
cd /lab/page_human_data/linyong2/
from prev commands
vi dir-list
/lab/page_human_data/linyong2/dir-gtex-462/
/lab/page_human_data/linyong2/dir-gtex-487/
/lab/page_human_data/linyong2/dir-gtex-488/
/lab/page_human_data/linyong2/dir-gtex-489/
/lab/page_human_data/linyong2/dir-gtex-490/
...
/lab/page_human_data/linyong2/dir-gtex-601/
2317 samples

################################# order-bam.notProcessed
cat /lab/solexa_page/linyong/file-manifest.json  | grep "Aligned.sortedByCoord.out.patched.md.bam" | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print NR, $1}' > temp1
vi temp1
linyong@fry /lab/solexa_page/linyong$ tail temp1
...
17348   GTEX-1HCVE-1026-SM-ACKXR.Aligned.sortedByCoord.out.patched.md.bam
17349   GTEX-1GN2E-1526-SM-7P8TD.Aligned.sortedByCoord.out.patched.md.bam
17350   GTEX-17JCI-1526-SM-7IGOQ.Aligned.sortedByCoord.out.patched.md.bam
mv temp1 file-manifest.order-bam.txt
 head -1 *samp.gene.count.txt | grep -w "geneID"  |cut -f 3-1234567 | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print  $i}' > temp2
wc -l temp2
16234 temp2
> 2317 + 3127 + 4388 + 6402
[1] 16234
head temp2
GTEX-1117F-0526-SM-5EGHJ.
GTEX-1117F-2826-SM-5GZXL.
GTEX-111CU-0626-SM-5EGHL.
cat temp2  | while read g; do grep  "$g"Aligned file-manifest.order-bam.txt; done > temp3
cat file-manifest.order-bam.txt temp3 | sort | uniq -d | wc
  16234
cat file-manifest.order-bam.txt temp3 | sort | uniq -u | wc
   1116
cat file-manifest.order-bam.txt temp3 | sort | uniq -u > file-manifest.order-bam.notProcess.5.27.23
head /lab/solexa_page/linyong/file-manifest.order-bam.notProcess.5.27.23  
10068   GTEX-146FR-1826-SM-5QGPF.Aligned.sortedByCoord.out.patched.md.bam
10069   GTEX-13RTJ-0726-SM-5QGQN.Aligned.sortedByCoord.out.patched.md.bam
10070   GTEX-15RIE-0626-SM-6M47G.Aligned.sortedByCoord.out.patched.md.bam

#################################filter first then normalization?
cp -i temp-tissue-names tissue-names-lucas-list
Rscript R-script-select-gtex-samples-in-a-tissue > out-select-gtex-samples-in-a-tissue 
###median < 0.9 tissues
6 GTEX-11DXX-1326-SM-5GIDZ 257 Stomach
[1] 15530   359
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.7631  0.8313  0.8708  0.8562  0.8829  0.9073 

6 GTEX-117YW-1826-SM-5PNY5 167 Colon - Transverse
[1] 16005   406
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.7880  0.8249  0.8440  0.8467  0.8712  0.9002 

cut -f 2 *10samples.940pm  | grep -vw mean > list.10samples.940pm.per15tissues

setwd("/Users/linyongmao/Documents/dir-GTExV8/dir-gtex-website-data")
raw <- read.delim("GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct", header=T)
dim(raw)
samp <- read.delim("list.10samples.940pm.per15tissues", header=F)
dim(samp)
# [1] 150   1
raw.samp <- raw[, colnames(raw) %in% samp$V1]
dim(raw.samp)
#[1] 56200   150
rownames(raw.samp) <- raw$Name
length(raw.samp[,1] - raw[, "GTEX.11DXW.1026.SM.5H11K"]  )
##[1] 56200
summary( raw.samp[,1] - raw[, "GTEX.11DXW.1026.SM.5H11K"]  )
write.table(raw.samp, "temp.raw.txt", quote=F, sep="\t")
system("bash script-sel-expr-genes")
raw.samp.filt <- read.delim("temp-1338", header=T)
dim(raw.samp.filt)
##[1] 25271   150
y <- DGEList(counts=raw.samp.filt)
y <- calcNormFactors(y)
summary(y$samples$lib.size)
##    Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
##35270131  51678694  62455252  65975200  77647586 124561663 
summary(y$samples$norm.factors)
##   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
## 0.4770  0.7966  1.0715  1.0415  1.2766  1.5738 

y <- DGEList(counts=raw.samp)
y <- calcNormFactors(y)
> summary(y$samples$lib.size)
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
 35282054  51700389  62499855  66006365  77674598 124592493 
> summary(y$samples$norm.factors)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.4991  0.8023  1.0639  1.0389  1.2576  1.5958 

#################################sample x gene heatmap 
head(colnames(raw))
# [1] "Name"                     "Description"              "GTEX.1117F.0226.SM.5GZZ7" "GTEX.1117F.0426.SM.5EGHI" "GTEX.1117F.0526.SM.5EGHJ" "GTEX.1117F.0626.SM.5N9CS"
dim(raw)
# [1] 56200 17384

y <- DGEList(counts=raw.samp)
y <- calcNormFactors(y)
dim(y)
#[1] 56200   150
keep <-rowSums(cpm(y)>=1) >= 10
y<-y[keep,]
dim(y)
#[1] 20784   150
d = cpm(y)
a <- d
b = log10(a+1)
b.df <- as.data.frame(b)
b.mat <- as.matrix(b.df)
b.mat.t <- t(b.mat)
t1 <- read.delim("sample-tissue.2colum", header=F)
b.mat.t.df <- as.data.frame(b.mat.t)
b.mat.t.df$id <- rownames(b.mat.t.df)
###add a column id to t1, 'GTEX.1117F.0003.SM.58Q7G'
t1$id <- gsub("-", ".", t1$V1)
t2 <- merge(b.mat.t.df, t1, by.x="id", by.y="id")
dim(t2)
t3 <- read.delim("samp-name-T55", header=F)
head(t3)
#                            V1 V2
#1       Adipose - Subcutaneous T1
#2 Adipose - Visceral (Omentum) T2
#3                Adrenal Gland T3

t4 <- merge(t2, t3, by.x="V2", by.y="V1")
rownames(t4) <- paste( t4$V2.y, gsub("GTEX", "", t4$V1), sep="")
t4[1:2, c(1:3, 20785:20788)]
#                                                  V2                       id ENSG00000227232.5 ENSG00000210194.1 ENSG00000198727.2                       V1 V2.y
# T2-145ME-0726-SM-5O9A3 Adipose - Visceral (Omentum) GTEX.145ME.0726.SM.5O9A3         0.5625113         0.3050703          3.953870 GTEX-145ME-0726-SM-5O9A3   T2
# T2-1KXAM-0526-SM-DKPQN Adipose - Visceral (Omentum) GTEX.1KXAM.0526.SM.DKPQN         0.3690278         0.3502886          3.935615 GTEX-1KXAM-0526-SM-DKPQN   T2

mat <- as.matrix(t4[, c(3:20786)])
ca <- HeatmapAnnotation(tissue = t4$V2, which="row")
> Heatmap(matrix = mat, show_column_names=F, name="logCPM", row_names_gp = gpar(fontsize = 4), right_annotation=ca, row_dend_width=unit(30, "mm"))

rowlabel <- data.frame(t4$V2)
rowlabel$tissue <- ""
rowlabel$tissue[ seq(1, 150, 10)] <- t4$V2[ seq(1,150, 10)]
Heatmap(matrix = mat, show_column_names=F, name="logCPM", row_names_gp = gpar(fontsize = 6), right_annotation=ca, row_dend_width=unit(30, "mm"), row_labels= rowlabel$tissue)

cut -f 1 GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt > temp1
cut -f 1 GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"}  {print $1, $1}'| sed 's/-/@@@/' | sed 's/-.*      /       /' | sed 's/@@@/-/' > temp1
vi temp1
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine  temp1 GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.txt out
paste temp1 out  | cut -f 1-6 > GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt

> t5 <- read.delim("GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
> t4.sex <- merge(t5, t4, by.x="SAMPID", by.y="V1")
> t4.sex$sex <- "male"
> t4.sex[ t4.sex$SEX == 2, ]$sex <- "female"
> ca <- HeatmapAnnotation(tissue = t4.sex$V2, sex = t4.sex$sex,which="row")
> ca <- HeatmapAnnotation(tissue = t4.sex$V2, sex = t4.sex$sex,which="row", col=list(sex = c("female" = "red", "male" = "blue")))
> mat <- as.matrix(t4.sex[, c(9:20792)])
> dim(mat)
[1]   150 20784

#####################################using z-score of log10(cpm+1), pearson for clustering
mat <- as.matrix(t4[, c(3:20786)])
a <- mat
for(i in 1:dim(mat)[1])
{
 a[i, ] <- (mat[i, ] - mean(as.numeric(mat[i,]))) / var(as.numeric(mat[i,]))^(1/2)
}
###a is z-score of log10(cpm+1)
m1 <- mat
mat <- a
summary( data.frame(mat[11,]))
var( data.frame(mat[11,]))

ca <- HeatmapAnnotation(tissue = t4$V2, which="row")
> Heatmap(matrix = mat, show_column_names=F, name="z-score", row_names_gp = gpar(fontsize = 4), right_annotation=ca, row_dend_width=unit(30, "mm"), clustering_distance_rows="pearson", clustering_distance_columns="pearson")

rowlabel <- data.frame(t4$V2)
rowlabel$tissue <- ""
rowlabel$tissue[ seq(1, 150, 10)] <- t4$V2[ seq(1,150, 10)]
> Heatmap(matrix = mat, show_column_names=F, name="z-score", row_names_gp = gpar(fontsize = 4), right_annotation=ca, row_dend_width=unit(30, "mm"), clustering_distance_rows="pearson", clustering_distance_columns="pearson", row_labels= rowlabel$tissue)


#######################################################Website downloaded gene count vs. my star-htseq pipeline

> t2 <- merge(b.mat.t.df, t1, by.x="id", by.y="id")
t3 <- t2[ t2$V2 == "Heart - Atrial Appendage",][, 1:11]
y$samples[ t3$id,]
# GTEX.1AX8Z.1126.SM.731CS     1  60397468    0.9614743
# GTEX-1AX8Z-1126-SM-731CS Heart - Atrial Appendage GTEX.1AX8Z.1126.SM.731CS

GTEX-1AX8Z-1126-SM-731CS
gtex-comb-6402samp.gene.count.txt
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % head -1 gtex-comb-6402samp.gene.count.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print i, $i}' | grep GTEX-1AX8Z-1126-SM-731CS
2464	GTEX-1AX8Z-1126-SM-731CS.
cut -f 1,2,2464 gtex-comb-6402samp.gene.count.txt > temp1
vi temp1               
# :1, $ s/\.[0-9]*//
linyongmao@Linyong-Mao-MBP16-2019 dir-gtex-website-data % cut -f 1,2,6674 GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct > temp2
vi temp2
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine ../temp1 temp2  out
paste  ../temp1 out | grep -v notApplicable > temp3

> me.gtex.compare <- read.delim("temp3")
    geneID              name           GTEX.1AX8Z.1126.SM.731CS   geneID.1         Description        GTEX.1AX8Z.1126.SM.731CS.1
 Length:55484       Length:55484       Min.   :      0.0        Length:55484       Length:55484       Min.   :      0           
 Class :character   Class :character   1st Qu.:      0.0        Class :character   Class :character   1st Qu.:      0           
 Mode  :character   Mode  :character   Median :      1.0        Mode  :character   Mode  :character   Median :      1           
                                       Mean   :    535.7                                              Mean   :   1087           
                                       3rd Qu.:     55.0                                              3rd Qu.:    112           
                                       Max.   :1815295.0                                              Max.   :3542877           
me.gtex.2 <- me.gtex.compare[ me.gtex.compare$GTEX.1AX8Z.1126.SM.731CS > 5 & me.gtex.compare$GTEX.1AX8Z.1126.SM.731CS.1 >5,]
dim(me.gtex.2)
# [1] 19590     6
res <- lm( me.gtex.2$GTEX.1AX8Z.1126.SM.731CS.1 ~ me.gtex.2$GTEX.1AX8Z.1126.SM.731CS)
summary(res)

# Coefficients:
#                                     Estimate Std. Error  t value Pr(>|t|)    
# (Intercept)                        67.126582  28.100205    2.389   0.0169 *  
# me.gtex.2$GTEX.1AX8Z.1126.SM.731CS  1.978679   0.001423 1390.068   <2e-16 ***
# 
# Multiple R-squared:   0.99,	Adjusted R-squared:   0.99 
# F-statistic: 1.932e+06 on 1 and 19588 DF,  p-value: < 2.2e-16

res <- lm( log2(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS.1) ~ log2(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS))
summary(res)

# Coefficients:
#                                          Estimate Std. Error t value Pr(>|t|)    
# (Intercept)                              0.709241   0.016022   44.27   <2e-16 ***
# log2(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS) 1.022752   0.001951  524.15   <2e-16 ***
# 
# Multiple R-squared:  0.9334,	Adjusted R-squared:  0.9334 
# F-statistic: 2.747e+05 on 1 and 19588 DF,  p-value: < 2.2e-16

####################################
plot(log2(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS.1) ~ log2(2 * me.gtex.2$GTEX.1AX8Z.1126.SM.731CS), xlab="log2( 2 * geneCount), STAR-htseq", ylab = "log2(geneCount), RNA-SeQC")
y = 1:5
x = y
abline(lm(y~x), lwd = 1, col="blue")
# abline(lm( log2(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS.1) ~ log2(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS)), lwd = 1, col="blue")
abline(h = seq(-100,100,5), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(-100,100,5), lty = 5, lwd = 0.5, col = "gray")
text(5, 20, "y = x", col="blue")

me.gtex.2 <- me.gtex.compare[ me.gtex.compare$GTEX.1AX8Z.1126.SM.731CS > 5 | me.gtex.compare$GTEX.1AX8Z.1126.SM.731CS.1 >5,]
dim(me.gtex.2)
# [1] 22391     6
res <- lm( me.gtex.2$GTEX.1AX8Z.1126.SM.731CS.1 ~ me.gtex.2$GTEX.1AX8Z.1126.SM.731CS)
summary(res)
# lm(formula = me.gtex.2$GTEX.1AX8Z.1126.SM.731CS.1 ~ me.gtex.2$GTEX.1AX8Z.1126.SM.731CS)
# 
# Coefficients:
#                                     Estimate Std. Error  t value Pr(>|t|)    
# (Intercept)                        68.696260  24.716778    2.779  0.00545 ** 
# me.gtex.2$GTEX.1AX8Z.1126.SM.731CS  1.978662   0.001339 1478.195  < 2e-16 ***
# Residual standard error: 3689 on 22389 degrees of freedom
# Multiple R-squared:  0.9899,	Adjusted R-squared:  0.9899 

#11 ; 22
#11+1; 22+2
#2*(11+1); 22+2
#2(a+1); 2a+2

res <- lm( log2(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS.1+2) ~ log2(2*(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS+1)))
summary(res)
# Call:
# lm(formula = log2(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS.1 + 2) ~ 
#     log2(2 * (me.gtex.2$GTEX.1AX8Z.1126.SM.731CS + 1)))
# 
# Coefficients:
#                                                    Estimate Std. Error t value Pr(>|t|)    
# (Intercept)                                        0.651697   0.022193   29.36   <2e-16 ***
# log2(2 * (me.gtex.2$GTEX.1AX8Z.1126.SM.731CS + 1)) 0.920062   0.002564  358.87   <2e-16 ***
# 
# Residual standard error: 1.259 on 22389 degrees of freedom
# Multiple R-squared:  0.8519,	Adjusted R-squared:  0.8519 

plot(log2(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS.1+2) ~ log2(2*(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS+1)), xlab="log2(2 *(geneCount + 1)), STAR-htseq", ylab =     "log2(geneCount + 2), RNA-SeQC", ylim=c(0, 25), xlim=c(0, 25))
abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
y = 1:5 
x = y 
abline(lm(y~x), lwd = 1, col="blue")
text(5, 20, "y = x", col="blue")
#########
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat  temp3 | awk 'BEGIN {FS = "\t"; OFS = "\t"} $6 > 5 && $3 > 5' > temp4
# 19590 expressed genes in both approaches
cat temp4 | awk 'BEGIN {FS = "\t"; OFS = "\t"}  NR > 1 {print $0, $6 / ($3 * 2);}' > temp5
dir-gtex-website-data/GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct
cat temp5 | awk 'BEGIN {FS = "\t"; OFS = "\t"}  $7 < 1/2' | wc -l
    1136
cat temp5 | awk 'BEGIN {FS = "\t"; OFS = "\t"}  $7 > 2' | wc -l
#     669genes higher expr in website of gtex

cat temp5 | awk 'BEGIN {FS = "\t"; OFS = "\t"}  $7 < 1/10' | wc -l
      50
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp5 | awk 'BEGIN {FS = "\t"; OFS = "\t"}  $7 > 10' | wc -l
     187

ENSG00000243646 IL10RB  41      ENSG00000243646 IL10RB  1164    14.1951
ENSG00000276409 CCL14   64      ENSG00000276409 CCL14   1573    12.2891
ENSG00000100142 POLR2F  638     ENSG00000100142 POLR2F  35      0.0274295
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp3 |  awk 'BEGIN {FS = "\t"; OFS = "\t"}  $3 == 0 && $6 > 200' |wc
     130     780    7322
cat temp3 |  awk 'BEGIN {FS = "\t"; OFS = "\t"}  $6 == 0 && $3 > 100' |wc
       2      12     117

#################################randomly select 10 samples among top half for metabolite data
raw <- read.csv("allTissues_filtered_3QCcriteria_noNAvalues_60metabolites_in_columns.csv")
dim(raw)
# [1] 378  63
rownames(raw) <- raw$sample_name
tiss <- unique(raw$tissue)
# 19 tissues
for(index in 1:length(tiss))
{
x <- tiss[index]
print(x)

raw.tis <- raw[ raw$tissue == x, ]
dim(raw.tis)
# "LV" [1] 23samples 63metabolites - 3
met.tis.df <- log10(raw.tis[, 4:63] + 1)
print(dim(met.tis.df))
t1 <- as.matrix(met.tis.df)
t2 <- t(t1)
t3 <- as.data.frame(t2)
t11 <- cor(t3)
t12 <- as.data.frame(t11)
mat <- as.matrix(t12)
res <- data.frame(id = colnames(mat), mean = colMeans(mat))
print(summary( res$mean))
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
#  0.9820  0.9862  0.9886  0.9879  0.9903  0.9914
if(dim(met.tis.df)[1] < 10)
{
 print(dim(met.tis.df));
 r3 <- res;
}
else
{
 med <- median(res$mean)
 r2 <- res[ res$mean > med, ]
 print(dim(r2))
 # [1] 11  2
 set.seed(1234)
 r3 <- r2[ sample(1:dim(r2)[1], 10 ), ]                                  
}
#                                                                        id      mean
# 20220607_QE2_LC_Job2504_Heart_LV_147 20220607_QE2_LC_Job2504_Heart_LV_147 0.9911448
# 20220607_QE2_LC_Job2504_Heart_LV_167 20220607_QE2_LC_Job2504_Heart_LV_167 0.9902635
outfile <- paste("metab.", x, ".10samples.157pm", sep = "")
print(outfile)
write.table(r3, outfile, quote=F, sep='\t')
}

#################################sample x metabolite heatmap
linyongmao@Linyong-Mao-MBP16-2019 dir-gtex-website-data % cut -f 1 metab*.157pm | grep -wv id > list.10samples.orless.940pm.per19tissues
rm(list=ls())
raw <- read.csv("allTissues_filtered_3QCcriteria_noNAvalues_60metabolites_in_columns.csv")
samp <- read.delim("list.10samples.orless.940pm.per19tissues", header=F)
dim(samp)
# [1] 176   1
raw.samp <- raw[ raw$sample_name %in% samp$V1,]
# raw.samp <- raw
dim(raw.samp)
# [1] 176  63
raw.tis <- raw.samp
dim(raw.tis)
# "LV" [1] 23samples 63metabolites - 3
b <- log10(raw.tis[, 4:63] + 1)
a = b
for(i in 1:dim(b)[1])
{
 a[i, ] <- (b[i, ] - mean(as.numeric(b[i,]))) / var(as.numeric(b[i,]))^(1/2)
}
met.tis.df <- a
print(dim(met.tis.df))
# [1] 176  60
rownames(met.tis.df) <- raw.tis$sample_name
mat <- as.matrix(met.tis.df)
ca <- HeatmapAnnotation(tissue = raw.tis$tissue, which="row")
rowlabel <- data.frame(raw.tis$CDP)
rowlabel$tissue <- ""
step = 4
rowlabel$tissue[ seq(1, dim(met.tis.df)[1], step)] <- raw.tis$tissue[ seq(1, dim(met.tis.df)[1], step)]
Heatmap(matrix = mat, show_column_names=F, name="logMetab", row_names_gp = gpar(fontsize = 4), right_annotation=ca, row_dend_width=unit(30, "mm"), row_labels= rowlabel$tissue)
> Heatmap(matrix = mat, show_column_names=F, name="z-socre (metab)", row_names_gp = gpar(fontsize = 4), right_annotation=ca, row_dend_width=unit(30, "mm"), clustering_distance_rows="pearson", clustering_distance_columns="pearson")

#################################################################################################
linyong@fry /lab/solexa_page/linyong$ awk '{print NF}' gtex-all-samples.gene.count.txt | uniq -c
  62704 17352
linyong@fry /lab/solexa_page/linyong$ ls -lh gtex-all-samples.gene.count.txt
-r--r--r-- 1 linyong systemd-timesync 2.7G Jun 19 16:29 gtex-all-samples.gene.count.txt
#############################################################################
# STAR-HTseq Gencode.v42.
raw <- read.delim("gtex-all-samples.gene.count.txt", header=T)
dim(raw)
# [1] 62703 17352
samp <- read.delim("dir-gtex-website-data/list.10samples.940pm.per15tissues", header=F)
dim(samp)
# [1] 150   1
samp$V2 <- paste( samp$V1, ".", sep="")
raw.samp <- raw[, colnames(raw) %in% samp$V2]
dim(raw.samp)
# [1] 62703   150
rownames(raw.samp) <- raw$geneID
length(raw.samp[,1] - raw[, "GTEX.11DXW.1026.SM.5H11K."]  )
# [1] 62703
summary( raw.samp[,1] - raw[, "GTEX.11DXW.1026.SM.5H11K."]  )
y <- DGEList(counts=raw.samp)
y <- calcNormFactors(y)
dim(y)
# [1] 62703   150
summary(y$samples$norm.factors)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.4905  0.8240  1.0683  1.0344  1.2348  1.5247 
summary(y$samples$lib.size)
#     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
# 17613867 25867647 31913960 33285316 38551244 60174325 
keep <-rowSums(cpm(y)>=1) >= 10
y<-y[keep,]
dim(y)
# [1] 22204   150
d = cpm(y)
a <- d
b = log10(a+1)
b.df <- as.data.frame(b)
b.mat <- as.matrix(b.df)
b.mat.t <- t(b.mat)
t1 <- read.delim("dir-gtex-website-data/sample-tissue.2colum", header=F)
b.mat.t.df <- as.data.frame(b.mat.t)
b.mat.t.df$id <- rownames(b.mat.t.df)
dim(b.mat.t.df)
# [1]   150samples 22205 - 1 genes log10(cpm+1)
t1$id2 <- gsub("-", ".", t1$V1)
t1$id <- paste(t1$id2, ".", sep="")
t2 <- merge(b.mat.t.df, t1, by.x="id", by.y="id")
dim(t2)
t3 <- read.delim("dir-gtex-website-data/samp-name-T55", header=F)
head(t3)
#                            V1 V2
#1       Adipose - Subcutaneous T1
#2 Adipose - Visceral (Omentum) T2
#3                Adrenal Gland T3
t4 <- merge(t2, t3, by.x="V2", by.y="V1")
rownames(t4) <- paste( t4$V2.y, gsub("GTEX", "", t4$V1), sep="")
t4[1:2, c(1:3, 22205:22209)]
#                                                  V2                        id ENSG00000000003.15 ENSG00000291299.1 ENSG00000291300.1
# T2-145ME-0726-SM-5O9A3 Adipose - Visceral (Omentum) GTEX.145ME.0726.SM.5O9A3.           1.479368         0.3126457        0.04093152
# T2-1KXAM-0526-SM-DKPQN Adipose - Visceral (Omentum) GTEX.1KXAM.0526.SM.DKPQN.           1.715370         0.4391680        0.08077925
#                                              V1                      id2 V2.y
# T2-145ME-0726-SM-5O9A3 GTEX-145ME-0726-SM-5O9A3 GTEX.145ME.0726.SM.5O9A3   T2
# T2-1KXAM-0526-SM-DKPQN GTEX-1KXAM-0526-SM-DKPQN GTEX.1KXAM.0526.SM.DKPQN   T2
mat <- as.matrix(t4[, c(3:22206)])
dim(mat)
#[1]   150 22204
ca <- HeatmapAnnotation(tissue = t4$V2, which="row")
rowlabel <- data.frame(t4$V2) 
> Heatmap(matrix = mat, show_column_names=F, name="log10_CPM", row_names_gp = gpar(fontsize = 4), right_annotation=ca, row_dend_width=unit(30, "mm"), row_labels= rowlabel$t4.V2)

#########
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt | cut -f 7,17 | sort | uniq    | grep -i rnaseq |cut -f 1  > gtex-54tiss.txt
cut -f 2 *htseq.10samples.851pm |grep -v mean > gtex-htseq.50tiss-10sampPertiss
cat out-R-script-select-gtex-htseq-samples-in-a-tissue-912pm  | awk '(NR -1) % 5 == 1' | cut -f 1

#############################################################################
raw <- read.delim("gtex-all-samples.gene.count.txt", header=T)
dim(raw)
# [1] 62703 17352
samp <- read.delim("gtex-htseq.50tiss-10sampPertiss", header=F)
dim(samp)
samp$V2 <- paste( samp$V1, ".", sep="")
raw.samp <- raw[, colnames(raw) %in% samp$V2]
dim(raw.samp)
rownames(raw.samp) <- raw$geneID
summary( raw.samp[,1] - raw[, "GTEX.144GL.2926.SM.5O99F."]  )
y <- DGEList(counts=raw.samp)
y <- calcNormFactors(y)
dim(y)
summary(y$samples$norm.factors)
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  0.3249  0.8577  1.0377  1.0408  1.2318  1.9053 
summary(y$samples$lib.size)
#     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
# 12279814 26497412 31427822 32812601 37609295 87255002 
keep <-rowSums(cpm(y)>=1) >= 10
y<-y[keep,]
dim(y)
# [1] 27501   500
d = cpm(y)
a <- d
b = log10(a+1)
b.df <- as.data.frame(b)
b.mat <- as.matrix(b.df)
b.mat.t <- t(b.mat)
t1 <- read.delim("dir-gtex-website-data/sample-tissue.2colum", header=F)
b.mat.t.df <- as.data.frame(b.mat.t)
b.mat.t.df$id <- rownames(b.mat.t.df)
dim(b.mat.t.df)
# [1]   500 27502
t1$id2 <- gsub("-", ".", t1$V1)
t1$id <- paste(t1$id2, ".", sep="")
t2 <- merge(b.mat.t.df, t1, by.x="id", by.y="id")
dim(t2)
t3 <- read.delim("dir-gtex-website-data/samp-name-T55", header=F)
head(t3)
#                            V1 V2
#1       Adipose - Subcutaneous T1
#2 Adipose - Visceral (Omentum) T2
#3                Adrenal Gland T3
t4 <- merge(t2, t3, by.x="V2", by.y="V1")
rownames(t4) <- paste( t4$V2.y, gsub("GTEX", "", t4$V1), sep="")
t4[1:2, c(1:6, 27500:27506)]
mat <- as.matrix(t4[, c(3:27503)])
dim(mat)
# [1]   500 27501
 
ca <- HeatmapAnnotation(tissue = t4$V2, which="row")
rowlabel <- data.frame(t4$V2) 
rowlabel$tissue <- ""
step = 2
rowlabel$tissue[ seq(1, dim(t4)[1], step)] <- t4$V2[ seq(1, dim(t4)[1], step)]
> Heatmap(matrix = mat, show_column_names=F, name="log10_CPM", row_names_gp = gpar(fontsize = 3), right_annotation=ca, row_dend_width=unit(30, "mm"), row_labels= rowlabel$tissue)

######brain tissues only
> t4.brain <- t4[ grepl("Brain", t4$V2),]
> dim(t4.brain)
[1]   130 27506

mat <- as.matrix(t4.brain[, c(3:27503)])
dim(mat)
ca <- HeatmapAnnotation(tissue = t4.brain$V2, which="row")
rowlabel <- data.frame(t4.brain$V2)
rowlabel$tissue <- ""
step = 2
rowlabel$tissue[ seq(1, dim(t4.brain)[1], step)] <- t4.brain$V2[ seq(1, dim(t4.brain)[1], step)]
> Heatmap(matrix = mat, show_column_names=F, name="log10_CPM", row_names_gp = gpar(fontsize = 5), right_annotation=ca,  row_labels= rowlabel$tissue, clustering_distance_rows="pearson", row_dend_width=unit(30, "mm"))

#for non-bain cells 
 Heatmap(matrix = mat, show_column_names=F, name="log10_CPM", row_names_gp = gpar(fontsize = 3), right_annotation=ca,  row_labels= rowlabel$tissue,  row_dend_width=unit(30, "mm"))

#########QC of star-htseqcount res
rm -f temp1
head -1 gtex-all-samples.gene.count.txt > temp1
grep -iw xist gtex-all-samples.gene.count.txt >> temp1
grep -iw ddx3y gtex-all-samples.gene.count.txt >> temp1
grep -iw zfy gtex-all-samples.gene.count.txt >> temp1
grep -iw CPT1B gtex-all-samples.gene.count.txt >> temp1

~/Documents/microglia/table-transpose temp1 temp1-transp
# rm 1st line from temp1-transp
# rm . from samaple ID GTEX-1117F-0003-SM-58Q7G.
vi  temp1-transp

> t1 <- read.delim("temp1-transp")
info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
gene.info <- merge(t1, info, by.x="name", by.y="SAMPID")
dim(gene.info)
# [1] 17350    12
tis <- read.delim("dir-gtex-website-data/sample-tissue.2colum")
gene.info.tiss <- merge( gene.info, tis, by.x="name", by.y="SAMPID")
plot(log2( gene.info.tiss$XIST +1) ~ log2( gene.info.tiss$DDX3Y +1), col = "white")
g2.f <- gene.info.tiss[ gene.info.tiss$SEX == 2 , ]
g2.m <- gene.info.tiss[ gene.info.tiss$SEX == 1 , ]
points(log2(g2.f$DDX3Y +1), log2(g2.f$XIST +1), col = "red")
points(log2(g2.m$DDX3Y +1), log2(g2.m$XIST +1), col = "blue")
abline(h = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")
legend(0, 2.5, c("F", "M"), pch = c(16,16),col = c("red", "blue" ) )

g2 <- gene.info.tiss[ gene.info.tiss$SEX == 2 & gene.info.tiss$DDX3Y > 100,]
dim(g2)
# [1] 20samples 

g.brain <- gene.info.tiss[ !grepl("Brain", gene.info.tiss$SMTSD), ]
#A numerical vector of the form c(bottom, left, top, right) which gives the number of lines of margin to be specified on the four sides of the plot
#41 boxplots
#Small Intestine - Terminal Ileum
par( mar=c(8,5,2,2))
a <- boxplot(log2(g.brain$CPT1B+1) ~ g.brain$SMTSD, xlab="", ylab="log2(CPT1B raw gene count)", xaxt= "n")
len <- length(unique(g.brain$SMTSD))
axis(1, at = seq(1, len, by = 1), labels=substr( a$names, 1, 32), las=2, cex.axis=0.5)
abline(h = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")

#########compare star-htseq with GTEx_Analysis_2017-06-05_v8_RNASeQC
head -1 gtex-all-samples.gene.count.txt > temp1
grep -iw xist gtex-all-samples.gene.count.txt >> temp1
~/Documents/microglia/table-transpose temp1 temp1-transp

head -1 dir-gtex-website-data/GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct > temp2
grep -iw xist dir-gtex-website-data/GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct >> temp2
~/Documents/microglia/table-transpose temp2 temp2-transp
vi temp1-transp 
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine  temp1-transp temp2-transp out
paste  temp1-transp  out > temp1-temp2
cat temp1-temp2 | wc -l
   17351
cat temp1-temp2 |  awk 'BEGIN {FS = "\t"; OFS = "\t"} $4 == $2 * 2' | wc -l
    2171
>t1 <- read.delim("temp1-temp2")
info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
gene.info <- merge(t1, info, by.x="Description", by.y="SAMPID")
dim(gene.info)
# [1] 17350     9
g2.f <- gene.info[ gene.info$SEX == 2 , ]
dim(g2.f)
# [1] 5783    9
g2.m <- gene.info[ gene.info$SEX == 1 , ]
dim(g2.m)
# [1] 11567     9

plot(log2( gene.info$XIST.1+2) ~ log2(2*(gene.info$XIST+1)), xlab="log2(2 *(geneCount + 1)), STAR-htseq", ylab =     "log2(geneCount + 2), RNA-SeQC", ylim=c(0, 20), xlim=c(0, 20), col = "white")
points( log2(2*(g2.f$XIST+1)),log2( g2.f$XIST.1+2), col = "red")
points( log2(2*(g2.m$XIST+1)),log2( g2.m$XIST.1+2), col = "blue")
abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
y = 1:5
x = y
abline(lm(y~x), lwd = 1, col="blue")
text(2, 20, "y = x", col="blue")
legend(2, 18, c("F", "M"), pch = c(16,16),col = c("red", "blue" ) )

##########################x-axis consortium; y-axis P-lab
> par(mar=c(5,6,4,2))
plot(log2(2*(gene.info$XIST+1)) ~ log2( gene.info$XIST.1+2), xlab="Consortium XIST gene count \n log2(geneCount + 2)", ylab="P-star-htseq XIST gene count \n log2(2 *(geneCount + 1))", ylim=c(0, 20), xlim=c(0, 20), col = "white")

points(log2( g2.f$XIST.1+2), log2(2*(g2.f$XIST+1)), col = "red")
points(log2( g2.m$XIST.1+2), log2(2*(g2.m$XIST+1)),col = "blue")
abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
y = 1:5
x = y
abline(lm(y~x), lwd = 1, col="blue")
text(2, 20, "y = x", col="blue")
legend(2, 18, c("F", "M"), pch = c(16,16),col = c("red", "blue" ) )

##########################cpt1b P-lab vs consortium
  head -1 gtex-all-samples.gene.count.txt > temp1
grep -iw cpt1b gtex-all-samples.gene.count.txt | grep -v CHKB >> temp1
~/Documents/microglia/table-transpose temp1 temp1-transp

head -1 dir-gtex-website-data/GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct > temp2
grep -iw   cpt1b dir-gtex-website-data/GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct | grep -v CHKB  >> temp2
~/Documents/microglia/table-transpose temp2 temp2-transp
vi temp1-transp
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine  temp1-transp temp2-transp out
paste  temp1-transp  out > temp1-temp2-CPT1B
> t1 <- read.delim("temp1-temp2-CPT1B")
info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
gene.info <- merge(t1, info, by.x="Description", by.y="SAMPID")
dim(gene.info)
 par(mar=c(5,6,4,2))
 plot(log2(2*(gene.info$CPT1B+1)) ~ log2( gene.info$CPT1B.1+2), xlab="Consortium CPT1B gene count \n log2(geneCount + 2)", ylab="P-star-htseq CPT1B gene count \n log2(2 *(geneCount + 1))", ylim=c(0,10), cex=0.5)
 abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")

######################boxplot of cpt1b across tissues
 tis <- read.delim("dir-gtex-website-data/sample-tissue.2colum")
 head(tis)
#                          SAMPID                        SMTSD
# 1      GTEX-1117F-0003-SM-58Q7G                  Whole Blood
 gene.info.tiss <- merge( gene.info, tis, by.x="Description", by.y="SAMPID")
 g.brain <- gene.info.tiss[ !grepl("Brain", gene.info.tiss$SMTSD), ]
 dim(g.brain)
# [1] 14708    10
par( mar=c(8,5,2,2))
a <- boxplot(log2(2*(g.brain$CPT1B+1)) ~ g.brain$SMTSD, xlab="", ylab="P-star-htseq CPT1B gene count \n log2(2 *(geneCount + 1))", xaxt= "n")
 len <- length(unique(g.brain$SMTSD))
 axis(1, at = seq(1, len, by = 1), labels=substr( a$names, 1, 32), las=2, cex.axis=0.5)
 abline(h = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")

par( mar=c(8,5,2,2))
a <- boxplot(log2(g.brain$CPT1B.1+2) ~ g.brain$SMTSD, xlab="", ylab="Consortium CPT1B gene count \n log2(geneCount + 2)", xaxt= "n")
 len <- length(unique(g.brain$SMTSD))
 axis(1, at = seq(1, len, by = 1), labels=substr( a$names, 1, 32), las=2, cex.axis=0.5)
 abline(h = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")

###read in CHKB-CPT1B gene count
> t1 <- read.delim("temp1-transp")
 g.brain.chkb <- merge(t1, g.brain, by.x="name", by.y="Description")
 dim(g.brain.chkb)
# [1] 14708    12
par( mar=c(8,5,2,2))
a <- boxplot(log2(2*(g.brain.chkb$CHKB.CPT1B+1)) ~ g.brain.chkb$SMTSD, xlab="", ylab="P-star-htseq CHKB-CPT1B gene count \n log2(2 *(geneCount + 1))", xaxt= "n")

> sink("temp.txt")

for(i in 1:length(unique(g.brain.chkb$SMTSD))) {
 temp <- g.brain.chkb[ g.brain.chkb$SMTSD == sort(unique(g.brain.chkb$SMTSD))[i],]
 res <- lm(log2(2*(temp$CPT1B.x+1)) ~ log2( temp$CPT1B.1+2))
 sum <- summary(res)
 p <- (sum$coefficients[2,4])
 str <- paste(sort(unique(g.brain.chkb$SMTSD))[i], dim(temp)[1], res$coefficients[1], res$coefficients[2], sum$r.squared, p, sep="\t")
 cat(str)
 cat("\n")
}
sink()

#############################################################################
linyong@fry /lab/solexa_page/linyong/autism$ cp -i ../gtex-all-samples.gene.count.txt.gz  .
linyong@fry /lab/solexa_page/linyong/autism$ gunzip gtex-all-samples.gene.count.txt.gz
linyong@fry /lab/solexa_page/linyong/autism$ ls -l gtex-all-samples.gene.count.txt ../gtex-all-samples.gene.count.orig.txt
-r--r--r-- 1 linyong systemd-timesync 2838623072 Jun 19 17:02 ../gtex-all-samples.gene.count.orig.txt
-r--r--r-- 1 linyong systemd-timesync 2838623072 Jun 26 12:40 gtex-all-samples.gene.count.txt
linyong@fry /lab/solexa_page/linyong/autism$ diff ../gtex-all-samples.gene.count.orig.txt gtex-all-samples.gene.count.txt | wc
      0       0       0
linyong@fry /lab/solexa_page/linyong/autism$ rm -f gtex-all-samples.gene.count.txt

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % scp linyong@tak.wi.mit.edu:/lab/solexa_page/linyong/gtex-all-samples.gene.count.orig.txt ./
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % ls -l gtex-all-samples.*
-rw-r--r--  1 linyongmao  staff  2838623072 Jun 26 12:54 gtex-all-samples.gene.count.orig.txt
-rw-r--r--  1 linyongmao  staff  2838623072 Jun 19 17:30 gtex-all-samples.gene.count.txt
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % diff gtex-all-samples.gene.count.orig.txt gtex-all-samples.gene.count.txt | wc
       0       0       0
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % rm -f gtex-all-samples.gene.count.orig.txt

#############################################################################
linyong@fry /lab/page_human_data/gtexV8-reMap-2023$ ls -lh /lab/solexa_page/linyong/gtex-all-samples.gene.count.txt.gz
linyong@fry /lab/page_human_data/gtexV8-reMap-2023$ cp -i /lab/solexa_page/linyong/gtex-all-samples.gene.count.txt.gz ./
linyong@fry /lab/page_human_data/gtexV8-reMap-2023$ cp -i /lab/solexa_page/linyong/gencode/gencode.v42.primary_assembly.annotation.gtf ./
-r--r--r-- 1 linyong page_hd 763306586 Jun 26 13:07 /lab/page_human_data/gtexV8-reMap-2023/gtex-all-samples.gene.count.txt.gz
-r--r--r-- 1 linyong systemd-timesync 763306586 Jun 19 16:29 /lab/solexa_page/linyong/gtex-all-samples.gene.count.txt.gz

drwxr-sr-x   2 linyong  page_hd   52 Jun 26 13:06 gtexV8-reMap-2023/
drwxr-sr-x 637 linyong  page_hd  21K Jun 19 15:33 linyong2/

##################################################
linyong@fry /lab/page_human_data/linyong2/test-dir$ cat script-test-325
#
ls GTEX*counts_gene | head -101 | grep -v GTEX-1IL2U-0626-SM-CE6TA.Aligned. | while read ll
do

# ll="GTEX-111CU-0526-SM-5EGHK.Aligned.sortedByCoord.out.patched.md.bam.counts_gene"
f=`echo "$ll" | sed 's/Aligned.sortedByCoord.out.patched.md.bam.counts_gene//' `
t=` head -1 /lab/solexa_page/linyong/gtex-all-samples.gene.count.orig.txt |  awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print i, $i}' | grep -w "$f" | head -1 | cut -f 1`
cut -f 1,2,$t /lab/solexa_page/linyong/gtex-all-samples.gene.count.orig.txt > temp-"$f"-cnt
echo -n "numofdifflines "
diff "temp-$f-cnt" "$ll" | wc -l
echo "$ll"
diff "temp-$f-cnt" "$ll"
rm "temp-$f-cnt"

done
###

linyong@fry /lab/page_human_data/linyong2/test-dir$ rm -f out-july-2
linyong@fry /lab/page_human_data/linyong2/test-dir$ bash script-test-325 > out-july-2
cat out-july-2 | grep numof  | uniq -c
    100 numofdifflines  8
cat out-july-2 | grep '62704a62704,62708' | uniq -c
    100 62704a62704,62708
wc -l out-july-2
1000 out-july-2

##################C-P-stomach-10-10samp.raw
using R-script-select-gtex-htseq-samples-in-a-tissue
#stomach 
> tissue = file[49,1]
t2 <- t1[ t1$V2 == tissue, ]
 t2$id <- gsub("-", ".", t2$V1)
 t2$id <- paste(t2$id, ".", sep="")
 raw2 <- raw[, colnames(raw) %in% t2$id ]
 str1 <- paste(tissue, dim(raw2)[2], sep="\t")
 cat(str1)
 cat("\n")
 rownames(raw2) <- raw$geneID
> r3 <- raw2[ ,sample(1:dim(raw2)[2], 10 )]
> write.table(r3, "P-stomach-10samp.raw", sep="\t", quote=F)
> samp <- colnames(r3)
> samp
 [1] "GTEX.1RAZR.1526.SM.EAZ4U." "GTEX.R55C.1026.SM.48FCM." 
> raw <- read.delim("dir-gtex-website-data/GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct", header=T)
> s2 <- gsub(".$", "", samp)
> r4 <- raw[,  colnames(raw) %in% s2]
> rownames(r4) <- raw$Name
write.table(r4, "C-stomach-10samp.raw", sep="\t", quote=F)
# 44 PAR_Y genes in the website gene count matrix
# ENSG00000168939.11_PAR_Y
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % /Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine  C-stomach-10samp.raw P-stomach-10samp.raw out
paste C-stomach-10samp.raw out | grep -vw notApplicable > C-P-stomach-10-10samp.raw
wc -l  C-stomach-10samp.raw P-stomach-10samp.raw C-P-stomach-10-10samp.raw
   56201 C-stomach-10samp.raw
   62704 P-stomach-10samp.raw
   55485 C-P-stomach-10-10samp.raw
> r1 <- read.delim("C-P-stomach-10-10samp.raw")
> raw <- r1[, c(2:11, 13:22)]
> rownames(raw) <- r1$geneID
> dim(raw)
# [1] 55484    20
y <- DGEList(counts=raw)
y <- calcNormFactors(y)
med <- data.frame(y$counts[,1])
med$logic <- TRUE
d <- edgeR::cpm(y)
for(i in 1:dim(y)[1]) {
 med$logic[i] <- median(d[i,]) >= 1
}
####median >= 1 for pathway genes
y<-y[med$logic,]
print(dim(y))
# [1] 15880    20
d = edgeR::cpm(y)
t9 <- as.data.frame(d)
t10 <- log10(t9 + 1)
t11 <- cor(t10)
t12 <- as.data.frame(t11)
mat <- as.matrix(t12)
 c1 <- paste("C-", rownames(mat)[1:10], sep="")
 c2 <- paste("P-", rownames(mat)[11:20], sep="")
 rownames(mat) <- c(c1,c2)
 colnames(mat) <- c(c1,c2)
> Heatmap(mat, name = "correlation", row_order=sort(rownames(mat)), column_order=sort(colnames(mat)), row_names_gp = gpar(fontsize = 8), column_names_gp = gpar(fontsize = 8))
 c1 <- data.frame(cor = 1:45)
 c1$cor = -1
k = 1
for(i in 1:10) {
 for(j in 1:10) {
 if(j > i)
 {
   c1$cor[k] = mat[i,j]
   k <- k+1
 }
}
}
 ll <- list()
 ll[[1]] <- c1$cor

c1$cor = -1
k = 1
for(i in 11:20) {
 for(j in 11:20) {
 if(j > i)
 { 
   c1$cor[k] = mat[i,j]
   k <- k+1
 }
}
}
 ll[[2]] <- c1$cor
 identical(rownames(mat), colnames(mat))
 rownames(mat)
c2 <- data.frame(cor = 1:10)
c2$cor = -1

k = 1
for(i in 1:10) {
   r <- gsub("^C-", "", rownames(mat)[i])
   r <- paste("P-", r, sep="")
   r <- paste( r, ".", sep="")
  c2$cor[k] = mat[ i, colnames(mat) == r ][1]                  
  k <- k+1
}
ll[[3]] <- c2$cor

boxplot(ll, ylab=" correlation (r)", xaxt="n", outcol ="white")
 beeswarm(ll, add = T)
 abline(h = seq(0,100,0.05), lty = 5, lwd = 0.5, col = "gray")
 axis(1, at = 1:3, labels=c("Consortium sample-sample", "P-star-htseq.count sample-sample", "C-P same sample"))

 c3 <- data.frame(cor = 1:45)
 c3$cor = -1
k = 1
for(i in 1:10) {
 for(j in 1:10) {
 if(j > i)
 { 
   r <- gsub("^C-", "", rownames(mat)[i])
   r <- paste("P-", r, sep="")
   r <- paste( r, ".", sep="")
   c <- gsub("^C-", "", colnames(mat)[j])
   c <- paste("P-", c, sep="")
   c <- paste( c, ".", sep="")

   c3$cor[k] = mat[ rownames(mat) == r, colnames(mat) == c ][1] 
   k <- k+1
 }
}
}

 plot(c3$cor ~ ll[[1]], ylab="P-star-htseq.count sample-sample corr", xlab ="Consortium sample-sample corr")
 y = 1:5
 x = y
 abline(lm(y~x))
 abline(h = seq(-10,10,0.05), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-10,10,0.05), lty = 5, lwd = 0.5, col = "gray")
##################
> C.GTEX.1RAZR.1526.SM.EAZ4U <- t10[, "GTEX.1RAZR.1526.SM.EAZ4U"]
 P.GTEX.1RAZR.1526.SM.EAZ4U <- t10[, "GTEX.1RAZR.1526.SM.EAZ4U."]
 plot(P.GTEX.1RAZR.1526.SM.EAZ4U ~ C.GTEX.1RAZR.1526.SM.EAZ4U)
 title("log10(cpm+1); R-squared:  0.8757")
y22 = 1:5
x = y22
abline(lm(y22~x), lwd = 1.5, col="blue")
 abline(h = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 text(0.5, 4, "P-star-htseq.count", pos=4)
 text(3.5, 1, "Consortium", pos = 4)

###randomly pick 1000 genes with cpm > 0
> d = edgeR::cpm(y)
> t9 <- as.data.frame(d)
 df <- data.frame(t9$GTEX.1RAZR.1526.SM.EAZ4U, t9$GTEX.1RAZR.1526.SM.EAZ4U.)
####already median of 20 cpm >= 1
 df2 <- df[ df[,1] > 0 & df[,2] > 0,]
 dim(df2)
# [1] 15758     2
 df3 <- df2[ sample(1:dim(df2)[1], 1000),]
 plot(log10(df3$t9.GTEX.1RAZR.1526.SM.EAZ4U.) ~ log10(df3$t9.GTEX.1RAZR.1526.SM.EAZ4U), xlab = "consortium, log10(cpm)", ylab = "P-star-htseq.count, log10(cpm)")
y22 = 1:5
x = y22
abline(lm(y22~x), lwd = 1.5, col="blue")
 abline(h = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 x = 1:10
 y22 <- x + log10(1.5)
 abline(lm(y22~x),lty=5, lwd = 1, col="red")
 y22 <- x - log10(1.5)
 abline(lm(y22~x),lty=5, lwd = 1, col="red")
 legend("topleft", inset=0.05, legend=c("y=x", "+/- log10(1.5)"), lty = c(1, 5), col = c("blue", "red"))
##########################hallmark pathway genes
 r1 <- read.delim("C-P-stomach-10-10samp.raw")
 raw <- r1[, c(2:11, 13:22)]
 rownames(raw) <- r1$geneID
 dim(raw)
# [1] 55484    20
y <- DGEList(counts=raw)
y <- calcNormFactors(y)
med <- data.frame(y$counts[,1])
med$logic <- TRUE
d <- edgeR::cpm(y)
for(i in 1:dim(y)[1]) {
 med$logic[i] <- median(d[i,]) >= 1
}
####median >= 1 for pathway genes
y<-y[med$logic,]
print(dim(y))
# [1] 15880    20
.......
> g.n <- read.delim("gencode.v42.primary_assembly.noPar.geneID-name.2")
> t10$geneID <- rownames(t10)
> t10.g <- merge(t10, g.n, by.x="geneID", by.y="geneID")
rm -f temp temp-u
ls HALL*.genes | grep -v temp | while read f
do
  cat "$f" >> temp
done

cat temp | sort | uniq > temp-u
wc -l temp temp-u
    7321 temp
    4383 temp-u
> h.g <- read.delim("../microglia/temp-u", header=F)
> t10.g.h <- t10.g[ t10.g$name %in% h.g$V1,]
> dim(t10.g.h)
[1] 3881   22
C.GTEX.1RAZR.1526.SM.EAZ4U <- t10.g.h[, "GTEX.1RAZR.1526.SM.EAZ4U"]
 P.GTEX.1RAZR.1526.SM.EAZ4U <- t10.g.h[, "GTEX.1RAZR.1526.SM.EAZ4U."]
plot(P.GTEX.1RAZR.1526.SM.EAZ4U ~ C.GTEX.1RAZR.1526.SM.EAZ4U)
 title("log10(cpm+1);")
y22 = 1:5
x = y22
abline(lm(y22~x), lwd = 1.5, col="blue")
 abline(h = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 text(0.5, 3, "P-star-htseq.count", pos=4)
 text(3, 1.5, "Consortium", pos = 4)

##################sample inputreads Uniquelyreads lib.size        no_feature      ambiguous       too_low_aQual
#sample inputreads Uniquelyreads  sample	lib.size	no_feature	ambiguous	too_low_aQual	not_alignedalignment_not_unique
GTEX-1117F-3226-SM-5N9CT.Aligned.sortedByCoord.out.patched.md.bam	40408706	37511071	GTEX-1117F-3226-SM-5N9CT.Aligned.sortedByCoord.out.patched.md.bam	31392486	2078686	4039899	0	794779	2102856
> sum(x[3:8]) == x[1]
inputreads == lib.size + no_feature + ambiguous + too_low_aQual + not_aligned + alignment_not_unique
> sum(x[3], x[4], x[5]) == x[2]
uniqreads == lib.size + no_feature + ambiguous

linyong@fry /lab/solexa_page/linyong/dir-gtex-10$ rm -f temp1 temp2 temp3 temp11
-rw-r--r-- 1 linyong systemd-timesync 1.1K Jul 15 23:14 /lab/solexa_page/linyong/dir-gtex-10/script-get-feature-count

linyong@fry /lab/page_human_data/linyong2$ ls | grep "^dir-gtex-[0-9]*" > temp-dir-1
##rm dir-600 and later dir that are 2nd round remap
vi temp-dir-1
linyong@fry /lab/page_human_data/linyong2$ cat temp-scr-01 
#
cat temp-dir-1 | while read dir
do
 cd "$dir"
 echo -n "$dir"
 n=`ls GTEX*counts_gene  | wc -l`
 e=`grep -i  error out* | wc -l `
 echo "	$n	$e"
 cd ..
done
linyong@fry /lab/page_human_data/linyong2$ bash temp-scr-01 > map-dir-countsFilesNum-errorNum
# dir-gtex-147/   20      0
cat map-dir-countsFilesNum-errorNum | awk '$2 == 20 && $3 == 0' | wc -l
439
cat map-dir-countsFilesNum-errorNum | awk '$2 == 20 && $3 == 0' | awk 'NR % 50 == 1' | cut -f 1
dir-gtex-147/ #this dir not used ; 40 + 20*8 = 200 samples for mapping statis
dir-gtex-197/
dir-gtex-249/
dir-gtex-304/
dir-gtex-354/
dir-gtex-406/
dir-gtex-458/
dir-gtex-510/
dir-gtex-561/
cat map-dir-countsFilesNum-errorNum | awk '$2 == 20 && $3 == 0' | awk 'NR % 50 == 1' | cut -f 1 > map-test-dir
linyong@fry /lab/page_human_data/linyong2$ cat temp-scr-2
#
cat map-test-dir | awk 'NR > 1' | while read dir
do
 cd "$dir"
 bash /lab/solexa_page/linyong/dir-gtex-10/script-get-feature-count
 cd ..
done

linyong@fry /lab/page_human_data/linyong2$ cat /lab/solexa_page/linyong/dir-gtex-10/script-get-feature-count
#
#
rm -f temp1 temp2 temp3 temp11
head GTEX*.STAR.log | grep "==> " | sed 's/.STAR.log <==//' > temp1
head GTEX*.STAR.log | grep "Number of input reads" | awk '{print $6}'  > temp2
head GTEX*.STAR.log | grep "Uniquely mapped reads number" | awk '{print $6}' > temp3
paste temp1 temp2 temp3 > temp11
wc -l temp1 temp2 temp3 temp11

b=`ls GTEX*counts_gene  | awk 'NR == 1' `
echo "feature	$b" |  sed 's/.counts_gene//' > s
echo -n "lib.size	" >> s
cat  "$b" | awk ' NF == 3' |  awk 'BEGIN {FS = "\t"; s = 0} {
s += $3;}
END {print s}' >> s

tail -n 5 "$b" | awk '{print $1 "\t" $2}' | sed 's/__//' >> s
ls GTEX*counts_gene  | awk 'NR > 1' | while read f
do
  echo "$f" |  sed 's/.counts_gene//' > f2
  cat  "$f" | awk ' NF == 3' |  awk 'BEGIN {FS = "\t"; s = 0} {
s += $3;}
END {print s}' >> f2

  tail -n 5 "$f" | awk '{print  $2}' | sed 's/__//' >> f2       
  paste s f2 > m
  mv m s
done
ls -lh s
 ~/C++/table-transpose s s-tr
cat  temp11 | sed 's/==> //' | sort > temp12
awk 'NR > 1' s-tr | sort  > s-tr-1 ###rm header line
paste temp12 s-tr-1 > temp13
ls -lh temp13
cat temp13

rm temp1 temp2 temp3 temp11 temp12 temp13 s f2 m s-tr s-tr-1 
linyong@fry /lab/page_human_data/linyong2$ bash temp-scr-2 | awk 'NF > 9' > map-test-200-files

linyong@fry /lab/page_human_data/linyong2$ cd /lab/solexa_page/linyong/dir-gtex-10/
linyong@fry /lab/solexa_page/linyong/dir-gtex-10$ bash script-get-feature-count | awk 'NF > 9' >> /lab/page_human_data/linyong2/map-test-200-files
linyong@fry /lab/page_human_data/linyong2$ cat  map-test-200-files | awk '$1 == $4' | wc -l
201 #including 1 header line
cat  map-test-200-files | cut -f 2 | sort | uniq -d |wc
      0       0       0 #no two #.of.input.reads identical
cat  map-test-200-files | awk 'NR > 1 {print $3 / $2}' | sort -g | awk 'NR == 100'
0.933841
cat  map-test-200-files | awk 'NR > 1 {print $3 / $2}' | sort -g | awk 'NR == 20'
0.78069
#############################################################################
> map <- read.delim("map-test-200-files")
 par( mar=c(9,5,1,2))
 plot(0,0, xlim=c(0,205), ylim=c(0, 12e7), col="white", xlab="", ylab="reads", xaxt = "n" )
 points(1:dim(map)[1], map$inputreads, pch = 1, col = "black", cex = 0.2 )
 lines(1:dim(map)[1], map$inputreads,  col = "black")
 points(1:dim(map)[1], map$Uniquelyreads, pch = 1, col = "red", cex = 0.2 )
 lines(1:dim(map)[1], map$Uniquelyreads,  col = "red")
 points(1:dim(map)[1], map$lib.size, pch = 1, col = "blue", cex = 0.2 )
 lines(1:dim(map)[1], map$lib.size,  col = "blue")
 points(1:dim(map)[1], map$no_feature, pch = 1, col = "green", cex = 0.2 )
 lines(1:dim(map)[1], map$no_feature,  col = "green")
 abline(h = seq(0, 20e8,1e7), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100, 1000, 10), lty = 5, lwd = 0.5, col = "gray")
 axis(1, at = seq(1, dim(map)[1], by=1), labels=gsub(".Aligned.sortedByCoord.out.patched.md.bam", "", map$sample), las = 2, cex.axis=0.5)
 legend(100, 1.2e8, legend=c("raw read", "uniq mapped read", "uniq read in non-overlap exon", "no_feature"), col = c("black", "red", "blue", "green"), lty = 1, cex = 0.8 )

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % sort -t '        ' +1 -2g map-test-200-files > map-test-200-files-sorted-1
> map <- read.delim("map-test-200-files-sorted-1")
......
 points(1:dim(map)[1], map$not_aligned, pch = 1, col = "green", cex = 0.2 )
 lines(1:dim(map)[1], map$not_aligned,  col = "green")
 abline(h = seq(0, 20e8,1e7), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100, 1000, 10), lty = 5, lwd = 0.5, col = "gray")
 axis(1, at = seq(1, dim(map)[1], by=1), labels=gsub(".Aligned.sortedByCoord.out.patched.md.bam", "", map$sample), las = 2, cex.axis=0.5)
 legend(100, 1.2e8, legend=c("raw read", "uniq mapped read", "uniq read in non-overlap exon", "not-aligned"), col = c("black", "red", "blue", "green"), lty = 1, cex = 0.8 )

####################genes in V42 but not in v26, expressed in certain tissue, heatmap
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cut -f 1  C-stomach-10samp.raw  | awk 'NR > 1' > temp-1
cut -f 1  P-stomach-10samp.raw  | awk 'NR > 1' > temp-2
cat temp-1 temp-2 | sort | uniq -d > temp-3
cat temp-2 temp-3 | sort | uniq -u > temp-4
    7219 temp-4
vi temp-4
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine  temp-4  gencode.v42.primary_assembly.noPar.gene-chr-type-2 out
 paste  temp-4  out | grep -v notApplicable  > temp-5
cut -f 1-2 dir-gtex-website-data/GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct > gencodeV26.id.name

> t1 <- read.delim("temp-5")
 dim(t1)
# [1] 7219    6
t2 <- read.delim("gtex-comb-1103samp.gene.count.txt")
dim(t2)
# [1] 62703  1105
t2 <- t2[, 1:42]
t3 <- merge(t1, t2, by.x="geneID.2", by.y="geneID")
dim(t3)
# [1] 7219   47
 t4 <- read.delim("gencodeV26.id.name")
 t5 <- t3[ t3$name %in% t4$Description,]
 dim(t5)
# [1] 344  47
 t5 <- t3[ !(t3$name %in% t4$Description),]
 dim(t5)
# [1] 6875   47
 dim(t5[ t5$type =="protein_coding", 1:8])
# [1] 802   8
###> write.table(t5[,1:10], "gencode.v42.not.in.v26.6875genes", quote=F, sep="\t")
t5.orig <- t5
......
samp <- read.delim("gtex-htseq.50tiss-10sampPertiss", header=F)
g.n <- raw[, 1:2]
......
###10 samples out of 500 samples
> keep <-rowSums(cpm(y)>=10) >= 10
 y<-y[keep,]
 dim(y)
# [1] 17459   500
d = cpm(y)
a <- d
b = log10(a+1)
b.df <- as.data.frame(b)
 b.filt <- b.df[ rownames(b.df) %in% t5.orig$geneID.2,]
 dim(b.filt)
# [1] 248 500
b.mat <- as.matrix(b.filt)
b.mat.t <- t(b.mat)
t1 <- read.delim("dir-gtex-website-data/sample-tissue.2colum", header=F)
b.mat.t.df <- as.data.frame(b.mat.t)
b.mat.t.df$id <- rownames(b.mat.t.df)
dim(b.mat.t.df)
t1$id2 <- gsub("-", ".", t1$V1)
t1$id <- paste(t1$id2, ".", sep="")
t2 <- merge(b.mat.t.df, t1, by.x="id", by.y="id")
dim(t2)
t3 <- read.delim("dir-gtex-website-data/samp-name-T55", header=F)
head(t3)
#                            V1 V2
#1       Adipose - Subcutaneous T1
#2 Adipose - Visceral (Omentum) T2
#3                Adrenal Gland T3
t4 <- merge(t2, t3, by.x="V2", by.y="V1")
rownames(t4) <- paste( t4$V2.y, gsub("GTEX", "", t4$V1), sep="")
 mat <- as.matrix(t4[, c(3:250)])
rowlabel <- data.frame(t4$V2) 
rowlabel$tissue <- ""
step = 2
rowlabel$tissue[ seq(1, dim(t4)[1], step)] <- t4$V2[ seq(1, dim(t4)[1], step)]
 ca <- HeatmapAnnotation(tissue = t4$V2, which="row", annotation_legend_param = list(grid_height = unit(2, "mm"), grid_width = unit(2, "mm"), labels_gp = gpar(fontsize = 5)))
 col.g <- colnames(mat)

for(i in 1:length(col.g)) {
 col.g[i] <- ""
 }

for(i in seq(1,length(col.g), 1) ) {
 col.g[i] <- g.n[ g.n$geneID == colnames(mat)[i], ][1,2]
 }
for(i in 1:length(col.g)) {
 if(grepl("^ENSG", col.g[i]))
   col.g[i] <- ""
 }


> Heatmap(matrix = mat, show_column_names=T, name="log10(CPM+1)", row_names_gp = gpar(fontsize = 3), right_annotation=ca,  row_labels= rowlabel$tissue, clustering_distance_rows="pearson", clustering_distance_columns="pearson", column_labels=col.g, column_names_gp=gpar(fontsize = 5))

############################################
linyong@fry /lab/solexa_page/linyong/gencode$ cat gencode.v42.primary_assembly.noPar.annotation.gtf | grep -iw "readthrough_gene" | awk '$3 == "gene"' |wc
    651   14656  146561
cat gencode.v42.primary_assembly.noPar.readthrough_gene | cut -f 9 | awk 'BEGIN {FS = ";"} {print $1}' |sed 's/gene_id //' | sed 's/"//g' | sed 's/\.[0-9]*$//' > gencode.v42.primary_assembly.noPar.readthrough_gene.id
cat gencode.v42.primary_assembly.noPar.readthrough_gene | cut -f 9 | awk 'BEGIN {FS = ";"} {print $1}' |sed 's/gene_id //' | sed 's/"//g' > gencode.v42.primary_assembly.noPar.readthrough_gene.id.2

> keep <-rowSums(cpm(y)>=1) >= 10
>  y<-y[keep,]
>  dim(y)
[1] 27501   500
> rt.g <- read.delim("gencode.v42.primary_assembly.noPar.readthrough_gene.id.2", header=F)
> dim(rt.g)
[1] 651 readthrough genes,   1
> temp2 <- y$counts[ rownames(y$counts) %in% rt.g$V1,]
> dim(temp2)
[1]  95 500

########################cpt1b, cpm, F vs. M plot
Heart - Left Ventricle  428samples
> ####median >= 1 for pathway genes
> y<-y[med$logic,]
> print(dim(y))
[1] 13643   428
> summary(y$samples$lib.size)
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max.
 5092064 29668253 34351282 35888494 41328838 79508819  
> summary(y$samples$norm.factors)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.2245  0.8977  1.0726  1.0547  1.2345  2.2914
###############################################################################################
 setwd("/Users/linyongmao/Documents/dir-GTExV8/")
raw <- read.delim("gtex-all-samples.gene.count.txt", header=T)
dim(raw)
t1 <- read.delim("dir-gtex-website-data/sample-tissue.2colum", header=F)
file <- read.delim("gtex-54tiss.txt", header=F)
index = 33
tissue = file[index,1]
 t2 <- t1[ t1$V2 == tissue, ]
 t2$id <- gsub("-", ".", t2$V1)
 t2$id <- paste(t2$id, ".", sep="")
 raw2 <- raw[, colnames(raw) %in% t2$id ]
 str1 <- paste(tissue, dim(raw2)[2], sep="\t")
 cat(str1)
 cat("\n")
 rownames(raw2) <- raw$geneID
y <- DGEList(counts=raw2)
y <- calcNormFactors(y)
med <- data.frame(y$counts[,1])
med$logic <- TRUE
d <- cpm(y)
for(i in 1:dim(y)[1]) {
 med$logic[i] <- median(d[i,]) >= 1
}
####median >= 1 for pathway genes
y<-y[med$logic,]
print(dim(y))
# [1] 13643   428
d = edgeR::cpm(y)
 a <- d
 gene.name <- raw[, 1:2]
 a.df <- as.data.frame(a)
 a.df$id <- row.names(a.df)
 a.df.g <- merge(a.df, gene.name, by.x="id", by.y="geneID")
 dim(a.df.g)
# [1] 13643   430
 cpt <- a.df.g[ a.df.g$name == "CPT1B",]
 rownames(cpt) <- cpt$name
 cpt.2 <- as.matrix(cpt[, 2:(dim(y)[2]+1)])
 cpt.3 <- as.data.frame( t(cpt.2))
 dim(cpt.3)
# [1] 428   1
 cpt.3$sid <- rownames(cpt.3)
 info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
 info$sid <-  gsub("-", ".", info$SAMPID)
 info$sid <-  paste( info$sid, ".", sep="")
 cpt.7 <- merge(cpt.3, info, by.x="sid", by.y="sid")
 dim(cpt.7)
# [1] 428   8
 cpt.f <- cpt.7[ cpt.7$SEX == 2, ]
 cpt.m <- cpt.7[ cpt.7$SEX == 1, ] 
 t.test(cpt.f$CPT1B, cpt.m$CPT1B)
 t.test(log10(cpt.f$CPT1B + 1), log10(cpt.m$CPT1B+1))
dim(cpt.f)
dim(cpt.m)
 cpt.7$SEX <- factor(cpt.7$SEX, levels=c(2,1), labels=c("F", "M"))
 vioplot(cpt.7$CPT1B ~ cpt.7$SEX, xlab="", ylab="P-star-htseq CPT1B gene, CPM", col="white" )
 abline(h = seq(-100,100,0.2), lty = 5, lwd = 0.5, col = "gray")

########################cpt1b, cpm, F vs. M plot
Heart - Left Ventricle	432 samples (GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct)
>  t2$id <- gsub("-", ".", t2$V1)
  raw2 <- raw[, colnames(raw) %in% t2$id ]
  str1 <- paste(tissue, dim(raw2)[2], sep="\t")
  cat(str1)
# Heart - Left Ventricle	432
  cat("\n")
 rownames(raw2) <- raw$Name
y <- DGEList(counts=raw2)
y <- calcNormFactors(y)
med <- data.frame(y$counts[,1])
med$logic <- TRUE
d <- cpm(y)
for(i in 1:dim(y)[1]) {
 med$logic[i] <- median(d[i,]) >= 1
}
####median >= 1 for pathway genes
y<-y[med$logic,]
print(dim(y))
# [1] 13615   432
> summary(y$samples$lib.size)
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
 10186939  56820733  66039240  69412333  79500352 162805706 
> summary(y$samples$norm.factors)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.2594  0.9297  1.0752  1.0404  1.1934  2.1442 
######
 d = edgeR::cpm(y)
 a <- d
 gene.name <- raw[, 1:2]
 a.df <- as.data.frame(a)
 a.df$id <- row.names(a.df)
 a.df.g <- merge(a.df, gene.name, by.x="id", by.y="Name")
 dim(a.df.g)
# [1] 13615   434
 cpt <- a.df.g[ a.df.g$Description == "CPT1B",]
 dim(cpt)
# [1]   1 434
 rownames(cpt) <- cpt$Description
 cpt.2 <- as.matrix(cpt[, 2:(dim(y)[2]+1)])
 dim(cpt.2)
# [1]   1 432
 cpt.3 <- as.data.frame( t(cpt.2))
 cpt.3$sid <- rownames(cpt.3)
 info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
 info$sid <-  gsub("-", ".", info$SAMPID)
 cpt.7 <- merge(cpt.3, info, by.x="sid", by.y="sid")
 dim(cpt.7)
# [1] 432   8
 cpt.f <- cpt.7[ cpt.7$SEX == 2, ]
 cpt.m <- cpt.7[ cpt.7$SEX == 1, ] 
 t.test(cpt.f$CPT1B, cpt.m$CPT1B)
 t.test(log10(cpt.f$CPT1B + 1), log10(cpt.m$CPT1B+1))
 dim(cpt.f)
# [1] 138   8
 dim(cpt.m)
# [1] 294   8
 cpt.7$SEX <- factor(cpt.7$SEX, levels=c(2,1), labels=c("F", "M"))
 vioplot(cpt.7$CPT1B ~ cpt.7$SEX, xlab="", ylab="Consortium CPT1B gene, CPM", col="white" )
 abline(h = seq(-100,1000,20), lty = 5, lwd = 0.5, col = "gray")

########################DEGs, plab-star-htseq-gene-count
> y.cn <- colnames(y)
 info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
 info$sid <-  gsub("-", ".", info$SAMPID)
 info$sid <-  paste( info$sid, ".", sep="")
 info.2 <- head(info, n= dim(y)[2])
for(i in 1:dim(y)[2]) {
 t1 <- info[ info$sid == y.cn[i],]
 info.2[i,] <- t1[1,]
 }
 design <- model.matrix( ~ info.2$SEX)
y <- estimateDisp(y,design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, coef=2)
top2v1 <- topTags(qlf, n = 91234)
write.table(top2v1, "diff2-1.txt", sep="\t", quote = F)
diff <- as.data.frame(top2v1)
diff$geneID <- rownames(diff)
gene.name <- raw[, 1:2]
df.gene <- merge(diff, gene.name, by.x="geneID", by.y="geneID")
chr <- read.delim("../autism/gencode.v42.primary_assembly.noPar.gene-chr-type")
df.cpm.gene <- merge(df.gene, chr, by.x="geneID", by.y="geneID")
write.table(df.cpm.gene, "diff2-1.txt", sep="\t", quote = F)
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % mv -i  diff2-1.txt diff2-1-left-ventricle-FvsM.txt
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % mv -i diff2-1.txt diff2-1-left-ventricle-FvsM.consortium.txt

head -1 diff2-1-left-ventricle-FvsM.consortium.txt > temp.txt
for g in `echo KDM6A    KDM5C   SMC1A   ZFX     RBBP7   DDX3X   CDK16   DLG3    USP9X   BCOR    UTY     ZFY     XIST    GLA     TIMP1   SAT1    MPP1`
do
 grep -iw $g   diff2-1-left-ventricle-FvsM.consortium.txt
done >> temp.txt
grep -iw cpt1b  diff2-1-left-ventricle-FvsM.consortium.txt >> temp.txt

######################## map-stat-17350.samples.txt 
linyong@fry /lab/solexa_page/linyong$ vi scr-map-stat
linyong@fry /lab/solexa_page/linyong$ cat scr-map-stat
#
ls | grep ^dir-gtex- | while read dir
do
 cd "$dir"
 bash /lab/solexa_page/linyong/script-get-feature-count-02
 cd ..
done
linyong@fry /lab/solexa_page/linyong$ bash scr-map-stat > temp.map-stat.txt
linyong@fry /lab/page_human_data/linyong2$ cat /lab/solexa_page/linyong/temp.map-stat.txt temp.map-stat.txt > temp.txt
linyong@fry /lab/page_human_data/linyong2$ cat /lab/solexa_page/linyong/temp.map-stat.txt temp.map-stat.txt | awk 'NF < 8'
error   error   error   error   error   error   error
-1      -1      -1      -1      -1      -1      -1
error   error   error   error   error   error   error
-1      -1      -1      -1      -1      -1      -1
GTEX-1JJ6O-1426-SM-CY8HT.Aligned.sortedByCoord.out.patched.md.bam       38864534        36606739        29299051        3725025 3582663 0
GTEX-RWS6-1726-SM-47JXP.Aligned.sortedByCoord.out.patched.md.bam        31109583        29219570        23628865        2781298 2809407 0
GTEX-ZAJG-0826-SM-5PNVA.Aligned.sortedByCoord.out.patched.md.bam        35636636        33532458        27947981        1859792 3724685 0
GTEX-ZAK1-0626-SM-5HL8E.Aligned.sortedByCoord.out.patched.md.bam        36727552        34311212        27704975        3623170 2983067 0
GTEX-ZQG8-0926-SM-57WFF.Aligned.sortedByCoord.out.patched.md.bam        42416175        39816623        31588270        4595606 3632747 0
GTEX-ZVZP-0726-SM-59HKA.Aligned.sortedByCoord.out.patched.md.bam        32968593        30500272        24463767        3039866 2996639 0

##############modified script-get-feature-count-02, run again,
feature inputreads      Uniqreads       lib.size        no_feature      ambiguous       too_low_aQual   not_aligned     alignment_not_unique
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat  map-stat-17350.samples.txt | awk '$2 - $3 - $9 - $8 - $7 == 0' | wc -l
   17351
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat  map-stat-17350.samples.txt | awk ' $3 - $4 - $5 - $6 == 0' | wc -l
   17351
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat  map-stat-17350.samples.txt | cut -f 7 | uniq -c  
   1 too_low_aQual
17350 0

#############################################################################
> ms <- read.delim("map-stat-17350.samples.txt")
 ms.1 <- ms[, c(2:4)]
 colnames(ms.1) <- c("raw reads", "uniq reads", "lib.size")
 vioplot(ms.1/1e6, ylim=c(0, 150), ylab="million read pairs")
 abline(h = seq(-100,1000,10), lty = 5, lwd = 0.5, col = "gray")
 dim(ms.1)
# [1] 17350     3
 ms.2 <- data.frame( ms$feature)
 ms.2[,1] <- ms$Uniqreads / ms$inputreads
 ms.2[,2] <-  ms$lib.size / ms$Uniqreads 
 ms.2[,3] <-  ms$ambiguous / ms$Uniqreads
 ms.2[,4] <-  ms$no_feature / ms$Uniqreads
 colnames(ms.2) <- c("uniq / raw", "lib.size / uniq", "ambiguous / uniq", "no_feature / uniq")
 vioplot(ms.2)
 abline(h = seq(-100,1000,0.1), lty = 5, lwd = 0.5, col = "gray")

##########################"gtex-htseq.50tiss-10sampPertiss"
> keep <-rowSums(cpm(y)>=1) >= 10
>  y<-y[keep,]
>  dim(y)
[1] 27501   500
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat "gencode.v42.not.in.v26.6875genes" | head -1 > temp
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat "gencode.v42.not.in.v26.6875genes" | grep -w protein_coding | awk '$8 ~ /-/' >> temp ####possible read through genes
> temp <- read.delim("temp")
> dim(temp)
[1] 115  11
> dim(y)
[1] 27501   500
>  b.filt <- b.df[ rownames(b.df) %in% temp$geneID.2,]
>  dim(b.filt)
[1]  22 out of 115 possible read through genes, 500
......
> dim(t4)
[1] 500  27
> write.table(t4, "temp-2", sep="\t", quote=F)

 a <- boxplot(t5$cpm ~ t5$t4.V2,  xlab="", ylab="P-star-htseq CHKB-CPT1B, CPM", xaxt= "n")
  len <- length(unique(t5$t4.V2))
 axis(1, at = seq(1, len, by = 1), labels=substr( a$names, 1, 32), las=2, cex.axis=0.3)
 abline(h = seq(0,100,0.2), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % for g in `cat temp-2 | head -1 | cut -f 3-117`
do
 grep -w "$g" "gencode.v42.not.in.v26.6875genes" | head -1
done

#############################################################################
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 %  cat   gencode.v26.primary_assembly.annotation.gtf    | awk 'BEGIN {FS = "\t"; OFS = "\t";} NF > 6 && $3 == "gene"' > temp-gene
   58278 temp-gene
cut -f 9  temp-gene |  awk 'BEGIN {FS = "\;"} {print $1}' | sed 's/gene_id //' | sed 's/"//g' |sort | uniq > temp-gene-2
cat gencodeV26.id.name | cut -f 1 |awk 'NR > 1' |sort | uniq > temp-const-gene
cat temp-gene-2 temp-const-gene | sort | uniq -d | wc -l
   56200
   58278 temp-gene-2
   56200 temp-const-gene
######removed 2078 genes in consortium gene-count file
cat temp-gene-2 temp-const-gene | sort | uniq -u > temp-u
cat   gencode.v26.primary_assembly.annotation.gtf    | awk 'BEGIN {FS = "\t"; OFS = "\t";} NF > 6 && $3 == "transcript" ' > temp-transc
  199391 temp-transc

#######################################age_value, body_mass_index
linyong@fry ~$ /home/linyong/.local/bin/pfb to -i    "export_2023-09-18T20 27 57.avro" tsv
Creating ./tsvs/program.tsv
Creating ./tsvs/project.tsv
Creating ./tsvs/subject.tsv
Creating ./tsvs/reference_file.tsv
Creating ./tsvs/sample.tsv
Creating ./tsvs/sequencing.tsv
Done, created 7 files under: ./tsvs/

linyong@fry /lab/solexa_page/linyong$ mv -i  tsvs gtex-981subjects-tsvs

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat gtex-981subjects-tsvs/subject.tsv | cut -f 46,148,224 | head -20

source_subject_id       participant_id  submitter_id
GTEX-YB5E       GTEX-YB5E       GTEX-YB5E
GTEX-14A6H      GTEX-14A6H      GTEX-14A6H
GTEX-14PHW      GTEX-14PHW      GTEX-14PHW
cat gtex-981subjects-tsvs/subject.tsv | cut -f 46,148,224 | awk '$1 == $2' | wc -l
     981
cat gtex-981subjects-tsvs/subject.tsv | cut -f 46,148,224 | awk '$1 == $3' | wc -l
     981
cat gtex-981subjects-tsvs/subject.tsv | cut -f 46 | sort | uniq -d | wc
       0       0       0
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat gtex-981subjects-tsvs/subject.tsv | head -1 | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print i, $i}'
16      age_value
31      body_mass_index
46      source_subject_id
106     height

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat  "dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt" | wc -l
   22952

SUBJID  SAMPID  SUBJID  SEX     AGE     DTHHRDY
GTEX-1117F      GTEX-1117F-0003-SM-58Q7G        GTEX-1117F      2       60-69   4
GTEX-1117F      GTEX-1117F-0003-SM-5DWSB        GTEX-1117F      2       60-69   4
GTEX-1117F      GTEX-1117F-0003-SM-6WBT7        GTEX-1117F      2       60-69   4

cat  "dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt" | awk 'BEGIN {FS = "\t"} $1 == $3' | wc -l
   22952
cat  "dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt" | cut -f 1,5 | sort | uniq | wc -l
     981
cat  "dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt" | cut -f 1 | sort | uniq | wc -l
     981

> info2 <- read.delim("gtex-981subjects-tsvs/subject.tsv")
 info3 <- info2[, c(16,31,46, 106)]
 summary(info3)
 cpt.9 <- merge(cpt.7, info3, by.x="SUBJID", by.y="source_subject_id")
 dim(cpt.9)
# [1] 428  12
 vioplot(cpt.9$age_value ~ cpt.9$SEX, xlab="", ylab="age", col="white" )
 abline(h = seq(-100,100,2), lty = 5, lwd = 0.5, col = "gray")
 cpt.f <- cpt.9[ cpt.9$SEX == "F", ]
 cpt.m <- cpt.9[ cpt.9$SEX == "M", ]
 t.test(cpt.f$age_value, cpt.m$age_value)
 wilcox.test(cpt.f$age_value, cpt.m$age_value)
 
#######################################
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat diff2-1-left-ventricle-FvsM.txt | awk 'BEGIN {FS = "\t"} !($8 == "chrX" || $8 == "chrY")' > diff2-1-left-ventricle-FvsM.noX.Y.txt
cat   diff2-1-left-ventricle-FvsM.noX.Y.txt | awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""}
{for(i = 1; i <= 7; i++)
   print $i "\t";

 print $7 "\n";
}' > temp
../microglia/make-rnk-genesymble  temp   diff2-1-left-ventricle-FvsM.noX.Y.rnk  
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat /Users/linyongmao/Documents/h.all.v7.4.symbols.gmt > fao.gmt

bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx    fao.gmt    -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk  diff2-1-left-ventricle-FvsM.noX.Y.rnk -scoring_scheme classic(p=0)  -rpt_label   "left-ventricle-FvsM.noX.Y-weight0-FAO"  -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

> rnk <- read.delim("diff2-1-left-ventricle-FvsM.noX.Y.rnk", header=F)
 ll <- list()
 ll[[1]] <- rnk$V2
 fao <- scan(what="", sep = "\n")
 ll[[2]] <- rnk[ rnk$V1 %in% fao, 2]
 names(ll) <- c("genomic bg", "FAO genes")
 vioplot(ll, col="white")
 abline(h = seq(-100,1000,1), lty = 5, lwd = 0.5, col = "gray")
 abline(h = 0, col="blue")

#############################################################################
> deg <- read.delim("diff2-1-left-ventricle-FvsM.txt")
 layout(matrix(1:8, 2, 4, byrow=T) )
for(index in 1:length(fao)) {
# index = 1
# fao sorted on p-value (F or M biased)
 pval <- deg[ deg$name == fao[index],][1,5]
 ratio <- 2^(deg[ deg$name == fao[index],][1,2])
 if(ratio >= 1) {
 str <- paste(fao[index], ", p-value=", format(pval, digits=3), "\n F/M =", round(ratio, digits = 3), sep="")
cpt <- a.df.g[ a.df.g$name == fao[index],]
 rownames(cpt) <- cpt$name
 cpt.2 <- as.matrix(cpt[, 2:429])
 cpt.3 <- as.data.frame( t(cpt.2))
 dim(cpt.3)
# [1] 428   1
 cpt.3$sid <- rownames(cpt.3)
 info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
 info$sid <-  gsub("-", ".", info$SAMPID)
 info$sid <-  paste( info$sid, ".", sep="")
 cpt.7 <- merge(cpt.3, info, by.x="sid", by.y="sid")
 dim(cpt.7)
# [1] 428   8
 cpt.f <- cpt.7[ cpt.7$SEX == 2, ]
 cpt.m <- cpt.7[ cpt.7$SEX == 1, ]
dim(cpt.f)
dim(cpt.m)
 cpt.7$SEX <- factor(cpt.7$SEX, levels=c(2,1), labels=c("F", "M"))
 vioplot(cpt.7[,2] ~ cpt.7$SEX, xlab="", ylab="P-star-htseq  CPM", col=c("white", "gray") )
 title(main = str, cex.main = 1)
# abline(h = seq(-100,100,0.2), lty = 5, lwd = 0.5, col = "gray")
}
}

#############################################################################
############################gencode.v42.primary_assembly.noPar.protein coding genes (no readthrough_gene) + xist .gtf
linyong@fry /lab/solexa_page/linyong$ cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | awk 'BEGIN {FS = "\t"; OFS = "\t";} $3 == "gene" {print $1, $4, $5, $9} ' > temp
vi temp
cp temp temp2
bedtools intersect -wa -wb -a temp -b temp2 -sorted  > temp-temp2
cat temp-temp2 | awk '$4 != $8' | cut -f 4 | sort | uniq | wc -l
40391 genes, each overlaps some other gene(s) to some extent

cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | awk 'BEGIN {FS = "\t"; OFS = "\t";} $3 == "gene" ' | grep  protein_coding |grep -v "readthrough_gene" > temp
cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | awk 'BEGIN {FS = "\t"; OFS = "\t";} $3 == "gene" ' | grep -i xist >> temp
cat temp  | awk 'BEGIN {FS = "\t"; OFS = "\t";} $3 == "gene" {print $1, $4, $5, $9} ' > temp1
vi temp1
cp temp1 temp2
wc -l temp1 temp2
  19386 temp1
  19386 temp2

bedtools intersect -wa -wb -a temp1 -b temp2 > temp-temp2
cat temp-temp2 | awk '$4 != $8' | cut -f 4 | sort | uniq | wc -l
5295 genes, each overlaps some other protein_coding gene(s) to some extent
cat temp-temp2 | awk '$4 != $8' | cut -f 4 | sort | uniq -c | awk '$1 == 1' | wc -l
4443

gene_id "ENSG00000244731.10"; gene_type "protein_coding"; gene_name "C4A"
cat temp-temp2 | grep "ENSG00000244731.10"
chr6    31982057        32002681        ENSG00000244731.10      chr6    31982057        32002681        ENSG00000244731.10

gene_id "ENSG00000224389.9"; gene_type "protein_coding"; gene_name "C4B"
cat temp-temp2 | grep "ENSG00000224389.9"
chr6    32014795        32035418        ENSG00000224389.9       chr6    32014795        32035418        ENSG00000224389.9

gene_id "ENSG00000125730.18"; gene_type "protein_coding"; gene_name "C3"; 
cat temp-temp2 | grep "ENSG00000125730.18" | awk '$4 != $8'
chr19   6677704 6730562 ENSG00000125730.18      chr19   6729914 6737580 ENSG00000125734.16 (GPR108; G protein-coupled receptor 108)


cat temp1 |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""}
 {
     print $1 "\t" "macs2" "\t" "peak" "\t"  $2 "\t" $3 "\t" "." "\t" "+"  "\t" "."  "\t" "peak_id=\"" $4  "\"" "\n";
 }' > gencode.v42.primary_assembly.noPar.protein.xist.gtf

wc -l gencode.v42.primary_assembly.noPar.protein.xist.gtf
19386 gencode.v42.primary_assembly.noPar.protein.xist.gtf

#############################################################################
############################GTEx v8 PE mapping statistics
linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools view GTEX-11GSO-0003-SM-6WBTR.cram | awk '$3 ==  "chrX"' |  awk 'BEGIN {FS = "\t";} !($2 != 99 && $2 != 147 && $2 != 83 && $2 != 163) && $5 >= 20'  > temp-chrx.sam &

linyong@fry /lab/solexa_page/linyong/gtex-dna$ cat temp-chrx.sam | wc -l
14,658,190

cat temp-chrx.sam | cut -f 5 | sort | uniq -c | sort -g | tail -n 6
  23384 47
  58775 48
  62247 27
  91601 55
 199219 40
13,946,927 60 mapQ

linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools view GTEX-11GSO-0003-SM-6WBTR.cram | awk '$3 ==  "chr1"' |  awk 'BEGIN {FS = "\t";} !($2 != 99 && $2 != 147 && $2 != 83 && $2 != 163) && $5 >= 60'  | head -2000000 | cut -f 5 | uniq -c
2000000 60 mapQ

linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools view GTEX-11GSO-0003-SM-6WBTR.cram | awk '$3 ==  "chr1"' |  awk 'BEGIN {FS = "\t";} !($2 != 99 && $2 != 147 && $2 != 83 && $2 != 163) && $5 >= 60'  | head -200000 | cut -f 6 | sort | uniq -c | awk '$1 >= 160'
    177 138M13S
    255 146M5S
    180 147M4S
    165 148M3S
    595 149M2S
 181929 151M
    556 2S149M
    169 3S148M
    223 4S147M
    265 5S146M

linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools view GTEX-11GSO-0003-SM-6WBTR.cram | awk '$3 ==  "chr1"' |  awk 'BEGIN {FS = "\t";} !($2 != 99 && $2 != 147 && $2 != 83 && $2 != 163) && $5 >= 60'  | head -200000 | cut -f 9 | sort | uniq -c | sort -g | tail -n 6
   2043 -412
   2047 -409
   2059 407 bp library insert size
   2061 409
   2070 412
   2077 -407

###################################################RP with soft clip
###################################################single read in a pair, how does htseq count
linyong@fry /lab/solexa_page/linyong/gtex-dna$ cat temp-chrx.sam | awk 'BEGIN {FS = "\t";} $6 ~ /^[0-9]*M[0-9][0-9][0-9]*S$/' > temp.sam
cat temp-chrx.sam | awk 'BEGIN {FS = "\t";} $6 ~ /^[0-9][0-9][0-9]*S[0-9]*M$/' >> temp.sam
sort  temp.sam > temp.2.sam
rm -f temp.sam 
cat temp.2.sam  | awk 'BEGIN {FS = "\t";} $5 >= 60' > temp.3.sam
rm -f temp.2.sam 

samtools view GTEX-11GSO-0003-SM-6WBTR.cram -H > temp.4.sam
cat temp.3.sam >> temp.4.sam
linyong@fry /lab/solexa_page/linyong/gtex-dna$ htseq-count  --mode=intersection-strict  --nonunique=none  --stranded=no --idattr=peak_id  --format=sam  --order=name --type=peak temp.4.sam  /lab/solexa_page/linyong/gencode.v42.primary_assembly.noPar.protein.xist.gtf > temp.10S10M.readcount

19386 GFF lines processed.
Warning: Read H03CRALXX140919:7:1101:10064:21667 claims to have an aligned mate which could not be found in an adjacent line.
400000 alignment record pairs processed.
Warning: 392800 reads with missing mate encountered.
445395 alignment record pairs processed.
linyong@fry /lab/solexa_page/linyong/gtex-dna$ cat temp.3.sam | cut -f 1 | uniq | wc -l
445395
gene_id: ENSG00000229807.13 xist
linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools view GTEX-11GSO-0003-SM-6WBTR.cram -H > temp.4.sam
linyong@fry /lab/solexa_page/linyong/gtex-dna$ cat  temp.3.sam | awk 'BEGIN {FS = "\t";} $4 > 32097677 && $4 < 32339609' >> temp.4.sam
linyong@fry /lab/solexa_page/linyong/gtex-dna$ cat  temp.3.sam | awk 'BEGIN {FS = "\t";} $4 > 32097677 && $4 < 32339609' | cut -f 1 | uniq | wc -l
548

rm -f temp.4.sam
samtools view GTEX-11GSO-0003-SM-6WBTR.cram -H > temp.4.sam
 cat  temp.3.sam | awk 'BEGIN {FS = "\t";} $4 > 32097677 && $4 < 32339609' | head -50 >> temp.4.sam
htseq-count  --mode=intersection-strict  --nonunique=none  --stranded=no --idattr=peak_id  --format=sam  --order=name --type=peak temp.4.sam  /lab/solexa_page/linyong/gencode.v42.primary_assembly.noPar.protein.xist.gtf > temp.10S10M.readcount
tail temp.10S10M.readcount
grep ENSG00000198947.18 temp.10S10M.readcount

__not_aligned:
-------------
H03CRALXX140919:7:1101:19554:49742	163	chrX	32192809	60	138M13S	=	32193073	415
H03CRALXX140919:7:1101:20061:6073	163	chrX	32134012	60	127M24S	=	32134273	412
H03CRALXX140919:7:1101:2055:46965	163	chrX	32333145	60	93M58S	=	32333145	93
H03CRALXX140919:7:1102:18742:37753	147	chrX	32327268	60	26S125M	=	32327268	-125
H03CRALXX140919:7:1102:20924:58410	147	chrX	32268664	60	22S129M	=	32268666	-127
H03CRALXX140919:7:1103:15057:40900	163	chrX	32133806	60	126M25S	=	32134087	432


ENSG00000198947.18	1
-------------------------
H03CRALXX140919:7:1101:2055:46965	83	chrX	32333145	60	58S93M	=	32333145	-93
H03CRALXX140919:7:1101:8003:23020	99	chrX	32099827	60	136M15S	=	32100096	420
H03CRALXX140919:7:1102:18742:37753	99	chrX	32327268	60	125M26S	=	32327268	125
H03CRALXX140919:7:1102:20924:58410	99	chrX	32268666	60	127M24S	=	32268664	127

cat temp-chrx.sam | awk 'BEGIN {FS = "\t";} $5 >= 60 && $6 ~/^[0-9]*M[0-9][0-9]D[0-9]*M$/' | sort 
/^[0-9]*M[0-9][0-9]I[0-9]*M$/  
86M10D65M
124M10I17M
those reads with middle indel can be counted for (assigned to)  a gene

###########################################################################set lib.size as user defined

# ------------------------------------
raw <- data.frame(a = rep(1, 10), b = c(1,1,1,1,1,1,1,1,1,100))
raw
y <- DGEList(counts=raw, lib.size=c(100, 200))
y
y <- calcNormFactors(y)
y

# An object of class "DGEList"
# $counts
#    a   b   
# 1  1   1   
# 2  1   1   
# 3  1   1   
# 4  1   1   
# 5  1   1   
# 6  1   1   
# 7  1   1   
# 8  1   1   
# 9  1   1   
# 10 1 100 
# 
# $samples
#   group lib.size norm.factors
# a     1      100    1.4142136
# b     1      200    0.7071068

edgeR::cpm(y)

################################################################
cram="GTEX-11GSO-0003-SM-6WBTR.cram"
f=`echo "$cram" | sed 's/.cram$//' `
samtools view "$cram" |  awk 'BEGIN {FS = "\t";} !($2 != 99 && $2 != 147 && $2 != 83 && $2 != 163) && $5 >= 60' | head -212345 > "$f".1.sam

15806 ENSG00000188157.15 5396
15832 ENSG00000188290.11   79

19387           __no_feature 41832
19388            __ambiguous   144
19389        __too_low_aQual     0
19390          __not_aligned     0
19391 __alignment_not_unique     0
19392               total.RP 99433

#############################################################################
############################filtering gtf file based gene types and transcript types
linyong@fry /lab/solexa_page/linyong$ cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | grep -iw ddx3x | awk '$3 == "transcript"' | grep -o "transcript_type.\{30\}" | sort| uniq -c
     14 transcript_type "nonsense_mediated_decay"; tr
      3 transcript_type "protein_coding_CDS_not_defin
     23 transcript_type "protein_coding"; transcript_
     29 transcript_type "retained_intron"; transcript

cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | grep -iw ddx3x | awk '$3 == "transcript"' | grep "transcript_type \"protein_coding\";"
chrX	HAVANA	gene	41333348	41364472	.	+	.	gene_id "ENSG00000215301.11"; gene_type "protein_coding"; gene_name "DDX3X"; level 2; hgnc_id "HGNC:2745"; havana_gene "OTTHUMG00000021369.22";

chrX	HAVANA	transcript	41333348	41350287	.	+	.	gene_id "ENSG00000215301.11"; transcript_id "ENST00000629496.3"; gene_type "protein_coding"; gene_name "DDX3X"; transcript_type "protein_coding"; transcript_name "DDX3X-217"; level 2; protein_id "ENSP00000487224.1"; transcript_support_level "5"; hgnc_id "HGNC:2745"; tag "alternative_5_UTR"; tag "non_submitted_evidence"; tag "basic"; tag "appris_principal_4"; tag "CCDS"; ccdsid "CCDS43931.1"; havana_gene "OTTHUMG00000021369.22"; havana_transcript "OTTHUMT00000481647.3";

chrX	HAVANA	exon	41333348	41333699	.	+	.	gene_id "ENSG00000215301.11"; transcript_id "ENST00000629496.3"; gene_type "protein_coding"; gene_name "DDX3X"; transcript_type "protein_coding"; transcript_name "DDX3X-217"; exon_number 1; exon_id "ENSE00003771363.1"; level 2; protein_id "ENSP00000487224.1"; transcript_support_level "5"; hgnc_id "HGNC:2745"; tag "alternative_5_UTR"; tag "non_submitted_evidence"; tag "basic"; tag "appris_principal_4"; tag "CCDS"; ccdsid "CCDS43931.1"; havana_gene "OTTHUMG00000021369.22"; havana_transcript "OTTHUMT00000481647.3";

chrX	HAVANA	UTR	41347717	41350287	.	+	.	gene_id "ENSG00000215301.11"; transcript_id "ENST00000629496.3"; gene_type "protein_coding"; gene_name "DDX3X"; transcript_type "protein_coding"; transcript_name "DDX3X-217"; exon_number 18; exon_id "ENSE00003830364.1"; level 2; protein_id "ENSP00000487224.1"; transcript_support_level "5"; hgnc_id "HGNC:2745"; tag "alternative_5_UTR"; tag "non_submitted_evidence"; tag "basic"; tag "appris_principal_4"; tag "CCDS"; ccdsid "CCDS43931.1"; havana_gene "OTTHUMG00000021369.22"; havana_transcript "OTTHUMT00000481647.3";

chrX	HAVANA	CDS	41341484	41341616	.	+	2	gene_id "ENSG00000215301.11"; transcript_id "ENST00000629496.3"; gene_type "protein_coding"; gene_name "DDX3X"; transcript_type "protein_coding"; transcript_name "DDX3X-217"; exon_number 5; exon_id "ENSE00003572608.1"; level 2; protein_id "ENSP00000487224.1"; transcript_support_level "5"; hgnc_id "HGNC:2745"; tag "alternative_5_UTR"; tag "non_submitted_evidence"; tag "basic"; tag "appris_principal_4"; tag "CCDS"; ccdsid "CCDS43931.1"; havana_gene "OTTHUMG00000021369.22"; havana_transcript "OTTHUMT00000481647.3";

linyong@fry /lab/solexa_page/linyong$ cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | grep  "gene_id.*gene_id" | wc
      0       0       0
cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | grep  "transcript_id.*transcript_id" | wc
      0       0       0
linyong@fry /lab/solexa_page/linyong$ cat gencode.v42.primary_assembly.noPar.protein.xist.gtf | cut -f 9 | sed 's/peak_id=/     gene_id /' > temp-gene-ids-131pm

linyong@fry /lab/solexa_page/linyong$ cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | awk '$3 == "transcript"' | grep "transcript_type \"protein_coding\";"  | cut -f 9 | awk 'BEGIN {FS = ";"} {print $2}'  > temp-transcriptid-140pm

geneID-input-file 'gene_id "ENSG00000215301.11"'      protein coding genes, xist
transcript-ip-file 'transcript_id "ENST00000629496.3"'       transcript_type "protein_coding"; 

if field #3 is a gene, then gene_id xxxxxx contained in the geneID-input-file
else
  gene_id in the file && transcript_id in second file 

---------------------------
linyong@fry /lab/solexa_page/linyong$ cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | grep "gene_id \"ENSG000002298
07.13\";" | awk '$3 == "transcript"' | grep  "transcript_type \"lncRNA\"" | cut -f 9 | awk 'BEGIN {FS = ";"} {print $2}'  >> temp-transcriptid-140pm
linyong@fry /lab/solexa_page/linyong$ /lab/solexa_page/linyong/gtex-dna/process-gtf-1  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf  temp-gene-ids-131pm temp-transcriptid-140pm out
wc -l out
2094614 out
sort gencode/gencode.v42.primary_assembly.noPar.annotation.gtf  out | uniq -d | wc -l
2094614
cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | grep -iw ddx3x | awk '$3 != "transcript"' | grep -o "transcript_type.\{30\}" | sort| uniq -c
    463 transcript_type "nonsense_mediated_decay"; tr
     14 transcript_type "protein_coding_CDS_not_defin
    766 transcript_type "protein_coding"; transcript_
    298 transcript_type "retained_intron"; transcript
cat out | grep -iw ddx3x | awk '$3 != "transcript"' | grep -o "transcript_type.\{30\}" | sort| uniq -c
    766 transcript_type "protein_coding"; transcript_
cat out | grep -iw xist | awk '$3 != "transcript"' |  head
chrX    HAVANA  exon    73841382        73843533        .       -       .       gene_id "ENSG00000229807.13"; transcript_id "ENST00000669898.1"; gene_type "lncRNA"; gene_name "XIST"; transcript_type "lncRNA"; transcript_name "XIST-230"; exon_number 1; exon_id "ENSE00003871931.1"; level 2; hgnc_id "HGNC:12810"; tag "TAGENE"; havana_gene "OTTHUMG00000021839.13"; havana_transcript "OTTHUMT00000517260.2";

cat out | grep -i "readthrough" | wc
    319
cat out | grep -i "stop_codon_readthrough" | wc
    319
linyong@fry /lab/solexa_page/linyong$ mv -i out  gencode.v42.primary_assembly.noPar.protein.xist.exons.gtf

