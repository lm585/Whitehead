linyong@tak ~$ h | grep pfb
  540  pfb
  543  pip install pypfb==0.5.0
  544  pfb
  546  /home/linyong/.local/bin/pfb
  551  # pfb to -i <PATH_to_export_pfb.avro> tsv
  552  pfb to -i  export_2023-01-26T20.avro tsv
  553  /home/linyong/.local/bin/pfb to -i  export_2023-01-26T20.avro tsv
  563  #/home/linyong/.local/bin/pfb to -i  export_2023-01-26T20.avro tsv
  564  /home/linyong/.local/bin/pfb to -i export_2023-01-26T20\ 39\ 38.avro tsv
  578  /home/linyong/.local/bin/pfb to -i "export_2023-01-26T21 12 10.avro" tsv
##from tak cluster only
/home/linyong/.local/bin/pfb to -i "export_2023-01-26T21 12 10.avro" tsv
-rw-r--r-- 1 linyong input 22M Jan 26 16:18 export_2023-01-26T21 12 10.avro


./gen3-client |not exec this cmd### configure --profile=gtexv8 --cred=credentials.json --apiendpoint=https://gen3.theanvil.io
# 2023/01/27 15:22:22 Profile 'gtexv8' has been configured successfully.
./gen3-client configure --profile=gtexv8expire_3_29  --cred=credentials_expire_3_29.json --apiendpoint=https://gen3.theanvil.io
2023/02/27 12:27:17 A new version of gen3-client is available! The latest version is 2023.2.0. You are using version 2022.12
2023/02/27 12:27:17 Please download the latest gen3-client release from https://github.com/uc-cdis/cdis-data-client/releases/latest
2023/02/27 12:27:17 Profile 'gtexv8expire_3_29' has been configured successfully.

linyong@tak /lab/solexa_page/linyong$ /lab/page_human_data/linyong2/dir-gtex-118/gen3-client  configure --profile=gtexv8expire_4_26 --cred=credentials_expire_4_26.json  --apiendpoint=https://gen3.theanvil.io
2023/03/27 16:32:08 A new version of gen3-client is available! The latest version is 2023.4.0. You are using version 2022.12
2023/03/27 16:32:08 Please download the latest gen3-client release from https://github.com/uc-cdis/cdis-data-client/releases/latest
2023/03/27 16:32:08 Profile 'gtexv8expire_4_26' has been configured successfully.

linyong@fry /lab/solexa_page/linyong$ /lab/page_human_data/linyong2/dir-gtex-118/gen3-client  configure --profile=gtexv8expire_5_26 --cred=credentials-5-26-5pm.json  --apiendpoint=https://gen3.theanvil.io 
2023/04/26 17:36:24 A new version of gen3-client is available! The latest version is 2023.4.0. You are using version 2022.12
2023/04/26 17:36:24 Please download the latest gen3-client release from https://github.com/uc-cdis/cdis-data-client/releases/latest
2023/04/26 17:36:24 Profile 'gtexv8expire_5_26' has been configured successfully.

linyong@fry /lab/solexa_page/linyong$ /lab/page_human_data/linyong2/dir-gtex-118/gen3-client  configure --profile=gtexv8expire_5_26 --cred=credentials_6_26.json  --apiendpoint=https://gen3.theanvil.io 
2023/05/27 15:31:01 A new version of gen3-client is available! The latest version is 2023.6.0. You are using version 2022.12
2023/05/27 15:31:01 Please download the latest gen3-client release from https://github.com/uc-cdis/cdis-data-client/releases/latest
2023/05/27 15:31:01 Profile 'gtexv8expire_5_26' has been configured successfully.

linyong@fry /lab/solexa_page/linyong$ /lab/page_human_data/linyong2/dir-gtex-118/gen3-client  configure --profile=gtexv8expire_7_26_825 --cred=credentials_july_26_8pm.json  --apiendpoint=https://gen3.theanvil.io  
2023/06/26 20:25:38 A new version of gen3-client is available! The latest version is 2023.6.0. You are using version 2022.12
2023/06/26 20:25:38 Please download the latest gen3-client release from https://github.com/uc-cdis/cdis-data-client/releases/latest
2023/06/26 20:25:39 Profile 'gtexv8expire_7_26_825' has been configured successfully.

linyong@fry /lab/solexa_page/linyong$ /lab/page_human_data/linyong2/dir-gtex-118/gen3-client  configure --profile=gtexv8expire_oct27 --cred=credentials_expire_oct27.json   --apiendpoint=https://gen3.theanvil.io 
2023/09/27 12:11:58 A new version of gen3-client is available! The latest version is 2023.10.0. You are using version 2022.12
2023/09/27 12:11:58 Please download the latest gen3-client release from https://github.com/uc-cdis/cdis-data-client/releases/latest
2023/09/27 12:11:58 Profile 'gtexv8expire_oct27' has been configured successfully.

linyong@fry /lab/solexa_page/linyong$ /lab/page_human_data/linyong2/dir-gtex-118/gen3-client  configure --profile=gtexv8expire_nov25 --cred=credentials-oct-25.json --apiendpoint=https://gen3.theanvil.io 
2023/10/25 16:57:38 A new version of gen3-client is available! The latest version is 2023.11.0. You are using version 2022.12
2023/10/25 16:57:38 Please download the latest gen3-client release from https://github.com/uc-cdis/cdis-data-client/releases/latest
2023/10/25 16:57:39 Profile 'gtexv8expire_nov25' has been configured successfully.

linyong@fry /lab/solexa_page/linyong$ /lab/page_human_data/linyong2/dir-gtex-118/gen3-client  configure --profile=gtexv8expire_dec27_2023 --cred=credentials-11-27.json   --apiendpoint=https://gen3.theanvil.io 
2023/11/27 14:30:18 A new version of gen3-client is available! The latest version is 2023.12.0. You are using version 2022.12
2023/11/27 14:30:18 Please download the latest gen3-client release from https://github.com/uc-cdis/cdis-data-client/releases/latest
2023/11/27 14:30:19 Profile 'gtexv8expire_dec27_2023' has been configured successfully.

linyong@fry /lab/solexa_page/linyong$ /lab/page_human_data/linyong2/dir-gtex-118/gen3-client  configure --profile=gtexv8expire_4_21_2024 --cred=credentials4_21.json --apiendpoint=https://gen3.theanvil.io 
2024/03/22 16:18:45 A new version of gen3-client is available! The latest version is 2024.4.0. You are using version 2022.12
2024/03/22 16:18:45 Please download the latest gen3-client release from https://github.com/uc-cdis/cdis-data-client/releases/latest
2024/03/22 16:18:45 Profile 'gtexv8expire_4_21_2024' has been configured successfully.

linyong@fry /lab/solexa_page/linyong$  /lab/page_human_data/linyong2/dir-gtex-118/gen3-client  configure --profile=gtexv8expire_9_14_2024 --cred=credentials.expire.9.14.2024.json   --apiendpoint=https://gen3.theanvil.io 
2024/08/15 13:33:01 A new version of gen3-client is available! The latest version is 2024.8.0. You are using version 2022.12
2024/08/15 13:33:01 Please download the latest gen3-client release from https://github.com/uc-cdis/cdis-data-client/releases/latest
2024/08/15 13:33:01 Profile 'gtexv8expire_9_14_2024' has been configured successfully.

    Important: “--protocol” tag is important to this command as it will determine which bucket the files will be downloaded from. The “s3” value will download from the egress free Cleversafe bucket for the datasets in the “Downloadable” tab.

    Note: With larger manifests containing more than 100,000 files such as GTEx v8, the initial process of reading and parsing the manifest into the gen3-client can take anywhere from 30 - 240 mins.

cp -i  file-manifest.json file-manifest.test.json
vi file-manifest.test.json

./gen3-client download-multiple --profile=gtexv8  --manifest=file-manifest.test.json --download-path=dir-gtexv8-bam-files --protocol=s3
#
2023/01/27 15:36:19 A new version of gen3-client is available! The latest version is 2023.2.0. You are using version 2022.12
2023/01/27 15:36:19 Please download the latest gen3-client release from https://github.com/uc-cdis/cdis-data-client/releases/latest
2023/01/27 15:36:19 Reading manifest...
 1.86 KiB / 1.86 KiB [===========================================================================================] 100.00% 0s
WARNING: flag "rename" was set to false in "original" mode, duplicated files under "dir-gtexv8-bam-files/" will be overwritten
Proceed? [y/n]: y
2023/01/27 15:36:42 Total number of objects in manifest: 8
2023/01/27 15:36:42 Preparing file info for each file, please wait...
 8 / 8 [=========================================================================================================] 100.00% 0s
2023/01/27 15:36:42 File info prepared successfully  
GTEX-1CB4F-2326-SM-7MKFO.Aligned.sortedByCoord.out.patched.md.bam  4.77 GiB / 4.77 GiB [============================] 100.00%
GTEX-1GMRU-0011-R5a-SM-CKZNS.Aligned.sortedByCoord.out.patched.md.bam  4.83 GiB / 4.83 GiB [========================] 100.00%
GTEX-1I1CD-1226-SM-CNPQ2.Aligned.sortedByCoord.out.patched.md.bam  4.77 GiB / 4.77 GiB [============================] 100.00%
GTEX-S341-0008-SM-4AD6D.Aligned.sortedByCoord.out.patched.md.bam  4.79 GiB / 4.79 GiB [=============================] 100.00%
GTEX-RM2N-1426-SM-2TF4H.Aligned.sortedByCoord.out.patched.md.bam  6.45 GiB / 6.45 GiB [=============================] 100.00%
GTEX-1HCVE-1026-SM-ACKXR.Aligned.sortedByCoord.out.patched.md.bam  5.15 GiB / 5.15 GiB [============================] 100.00%
GTEX-1GN2E-1526-SM-7P8TD.Aligned.sortedByCoord.out.patched.md.bam  4.55 GiB / 4.55 GiB [============================] 100.00%
GTEX-17JCI-1526-SM-7IGOQ.Aligned.sortedByCoord.out.patched.md.bam  2.29 GiB / 2.29 GiB [============================] 100.00%
2023/01/27 15:43:44 8 files downloaded.

/lab/page_human_data/linyong2/dir-gtex-118/gen3-client download-multiple --profile=gtexv8expire_3_29  --manifest=temp.json --protocol=s3 --no-prompt  

##############################rm _PAR_Y lines from gtf
sort gencode.v42.primary_assembly.annotation.gtf | uniq -d | wc -l
0
cat gencode.v42.primary_assembly.annotation.gtf | grep -iw "transcript" | wc -l
252475
cat rsemindex_gencode_01.ti | grep ENST | awk 'NF == 2' | wc -l
252475
cat rsemindex_gencode_01.ti | grep ENST | awk 'NF == 2' | cut -f 1 | sort | uniq -d | wc -l
0
cat rsemindex_gencode_01.ti | grep ENST | awk 'NF == 2' | cut -f 1 | sed 's/_PAR_Y//' | sort | uniq -d | wc -l
174
cat gencode.v42.primary_assembly.annotation.gtf | grep PAR_Y | cut -f 3 | sort |uniq -c
    450 CDS
    937 exon
     47 gene
     71 start_codon
     58 stop_codon
    174 transcript
    214 UTR
450 + 937 + 47 + 71 + 58 + 174 + 214
[1] 1951
cat gencode.v42.primary_assembly.annotation.gtf | grep "_PAR_Y\"; " > temp-1
wc -l temp-1
1951 temp-1
cat temp-1 | grep "tag \"PAR\";" | wc -l
1951
grep -v "_PAR_Y\"; " gencode.v42.primary_assembly.annotation.gtf > gencode.v42.primary_assembly.noPar.annotation.gtf
grep -i "par.y" gencode.v42.primary_assembly.noPar.annotation.gtf | wc -l
0
diff gencode.v42.primary_assembly.annotation.gtf  gencode/gencode.v42.primary_assembly.annotation.gtf | wc
      0       0       0
(from helen) -r-xr-xr-x 1 linyong input 1561033529 Jan 13 20:43 gencode/gencode.v42.primary_assembly.annotation.gtf*
(download  ) -rw-r--r-- 1 linyong input 1561033529 Feb  2 14:01 gencode.v42.primary_assembly.annotation.gtf

##################

java -jar /usr/local/share/picard-tools/picard.jar SamToFastq I=GTEX-RM2N-1426-SM-2TF4H.Aligned.sortedByCoord.out.patched.md.bam FASTQ="r3.fq" SECOND_END_FASTQ="r4.fq"

[Thu Feb 02 14:45:09 EST 2023] picard.sam.SamToFastq done. Elapsed time: 14.32 minutes.
Runtime.totalMemory()=2,016,411,648

  196335196 r3.fq (49083799 read pairs)
  196335196 r4.fq
  392670392 total
awk 'NR % 4 == 1'  r3.fq | sort | uniq -d | wc
(no dup read)      0       0       0
/lab/solexa_page/linyong/dir-gtexv8-bam-files$ awk 'NR % 4 == 1'  r3.fq | sort | uniq -u | wc -l
49083799

##########################
cat slurm-wi-star-genome-index
#!/bin/bash
# Configuration values for SLURM job submission.
# One leading hash ahead of the word SBATCH is not a comment, but two are.
#SBATCH --job-name="satrgenomeindex" # friendly name for job.
#SBATCH --nodes=1                      # ensure cores are on one node
#SBATCH --ntasks=1                     # run a single task
#SBATCH --cpus-per-task=20              # number of cores/threads requested.
#SBATCH --mem=128gb                      # memory requested.
#SBATCH --partition=20                 # partition (queue) to use
#SBATCH --output star-genome-index-%j.out   # name of output file.  %j is jobid
##SBATCH --mail-type=ALL               # send email on job start/finish.
##SBATCH --mail-user=linyong@wi.mit.edu

# This is the actual section for commands to run
STAR  --runMode genomeGenerate  --genomeDir /lab/solexa_page/linyong/dir-star-genome-index-oh75  --genomeFastaFiles   /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa    --sjdbGTFfile  /lab/solexa_page/linyong/gencode/gencode.v42.primary_assembly.noPar.annotation.gtf  --sjdbOverhang 75 --runThreadN 16

# Uncomment the last line to email output file to specified address.
# Slurm doesn't do this automatically, regardless of the mail-type setting above.
#/usr/bin/mail -s "$SLURM_JOB_NAME $SLURM_JOB_ID" your_username@wi.mit.edu < friendlyname-${SLURM_JOB_ID}.out

##################bsub script-gtexv8-pipeline-download-genecount 
###pipeline QA cmds
cd /lab/solexa_page/linyong/
date
df -h | grep -i page
du -sh .
grep -in error dir-gtex-*/out-*
# dir-gtex-02/out-01:23403:  [Exception type: ValueError, raised in libcalignmentfile.pyx:947]
# check if still running
ls dir-gtex-*/out-* -lh
tail dir-gtex-*/out-*

rm -f temp1
cat dir-gtex-*/out-* > temp1
cat temp1 | grep "Uniquely mapped reads" | grep "%" | wc -l
cat temp1 | grep "Uniquely mapped reads" | grep "%" | sort +5 -6g
cat temp1 | grep "Uniquely mapped reads" | grep -v "%" | sort +5 -6g | sort | uniq -d
ls dir-gtex-*/*counts_gene -lh | grep "Feb  9 18"
# -rw-r--r-- 1 linyong input    0 Feb  9 18:26 dir-gtex-01/GTEX-WFON-2226-SM-3TW8W.Aligned.sortedByCoord.out.patched.md.bam.counts_gene
head dir-gtex-*/script-gtexv8-pipeline-download-genecount
h | grep script-make-gtexv8-pipeline
# issue pipeline cmd
# disc space used
ls -lh dir-gtex-* | grep total
# total 97G

-rw-r--r-- 1 linyong input  48G Feb  9 18:52 GTEX-14BMU-1526-SM-5TDE6.Aligned.sortedByCoord.out.patched.md.bam
-rw-r--r-- 1 linyong input  61G Feb  9 21:06 r3.fq
-rw-r--r-- 1 linyong input  61G Feb  9 21:06 r4.fq
                          Number of input reads |       334353824
                      Average input read length |       152
                   Uniquely mapped reads number |       309927931
                        Uniquely mapped reads % |       92.69%


######pipeline QC cmds; version Feb 13, 2023
cd /lab/solexa_page/linyong/
date
df -h | grep -i page
du -sh . /lab/page_human_data/linyong2/
grep -in error dir-gtex-*/out-*  /lab/page_human_data/linyong2/dir-gtex-*/out-*
# dir-gtex-02/out-01:23403:  [Exception type: ValueError, raised in libcalignmentfile.pyx:947]
# dir-gtex-41/out-dir-gtex-41-Tue_Feb_14_15:21:42_EST_2023:1867:  [Exception type: ValueError, raised in libcalignmentfile.pyx:947]

# check if still running
ls dir-gtex-*/out-*  /lab/page_human_data/linyong2/dir-gtex-*/out-* -lh
tail dir-gtex-*/out-* /lab/page_human_data/linyong2/dir-gtex-*/out-*
###avoid dup directory such as out-dir-gtex-34
bjobs -w -u  linyong | grep linyong | awk '{print $10}' | sort | sed 's/-[A-Z].*//' | sort | uniq -d
# out-dir-gtex-16
# out-dir-gtex-17
# out-dir-gtex-18

ls dir-gtex-10/*counts_gene | while read f; do grep -iw ddx3y "$f"; grep -iw xist "$f"; echo; done
# ENSG00000067048.17    DDX3Y   4
# ENSG00000229807.13    XIST    14641

#MT- genes at the end of orig/downloaded bam file
grep "MT-CO1" dir-gtex-24/*counts_gene  | sort +2 -3g | wc -l
# dir-gtex-24/GTEX-P4QS-1126-SM-3NMD5.Aligned.sortedByCoord.out.patched.md.bam.counts_gene:ENSG00000198804.2    MT-CO1  3848681

rm -f temp1
cat dir-gtex-*/out-*  /lab/page_human_data/linyong2/dir-gtex-*/out-*  > temp1
cat temp1 | grep "Uniquely mapped reads" | grep "%" | wc -l
cat temp1 | grep "Uniquely mapped reads" | grep "%" | sort +5 -6g
cat temp1 | grep "Uniquely mapped reads" | grep -v "%" | sort +5 -6g | sort | uniq -d
cat temp1 | grep "Uniquely mapped reads" | grep -v "%" | sort +5 -6g | sort  | uniq | awk 'NR == 450'
###median uniq read coverage                   Uniquely mapped reads number |   37274465

ls dir-gtex-*/*counts_gene /lab/page_human_data/linyong2/dir-gtex-*/*counts_gene  -lh | grep "Feb  9 18"
# -rw-r--r-- 1 linyong input    0 Feb  9 18:26 dir-gtex-01/GTEX-WFON-2226-SM-3TW8W.Aligned.sortedByCoord.out.patched.md.bam.counts_gene
head dir-gtex-*/script-gtexv8-pipeline-download-genecount
h | grep script-make-gtexv8-pipeline
# issue pipeline cmd
# disc space used
ls -lh dir-gtex-* | grep total
# total 97G

# error message before Fri Feb 17 12:51:13 EST 2023
# dir-gtex-02/out-01:23403:  [Exception type: ValueError, raised in libcalignmentfile.pyx:947]
# dir-gtex-38/out-dir-gtex-38-Tue_Feb_14_15:14:38_EST_2023:54102:2023/02/17 06:41:20 Error occurred when checking for latest version: Get "https://api.github.com/repos/uc-cdis/cdis-data-client/tags": dial tcp 140.82.114.6:443: connect: connection refused
### for dir-gtex-38/GTEX-146FR-0526-SM-5Q5EX.Aligned.sortedByCoord.out.patched.md.bam
### 2023/02/17 06:42:54 1 files downloaded.
### -rw-r--r-- 1 linyong input 9.9G Feb 17 07:01 r3.fq
###                    Uniquely mapped reads number |       51774649
### result ok
### -rw-r--r-- 1 linyong input 1.9M Feb 17 09:29 dir-gtex-38/GTEX-146FR-0526-SM-5Q5EX.Aligned.sortedByCoord.out.patched.md.bam.counts_gene
### next bam file 2023/02/17 09:29:54 1 files downloaded.
### -rw-r--r-- 1 linyong input 1.9M Feb 17 11:59 dir-gtex-38/GTEX-17JCI-2326-SM-7IGPC.Aligned.sortedByCoord.out.patched.md.bam.counts_gene

# dir-gtex-41/out-dir-gtex-41-Tue_Feb_14_15:21:42_EST_2023:1867:  [Exception type: ValueError, raised in libcalignmentfile.pyx:947]
# /lab/page_human_data/linyong2/dir-gtex-44/out-dir-gtex-44-Wed_Feb_15_15:26:05_EST_2023:13062:  [Exception type: ValueError, raised in libcalignmentfile.pyx:947]  
### dir-gtex-44/GTEX-1GTWX-0003-SM-EYYVV.Aligned.sortedByCoord.out.patched.md.bam  files have encountered an error during downloading
### INFO    2023-02-16 15:27:08     SamToFastq

# GTEX-XGQ4-1026-SM-4AT4L.Aligned.sortedByCoord.out.patched.md.bam
###EXITING: fatal error trying to allocate genome arrays, exception thrown: std::bad_alloc
###Possible cause 1: not enough RAM. Check if you have enough RAM 31588312371 bytes
###Possible cause 2: not enough virtual memory allowed with ulimit. SOLUTION: run ulimit -v 31588312371
### -rw-r--r-- 1 linyong page_hd 6.1G Feb 19 03:02 r4.fq
### -rw-r--r-- 1 linyong page_hd    0 Feb 19 03:02 /lab/page_human_data/linyong2/dir-gtex-54/GTEX-XGQ4-1026-SM-4AT4L.Aligned.sortedByCoord.out.patched.md.bam.counts_gene

# /lab/page_human_data/linyong2/dir-gtex-62/out-dir-gtex-62-Fri_Feb_17_13:22:32_EST_2023:218:  [Exception type: ValueError, raised in libcalignmentfile.pyx:947] GTEX-18465-0526-SM-7LG4K.Aligned.sortedByCoord.out.patched.md.bam, Error occurred when getting download URL for object; INFO    2023-02-17 13:22:40     SamToFastq; next bam file , "GTEX-11OC5-0626-SM-5HL6M.Aligned.sortedByCoord.out.patched.md.bam", to be downloaded 2023/02/17 13:27:52 A new version of gen3-client is available! The latest version is 2023.2.0. You are using version 2022.12;
head ../dir-gtex-84/GTEX-1ICLZ-0726-SM-ARL84.Aligned.sortedByCoord.out.patched.md.bam.counts_gene
ENSG00000000003.15      TSPAN6  757
ENSG00000000005.6       TNMD    24
ENSG00000000419.14      DPM1    620
ENSG00000000457.14      SCYL3   440
ENSG00000000460.17      C1orf112        194
ENSG00000000938.13      FGR     273
ENSG00000000971.17      CFH     3229
ENSG00000001036.14      FUCA2   520
ENSG00000001084.13      GCLC    399
ENSG00000001167.15      NFYA    630

head ../dir-gtex-84/GTEX-XMK1-0326-SM-4B652.Aligned.sortedByCoord.out.patched.md.bam.counts_gene
ENSG00000000003.15      TSPAN6  634
ENSG00000000005.6       TNMD    0
ENSG00000000419.14      DPM1    681
ENSG00000000457.14      SCYL3   347
ENSG00000000460.17      C1orf112        66
ENSG00000000938.13      FGR     75
ENSG00000000971.17      CFH     97
ENSG00000001036.14      FUCA2   733
ENSG00000001084.13      GCLC    717
ENSG00000001167.15      NFYA    463

head dir-gtex-97/GTEX-1B933-0011-R11a-SM-7P8PM.Aligned.sortedByCoord.out.patched.md.bam.counts_gene
ENSG00000000003.15      TSPAN6  95
ENSG00000000005.6       TNMD    0
ENSG00000000419.14      DPM1    1297
ENSG00000000457.14      SCYL3   622
ENSG00000000460.17      C1orf112        141
ENSG00000000938.13      FGR     125
ENSG00000000971.17      CFH     25
ENSG00000001036.14      FUCA2   281
ENSG00000001084.13      GCLC    861
ENSG00000001167.15      NFYA    1014

tail -n 15 dir-gtex-107/GTEX-13O3P-0626-SM-5L3D5.Aligned.sortedByCoord.out.patched.md.bam.counts_gene
ENSG00000291292.1       ENSG00000291292 0
ENSG00000291293.1       ENSG00000291293 0
ENSG00000291294.1       ENSG00000291294 0
ENSG00000291295.1       ENSG00000291295 0
ENSG00000291296.1       ENSG00000291296 4
ENSG00000291297.1       ENSG00000291297 0
ENSG00000291298.1       ENSG00000291298 0
ENSG00000291299.1       ENSG00000291299 48
ENSG00000291300.1       PRSS30P 0
ENSG00000291301.1       ENSG00000291301 0
__no_feature            2245732
__ambiguous             4096397
__too_low_aQual         0
__not_aligned           731747
__alignment_not_unique          1859550

dir-gtex-118/GTEX-ZAB5-2426-SM-5CVMW.Aligned.sortedByCoord.out.patched.md.bam.counts_gene <==
ENSG00000000003.15      TSPAN6  1901
ENSG00000000005.6       TNMD    2
ENSG00000000419.14      DPM1    1456
ENSG00000000457.14      SCYL3   443
ENSG00000000460.17      C1orf112        437
ENSG00000000938.13      FGR     144
ENSG00000000971.17      CFH     147
ENSG00000001036.14      FUCA2   223
ENSG00000001084.13      GCLC    574
ENSG00000001167.15      NFYA    2663

#######################################################################################################
###### Mar 2, 2023 gene count table for 1st 3k samples
rm -f dir-list
ls  /lab/solexa_page/linyong/ | grep dir-gtex- | awk '{print "/lab/solexa_page/linyong/" $0}' > dir-list
ls /lab/page_human_data/linyong2/ | grep "dir-gtex-[0-7][0-9]\/" | awk '{print "/lab/page_human_data/linyong2/" $0}' >> dir-list
wc -l dir-list
# 79 dir-list
bash  /lab/solexa_page/linyong/script-genecount-merge-2
ls  /lab/solexa_page/linyong/temp-gtexv8-* | wc -l
# 3127
cd /lab/solexa_page/linyong/
rm -f temp1
bsub "bash script-paste-files"
ls -lh m s
# -rw-r--r-- 1 linyong input 490M (3127 samples) Mar  2 19:21 s
grep -n '__no_feature' s | cut -f 1-10
# 62705:__no_feature
awk 'NR < 62705' s > temp1
# mv -i  temp1 gtex-comb-3127samp.gene.count.txt
awk '{print NF}' gtex-comb-3127samp.gene.count.txt | uniq -c | head
#  62704 3129
awk '{print NF}' s | uniq -c | head
#  62704 3129
#      5 3128 (lack gene_name column)
rm -f s

mkdir dir-gtex-141
cd dir-gtex-141
cp -i ../dir-gtex-131/slurm-gtexv8-pipeline-download-genecount .
grep -Ei "file_name|error"  ../dir-gtex-131/out-dir-gtex-131-Thu_16_Mar_2023_07\:50\:40_PM_EDT  | awk '{print NR, $0}'

grep -w chrM  /lab/solexa_page/linyong/gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | grep -w gene  | sort +3 -4gr
# PEER with covariates
echo "PEER with known covariates included in inference. Output in peer_our_covs/"
./peertool -f data/expression.csv -c data/covs.csv -n 20 -i 100 -o peer_out_covs


linyong@fry /lab/page_human_data/linyong2/test-dir$ samtools view  GTEX-ZP4G-0002-SM-6WBSI.cram | head
[W::cram_populate_ref] Creating reference cache directory /home/linyong/.cache/hts-ref
This may become large; see the samtools(1) manual page REF_CACHE discussion
H032JALXX140919:1:2207:24517:7181	1189	chr1	9996	0	*	=	9996	0	TGCCGTGCTTACTCCGCCCAACACCGCAACCACGCACCCCCCCCCCCCCACCCCCCACCCCACAAACCCCACACACCCACCAAACCCCCCACACCCCCCCCCCACACACACACAACACCCACACCACACAACAACACACAACACCAGCCAA	#######################################################################################################################################################	MC:Z:45S106M	PG:Z:MarkDuplicates	OQ:Z:#######################################################################################################################################################	RG:Z:H032J.1

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat MGB_100.gtex-orig.counts | wc -l
   57604
cat MGB_100.gtex-orig.counts | cut -f 1,3,5 > temp1
> setwd("/Users/linyongmao/Documents/dir-GTExV8")
t1 <- read.delim("temp1", row.names=1)
rawCount <- t1
group <- factor(rep(1, 2))
y <- DGEList(counts=rawCount,group=group)
y <- calcNormFactors(y)
#           group lib.size norm.factors
#count.gtex     1 30359242    1.0070915
#MGB_100        1 30791351    0.9929585
# 30359242 / 30791351 = 0.9859665
keep <-rowSums(cpm(y)>=1) >= 1
y<-y[keep,]
dim(y)
# [1] 11778     2
design <- model.matrix(~c("gtex", "mg"))
# error  No residual df
df <- as.data.frame( cpm(y))
> m <- lm( log10(df$MGB_100 + 1) ~ log10(df$count.gtex + 1) )
> summary(m)

Call:
lm(formula = log10(df$MGB_100 + 1) ~ log10(df$count.gtex + 1))

Residuals:
     Min       1Q   Median       3Q      Max 
-1.96619 -0.05109 -0.01576  0.01960  2.49084 

Coefficients:
                         Estimate Std. Error t value Pr(>|t|)    
(Intercept)              0.110140   0.004036   27.29   <2e-16 ***
log10(df$count.gtex + 1) 0.931960   0.002700  345.15   <2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.192 on 11776 degrees of freedom
Multiple R-squared:   0.91,	Adjusted R-squared:   0.91 
F-statistic: 1.191e+05 on 1 and 11776 DF,  p-value: < 2.2e-16

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat ../microglia/HALLMARK_INFLAMMATORY_RESPONSE.temp.genes | while read g
do
grep  " $g      "  MGB_100.gtex-orig.counts
done > temp2
cat temp2 | wc -l
     200
cat temp2 | awk '$3 == $5' | wc -l
      82
cat temp2 | awk '$3 != $5' | awk '{print $0 "\t" $5/$3}' | sort +5 -6g
geneID	name	count.gtex	geneID	MGB_100

ENSG00000136634	IL10	1621	ENSG00000136634	191	0.117829
ENSG00000105835	NAMPT	161214	ENSG00000105835	85591	0.530915
ENSG00000160223	ICOSLG	28	ENSG00000160223	16	0.571429
ENSG00000101017	CD40	877	ENSG00000101017	509	0.580388
ENSG00000109320	NFKB1	1717	ENSG00000109320	1471	0.856727
ENSG00000177272	KCNA3	357	ENSG00000177272	306	0.857143
ENSG00000080815	PSEN1	2402	ENSG00000080815	2097	0.873022
ENSG00000196352	CD55	39632	ENSG00000196352	35701	0.900812
ENSG00000163251	FZD5	741	ENSG00000163251	680	0.917679
ENSG00000137462	TLR2	49892	ENSG00000137462	46511	0.932234
ENSG00000125347	IRF1	16177	ENSG00000125347	15223	0.941027
ENSG00000175591	P2RY2	198	ENSG00000175591	187	0.944444
ENSG00000103313	MEFV	2301	ENSG00000103313	2181	0.947849
ENSG00000119535	CSF3R	65724	ENSG00000119535	63554	0.966983
ENSG00000136867	SLC31A2	430	ENSG00000136867	416	0.967442
ENSG00000185885	IFITM1	407	ENSG00000185885	395	0.970516
ENSG00000054523	KIF1B	3795	ENSG00000054523	3685	0.971014
ENSG00000142166	IFNAR1	4331	ENSG00000142166	4224	0.975294
ENSG00000197405	C5AR1	29213	ENSG00000197405	28578	0.978263
ENSG00000157227	MMP14	879	ENSG00000157227	864	0.982935
ENSG00000136244	IL6	654	ENSG00000136244	646	0.987768
ENSG00000169429	CXCL8	159116	ENSG00000169429	157368	0.989014
ENSG00000115009	CCL20	2666	ENSG00000115009	2640	0.990248
ENSG00000110324	IL10RA	8973	ENSG00000110324	8892	0.990973
ENSG00000100906	NFKBIA	72042	ENSG00000100906	71421	0.99138
ENSG00000159128	IFNGR2	10443	ENSG00000159128	10362	0.992244
ENSG00000167207	NOD2	11985	ENSG00000167207	11898	0.992741
ENSG00000060558	GNA15	2537	ENSG00000060558	2520	0.993299
ENSG00000100385	IL2RB	170	ENSG00000100385	169	0.994118
ENSG00000187764	SEMA4D	2386	ENSG00000187764	2372	0.994132
ENSG00000070961	ATP2B1	6385	ENSG00000070961	6361	0.996241
ENSG00000019169	MARCO	3951	ENSG00000019169	3938	0.99671
ENSG00000099985	OSM	34374	ENSG00000099985	34280	0.997265
ENSG00000162493	PDPN	467	ENSG00000162493	466	0.997859
ENSG00000077238	IL4R	3617	ENSG00000077238	3610	0.998065
ENSG00000043462	LCP2	48979	ENSG00000043462	48901	0.998407
ENSG00000174437	ATP2A2	1295	ENSG00000174437	1293	0.998456
ENSG00000163421	PROK2	17667	ENSG00000163421	17644	0.998698
ENSG00000185507	IRF7	810	ENSG00000185507	809	0.998765
ENSG00000142227	EMP3	2475	ENSG00000142227	2472	0.998788
ENSG00000159388	BTG2	114719	ENSG00000159388	114585	0.998832
ENSG00000110911	SLC11A2	879	ENSG00000110911	878	0.998862
ENSG00000184588	PDE4B	10684	ENSG00000184588	10672	0.998877
ENSG00000106546	AHR	1787	ENSG00000106546	1785	0.998881
ENSG00000126262	FFAR2	7445	ENSG00000126262	7437	0.998925
ENSG00000085117	CD82	6040	ENSG00000085117	6034	0.999007
ENSG00000106366	SERPINE1	1059	ENSG00000106366	1058	0.999056
ENSG00000028137	TNFRSF1B	14024	ENSG00000028137	14012	0.999144
ENSG00000171522	PTGER4	5910	ENSG00000171522	5905	0.999154
ENSG00000177105	RHOG	4320	ENSG00000177105	4317	0.999306
ENSG00000115594	IL1R1	1462	ENSG00000115594	1461	0.999316
ENSG00000108688	CCL7	1483	ENSG00000108688	1482	0.999326
ENSG00000132334	PTPRE	26749	ENSG00000132334	26731	0.999327
ENSG00000121797	CCRL2	4789	ENSG00000121797	4786	0.999374
ENSG00000067082	KLF6	64070	ENSG00000067082	64033	0.999423
ENSG00000134470	IL15RA	1907	ENSG00000134470	1906	0.999476
ENSG00000011422	PLAUR	34886	ENSG00000011422	34868	0.999484
ENSG00000130303	BST2	2276	ENSG00000130303	2275	0.999561
ENSG00000131979	GCH1	4609	ENSG00000131979	4607	0.999566
ENSG00000167995	BEST1	2848	ENSG00000167995	2847	0.999649
ENSG00000123610	TNFAIP6	2953	ENSG00000123610	2952	0.999661
ENSG00000090104	RGS1	9073	ENSG00000090104	9070	0.999669
ENSG00000173391	OLR1	9401	ENSG00000173391	9398	0.999681
ENSG00000055332	EIF2AK2	3153	ENSG00000055332	3152	0.999683
ENSG00000113070	HBEGF	19847	ENSG00000113070	19841	0.999698
ENSG00000169403	PTAFR	7301	ENSG00000169403	7299	0.999726
ENSG00000125538	IL1B	109046	ENSG00000125538	109017	0.999734
ENSG00000108691	CCL2	14478	ENSG00000108691	14475	0.999793
ENSG00000010327	STAB1	5178	ENSG00000010327	5177	0.999807
ENSG00000038945	MSR1	6574	ENSG00000038945	6573	0.999848
ENSG00000165168	CYBB	13244	ENSG00000165168	13242	0.999849
ENSG00000170458	CD14	40572	ENSG00000170458	40567	0.999877
ENSG00000188404	SELL	18160	ENSG00000188404	18158	0.99989
ENSG00000102265	TIMP1	24905	ENSG00000102265	24903	0.99992
ENSG00000171051	FPR1	35289	ENSG00000171051	35291	1.00006
ENSG00000059728	MXD1	27615	ENSG00000059728	27619	1.00014
ENSG00000124762	CDKN1A	43669	ENSG00000124762	43677	1.00018
ENSG00000184371	CSF1	4722	ENSG00000184371	4723	1.00021
ENSG00000136754	ABI1	8227	ENSG00000136754	8229	1.00024
ENSG00000124882	EREG	6708	ENSG00000124882	6710	1.0003
ENSG00000169508	GPR183	16071	ENSG00000169508	16076	1.00031
ENSG00000141506	PIK3R5	11983	ENSG00000141506	11988	1.00042
ENSG00000258227	CLEC5A	2258	ENSG00000258227	2259	1.00044
ENSG00000090339	ICAM1	20197	ENSG00000090339	20206	1.00045
ENSG00000137393	RNF144B	5743	ENSG00000137393	5746	1.00052
ENSG00000078401	EDN1	1700	ENSG00000078401	1701	1.00059
ENSG00000073008	PVR	1676	ENSG00000073008	1677	1.0006
ENSG00000139514	SLC7A1	1308	ENSG00000139514	1309	1.00076
ENSG00000135124	P2RX4	2431	ENSG00000135124	2433	1.00082
ENSG00000125384	PTGER2	7900	ENSG00000125384	7911	1.00139
ENSG00000115008	IL1A	575	ENSG00000115008	576	1.00174
ENSG00000174600	CMKLR1	558	ENSG00000174600	559	1.00179
ENSG00000049249	TNFRSF9	554	ENSG00000049249	555	1.00181
ENSG00000164136	IL15	490	ENSG00000164136	491	1.00204
ENSG00000161638	ITGA5	2377	ENSG00000161638	2382	1.0021
ENSG00000254087	LYN	13961	ENSG00000254087	13992	1.00222
ENSG00000148926	ADM	6856	ENSG00000148926	6880	1.0035
ENSG00000198121	LPAR1	1704	ENSG00000198121	1710	1.00352
ENSG00000104312	RIPK2	6503	ENSG00000104312	6526	1.00354
ENSG00000171596	NMUR1	262	ENSG00000171596	263	1.00382
ENSG00000103569	AQP9	9587	ENSG00000103569	9628	1.00428
ENSG00000131871	SELENOS	853	ENSG00000131871	857	1.00469
ENSG00000017260	ATP2C1	1108	ENSG00000017260	1114	1.00542
ENSG00000117091	CD48	1686	ENSG00000117091	1703	1.01008
ENSG00000170425	ADORA2B	76	ENSG00000170425	77	1.01316
ENSG00000175040	CHST2	530	ENSG00000175040	539	1.01698
ENSG00000089041	P2RX7	2101	ENSG00000089041	2137	1.01713
ENSG00000173039	RELA	3131	ENSG00000173039	3203	1.023
ENSG00000164023	SGMS2	911	ENSG00000164023	954	1.0472
ENSG00000065135	GNAI3	5256	ENSG00000065135	6072	1.15525
ENSG00000136997	MYC	1945	ENSG00000136997	2347	1.20668
ENSG00000122641	INHBA	161	ENSG00000122641	200	1.24224
ENSG00000100644	HIF1A	11259	ENSG00000100644	14210	1.2621
ENSG00000121989	ACVR2A	161	ENSG00000121989	216	1.34161
ENSG00000172575	RASGRP1	249	ENSG00000172575	389	1.56225
ENSG00000132155	RAF1	5473	ENSG00000132155	8798	1.60753
ENSG00000231925	TAPBP	6543	ENSG00000231925	11503	1.75806
ENSG00000162711	NLRP3	1562	ENSG00000162711	12689	8.12356

cat temp2 | awk '$3 == $5 && $3 > 0'  | sort +2 -3g
ENSG00000064989	CALCRL	2	ENSG00000064989	2
ENSG00000110436	SLC1A2	2	ENSG00000110436	2
ENSG00000105855	ITGB8	3	ENSG00000105855	3
ENSG00000124875	CXCL6	6	ENSG00000124875	6
ENSG00000057019	DCBLD2	11	ENSG00000057019	11
ENSG00000115604	IL18R1	21	ENSG00000115604	21
ENSG00000105246	EBI3	23	ENSG00000105246	23
ENSG00000169245	CXCL10	25	ENSG00000169245	25
ENSG00000105711	SCN1B	58	ENSG00000105711	58
ENSG00000164342	TLR3	68	ENSG00000164342	68
ENSG00000196639	HRH1	103	ENSG00000196639	103
ENSG00000172215	CXCR6	117	ENSG00000172215	117
ENSG00000160013	PTGIR	122	ENSG00000160013	122
ENSG00000134070	IRAK2	126	ENSG00000134070	126
ENSG00000074660	SCARF1	173	ENSG00000074660	173
ENSG00000168685	IL7R	181	ENSG00000168685	181
ENSG00000117090	SLAMF1	206	ENSG00000117090	206
ENSG00000146242	TPBG	222	ENSG00000146242	222
ENSG00000167601	AXL	227	ENSG00000167601	227
ENSG00000102962	CCL22	269	ENSG00000102962	269
ENSG00000123700	KCNJ2	287	ENSG00000123700	287
ENSG00000271503	CCL5	289	ENSG00000271503	289
ENSG00000135503	ACVR1B	405	ENSG00000135503	405
ENSG00000145623	OSMR	478	ENSG00000145623	478
ENSG00000204681	GABBR1	484	ENSG00000204681	484
ENSG00000150782	IL18	524	ENSG00000150782	524
ENSG00000115607	IL18RAP	560	ENSG00000115607	560
ENSG00000130706	ADRM1	641	ENSG00000130706	641
ENSG00000125657	TNFSF9	935	ENSG00000125657	935
ENSG00000128342	LIF	1058	ENSG00000128342	1058
ENSG00000174837	ADGRE1	1164	ENSG00000174837	1164
ENSG00000143333	RGS16	1338	ENSG00000143333	1338
ENSG00000160932	LY6E	1527	ENSG00000160932	1527
ENSG00000136868	SLC31A1	1904	ENSG00000136868	1904
ENSG00000075142	SRI	1969	ENSG00000075142	1969
ENSG00000123609	NMI	2047	ENSG00000123609	2047
ENSG00000165029	ABCA1	2666	ENSG00000165029	2666
ENSG00000130164	LDLR	2980	ENSG00000130164	2980
ENSG00000183484	GPR132	2982	ENSG00000183484	2982
ENSG00000176170	SPHK1	3753	ENSG00000176170	3753
ENSG00000121858	TNFSF10	4348	ENSG00000121858	4348
ENSG00000171860	C3AR1	7615	ENSG00000171860	7615
ENSG00000110848	CD69	7968	ENSG00000110848	7968
ENSG00000174125	TLR1	9152	ENSG00000174125	9152

chr1    HAVANA  exon    247423847       247425599       .       +       .       gene_id "ENSG00000162711.18"; transcript_id "ENST00000697350.1"; gene_type "protein_coding"; gene_name "NLRP3"; transcript_type "protein_coding"; transcript_name "NLRP3-210"; exon_number 4; exon_id "ENSE00001067929.1"; level 2; protein_id "ENSP00000513275.1"; hgnc_id "HGNC:16400"; tag "alternative_5_UTR"; tag "upstream_ATG"; tag "RNA_Seq_supported_only"; tag "basic"; tag "appris_principal_1"; havana_gene "OTTHUMG00000040647.7";

chr1    HAVANA  exon    247423847       247425599       .       +       .       gene_id "ENSG00000289728.1"; transcript_id "ENST00000697408.1"; gene_type "lncRNA"; gene_name "ENSG00000289728"; transcript_type "lncRNA"; transcript_name "ENST00000697408"; exon_number 7; exon_id "ENSE00003970522.1"; level 2; tag "RNA_Seq_supported_only"; tag "basic"; tag "Ensembl_canonical"; tag "readthrough_transcript";

cat /lab/solexa_page/linyong/Homo_sapiens.GRCh38.90.gtf| grep "24742[0-9][0-9][0-9][0-9]"  | awk '$1 == 1'  | grep -v NLRP3 | wc -l
0

for d in  `echo "dir-gtex-433 dir-gtex-436 dir-gtex-437 dir-gtex-438 dir-gtex-439" `
do
 tail -n 1 $d/out*
 cd  $d
 rm -f [GL]*
 sbatch slurm-gtexv8-pipeline-download-genecount 
 cd ..
 sleep 30
done

#####################################check stuck then rerun results
cd ../dir-gtex-433
ls -lh *counts_gene | sort  +5 -6 +6 -7g +7 -8 | awk '{print $7}' | uniq -c
ls -lh *counts_gene | sort  +5 -6 +6 -7g +7 -8
ls *counts_gene | while read f; do grep -iw ddx3y "$f"; grep -iw xist "$f"; echo; done

scontrol show job | grep linyong | grep StdOut | grep -o "dir-gtex-[0-9]*" | sort | uniq | while read d
do
echo $d
cat $d/out* | tail
echo
done

#########################merge gene count files; combine
ls  /lab/solexa_page/linyong/ | grep "^dir-gtex-[0-9]*/"  | awk '{print "/lab/solexa_page/linyong/" $0}' > dir-list
ls /lab/page_human_data/linyong2/ | grep "^dir-gtex-[0-9]*/" | awk '{print "/lab/page_human_data/linyong2/" $0}' >> dir-list
wc -l dir-list*
cat dir-list* | sort | uniq -d | wc -l
cat dir-list* | sort | uniq -u | wc -l
cat dir-list* | sort | uniq -u > temp
mv temp dir-list
###rm dir-gtex-462 from dir-list because dir-gtex-462 is still running
bash  /lab/solexa_page/linyong/script-genecount-merge-2
cat  /lab/solexa_page/linyong/temp-error | grep -v "cannot access" |head
ls  /lab/solexa_page/linyong/temp-gtexv8-* | wc -l
# 6402
cd /lab/solexa_page/linyong/
rm -f temp1
bsub "bash script-paste-files"
# 8 hour running on LSF
ls -lh s  f2 m
grep -n '__no_feature' s | cut -f 1-10
# 62705:__no_feature            1875341 3762916 3548239 3767337 2554672 3159592 2963935 2526148
awk 'NR < 62705' s > temp1
mv -i temp1 gtex-comb-6402samp.gene.count.txt
chmod -w gtex-comb-6402samp.gene.count.txt
awk '{print NF}' gtex-comb-6402samp.gene.count.txt | uniq -c | head
#  62704 6404
rm -f s

##########################################################
-r--r--r-- 1 linyong systemd-timesync  513411552 Mar  2 22:21 gtex-comb-3127samp.gene.count.txt
-r--r--r-- 1 linyong systemd-timesync  719148199 Mar 27 11:39 gtex-comb-4388samp.gene.count.txt
-r--r--r-- 1 linyong systemd-timesync 1048559353 Apr 27 23:40 gtex-comb-6402samp.gene.count.txt
-r--r--r-- 1 linyong input 380514586 May 27 01:44 gtex-comb-2317samp.gene.count.txt

################################################select 10 random samples within top half
linyongmao@Linyong-Mao-MBP16-2019 dir-gtex-website-data % cat  GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct | awk '{print NF}' | uniq -c
   1 1
   1 2
56201 17384
awk 'NR > 2'  GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct  > temp
mv temp  GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct 
head -1 GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct  | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print i, $i}' > GTEx_Analysis_2017-06-05_header
cut -f 1,7    GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt > sample-tissue.2colum
cut -f 2 sample-tissue.2colum | sort | uniq -c | wc
      56 
cat   GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt | cut -f 7,17 | sort | uniq -c   
 432 Heart - Left Ventricle	RNASEQ
 429 Heart - Atrial Appendage	RNASEQ
 803 Muscle - Skeletal	RNASEQ

> setwd("/Users/linyongmao/Documents/dir-GTExV8/dir-gtex-website-data")
t1 <- read.delim("sample-tissue.2colum", header=F)
t2 <- t1[ t1$V2 == "Heart - Left Ventricle", ]
t3 <- read.delim("GTEx_Analysis_2017-06-05_header", header=F)
head(t3)
#  V1                       V2
#1  1                     Name
#2  2              Description
#3  3 GTEX-1117F-0226-SM-5GZZ7

t4 <- merge(t3, t2, by.x="V2", by.y="V1")
dim(t4)
# [1] 432   3
head(t4)
#                         V2  V1                   V2.y
# 1 GTEX-111FC-0826-SM-5GZWO  40 Heart - Left Ventricle
# 2 GTEX-111YS-0426-SM-5987O  65 Heart - Left Ventricle
raw <- read.delim("GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct", header=T)
dim(raw)
###[1] 56200genes  17384
raw2 <- raw[, t4$V1 ]
rownames(raw2) <- raw$Name
y <- DGEList(counts=raw2)
y <- calcNormFactors(y)
med <- data.frame(y$counts[,1])
med$logic <- TRUE
d <- cpm(y)
for(i in 1:dim(y)[1]) {
 med$logic[i] <- median(d[i,]) >= 1
}
####median >= 1 for pathway genes
y<-y[med$logic,]
dim(y)
# [1] 13615   432
d = cpm(y)
t9 <- as.data.frame(d)
t10 <- log10(t9 + 1)
t11 <- cor(t10)
t12 <- as.data.frame(t11)
mat <- as.matrix(t12)
res <- data.frame(id = colnames(mat), mean = colMeans(mat))
summary( res$mean)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  0.7060  0.8903  0.9091  0.8977  0.9158  0.9291 
med <- median(res$mean)
r2 <- res[ res$mean > med, ]
dim(r2)
##[1] 216   2
set.seed(1234)
r3 <- r2[ sample(1:dim(r2)[1], 10 ), ]
write.table(r3, "Heart - Left Ventricle.10.samples", quote=F, sep='\t')

#########################merge gene count files; combine; May 25, 2023
cd /lab/page_human_data/linyong2/
from prev commands
vi dir-list
/lab/page_human_data/linyong2/dir-gtex-462/
/lab/page_human_data/linyong2/dir-gtex-487/
/lab/page_human_data/linyong2/dir-gtex-488/
/lab/page_human_data/linyong2/dir-gtex-489/
/lab/page_human_data/linyong2/dir-gtex-490/
...
/lab/page_human_data/linyong2/dir-gtex-601/
2317 samples

################################# order-bam.notProcessed
cat /lab/solexa_page/linyong/file-manifest.json  | grep "Aligned.sortedByCoord.out.patched.md.bam" | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print NR, $1}' > temp1
vi temp1
linyong@fry /lab/solexa_page/linyong$ tail temp1
...
17348   GTEX-1HCVE-1026-SM-ACKXR.Aligned.sortedByCoord.out.patched.md.bam
17349   GTEX-1GN2E-1526-SM-7P8TD.Aligned.sortedByCoord.out.patched.md.bam
17350   GTEX-17JCI-1526-SM-7IGOQ.Aligned.sortedByCoord.out.patched.md.bam
mv temp1 file-manifest.order-bam.txt
 head -1 *samp.gene.count.txt | grep -w "geneID"  |cut -f 3-1234567 | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print  $i}' > temp2
wc -l temp2
16234 temp2
> 2317 + 3127 + 4388 + 6402
[1] 16234
head temp2
GTEX-1117F-0526-SM-5EGHJ.
GTEX-1117F-2826-SM-5GZXL.
GTEX-111CU-0626-SM-5EGHL.
cat temp2  | while read g; do grep  "$g"Aligned file-manifest.order-bam.txt; done > temp3
cat file-manifest.order-bam.txt temp3 | sort | uniq -d | wc
  16234
cat file-manifest.order-bam.txt temp3 | sort | uniq -u | wc
   1116
cat file-manifest.order-bam.txt temp3 | sort | uniq -u > file-manifest.order-bam.notProcess.5.27.23
head /lab/solexa_page/linyong/file-manifest.order-bam.notProcess.5.27.23  
10068   GTEX-146FR-1826-SM-5QGPF.Aligned.sortedByCoord.out.patched.md.bam
10069   GTEX-13RTJ-0726-SM-5QGQN.Aligned.sortedByCoord.out.patched.md.bam
10070   GTEX-15RIE-0626-SM-6M47G.Aligned.sortedByCoord.out.patched.md.bam

#################################filter first then normalization?
cp -i temp-tissue-names tissue-names-lucas-list
Rscript R-script-select-gtex-samples-in-a-tissue > out-select-gtex-samples-in-a-tissue 
###median < 0.9 tissues
6 GTEX-11DXX-1326-SM-5GIDZ 257 Stomach
[1] 15530   359
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.7631  0.8313  0.8708  0.8562  0.8829  0.9073 

6 GTEX-117YW-1826-SM-5PNY5 167 Colon - Transverse
[1] 16005   406
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.7880  0.8249  0.8440  0.8467  0.8712  0.9002 

cut -f 2 *10samples.940pm  | grep -vw mean > list.10samples.940pm.per15tissues

setwd("/Users/linyongmao/Documents/dir-GTExV8/dir-gtex-website-data")
raw <- read.delim("GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct", header=T)
dim(raw)
samp <- read.delim("list.10samples.940pm.per15tissues", header=F)
dim(samp)
# [1] 150   1
raw.samp <- raw[, colnames(raw) %in% samp$V1]
dim(raw.samp)
#[1] 56200   150
rownames(raw.samp) <- raw$Name
length(raw.samp[,1] - raw[, "GTEX.11DXW.1026.SM.5H11K"]  )
##[1] 56200
summary( raw.samp[,1] - raw[, "GTEX.11DXW.1026.SM.5H11K"]  )
write.table(raw.samp, "temp.raw.txt", quote=F, sep="\t")
system("bash script-sel-expr-genes")
raw.samp.filt <- read.delim("temp-1338", header=T)
dim(raw.samp.filt)
##[1] 25271   150
y <- DGEList(counts=raw.samp.filt)
y <- calcNormFactors(y)
summary(y$samples$lib.size)
##    Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
##35270131  51678694  62455252  65975200  77647586 124561663 
summary(y$samples$norm.factors)
##   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
## 0.4770  0.7966  1.0715  1.0415  1.2766  1.5738 

y <- DGEList(counts=raw.samp)
y <- calcNormFactors(y)
> summary(y$samples$lib.size)
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
 35282054  51700389  62499855  66006365  77674598 124592493 
> summary(y$samples$norm.factors)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.4991  0.8023  1.0639  1.0389  1.2576  1.5958 

#################################sample x gene heatmap 
head(colnames(raw))
# [1] "Name"                     "Description"              "GTEX.1117F.0226.SM.5GZZ7" "GTEX.1117F.0426.SM.5EGHI" "GTEX.1117F.0526.SM.5EGHJ" "GTEX.1117F.0626.SM.5N9CS"
dim(raw)
# [1] 56200 17384

y <- DGEList(counts=raw.samp)
y <- calcNormFactors(y)
dim(y)
#[1] 56200   150
keep <-rowSums(cpm(y)>=1) >= 10
y<-y[keep,]
dim(y)
#[1] 20784   150
d = cpm(y)
a <- d
b = log10(a+1)
b.df <- as.data.frame(b)
b.mat <- as.matrix(b.df)
b.mat.t <- t(b.mat)
t1 <- read.delim("sample-tissue.2colum", header=F)
b.mat.t.df <- as.data.frame(b.mat.t)
b.mat.t.df$id <- rownames(b.mat.t.df)
###add a column id to t1, 'GTEX.1117F.0003.SM.58Q7G'
t1$id <- gsub("-", ".", t1$V1)
t2 <- merge(b.mat.t.df, t1, by.x="id", by.y="id")
dim(t2)
t3 <- read.delim("samp-name-T55", header=F)
head(t3)
#                            V1 V2
#1       Adipose - Subcutaneous T1
#2 Adipose - Visceral (Omentum) T2
#3                Adrenal Gland T3

t4 <- merge(t2, t3, by.x="V2", by.y="V1")
rownames(t4) <- paste( t4$V2.y, gsub("GTEX", "", t4$V1), sep="")
t4[1:2, c(1:3, 20785:20788)]
#                                                  V2                       id ENSG00000227232.5 ENSG00000210194.1 ENSG00000198727.2                       V1 V2.y
# T2-145ME-0726-SM-5O9A3 Adipose - Visceral (Omentum) GTEX.145ME.0726.SM.5O9A3         0.5625113         0.3050703          3.953870 GTEX-145ME-0726-SM-5O9A3   T2
# T2-1KXAM-0526-SM-DKPQN Adipose - Visceral (Omentum) GTEX.1KXAM.0526.SM.DKPQN         0.3690278         0.3502886          3.935615 GTEX-1KXAM-0526-SM-DKPQN   T2

mat <- as.matrix(t4[, c(3:20786)])
ca <- HeatmapAnnotation(tissue = t4$V2, which="row")
> Heatmap(matrix = mat, show_column_names=F, name="logCPM", row_names_gp = gpar(fontsize = 4), right_annotation=ca, row_dend_width=unit(30, "mm"))

rowlabel <- data.frame(t4$V2)
rowlabel$tissue <- ""
rowlabel$tissue[ seq(1, 150, 10)] <- t4$V2[ seq(1,150, 10)]
Heatmap(matrix = mat, show_column_names=F, name="logCPM", row_names_gp = gpar(fontsize = 6), right_annotation=ca, row_dend_width=unit(30, "mm"), row_labels= rowlabel$tissue)

cut -f 1 GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt > temp1
cut -f 1 GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"}  {print $1, $1}'| sed 's/-/@@@/' | sed 's/-.*      /       /' | sed 's/@@@/-/' > temp1
vi temp1
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine  temp1 GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.txt out
paste temp1 out  | cut -f 1-6 > GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt

> t5 <- read.delim("GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
> t4.sex <- merge(t5, t4, by.x="SAMPID", by.y="V1")
> t4.sex$sex <- "male"
> t4.sex[ t4.sex$SEX == 2, ]$sex <- "female"
> ca <- HeatmapAnnotation(tissue = t4.sex$V2, sex = t4.sex$sex,which="row")
> ca <- HeatmapAnnotation(tissue = t4.sex$V2, sex = t4.sex$sex,which="row", col=list(sex = c("female" = "red", "male" = "blue")))
> mat <- as.matrix(t4.sex[, c(9:20792)])
> dim(mat)
[1]   150 20784

#####################################using z-score of log10(cpm+1), pearson for clustering
mat <- as.matrix(t4[, c(3:20786)])
a <- mat
for(i in 1:dim(mat)[1])
{
 a[i, ] <- (mat[i, ] - mean(as.numeric(mat[i,]))) / var(as.numeric(mat[i,]))^(1/2)
}
###a is z-score of log10(cpm+1)
m1 <- mat
mat <- a
summary( data.frame(mat[11,]))
var( data.frame(mat[11,]))

ca <- HeatmapAnnotation(tissue = t4$V2, which="row")
> Heatmap(matrix = mat, show_column_names=F, name="z-score", row_names_gp = gpar(fontsize = 4), right_annotation=ca, row_dend_width=unit(30, "mm"), clustering_distance_rows="pearson", clustering_distance_columns="pearson")

rowlabel <- data.frame(t4$V2)
rowlabel$tissue <- ""
rowlabel$tissue[ seq(1, 150, 10)] <- t4$V2[ seq(1,150, 10)]
> Heatmap(matrix = mat, show_column_names=F, name="z-score", row_names_gp = gpar(fontsize = 4), right_annotation=ca, row_dend_width=unit(30, "mm"), clustering_distance_rows="pearson", clustering_distance_columns="pearson", row_labels= rowlabel$tissue)


#######################################################Website downloaded gene count vs. my star-htseq pipeline

> t2 <- merge(b.mat.t.df, t1, by.x="id", by.y="id")
t3 <- t2[ t2$V2 == "Heart - Atrial Appendage",][, 1:11]
y$samples[ t3$id,]
# GTEX.1AX8Z.1126.SM.731CS     1  60397468    0.9614743
# GTEX-1AX8Z-1126-SM-731CS Heart - Atrial Appendage GTEX.1AX8Z.1126.SM.731CS

GTEX-1AX8Z-1126-SM-731CS
gtex-comb-6402samp.gene.count.txt
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % head -1 gtex-comb-6402samp.gene.count.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print i, $i}' | grep GTEX-1AX8Z-1126-SM-731CS
2464	GTEX-1AX8Z-1126-SM-731CS.
cut -f 1,2,2464 gtex-comb-6402samp.gene.count.txt > temp1
vi temp1               
# :1, $ s/\.[0-9]*//
linyongmao@Linyong-Mao-MBP16-2019 dir-gtex-website-data % cut -f 1,2,6674 GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct > temp2
vi temp2
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine ../temp1 temp2  out
paste  ../temp1 out | grep -v notApplicable > temp3

> me.gtex.compare <- read.delim("temp3")
    geneID              name           GTEX.1AX8Z.1126.SM.731CS   geneID.1         Description        GTEX.1AX8Z.1126.SM.731CS.1
 Length:55484       Length:55484       Min.   :      0.0        Length:55484       Length:55484       Min.   :      0           
 Class :character   Class :character   1st Qu.:      0.0        Class :character   Class :character   1st Qu.:      0           
 Mode  :character   Mode  :character   Median :      1.0        Mode  :character   Mode  :character   Median :      1           
                                       Mean   :    535.7                                              Mean   :   1087           
                                       3rd Qu.:     55.0                                              3rd Qu.:    112           
                                       Max.   :1815295.0                                              Max.   :3542877           
me.gtex.2 <- me.gtex.compare[ me.gtex.compare$GTEX.1AX8Z.1126.SM.731CS > 5 & me.gtex.compare$GTEX.1AX8Z.1126.SM.731CS.1 >5,]
dim(me.gtex.2)
# [1] 19590     6
res <- lm( me.gtex.2$GTEX.1AX8Z.1126.SM.731CS.1 ~ me.gtex.2$GTEX.1AX8Z.1126.SM.731CS)
summary(res)

# Coefficients:
#                                     Estimate Std. Error  t value Pr(>|t|)    
# (Intercept)                        67.126582  28.100205    2.389   0.0169 *  
# me.gtex.2$GTEX.1AX8Z.1126.SM.731CS  1.978679   0.001423 1390.068   <2e-16 ***
# 
# Multiple R-squared:   0.99,	Adjusted R-squared:   0.99 
# F-statistic: 1.932e+06 on 1 and 19588 DF,  p-value: < 2.2e-16

res <- lm( log2(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS.1) ~ log2(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS))
summary(res)

# Coefficients:
#                                          Estimate Std. Error t value Pr(>|t|)    
# (Intercept)                              0.709241   0.016022   44.27   <2e-16 ***
# log2(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS) 1.022752   0.001951  524.15   <2e-16 ***
# 
# Multiple R-squared:  0.9334,	Adjusted R-squared:  0.9334 
# F-statistic: 2.747e+05 on 1 and 19588 DF,  p-value: < 2.2e-16

####################################
plot(log2(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS.1) ~ log2(2 * me.gtex.2$GTEX.1AX8Z.1126.SM.731CS), xlab="log2( 2 * geneCount), STAR-htseq", ylab = "log2(geneCount), RNA-SeQC")
y = 1:5
x = y
abline(lm(y~x), lwd = 1, col="blue")
# abline(lm( log2(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS.1) ~ log2(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS)), lwd = 1, col="blue")
abline(h = seq(-100,100,5), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(-100,100,5), lty = 5, lwd = 0.5, col = "gray")
text(5, 20, "y = x", col="blue")

me.gtex.2 <- me.gtex.compare[ me.gtex.compare$GTEX.1AX8Z.1126.SM.731CS > 5 | me.gtex.compare$GTEX.1AX8Z.1126.SM.731CS.1 >5,]
dim(me.gtex.2)
# [1] 22391     6
res <- lm( me.gtex.2$GTEX.1AX8Z.1126.SM.731CS.1 ~ me.gtex.2$GTEX.1AX8Z.1126.SM.731CS)
summary(res)
# lm(formula = me.gtex.2$GTEX.1AX8Z.1126.SM.731CS.1 ~ me.gtex.2$GTEX.1AX8Z.1126.SM.731CS)
# 
# Coefficients:
#                                     Estimate Std. Error  t value Pr(>|t|)    
# (Intercept)                        68.696260  24.716778    2.779  0.00545 ** 
# me.gtex.2$GTEX.1AX8Z.1126.SM.731CS  1.978662   0.001339 1478.195  < 2e-16 ***
# Residual standard error: 3689 on 22389 degrees of freedom
# Multiple R-squared:  0.9899,	Adjusted R-squared:  0.9899 

#11 ; 22
#11+1; 22+2
#2*(11+1); 22+2
#2(a+1); 2a+2

res <- lm( log2(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS.1+2) ~ log2(2*(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS+1)))
summary(res)
# Call:
# lm(formula = log2(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS.1 + 2) ~ 
#     log2(2 * (me.gtex.2$GTEX.1AX8Z.1126.SM.731CS + 1)))
# 
# Coefficients:
#                                                    Estimate Std. Error t value Pr(>|t|)    
# (Intercept)                                        0.651697   0.022193   29.36   <2e-16 ***
# log2(2 * (me.gtex.2$GTEX.1AX8Z.1126.SM.731CS + 1)) 0.920062   0.002564  358.87   <2e-16 ***
# 
# Residual standard error: 1.259 on 22389 degrees of freedom
# Multiple R-squared:  0.8519,	Adjusted R-squared:  0.8519 

plot(log2(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS.1+2) ~ log2(2*(me.gtex.2$GTEX.1AX8Z.1126.SM.731CS+1)), xlab="log2(2 *(geneCount + 1)), STAR-htseq", ylab =     "log2(geneCount + 2), RNA-SeQC", ylim=c(0, 25), xlim=c(0, 25))
abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
y = 1:5 
x = y 
abline(lm(y~x), lwd = 1, col="blue")
text(5, 20, "y = x", col="blue")
#########
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat  temp3 | awk 'BEGIN {FS = "\t"; OFS = "\t"} $6 > 5 && $3 > 5' > temp4
# 19590 expressed genes in both approaches
cat temp4 | awk 'BEGIN {FS = "\t"; OFS = "\t"}  NR > 1 {print $0, $6 / ($3 * 2);}' > temp5
dir-gtex-website-data/GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct
cat temp5 | awk 'BEGIN {FS = "\t"; OFS = "\t"}  $7 < 1/2' | wc -l
    1136
cat temp5 | awk 'BEGIN {FS = "\t"; OFS = "\t"}  $7 > 2' | wc -l
#     669genes higher expr in website of gtex

cat temp5 | awk 'BEGIN {FS = "\t"; OFS = "\t"}  $7 < 1/10' | wc -l
      50
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp5 | awk 'BEGIN {FS = "\t"; OFS = "\t"}  $7 > 10' | wc -l
     187

ENSG00000243646 IL10RB  41      ENSG00000243646 IL10RB  1164    14.1951
ENSG00000276409 CCL14   64      ENSG00000276409 CCL14   1573    12.2891
ENSG00000100142 POLR2F  638     ENSG00000100142 POLR2F  35      0.0274295
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp3 |  awk 'BEGIN {FS = "\t"; OFS = "\t"}  $3 == 0 && $6 > 200' |wc
     130     780    7322
cat temp3 |  awk 'BEGIN {FS = "\t"; OFS = "\t"}  $6 == 0 && $3 > 100' |wc
       2      12     117

#################################randomly select 10 samples among top half for metabolite data
raw <- read.csv("allTissues_filtered_3QCcriteria_noNAvalues_60metabolites_in_columns.csv")
dim(raw)
# [1] 378  63
rownames(raw) <- raw$sample_name
tiss <- unique(raw$tissue)
# 19 tissues
for(index in 1:length(tiss))
{
x <- tiss[index]
print(x)

raw.tis <- raw[ raw$tissue == x, ]
dim(raw.tis)
# "LV" [1] 23samples 63metabolites - 3
met.tis.df <- log10(raw.tis[, 4:63] + 1)
print(dim(met.tis.df))
t1 <- as.matrix(met.tis.df)
t2 <- t(t1)
t3 <- as.data.frame(t2)
t11 <- cor(t3)
t12 <- as.data.frame(t11)
mat <- as.matrix(t12)
res <- data.frame(id = colnames(mat), mean = colMeans(mat))
print(summary( res$mean))
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
#  0.9820  0.9862  0.9886  0.9879  0.9903  0.9914
if(dim(met.tis.df)[1] < 10)
{
 print(dim(met.tis.df));
 r3 <- res;
}
else
{
 med <- median(res$mean)
 r2 <- res[ res$mean > med, ]
 print(dim(r2))
 # [1] 11  2
 set.seed(1234)
 r3 <- r2[ sample(1:dim(r2)[1], 10 ), ]                                  
}
#                                                                        id      mean
# 20220607_QE2_LC_Job2504_Heart_LV_147 20220607_QE2_LC_Job2504_Heart_LV_147 0.9911448
# 20220607_QE2_LC_Job2504_Heart_LV_167 20220607_QE2_LC_Job2504_Heart_LV_167 0.9902635
outfile <- paste("metab.", x, ".10samples.157pm", sep = "")
print(outfile)
write.table(r3, outfile, quote=F, sep='\t')
}

#################################sample x metabolite heatmap
linyongmao@Linyong-Mao-MBP16-2019 dir-gtex-website-data % cut -f 1 metab*.157pm | grep -wv id > list.10samples.orless.940pm.per19tissues
rm(list=ls())
raw <- read.csv("allTissues_filtered_3QCcriteria_noNAvalues_60metabolites_in_columns.csv")
samp <- read.delim("list.10samples.orless.940pm.per19tissues", header=F)
dim(samp)
# [1] 176   1
raw.samp <- raw[ raw$sample_name %in% samp$V1,]
# raw.samp <- raw
dim(raw.samp)
# [1] 176  63
raw.tis <- raw.samp
dim(raw.tis)
# "LV" [1] 23samples 63metabolites - 3
b <- log10(raw.tis[, 4:63] + 1)
a = b
for(i in 1:dim(b)[1])
{
 a[i, ] <- (b[i, ] - mean(as.numeric(b[i,]))) / var(as.numeric(b[i,]))^(1/2)
}
met.tis.df <- a
print(dim(met.tis.df))
# [1] 176  60
rownames(met.tis.df) <- raw.tis$sample_name
mat <- as.matrix(met.tis.df)
ca <- HeatmapAnnotation(tissue = raw.tis$tissue, which="row")
rowlabel <- data.frame(raw.tis$CDP)
rowlabel$tissue <- ""
step = 4
rowlabel$tissue[ seq(1, dim(met.tis.df)[1], step)] <- raw.tis$tissue[ seq(1, dim(met.tis.df)[1], step)]
Heatmap(matrix = mat, show_column_names=F, name="logMetab", row_names_gp = gpar(fontsize = 4), right_annotation=ca, row_dend_width=unit(30, "mm"), row_labels= rowlabel$tissue)
> Heatmap(matrix = mat, show_column_names=F, name="z-socre (metab)", row_names_gp = gpar(fontsize = 4), right_annotation=ca, row_dend_width=unit(30, "mm"), clustering_distance_rows="pearson", clustering_distance_columns="pearson")

#################################################################################################
linyong@fry /lab/solexa_page/linyong$ awk '{print NF}' gtex-all-samples.gene.count.txt | uniq -c
  62704 17352
linyong@fry /lab/solexa_page/linyong$ ls -lh gtex-all-samples.gene.count.txt
-r--r--r-- 1 linyong systemd-timesync 2.7G Jun 19 16:29 gtex-all-samples.gene.count.txt
#############################################################################
# STAR-HTseq Gencode.v42.
raw <- read.delim("gtex-all-samples.gene.count.txt", header=T)
dim(raw)
# [1] 62703 17352
samp <- read.delim("dir-gtex-website-data/list.10samples.940pm.per15tissues", header=F)
dim(samp)
# [1] 150   1
samp$V2 <- paste( samp$V1, ".", sep="")
raw.samp <- raw[, colnames(raw) %in% samp$V2]
dim(raw.samp)
# [1] 62703   150
rownames(raw.samp) <- raw$geneID
length(raw.samp[,1] - raw[, "GTEX.11DXW.1026.SM.5H11K."]  )
# [1] 62703
summary( raw.samp[,1] - raw[, "GTEX.11DXW.1026.SM.5H11K."]  )
y <- DGEList(counts=raw.samp)
y <- calcNormFactors(y)
dim(y)
# [1] 62703   150
summary(y$samples$norm.factors)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.4905  0.8240  1.0683  1.0344  1.2348  1.5247 
summary(y$samples$lib.size)
#     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
# 17613867 25867647 31913960 33285316 38551244 60174325 
keep <-rowSums(cpm(y)>=1) >= 10
y<-y[keep,]
dim(y)
# [1] 22204   150
d = cpm(y)
a <- d
b = log10(a+1)
b.df <- as.data.frame(b)
b.mat <- as.matrix(b.df)
b.mat.t <- t(b.mat)
t1 <- read.delim("dir-gtex-website-data/sample-tissue.2colum", header=F)
b.mat.t.df <- as.data.frame(b.mat.t)
b.mat.t.df$id <- rownames(b.mat.t.df)
dim(b.mat.t.df)
# [1]   150samples 22205 - 1 genes log10(cpm+1)
t1$id2 <- gsub("-", ".", t1$V1)
t1$id <- paste(t1$id2, ".", sep="")
t2 <- merge(b.mat.t.df, t1, by.x="id", by.y="id")
dim(t2)
t3 <- read.delim("dir-gtex-website-data/samp-name-T55", header=F)
head(t3)
#                            V1 V2
#1       Adipose - Subcutaneous T1
#2 Adipose - Visceral (Omentum) T2
#3                Adrenal Gland T3
t4 <- merge(t2, t3, by.x="V2", by.y="V1")
rownames(t4) <- paste( t4$V2.y, gsub("GTEX", "", t4$V1), sep="")
t4[1:2, c(1:3, 22205:22209)]
#                                                  V2                        id ENSG00000000003.15 ENSG00000291299.1 ENSG00000291300.1
# T2-145ME-0726-SM-5O9A3 Adipose - Visceral (Omentum) GTEX.145ME.0726.SM.5O9A3.           1.479368         0.3126457        0.04093152
# T2-1KXAM-0526-SM-DKPQN Adipose - Visceral (Omentum) GTEX.1KXAM.0526.SM.DKPQN.           1.715370         0.4391680        0.08077925
#                                              V1                      id2 V2.y
# T2-145ME-0726-SM-5O9A3 GTEX-145ME-0726-SM-5O9A3 GTEX.145ME.0726.SM.5O9A3   T2
# T2-1KXAM-0526-SM-DKPQN GTEX-1KXAM-0526-SM-DKPQN GTEX.1KXAM.0526.SM.DKPQN   T2
mat <- as.matrix(t4[, c(3:22206)])
dim(mat)
#[1]   150 22204
ca <- HeatmapAnnotation(tissue = t4$V2, which="row")
rowlabel <- data.frame(t4$V2) 
> Heatmap(matrix = mat, show_column_names=F, name="log10_CPM", row_names_gp = gpar(fontsize = 4), right_annotation=ca, row_dend_width=unit(30, "mm"), row_labels= rowlabel$t4.V2)

#########
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt | cut -f 7,17 | sort | uniq    | grep -i rnaseq |cut -f 1  > gtex-54tiss.txt
cut -f 2 *htseq.10samples.851pm |grep -v mean > gtex-htseq.50tiss-10sampPertiss
cat out-R-script-select-gtex-htseq-samples-in-a-tissue-912pm  | awk '(NR -1) % 5 == 1' | cut -f 1

#############################################################################
raw <- read.delim("gtex-all-samples.gene.count.txt", header=T)
dim(raw)
# [1] 62703 17352
samp <- read.delim("gtex-htseq.50tiss-10sampPertiss", header=F)
dim(samp)
samp$V2 <- paste( samp$V1, ".", sep="")
raw.samp <- raw[, colnames(raw) %in% samp$V2]
dim(raw.samp)
rownames(raw.samp) <- raw$geneID
summary( raw.samp[,1] - raw[, "GTEX.144GL.2926.SM.5O99F."]  )
y <- DGEList(counts=raw.samp)
y <- calcNormFactors(y)
dim(y)
summary(y$samples$norm.factors)
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#  0.3249  0.8577  1.0377  1.0408  1.2318  1.9053 
summary(y$samples$lib.size)
#     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
# 12279814 26497412 31427822 32812601 37609295 87255002 
keep <-rowSums(cpm(y)>=1) >= 10
y<-y[keep,]
dim(y)
# [1] 27501   500
d = cpm(y)
a <- d
b = log10(a+1)
b.df <- as.data.frame(b)
b.mat <- as.matrix(b.df)
b.mat.t <- t(b.mat)
t1 <- read.delim("dir-gtex-website-data/sample-tissue.2colum", header=F)
b.mat.t.df <- as.data.frame(b.mat.t)
b.mat.t.df$id <- rownames(b.mat.t.df)
dim(b.mat.t.df)
# [1]   500 27502
t1$id2 <- gsub("-", ".", t1$V1)
t1$id <- paste(t1$id2, ".", sep="")
t2 <- merge(b.mat.t.df, t1, by.x="id", by.y="id")
dim(t2)
t3 <- read.delim("dir-gtex-website-data/samp-name-T55", header=F)
head(t3)
#                            V1 V2
#1       Adipose - Subcutaneous T1
#2 Adipose - Visceral (Omentum) T2
#3                Adrenal Gland T3
t4 <- merge(t2, t3, by.x="V2", by.y="V1")
rownames(t4) <- paste( t4$V2.y, gsub("GTEX", "", t4$V1), sep="")
t4[1:2, c(1:6, 27500:27506)]
mat <- as.matrix(t4[, c(3:27503)])
dim(mat)
# [1]   500 27501
 
ca <- HeatmapAnnotation(tissue = t4$V2, which="row")
rowlabel <- data.frame(t4$V2) 
rowlabel$tissue <- ""
step = 2
rowlabel$tissue[ seq(1, dim(t4)[1], step)] <- t4$V2[ seq(1, dim(t4)[1], step)]
> Heatmap(matrix = mat, show_column_names=F, name="log10_CPM", row_names_gp = gpar(fontsize = 3), right_annotation=ca, row_dend_width=unit(30, "mm"), row_labels= rowlabel$tissue)

######brain tissues only
> t4.brain <- t4[ grepl("Brain", t4$V2),]
> dim(t4.brain)
[1]   130 27506

mat <- as.matrix(t4.brain[, c(3:27503)])
dim(mat)
ca <- HeatmapAnnotation(tissue = t4.brain$V2, which="row")
rowlabel <- data.frame(t4.brain$V2)
rowlabel$tissue <- ""
step = 2
rowlabel$tissue[ seq(1, dim(t4.brain)[1], step)] <- t4.brain$V2[ seq(1, dim(t4.brain)[1], step)]
> Heatmap(matrix = mat, show_column_names=F, name="log10_CPM", row_names_gp = gpar(fontsize = 5), right_annotation=ca,  row_labels= rowlabel$tissue, clustering_distance_rows="pearson", row_dend_width=unit(30, "mm"))

#for non-bain cells 
 Heatmap(matrix = mat, show_column_names=F, name="log10_CPM", row_names_gp = gpar(fontsize = 3), right_annotation=ca,  row_labels= rowlabel$tissue,  row_dend_width=unit(30, "mm"))

#########QC of star-htseqcount res
rm -f temp1
head -1 gtex-all-samples.gene.count.txt > temp1
grep -iw xist gtex-all-samples.gene.count.txt >> temp1
grep -iw ddx3y gtex-all-samples.gene.count.txt >> temp1
grep -iw zfy gtex-all-samples.gene.count.txt >> temp1
grep -iw CPT1B gtex-all-samples.gene.count.txt >> temp1

~/Documents/microglia/table-transpose temp1 temp1-transp
# rm 1st line from temp1-transp
# rm . from samaple ID GTEX-1117F-0003-SM-58Q7G.
vi  temp1-transp

> t1 <- read.delim("temp1-transp")
info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
gene.info <- merge(t1, info, by.x="name", by.y="SAMPID")
dim(gene.info)
# [1] 17350    12
tis <- read.delim("dir-gtex-website-data/sample-tissue.2colum")
gene.info.tiss <- merge( gene.info, tis, by.x="name", by.y="SAMPID")
plot(log2( gene.info.tiss$XIST +1) ~ log2( gene.info.tiss$DDX3Y +1), col = "white")
g2.f <- gene.info.tiss[ gene.info.tiss$SEX == 2 , ]
g2.m <- gene.info.tiss[ gene.info.tiss$SEX == 1 , ]
points(log2(g2.f$DDX3Y +1), log2(g2.f$XIST +1), col = "red")
points(log2(g2.m$DDX3Y +1), log2(g2.m$XIST +1), col = "blue")
abline(h = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")
legend(0, 2.5, c("F", "M"), pch = c(16,16),col = c("red", "blue" ) )

g2 <- gene.info.tiss[ gene.info.tiss$SEX == 2 & gene.info.tiss$DDX3Y > 100,]
dim(g2)
# [1] 20samples 

g.brain <- gene.info.tiss[ !grepl("Brain", gene.info.tiss$SMTSD), ]
#A numerical vector of the form c(bottom, left, top, right) which gives the number of lines of margin to be specified on the four sides of the plot
#41 boxplots
#Small Intestine - Terminal Ileum
par( mar=c(8,5,2,2))
a <- boxplot(log2(g.brain$CPT1B+1) ~ g.brain$SMTSD, xlab="", ylab="log2(CPT1B raw gene count)", xaxt= "n")
len <- length(unique(g.brain$SMTSD))
axis(1, at = seq(1, len, by = 1), labels=substr( a$names, 1, 32), las=2, cex.axis=0.5)
abline(h = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")

#########compare star-htseq with GTEx_Analysis_2017-06-05_v8_RNASeQC
head -1 gtex-all-samples.gene.count.txt > temp1
grep -iw xist gtex-all-samples.gene.count.txt >> temp1
~/Documents/microglia/table-transpose temp1 temp1-transp

head -1 dir-gtex-website-data/GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct > temp2
grep -iw xist dir-gtex-website-data/GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct >> temp2
~/Documents/microglia/table-transpose temp2 temp2-transp
vi temp1-transp 
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine  temp1-transp temp2-transp out
paste  temp1-transp  out > temp1-temp2
cat temp1-temp2 | wc -l
   17351
cat temp1-temp2 |  awk 'BEGIN {FS = "\t"; OFS = "\t"} $4 == $2 * 2' | wc -l
    2171
>t1 <- read.delim("temp1-temp2")
info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
gene.info <- merge(t1, info, by.x="Description", by.y="SAMPID")
dim(gene.info)
# [1] 17350     9
g2.f <- gene.info[ gene.info$SEX == 2 , ]
dim(g2.f)
# [1] 5783    9
g2.m <- gene.info[ gene.info$SEX == 1 , ]
dim(g2.m)
# [1] 11567     9

plot(log2( gene.info$XIST.1+2) ~ log2(2*(gene.info$XIST+1)), xlab="log2(2 *(geneCount + 1)), STAR-htseq", ylab =     "log2(geneCount + 2), RNA-SeQC", ylim=c(0, 20), xlim=c(0, 20), col = "white")
points( log2(2*(g2.f$XIST+1)),log2( g2.f$XIST.1+2), col = "red")
points( log2(2*(g2.m$XIST+1)),log2( g2.m$XIST.1+2), col = "blue")
abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
y = 1:5
x = y
abline(lm(y~x), lwd = 1, col="blue")
text(2, 20, "y = x", col="blue")
legend(2, 18, c("F", "M"), pch = c(16,16),col = c("red", "blue" ) )

##########################x-axis consortium; y-axis P-lab
> par(mar=c(5,6,4,2))
plot(log2(2*(gene.info$XIST+1)) ~ log2( gene.info$XIST.1+2), xlab="Consortium XIST gene count \n log2(geneCount + 2)", ylab="P-star-htseq XIST gene count \n log2(2 *(geneCount + 1))", ylim=c(0, 20), xlim=c(0, 20), col = "white")

points(log2( g2.f$XIST.1+2), log2(2*(g2.f$XIST+1)), col = "red")
points(log2( g2.m$XIST.1+2), log2(2*(g2.m$XIST+1)),col = "blue")
abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
y = 1:5
x = y
abline(lm(y~x), lwd = 1, col="blue")
text(2, 20, "y = x", col="blue")
legend(2, 18, c("F", "M"), pch = c(16,16),col = c("red", "blue" ) )

##########################cpt1b P-lab vs consortium
  head -1 gtex-all-samples.gene.count.txt > temp1
grep -iw cpt1b gtex-all-samples.gene.count.txt | grep -v CHKB >> temp1
~/Documents/microglia/table-transpose temp1 temp1-transp

head -1 dir-gtex-website-data/GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct > temp2
grep -iw   cpt1b dir-gtex-website-data/GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct | grep -v CHKB  >> temp2
~/Documents/microglia/table-transpose temp2 temp2-transp
vi temp1-transp
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine  temp1-transp temp2-transp out
paste  temp1-transp  out > temp1-temp2-CPT1B
> t1 <- read.delim("temp1-temp2-CPT1B")
info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
gene.info <- merge(t1, info, by.x="Description", by.y="SAMPID")
dim(gene.info)
 par(mar=c(5,6,4,2))
 plot(log2(2*(gene.info$CPT1B+1)) ~ log2( gene.info$CPT1B.1+2), xlab="Consortium CPT1B gene count \n log2(geneCount + 2)", ylab="P-star-htseq CPT1B gene count \n log2(2 *(geneCount + 1))", ylim=c(0,10), cex=0.5)
 abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")

######################boxplot of cpt1b across tissues
 tis <- read.delim("dir-gtex-website-data/sample-tissue.2colum")
 head(tis)
#                          SAMPID                        SMTSD
# 1      GTEX-1117F-0003-SM-58Q7G                  Whole Blood
 gene.info.tiss <- merge( gene.info, tis, by.x="Description", by.y="SAMPID")
 g.brain <- gene.info.tiss[ !grepl("Brain", gene.info.tiss$SMTSD), ]
 dim(g.brain)
# [1] 14708    10
par( mar=c(8,5,2,2))
a <- boxplot(log2(2*(g.brain$CPT1B+1)) ~ g.brain$SMTSD, xlab="", ylab="P-star-htseq CPT1B gene count \n log2(2 *(geneCount + 1))", xaxt= "n")
 len <- length(unique(g.brain$SMTSD))
 axis(1, at = seq(1, len, by = 1), labels=substr( a$names, 1, 32), las=2, cex.axis=0.5)
 abline(h = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")

par( mar=c(8,5,2,2))
a <- boxplot(log2(g.brain$CPT1B.1+2) ~ g.brain$SMTSD, xlab="", ylab="Consortium CPT1B gene count \n log2(geneCount + 2)", xaxt= "n")
 len <- length(unique(g.brain$SMTSD))
 axis(1, at = seq(1, len, by = 1), labels=substr( a$names, 1, 32), las=2, cex.axis=0.5)
 abline(h = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")

###read in CHKB-CPT1B gene count
> t1 <- read.delim("temp1-transp")
 g.brain.chkb <- merge(t1, g.brain, by.x="name", by.y="Description")
 dim(g.brain.chkb)
# [1] 14708    12
par( mar=c(8,5,2,2))
a <- boxplot(log2(2*(g.brain.chkb$CHKB.CPT1B+1)) ~ g.brain.chkb$SMTSD, xlab="", ylab="P-star-htseq CHKB-CPT1B gene count \n log2(2 *(geneCount + 1))", xaxt= "n")

> sink("temp.txt")

for(i in 1:length(unique(g.brain.chkb$SMTSD))) {
 temp <- g.brain.chkb[ g.brain.chkb$SMTSD == sort(unique(g.brain.chkb$SMTSD))[i],]
 res <- lm(log2(2*(temp$CPT1B.x+1)) ~ log2( temp$CPT1B.1+2))
 sum <- summary(res)
 p <- (sum$coefficients[2,4])
 str <- paste(sort(unique(g.brain.chkb$SMTSD))[i], dim(temp)[1], res$coefficients[1], res$coefficients[2], sum$r.squared, p, sep="\t")
 cat(str)
 cat("\n")
}
sink()

#############################################################################
linyong@fry /lab/solexa_page/linyong/autism$ cp -i ../gtex-all-samples.gene.count.txt.gz  .
linyong@fry /lab/solexa_page/linyong/autism$ gunzip gtex-all-samples.gene.count.txt.gz
linyong@fry /lab/solexa_page/linyong/autism$ ls -l gtex-all-samples.gene.count.txt ../gtex-all-samples.gene.count.orig.txt
-r--r--r-- 1 linyong systemd-timesync 2838623072 Jun 19 17:02 ../gtex-all-samples.gene.count.orig.txt
-r--r--r-- 1 linyong systemd-timesync 2838623072 Jun 26 12:40 gtex-all-samples.gene.count.txt
linyong@fry /lab/solexa_page/linyong/autism$ diff ../gtex-all-samples.gene.count.orig.txt gtex-all-samples.gene.count.txt | wc
      0       0       0
linyong@fry /lab/solexa_page/linyong/autism$ rm -f gtex-all-samples.gene.count.txt

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % scp linyong@tak.wi.mit.edu:/lab/solexa_page/linyong/gtex-all-samples.gene.count.orig.txt ./
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % ls -l gtex-all-samples.*
-rw-r--r--  1 linyongmao  staff  2838623072 Jun 26 12:54 gtex-all-samples.gene.count.orig.txt
-rw-r--r--  1 linyongmao  staff  2838623072 Jun 19 17:30 gtex-all-samples.gene.count.txt
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % diff gtex-all-samples.gene.count.orig.txt gtex-all-samples.gene.count.txt | wc
       0       0       0
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % rm -f gtex-all-samples.gene.count.orig.txt

#############################################################################
linyong@fry /lab/page_human_data/gtexV8-reMap-2023$ ls -lh /lab/solexa_page/linyong/gtex-all-samples.gene.count.txt.gz
linyong@fry /lab/page_human_data/gtexV8-reMap-2023$ cp -i /lab/solexa_page/linyong/gtex-all-samples.gene.count.txt.gz ./
linyong@fry /lab/page_human_data/gtexV8-reMap-2023$ cp -i /lab/solexa_page/linyong/gencode/gencode.v42.primary_assembly.annotation.gtf ./
-r--r--r-- 1 linyong page_hd 763306586 Jun 26 13:07 /lab/page_human_data/gtexV8-reMap-2023/gtex-all-samples.gene.count.txt.gz
-r--r--r-- 1 linyong systemd-timesync 763306586 Jun 19 16:29 /lab/solexa_page/linyong/gtex-all-samples.gene.count.txt.gz

drwxr-sr-x   2 linyong  page_hd   52 Jun 26 13:06 gtexV8-reMap-2023/
drwxr-sr-x 637 linyong  page_hd  21K Jun 19 15:33 linyong2/

##################################################
linyong@fry /lab/page_human_data/linyong2/test-dir$ cat script-test-325
#
ls GTEX*counts_gene | head -101 | grep -v GTEX-1IL2U-0626-SM-CE6TA.Aligned. | while read ll
do

# ll="GTEX-111CU-0526-SM-5EGHK.Aligned.sortedByCoord.out.patched.md.bam.counts_gene"
f=`echo "$ll" | sed 's/Aligned.sortedByCoord.out.patched.md.bam.counts_gene//' `
t=` head -1 /lab/solexa_page/linyong/gtex-all-samples.gene.count.orig.txt |  awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print i, $i}' | grep -w "$f" | head -1 | cut -f 1`
cut -f 1,2,$t /lab/solexa_page/linyong/gtex-all-samples.gene.count.orig.txt > temp-"$f"-cnt
echo -n "numofdifflines "
diff "temp-$f-cnt" "$ll" | wc -l
echo "$ll"
diff "temp-$f-cnt" "$ll"
rm "temp-$f-cnt"

done
###

linyong@fry /lab/page_human_data/linyong2/test-dir$ rm -f out-july-2
linyong@fry /lab/page_human_data/linyong2/test-dir$ bash script-test-325 > out-july-2
cat out-july-2 | grep numof  | uniq -c
    100 numofdifflines  8
cat out-july-2 | grep '62704a62704,62708' | uniq -c
    100 62704a62704,62708
wc -l out-july-2
1000 out-july-2

##################C-P-stomach-10-10samp.raw
using R-script-select-gtex-htseq-samples-in-a-tissue
#stomach 
> tissue = file[49,1]
t2 <- t1[ t1$V2 == tissue, ]
 t2$id <- gsub("-", ".", t2$V1)
 t2$id <- paste(t2$id, ".", sep="")
 raw2 <- raw[, colnames(raw) %in% t2$id ]
 str1 <- paste(tissue, dim(raw2)[2], sep="\t")
 cat(str1)
 cat("\n")
 rownames(raw2) <- raw$geneID
> r3 <- raw2[ ,sample(1:dim(raw2)[2], 10 )]
> write.table(r3, "P-stomach-10samp.raw", sep="\t", quote=F)
> samp <- colnames(r3)
> samp
 [1] "GTEX.1RAZR.1526.SM.EAZ4U." "GTEX.R55C.1026.SM.48FCM." 
> raw <- read.delim("dir-gtex-website-data/GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct", header=T)
> s2 <- gsub(".$", "", samp)
> r4 <- raw[,  colnames(raw) %in% s2]
> rownames(r4) <- raw$Name
write.table(r4, "C-stomach-10samp.raw", sep="\t", quote=F)
# 44 PAR_Y genes in the website gene count matrix
# ENSG00000168939.11_PAR_Y
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % /Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine  C-stomach-10samp.raw P-stomach-10samp.raw out
paste C-stomach-10samp.raw out | grep -vw notApplicable > C-P-stomach-10-10samp.raw
wc -l  C-stomach-10samp.raw P-stomach-10samp.raw C-P-stomach-10-10samp.raw
   56201 C-stomach-10samp.raw
   62704 P-stomach-10samp.raw
   55485 C-P-stomach-10-10samp.raw
> r1 <- read.delim("C-P-stomach-10-10samp.raw")
> raw <- r1[, c(2:11, 13:22)]
> rownames(raw) <- r1$geneID
> dim(raw)
# [1] 55484    20
y <- DGEList(counts=raw)
y <- calcNormFactors(y)
med <- data.frame(y$counts[,1])
med$logic <- TRUE
d <- edgeR::cpm(y)
for(i in 1:dim(y)[1]) {
 med$logic[i] <- median(d[i,]) >= 1
}
####median >= 1 for pathway genes
y<-y[med$logic,]
print(dim(y))
# [1] 15880    20
d = edgeR::cpm(y)
t9 <- as.data.frame(d)
t10 <- log10(t9 + 1)
t11 <- cor(t10)
t12 <- as.data.frame(t11)
mat <- as.matrix(t12)
 c1 <- paste("C-", rownames(mat)[1:10], sep="")
 c2 <- paste("P-", rownames(mat)[11:20], sep="")
 rownames(mat) <- c(c1,c2)
 colnames(mat) <- c(c1,c2)
> Heatmap(mat, name = "correlation", row_order=sort(rownames(mat)), column_order=sort(colnames(mat)), row_names_gp = gpar(fontsize = 8), column_names_gp = gpar(fontsize = 8))
 c1 <- data.frame(cor = 1:45)
 c1$cor = -1
k = 1
for(i in 1:10) {
 for(j in 1:10) {
 if(j > i)
 {
   c1$cor[k] = mat[i,j]
   k <- k+1
 }
}
}
 ll <- list()
 ll[[1]] <- c1$cor

c1$cor = -1
k = 1
for(i in 11:20) {
 for(j in 11:20) {
 if(j > i)
 { 
   c1$cor[k] = mat[i,j]
   k <- k+1
 }
}
}
 ll[[2]] <- c1$cor
 identical(rownames(mat), colnames(mat))
 rownames(mat)
c2 <- data.frame(cor = 1:10)
c2$cor = -1

k = 1
for(i in 1:10) {
   r <- gsub("^C-", "", rownames(mat)[i])
   r <- paste("P-", r, sep="")
   r <- paste( r, ".", sep="")
  c2$cor[k] = mat[ i, colnames(mat) == r ][1]                  
  k <- k+1
}
ll[[3]] <- c2$cor

boxplot(ll, ylab=" correlation (r)", xaxt="n", outcol ="white")
 beeswarm(ll, add = T)
 abline(h = seq(0,100,0.05), lty = 5, lwd = 0.5, col = "gray")
 axis(1, at = 1:3, labels=c("Consortium sample-sample", "P-star-htseq.count sample-sample", "C-P same sample"))

 c3 <- data.frame(cor = 1:45)
 c3$cor = -1
k = 1
for(i in 1:10) {
 for(j in 1:10) {
 if(j > i)
 { 
   r <- gsub("^C-", "", rownames(mat)[i])
   r <- paste("P-", r, sep="")
   r <- paste( r, ".", sep="")
   c <- gsub("^C-", "", colnames(mat)[j])
   c <- paste("P-", c, sep="")
   c <- paste( c, ".", sep="")

   c3$cor[k] = mat[ rownames(mat) == r, colnames(mat) == c ][1] 
   k <- k+1
 }
}
}

 plot(c3$cor ~ ll[[1]], ylab="P-star-htseq.count sample-sample corr", xlab ="Consortium sample-sample corr")
 y = 1:5
 x = y
 abline(lm(y~x))
 abline(h = seq(-10,10,0.05), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-10,10,0.05), lty = 5, lwd = 0.5, col = "gray")
##################
> C.GTEX.1RAZR.1526.SM.EAZ4U <- t10[, "GTEX.1RAZR.1526.SM.EAZ4U"]
 P.GTEX.1RAZR.1526.SM.EAZ4U <- t10[, "GTEX.1RAZR.1526.SM.EAZ4U."]
 plot(P.GTEX.1RAZR.1526.SM.EAZ4U ~ C.GTEX.1RAZR.1526.SM.EAZ4U)
 title("log10(cpm+1); R-squared:  0.8757")
y22 = 1:5
x = y22
abline(lm(y22~x), lwd = 1.5, col="blue")
 abline(h = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 text(0.5, 4, "P-star-htseq.count", pos=4)
 text(3.5, 1, "Consortium", pos = 4)

###randomly pick 1000 genes with cpm > 0
> d = edgeR::cpm(y)
> t9 <- as.data.frame(d)
 df <- data.frame(t9$GTEX.1RAZR.1526.SM.EAZ4U, t9$GTEX.1RAZR.1526.SM.EAZ4U.)
####already median of 20 cpm >= 1
 df2 <- df[ df[,1] > 0 & df[,2] > 0,]
 dim(df2)
# [1] 15758     2
 df3 <- df2[ sample(1:dim(df2)[1], 1000),]
 plot(log10(df3$t9.GTEX.1RAZR.1526.SM.EAZ4U.) ~ log10(df3$t9.GTEX.1RAZR.1526.SM.EAZ4U), xlab = "consortium, log10(cpm)", ylab = "P-star-htseq.count, log10(cpm)")
y22 = 1:5
x = y22
abline(lm(y22~x), lwd = 1.5, col="blue")
 abline(h = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 x = 1:10
 y22 <- x + log10(1.5)
 abline(lm(y22~x),lty=5, lwd = 1, col="red")
 y22 <- x - log10(1.5)
 abline(lm(y22~x),lty=5, lwd = 1, col="red")
 legend("topleft", inset=0.05, legend=c("y=x", "+/- log10(1.5)"), lty = c(1, 5), col = c("blue", "red"))
##########################hallmark pathway genes
 r1 <- read.delim("C-P-stomach-10-10samp.raw")
 raw <- r1[, c(2:11, 13:22)]
 rownames(raw) <- r1$geneID
 dim(raw)
# [1] 55484    20
y <- DGEList(counts=raw)
y <- calcNormFactors(y)
med <- data.frame(y$counts[,1])
med$logic <- TRUE
d <- edgeR::cpm(y)
for(i in 1:dim(y)[1]) {
 med$logic[i] <- median(d[i,]) >= 1
}
####median >= 1 for pathway genes
y<-y[med$logic,]
print(dim(y))
# [1] 15880    20
.......
> g.n <- read.delim("gencode.v42.primary_assembly.noPar.geneID-name.2")
> t10$geneID <- rownames(t10)
> t10.g <- merge(t10, g.n, by.x="geneID", by.y="geneID")
rm -f temp temp-u
ls HALL*.genes | grep -v temp | while read f
do
  cat "$f" >> temp
done

cat temp | sort | uniq > temp-u
wc -l temp temp-u
    7321 temp
    4383 temp-u
> h.g <- read.delim("../microglia/temp-u", header=F)
> t10.g.h <- t10.g[ t10.g$name %in% h.g$V1,]
> dim(t10.g.h)
[1] 3881   22
C.GTEX.1RAZR.1526.SM.EAZ4U <- t10.g.h[, "GTEX.1RAZR.1526.SM.EAZ4U"]
 P.GTEX.1RAZR.1526.SM.EAZ4U <- t10.g.h[, "GTEX.1RAZR.1526.SM.EAZ4U."]
plot(P.GTEX.1RAZR.1526.SM.EAZ4U ~ C.GTEX.1RAZR.1526.SM.EAZ4U)
 title("log10(cpm+1);")
y22 = 1:5
x = y22
abline(lm(y22~x), lwd = 1.5, col="blue")
 abline(h = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 text(0.5, 3, "P-star-htseq.count", pos=4)
 text(3, 1.5, "Consortium", pos = 4)

##################sample inputreads Uniquelyreads lib.size        no_feature      ambiguous       too_low_aQual
#sample inputreads Uniquelyreads  sample	lib.size	no_feature	ambiguous	too_low_aQual	not_alignedalignment_not_unique
GTEX-1117F-3226-SM-5N9CT.Aligned.sortedByCoord.out.patched.md.bam	40408706	37511071	GTEX-1117F-3226-SM-5N9CT.Aligned.sortedByCoord.out.patched.md.bam	31392486	2078686	4039899	0	794779	2102856
> sum(x[3:8]) == x[1]
inputreads == lib.size + no_feature + ambiguous + too_low_aQual + not_aligned + alignment_not_unique
> sum(x[3], x[4], x[5]) == x[2]
uniqreads == lib.size + no_feature + ambiguous

linyong@fry /lab/solexa_page/linyong/dir-gtex-10$ rm -f temp1 temp2 temp3 temp11
-rw-r--r-- 1 linyong systemd-timesync 1.1K Jul 15 23:14 /lab/solexa_page/linyong/dir-gtex-10/script-get-feature-count

linyong@fry /lab/page_human_data/linyong2$ ls | grep "^dir-gtex-[0-9]*" > temp-dir-1
##rm dir-600 and later dir that are 2nd round remap
vi temp-dir-1
linyong@fry /lab/page_human_data/linyong2$ cat temp-scr-01 
#
cat temp-dir-1 | while read dir
do
 cd "$dir"
 echo -n "$dir"
 n=`ls GTEX*counts_gene  | wc -l`
 e=`grep -i  error out* | wc -l `
 echo "	$n	$e"
 cd ..
done
linyong@fry /lab/page_human_data/linyong2$ bash temp-scr-01 > map-dir-countsFilesNum-errorNum
# dir-gtex-147/   20      0
cat map-dir-countsFilesNum-errorNum | awk '$2 == 20 && $3 == 0' | wc -l
439
cat map-dir-countsFilesNum-errorNum | awk '$2 == 20 && $3 == 0' | awk 'NR % 50 == 1' | cut -f 1
dir-gtex-147/ #this dir not used ; 40 + 20*8 = 200 samples for mapping statis
dir-gtex-197/
dir-gtex-249/
dir-gtex-304/
dir-gtex-354/
dir-gtex-406/
dir-gtex-458/
dir-gtex-510/
dir-gtex-561/
cat map-dir-countsFilesNum-errorNum | awk '$2 == 20 && $3 == 0' | awk 'NR % 50 == 1' | cut -f 1 > map-test-dir
linyong@fry /lab/page_human_data/linyong2$ cat temp-scr-2
#
cat map-test-dir | awk 'NR > 1' | while read dir
do
 cd "$dir"
 bash /lab/solexa_page/linyong/dir-gtex-10/script-get-feature-count
 cd ..
done

linyong@fry /lab/page_human_data/linyong2$ cat /lab/solexa_page/linyong/dir-gtex-10/script-get-feature-count
#
#
rm -f temp1 temp2 temp3 temp11
head GTEX*.STAR.log | grep "==> " | sed 's/.STAR.log <==//' > temp1
head GTEX*.STAR.log | grep "Number of input reads" | awk '{print $6}'  > temp2
head GTEX*.STAR.log | grep "Uniquely mapped reads number" | awk '{print $6}' > temp3
paste temp1 temp2 temp3 > temp11
wc -l temp1 temp2 temp3 temp11

b=`ls GTEX*counts_gene  | awk 'NR == 1' `
echo "feature	$b" |  sed 's/.counts_gene//' > s
echo -n "lib.size	" >> s
cat  "$b" | awk ' NF == 3' |  awk 'BEGIN {FS = "\t"; s = 0} {
s += $3;}
END {print s}' >> s

tail -n 5 "$b" | awk '{print $1 "\t" $2}' | sed 's/__//' >> s
ls GTEX*counts_gene  | awk 'NR > 1' | while read f
do
  echo "$f" |  sed 's/.counts_gene//' > f2
  cat  "$f" | awk ' NF == 3' |  awk 'BEGIN {FS = "\t"; s = 0} {
s += $3;}
END {print s}' >> f2

  tail -n 5 "$f" | awk '{print  $2}' | sed 's/__//' >> f2       
  paste s f2 > m
  mv m s
done
ls -lh s
 ~/C++/table-transpose s s-tr
cat  temp11 | sed 's/==> //' | sort > temp12
awk 'NR > 1' s-tr | sort  > s-tr-1 ###rm header line
paste temp12 s-tr-1 > temp13
ls -lh temp13
cat temp13

rm temp1 temp2 temp3 temp11 temp12 temp13 s f2 m s-tr s-tr-1 
linyong@fry /lab/page_human_data/linyong2$ bash temp-scr-2 | awk 'NF > 9' > map-test-200-files

linyong@fry /lab/page_human_data/linyong2$ cd /lab/solexa_page/linyong/dir-gtex-10/
linyong@fry /lab/solexa_page/linyong/dir-gtex-10$ bash script-get-feature-count | awk 'NF > 9' >> /lab/page_human_data/linyong2/map-test-200-files
linyong@fry /lab/page_human_data/linyong2$ cat  map-test-200-files | awk '$1 == $4' | wc -l
201 #including 1 header line
cat  map-test-200-files | cut -f 2 | sort | uniq -d |wc
      0       0       0 #no two #.of.input.reads identical
cat  map-test-200-files | awk 'NR > 1 {print $3 / $2}' | sort -g | awk 'NR == 100'
0.933841
cat  map-test-200-files | awk 'NR > 1 {print $3 / $2}' | sort -g | awk 'NR == 20'
0.78069
#############################################################################
> map <- read.delim("map-test-200-files")
 par( mar=c(9,5,1,2))
 plot(0,0, xlim=c(0,205), ylim=c(0, 12e7), col="white", xlab="", ylab="reads", xaxt = "n" )
 points(1:dim(map)[1], map$inputreads, pch = 1, col = "black", cex = 0.2 )
 lines(1:dim(map)[1], map$inputreads,  col = "black")
 points(1:dim(map)[1], map$Uniquelyreads, pch = 1, col = "red", cex = 0.2 )
 lines(1:dim(map)[1], map$Uniquelyreads,  col = "red")
 points(1:dim(map)[1], map$lib.size, pch = 1, col = "blue", cex = 0.2 )
 lines(1:dim(map)[1], map$lib.size,  col = "blue")
 points(1:dim(map)[1], map$no_feature, pch = 1, col = "green", cex = 0.2 )
 lines(1:dim(map)[1], map$no_feature,  col = "green")
 abline(h = seq(0, 20e8,1e7), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100, 1000, 10), lty = 5, lwd = 0.5, col = "gray")
 axis(1, at = seq(1, dim(map)[1], by=1), labels=gsub(".Aligned.sortedByCoord.out.patched.md.bam", "", map$sample), las = 2, cex.axis=0.5)
 legend(100, 1.2e8, legend=c("raw read", "uniq mapped read", "uniq read in non-overlap exon", "no_feature"), col = c("black", "red", "blue", "green"), lty = 1, cex = 0.8 )

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % sort -t '        ' +1 -2g map-test-200-files > map-test-200-files-sorted-1
> map <- read.delim("map-test-200-files-sorted-1")
......
 points(1:dim(map)[1], map$not_aligned, pch = 1, col = "green", cex = 0.2 )
 lines(1:dim(map)[1], map$not_aligned,  col = "green")
 abline(h = seq(0, 20e8,1e7), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100, 1000, 10), lty = 5, lwd = 0.5, col = "gray")
 axis(1, at = seq(1, dim(map)[1], by=1), labels=gsub(".Aligned.sortedByCoord.out.patched.md.bam", "", map$sample), las = 2, cex.axis=0.5)
 legend(100, 1.2e8, legend=c("raw read", "uniq mapped read", "uniq read in non-overlap exon", "not-aligned"), col = c("black", "red", "blue", "green"), lty = 1, cex = 0.8 )

####################genes in V42 but not in v26, expressed in certain tissue, heatmap
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cut -f 1  C-stomach-10samp.raw  | awk 'NR > 1' > temp-1
cut -f 1  P-stomach-10samp.raw  | awk 'NR > 1' > temp-2
cat temp-1 temp-2 | sort | uniq -d > temp-3
cat temp-2 temp-3 | sort | uniq -u > temp-4
    7219 temp-4
vi temp-4
/Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine  temp-4  gencode.v42.primary_assembly.noPar.gene-chr-type-2 out
 paste  temp-4  out | grep -v notApplicable  > temp-5
cut -f 1-2 dir-gtex-website-data/GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct > gencodeV26.id.name

> t1 <- read.delim("temp-5")
 dim(t1)
# [1] 7219    6
t2 <- read.delim("gtex-comb-1103samp.gene.count.txt")
dim(t2)
# [1] 62703  1105
t2 <- t2[, 1:42]
t3 <- merge(t1, t2, by.x="geneID.2", by.y="geneID")
dim(t3)
# [1] 7219   47
 t4 <- read.delim("gencodeV26.id.name")
 t5 <- t3[ t3$name %in% t4$Description,]
 dim(t5)
# [1] 344  47
 t5 <- t3[ !(t3$name %in% t4$Description),]
 dim(t5)
# [1] 6875   47
 dim(t5[ t5$type =="protein_coding", 1:8])
# [1] 802   8
###> write.table(t5[,1:10], "gencode.v42.not.in.v26.6875genes", quote=F, sep="\t")
t5.orig <- t5
......
samp <- read.delim("gtex-htseq.50tiss-10sampPertiss", header=F)
g.n <- raw[, 1:2]
......
###10 samples out of 500 samples
> keep <-rowSums(cpm(y)>=10) >= 10
 y<-y[keep,]
 dim(y)
# [1] 17459   500
d = cpm(y)
a <- d
b = log10(a+1)
b.df <- as.data.frame(b)
 b.filt <- b.df[ rownames(b.df) %in% t5.orig$geneID.2,]
 dim(b.filt)
# [1] 248 500
b.mat <- as.matrix(b.filt)
b.mat.t <- t(b.mat)
t1 <- read.delim("dir-gtex-website-data/sample-tissue.2colum", header=F)
b.mat.t.df <- as.data.frame(b.mat.t)
b.mat.t.df$id <- rownames(b.mat.t.df)
dim(b.mat.t.df)
t1$id2 <- gsub("-", ".", t1$V1)
t1$id <- paste(t1$id2, ".", sep="")
t2 <- merge(b.mat.t.df, t1, by.x="id", by.y="id")
dim(t2)
t3 <- read.delim("dir-gtex-website-data/samp-name-T55", header=F)
head(t3)
#                            V1 V2
#1       Adipose - Subcutaneous T1
#2 Adipose - Visceral (Omentum) T2
#3                Adrenal Gland T3
t4 <- merge(t2, t3, by.x="V2", by.y="V1")
rownames(t4) <- paste( t4$V2.y, gsub("GTEX", "", t4$V1), sep="")
 mat <- as.matrix(t4[, c(3:250)])
rowlabel <- data.frame(t4$V2) 
rowlabel$tissue <- ""
step = 2
rowlabel$tissue[ seq(1, dim(t4)[1], step)] <- t4$V2[ seq(1, dim(t4)[1], step)]
 ca <- HeatmapAnnotation(tissue = t4$V2, which="row", annotation_legend_param = list(grid_height = unit(2, "mm"), grid_width = unit(2, "mm"), labels_gp = gpar(fontsize = 5)))
 col.g <- colnames(mat)

for(i in 1:length(col.g)) {
 col.g[i] <- ""
 }

for(i in seq(1,length(col.g), 1) ) {
 col.g[i] <- g.n[ g.n$geneID == colnames(mat)[i], ][1,2]
 }
for(i in 1:length(col.g)) {
 if(grepl("^ENSG", col.g[i]))
   col.g[i] <- ""
 }


> Heatmap(matrix = mat, show_column_names=T, name="log10(CPM+1)", row_names_gp = gpar(fontsize = 3), right_annotation=ca,  row_labels= rowlabel$tissue, clustering_distance_rows="pearson", clustering_distance_columns="pearson", column_labels=col.g, column_names_gp=gpar(fontsize = 5))

############################################
linyong@fry /lab/solexa_page/linyong/gencode$ cat gencode.v42.primary_assembly.noPar.annotation.gtf | grep -iw "readthrough_gene" | awk '$3 == "gene"' |wc
    651   14656  146561
cat gencode.v42.primary_assembly.noPar.readthrough_gene | cut -f 9 | awk 'BEGIN {FS = ";"} {print $1}' |sed 's/gene_id //' | sed 's/"//g' | sed 's/\.[0-9]*$//' > gencode.v42.primary_assembly.noPar.readthrough_gene.id
cat gencode.v42.primary_assembly.noPar.readthrough_gene | cut -f 9 | awk 'BEGIN {FS = ";"} {print $1}' |sed 's/gene_id //' | sed 's/"//g' > gencode.v42.primary_assembly.noPar.readthrough_gene.id.2

> keep <-rowSums(cpm(y)>=1) >= 10
>  y<-y[keep,]
>  dim(y)
[1] 27501   500
> rt.g <- read.delim("gencode.v42.primary_assembly.noPar.readthrough_gene.id.2", header=F)
> dim(rt.g)
[1] 651 readthrough genes,   1
> temp2 <- y$counts[ rownames(y$counts) %in% rt.g$V1,]
> dim(temp2)
[1]  95 500

########################cpt1b, cpm, F vs. M plot
Heart - Left Ventricle  428samples
> ####median >= 1 for pathway genes
> y<-y[med$logic,]
> print(dim(y))
[1] 13643   428
> summary(y$samples$lib.size)
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max.
 5092064 29668253 34351282 35888494 41328838 79508819  
> summary(y$samples$norm.factors)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.2245  0.8977  1.0726  1.0547  1.2345  2.2914
###############################################################################################
 setwd("/Users/linyongmao/Documents/dir-GTExV8/")
raw <- read.delim("gtex-all-samples.gene.count.txt", header=T)
dim(raw)
t1 <- read.delim("dir-gtex-website-data/sample-tissue.2colum", header=F)
file <- read.delim("gtex-54tiss.txt", header=F)
index = 33
tissue = file[index,1]
 t2 <- t1[ t1$V2 == tissue, ]
 t2$id <- gsub("-", ".", t2$V1)
 t2$id <- paste(t2$id, ".", sep="")
 raw2 <- raw[, colnames(raw) %in% t2$id ]
 str1 <- paste(tissue, dim(raw2)[2], sep="\t")
 cat(str1)
 cat("\n")
 rownames(raw2) <- raw$geneID
y <- DGEList(counts=raw2)
y <- calcNormFactors(y)
med <- data.frame(y$counts[,1])
med$logic <- TRUE
d <- cpm(y)
for(i in 1:dim(y)[1]) {
 med$logic[i] <- median(d[i,]) >= 1
}
####median >= 1 for pathway genes
y<-y[med$logic,]
print(dim(y))
# [1] 13643   428
d = edgeR::cpm(y)
 a <- d
 gene.name <- raw[, 1:2]
 a.df <- as.data.frame(a)
 a.df$id <- row.names(a.df)
 a.df.g <- merge(a.df, gene.name, by.x="id", by.y="geneID")
 dim(a.df.g)
# [1] 13643   430
 cpt <- a.df.g[ a.df.g$name == "CPT1B",]
 rownames(cpt) <- cpt$name
 cpt.2 <- as.matrix(cpt[, 2:(dim(y)[2]+1)])
 cpt.3 <- as.data.frame( t(cpt.2))
 dim(cpt.3)
# [1] 428   1
 cpt.3$sid <- rownames(cpt.3)
 info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
 info$sid <-  gsub("-", ".", info$SAMPID)
 info$sid <-  paste( info$sid, ".", sep="")
 cpt.7 <- merge(cpt.3, info, by.x="sid", by.y="sid")
 dim(cpt.7)
# [1] 428   8
 cpt.f <- cpt.7[ cpt.7$SEX == 2, ]
 cpt.m <- cpt.7[ cpt.7$SEX == 1, ] 
 t.test(cpt.f$CPT1B, cpt.m$CPT1B)
 t.test(log10(cpt.f$CPT1B + 1), log10(cpt.m$CPT1B+1))
dim(cpt.f)
dim(cpt.m)
 cpt.7$SEX <- factor(cpt.7$SEX, levels=c(2,1), labels=c("F", "M"))
 vioplot(cpt.7$CPT1B ~ cpt.7$SEX, xlab="", ylab="P-star-htseq CPT1B gene, CPM", col="white" )
 abline(h = seq(-100,100,0.2), lty = 5, lwd = 0.5, col = "gray")

########################cpt1b, cpm, F vs. M plot
Heart - Left Ventricle	432 samples (GTEx_Analysis_2017-06-05_v8_RNASeQCv1.1.9_gene_reads.gct)
>  t2$id <- gsub("-", ".", t2$V1)
  raw2 <- raw[, colnames(raw) %in% t2$id ]
  str1 <- paste(tissue, dim(raw2)[2], sep="\t")
  cat(str1)
# Heart - Left Ventricle	432
  cat("\n")
 rownames(raw2) <- raw$Name
y <- DGEList(counts=raw2)
y <- calcNormFactors(y)
med <- data.frame(y$counts[,1])
med$logic <- TRUE
d <- cpm(y)
for(i in 1:dim(y)[1]) {
 med$logic[i] <- median(d[i,]) >= 1
}
####median >= 1 for pathway genes
y<-y[med$logic,]
print(dim(y))
# [1] 13615   432
> summary(y$samples$lib.size)
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
 10186939  56820733  66039240  69412333  79500352 162805706 
> summary(y$samples$norm.factors)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.2594  0.9297  1.0752  1.0404  1.1934  2.1442 
######
 d = edgeR::cpm(y)
 a <- d
 gene.name <- raw[, 1:2]
 a.df <- as.data.frame(a)
 a.df$id <- row.names(a.df)
 a.df.g <- merge(a.df, gene.name, by.x="id", by.y="Name")
 dim(a.df.g)
# [1] 13615   434
 cpt <- a.df.g[ a.df.g$Description == "CPT1B",]
 dim(cpt)
# [1]   1 434
 rownames(cpt) <- cpt$Description
 cpt.2 <- as.matrix(cpt[, 2:(dim(y)[2]+1)])
 dim(cpt.2)
# [1]   1 432
 cpt.3 <- as.data.frame( t(cpt.2))
 cpt.3$sid <- rownames(cpt.3)
 info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
 info$sid <-  gsub("-", ".", info$SAMPID)
 cpt.7 <- merge(cpt.3, info, by.x="sid", by.y="sid")
 dim(cpt.7)
# [1] 432   8
 cpt.f <- cpt.7[ cpt.7$SEX == 2, ]
 cpt.m <- cpt.7[ cpt.7$SEX == 1, ] 
 t.test(cpt.f$CPT1B, cpt.m$CPT1B)
 t.test(log10(cpt.f$CPT1B + 1), log10(cpt.m$CPT1B+1))
 dim(cpt.f)
# [1] 138   8
 dim(cpt.m)
# [1] 294   8
 cpt.7$SEX <- factor(cpt.7$SEX, levels=c(2,1), labels=c("F", "M"))
 vioplot(cpt.7$CPT1B ~ cpt.7$SEX, xlab="", ylab="Consortium CPT1B gene, CPM", col="white" )
 abline(h = seq(-100,1000,20), lty = 5, lwd = 0.5, col = "gray")

########################DEGs, plab-star-htseq-gene-count
> y.cn <- colnames(y)
 info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
 info$sid <-  gsub("-", ".", info$SAMPID)
 info$sid <-  paste( info$sid, ".", sep="")
 info.2 <- head(info, n= dim(y)[2])
for(i in 1:dim(y)[2]) {
 t1 <- info[ info$sid == y.cn[i],]
 info.2[i,] <- t1[1,]
 }
 design <- model.matrix( ~ info.2$SEX)
y <- estimateDisp(y,design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, coef=2)
top2v1 <- topTags(qlf, n = 91234)
write.table(top2v1, "diff2-1.txt", sep="\t", quote = F)
diff <- as.data.frame(top2v1)
diff$geneID <- rownames(diff)
gene.name <- raw[, 1:2]
df.gene <- merge(diff, gene.name, by.x="geneID", by.y="geneID")
chr <- read.delim("../autism/gencode.v42.primary_assembly.noPar.gene-chr-type")
df.cpm.gene <- merge(df.gene, chr, by.x="geneID", by.y="geneID")
write.table(df.cpm.gene, "diff2-1.txt", sep="\t", quote = F)
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % mv -i  diff2-1.txt diff2-1-left-ventricle-FvsM.txt
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % mv -i diff2-1.txt diff2-1-left-ventricle-FvsM.consortium.txt

head -1 diff2-1-left-ventricle-FvsM.consortium.txt > temp.txt
for g in `echo KDM6A    KDM5C   SMC1A   ZFX     RBBP7   DDX3X   CDK16   DLG3    USP9X   BCOR    UTY     ZFY     XIST    GLA     TIMP1   SAT1    MPP1`
do
 grep -iw $g   diff2-1-left-ventricle-FvsM.consortium.txt
done >> temp.txt
grep -iw cpt1b  diff2-1-left-ventricle-FvsM.consortium.txt >> temp.txt

######################## map-stat-17350.samples.txt 
linyong@fry /lab/solexa_page/linyong$ vi scr-map-stat
linyong@fry /lab/solexa_page/linyong$ cat scr-map-stat
#
ls | grep ^dir-gtex- | while read dir
do
 cd "$dir"
 bash /lab/solexa_page/linyong/script-get-feature-count-02
 cd ..
done
linyong@fry /lab/solexa_page/linyong$ bash scr-map-stat > temp.map-stat.txt
linyong@fry /lab/page_human_data/linyong2$ cat /lab/solexa_page/linyong/temp.map-stat.txt temp.map-stat.txt > temp.txt
linyong@fry /lab/page_human_data/linyong2$ cat /lab/solexa_page/linyong/temp.map-stat.txt temp.map-stat.txt | awk 'NF < 8'
error   error   error   error   error   error   error
-1      -1      -1      -1      -1      -1      -1
error   error   error   error   error   error   error
-1      -1      -1      -1      -1      -1      -1
GTEX-1JJ6O-1426-SM-CY8HT.Aligned.sortedByCoord.out.patched.md.bam       38864534        36606739        29299051        3725025 3582663 0
GTEX-RWS6-1726-SM-47JXP.Aligned.sortedByCoord.out.patched.md.bam        31109583        29219570        23628865        2781298 2809407 0
GTEX-ZAJG-0826-SM-5PNVA.Aligned.sortedByCoord.out.patched.md.bam        35636636        33532458        27947981        1859792 3724685 0
GTEX-ZAK1-0626-SM-5HL8E.Aligned.sortedByCoord.out.patched.md.bam        36727552        34311212        27704975        3623170 2983067 0
GTEX-ZQG8-0926-SM-57WFF.Aligned.sortedByCoord.out.patched.md.bam        42416175        39816623        31588270        4595606 3632747 0
GTEX-ZVZP-0726-SM-59HKA.Aligned.sortedByCoord.out.patched.md.bam        32968593        30500272        24463767        3039866 2996639 0

##############modified script-get-feature-count-02, run again,
feature inputreads      Uniqreads       lib.size        no_feature      ambiguous       too_low_aQual   not_aligned     alignment_not_unique
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat  map-stat-17350.samples.txt | awk '$2 - $3 - $9 - $8 - $7 == 0' | wc -l
   17351
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat  map-stat-17350.samples.txt | awk ' $3 - $4 - $5 - $6 == 0' | wc -l
   17351
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat  map-stat-17350.samples.txt | cut -f 7 | uniq -c  
   1 too_low_aQual
17350 0

#############################################################################
> ms <- read.delim("map-stat-17350.samples.txt")
 ms.1 <- ms[, c(2:4)]
 colnames(ms.1) <- c("raw reads", "uniq reads", "lib.size")
 vioplot(ms.1/1e6, ylim=c(0, 150), ylab="million read pairs")
 abline(h = seq(-100,1000,10), lty = 5, lwd = 0.5, col = "gray")
 dim(ms.1)
# [1] 17350     3
 ms.2 <- data.frame( ms$feature)
 ms.2[,1] <- ms$Uniqreads / ms$inputreads
 ms.2[,2] <-  ms$lib.size / ms$Uniqreads 
 ms.2[,3] <-  ms$ambiguous / ms$Uniqreads
 ms.2[,4] <-  ms$no_feature / ms$Uniqreads
 colnames(ms.2) <- c("uniq / raw", "lib.size / uniq", "ambiguous / uniq", "no_feature / uniq")
 vioplot(ms.2)
 abline(h = seq(-100,1000,0.1), lty = 5, lwd = 0.5, col = "gray")

##########################"gtex-htseq.50tiss-10sampPertiss"
> keep <-rowSums(cpm(y)>=1) >= 10
>  y<-y[keep,]
>  dim(y)
[1] 27501   500
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat "gencode.v42.not.in.v26.6875genes" | head -1 > temp
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat "gencode.v42.not.in.v26.6875genes" | grep -w protein_coding | awk '$8 ~ /-/' >> temp ####possible read through genes
> temp <- read.delim("temp")
> dim(temp)
[1] 115  11
> dim(y)
[1] 27501   500
>  b.filt <- b.df[ rownames(b.df) %in% temp$geneID.2,]
>  dim(b.filt)
[1]  22 out of 115 possible read through genes, 500
......
> dim(t4)
[1] 500  27
> write.table(t4, "temp-2", sep="\t", quote=F)

 a <- boxplot(t5$cpm ~ t5$t4.V2,  xlab="", ylab="P-star-htseq CHKB-CPT1B, CPM", xaxt= "n")
  len <- length(unique(t5$t4.V2))
 axis(1, at = seq(1, len, by = 1), labels=substr( a$names, 1, 32), las=2, cex.axis=0.3)
 abline(h = seq(0,100,0.2), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % for g in `cat temp-2 | head -1 | cut -f 3-117`
do
 grep -w "$g" "gencode.v42.not.in.v26.6875genes" | head -1
done

#############################################################################
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 %  cat   gencode.v26.primary_assembly.annotation.gtf    | awk 'BEGIN {FS = "\t"; OFS = "\t";} NF > 6 && $3 == "gene"' > temp-gene
   58278 temp-gene
cut -f 9  temp-gene |  awk 'BEGIN {FS = "\;"} {print $1}' | sed 's/gene_id //' | sed 's/"//g' |sort | uniq > temp-gene-2
cat gencodeV26.id.name | cut -f 1 |awk 'NR > 1' |sort | uniq > temp-const-gene
cat temp-gene-2 temp-const-gene | sort | uniq -d | wc -l
   56200
   58278 temp-gene-2
   56200 temp-const-gene
######removed 2078 genes in consortium gene-count file
cat temp-gene-2 temp-const-gene | sort | uniq -u > temp-u
cat   gencode.v26.primary_assembly.annotation.gtf    | awk 'BEGIN {FS = "\t"; OFS = "\t";} NF > 6 && $3 == "transcript" ' > temp-transc
  199391 temp-transc

#######################################age_value, body_mass_index
linyong@fry ~$ /home/linyong/.local/bin/pfb to -i    "export_2023-09-18T20 27 57.avro" tsv
Creating ./tsvs/program.tsv
Creating ./tsvs/project.tsv
Creating ./tsvs/subject.tsv
Creating ./tsvs/reference_file.tsv
Creating ./tsvs/sample.tsv
Creating ./tsvs/sequencing.tsv
Done, created 7 files under: ./tsvs/

linyong@fry /lab/solexa_page/linyong$ mv -i  tsvs gtex-981subjects-tsvs

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat gtex-981subjects-tsvs/subject.tsv | cut -f 46,148,224 | head -20

source_subject_id       participant_id  submitter_id
GTEX-YB5E       GTEX-YB5E       GTEX-YB5E
GTEX-14A6H      GTEX-14A6H      GTEX-14A6H
GTEX-14PHW      GTEX-14PHW      GTEX-14PHW
cat gtex-981subjects-tsvs/subject.tsv | cut -f 46,148,224 | awk '$1 == $2' | wc -l
     981
cat gtex-981subjects-tsvs/subject.tsv | cut -f 46,148,224 | awk '$1 == $3' | wc -l
     981
cat gtex-981subjects-tsvs/subject.tsv | cut -f 46 | sort | uniq -d | wc
       0       0       0
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat gtex-981subjects-tsvs/subject.tsv | head -1 | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print i, $i}'
16      age_value
31      body_mass_index
46      source_subject_id
106     height

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat  "dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt" | wc -l
   22952

SUBJID  SAMPID  SUBJID  SEX     AGE     DTHHRDY
GTEX-1117F      GTEX-1117F-0003-SM-58Q7G        GTEX-1117F      2       60-69   4
GTEX-1117F      GTEX-1117F-0003-SM-5DWSB        GTEX-1117F      2       60-69   4
GTEX-1117F      GTEX-1117F-0003-SM-6WBT7        GTEX-1117F      2       60-69   4

cat  "dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt" | awk 'BEGIN {FS = "\t"} $1 == $3' | wc -l
   22952
cat  "dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt" | cut -f 1,5 | sort | uniq | wc -l
     981
cat  "dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt" | cut -f 1 | sort | uniq | wc -l
     981

> info2 <- read.delim("gtex-981subjects-tsvs/subject.tsv")
 info3 <- info2[, c(16,31,46, 106)]
 summary(info3)
 cpt.9 <- merge(cpt.7, info3, by.x="SUBJID", by.y="source_subject_id")
 dim(cpt.9)
# [1] 428  12
 vioplot(cpt.9$age_value ~ cpt.9$SEX, xlab="", ylab="age", col="white" )
 abline(h = seq(-100,100,2), lty = 5, lwd = 0.5, col = "gray")
 cpt.f <- cpt.9[ cpt.9$SEX == "F", ]
 cpt.m <- cpt.9[ cpt.9$SEX == "M", ]
 t.test(cpt.f$age_value, cpt.m$age_value)
 wilcox.test(cpt.f$age_value, cpt.m$age_value)
 
#######################################
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat diff2-1-left-ventricle-FvsM.txt | awk 'BEGIN {FS = "\t"} !($8 == "chrX" || $8 == "chrY")' > diff2-1-left-ventricle-FvsM.noX.Y.txt
cat   diff2-1-left-ventricle-FvsM.noX.Y.txt | awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""}
{for(i = 1; i <= 7; i++)
   print $i "\t";

 print $7 "\n";
}' > temp
../microglia/make-rnk-genesymble  temp   diff2-1-left-ventricle-FvsM.noX.Y.rnk  
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat /Users/linyongmao/Documents/h.all.v7.4.symbols.gmt > fao.gmt

bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx    fao.gmt    -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk  diff2-1-left-ventricle-FvsM.noX.Y.rnk -scoring_scheme classic(p=0)  -rpt_label   "left-ventricle-FvsM.noX.Y-weight0-FAO"  -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

> rnk <- read.delim("diff2-1-left-ventricle-FvsM.noX.Y.rnk", header=F)
 ll <- list()
 ll[[1]] <- rnk$V2
 fao <- scan(what="", sep = "\n")
 ll[[2]] <- rnk[ rnk$V1 %in% fao, 2]
 names(ll) <- c("genomic bg", "FAO genes")
 vioplot(ll, col="white")
 abline(h = seq(-100,1000,1), lty = 5, lwd = 0.5, col = "gray")
 abline(h = 0, col="blue")

#############################################################################
> deg <- read.delim("diff2-1-left-ventricle-FvsM.txt")
 layout(matrix(1:8, 2, 4, byrow=T) )
for(index in 1:length(fao)) {
# index = 1
# fao sorted on p-value (F or M biased)
 pval <- deg[ deg$name == fao[index],][1,5]
 ratio <- 2^(deg[ deg$name == fao[index],][1,2])
 if(ratio >= 1) {
 str <- paste(fao[index], ", p-value=", format(pval, digits=3), "\n F/M =", round(ratio, digits = 3), sep="")
cpt <- a.df.g[ a.df.g$name == fao[index],]
 rownames(cpt) <- cpt$name
 cpt.2 <- as.matrix(cpt[, 2:429])
 cpt.3 <- as.data.frame( t(cpt.2))
 dim(cpt.3)
# [1] 428   1
 cpt.3$sid <- rownames(cpt.3)
 info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
 info$sid <-  gsub("-", ".", info$SAMPID)
 info$sid <-  paste( info$sid, ".", sep="")
 cpt.7 <- merge(cpt.3, info, by.x="sid", by.y="sid")
 dim(cpt.7)
# [1] 428   8
 cpt.f <- cpt.7[ cpt.7$SEX == 2, ]
 cpt.m <- cpt.7[ cpt.7$SEX == 1, ]
dim(cpt.f)
dim(cpt.m)
 cpt.7$SEX <- factor(cpt.7$SEX, levels=c(2,1), labels=c("F", "M"))
 vioplot(cpt.7[,2] ~ cpt.7$SEX, xlab="", ylab="P-star-htseq  CPM", col=c("white", "gray") )
 title(main = str, cex.main = 1)
# abline(h = seq(-100,100,0.2), lty = 5, lwd = 0.5, col = "gray")
}
}

#############################################################################
############################gencode.v42.primary_assembly.noPar.protein coding genes (no readthrough_gene) + xist .gtf
linyong@fry /lab/solexa_page/linyong$ cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | awk 'BEGIN {FS = "\t"; OFS = "\t";} $3 == "gene" {print $1, $4, $5, $9} ' > temp
vi temp
cp temp temp2
bedtools intersect -wa -wb -a temp -b temp2 -sorted  > temp-temp2
cat temp-temp2 | awk '$4 != $8' | cut -f 4 | sort | uniq | wc -l
40391 genes, each overlaps some other gene(s) to some extent

cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | awk 'BEGIN {FS = "\t"; OFS = "\t";} $3 == "gene" ' | grep  protein_coding |grep -v "readthrough_gene" > temp
cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | awk 'BEGIN {FS = "\t"; OFS = "\t";} $3 == "gene" ' | grep -i xist >> temp
cat temp  | awk 'BEGIN {FS = "\t"; OFS = "\t";} $3 == "gene" {print $1, $4, $5, $9} ' > temp1
vi temp1
cp temp1 temp2
wc -l temp1 temp2
  19386 temp1
  19386 temp2

bedtools intersect -wa -wb -a temp1 -b temp2 > temp-temp2
cat temp-temp2 | awk '$4 != $8' | cut -f 4 | sort | uniq | wc -l
5295 genes, each overlaps some other protein_coding gene(s) to some extent
cat temp-temp2 | awk '$4 != $8' | cut -f 4 | sort | uniq -c | awk '$1 == 1' | wc -l
4443

gene_id "ENSG00000244731.10"; gene_type "protein_coding"; gene_name "C4A"
cat temp-temp2 | grep "ENSG00000244731.10"
chr6    31982057        32002681        ENSG00000244731.10      chr6    31982057        32002681        ENSG00000244731.10

gene_id "ENSG00000224389.9"; gene_type "protein_coding"; gene_name "C4B"
cat temp-temp2 | grep "ENSG00000224389.9"
chr6    32014795        32035418        ENSG00000224389.9       chr6    32014795        32035418        ENSG00000224389.9

gene_id "ENSG00000125730.18"; gene_type "protein_coding"; gene_name "C3"; 
cat temp-temp2 | grep "ENSG00000125730.18" | awk '$4 != $8'
chr19   6677704 6730562 ENSG00000125730.18      chr19   6729914 6737580 ENSG00000125734.16 (GPR108; G protein-coupled receptor 108)


cat temp1 |  awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""}
 {
     print $1 "\t" "macs2" "\t" "peak" "\t"  $2 "\t" $3 "\t" "." "\t" "+"  "\t" "."  "\t" "peak_id=\"" $4  "\"" "\n";
 }' > gencode.v42.primary_assembly.noPar.protein.xist.gtf

wc -l gencode.v42.primary_assembly.noPar.protein.xist.gtf
19386 gencode.v42.primary_assembly.noPar.protein.xist.gtf

#############################################################################
############################GTEx v8 PE mapping statistics
linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools view GTEX-11GSO-0003-SM-6WBTR.cram | awk '$3 ==  "chrX"' |  awk 'BEGIN {FS = "\t";} !($2 != 99 && $2 != 147 && $2 != 83 && $2 != 163) && $5 >= 20'  > temp-chrx.sam &

linyong@fry /lab/solexa_page/linyong/gtex-dna$ cat temp-chrx.sam | wc -l
14,658,190

cat temp-chrx.sam | cut -f 5 | sort | uniq -c | sort -g | tail -n 6
  23384 47
  58775 48
  62247 27
  91601 55
 199219 40
13,946,927 60 mapQ

linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools view GTEX-11GSO-0003-SM-6WBTR.cram | awk '$3 ==  "chr1"' |  awk 'BEGIN {FS = "\t";} !($2 != 99 && $2 != 147 && $2 != 83 && $2 != 163) && $5 >= 60'  | head -2000000 | cut -f 5 | uniq -c
2000000 60 mapQ

linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools view GTEX-11GSO-0003-SM-6WBTR.cram | awk '$3 ==  "chr1"' |  awk 'BEGIN {FS = "\t";} !($2 != 99 && $2 != 147 && $2 != 83 && $2 != 163) && $5 >= 60'  | head -200000 | cut -f 6 | sort | uniq -c | awk '$1 >= 160'
    177 138M13S
    255 146M5S
    180 147M4S
    165 148M3S
    595 149M2S
 181929 151M
    556 2S149M
    169 3S148M
    223 4S147M
    265 5S146M

linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools view GTEX-11GSO-0003-SM-6WBTR.cram | awk '$3 ==  "chr1"' |  awk 'BEGIN {FS = "\t";} !($2 != 99 && $2 != 147 && $2 != 83 && $2 != 163) && $5 >= 60'  | head -200000 | cut -f 9 | sort | uniq -c | sort -g | tail -n 6
   2043 -412
   2047 -409
   2059 407 bp library insert size
   2061 409
   2070 412
   2077 -407

###################################################RP with soft clip
###################################################single read in a pair, how does htseq count
linyong@fry /lab/solexa_page/linyong/gtex-dna$ cat temp-chrx.sam | awk 'BEGIN {FS = "\t";} $6 ~ /^[0-9]*M[0-9][0-9][0-9]*S$/' > temp.sam
cat temp-chrx.sam | awk 'BEGIN {FS = "\t";} $6 ~ /^[0-9][0-9][0-9]*S[0-9]*M$/' >> temp.sam
sort  temp.sam > temp.2.sam
rm -f temp.sam 
cat temp.2.sam  | awk 'BEGIN {FS = "\t";} $5 >= 60' > temp.3.sam
rm -f temp.2.sam 

samtools view GTEX-11GSO-0003-SM-6WBTR.cram -H > temp.4.sam
cat temp.3.sam >> temp.4.sam
linyong@fry /lab/solexa_page/linyong/gtex-dna$ htseq-count  --mode=intersection-strict  --nonunique=none  --stranded=no --idattr=peak_id  --format=sam  --order=name --type=peak temp.4.sam  /lab/solexa_page/linyong/gencode.v42.primary_assembly.noPar.protein.xist.gtf > temp.10S10M.readcount

19386 GFF lines processed.
Warning: Read H03CRALXX140919:7:1101:10064:21667 claims to have an aligned mate which could not be found in an adjacent line.
400000 alignment record pairs processed.
Warning: 392800 reads with missing mate encountered.
445395 alignment record pairs processed.
linyong@fry /lab/solexa_page/linyong/gtex-dna$ cat temp.3.sam | cut -f 1 | uniq | wc -l
445395
gene_id: ENSG00000229807.13 xist
linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools view GTEX-11GSO-0003-SM-6WBTR.cram -H > temp.4.sam
linyong@fry /lab/solexa_page/linyong/gtex-dna$ cat  temp.3.sam | awk 'BEGIN {FS = "\t";} $4 > 32097677 && $4 < 32339609' >> temp.4.sam
linyong@fry /lab/solexa_page/linyong/gtex-dna$ cat  temp.3.sam | awk 'BEGIN {FS = "\t";} $4 > 32097677 && $4 < 32339609' | cut -f 1 | uniq | wc -l
548

rm -f temp.4.sam
samtools view GTEX-11GSO-0003-SM-6WBTR.cram -H > temp.4.sam
 cat  temp.3.sam | awk 'BEGIN {FS = "\t";} $4 > 32097677 && $4 < 32339609' | head -50 >> temp.4.sam
htseq-count  --mode=intersection-strict  --nonunique=none  --stranded=no --idattr=peak_id  --format=sam  --order=name --type=peak temp.4.sam  /lab/solexa_page/linyong/gencode.v42.primary_assembly.noPar.protein.xist.gtf > temp.10S10M.readcount
tail temp.10S10M.readcount
grep ENSG00000198947.18 temp.10S10M.readcount

__not_aligned:
-------------
H03CRALXX140919:7:1101:19554:49742	163	chrX	32192809	60	138M13S	=	32193073	415
H03CRALXX140919:7:1101:20061:6073	163	chrX	32134012	60	127M24S	=	32134273	412
H03CRALXX140919:7:1101:2055:46965	163	chrX	32333145	60	93M58S	=	32333145	93
H03CRALXX140919:7:1102:18742:37753	147	chrX	32327268	60	26S125M	=	32327268	-125
H03CRALXX140919:7:1102:20924:58410	147	chrX	32268664	60	22S129M	=	32268666	-127
H03CRALXX140919:7:1103:15057:40900	163	chrX	32133806	60	126M25S	=	32134087	432


ENSG00000198947.18	1
-------------------------
H03CRALXX140919:7:1101:2055:46965	83	chrX	32333145	60	58S93M	=	32333145	-93
H03CRALXX140919:7:1101:8003:23020	99	chrX	32099827	60	136M15S	=	32100096	420
H03CRALXX140919:7:1102:18742:37753	99	chrX	32327268	60	125M26S	=	32327268	125
H03CRALXX140919:7:1102:20924:58410	99	chrX	32268666	60	127M24S	=	32268664	127

cat temp-chrx.sam | awk 'BEGIN {FS = "\t";} $5 >= 60 && $6 ~/^[0-9]*M[0-9][0-9]D[0-9]*M$/' | sort 
/^[0-9]*M[0-9][0-9]I[0-9]*M$/  
86M10D65M
124M10I17M
those reads with middle indel can be counted for (assigned to)  a gene

###########################################################################set lib.size as user defined

# ------------------------------------
raw <- data.frame(a = rep(1, 10), b = c(1,1,1,1,1,1,1,1,1,100))
raw
y <- DGEList(counts=raw, lib.size=c(100, 200))
y
y <- calcNormFactors(y)
y

# An object of class "DGEList"
# $counts
#    a   b   
# 1  1   1   
# 2  1   1   
# 3  1   1   
# 4  1   1   
# 5  1   1   
# 6  1   1   
# 7  1   1   
# 8  1   1   
# 9  1   1   
# 10 1 100 
# 
# $samples
#   group lib.size norm.factors
# a     1      100    1.4142136
# b     1      200    0.7071068

edgeR::cpm(y)

################################################################
cram="GTEX-11GSO-0003-SM-6WBTR.cram"
f=`echo "$cram" | sed 's/.cram$//' `
samtools view "$cram" |  awk 'BEGIN {FS = "\t";} !($2 != 99 && $2 != 147 && $2 != 83 && $2 != 163) && $5 >= 60' | head -212345 > "$f".1.sam

15806 ENSG00000188157.15 5396
15832 ENSG00000188290.11   79

19387           __no_feature 41832
19388            __ambiguous   144
19389        __too_low_aQual     0
19390          __not_aligned     0
19391 __alignment_not_unique     0
19392               total.RP 99433

#############################################################################
############################filtering gtf file based gene types and transcript types
linyong@fry /lab/solexa_page/linyong$ cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | grep -iw ddx3x | awk '$3 == "transcript"' | grep -o "transcript_type.\{30\}" | sort| uniq -c
     14 transcript_type "nonsense_mediated_decay"; tr
      3 transcript_type "protein_coding_CDS_not_defin
     23 transcript_type "protein_coding"; transcript_
     29 transcript_type "retained_intron"; transcript

cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | grep -iw ddx3x | awk '$3 == "transcript"' | grep "transcript_type \"protein_coding\";"
chrX	HAVANA	gene	41333348	41364472	.	+	.	gene_id "ENSG00000215301.11"; gene_type "protein_coding"; gene_name "DDX3X"; level 2; hgnc_id "HGNC:2745"; havana_gene "OTTHUMG00000021369.22";

chrX	HAVANA	transcript	41333348	41350287	.	+	.	gene_id "ENSG00000215301.11"; transcript_id "ENST00000629496.3"; gene_type "protein_coding"; gene_name "DDX3X"; transcript_type "protein_coding"; transcript_name "DDX3X-217"; level 2; protein_id "ENSP00000487224.1"; transcript_support_level "5"; hgnc_id "HGNC:2745"; tag "alternative_5_UTR"; tag "non_submitted_evidence"; tag "basic"; tag "appris_principal_4"; tag "CCDS"; ccdsid "CCDS43931.1"; havana_gene "OTTHUMG00000021369.22"; havana_transcript "OTTHUMT00000481647.3";

chrX	HAVANA	exon	41333348	41333699	.	+	.	gene_id "ENSG00000215301.11"; transcript_id "ENST00000629496.3"; gene_type "protein_coding"; gene_name "DDX3X"; transcript_type "protein_coding"; transcript_name "DDX3X-217"; exon_number 1; exon_id "ENSE00003771363.1"; level 2; protein_id "ENSP00000487224.1"; transcript_support_level "5"; hgnc_id "HGNC:2745"; tag "alternative_5_UTR"; tag "non_submitted_evidence"; tag "basic"; tag "appris_principal_4"; tag "CCDS"; ccdsid "CCDS43931.1"; havana_gene "OTTHUMG00000021369.22"; havana_transcript "OTTHUMT00000481647.3";

chrX	HAVANA	UTR	41347717	41350287	.	+	.	gene_id "ENSG00000215301.11"; transcript_id "ENST00000629496.3"; gene_type "protein_coding"; gene_name "DDX3X"; transcript_type "protein_coding"; transcript_name "DDX3X-217"; exon_number 18; exon_id "ENSE00003830364.1"; level 2; protein_id "ENSP00000487224.1"; transcript_support_level "5"; hgnc_id "HGNC:2745"; tag "alternative_5_UTR"; tag "non_submitted_evidence"; tag "basic"; tag "appris_principal_4"; tag "CCDS"; ccdsid "CCDS43931.1"; havana_gene "OTTHUMG00000021369.22"; havana_transcript "OTTHUMT00000481647.3";

chrX	HAVANA	CDS	41341484	41341616	.	+	2	gene_id "ENSG00000215301.11"; transcript_id "ENST00000629496.3"; gene_type "protein_coding"; gene_name "DDX3X"; transcript_type "protein_coding"; transcript_name "DDX3X-217"; exon_number 5; exon_id "ENSE00003572608.1"; level 2; protein_id "ENSP00000487224.1"; transcript_support_level "5"; hgnc_id "HGNC:2745"; tag "alternative_5_UTR"; tag "non_submitted_evidence"; tag "basic"; tag "appris_principal_4"; tag "CCDS"; ccdsid "CCDS43931.1"; havana_gene "OTTHUMG00000021369.22"; havana_transcript "OTTHUMT00000481647.3";

linyong@fry /lab/solexa_page/linyong$ cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | grep  "gene_id.*gene_id" | wc
      0       0       0
cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | grep  "transcript_id.*transcript_id" | wc
      0       0       0
linyong@fry /lab/solexa_page/linyong$ cat gencode.v42.primary_assembly.noPar.protein.xist.gtf | cut -f 9 | sed 's/peak_id=/     gene_id /' > temp-gene-ids-131pm

linyong@fry /lab/solexa_page/linyong$ cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | awk '$3 == "transcript"' | grep "transcript_type \"protein_coding\";"  | cut -f 9 | awk 'BEGIN {FS = ";"} {print $2}'  > temp-transcriptid-140pm

geneID-input-file 'gene_id "ENSG00000215301.11"'      protein coding genes, xist
transcript-ip-file 'transcript_id "ENST00000629496.3"'       transcript_type "protein_coding"; 

if field #3 is a gene, then gene_id xxxxxx contained in the geneID-input-file
else
  gene_id in the file && transcript_id in second file 

---------------------------
linyong@fry /lab/solexa_page/linyong$ cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | grep "gene_id \"ENSG000002298
07.13\";" | awk '$3 == "transcript"' | grep  "transcript_type \"lncRNA\"" | cut -f 9 | awk 'BEGIN {FS = ";"} {print $2}'  >> temp-transcriptid-140pm
linyong@fry /lab/solexa_page/linyong$ /lab/solexa_page/linyong/gtex-dna/process-gtf-1  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf  temp-gene-ids-131pm temp-transcriptid-140pm out
wc -l out
2094614 out
sort gencode/gencode.v42.primary_assembly.noPar.annotation.gtf  out | uniq -d | wc -l
2094614
cat  gencode/gencode.v42.primary_assembly.noPar.annotation.gtf | grep -iw ddx3x | awk '$3 != "transcript"' | grep -o "transcript_type.\{30\}" | sort| uniq -c
    463 transcript_type "nonsense_mediated_decay"; tr
     14 transcript_type "protein_coding_CDS_not_defin
    766 transcript_type "protein_coding"; transcript_
    298 transcript_type "retained_intron"; transcript
cat out | grep -iw ddx3x | awk '$3 != "transcript"' | grep -o "transcript_type.\{30\}" | sort| uniq -c
    766 transcript_type "protein_coding"; transcript_
cat out | grep -iw xist | awk '$3 != "transcript"' |  head
chrX    HAVANA  exon    73841382        73843533        .       -       .       gene_id "ENSG00000229807.13"; transcript_id "ENST00000669898.1"; gene_type "lncRNA"; gene_name "XIST"; transcript_type "lncRNA"; transcript_name "XIST-230"; exon_number 1; exon_id "ENSE00003871931.1"; level 2; hgnc_id "HGNC:12810"; tag "TAGENE"; havana_gene "OTTHUMG00000021839.13"; havana_transcript "OTTHUMT00000517260.2";

cat out | grep -i "readthrough" | wc
    319
cat out | grep -i "stop_codon_readthrough" | wc
    319
linyong@fry /lab/solexa_page/linyong$ mv -i out  gencode.v42.primary_assembly.noPar.protein.xist.exons.gtf

############################
> t1 <- read.delim("out-GTEX-OIZI-1026-SM-CLTGE.strictmode.nonuniq.geneintv.readcount", header=F)
 t2 <- read.delim("gencode.v42.primary_assembly.noPar.protein.xist.gtf", header=F)
 t2$V10 <- gsub("peak_id=", "", t2$V9)
 t3 <- merge(t1, t2, by.x="V1", by.y="V10")
 dim(t3)
# [1] 19386    11
 t3$geneL <- t3$V5 - t3$V4 + 1

> dim(t3[ t3$V2.x == 0,])
[1] 371  12
> res <- lm(t3$V2.x ~ t3$geneL)
> summary(res)

Call:
lm(formula = t3$V2.x ~ t3$geneL)

Residuals:
    Min      1Q  Median      3Q     Max
-155690    -719     777    1415   65929

Coefficients:
              Estimate Std. Error t value Pr(>|t|)
(Intercept) -1.609e+03  3.805e+01  -42.29   <2e-16 ***
t3$geneL     1.541e-01  2.535e-04  607.92   <2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 4716 on 19384 degrees of freedom
Multiple R-squared:  0.9502,    Adjusted R-squared:  0.9502
F-statistic: 3.696e+05 on 1 and 19384 DF,  p-value: < 2.2e-16

 plot(t3$geneL, t3$V2.x, xlab="gene L (bp)", ylab="gene interval RP count")
 abline(lm(t3$V2.x ~ t3$geneL), lwd = 1, col="blue")
 abline(h = seq(0, 10e5, 1e5), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(0, 2e7, 5e5), lty = 5, lwd = 0.5, col = "gray")
> summary(t3$V2.x * 301/ t3$geneL)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
   0.00   25.10   31.26   34.36   39.97 8414.38
> t6 <- t3[  t3$V2.x > 100,]
> summary(t6$V2.x * 301/ t6$geneL)
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
   0.327   26.058   32.007   35.958   40.650 8414.379 
sex == 1, male
> t6 <- t3[ t3$V1.y == "chrX" & t3$V2.x > 100,]
> summary(t6$V2.x * 301/ t6$geneL)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   5.25   15.27   18.83   18.97   22.39   63.33 
> t6 <- t3[ t3$V1.y == "chrY" & t3$V2.x > 100,]
> summary(t6$V2.x * 301/ t6$geneL)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  6.049  19.008  19.741  19.192  21.496  22.908 

g <- c("ENSG00000244731.10", "ENSG00000224389.9", "ENSG00000125730.18")
 t.g <- t3[ t3$V1 %in% g,]

###########################################################################
linyong@fry /lab/solexa_page/linyong/gtex-dna-test$ grep -i "c3.*geneIntv" *depth > temp1
grep -i "chrom.*chr1        " *depth > temp2
paste temp[12]  | cut -f 1,14 | awk '$1 != $2'|wc

linyong@fry /lab/solexa_page/linyong/gtex-dna-oct2023$ cp /lab/solexa_page/linyong/gtex-dna-test/slurm-gtexv8-pipeline-DNA-download-genecount-02 ./
vi slurm-gtexv8-pipeline-DNA-download-genecount-02
#SBATCH --output out-dir-cram-oct08
t=1
while [ "$t"  -le 50 ]
linyong@fry /lab/solexa_page/linyong/gtex-dna-oct2023$ sbatch slurm-gtexv8-pipeline-DNA-download-genecount-02

################################################################
linyong@fry /lab/solexa_page/linyong/gtex-genome-tsvs$ cat subject.tsv | cut -f 46,106,204 > temp-1
linyong@fry /lab/solexa_page/linyong/gtex-981subjects-tsvs$ cat subject.tsv | cut -f 46,106,204 > temp-1
source_subject_id       height  unit_height
GTEX-YB5E       68.0    in
GTEX-14A6H      74.0    in

linyong@fry /lab/solexa_page/linyong/gtex-981subjects-tsvs$ wc -l /lab/solexa_page/linyong/gtex-genome-tsvs/temp-1 /lab/solexa_page/linyong/gtex-981subjects-tsvs/temp-1
  839 /lab/solexa_page/linyong/gtex-genome-tsvs/temp-1
  982 /lab/solexa_page/linyong/gtex-981subjects-tsvs/temp-1
cat /lab/solexa_page/linyong/gtex-genome-tsvs/temp-1 /lab/solexa_page/linyong/gtex-981subjects-tsvs/temp-1 | sort | uniq -d | wc -l
839

linyong@fry /lab/solexa_page/linyong/gtex-transcriptome-tsvs$ cat subject.tsv | cut -f 46,106,204 > temp-1
linyong@fry /lab/solexa_page/linyong$ wc -l /lab/solexa_page/linyong/gtex-transcriptome-tsvs/temp-1 /lab/solexa_page/linyong/gtex-981subjects-tsvs/temp-1
  949 /lab/solexa_page/linyong/gtex-transcriptome-tsvs/temp-1
  982 /lab/solexa_page/linyong/gtex-981subjects-tsvs/temp-1
linyong@fry /lab/solexa_page/linyong$ cat /lab/solexa_page/linyong/gtex-transcriptome-tsvs/temp-1 /lab/solexa_page/linyong/gtex-981subjects-tsvs/temp-1 | sort | uniq -d | wc -l
949
linyong@fry /lab/solexa_page/linyong/gtex-981subjects-tsvs$  cat subject.tsv | cut -f 46,106,204 > gtex-981donor-height.txt

####################################################################
Heart - Left Ventricle  428
+  med$logic[i] <- median(d[i,]) >= 0.5
> print(dim(y))
[1] 15298   428
......
> for(i in 1:dim(y)[2]) {
+  t1 <- info[ info$sid == y.cn[i],]
.......
 t5 <- read.delim("gtex-981subjects-tsvs/subject.tsv")
 info3 <- t5[, c(16,31,46, 106)]
 summary(info3)
 info.2$ageV = 0
 info.2$bmi = 0
 info4 <- merge(info.2, info3, by.x="SUBJID", by.y="source_subject_id")
 dim(info4)
# [1] 428  12
for(i in 1:dim(y)[2]) {
 t1 <- info.2[i,]$SUBJID
 info.2[i,]$ageV = info4[ info4$SUBJID == t1,]$age_value[1]
 info.2[i,]$bmi = info4[ info4$SUBJID == t1,]$body_mass_index[1]
 }
 identical(info.2$sid, y.cn)
 design <- model.matrix( ~ info.2$SEX + info.2$ageV + info.2$bmi)
y <- estimateDisp(y,design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, coef=2)
top2v1 <- topTags(qlf, n = 91234)
write.table(top2v1, "diff2-1.txt", sep="\t", quote = F)
diff <- as.data.frame(top2v1)
diff$geneID <- rownames(diff)
gene.name <- raw[, 1:2]
df.gene <- merge(diff, gene.name, by.x="geneID", by.y="geneID")
chr <- read.delim("../autism/gencode.v42.primary_assembly.noPar.gene-chr-type")
df.cpm.gene <- merge(df.gene, chr, by.x="geneID", by.y="geneID")

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % mv -i  diff2-1.txt diff2-1-left-ventricle-FvsM.age-bmi-covar.txt
# diff2-1-left-ventricle-FvsM.age-bmi-covar.2.txt

vi diff2-1-left-ventricle-FvsM.age-bmi-covar.2.txt  
###:, $ s/^[0-9][0-9]*^I//
cat diff2-1-left-ventricle-FvsM.age-bmi-covar.2.txt  | awk 'BEGIN {FS = "\t"} !($8 == "chrX" || $8 == "chrY")'   > temp1

cat temp1 | awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""}
{for(i = 1; i <= 7; i++)
   print $i "\t";

 print $7 "\n";
}' > temp
../microglia/make-rnk-genesymble  temp   diff2-1-left-ventricle-FvsM.age-bmi-covar.noX.Y.rnk

bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx    fao.gmt    -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk   diff2-1-left-ventricle-FvsM.age-bmi-covar.noX.Y.rnk  -scoring_scheme classic  -rpt_label   "left-ventricle-FvsM.noX.Y.age-bmi-covar-weight0-FAO"  -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

#####################################
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat diff2-1-left-ventricle-FvsM.age-bmi-covar.2.txt  | awk 'BEGIN {FS = "\t"} !($8 == "chrX" || $8 == "chrY")'   | grep -w protein_coding > temp1
cut -f 10 temp1 | sort | uniq -c | sort -n
cat temp1 | awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""}
{for(i = 1; i <= 7; i++)
   print $i "\t";

 print $7 "\n";
}' > temp
 ../microglia/make-rnk-genesymble  temp   diff2-1-left-ventricle-FvsM.age-bmi-covar.noX.Y.protein_coding.rnk
bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx    fao.gmt    -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk    diff2-1-left-ventricle-FvsM.age-bmi-covar.noX.Y.protein_coding.rnk -scoring_scheme classic  -rpt_label   "left-ventricle-FvsM.noX.Y.age-bmi-covar-weight0-FAO-protein_coding"  -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

################################################################################
Skin - Sun Exposed (Lower leg)  698
+  med$logic[i] <- median(d[i,]) >= 0.5
+ }
> ####median >= 1 for pathway genes
> y<-y[med$logic,]
> print(dim(y))
[1] 18312   698
> df.cpm.gene[ df.cpm.gene$name %in% c("DDX3X", "DDX3Y"),]
                  geneID      logFC   logCPM          F       PValue          FDR  name  chr strand           type
908   ENSG00000067048.17 -8.6235068 6.004004 10359.4750 0.000000e+00 0.000000e+00 DDX3Y chrY      + protein_coding
14447 ENSG00000215301.11  0.4293785 8.373848   287.9503 2.481522e-54 1.336519e-51 DDX3X chrX      + protein_coding
> y[,1:11]

> write.table(df.cpm.gene, "diff2-1-Skin-SunExposed-FvsM.age-bmi-covar.txt", quote=F, sep="\t")

#############################################################
> f <- read.delim("diff2-1-Skin-SunExposed-FvsM.age-bmi-covar.noX.Y.rnk", header=F)
 fao.name <- df.cpm.gene[ df.cpm.gene$geneID %in% fao,]$name
 f2 <- f[ f$V1 %in% fao.name,]
 dim(f2)
a =  dim(f2 [ f2$V2 > 0,])[1]
b = dim(f2 [ f2$V2 < 0,])[1]
c = dim(f [ f$V2 > 0,])[1] - a
d = dim(f [ f$V2 < 0,])[1] - b
fis <- matrix(c(a,b,c,d), nrow=2, ncol=2, byrow=T )
fis
 fisher.test(fis)

######################################################################################
linyong@fry /lab/solexa_page/linyong$  ~/C++/reSeqPrintChrRegion.fq /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa  out chr6 31982057 32002681  > c4a.dna.fa

linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools view -b   GTEX-11GSO-0003-SM-6WBTR.cram chr6:31982057-32002681 > temp.c4a.bam
samtools index  temp.c4a.bam

linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools mpileup -q 20 -o out -f /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa  -d 1234567 --output-MQ   --output-QNAME  temp.c4a.bam
[mpileup] 1 samples in 1 input files
[mpileup] Combined max depth is above 1M. Potential memory hog!

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp.pileup | awk '{print NR "\t" $2 - 31982057 + 1}' > out
> t1 <- read.delim("out", header=F)
> plot(t1, pch = 16, cex=0.1)
> abline(h = seq(0,18000,200), lty = 5, lwd = 0.5, col = "gray")
> abline(v = seq(0,18000,100), lty = 5, lwd = 0.5, col = "gray")

 t1 <- read.delim("temp.q0.pileup", header=F)
 plot(t1$V2, t1$V4,  pch = 1, cex = 0.5, xlab= "C4A position", ylab="mpileup -q 0", col= "blue")
 abline(h = seq(0,18000,5), lty = 5, lwd = 0.5, col = "gray")
 t2 <- read.delim("temp.pileup", header=F)
 t3 <- merge(t1, t2, by.x ="V2", by.y = "V2")
 dim(t3)
# [1] 3485   15
 plot(t3$V2, t3$V4.x,  col="white", xlab= "C4A DNA chr position", ylab="mpileup")
 points(t3$V2, t3$V4.x, col="red")
 points(t3$V2, t3$V4.y, col="blue")
  abline(h = seq(0,18000,5), lty = 5, lwd = 0.5, col = "gray")
 
 abline(v = seq(0,41234000,500), lty = 5, lwd = 0.5, col = "gray")
 legend(31994000, 80, c("mapq 0", "mapq 20"), pch = c(16,16),col = c("red", "blue" ) )

###################simulation data
################################generate reads from c4a locus only
linyong@fry /lab/solexa_page/linyong/gtex-dna$ ~/C++/reSeqPrintChrRegion.fq /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa  out chr6  31982057  32003681   > temp.c4a.dna.plus1kbp.fa
linyong@fry /lab/solexa_page/linyong/gtex-dna$ cat script-get-reads-c4a
#chr6 31982057 32002681 (20625-bp) . + . gene_id "ENSG00000244731.10"; gene_type "protein_coding"; gene_name "C4A"; 


a=1

while [ "$a" -lt 20625 ]
do
 e=`expr "$a" + 149`
 echo ">c4a.$a-$e"
  ~/C++/reSeqPrintChrRegion.fq temp.c4a.dna.plus1kbp.fa out chr6 "$a" "$e" | awk 'NR == 2'
 a=`expr "$a" + 5000`
done
----------------------------------------------------------------
bash script-get-reads-c4a > temp.c4a.dna.reads.fa
bwa mem -t 4 /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa   temp.c4a.dna.reads.fa > temp.sam
## [M::process] read 138 sequences (20700 bp)...
cat temp.sam | grep "^c4a" | cut -f 3 | uniq -c
#     138 chr6
cat temp.sam | grep "^c4a" | cut -f 4 | sort -n
# 31982207 .. 32035044
cat temp.sam | grep "^c4a" | awk '$4 > 32014795' | wc -l
# 64 reads in c4b locus
cat temp.sam | grep "^c4a" | cut -f 5 | sort -n | uniq -c
    128 0
      7 8
      1 26
      1 43
      1 54
cat temp.sam | grep "^c4a" | awk '$5 > 0'
cat temp.sam | grep "^c4a" | awk '$5 > 0' | cut -f 1-9,11-100
c4a.12301-12450	0	chr6	31994357	8	150M	*	0	0	*	NM:i:0	MD:Z:150	AS:i:150	XS:i:145	XA:Z:chr6,+32027095,150M,1;  (1 mismatch)
c4a.14551-14700	0	chr6	31996607	26	150M	*	0	0	*	NM:i:0	MD:Z:150	AS:i:150	XS:i:138	XA:Z:chr6,+32029345,11M1I138M,2;
c4a.14401-14550	0	chr6	31996457	43	150M	*	0	0	*	NM:i:0	MD:Z:150	AS:i:150	XS:i:130	XA:Z:chr6,+32029195,150M,4;
c4a.13951-14100	0	chr6	31996007	54	150M	*	0	0	*	NM:i:0	MD:Z:150	AS:i:150	XS:i:125	XA:Z:chr6,+32028745,150M,5; (5 mismatch)


samtools view  GTEX-11GSO-0003-SM-6WBTR.cram chr6:31982057-32002681 >  temp.c4a.sam

linyong@fry /lab/solexa_page/linyong/gtex-dna$ cat temp.c4a.sam  | cut -f 5 | sort -n | uniq -c
   7100 0
      1 1
     17 3
      1 4
      5 5
     42 6
      1 7
     18 9
     12 15
     10 21
      1 25
    494 27
      8 39
    139 40
      3 41
      1 42
      1 43
      6 44
     22 45
     46 46
      1 47
      1 50
      1 51
      6 54
      3 57
    173 60
linyong@fry /lab/solexa_page/linyong/gtex-dna$ cat temp.c4a.sam  | awk '$5 >= 20' |wc -l
916
linyong@fry /lab/solexa_page/linyong/gtex-dna$ cat temp.c4a.sam  | awk '$5 >= 20' |cut -f 1 | sort | uniq -u | wc -l
8 (3 mates mapped to chr3/2/11; 2 mates with mapQ = 0; 3 mates mapped with insert size 33269-bp, 33297-bp, 33024-bp
linyong@fry /lab/solexa_page/linyong/gtex-dna$ cat temp.c4a.sam  | awk '$5 >= 20' |cut -f 1 | sort | uniq -d | wc -l
454

####################################################liver, sex diff, BMI / age as covar
                  geneID     logFC   logCPM         F    PValue       FDR name  chr strand           type
13394  ENSG00000224389.9 0.1951779 7.546203 1.5227584 0.2184858 0.6060490  C4B chr6      + protein_coding 
14202 ENSG00000244731.10 0.1669817 7.381534 0.8640129 0.3536111 0.7156702  C4A chr6      + protein_coding

Liver
C4A
cpm.female.mean = 177.317
cpm.male.mean = 162.3954

C4B
cpm.female.mean = 202.18
cpm.male.mean = 180.66




 t6 <- as.data.frame(cpm(y))
 t7 <- t6[ c("ENSG00000224389.9"), info.2$SEX ==2]
 t8 <- as.data.frame(t(t7))
 dim(t8)
 summary(t8[,1])

  t7 <- t6[ c("ENSG00000224389.9"), info.2$SEX ==1]
 t8 <- as.data.frame(t(t7))
 dim(t8)
 summary(t8[,1])

############################################################mouse RNA-seq read length
linyong@fry /lab/solexa_page/linyong$ cat script-read-length
#
ls  /lab/page_scratch/helen/lukas/mouse/GB/*_2.fastq | while read ll
do
  head -400000 "$ll" | awk 'NR % 4 == 2 {print length($0) }' | sort -n | tail -n 1

done

linyong@fry /lab/solexa_page/linyong$ bash script-read-length | wc
     79 fastq PE files;     79     293

linyong@fry /lab/solexa_page/linyong$ bash script-read-length | sort -n | uniq -c
      2 42
      2 50
     13 76
      6 80
     18 100
      9 101
      3 126
      9 150
     17 151-bp , read length

linyong@fry /lab/solexa_page/linyong$ cat script-read-length-2
#
ls  /lab/page_scratch/helen/lukas/mouse/GB/*.fastq | grep -v "_[12].fastq" | while read ll
do
  head -400000 "$ll" | awk 'NR % 4 == 2 {print length($0) }' | sort -n | tail -n 1

done
linyong@fry /lab/solexa_page/linyong$ bash script-read-length-2 | sort -n | uniq -c
      1 36
     10 50-bp, SE RNA-seq

linyong@fry /lab/solexa_page/linyong/mouse-helen-lukas-heart$ cat script-1 
#
ls *.STAR.log | while read ll
do
 l1=`cat "$ll" | grep "Average input read length" | awk '{print $6}' `
 l2=`cat "$ll" | grep "Average mapped length" | awk '{print $5}' `
 m1=`cat "$ll" | grep "Uniquely mapped reads %"   | awk '{print $6}' `
 echo "$ll	$l1	$l2	$m1"
done

######################################################################
linyong@fry /lab/solexa_page/linyong/mouse-genome$ cat slurm-wi-star-genome-index-mouse 
#!/bin/bash
# Configuration values for SLURM job submission.
# One leading hash ahead of the word SBATCH is not a comment, but two are.
#SBATCH --job-name="stargenomeindex" # friendly name for job.
#SBATCH --nodes=1                      # ensure cores are on one node
#SBATCH --ntasks=1                     # run a single task
#SBATCH --cpus-per-task=20              # number of cores/threads requested.
#SBATCH --mem=128gb                      # memory requested.
#SBATCH --partition=20                 # partition (queue) to use
#SBATCH --output star-genome-index-%j.out   # name of output file.  %j is jobid
#SBATCH --mail-type=ALL               # send email on job start/finish.
#SBATCH --mail-user=linyong@wi.mit.edu

# This is the actual section for commands to run

STAR  --runMode genomeGenerate  --genomeDir /lab/solexa_page/linyong/dir-star-genome-index-mouse-oh150    --genomeFastaFiles  Mus_musculus.GRCm39.dna.primary_assembly.fa   --sjdbGTFfile gencode.vM31.primary_assembly.annotation.gtf   --sjdbOverhang 150 --runThreadN 16

################################################################modify mouse fasta file: 1 -> chr1
linyong@fry /lab/solexa_page/linyong/mouse-helen-lukas-heart$  grep -n ">" ../mouse-genome/Mus_musculus.GRCm39.dna.primary_assembly.fa
cat ../mouse-genome/Mus_musculus.GRCm39.dna.primary_assembly.fa | sed '1, 43866282 s/>/>chr/ ' > ../mouse-genome/Mus_musculus.GRCm39.dna.primary_assembly.chr.fa
vi ../mouse-genome/Mus_musculus.GRCm39.dna.primary_assembly.chr.fa
cat /lab/solexa_page/linyong/mouse-genome/gencode.vM31.primary_assembly.annotation.gtf | cut -f 1 | sort | uniq > temp-1
grep ">" ../mouse-genome/Mus_musculus.GRCm39.dna.primary_assembly.chr.fa | sed 's/ .*//' | sed 's/>//' | while read ll; do echo -n "$ll   "; grep -w "$ll" temp-1 | wc -l; done

grep ">" ../mouse-genome/Mus_musculus.GRCm39.dna.primary_assembly.chr.fa | sed 's/ .*//' | sed 's/>//' | while read ll; do echo -n "$ll   "; grep -w "$ll" temp-1 | wc -l; done | awk '$2 == 0'
GL456233.2   0
GL456359.1   0
GL456360.1   0
GL456366.1   0
GL456367.1   0
GL456368.1   0
GL456370.1   0
GL456378.1   0
GL456379.1   0
GL456382.1   0
GL456383.1   0
GL456387.1   0
GL456389.1   0
GL456390.1   0
GL456392.1   0
GL456394.1   0
GL456396.1   0
JH584300.1   0
JH584301.1   0
JH584302.1   0
MU069434.1   0
MU069435.1   0

grep ">" ../mouse-genome/Mus_musculus.GRCm39.dna.primary_assembly.chr.fa | sed 's/ .*//' | sed 's/>//' | while read ll; do echo -n "$ll   "; grep -w "$ll" temp-1 | wc -l; done | awk '$2 == 0' | sort | awk '{print $1}' | while read g; do grep -i "$g" /lab/solexa_page/linyong/mouse-genome/gencode.vM31.primary_assembly.annotation.gtf ; done

linyong@fry /lab/solexa_page/linyong$ cat dir-star-genome-index-mouse-oh150-chr/chrNameLength.txt | sed 's/chr//' > temp
diff temp dir-star-genome-index-mouse-oh150-chr/chrNameLength.txt
linyong@fry /lab/solexa_page/linyong$ diff temp dir-star-genome-index-mouse-oh150/chrNameLength.txt
20c20
< M     16299
---
> MT    16299

###############################overlapped donors between muscle and heart
> dim(info.2)
[1] 799   9
> head(info.2)
      SUBJID                   SAMPID   SUBJID.1 SEX   AGE DTHHRDY                       sid ageV   bmi
1 GTEX-113JC GTEX-113JC-2726-SM-5EGIS GTEX-113JC   2 50-59       2 GTEX.113JC.2726.SM.5EGIS.   53 27.99
2 GTEX-11DXY GTEX-11DXY-2726-SM-5GID2 GTEX-11DXY   1 60-69       2 GTEX.11DXY.2726.SM.5GID2.   62 20.67
3 GTEX-12WSD GTEX-12WSD-0526-SM-5EQ6F GTEX-12WSD   2 60-69       2 GTEX.12WSD.0526.SM.5EQ6F.   64 31.24
> info.muscle <- info.2
......
info.2 from heart-atri
> info.atr <- info.2[ info.2$SUBJID %in% info.muscle$SUBJID, ]
> dim(info.atr)
[1] 380 (overlapped donors between 429 heart-atri & 799 muscle);  9
> dim(raw)
[1] 62703 17352
>  raw2 <- raw[, colnames(raw) %in% info.atr$sid ]
> dim(raw2)
[1] 62703   380

################################overlap among heart-aa, heart-lv, muscle

script-gtexv8-tissue-sex-diff-age-bmi-covar
-------------------------------------------
> dim(info.2)
[1] 428   7
> info.LV <- info.2
......
> info.mus <- info.2
......
> info.atr <- info.2[ (info.2$SUBJID %in% info.mus$SUBJID) & (info.2$SUBJID %in% info.LV$SUBJID), ]
> dim(info.atr)
[1] 270   7
dim(raw)
t1 <- read.delim("dir-gtex-website-data/sample-tissue.2colum", header=F)
file <- read.delim("gtex-54tiss.txt", header=F)
 index = 32
tissue = file[index,1]
 t2 <- t1[ t1$V2 == tissue, ]
 t2$id <- gsub("-", ".", t2$V1)
 t2$id <- paste(t2$id, ".", sep="")
 raw2 <- raw[, colnames(raw) %in% info.atr$sid ]
 str1 <- paste(tissue, dim(raw2)[2], sep="\t")
 cat(str1)
 cat("\n")
# Heart - Atrial Appendage      270
# 87 F; 183 M; 
>  rownames(raw2) <- raw$geneID
> y <- DGEList(counts=raw2)
> y <- calcNormFactors(y)
> med <- data.frame(y$counts[,1])
> med$logic <- TRUE

.......
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % mv -i diff2-1.txt  diff2-1-Heart-Atrial-Appendage-FvsM.age-bmi-covar.aa-LV-mus-270.txt
diff2-1-Heart-Atrial-Appendage-FvsM.age-bmi-covar.aa-LV-mus-270.noX.Y.rnk

##################################get cpm values for lukas
> dim(info.aa0)
[1] 429   9
> dim(info.LV)
[1] 428   9
> dim(info.mus)
[1] 799   9

> c3 <- as.data.frame( cpm(y))
 c3$id <- rownames(c3)
 gene.name <- raw[, 1:2]
 c4 <- merge(c3, gene.name, by.x="id", by.y="geneID")
 dim(c4)
# [1] 16642   272
 write.table(c4, "temp1", quote=F, sep="\t")
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % vi temp1
upload temp1
rename temp1
"CPM.shared270donors.Heart-Atrial-Appendage.txt"
Heart - Left Ventricle 15249 genes
CPM.shared270donors.Heart-Left-Ventricle.txt
Muscle - Skeletal       270 14714-genes
CPM.shared270donors.Muscle-Skeletal.txt
############################R code ###
 cpm <- read.delim("../../Downloads/CPM.Heart-Left-Ventricle.txt")
 dim(cpm) 
# [1] 15298   430
 info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
 info$sid <-  gsub("-", ".", info$SAMPID)
 info$sid <-  paste( info$sid, ".", sep="")
 t=dim(cpm)[2]
 cpm.info <- data.frame(donor= colnames(cpm)[2:(t-1)] )
 cpm.info$sex = "S"
for(i in 1:length(cpm.info$donor)) {
  cpm.info$sex[i] = info[ info$sid == cpm.info$donor[i],  ][1,4]
}
 cpm.info$sex <- factor(cpm.info$sex, levels=c(2,1), labels=c("Female", "Male"))
 write.table(cpm.info, "temp-cpm-LV-donor.sex.txt", sep="\t", quote=F)
###testing purpose
 vioplot( t(cpm[ cpm$name == "DDX3Y", 2:(t-1)]) ~ cpm.info$sex)

###
 layout(matrix(1:4, 2, 2, byrow=T) )
   boxplot( t(cpm[ cpm$name == "CPT1A", 2:(t-1)]) ~ cpm.info$sex)
  boxplot( t(cpm[ cpm$name == "CPT1B", 2:(t-1)]) ~ cpm.info$sex)
  boxplot( t(cpm[ cpm$name == "ECHS1", 2:(t-1)]) ~ cpm.info$sex)
  boxplot( t(cpm[ cpm$name == "ACADL", 2:(t-1)]) ~ cpm.info$sex)


###############################MASH.beta vs P-lab
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % vi temp-muscle
> t1 <- read.delim("temp-muscle")
 head(t1)
 t2 <- read.delim("diff2-1-muscle-FvsM.age-bmi-covar.noX.Y.rnk", header=F)
 t3 <- merge(t1, t2, by.x=colnames(t1)[2], by.y="V1")
 dim(t3)
# [1] 333   7; t2-.rnk already removed x/y chr linked genes
 cor1 <- cor.test(t3$MASH.beta, t3$V2, method="spearman")
 par( mar=c(6,6,2,2))
 plot(t3$MASH.beta, t3$V2, xlab="MASH.beta (PMID: 32913072)", ylab="signed log10(p-value) \n F vs M, P-Lab")
 abline(lm(t3$V2 ~ t3$MASH.beta), lwd = 1, col="blue")

 abline(h = seq(-100,100,5), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,0.2), lty = 5, lwd = 0.5, col = "gray")
 abline(h = 0)
 abline(v = 0)
title(main=paste("muscle: ", "r=",round(cor1$estimate, digits = 3), " p=", format(cor1$p.value, digits=3), " (Spearman)", sep =""))

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % vi temp-heart-aa
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % vi temp-heart-lv

######################################fisher test 
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp-heart-aa| awk 'BEGIN {FS = "\t"; OFS = "\t"} $3 != "chrX" && $3 != "chrY" && $4 > 0' | cut -f 2 | sort | uniq| grep -vi HUGO_gene_id | awk 'NF == 1' |wc -l
     193
cat temp-heart-aa| awk 'BEGIN {FS = "\t"; OFS = "\t"} $3 != "chrX" && $3 != "chrY" && $4 > 0' | cut -f 2 | sort | uniq| grep -vi HUGO_gene_id | awk 'NF == 1' > temp-up
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat fao.gmt| grep -iw fao | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 3; i <= NF; i++) print  $i}' | sort | uniq > genes-fao
head temp-file
../dir-GTExV8/genes-fao
../microglia/HALLMARK_ADIPOGENESIS.genes
../microglia/HALLMARK_ALLOGRAFT_REJECTION.genes
../microglia/HALLMARK_ANDROGEN_RESPONSE.genes

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % bash  script-inputset-pathways-overlap-fisher  temp-up  heart-aa-up-genes  temp-file diff2-1-Heart-Atrial-Appendage-FvsM.age-bmi-covar.noX.Y.rnk
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % mv -i script-inputset-pathways-overlap-fisher script-inputset-pathways-overlap-fisher-2

##################################c3 c4a chr read length, depth
linyong@fry /lab/page_human_data/linyong2/gtex-dna-oct102023$ cat GTEX-11ZTT-0003-SM-6WBU4.gene.exon.depth | head -600 | grep -i c4[ab] | grep -iv exon

cat GTEX-11ZTT-0003-SM-6WBU4.gene.exon.depth | head -600 | grep -w chrom |grep -w chr[0-9][0-9]* | sort -t '\t' +10 -11g | awk 'NR == 11'

header  geneID  geneName        header  #rname  startpos        endpos  numreads        covbases        coverage        meandepth       meanbaseq       meanmapq
GTEX-11ZTT-0003-SM-6WBU4        geneID  geneName        chrom   chr8    1       145138636       32102398        144533056       99.5828 32.832  255     56.6
### chr-len * depth / numreads = read-len
linyong@fry /lab/page_human_data/linyong2/gtex-dna-oct102023$ echo | awk '{print  145138636 * 32.832 / 32102398}'
148.437

GTEX-11ZTT-0003-SM-6WBU4        geneID  geneName        chrom   chrX    1       156040895       33870350        154561837       99.0521 32.2191 255     55.1
linyong@fry /lab/page_human_data/linyong2/gtex-dna-oct102023$ echo | awk '{print  156040895 * 32.2191 / 33870350 }'
148.434

linyong@fry /lab/page_human_data/linyong2/gtex-dna-oct102023$ cat GTEX-11ZTT-0003-SM-6WBU4.gene.exon.depth | head -600 | grep -i c4[ab] | grep -iv exon
GTEX-11ZTT-0003-SM-6WBU4        ENSG00000244731.10      C4A     geneIntv        chr6    31982057        32002681        5522    20625   100     39.6296 255     2
.61
GTEX-11ZTT-0003-SM-6WBU4        geneID  C4A-C4B geneIntv        chr6    31982057        32035418        14464   53362   100     40.3379 255     8.21

linyong@fry /lab/page_human_data/linyong2/gtex-dna-oct102023$  echo | awk '{print 20625 * 39.6296 / 5522}'
148.019
linyong@fry /lab/page_human_data/linyong2/gtex-dna-oct102023$ echo | awk '{print 53362 * 40.3379 / 14464}'
148.819

linyong@fry /lab/page_human_data/linyong2/gtex-dna-oct102023$ cat GTEX-11ZTT-0003-SM-6WBU4.gene.exon.depth | head -600 | grep -i c3 | grep -iv exon
GTEX-11ZTT-0003-SM-6WBU4        ENSG00000125730.18      C3      geneIntv        chr19   6677704 6730562 12598   52268   98.8819 34.8137 255     58.9
linyong@fry /lab/page_human_data/linyong2/gtex-dna-oct102023$ echo | awk '{print (6730562 - 6677704) * 34.8137 / 12598}'
146.069

#############################################################
> t1 <- read.delim("diff2-1-Heart-Atrial-Appendage-FvsM.age-bmi-covar.txt")
> scan fao genes
 t2 <- t1[ t1$chr != "chrX" & t1$chr != "chrY",]
 dim(t2)
# [1] 16162    10
fatty <- read.delim("../microglia/HALLMARK_FATTY_ACID_METABOLISM.genes", header=F)
 t2$categ <- "NA"
for (i in 1:dim(t2)[1]) {
 if(t2[i,]$FDR > 0.05)
 {
  t2[i,]$categ = "N.S."
  if(t2[i,]$name %in% fao)
    t2[i,]$categ = "N.S.fao-20"
  if(t2[i,]$name %in% fatty$V1)
    t2[i,]$categ = "N.S.hallmark-fa-metab"
  if(t2[i,]$name %in% fao & t2[i,]$name %in% fatty$V1)
    t2[i,]$categ = "N.S.fa-overlapped"
 }
 else
 {
  t2[i,]$categ = "Sig"
  if(t2[i,]$name %in% fao)
    t2[i,]$categ = "Sig.fao-20"
  if(t2[i,]$name %in% fatty$V1)
    t2[i,]$categ = "Sig.hallmark-fa-metab"
  if(t2[i,]$name %in% fao & t2[i,]$name %in% fatty$V1)
    t2[i,]$categ = "Sig.fa-overlapped"

 }
}

 unique(t2$categ)
 ggplot(t2, aes(x=logFC, y = -log10(PValue), color = categ)) + geom_point(size=1)
 sort(unique(t2$categ))[c(2:4, 6:8)]
# [1] "N.S.fa-overlapped"     "N.S.fao-20"            "N.S.hallmark-fa-metab" "Sig.fa-overlapped"     "Sig.fao-20"            "Sig.hallmark-fa-metab"
 t3 <- t2[ t2$categ %in% sort(unique(t2$categ))[c(2:4, 6:8)], ]
 dim(t3)
# [1] 138  11
 cat1 <- sort(unique(t2$categ))[c(2:4, 6:8)]
 cat1
# [1] "N.S.fa-overlapped"     "N.S.fao-20"            "N.S.hallmark-fa-metab" "Sig.fa-overlapped"     "Sig.fao-20"            "Sig.hallmark-fa-metab"
 col1 = c("grey60", "brown", "grey10", "green", "blue", "red")
ggplot(t3, aes(x=logFC, y = -log10(PValue), color = categ)) + geom_point(size=2) + scale_color_manual(breaks=cat1, values=col1)

 p <- sort(t3$PValue)[20]
 t4 <- t3[ t3$PValue <= p,]
 dim(t4)
library(ggrepel)
 ggplot(t3, aes(x=logFC, y = -log10(PValue), color = categ, label = name)) + geom_point(size=1) + scale_color_manual(breaks=cat1, values=col1) + labs(title="heart-AA: FA metab genes", x = "log2FC (F vs. M)") + geom_text_repel(show.legend=F, data=t4, size=2.2, max.overlaps=100, min.segment.length = 0.4)

 ggplot(t3, aes(x=logFC, y = -log10(PValue), color = categ)) + geom_point(size=2) + scale_color_manual(breaks=cat1, values=col1) + labs(title="heart-AA: FA metab genes", x = "log2FC (F vs. M)")

##############################genome-wide genes volcano plot
 t1 <- read.delim("diff2-1-Heart-Atrial-Appendage-FvsM.age-bmi-covar.txt")
 t2 <- t1[ t1$chr != "chrX" & t1$chr != "chrY",]
 dim(t2)
# [1] 16162    10
fatty <- read.delim("../microglia/HALLMARK_FATTY_ACID_METABOLISM.genes", header=F)
 t2$categ <- "NA"
for (i in 1:dim(t2)[1]) {
 if(t2[i,]$FDR > 0.05)
 {
  t2[i,]$categ = "N.S."
 }
 else
 {
  t2[i,]$categ = "Sig. (FRD < 0.05)"
 }
}
 unique(t2$categ)
cat1 <- sort(unique(t2$categ))
 col1 = c( "grey10",  "red")
 ggplot(t2, aes(x=logFC, y = -log10(PValue), color = categ)) + geom_point(size=1) + scale_color_manual(breaks=cat1, values=col1) + labs(title="heart-AA: autosomal genes", x = "log2FC (F vs. M)")

########################random gene sets
 t3 <- t2[ !(t2$categ %in% sort(unique(t2$categ))[c(2:4, 6:8)]), ]
  dim(t3)
# [1] 16024    11
 cat1 <- sort(unique(t3$categ))
 cat1
# [1] "N.S."              "Sig. (FDR < 0.05)"
 col1 = c("grey10", "red")
 t4 <- t3[ sample(1:dim(t3)[1], 138), ]

 ggplot(t4, aes(x=logFC, y = -log10(PValue), color = categ)) + geom_point(size=2) + scale_color_manual(breaks=cat1, values=col1) + labs(title="heart-AA: FA metab genes", x = "log2FC (F vs. M)")

############################bar plot
> t1 <- read.delim("mash-heart-aa-up-genes.51GO")
 t2 <- read.delim("mash-heart-lv-up-genes.51GO")
 paths <- t1$pathway[c(1,18)]
###second 2 is # of pathways (columns), first 2 # of tissues
 pva <- data.frame(matrix(NA, 2, 2))
 li <- list(t1,t2)
 for(i in 1:length(paths)) {
  for(j in 1:length(li)){
 tem <- li[[j]]
 rownames(pva)[j] = tem$test.set[1]
 colnames(pva)[i] = paths[i]
 pva[j,i] =tem[ tem$pathway == paths[i],]$log10P
 }
}

 nam <- colnames(pva)
 nam <- gsub(".*/", "", nam)
 nam <- gsub("genes-fao", "FAO 20 genes", nam)
 par( mar=c(6,16,2,2))
 barplot(as.matrix( pva), horiz=T, beside=T, xlim=c(0, 5.5), xlab="-log10(p-value)", yaxt = "n", col=c("green",  "red"))
 axis(side=2, at = seq(2, 5, by=3), labels=nam, las =1, cex.axis = 0.7)

 or <- data.frame(matrix(NA, 2, 2))
 for(i in 1:length(paths)) {
  for(j in 1:length(li)){
 tem <- li[[j]]
 rownames(or)[j] = tem$test.set[1]
 colnames(or)[i] = paths[i]
 or[j,i] =tem[ tem$pathway == paths[i],]$oddsratio
 }
}

 text(pva[1,] , c(1.5, 4.5), paste("OR=", format(or[1,], digits=3), sep=""), pos=4, col = "green")
 text(pva[2,] , c(2.5, 5.5), paste("OR=", format(or[2,], digits=3), sep=""), pos=4, col = "red")
 abline(v= -log10(0.05), lty = 5, lwd = 0.5, col = "blue" )
 text(-log10(0.05), 3.5, "p=0.05", pos=4, col="blue")
 legend(4, 5.5, rownames(pva), fill=c("green", "red"), cex = 0.6, inset = 0.05)

############################below is plot for only 1 tissue. The above pva d.f. is for 2tiss x 2paths 
 nam <- colnames(pva)
 nam <- gsub(".*/", "", nam)
 nam <- gsub("genes-fao", "FAO 20 genes", nam)

 par( mar=c(6,16,2,2))
 barplot(as.matrix( pva), horiz=T, beside=T, xlim=c(0, 4), xlab="-log10(p-value)", yaxt = "n")
 axis(side=2, at = seq(1.5, 8, by=2), labels=nam, las =1, cex.axis = 0.8)
 text(pva[1,] , seq(1.5, 8, by=2), paste("OR=", format(or[1,], digits=3), sep=""), pos=4)
 abline(v= -log10(0.05), lty = 5, lwd = 0.5, col = "blue" )
 text(-log10(0.05), 2.5, "p=0.05", pos=4, col="blue")

###############################barplot NES, two pathways (column), two tissues (rows)
> t1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/Heart-Atrial-Appendage-FvsM.noX.Y.age-bmi-covar-weight0-FAO.GseaPreranked.1698075308261/gsea_report_for_na_pos_1698075308261.tsv")
 t2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/left-ventricle-FvsM.noX.Y.age-bmi-covar-weight0-FAO.GseaPreranked.1697054041002/gsea_report_for_na_pos_1697054041002.tsv")
 paths <- t1$NAME[c(3,4)]
 paths <- c(paths[2], paths[1])

 t1$test.set = "heart-AA-F-biased"
 t2$test.set = "heart-LV-F-biased"

 pva <- data.frame(matrix(NA, 2, 2))
 li <- list(t1,t2)
 for(i in 1:length(paths)) {
  for(j in 1:length(li)){
 tem <- li[[j]]
 rownames(pva)[j] = tem$test.set[1]
 colnames(pva)[i] = paths[i]
 pva[j,i] =tem[ tem$NAME == paths[i],]$NES
 }
}

 nam <- colnames(pva)
 nam <- gsub(".*/", "", nam)
 nam <- gsub("FAO", "FAO 20 genes", nam)

 or <- data.frame(matrix(NA, 2, 2))
 li <- list(t1,t2)
 for(i in 1:length(paths)) {
  for(j in 1:length(li)){
 tem <- li[[j]]
 rownames(or)[j] = tem$test.set[1]
 colnames(or)[i] = paths[i]
 or[j,i] =tem[ tem$NAME == paths[i],]$FDR.q.val
 }
}

 par( mar=c(6,16,2,2))
 barplot(as.matrix( pva), horiz=T, beside=T, xlim=c(0, 5.5), xlab="NES (F vs. M)", yaxt = "n", col=c("green",  "red"))
 axis(side=2, at = seq(2, 5, by=3), labels=nam, las =1, cex.axis = 0.7)
 text(pva[1,] , c(1.5, 4.5), paste("FDR=", format(or[1,], digits=3), sep=""), pos=4, col = "green")
 text(pva[2,] , c(2.5, 5.5), paste("FDR=", format(or[2,], digits=3), sep=""), pos=4, col = "red")
 legend(4, 6, rownames(pva), fill=c("green", "red"), cex = 0.6, inset = 0.05)

##########################################################################

ls /lab/page_human_data/linyong2/gtex-dna-nov082023/*.gene.exon.depth | wc -l
80
ls /lab/page_human_data/linyong2/gtex-dna-oct102023/*.gene.exon.depth | wc -l
708
ls  /lab/solexa_page/linyong/gtex-dna-oct2023/*.gene.exon.depth | wc -l
50

cat /lab/solexa_page/linyong/genome-bam-only-file-manifest.json |grep  "file_name" |wc
    838    1676   41612
    "file_name": "GTEX-11LCK-0002-SM-6WBSW.cram",

linyong@fry /lab/solexa_page/linyong/gtex-dna-test$ bash script-cnv-01 > temp.txt

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % head temp.txt
GTEX-111YS-0004-SM-6WBTN        chr19   32.8933 chr21   33.02   chrX    16.5161 chrY    14.1011
GTEX-113IC-0001-SM-DLIPU        chr12   40.5283 chr8    40.6177 chrX    20.3759 chrY    17.5418
GTEX-113JC-0001-SM-6WBTD        chr7    34.6051 chr1    34.6447 chrX    33.9567 chrY    2.29488

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp.txt | sort -t ' ' +2 -3g > temp.sort.txt
> dp <- read.delim("temp.sort.txt", header=F)
 dim(dp)
# [1] 838   9
 summary(dp)
 plot(0,0, xlim=c(0, 850), ylim=c(0, 80), col="white", xlab="donor", ylab="seq depth")
 points(1:dim(dp)[1], dp$V5, pch = 1, col = "red", cex = 0.5)
 points(1:dim(dp)[1], dp$V3, pch = 1, col = "black", cex = 0.5)
 abline(h = seq(0, 100, 5), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100, 1000, 100), lty = 5, lwd = 0.5, col = "gray")
 legend(0, 80, legend=c("rank #11 autosomal chr depth", "rank #12 autosomal chr depth"), col = c("red", "black"), pch = 1, cex = 1)


linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, $6, $7 * 2 * 2/ ($3 + $5), $8, $9 * 2 * 2/ ($3 + $5) }' |sort -t '  ' +2 -3g > temp.sex-chr.1.txt
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % head temp.sex-chr.1.txt
GTEX-13RTL-0826-SM-DO3WZ        chrX    0.921223        chrY    0.556425
GTEX-11DYG-0004-SM-6WBTB        chrX    0.923365        chrY    0.823456
GTEX-1QAET-1426-SM-DLT2N        chrX    0.927738        chrY    0.653464
> dps <- read.delim("temp.sex-chr.1.txt", head = F)
 summary(dps)
 dim(dps)
# [1] 838   5
 plot(0,0, xlim=c(0, 850), ylim = c(0,3), col="white", xlab="donor", ylab="copy #")
 points(1:dim(dps)[1], dps$V3, pch = 1, col = "black", cex = 0.5)
 points(1:dim(dps)[1], dps$V5, pch = 1, col = "red", cex = 0.5)
 abline(h = seq(0, 100, 0.25), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(0, 1000, 100), lty = 5, lwd = 0.5, col = "gray")
 abline(v = 558, lty = 5, lwd = 0.5, col = "blue")
 legend(0, 3, legend=c("chrY", "chrX"), col = c("red", "black"), pch = 1, cex = 1)

> head(dps[ dps$V3 > 1.5, ])
#                           V1   V2      V3   V4        V5
# 558 GTEX-1269C-1826-SM-DO3X2 chrX 1.65363 chrY 0.0481691
# 559  GTEX-OHPL-2626-SM-DO3X3 chrX 1.73175 chrY 0.0790194
# 560  GTEX-YJ8O-1026-SM-DMRPU chrX 1.76430 chrY 0.0820557
> 558/838
# [1] 0.6658711
> dps.f <- dps[ dps$V3 > 1.5, ]
 dps.m <- dps[ dps$V3 <= 1.5, ]

##################################################################################
linyong@fry /lab/solexa_page/linyong/gtex-dna-test$ bash script-cnv-01 > temp.txt
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, $10, $12 * 2 * 2/ ($3 + $5)}' | sort -t '   ' +2 -3g > temp.c3.txt
==> temp.txt <==
GTEX-111YS-0004-SM-6WBTN        chr19   32.8933 chr21   33.02   chrX    16.5161 chrY    14.1011 C3      chr19   34.0805 C4A     chr6    39.7287 C4B     chr6    39.5554

==> temp.c3.txt <==
GTEX-NPJ8-0004-SM-CLTG5 C3      0.639854

> t1 <- read.delim("temp.c3.txt", header=F)
 dim(t1)
# [1] 838   3
 summary(t1$V3)
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
#  0.6399  2.0034  2.1788  2.1645  2.3351  3.1338
 plot(0,0, xlim=c(0, 850), ylim = c(0,4), col="white", xlab="donor", ylab="C3 gene copy #")
 points(1:dim(t1)[1], t1$V3, pch = 1, col = "black", cex = 1)
  abline(h = seq(0, 100, 0.5), lty = 5, lwd = 0.5, col = "gray")
  abline(v = seq(0, 1000, 50), lty = 5, lwd = 0.5, col = "gray")

> med <- median(t1$V3)
 plot(0,0, xlim=c(0, 850), ylim = c(0,4), col="white", xlab="donor", ylab="C3 gene copy #")
 points(1:dim(t1)[1], t1$V3/med * 2, pch = 1, col = "black", cex = 1)
 abline(h = seq(0, 100, 0.5), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(0, 1000, 50), lty = 5, lwd = 0.5, col = "gray")

 boxplot(t1$V3/med * 2,outcol="white", ylab="C3 gene copy #")
 beeswarm(t1$V3/med * 2, add=T, cex=0.4)
 abline(h = seq(0, 100, 0.5), lty = 5, lwd = 0.5, col = "gray")

###################################################################
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, "C4-tot", ($15 + $18) * 2 * 2/ ($3 + $5)}'  | sort -t '     ' +2 -3g > temp.c4.txt

> t2 <- read.delim("temp.c4.txt", header=F)
 dim(t2)
# [1] 838   3
 summary(t2$V3)
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
#   1.622   3.755   4.527   4.537   5.279  11.308


linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cp -i temp.txt cnv.dna.depth.gtex.donors.txt

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % head  cnv.dna.depth.gtex.donors.txt
GTEX-111YS-0004-SM-6WBTN        chr19   32.8933 chr21   33.02   chrX    16.5161 chrY    14.1011 C3      chr19   34.0805 C4A     chr6    39.7287 C4B     chr6    39.5554
GTEX-113IC-0001-SM-DLIPU        chr12   40.5283 chr8    40.6177 chrX    20.3759 chrY    17.5418 C3      chr19   40.5403 C4A     chr6    35.0843 C4B     chr6    36.1179

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat cnv.dna.depth.gtex.donors.txt  | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, "C4-tot", ($15 + $18) * 2 * 2/ ($3 + $5)}'  | sort -t '       ' +2 -3g > temp.c4.txt

> hist(t2$V3, breaks=seq(0.05,12.05,0.1), xlab="C4A+C4B copy #", probability=T, main="GTEx v8 donors")
 abline(v = seq(0, 1000, 1), lty = 5, lwd = 0.5, col = "blue")
 d <- density(t2$V3, bw = 0.1)
 lines(d$x, d$y, col="red")

#######################################################c4a-c4b-total cn ~ gene expression
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat cnv.dna.depth.gtex.donors.txt  | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, "C4-tot", ($15 + $18) * 2 * 2/ ($3 + $5)}'  | sort -t '       ' +2 -3g > temp.c4.txt
>  t2 <- read.delim("temp.c4.txt", header=F)
 summary(t2)
 info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
 info$sid <-  gsub("-", ".", info$SAMPID)
 info$sid <-  paste( info$sid, ".", sep="")
 t3 <- merge(t2, info, by.x="V1", by.y="SAMPID")
 dim(t3)
# [1] 838   9
 c4.cn <- t3
###cmds from script-gtexv8-tissue-sex-diff-age-bmi-covar
###Liver	226

diff <- as.data.frame(cpm(y))
gene.name <- raw[, 1:2]
 gene.name[ gene.name$name %in% c("C4A", "C4B"),]
#                   geneID name
# 25277  ENSG00000224389.9  C4B
# 37237 ENSG00000244731.10  C4A

 g1 <- gene.name[ gene.name$name %in% c("C4A", "C4B"),]$geneID
 g2 <- as.data.frame( t(diff[ rownames(diff) %in% g1,]))
 str(g2)
 g2$sample <- rownames(g2)
 g3 <- merge(g2, info, by.x="sample", by.y="sid")
 dim(g3)
 g4 <- merge(g3, c4.cn, by.x="SUBJID", by.y="SUBJID")
 dim(g4)
# [1] 208  17
# > 208/226
# [1] 0.920354
 g4$C4.tot.exp <-  g4$ENSG00000224389.9 + g4$ENSG00000244731.10
 cor.test(g4$V3, log10(g4$ENSG00000244731.10), method="spearman" )
 cor.test(g4$V3, log10(g4$ENSG00000244731.10) )
 cor.test(g4$V3, log10(g4$ENSG00000224389.9), method="spearman" )
 cor.test(g4$V3, log10(g4$ENSG00000224389.9) )
 cor.test(g4$V3, log10(g4$C4.tot.exp), method="spearman" )
 cor.test(g4$V3, log10(g4$C4.tot.exp))

> cor.test(g4$V3, log10(g4$ENSG00000244731.10), method="spearman" )
S = 1182606, p-value = 0.002208
0.2114825 

> cor.test(g4$V3, log10(g4$ENSG00000244731.10) )
t = 4.0553, df = 206, p-value = 7.099e-05
0.2719035 

> cor.test(g4$V3, log10(g4$ENSG00000224389.9), method="spearman" )
S = 1422348, p-value = 0.4586
0.05163143 

> cor.test(g4$V3, log10(g4$ENSG00000224389.9) )
t = 0.52337, df = 206, p-value = 0.6013
0.03644036 

> cor.test(g4$V3, log10(g4$C4.tot.exp), method="spearman" )
S = 1320500, p-value = 0.08547
0.1195399 

> cor.test(g4$V3, log10(g4$C4.tot.exp))
t = 1.6992, df = 206, p-value = 0.09079
0.1175687 

#####################################################Brain - Frontal Cortex (BA9)	209
	Spearman's rank correlation rho

data:  g4$V3 and log10(g4$ENSG00000244731.10)
S = 697084, p-value = 0.00357
alternative hypothesis: true rho is not equal to 0
sample estimates:
      rho 
0.2195656 

	Pearson's product-moment correlation

data:  g4$V3 and log10(g4$ENSG00000244731.10)
t = 3.5797, df = 173, p-value = 0.0004466
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.118895 0.395541
sample estimates:
      cor 
0.2626065 
#####################################################Brain - Anterior cingulate cortex (BA24)	176
	Spearman's rank correlation rho

data:  g4$V3 and log10(g4$ENSG00000244731.10)
S = 446164, p-value = 0.05727
alternative hypothesis: true rho is not equal to 0
sample estimates:
      rho 
0.1572207 

	Pearson's product-moment correlation

data:  g4$V3 and log10(g4$ENSG00000244731.10)
t = 2.1636, df = 145, p-value = 0.03213
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.01539097 0.32930886
sample estimates:
      cor 
0.1768436 

##################################################Muscle - Skeletal	799
##################################################C4B not expressed
	Spearman's rank correlation rho

data:  g4$V3 and g4$ENSG00000244731.10
S = 46058574, p-value = 7.626e-08
alternative hypothesis: true rho is not equal to 0
sample estimates:
      rho 
0.2011757 

	Pearson's product-moment correlation

data:  g4$V3 and log10(g4$ENSG00000244731.10 + 1)
t = 3.1206, df = 700, p-value = 0.001879
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.04351613 0.18949077
sample estimates:
      cor 
0.1171361 


####################################################
cat cnv.dna.depth.gtex.donors.exon.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, "C4-tot", ($15 + $18) * 2 * 2/ ($3 + $5),
"C4Aexon172bp", $24, $26, $29, $27 * 2 * 2 / ($3 + $5), "C4Bexon172bp", $35, $37, $40, $38 * 2 * 2 / ($3 + $5);
}' > temp.c4.txt

> t2 <- read.delim("temp.c4.txt", header=F)
> summary(t2$V3)
c4a + c4b total
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
  1.622   3.755   4.527   4.537   5.279  11.308
> summary(t2$V8)
c4a exon cn
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
  0.000   2.191   2.794   2.877   3.544   7.689
> summary(t2$V13)
c4b exon cn
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
  0.000   1.716   2.330   2.296   2.796   5.630

###############################
> g4$c4a.der <- (g4$V3 - 0.9518 - 0.5927 * g4$V13 ) / 0.7734
g4$c4b.der <-   (g4$V3 - 0.9518 - 0.7734 * g4$V8 ) / 0.5927 

########################################boxplot FAO-gene-set FATTY_ACID_METABOLISM genes' ranks in 3 tissues
> f <- "/Users/linyongmao/Documents/dir-GTExV8/diff2-1-muscle-FvsM.age-bmi-covar.aa-LV-mus-270.noX.Y.rnk"
 str <- paste("cat", f, " | sort -t \'", "\'", "+1 -2gr", " > temp1", sep="\t")
 system(str)
 t1 <- read.delim("temp1", header=F)
 t1$r.1 <- 1:dim(t1)[1]
 t1$rank <- t1$r.1 / dim(t1)[1]
 summary(t1)
>  fao <- scan(what="", sep = "\n")
 f="/Users/linyongmao/Documents//microglia/HALLMARK_FATTY_ACID_METABOLISM.genes"
 fat <- read.delim(f, header=F)
 li <- list()
 li[[1]] <- t1[ t1$V1 %in% fao,]$rank
 names(li)[1] <- "muscle FAO"
 li[["muscle h_FA_metab"]] <- t1[ t1$V1 %in% fat$V1,]$rank

f <- "/Users/linyongmao/Documents/dir-GTExV8/diff2-1-left-ventricle-FvsM.age-bmi-covar.aa-LV-mus-270.noX.Y.rnk"
 str <- paste("cat", f, " | sort -t \'", "\'", "+1 -2gr", " > temp1", sep="\t")
 system(str)
 t1 <- read.delim("temp1", header=F)
 t1$r.1 <- 1:dim(t1)[1]
 t1$rank <- t1$r.1 / dim(t1)[1]
 summary(t1)
 li[["LV FAO"]] <- t1[ t1$V1 %in% fao,]$rank
 li[["LV h_FA_metab"]] <- t1[ t1$V1 %in% fat$V1,]$rank

f <- "/Users/linyongmao/Documents/dir-GTExV8/diff2-1-Heart-Atrial-Appendage-FvsM.age-bmi-covar.aa-LV-mus-270.noX.Y.rnk"
 str <- paste("cat", f, " | sort -t \'", "\'", "+1 -2gr", " > temp1", sep="\t")
 system(str)
 t1 <- read.delim("temp1", header=F)
 t1$r.1 <- 1:dim(t1)[1]
 t1$rank <- t1$r.1 / dim(t1)[1]
 summary(t1)
 li[["AA FAO"]] <- t1[ t1$V1 %in% fao,]$rank
 li[["AA h_FA_metab"]] <- t1[ t1$V1 %in% fat$V1,]$rank

 par( mar=c(6,8,2,2))
 boxplot(li, horizontal=T, xlab="rank normalized by expr. genes", yaxt="n")
 axis(side=2, at = 1:6, labels=names(li), las =1, cex.axis = 0.8)
 abline(v = seq(0,100,0.1), lty = 5, lwd = 0.5, col = "gray")
 abline(v = 0.5,  col = "blue")
> t.test(li[[1]], mu=0.5)
t.test(li[[2]], mu=0.5)
t.test(li[[3]], mu=0.5)
t.test(li[[4]], mu=0.5)
t.test(li[[5]], mu=0.5)
t.test(li[[6]], mu=0.5)
> wilcox.test(li[[1]], mu=0.5)

#############################################################################
> plot(res.2$mean ~ res.2$age_value, xlab = "age", ylab="pathway-level z-score of 20 FAO genes", col="white")
 points(res.m$mean ~ res.m$age_value, col="purple4")
 abline(lm(res.m$mean ~ res.m$age_value), col="purple4")
 points(res.f$mean ~ res.f$age_value, col="orange")
 abline(lm(res.f$mean ~ res.f$age_value), col= "orange")
 legend(20, -1.8, col=c("orange", "purple4"), c("Female", "Male"), pch = c(1, 1))
> res.2$sex = factor(res.2$SEX, levels=c(1,2), labels=c("Male", "Female"))
> write.table( res.2[, c(1,2,3,12)], "temp.LV-pathway-z-score-fao20genes.txt", sep="\t", quote=F )

#############################################################################
t1="../microglia/HALLMARK_APOPTOSIS.genes"
t2 <- read.delim(t1, header=F)
fao <- t2$V1

 gene.name <- raw[, 1:2]
 head(gene.name)
#               geneID     name
# 1 ENSG00000000003.15   TSPAN6
###a is z-score of log10(cpm+1)
 dim(a)
 a.df <- as.data.frame(a)
 a.df$id <- row.names(a.df)
 a.df.g <- merge(a.df, gene.name, by.x="id", by.y="geneID")
 dim(a.df.g)
 p.exp <- a.df.g[ a.df.g$name %in% fao, ]
 length(p.exp$name)
# [1] 20
 mat <- as.matrix(p.exp[, 2:429])
 dim(mat)
# [1]  20 428
 res <- data.frame(id = colnames(mat), mean = colMeans(mat))
 dim(res)
# [1] 428   2
 head(res)
 summary(res)
 p.exp[, 430]
 info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
  info$sid <-  gsub("-", ".", info$SAMPID)
  info$sid <-  paste( info$sid, ".", sep="")
  t5 <- read.delim("gtex-981subjects-tsvs/subject.tsv")
  info3 <- t5[, c(16,31,46, 106)]
  info4 <- merge(info, info3, by.x="SUBJID", by.y="source_subject_id")
 dim(info4)
# [1] 22951    10
 head(info4)
#       SUBJID                        SAMPID   SUBJID.1 SEX   AGE DTHHRDY                            sid age_value body_mass_index height
# 1 GTEX-1117F      GTEX-1117F-0003-SM-58Q7G GTEX-1117F   2 60-69       4      GTEX.1117F.0003.SM.58Q7G.        66           32.12     66
 res.2 <- merge(res, info4, by.x="id", by.y="sid")
 dim(res.2)
# [1] 428  11
 head(res.2)
 res.f <- res.2[ res.2$SEX == 2,]
 res.m <- res.2[ res.2$SEX == 1,]
 dim(res.f)
# [1] 137  11
 dim(res.m)
# [1] 291  11
 lr <- lm(res.f$mean ~ res.f$age_value)
 lr.1 <- summary(lr)
 lr.1
 lr <- lm(res.m$mean ~ res.m$age_value)
 lr.1 <- summary(lr)
 lr.1

 lr <- lm(res.2$mean ~ res.2$age_value)
 lr.1 <- summary(lr)
 lr.1

#####################################################The 270 donors shared among all three tissues – LV, AA and muscle
###########################metadata 
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 %  cat gtex-981subjects-tsvs/subject.tsv | cut -f 21| sort | uniq -c
   2 
   3 ['American_20_Indian_20_or_20_Alaska_20_Native']
  12 ['Asian']
 124 ['Black_20_or_20_African_20_American']
   8 ['Unknown']
 832 ['White']
   1 ancestry

> info3 <- t5[, c(16,21, 31,46, 106, 122)]
dim(info3)
summary(info3)
 info.2$ageV = 0
 info.2$bmi = 0
 info.2$ancestry = "NA"
 info.2$im.death = "NA"
 info4 <- merge(info.2, info3, by.x="SUBJID", by.y="source_subject_id")
 dim(info4)
# [1] 429  12
for(i in 1:dim(y)[2]) {
 t1 <- info.2[i,]$SUBJID
 info.2[i,]$ageV = info4[ info4$SUBJID == t1,]$age_value[1]
 info.2[i,]$bmi = info4[ info4$SUBJID == t1,]$body_mass_index[1]
 info.2[i,]$ancestry = info4[ info4$SUBJID == t1,]$ancestry.y[1]
 info.2[i,]$im.death = info4[ info4$SUBJID == t1,]$immediate_cause_of_death[1]
 }
 identical(info.2$sid, y.cn)
 info.f <- info.2[ info.2$SEX == 2,]
 info.m <- info.2[ info.2$SEX == 1,]
 dim(info.f)
# [1] 87 10
 dim(info.m)
# [1] 183  10
> write.table(info.2, "temp", sep="\t", quote=F)
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % vi temp

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat gtex-981subjects-tsvs/subject.tsv | head -1 | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print i, $i}'  | grep -i death | grep -i cause
85	first_cause_of_death
122	immediate_cause_of_death
####130	last_cause_of_death

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 %  cat gtex-981subjects-tsvs/subject.tsv | cut -f 130 | grep -i heart | wc -l
       0
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 %  cat gtex-981subjects-tsvs/subject.tsv | cut -f 122 | grep -i heart | wc -l
      93
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 %  cat gtex-981subjects-tsvs/subject.tsv | cut -f 85 | grep -i heart | wc -l 
      16
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 %  cat gtex-981subjects-tsvs/subject.tsv | cut -f 122 | grep -i heart | sort | uniq -c
  82 heart disease
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 %  cat gtex-981subjects-tsvs/subject.tsv | cut -f 122 | sort | uniq -c | sort -g | awk '$1 > 9'
  10 trauma
  11 arrest; cardiac
  11 stroke
  13 respiratory failure
  13 vascular cerebral accident
  14 cva
  17 
  19 respiratory disease
  23 cerebrovascular/stroke
  24 cerebral vascular accident
  30 Head Trauma
  37 cva/stroke
  44 Anoxia
  59 head trauma
  65 CVA
  82 heart disease
  95 anoxia
  97 cardiac arrest

#############################################################################
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat age-bmi-ancestry-death.LV.428donor.txt| cut -f 4,11 |awk '$1 == 1' |grep -i "heart" | wc -l
      35
cat age-bmi-ancestry-death.LV.428donor.txt| cut -f 4,11 |awk '$1 == 1' |grep -i "cardi[ao]" | wc -l    
      63
291 male
(35 + 63) / 291 = 0.3367698

cat age-bmi-ancestry-death.LV.428donor.txt| cut -f 4,11 |awk '$1 == 2' |grep -i "heart" | wc -l
       7
cat age-bmi-ancestry-death.LV.428donor.txt| cut -f 4,11 |awk '$1 == 2' |grep -i "cardi[ao]" | wc -l
       8
137 female
15 / 137 = 0.1094891

> res.info$death = "NA"
 t1 <- grep("heart", res.info$im.death, ignore.case=T)
 res.info[t1,]$death = "heart disease"
 res.info[ res.info$death == "heart disease",]
 dim(res.info[ res.info$death == "heart disease",])
# [1] 42 13
 t1 <- grep("cardia", res.info$im.death, ignore.case=T)
 res.info[t1,]$death = "cardi"
 t1 <- grep("cardio", res.info$im.death, ignore.case=T)
 res.info[t1,]$death = "cardi"
 dim(res.info[ res.info$death == "cardi",])
# [1] 71 13
 (res.info[ res.info$death == "cardi",10:13])
 res.info$cater = paste(res.info$SEX, res.info$death, sep="_")
 boxplot(res.info$mean ~ res.info$cater, col=c(rep("purple4", 3), rep("orange", 3)))

res.info$death2 = res.info$death
res.info[ res.info$death == "cardi",]$death2 = "heart disease"
res.info$cater2 = paste(res.info$SEX, res.info$death2, sep="_")

#############################################################boxplot pathway-level z-score F_heart_disease, F_others, M_heart_disease, M_others
> head(info.2, n = 2)
#       SUBJID                   SAMPID   SUBJID.1 SEX   AGE DTHHRDY                       sid ageV   bmi  ancestry       im.death
# 1 GTEX-113JC GTEX-113JC-2726-SM-5EGIS GTEX-113JC   2 50-59       2 GTEX.113JC.2726.SM.5EGIS.   53 27.99 ['White']            CVA
# 2 GTEX-11DXY GTEX-11DXY-2726-SM-5GID2 GTEX-11DXY   1 60-69       2 GTEX.11DXY.2726.SM.5GID2.   62 20.67 ['White'] cardiac arrest

info.2$death = "NA"
 t1 <- grep("heart", info.2$im.death, ignore.case=T)
 info.2[t1,]$death = "heart disease"
# [1] 42 13
 t1 <- grep("cardia", info.2$im.death, ignore.case=T)
 info.2[t1,]$death = "heart disease"
 t1 <- grep("cardio", info.2$im.death, ignore.case=T)
 info.2[t1,]$death = "heart disease"

 dim(info.2[ info.2$death == "heart disease",])
 res.info <- merge(res, info.2, by.x="id", by.y="sid")
 summary(res.info)
 res.info$cater <- paste(res.info$SEX, res.info$death, sep="_")
 boxplot(res.info$mean ~ res.info$cater, col=c(rep("purple4", 2), rep("orange", 3)))
 abline(h = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 t1 <- res.info[ res.info$cater == "1_heart disease",]$mean
 length(t1)
 t2 <- res.info[ res.info$cater == "1_NA",]$mean
 length(t2)
 t3 <- res.info[ res.info$cater == "2_heart disease",]$mean
 length(t3)
 t4 <- res.info[ res.info$cater == "2_NA",]$mean
 length(t4)
 t.test(t1, t3)
 t.test(t2, t4)
###############################barplot NES, five pathways (column), two stat model (rows)
> t1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/Heart-Atrial-Appendage-FvsM.noX.Y.age-bmi-Hdisease-covar-weight0-FAO.GseaPreranked.1704216422963/gsea_report_for_na_pos_1704216422963.tsv")
 t2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/Heart-Atrial-Appendage-FvsM.noX.Y.age-bmi-covar-weight0-FAO.GseaPreranked.1698075308261/gsea_report_for_na_pos_1698075308261.tsv")
  paths <- t2$NAME[1:5]
 paths
# [1] "HALLMARK_OXIDATIVE_PHOSPHORYLATION" "HALLMARK_ADIPOGENESIS"              "HALLMARK_FATTY_ACID_METABOLISM"     "FAO"
 t1$test.set = "heart-AA-H-dis-covar"
 t2$test.set = "heart-AA"
 pva <- data.frame(matrix(NA, 2, 5))
 li <- list(t1,t2)
 for(i in 1:length(paths)) {
  for(j in 1:length(li)){
 tem <- li[[j]]
 rownames(pva)[j] = tem$test.set[1]
 colnames(pva)[i] = paths[i]
 pva[j,i] =tem[ tem$NAME == paths[i],]$NES
 }
}

pva
 nam <- colnames(pva)
 nam <- gsub(".*/", "", nam)
 nam <- gsub("FAO", "FAO 20 genes", nam)

 or <- data.frame(matrix(NA, 2, 5))
 li <- list(t1,t2)
 for(i in 1:length(paths)) {
  for(j in 1:length(li)){
 tem <- li[[j]]
 rownames(or)[j] = tem$test.set[1]
 colnames(or)[i] = paths[i]
 or[j,i] =tem[ tem$NAME == paths[i],]$FDR.q.val
 }
}
 par( mar=c(6,16,2,2))
 barplot(as.matrix( pva), horiz=T, beside=T,  xlab="NES (F vs. M)", yaxt = "n", col=c("green",  "red"))
 axis(side=2, at = seq(2, 14, by=3), labels=nam, las =1, cex.axis = 0.7)
 text(pva[1,] , seq(1.5, 1.5+3*4, by=3), paste("FDR=", format(or[1,], digits=3), sep=""), pos=4, col = "green")
 text(pva[2,] , seq(2.5, 2.5+3*4, by=3), paste("FDR=", format(or[2,], digits=3), sep=""), pos=4, col = "red")
 legend(5.5, 11, rownames(pva), fill=c("green", "red"), cex = 0.6, inset = 0.05)

###############################genecode v26 v42 conversion, mash
> mash <- read.delim("~/Downloads/GTEx_Analysis_v8_sbgenes/effect_size.tsv")
>  summary(mash[, c(28:29, 34)])
 Heart_Atrial_Appendage Heart_Left_Ventricle Muscle_Skeletal
 Min.   :-1.792         Min.   :-2.277       Min.   :-2.543
 1st Qu.:-0.012         1st Qu.:-0.014       1st Qu.:-0.020
 Median : 0.000         Median : 0.000       Median : 0.000
 Mean   : 0.002         Mean   : 0.001       Mean   : 0.000
 3rd Qu.: 0.012         3rd Qu.: 0.014       3rd Qu.: 0.019
 Max.   : 9.398         Max.   : 8.742       Max.   : 9.571
 NA's   :12237          NA's   :14078        NA's   :14400
> dim(mash)
[1] 35431    44
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat ~/Downloads/GTEx_Analysis_v8_sbgenes/effect_size.tsv | cut -f 1 | sed 's/ENSG[0-9]*//' |sort | uniq
.1
.10
.11
.12
...
.9

 left <- mash[,c(28:29, 34)]
 left$id <- rownames(left)
> write.table(left, "temp1", quote=F, sep="\t")
vi temp1
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % /Users/linyongmao/Documents/microglia/scrnaseq-metaannot-combine    temp1  gencode.v42.primary_assembly.noPar.geneID-name.2 out
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % paste   temp1    out | grep -vw notApplicable | wc
   34961  209766 3034552
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % paste   temp1    out | grep -vw notApplicable > temp2
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % mv -i temp2 gencodeV26.id.v42.name
 t1 <- read.delim("gencodeV26.id.v42.name")
 t2 <- read.delim("gencode.v42.primary_assembly.noPar.gene-chr-type.2")
 t3 <- merge(t1, t2, by.x="geneID", by.y="geneID")
 dim(t3)
[1] 34960     9
> dim(t1)
[1] 34960     6
> dim(t2)
[1] 62703     4
> left.gene <- merge(left, t3, by.x="id", by.y="id")
> dim(left)
[1] 35431     3
> dim(left.gene)
[1] 34960    11

> write.table(left.gene[,c(2,9,10)], "temp1", quote=F, sep="\t")
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % vi temp1
cat temp1 |  awk 'BEGIN {FS = "\t"} !($3 == "chrX" || $3 == "chrY") && $1 != "NA" ' > temp2
cat temp2 | awk 'BEGIN {FS = "\t"; OFS = "\t";} {print $2, 999, 0,0,$1, 0, $2, $2 }' > temp3
../microglia/make-rnk-genesymble.2 temp3 mash.Heart-Atrial-Appendage-FvsM.noX.Y.rnk


bash /Users/linyongmao/Documents/GSEA_4.1.0/gsea-cli.sh  GSEAPreranked -gmx    fao.gmt    -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk   diff2-1-left-ventricle-FvsM.age-bmi-covar.noX.Y.rnk  -scoring_scheme classic  -rpt_label   "left-ventricle-FvsM.noX.Y.age-bmi-covar-weight0-FAO"  -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 500  -zip_report false -out  "/Users/linyongmao/gsea_home/output/microgliaSex"

 lfsr <-  read.delim("~/Downloads/GTEx_Analysis_v8_sbgenes/LFSR.tsv")
 lfsr.l <- lfsr[ , c(28:29, 34)]
 lfsr.l$id <- rownames(lfsr.l)
 eff.p <- merge(left, lfsr.l, by.x="id", by.y="id")
 dim(eff.p)
# [1] 35431     7
 eff.p.g <- merge(eff.p, t3, by.x="id", by.y="id")
 dim(eff.p.g)
# [1] 34960    15
> write.table( eff.p.g[,c(4,7,12,13)], "temp1", quote=F, sep="\t")
vi temp1
cat temp1 |  awk 'BEGIN {FS = "\t"} !($4 == "chrX" || $4 == "chrY") && $1 != "NA" && $2 != "NA" ' > temp2
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat  temp2 | cut -f 1 | sort | uniq -d | wc
       0       0       0
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat  temp2 | cut -f 2 | sort | uniq -c | awk '$1 > 1'
   2 -2.22044604925031e-16
  15 0
   6 1.11022302462516e-16
   2 2.22044604925031e-16

cat temp2 | awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""}
    {
     if(NR == 1)
       print $0 "\n";
     else
     {
      if($2 < 0)
        $2 = -$2;

      if($2 == 0 || $2 == -0)
        $2 = 1.0e-99

      print $1 "\t" $2 "\t" $3 "\t" $4 "\n";
     }
    }' > temp2b

diff  temp2 temp2b | wc -l    

cat temp2b | awk 'BEGIN {FS = "\t"; OFS = "\t";}  {print $3, $1, 999, 999, $2, $2, $3, $3}'  > temp3
../microglia/make-rnk-genesymble temp3 mash.lfsr.muscle-FvsM.noX.Y.rnk

cut -f 2 mash.lfsr.muscle-FvsM.noX.Y.rnk | sort -g | uniq -c | head
cut -f 2 mash.lfsr.muscle-FvsM.noX.Y.rnk | sort -g | uniq -c | tail

#############################################################################
> f1 = "file:///Users/linyongmao/gsea_home/output/microgliaSex/mash.lfsr.left-ventricle-FvsM.noX.Y.weight0-FAO.GseaPreranked.1704697827899/gsea_report_for_na_neg_1704697827899.tsv"
 p <- read.delim(f1)
 paths <- p$NAME
> f="mash.lfsr.left-ventricle-FvsM.noX.Y.rnk"
str <- paste("cat", f, " | sort -t \'", "\'", "+1 -2gr", " > temp1", sep="\t")
 system(str)
 t1 <- read.delim("temp1", header=F)
 t1$r.1 <- 1:dim(t1)[1]
 t1$rank <- t1$r.1 / dim(t1)[1]
 summary(t1)
 t1.rank <- t1
 li <- list()

for(i in 1:length(paths)) {
 f <- paste("/Users/linyongmao/Documents//microglia/", paths[i], ".genes", sep ="")
 fat <- read.delim(f, header=F)
 li[[i]] <- t1.rank[ t1.rank$V1 %in% fat$V1,]$rank
 names(li)[i] <- paths[i]
}

 par( mar=c(6,10,2,2))
  boxplot(li, horizontal=T, xlab="rank normalized by expr. genes", yaxt="n")
  axis(side=2, at = 1:length(paths), labels=names(li), las =1, cex.axis = 0.5)
  abline(v = seq(0,100,0.05), lty = 5, lwd = 0.5, col = "gray")
  abline(v = 0.5,  col = "blue")
 text(0.1, 1:length(paths) + 0.2, paste("NES=", format(p$NES, digits=2), sep="" ), pos = 4, col="blue", cex = 0.7 )
 title(main = "mash.lfsr.left-ventricle-FvsM.noX.Y.rnk")

p$t.test = 999
p$est = 999
for(i in 1:length(paths)) {
 test <- t.test(li[[i]], mu=0.5)
 p$t.test[i] <- test$p.value
 p$est[i] <- test$estimate
}

 p[, c(1,4,6:8,13,14)]

#########################################################################################################################

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat /Users/linyongmao/Downloads/GOBP_FATTY_ACID_BIOSYNTHETIC_PROCESS.v2023.2.Hs.gmt >> fao.gmt

####################################################x="P-lab NES, left-ventricle-FvsM.age-bmi-covar.noX.Y", y = "NES, mash.lfsr.left-ventricle-FvsM.noX.Y"
 t1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/temp-fa-syn-mash.lfsr.left-ventricle-FvsM.noX.Y.weight0-FAO.GseaPreranked.1705100521041/gsea_report_for_na_pos_1705100521041.tsv")
 t2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/temp-fa-syn-mash.lfsr.left-ventricle-FvsM.noX.Y.weight0-FAO.GseaPreranked.1705100521041/gsea_report_for_na_neg_1705100521041.tsv")
 mash.lv <- rbind(t1,t2)
 t1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/temp-fa-syn-left-ventricle-FvsM.noX.Y.age-bmi-covar-weight0-FAO.GseaPreranked.1705102308759/gsea_report_for_na_pos_1705102308759.tsv")
 t2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/temp-fa-syn-left-ventricle-FvsM.noX.Y.age-bmi-covar-weight0-FAO.GseaPreranked.1705102308759/gsea_report_for_na_neg_1705102308759.tsv")
 plab.lv <- rbind(t1, t2)

t1 <- merge(plab.lv, mash.lv, by.x="NAME", by.y="NAME")
 head(t1)
#                                   NAME       GS.br..follow.link.to.MSigDB.x GS.DETAILS.x SIZE.x        ES.x     NES.x NOM.p.val.x FDR.q.val.x FWER.p.val.x
# 1                                  FAO                                  FAO  Details ...     20  0.35796925  1.915233 0.005940594 0.018437775        0.190
 dim(t1)
# [1] 52-pathways 23 fields
#top 6 positive and  negative pathways from one approach
n1 <- t1[ t1$NES.x > 2.5 | t1$NES.x < -3,]$NAME
#top 6 postive and  negative pathways from 2nd approach
n2 <- t1[ t1$NES.y > 2.4 | t1$NES.y < -1.8,]$NAME
n3 <- unique( c(n1, n2))
t2 <- t1[ t1$NAME %in% n3,]
t3 <- t2[ abs(t2$NES.x) > 1.7 & abs(t2$NES.y) > 1.7,]
> ggplot(t1, aes(x=NES.x, y=NES.y, label=NAME) ) + geom_point(size=1) + geom_text_repel(show.legend=T, data=t3, size=2.2, max.overlaps=100, min.segment.length = 0.1) + labs(x="P-lab NES, left-ventricle-FvsM.age-bmi-covar.noX.Y", y = "NES, mash.lfsr.left-ventricle-FvsM.noX.Y") + geom_hline(yintercept=0, col="blue") + geom_vline(xintercept=0, col="blue")
> ggplot(t1, aes(x=NES.x, y=NES.y, label=NAME) ) + geom_point(size=1) + geom_text_repel(show.legend=T, data=t2, size=2.2, max.overlaps=100, min.segment.length = 0.1) 
+ labs(x="P-lab NES, left-ventricle-FvsM.age-bmi-covar.noX.Y", y = "NES, mash.lfsr.left-ventricle-FvsM.noX.Y") + geom_hline(yintercept=0, col="blue") 
+ geom_vline(xintercept=0, col="blue") + geom_text_repel(show.legend=T, data=t3 (t3 refers to a single point), size=2.2, max.overlaps=100, min.segment.length = 0.1, col="red") 
+ scale_x_continuous(breaks=seq(-10, 10, 1), minor_breaks=NULL)

#############################################################################
> t1 <- read.delim("diff2-1-left-ventricle-FvsM.age-bmi-covar.noX.Y.rnk", header=F)
 t2 <- read.delim("mash.lfsr.left-ventricle-FvsM.noX.Y.rnk", header=F)
 p.mash <- merge(t1, t2, by.x="V1", by.y="V1")
 dim(p.mash)
# [1] 14388     3
 dim(t1)
# [1] 14783     2
 dim(t2)
# [1] 20455     2
 g <- read.delim("/Users/linyongmao/Documents/microglia/fao.genes", header=F)
 p.mash.g <- p.mash[ p.mash$V1 %in% g$V1,]
 dim(p.mash.g)
 cor1 <- cor.test(p.mash.g$V2.x, p.mash.g$V2.y,method="pearson")
 tit = paste("FAO 20 genes: ", "r=",round(cor1$estimate, digits = 3), ", p=", format(cor1$p.value, digits=3), " (Pearson)", sep ="")
> ggplot(p.mash.g, aes(x=V2.x, y=V2.y, label=V1) ) + geom_point(size=1.5, col="red") + geom_smooth(se=T, method="lm") + geom_text_repel(show.legend=T, data=p.mash.g, size=2.2, max.overlaps=100, min.segment.length = 0.1) + geom_hline(yintercept=0, col="black", size = 0.25) + geom_vline(xintercept=0, col="black", size=0.25) + labs(x="P-lab signed log10(p-value), left-ventricle-FvsM.age-bmi-covar", y = "signed log10(p-value), mash.lfsr.left-ventricle-FvsM", title=tit) + scale_x_continuous(breaks=seq(-5, 6, 1), limits=c(-6,6)) + scale_y_continuous(breaks=seq(
-5, 6, 1), limits=c(-6,6))

#############################################################################
 g <- c("DDX3X", "ZFX", "CPT1A", "CPT1B", "ACADL", "CD36", "PPARA", "PPARGC1A")
 eff.p.g[ eff.p.g$name %in% g,] 
 eff.p.g[ eff.p.g$name %in% g, c(1,3,6, 12,13)]
#                       id Heart_Left_Ventricle.x Heart_Left_Ventricle.y     name   chr 
# 111   ENSG00000005889.15             0.64211254           0.000000e+00      ZFX  chrX
# 3671   ENSG00000109819.8             0.04669970           7.973397e-02 PPARGC1A  chr4
> t5 <- read.delim("diff2-1-left-ventricle-FvsM.age-bmi-covar.2.txt")
> tem <- t5[ t5$name %in% g,]

#############################################################################
> info3 <- t5[, c(16,21, 31,46, 106, 85, 120, 122, 125, 126, 127, 130)]
#   age_value  ancestry body_mass_index source_subject_id height   first_cause_of_death icd10_cause_of_death immediate_cause_of_death interval_to_death_first_cause
 info5 <- merge(info.2, info3, by.x="SUBJID", by.y="source_subject_id")
 dim(info.2)
# [1] 429   7
 dim(info3)
# [1] 981  12
 dim(info5)
# [1] 429  18
> write.table(info5, "heart-aa-metadata-deaths.txt", quote=F, sep="\t")
# heart-lv-metadata-deaths.txt
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cut -f 1 heart-aa-metadata-deaths.txt   heart-lv-metadata-deaths.txt | sort |  uniq -d | wc -l
     298
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cut -f 1 heart-aa-metadata-deaths.txt   heart-lv-metadata-deaths.txt | sort |  uniq -u | wc -l
     263
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cut -f 1 heart-aa-metadata-deaths.txt   heart-lv-metadata-deaths.txt | sort |  uniq  | wc -l
     561
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cut -f  1,4,8,10,12-18 heart-aa-metadata-deaths.txt   heart-lv-metadata-deaths.txt |  sort | uniq | sort -r > temp.causedeath.txt

#############################################################################
> t1 <- read.delim("heart-lv-metadata-deaths.txt")
 t2 <- read.delim("GTEx_LA_AA_tissue_filtered.txt", header=F)
 t3 <- t1[ t1$SUBJID %in% t2$V1,]
 dim(t3)
# [1] 268  18
 head(t3, n = 10)
 dim(t3[ t3$SEX == 1,])
# [1] 167  18
 dim(t3[ t3$SEX == 2,])
# [1] 101  18
  101/268
# [1] 0.3768657
 dim(t1[ t1$SEX == 1,])
# [1] 291  18
 dim(t1[ t1$SEX == 2,])
# [1] 137  18
 137 / 428
# [1] 0.3200935
  raw2 <- raw[, colnames(raw) %in% t3$sid ]
 dim(raw2)
# [1] 62703   268
......
> print(dim(y))
[1] 15352   268

> (291-167)/291
[1] 0.4261168
> (137 - 101)/137
[1] 0.2627737

> t1 <- read.delim("heart-aa-metadata-deaths.txt")
> dim(t1)
[1] 429  18
> t2 <- read.delim("GTEx_LA_AA_tissue_filtered.txt", header=F)
>  t3 <- t1[ t1$SUBJID %in% t2$V1,]
>  dim(t3)
[1] 248  18
>  dim(t3[ t3$SEX == 1,])
[1] 156  18
>  dim(t3[ t3$SEX == 2,])
[1] 92 18
>  raw2 <- raw[, colnames(raw) %in% t3$sid ]
>  dim(raw2)
[1] 62703   248
......
> print(dim(y))
[1] 16620   248

#############################################################################
boxplot pathway z-score ~ Female-heart-disease
> res.info$diseas = "Heart-disease"

for(i in 1:dim(res.info)[1]) {
 id <- res.info[i,]$SUBJID
 if(id %in% h.diseas.id$SUBJID)
   res.info[i,]$diseas = "others"
}
 dim(res.info[ res.info$diseas == "others",])
# [1] 248   9
 dim(res.info[ res.info$diseas == "Heart-disease",])
# [1] 181   9
 res.info$sex.diseas <- paste(res.info$SEX, res.info$diseas, sep="_")
length(grep("2_", res.info$sex.diseas))
# [1] 136
 length(grep("^1_", res.info$sex.diseas))
# [1] 293
> boxplot(res.info$mean ~ res.info$sex.diseas, ylab="FAO 20-geneset z-score ( heart-AA)", col=c("purple", "purple", "orange", "orange"))
 t1.h <- res.info[ res.info$sex.diseas == "1_Heart-disease",]$mean
 t1.o <- res.info[ res.info$sex.diseas == "1_others",]$mean
 t2.h <- res.info[ res.info$sex.diseas == "2_Heart-disease",]$mean
 t2.o <- res.info[ res.info$sex.diseas == "2_others",]$mean
 t.test(t1.h, t1.o)
 t.test(t2.h, t2.o)
 t.test(t1.h, t2.h)
 t.test(t1.o, t2.o)

#############################################################################
> t7 <- read.delim("diff2-1-left-ventricle-FvsM.age-bmi-covar.noX.Y.rnk", header=F)
 t8 <- read.delim("diff2-1-left-ventricle-FvsM.age-bmi-covar.Hdiseas-filt-268.noX.Y.rnk", header = F)
 t9 <- merge(t7, t8, by.x="V1",by.y="V1")
> dim(t9)
[1] 14727     3
> dim(t7)
[1] 14783     2
> dim(t8)
[1] 14833     2

> plot(t9$V2.x, t9$V2.y, xlab="signed log10(p-value) (F vs. M), heart-LV all samples (n = 428)", ylab="signed log10(p-value), disease filtered samples (n=268)")
 abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,2), lty = 5, lwd = 0.5, col = "gray")
 abline(h = 0,   col = "blue")
 abline(v = 0, , col = "blue")
 abline(lm(t9$V2.y ~ t9$V2.x), col="blue")
> g <- read.delim("genes-fao", header=F)
 t10 <- t9[ t9$V1 %in% g$V1,]
 t10[ t10$V2.x * t10$V2.y > 0,]
> ggplot(t10, aes(x=V2.x, y=V2.y, label=V1)) + geom_point(size=1.5, col="red") + geom_smooth(se=T, method="lm") + geom_text_repel(show.legend=T, data=t10, size=2.2, max.overlaps=100, min.segment.length = 0.1) + geom_hline(yintercept=0, col="black", size = 0.25) + geom_vline(xintercept=0, col="black", size=0.25) + labs(x="signed log10(p-value) (F vs. M), heart-LV all samples (n = 428)", y = "signed log10(p-value), disease filtered samples (n=268)")

####################heart-AA
> t7 <- read.delim("diff2-1-Heart-Atrial-Appendage-FvsM.age-bmi-covar.noX.Y.rnk", header=F)
>  t8 <- read.delim("diff2-1-Heart-Atrial-Appendage-FvsM.age-bmi-covar.Hdiseas-filt-248.noX.Y.rnk", header = F)
>  t9 <- merge(t7, t8, by.x="V1",by.y="V1")
> dim(t7)
[1] 16156     2
> dim(t8)
[1] 16049     2
> dim(t9)
[1] 15984     3

>  plot(t9$V2.x, t9$V2.y, xlab="signed log10(p-value) (F vs. M), heart-AA all samples (n = 429)", ylab="signed log10(p-value), disease filtered samples (n=248)")
g <- read.delim("genes-fao", header=F)
 t10 <- t9[ t9$V1 %in% g$V1,]
 t10[ t10$V2.x * t10$V2.y < 0,]
#############################################################################
##################sample-sample correlation
Heart - Left Ventricle  428

d = cpm(y)
t9 <- as.data.frame(d)
t10 <- log10(t9 + 1)
 t10$id <- rownames(t10)
 dim(t10)
# [1] 15298   429
 chr <- read.delim("../autism/gencode.v42.primary_assembly.noPar.gene-chr-type")
 t11 <- merge(t10, chr, by.x="id", by.y="geneID")
 t12 <- t11[ t11$chr != "chrX" & t11$chr != "chrY",]
 dim(t12)
# [1] 14786   432
t13 <- t12[ , 2:429]
 t14 <- cor(t13)
 t15 <- as.data.frame(t14)
 mat <- as.matrix(t15)
 res <- data.frame(id = colnames(mat), mean = colMeans(mat))
 print(summary( res$mean))
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
#  0.7619  0.9094  0.9241  0.9151  0.9297  0.9415
 res <- data.frame(id = colnames(mat), mean = (colSums(mat) - 1) / 428)
 summary(res$mean)
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
#  0.7595  0.9071  0.9218  0.9128  0.9274  0.9392
 ol <- boxplot(res$mean)
 dim(res[ res$mean <= ol$stats[1],])
# [1] 43  2
ol$stats[1]
# [1] 0.8769241
> write.table(res, "lv-sample-samp-cor.txt", quote=F, sep="\t")

###############################################################
"CD36", "PPARA", "PPARGC1A"

cat fao.orig.gmt  | grep -i wdtc1 | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 3; i <= NF; i++) print  $i}' > temp2
168 temp2

#############################################################################
> dim(res.3)
[1] 428  11
> head(res.3, n =11)
       SUBJID                        id        mean                   SAMPID   SUBJID.1 SEX   AGE DTHHRDY age_value body_mass_index height
1  GTEX-111FC GTEX.111FC.0826.SM.5GZWO.  0.09688571 GTEX-111FC-0826-SM-5GZWO GTEX-111FC   1 60-69       1        61           25.06   73.0

>  res.3$SEX <- factor(res.3$SEX, levels=c(2,1), labels=c("F", "M"))
> ggplot(res.3, aes(x=age_value, y=mean, group=SEX, color = SEX)) + geom_point(shape=21, size = 1) + geom_smooth(aes(fill = SEX)) + labs(x= "age", y="FAO geneset z-score")  + scale_color_manual(breaks=c("F", "M"), values=c("orange", "purple")) + scale_fill_manual(breaks=c("F", "M"), values=c("orange", "purple")) +
  scale_y_continuous( limits=c(-2.5,1.5))

>  ggplot(res.lv.fas, aes(x=age_value, y=mean, group=SEX, color = SEX)) + geom_point(shape=21, size = 1) + geom_smooth(aes(fill = SEX)) + labs(x= "age", y="GO_FAS geneset z-score")  + scale_color_manual(breaks=c("F", "M"), values=c("orange", "purple")) + scale_fill_manual(breaks=c("F", "M"), values=c("orange", "purple")) +
  scale_y_continuous( limits=c(-2.5,1.5))

#####################################################################################
####heart disease (Lukas annot) age distri 
r1 <- res.info[ res.info$SEX == 1 & res.info$diseas != "others",]
 dim(r1)
# [1] 124  13
 hist(r1$age_value, breaks=seq(0, 100, 5), main="LV 124 male donors Heart-disease")
  abline(v = seq(0, 1000, 10), lty = 5, lwd = 0.5, col = "blue")
 abline(h = seq(0, 1000, 5), lty = 5, lwd = 0.5, col = "blue")

> t1 <- data.frame(breaks = h1$breaks[2:21], M_H_dis = h1$counts)
>  h1 <- hist(r1$age_value, breaks=seq(0, 100, 5), main="LV 124 male donors Heart-disease")
> t1$M_all_donor <- h1$counts
> plot(t1$breaks, t1$M_H_dis / t1$M_all_donor)
>   abline(v = seq(0, 1000, 10), lty = 5, lwd = 0.5, col = "grey")
>  abline(h = seq(0, 1000, 0.05), lty = 5, lwd = 0.5, col = "grey")
> t1$F_H_dis <- h1$counts
> plot(t1$breaks, t1$M_H_dis / t1$M_all_donor, ylim=c(0, 0.7), xlab="age breaks", ylab="H_disease / all_donors", col="purple")
> points(t1$breaks, t1$F_H_dis / t1$F_all_donor, col="orange")
> t2 <- t1[ t1$breaks <= 45,]
> colSums(t2)
     breaks     M_H_dis M_all_donor     F_H_dis F_all_donor
        225          10          47          10          31
> t2 <- t1[ t1$breaks <= 40,]
> colSums(t2)
     breaks     M_H_dis M_all_donor     F_H_dis F_all_donor
        180           6          34           7          21

#################################################################
> info5 <- info4[ info4$age_value <= 45,]
> dim(info5)
[1] 78 12
>  raw2 <- raw[, colnames(raw) %in% info5$sid ]
...
> y<-y[med$logic,]
> print(dim(y))
[1] 15419    78 (F = 31, M = 47)
######
> info.3 <- info.2[ info.2$ageV >= 55 & info.2$ageV < 60,]
> dim(info.3[ info.3$SEX == 1,])
[1] 55  9
> dim(info.3[ info.3$SEX == 2,])
[1] 20  9
...
> y<-y[med$logic,]
> print(dim(y))
[1] 15360    75
######
> info.3 <- info.2[ (info.2$ageV >= 55 & info.2$ageV < 60) | info.2$ageV <= 45,]
>  dim(info.3[ info.3$SEX == 1,])
[1] 102   9
>  dim(info.3[ info.3$SEX == 2,])
[1] 51  9
> raw2 <- raw[, colnames(raw) %in% info.3$sid ]
...
> y<-y[med$logic,]
> print(dim(y))
[1] 15376   153
...
> info.2$sex.cat <- factor(info.2$SEX, levels=c(1,2), labels=c( "1M", "2F"))
> info.2$menop = "yes"
for(i in 1:dim(info.2)[1]) { 
 if(info.2[i,]$ageV < 46)
   info.2[i,]$menop = "no" 
}
> dim(info.2[info.2$menop == "yes",])
[1] 75 11
> dim(info.2[info.2$menop == "no",])
[1] 78 11
>  design <- model.matrix( ~ info.2$sex.cat + info.2$menop + info.2$bmi + info.2$sex.cat : info.2$menop)
   (Intercept) info.2$sex.cat2F info.2$menopyes info.2$bmi info.2$sex.cat2F:info.2$menopyes
1            1                0               1      22.92                                0
2            1                1               1      24.97                                1
3            1                1               0      29.75                                0
4            1                0               1      26.60                                0
5            1                0               1      32.82                                0
6            1                0               0      26.32                                0
...
> qlf <- glmQLFTest(fit, coef=5)
################################################
> info5 <- merge(info, info3, by.x="SUBJID", by.y="source_subject_id")
> dim(info5)
[1] 22951    10
> head(info5)
      SUBJID                        SAMPID   SUBJID.1 SEX   AGE DTHHRDY                            sid age_value body_mass_index height
1 GTEX-1117F      GTEX-1117F-0003-SM-58Q7G GTEX-1117F   2 60-69       4      GTEX.1117F.0003.SM.58Q7G.        66           32.12     66

> res.info <- merge(res, info5, by.x="id", by.y="sid")
> res.info.2 <- res.info[ res.info$age_value <= 45 | (res.info$age_value >= 55 & res.info$age_value < 60),]
> dim(res.info.2)
[1] 153  11
res.info.2$meno = "NA"
for(i in 1:dim(res.info.2)[1]) {
 if(res.info.2$age_value[i] < 50)
   res.info.2$meno[i] = "before_menop"
 else
   res.info.2$meno[i] = "menopause"
}

 res.info.2$sex.cat <- factor(res.info.2$SEX, levels=c(2,1), labels=c("F", "M"))
 res.info.2$sex_menop <- paste( res.info.2$sex.cat, res.info.2$meno, sep="_")
> res.info.2$sex_menop2 <- factor(res.info.2$sex_menop, levels= c("M_before_menop", "F_before_menop", "M_menopause", "F_menopause" ), labels=c("M(age <= 45)", "F(age <= 45)", "M [55, 60)", "F [55, 60)"))
 boxplot(res.info.2$mean ~ res.info.2$sex_menop2, main="ZFX", ylab="CPM", ylim=c(5, 40), col=c("purple", "orange"))
  abline(h = seq(-100,100,5), lty = 5, lwd = 0.5, col = "gray")
 lev= c("M_before_menop", "F_before_menop", "M_menopause", "F_menopause" )
 t1=1:4
t1[1] = dim( res.info.2[res.info.2$sex_menop == lev[1],])[1]
t1[2] = dim( res.info.2[res.info.2$sex_menop == lev[2],])[1]
t1[3] = dim( res.info.2[res.info.2$sex_menop == lev[3],])[1]
t1[4] = dim( res.info.2[res.info.2$sex_menop == lev[4],])[1]
t1
 text(x=1:4, y=40, paste("N=",t1, sep=""))

#################################################
 t1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/left-ventricle-FvsM.age-bmi-covar.ageLE45.noX.Y-weight0-FAO.GseaPreranked.1707104648992/gsea_report_for_na_neg_1707104648992.tsv")
 t2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/left-ventricle-FvsM.age-bmi-covar.ageLE45.noX.Y-weight0-FAO.GseaPreranked.1707104648992/gsea_report_for_na_pos_1707104648992.tsv")
 age45 <- rbind(t1,t2)
 t1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/left-ventricle-FvsM.age-bmi-covar.age55_59.noX.Y-weight0-FAO.GseaPreranked.1707164595920/gsea_report_for_na_pos_1707164595920.tsv")
 t2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/left-ventricle-FvsM.age-bmi-covar.age55_59.noX.Y-weight0-FAO.GseaPreranked.1707164595920/gsea_report_for_na_neg_1707164595920.tsv")
 age55 <- rbind(t1, t2)
 t3 <- merge(age45, age55, by.x="NAME", by.y="NAME")
 dim(t3)
# [1] 52 23
> t1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/diff2-1-left-ventricle-FvsM.bmi-covar.F-menopause-interact.noX.Y-weight0-FAO.GseaPreranked.1707330833849/gsea_report_for_na_pos_1707330833849.tsv")
> t2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/diff2-1-left-ventricle-FvsM.bmi-covar.F-menopause-interact.noX.Y-weight0-FAO.GseaPreranked.1707330833849/gsea_report_for_na_neg_1707330833849.tsv")
> sex.men <- rbind(t1, t2)
> dim(sex.men)
[1] 52 12
t4 <- merge(t3, sex.men, by.x="NAME", by.y="NAME")
> t4$NES.diff <- t4$NES.y - t4$NES.x
> t5 <- t4[ t4$NES > 2 | t4$NES < -2,]
ggplot(t4, aes(x=NES.diff, y=NES, label=NAME) ) + geom_point(size=1) + labs(x="NES diff between [55, 59] and age <= 45", y="sex:menop interaction NES", title="heart-LV") +
    geom_hline(yintercept=0, col="blue") + geom_vline(xintercept=0, col="blue") +
     scale_x_continuous(breaks=seq(-6, 6, 1), minor_breaks=NULL) +
   geom_text_repel(show.legend=T, data=t5, size=2.2, max.overlaps=100, min.segment.length = 0.1) +
 geom_smooth(se=T, method="lm")

> write.table(t4[, c(1,6,7,17,18, 26, 28, 29, 30)], "temp.txt", quote=F, sep="\t")

####################################HEART-LV F/M * age <= 45/age [55,59] interaction boxplot, CPM ~ age
 g1 <- "COMP"
  p.exp <- a.df.g[ a.df.g$name %in% g1, ]
  length(p.exp$name)
  mat <- as.matrix(p.exp[, 2:429])
 res <- data.frame(id = colnames(mat), mean = colMeans(mat))
 dim(res)
# [1] 428   2
 summary(res)
 res.info <- merge(res, info5, by.x="id", by.y="sid")
 res.info.2 <- res.info[ res.info$age_value <= 45 | (res.info$age_value >= 55 & res.info$age_value < 60),]
 dim(res.info.2)
# [1] 153  11
res.info.2$meno = "NA"
for(i in 1:dim(res.info.2)[1]) {
 if(res.info.2$age_value[i] < 50)
   res.info.2$meno[i] = "before_menop"
 else
   res.info.2$meno[i] = "menopause"
}

 res.info.2$sex.cat <- factor(res.info.2$SEX, levels=c(2,1), labels=c("F", "M"))
 res.info.2$sex_menop <- paste( res.info.2$sex.cat, res.info.2$meno, sep="_")
 res.info.2$sex_menop2 <- factor(res.info.2$sex_menop, levels= c("M_before_menop", "F_before_menop", "M_menopause", "F_menopause" ), labels=c("M(age <= 45)", "F(age <= 45)", "M [55, 60)", "F [55, 60)"))

 t1 <- df.cpm.gene[ df.cpm.gene$name %in% g1,]
 rat <- round(2^t1$logFC, digits=3)
 pva <- format(t1$PValue, digits=3)
 boxplot(res.info.2$mean ~ res.info.2$sex_menop2, main=paste(g1, ": interaction F/M =",rat, ", pval=", pva, sep=""), ylab="CPM",  col=c("purple", "orange"))
  abline(h = seq(-100,100,10), lty = 5, lwd = 0.5, col = "gray")

############################################# RIN number, Total Ischemic time for a sample
 info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
 t <- read.delim("/Users/linyongmao/Documents/dir-GTExV8/dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt")
 t1 <- data.frame(t$SAMPID, t$SMRIN, t$SMTSISCH)
 t2 <- merge(info, t1, by.x="SAMPID", by.y="t.SAMPID")
 info <- t2
......
 summary(info.2)
     SEX           AGE               DTHHRDY         t.SMRIN        t.SMTSISCH         sid                    
 Min.   :1.00   Length:428         Min.   :0.000   Min.   :5.100   Min.   :  55.0   Length:428        
 1st Qu.:1.00   Class :character   1st Qu.:0.000   1st Qu.:6.300   1st Qu.: 179.0   Class :character  
 Median :1.00   Mode  :character   Median :0.000   Median :7.250   Median : 492.5   Mode  :character  
 Mean   :1.32                      Mean   :1.054   Mean   :7.253   Mean   : 554.8                     
 3rd Qu.:2.00                      3rd Qu.:2.000   3rd Qu.:8.100   3rd Qu.: 859.0                     
 Max.   :2.00                      Max.   :4.000   Max.   :9.400   Max.   :1737.0                     
                                   NA's   :1                                                

 summary(info.2)
 info.2$isch <- log10(info.2$t.SMTSISCH)
 design <- model.matrix( ~ info.2$SEX + info.2$ageV + info.2$bmi + info.2$isch + info.2$t.SMRIN)

################################################################
> print(dim(y))
[1] 15298   428
d = cpm(y)
a <- log10(d+1)
a.df <- as.data.frame(a)
a.df[1:6,1:6]
......
get sex info for each sample according to the y sample order
 identical(info.2$sid, colnames(y))
 identical(info.2$sid, colnames(a.df))
 resid2 <- a.df
for(i in 1:dim(a.df)[1] ) {
 t1 <- data.frame(y = t(a.df[i,]), sex = info.2$SEX )
 t2 <- lm(t1[,1] ~ sex, data=t1)
 t3 <- resid(t2)
 resid2[i,] <- t3

}
 r3 <- t(resid2)
###PCA
 pca <- prcomp(r3, center = TRUE, scale. = TRUE)
boxplot(pca$x[,1:20])
 s <- summary(pca)
s$importance[,1:10]
#                             PC1      PC2      PC3      PC4      PC5      PC6      PC7      PC8      PC9     PC10
# Standard deviation     66.97269 41.66762 32.66448 24.78981 21.87155 21.32555 19.56760 17.30709 15.74531 13.78309
# Proportion of Variance  0.29320  0.11349  0.06975  0.04017  0.03127  0.02973  0.02503  0.01958  0.01621  0.01242
# Cumulative Proportion   0.29320  0.40669  0.47643  0.51661  0.54788  0.57760  0.60263  0.62221  0.63842  0.65084

 p1 <- as.data.frame( pca$x[,1:10])
 p1$id <- rownames(p1)
 info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
 info$sid <-  gsub("-", ".", info$SAMPID)
 info$sid <-  paste( info$sid, ".", sep="")
 t5 <- read.delim("gtex-981subjects-tsvs/subject.tsv")
 info3 <- t5[, c(16,31,46, 106)]
 info4 <- merge(info, info3, by.x="SUBJID", by.y="source_subject_id")
 dim(info4)
# [1] 22951    10
 t <- read.delim("/Users/linyongmao/Documents/dir-GTExV8/dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SampleAttributesDS.txt")
 t1 <- data.frame(t$SAMPID, t$SMRIN, t$SMTSISCH)
 info5 <- merge(info4, t1, by.x="SAMPID", by.y="t.SAMPID")
 dim(info5)
# [1] 22951    12
 p2 <- merge(p1, info5, by.x ="id", by.y="sid")
 dim(p2)
# [1] 428  22
> cor.test(p2$PC1, p2$SEX)
t = -2.2652e-14, df = 426, p-value = 1
          cor 
-1.097477e-15 
> cor.test(p2$PC1, p2$t.SMRIN)
t = -24.828, df = 426, p-value < 2.2e-16
      cor 
-0.768986 
###########################################################################################
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat diff2-1-muscle-FvsM.age-bmi-covar.txt | head -40 | awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} {print "+info.2$PC" NR}'

dim(p2)
# [1] 429  52
 info.2 <- p2
 for(i in 1:dim(y)[2]) {
  t1 <- p2[ p2$id == colnames(y)[i],]
  info.2[i,] <- t1[1,]
  }
 dim(info.2)
 identical(info.2$id, colnames(y))

> design <- model.matrix( ~ info.2$SEX + info.2$age_value + info.2$body_mass_index +info.2$PC1+info.2$PC2+info.2$PC3+info.2$PC4+info.2$PC5+info.2$PC6+info.2$PC7+info.2$PC8+info.2$PC9+info.2$PC10+info.2$PC11+info.2$PC12+info.2$PC13+info.2$PC14+info.2$PC15+info.2$PC16+info.2$PC17+info.2$PC18+info.2$PC19+info.2$PC20+info.2$PC21+info.2$PC22+info.2$PC23+info.2$PC24+info.2$PC25+info.2$PC26+info.2$PC27+info.2$PC28+info.2$PC29+info.2$PC30+info.2$PC31+info.2$PC32+info.2$PC33+info.2$PC34+info.2$PC35+info.2$PC36+info.2$PC37+info.2$PC38+info.2$PC39+info.2$PC40)

> design <- model.matrix( ~ info.2$SEX + info.2$age_value + info.2$body_mass_index +info.2$PC1+info.2$PC2+info.2$PC3+info.2$PC4+info.2$PC5+info.2$PC6+info.2$PC7+info.2$PC8+info.2$PC9+info.2$PC10+info.2$PC11+info.2$PC12+info.2$PC13+info.2$PC14+info.2$PC15+info.2$PC16+info.2$PC17+info.2$PC18+info.2$PC19+info.2$PC20+info.2$PC21+info.2$PC22+info.2$PC23+info.2$PC24+info.2$PC25+info.2$PC26+info.2$PC27+info.2$PC28+info.2$PC29+info.2$PC30+info.2$PC31+info.2$PC32+info.2$PC33+info.2$PC34+info.2$PC35+info.2$PC36+info.2$PC37+info.2$PC38+info.2$PC39+info.2$PC40 + info.2$t.SMRIN + log10(info.2$t.SMTSISCH) )

###########################
linyong@fry /lab/solexa_page/linyong$ grep -i "_PAR_Y" /lab/solexa_page/linyong/gencode/gencode.v42.primary_assembly.annotation.gtf | awk 'BEGIN {FS = "\t"; OFS = "\t"} $3 == "gene" && $1 == "chrY" ' | cut -f 9 | grep -i "_PAR_Y" |  awk 'BEGIN {FS = ";"; OFS = "\t"} {print $2, $3}' > genes_PAR_Y
      18 genes_PAR_Y-protein_coding
      47 genes_PAR_Y
> raw <- read.delim("../dir-GTExV8/gtex-all-samples.gene.count.txt", header=T)
 g <- read.delim("../dir-GTExV8/genes_PAR_Y-protein_coding", header=F)
 t1 <- raw[ raw$name %in% g$V1, ]
 dim(t1)
# [1]    18 17352
 t2 <- t1[, c(3:17352)]
 rownames(t2) <- t1$name
 t3 <-as.data.frame( t(t2))
 dim(t3[ t3$IL9R > 15,])

#######################################
> dim(info.2[ info.2$SEX == 1,])
[1] 291   7
> dim(info.2[ info.2$SEX == 2,])
[1] 137   7
>  137 * 2 * 0.1 - 6
[1] 21.4
covariates:
sex
age
BMI
RIN
SISCH
intercept (lm)


design <- model.matrix( ~ info.2$SEX + info.2$age_value + info.2$body_mass_index + info.2$t.SMRIN + log10(info.2$t.SMTSISCH) + 
info.2$PC1+info.2$PC2+info.2$PC3+info.2$PC4+info.2$PC5+info.2$PC6+info.2$PC7+info.2$PC8+info.2$PC9+info.2$PC10+info.2$PC11+info.2$PC12+info.2$PC13+info.2$PC14+info.2$PC15+info.2$PC16+info.2$PC17+info.2$PC18+info.2$PC19+info.2$PC20+info.2$PC21 )

 dim(design)
# [1] 428  27
 head(design)

##################data variation explained by sex
> y.cn <- colnames(y)
 info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
 info$sid <-  gsub("-", ".", info$SAMPID)
 info$sid <-  paste( info$sid, ".", sep="")
 info.2 <- head(info, n= dim(y)[2])
for(i in 1:dim(y)[2]) {
 t1 <- info[ info$sid == y.cn[i],]
 info.2[i,] <- t1[1,]
 }
###get sex info for each sample according to the y sample order
 identical(info.2$sid, colnames(y))
 identical(info.2$sid, colnames(a.df))

t1 <- data.frame(id = rownames(a.df), var = a.df[,1])
for(i in 1:dim(a.df)[1])
{
 t1$var[i] = var(as.numeric(a.df[i,]))
}

t1$sex.cor = -999
for(i in 1:dim(a.df)[1])
{
  d1 <-  data.frame(y = t(a.df[i,]), sex = info.2$SEX )
  d2 <-  lm(d1[,1] ~ d1$sex)
  d3 <- summary(d2)
  t1$sex.cor[i] = d3$r.squared
}

> summary(t1$sex.cor)
> summary(t1$var)
> sum(t1$var * t1$sex.cor) / sum(t1$var)

#########################heart disease, LV, lukas annot
"GTEx_LA_AA_tissue_filtered.txt"

> heart.no.dis <- t3
> dim(heart.no.dis)
[1] 268  18
> p2$death = 0
> p3 <- p2[ p2$SUBJID %in% heart.no.dis$SUBJID,]
> dim(p3)
[1] 268  34
> p4 <- p2[ !(p2$SUBJID %in% heart.no.dis$SUBJID),]
> p4$death = 1
> p5 <- rbind(p3, p4)
> dim(p5)
[1] 428  34

> ggplot(p5, aes(x=t.SMRIN, y = PC1)) + geom_point(size= 1, shape = 21) + geom_smooth(se=T, method="lm") + labs(title="r= -0.7689", x = "RIN", y="PC1 (29.3%)")

> vioplot(p5$PC1 ~ p5$death, ylab="PC1", xlab = "possible cause of death", xaxt = "n", main="r= 0.2902, p= 9.398e-10")
  axis(1, at = c(1,2), labels=c("others", "heart related"), las=1)

> d1 <- lm( p5$death ~ p5$PC1+p5$PC2+p5$PC3+p5$PC4+p5$PC5+p5$PC6+p5$PC7+p5$PC8+p5$PC9+p5$PC10+p5$PC11+p5$PC12+p5$PC13+p5$PC14+p5$PC15+p5$PC16+p5$PC17+p5$PC18+p5$PC19+p5$PC20+p5$PC21  )
> summary(d1)
Multiple R-squared:  0.1953,    Adjusted R-squared:  0.1537
F-statistic: 4.692 on 21 and 406 DF,  p-value: 1.472e-10

> 0.1953^(1/2)
[1] 0.4419276

#############################################
> t1 <- read.delim("diff2-1-left-ventricle-FvsM.age-bmi-covar.noX.Y.rnk", header=F)
 t2 <- read.delim("diff2-1-left-ventricle-FvsM.age-bmi-RIN-ischem-PC1-21-covar.noX.Y.rnk", header=F)
 t3 <- merge(t1, t2, by.x="V1", by.y="V1")
 dim(t3)
[1] 14783     3
> plot(t3$V2.x, t3$V2.y, cex= 0.5, xlab="signed log10(pval),age-bmi-covar.noX.Y", ylab="signed log10(pval), age-bmi-RIN-ischem-PC1-21-covar.noX.Y")
 abline(h = seq(-100,100,10), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,5), lty = 5, lwd = 0.5, col = "gray")
 abline(h = 0, col="blue")
 abline(v = 0, col="blue")

> t4 <- read.delim("diff2-1-left-ventricle-FvsM.age-bmi-RIN-ischem-PC1-21-covar.txt")
 t5 <- read.delim("diff2-1-left-ventricle-FvsM.age-bmi-covar.2.txt")
 t6 <- merge( t5, t4,by.x="geneID", by.y="geneID")

 dim(t6)
# [1] 15298    19
 t7 <- t6[ t6$chr.x != "chrX" & t6$chr.x != "chrY",]
 dim(t7)
# [1] 14786    19
> plot(t7$logFC.x, t7$logFC.y, xlab="logFC, FvsM age-bmi-covar", ylab="logFC, age-bmi-RIN-ischem-PC1-21-covar")
 x1 = 1:5
 y1=x1
 abline(lm(y1 ~ x1), col="blue")
 abline(h = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 abline(h=0)
 abline(v=0)
 text(-1.5,1.2, "y=x line", col="blue")

############################################################
>  index = 16
Brain - Hypothalamus    202
+  med$logic[i] <- median(d[i,]) >= 0.5
> print(dim(y))
[1] 18447   202
>   dim(info.2[ info.2$SEX == 1,])
[1] 147   7
>   dim(info.2[ info.2$SEX == 2,])
[1] 55  7
> info6 <- info5[ info5$age_value <= 45,]
###......
 dim(raw)
 t1 <- read.delim("dir-gtex-website-data/sample-tissue.2colum", header=F)
 file <- read.delim("gtex-54tiss.txt", header=F)
  index = 16
 tissue = file[index,1]
  t2 <- t1[ t1$V2 == tissue, ]
  t2$id <- gsub("-", ".", t2$V1)
  t2$id <- paste(t2$id, ".", sep="")
  raw2 <- raw[, colnames(raw) %in% t2$id & colnames(raw) %in% info6$sid]

###18863 genes with median cpm >= 0.5;    15samples (4 F, 11 M <= 45 years old)
> design <- model.matrix( ~ info.2$SEX + info.2$age_value +
+ info.2$PC1+info.2$PC2 )

##########
> info6 <- info5[ info5$age_value >= 55 & info5$age_value < 60,]
Brain - Hypothalamus    33 samples within the above range
18681 genes with median >= 0.5,     26 M, 7 F;
##7 Females, 7 variables
> design <- model.matrix( ~ info.2$SEX + info.2$age_value +
+ info.2$PC1+info.2$PC2+info.2$PC3+info.2$PC4+info.2$PC5 )


linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat diff2-1-Hypothalamus-FvsM.age-PC1-5-covar.age55-59.txt | awk 'BEGIN {FS = "\t"} !($8 == "chrX" || $8 == "chrY")'  | sort -t '      ' +4 -5g | head -500 |  awk 'BEGIN {FS = "\t"} $2 > 0' | cut -f 7

#########
Brain - Hypothalamus    202
[1] 18447 expressed genes,   202
147 male, 55 female                  
> s$importance[,1:6]
                            PC1      PC2      PC3      PC4      PC5      PC6
Standard deviation     59.96759 41.15805 39.43753 31.89466 31.32077 25.98823
Proportion of Variance  0.19494  0.09183  0.08431  0.05515  0.05318  0.03661
Cumulative Proportion   0.19494  0.28677  0.37109  0.42623  0.47941  0.51602
> design <- model.matrix( ~ info.2$SEX + info.2$age_value + info.2$body_mass_index + info.2$t.SMRIN + log10(info.2$t.SMTSISCH) +
 info.2$PC1+info.2$PC2+info.2$PC3+info.2$PC4+info.2$PC5+info.2$PC6 )

Delayed puberty (HP:0000823) / Hypogonadotrophic hypogonadism (HP:0000044)
PUS1 LEPR GNRH1 NR0B1 TBX3 KISS1 PCSK1 TACR3 
Delayed puberty (HP:0000823): PUS1 LEPR GNRH1 NR0B1 TBX3
Hypogonadotrophic hypogonadism (HP:0000044): KISS1;PCSK1;TACR3;GNRH1;NR0B1

##################
Brain - Hypothalamus    202
+  med$logic[i] <- median(d[i,]) >= 0.1
> print(dim(y))
[1] 24465   202
> s$importance[,1:10]
                            PC1      PC2      PC3      PC4      PC5      PC6      PC7      PC8      PC9     PC10
Standard deviation     64.00678 44.94054 42.43793 34.47961 34.08877 28.75642 26.83672 25.51257 23.21841 22.39146
Proportion of Variance  0.16746  0.08255  0.07361  0.04859  0.04750  0.03380  0.02944  0.02660  0.02204  0.02049
Cumulative Proportion   0.16746  0.25001  0.32363  0.37222  0.41972  0.45352  0.48296  0.50956  0.53160  0.55209
design <- model.matrix( ~ info.2$SEX + info.2$age_value + info.2$body_mass_index + info.2$t.SMRIN + log10(info.2$t.SMTSISCH) +
 info.2$PC1+info.2$PC2+info.2$PC3+info.2$PC4+info.2$PC5+info.2$PC6 )
>  dim(design)
[1] 202  12
   23637 temp
   23591 (some genes consolidated) diff2-1-Hypothalamus-FvsM.age-bmi-RIN-ischem-PC1-6-covar.cpm0.1.noX.Y.rnk
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat  diff2-1-Hypothalamus-FvsM.age-bmi-RIN-ischem-PC1-6-covar.cpm0.1.txt | awk 'BEGIN {FS = "\t"} !($8 == "chrX" || $8 == "chrY")'  | sort -t '        '  +4 -5g | head -500 |  awk 'BEGIN {FS = "\t"} $2 > 0' | cut -f 7 | grep -vw name | sort | uniq > temp-f-2

#########################################
Whole Blood     755
+  med$logic[i] <- median(d[i,]) >= 0.1
> print(dim(y))
[1] 19204   755
501 M; 254 F
 254 * 2 * 0.1 - 6 = 44
                            PC1      PC2      PC3      PC4      PC5      PC6      PC7      PC8      PC9     PC10
Standard deviation     69.57922 44.20115 37.48689 32.69581 23.83401 21.46801 18.36810 18.24586 16.85916 16.29494
Proportion of Variance  0.25210  0.10174  0.07318  0.05567  0.02958  0.02400  0.01757  0.01734  0.01480  0.01383
Cumulative Proportion   0.25210  0.35383  0.42701  0.48268  0.51226  0.53625  0.55382  0.57116  0.58596  0.59979 
                           PC42     PC43     PC44     PC45    PC46
Standard deviation     6.368879 6.270157 6.027326 5.986372 5.95461
Proportion of Variance 0.002110 0.002050 0.001890 0.001870 0.00185
Cumulative Proportion  0.747720 0.749770 0.751660 0.753530 0.75537
> summary(p2$t.SMTSISCH)
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max.     NA's 
-1287.00   -90.75   339.50   336.03   726.00  1401.00        9 
design <- model.matrix( ~ info.2$SEX + info.2$age_value + info.2$body_mass_index + info.2$t.SMRIN  +                           
info.2$PC1+info.2$PC2+info.2$PC3+info.2$PC4+info.2$PC5+info.2$PC6+info.2$PC7+info.2$PC8+info.2$PC9+info.2$PC10+info.2$PC11+info.2$PC12+info.2$PC13+info.2$PC14+info.2$PC15+info.2$PC16+info.2$PC17+info.2$PC18+info.2$PC19+info.2$PC20+info.2$PC21  +
info.2$PC22+info.2$PC23+info.2$PC24+info.2$PC25+info.2$PC26+info.2$PC27+info.2$PC28+info.2$PC29+info.2$PC30+info.2$PC31+info.2$PC32+info.2$PC33+info.2$PC34+info.2$PC35+info.2$PC36+info.2$PC37+info.2$PC38+info.2$PC39+info.2$PC40+info.2$PC41+info.2$PC42+info.2$PC43+info.2$PC44  )
>  dim(design)
[1] 755  49
not including log10(info.2$t.SMTSISCH)

######
ALAS2

 name="KDM6A"
 id <- gene.name[ gene.name$name == name,]
 id
 info.2$sex <- factor( info.2$SEX, levels=c(2,1), labels=c("Female", "Male" ))
 t1 <- a.df[ rownames(a.df) == id[1,1],]
 t1[,1:11]
 t1 <- as.numeric(a.df[ rownames(a.df) == id[1,1],])
 boxplot(t1 ~ info.2$sex, xlab="", ylab="log2(CPM+1)", main=name)
>  abline(h = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 t2 <- t1[ info.2$SEX == 2]
 length(t2)
 t3 <- t1[ info.2$SEX == 1]
 length(t3)
summary(t2)
summary(t3)
 t.test(t2, t3)

####################################################include SMTSISCH (pos/negative values) as covar; remove 9 samples with SMTSISCH ==
NA
> samp.na <- info.2[is.na( info.2$t.SMTSISCH) ,]$id
 samp.na
  raw2 <- raw[, colnames(raw) %in% t2$id & !(colnames(raw)  %in% samp.na)]
Whole Blood     746
+  med$logic[i] <- median(d[i,]) >= 0.1
> print(dim(y))
[1] 19202   746
496 M; 250 F
                            PC1      PC2      PC3      PC4      PC5      PC6      PC7      PC8      PC9     PC10
Standard deviation     69.73716 44.12750 37.36748 32.44707 23.68985 21.48876 18.46261 18.18311 16.90570 16.34993
Proportion of Variance  0.25327  0.10141  0.07272  0.05483  0.02923  0.02405  0.01775  0.01722  0.01488  0.01392
Cumulative Proportion   0.25327  0.35468  0.42739  0.48222  0.51145  0.53550  0.55325  0.57047  0.58535  0.59927
> s$importance[,40:46] 
                          PC40     PC41    PC42     PC43     PC44     PC45     PC46
Standard deviation     6.53537 6.455712 6.36592 6.288039 6.054017 6.007447 5.950522
Proportion of Variance 0.00222 0.002170 0.00211 0.002060 0.001910 0.001880 0.001840
Cumulative Proportion  0.74376 0.745940 0.74805 0.750100 0.752010 0.753890 0.755740
> cor.test(p2$PC1, (p2$t.SMTSISCH))
       cor
-0.7405844

        Spearman's rank correlation rho
       rho
-0.7394633

> design <- model.matrix( ~ info.2$SEX + info.2$age_value + info.2$body_mass_index + info.2$t.SMRIN  +    info.2$t.SMTSISCH +   

+ 
>  dim(design)
[1] 746  50

######
> df2 <- read.delim("diff2-1-blood-FvsM.age-bmi-RIN-PC1-44-covar.cpm0.1.txt")
 dim(df2)
# [1] 19204    10
 df3 <- merge(df2, df.cpm.gene, by.x="geneID", by.y="geneID")
 dim(df3)
# [1] 19183    19
 dim(df.cpm.gene)
# [1] 19202    10

df3$logP.x = -999
df3$logP.y = -999
for(i in 1:dim(df3)[1])
{
 if(df3$PValue.x[i] == 0 | df3$PValue.y[i] == 0)
 {
  print(df3[i,]);
  cat("\n")
 } 
 else 
 {
  a=1
  b=1
  if(df3$logFC.x[i] < 0)
    a = -1
  if(df3$logFC.y[i] < 0)
    b = -1
  df3$logP.x[i] = a * (-log10(df3$PValue.x[i]))
  df3$logP.y[i] = b * (-log10(df3$PValue.y[i]))
 }
}

 df4 <- df3[ df3$logP.x > -900,]
 dim(df4[ (df4$logP.y - df4$logP.x) > 2,])
# [1] 1979   21
 dim(df4[ (df4$logP.x - df4$logP.y) > 2,])
# [1] 39 21
 dim(df4[ abs(df4$logP.y - df4$logP.x) > 2 & (df4$logFC.x * df4$logFC.y < 0),])
# [1]  0 21
> plot(df4$logP.x, df4$logP.y, xlim=c(-100,100), ylim=c(-100,100))

#############################################################################
Cells - EBV-transformed lymphocytes     174
+  med$logic[i] <- median(d[i,]) >= 0.1
> print(dim(y))
[1] 21742   174
> design <- model.matrix( ~ info.2$SEX + info.2$age_value + info.2$body_mass_index + info.2$t.SMRIN + (info.2$t.SMTSISCH) +
 info.2$PC1+info.2$PC2+info.2$PC3+info.2$PC4+info.2$PC5+info.2$PC6)

###
> lcl <- read.delim("temp-san")
> head(lcl)
    Gene   x_pval x_adj_pval   deltaEx
1  KDM5C 6.13e-58   2.09e-55 0.7299753
> dim(lcl)
# [1] 406   4
 t1 <- (df.cpm.gene[ df.cpm.gene$chr == "chrX",])
 dim(t1)
# [1] 668  10
 t2 <- merge(lcl, t1, by.x="Gene", by.y="name")
 dim(t2)
# [1] 375  13
 t3 <- t2[ !is.na(t2$deltaEx), ]
> plot(t3$deltaEx, t3$logFC, ylim=c(-1, 2), xlim=c(-0.5,1.5))
    Gene   x_pval x_adj_pval  deltaEx             geneID    logFC   logCPM        F        PValue           FDR  chr strand   type
353 XIST 1.04e-38   5.89e-37 1.159831 ENSG00000229807.13 10.67081 7.524678 4353.624 2.450541e-120 6.659959e-117 chrX      - lncRNA
 abline(h = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 abline(h=0)
 abline(v=0)

> lcl <- read.delim("Andrianna-LCL.deltaExi.txt")
 dim(lcl)
# [1] 341   6
 t1 <- (df.cpm.gene[ df.cpm.gene$chr == "chrX",])
 dim(t1)
# [1] 668  10
 t2 <- merge(lcl, t1, by.x="Gene", by.y="name")
 dim(t2)
# [1] 335  15
> t3 <- t2[ abs( t2$logFC) >= 0.5 | abs(t2$deltaEx >= 0.5),]
> ggplot(t2, aes(x=deltaEx, y = logFC, color = region, label = Gene)) + geom_point(size=1.5) + labs( x = "LCL deltaEx (Adrianna San Roman)", y="GTEx V8 LCL log2FC (F vs. M)", title="335 expressed X genes") + geom_hline(yintercept=0, col="black") + geom_vline(xintercept=0) + xlim(-0.5,1.5) + ylim(-1, 2) + geom_text_repel(show.legend=T, data=t3, size=2.2, max.overlaps=100, min.segment.length = 0.1)

###
t3 <- t2[ t2$region == "NPX",]
 dim(t3)
# [1] 322  15
 t3 <- t2[ t2$region == "NPX" & t2$Gene != "XIST",]
 dim(t3)
# [1] 321  15
lm(formula = t3$logFC ~ t3$deltaEx)
Multiple R-squared:  0.5183,    Adjusted R-squared:  0.5168
r = 0.7199304
p = 1.563e-52

t3$sp1 <- -log10(t3$x_pval)
t3$sp2 <- -log10(t3$PValue)
for (i in 1:dim(t3)[1])
{
 if(t3$deltaEx[i] < 0)
   t3$sp1[i] <- log10(t3$x_pval[i])
 if(t3$logFC[i] < 0)
   t3$sp2[i] <- log10(t3$PValue[i])
}

head(t3, n=20)

> ggplot(t3, aes(x=sp1, y=sp2)) + geom_point(size=1, col="brown1", shape=1) + labs( x = "LCL deltaEx signed log10(PValue)", y="GTEx V8 LCL signed log10(PValue) (F vs. M)", title="321 expressed NPX genes")  + geom_hline(yintercept=0, col="black") + geom_vline(xintercept=0) +  geom_smooth(se=T, method="lm")

t3$fdr1 <- -log10(t3$x_adj_pval)
t3$fdr2 <- -log10(t3$FDR)
for (i in 1:dim(t3)[1])
{
 if(t3$deltaEx[i] < 0)
   t3$fdr1[i] <- log10(t3$x_adj_pval[i])
 if(t3$logFC[i] < 0)
   t3$fdr2[i] <- log10(t3$FDR[i])
}

head(t3, n=20)
 t4 <- t3[  abs(t3$fdr1) <= 10 & abs(t3$fdr2) <= 10,]
 dim(t4)
# [1] 302  19
 dim(t3)
# [1] 321  19

> dim(t3)
# [1] 321  19

> dim(t3)
[1] 321  19
> dim(t3[ t3$x_adj_pval < 0.05 & t3$deltaEx > 0,])
[1] 58 19
> dim(t3[ t3$FDR < 0.05 & t3$logFC > 0,])
[1] 55 19
> dim(t3[ (t3$x_adj_pval < 0.05 & t3$deltaEx > 0) & (t3$FDR < 0.05 & t3$logFC > 0),])
[1] 29 19

         pathway       non-pathway
gtex-fdr      29        55-29=26
gtex-non-fdr  29        237
   
> fis <- matrix(c(29, 55-29,29, 237), nrow=2, ncol=2, byrow=T )
> fisher.test(fis)
p-value = 4.611e-11
odds ratio
  9.020268

> dim(t3[ (t3$x_adj_pval < 0.05 & t3$deltaEx < 0) & (t3$FDR < 0.05 & t3$logFC < 0),])
[1]  1 19
                  pathway-male-bias       non-pathway
gtex-fdr-male-bias      1                    12
gtex-non-fdr           39                   269
fis <- matrix(c(1,12,39,269), nrow=2, ncol=2, byrow=T )
        Fisher's Exact Test for Count Data
p-value = 1
odds ratio
 0.5756047

###############################mash, effect size, LFSR
> eff.p.g <- merge(eff.p, t3, by.x="id", by.y="id")
...
> t2.2 <- t2[ !is.na(t2$Cells_EBV.transformed_lymphocytes.x),]
 t3 <- t2.2[ abs( t2.2$deltaEx) >= 0.5 | abs(t2.2$Cells_EBV.transformed_lymphocytes.x) >= 0.3,]
 dim(t3)
[1] 30 18
> ggplot(t2, aes(x=deltaEx, y = Cells_EBV.transformed_lymphocytes.x, color = region, label = Gene)) + geom_point(size=1.5) + labs( x = "LCL deltaEx (Adrianna San Roman)", y="Cells_EBV.transformed_lymphocytes.effect-size", title="337 expressed X genes") + geom_hline(yintercept=0, col="black") + geom_vline(xintercept=0) + ylim(-1, 1) + geom_text_repel(show.legend=T, data=t3, size=2.2, max.overlaps=100, min.segment.length = 0.1)

t3 <- t2[ t2$region == "NPX" & t2$Gene != "XIST" & !is.na(t2$Cells_EBV.transformed_lymphocytes.x),]
dim(t3)
# [1] 322  18
 t3$fdr1 <- -log10(t3$x_adj_pval)
t3$fdr2 <- -log10(t3$Cells_EBV.transformed_lymphocytes.y)
for (i in 1:dim(t3)[1])
{
 if(t3$deltaEx[i] < 0)
   t3$fdr1[i] <- log10(t3$x_adj_pval[i])
 if(t3$Cells_EBV.transformed_lymphocytes.x[i] < 0)
   t3$fdr2[i] <- log10(t3$Cells_EBV.transformed_lymphocytes.y[i])
}


         pathway       non-pathway
gtex-fdr      33          8
gtex-non-fdr  25        256

> fis <- matrix(c(33,8,25,256), nrow=2, ncol=2, byrow=T )
p-value < 2.2e-16
odds ratio
  41.20613


                  pathway-male-bias       non-pathway
gtex-fdr-male-bias      2                    12
gtex-non-fdr           38                   270

> fis <- matrix(c(2,12,38,270), nrow=2, ncol=2, byrow=T )
p-value = 0.6881
odds ratio 
  1.183533

#######################################################################
> t1 <- read.delim("diff2-1-LCL-FvsM.age-bmi-RIN-ischem-PC1-6-covar.cpm0.1.txt")
 dim(eff.p.g)
# [1] 34960    13
 dim(t1)
# [1] 21742    10
# by gene symbol
 t2 <- merge(t1, eff.p.g, by.x="name", by.y="name")
 dim(t2)
# [1] 21602    22
 t3 <- t2[ !is.na(t2$Cells_EBV.transformed_lymphocytes.x),]
 dim(t3)
# [1] 20097    22
t3$fdr1 <- -log10(t3$FDR)
t3$fdr2 <- -log10(t3$Cells_EBV.transformed_lymphocytes.y)
for (i in 1:dim(t3)[1])
{
 if(t3$logFC[i] < 0)
   t3$fdr1[i] <- log10(t3$FDR[i])
 if(t3$Cells_EBV.transformed_lymphocytes.x[i] < 0)
   t3$fdr2[i] <- log10(t3$Cells_EBV.transformed_lymphocytes.y[i])
}

t3$pv1 <- -log10(t3$PValue.x)
t3$pv2 <- -log10(t3$PValue.y)
for (i in 1:dim(t3)[1])
{
 if(t3$logFC.x[i] < 0)
   t3$pv1[i] <- log10(t3$PValue.x[i])
 if(t3$logFC.y[i] < 0)
   t3$pv2[i] <- log10(t3$PValue.y[i])
}


t4 <- t3[ t3$Cells_EBV.transformed_lymphocytes.y != 0,]
 dim(t4)
# [1] 20095    24
data:  t4$fdr1 and t4$fdr2
      cor
0.7871715
     rho
0.3491185

> t5 <- t4[ t4$chr.x == "chrX",]
 dim(t5)
[1] 630  24
t6 <- t5[ t5$FDR >= 1e-10 & t5$Cells_EBV.transformed_lymphocytes.y > 1e-21,]
  dim(t6)
# [1] 608  24

##################################abline
 x=10
 abline(h = seq(-1000, 1000, x), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-1000, 1000, x), lty = 5, lwd = 0.5, col = "gray")
 abline(v=0)
 abline(h=0)

# abline(h = c(-log10(0.05), log10(0.05)), col="blue")
# abline(v = c(-log10(0.05), log10(0.05)), col="blue")

##########################Correlation between only-sex-var logFC vs. effect size of oliva res
##########################LCL tissue
> df.cpm.gene$geneid2 <- gsub("\\.[0-9][0-9]*", "", df.cpm.gene$geneID)
 t1 <- merge(df.cpm.gene, eff.p.g, by.x="geneid2", by.y="geneID")
 dim(t1)
# [1] 20152    23
 t2 <- t1[ t1$chr.x != "chrX" & t1$chr.x != "chrY",]
 t3 <- t2[ !is.na(t2$Cells_EBV.transformed_lymphocytes.x),]
 dim(t3)
# [1] 19012    23
t3$pv1 <- -log10(t3$FDR)
t3$pv2 <- -log10(t3$Cells_EBV.transformed_lymphocytes.y)
for (i in 1:dim(t3)[1])
{
 if(t3$logFC[i] < 0)
   t3$pv1[i] <- log10(t3$FDR[i])
 if(t3$Cells_EBV.transformed_lymphocytes.x[i] < 0)
   t3$pv2[i] <- log10(t3$Cells_EBV.transformed_lymphocytes.y[i])
}

t3$pv1.0 <- -log10(t3$PValue)
for (i in 1:dim(t3)[1])
{
 if(t3$logFC[i] < 0)
   t3$pv1.0[i] <- log10(t3$PValue[i])
}

########################################################
Pituitary       283
204 M; 79 F
+  med$logic[i] <- median(d[i,]) >= 0.1
> print(dim(y))
[1] 27035   283
 79  * 2 * 0.1 - 6 = 9.8 (10 PCs as covar)
> design <- model.matrix( ~ info.2$SEX + info.2$age_value + info.2$body_mass_index + info.2$t.SMRIN + log10(info.2$t.SMTSISCH) +
+ info.2$PC1+info.2$PC2+info.2$PC3+info.2$PC4+info.2$PC5+info.2$PC6+info.2$PC7+info.2$PC8+info.2$PC9+info.2$PC10)
>  dim(design)
[1] 283  16
#######################################################################
> t1 <- read.delim("temp-heart-lv")
  head(t1)
 t2 <- read.delim("diff2-1-left-ventricle-FvsM.age-bmi-RIN-ischem-PC1-21-covar.txt")
 head(t2)
 t3 <- merge(t1, t2, by.x=colnames(t1)[2], by.y="name")
 dim(t3)
# [1] 381  15
 dim(t1)
# [1] 500   6
  cor1 <- cor.test(t3$MASH.beta, t3$logFC, method="spearman")
  par( mar=c(6,6,2,2))
  plot(t3$MASH.beta, t3$logFC, xlab="MASH.beta (PMID: 32913072)", ylab="logFC \n F vs M, P-Lab")
 abline(lm(t3$logFC ~ t3$MASH.beta), lwd = 1, col="blue")

 abline(h = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
 abline(h = 0)
 abline(v = 0)
title(main=paste("left-ventricle ", "r=",round(cor1$estimate, digits = 3), " p=", format(cor1$p.value, digits=3), " (Spearman)", sep =""))

>  dim(eff.p.g)
[1] 34960    15
  t4 <- read.delim("diff2-1-left-ventricle-FvsM.age-bmi-RIN-ischem-PC1-21-covar.txt")
 t4$geneid2 <- gsub("\\.[0-9][0-9]*", "", t4$geneID)
 t5 <- merge(t4, eff.p.g, by.x="geneid2", by.y="geneID")
 dim(t5)
# [1] 14849    25
 dim(t4)
# [1] 15298    11
 t6 <- t5[ t5$chr.x != "chrX" & t5$chr.x != "chrY", ] 
 dim(t6)
# [1] 14362    25
 t6 <- t5[ (!is.na(t5$Heart_Left_Ventricle.x)) & (!is.na(t5$Heart_Left_Ventricle.y)) ,]
 dim(t6)
# [1] 14819    25
 dim( t6[ t6$Heart_Left_Ventricle.y < 0.005 | t6$FDR < 5e-20,])
# [1] 956  25
 t7 <- t6[ t6$Heart_Left_Ventricle.y < 0.005 | t6$FDR < 5e-20,]
 cor1 <- cor.test(t7$Heart_Left_Ventricle.x, t7$logFC, method="spearman")
  par( mar=c(6,6,2,2))
 plot(t7$Heart_Left_Ventricle.x, t7$logFC, xlab="MASH.beta (PMID: 32913072)", ylab="logFC \n F vs M, P-Lab", cex=0.5)
  abline(lm(t7$logFC ~ t7$Heart_Left_Ventricle.x), lwd = 1, col="blue")
  abline(h = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
  abline(v = seq(-100,100,0.5), lty = 5, lwd = 0.5, col = "gray")
  abline(h = 0)
  abline(v = 0)
 title(main=paste("left-ventricle ", "r=",round(cor1$estimate, digits = 3), " p=", format(cor1$p.value, digits=3), " (Spearman)", sep =""))
 
###
> t8 <- read.delim("diff2-1-left-ventricle-FvsM.age-bmi-covar.2.txt")
 dim(t8)
# [1] 15298    10
 t9 <- merge(t8, t7, by.x="geneID", by.y="geneID")
 dim(t9)
# [1] 956  34
 t10 <- t9[, c(3,2,6,7,8,10,12,16,23,26)]
 cor1 <- cor.test(t10$logFC.x, t10$logFC.y, method="s")
 par( mar=c(6,6,2,2))
 plot(t10$logFC.x, t10$logFC.y,  xlab="P-lab (FvsM.age-bmi-covar.)", ylab="logFC \n F vs M, P-Lab", cex=0.3)
 abline(lm(t10$logFC.y ~ t10$logFC.x), lwd = 1, col="blue")

 cor1 <- cor.test(t10$logFC.x, t10$Heart_Left_Ventricle.x, method="s")
 plot(t10$Heart_Left_Ventricle.x, t10$logFC.x,   ylab="P-lab (FvsM.age-bmi-covar.)", xlab="MASH.beta (PMID: 32913072)", cex=0.5)
 abline(lm(t10$logFC.x ~ t10$Heart_Left_Ventricle.x), lwd = 1, col="blue")

######
> t9 <- merge(t8, t6, by.x="geneID", by.y="geneID")
  dim(t9)
# [1] 14819    34  
  t10 <- t9[, c(3,2,6,7,8,10,12,16,23,26)]

t10$logP.x = -999
t10$logP.y = -999
for(i in 1:dim(t10)[1])
{
 if(t10$FDR.x[i] == 0 | t10$FDR.y[i] == 0) 
 {
  print(t10[i,]);
  cat("\n")
 } 
 else 
 {
  a=1 
  b=1 
  if(t10$logFC.x[i] < 0)
    a = -1
  if(t10$logFC.y[i] < 0)
    b = -1
  t10$logP.x[i] = a * (-log10(t10$FDR.x[i]))
  t10$logP.y[i] = b * (-log10(t10$FDR.y[i]))
 }
}

#######################################################################
> t1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/left-ventricle-FvsM.age-bmi-RIN-ischem-PC1-21-covar.noX.Y-weight0-FAO.GseaPreranked.1711332330950/gsea_report_for_na_pos_1711332330950.tsv")
 t2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/left-ventricle-FvsM.age-bmi-RIN-ischem-PC1-21-covar.noX.Y-weight0-FAO.GseaPreranked.1711332330950/gsea_report_for_na_neg_1711332330950.tsv")
 t3 <- rbind(t1,t2)
 t4 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/temp-fa-syn-left-ventricle-FvsM.noX.Y.age-bmi-covar-weight0-FAO.GseaPreranked.1705102308759/gsea_report_for_na_pos_1705102308759.tsv")
 t5 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/temp-fa-syn-left-ventricle-FvsM.noX.Y.age-bmi-covar-weight0-FAO.GseaPreranked.1705102308759/gsea_report_for_na_neg_1705102308759.tsv")
 t6 <- rbind(t4, t5)
 t3.1 <- t3[, c(1,6,7,8)]
 t6.1 <- t6[, c(1,6,7,8)]
 t7 <- merge(t3.1, t6.1, by.x="NAME", by.y="NAME")
 t8 <- t7[ abs( t7$NES.x) > 2 | abs(t7$NES.y) >2 | t7$NAME == "GOBP_FATTY_ACID_BIOSYNTHETIC_PROCESS", ]
 dim(t8)
# [1] 32  7
 t9 <- t8[, c(2,5)]
 rownames(t9) <- t8[, c(1)]
 i <- order(t9$NES.x)
 t9.1 <- t9[i,]

 gs8 <- as.data.frame( t(t9.1))
 colnames(gs8) <-  gsub("HALLMARK_", "h_", colnames(gs8)) 
> par( mar=c(6,2,2,16))
 barplot(as.matrix(gs8), horiz=T, beside=T, yaxt="n",  col=c("orange", "blue"), xlab="GSEA NES (F vs. M)", )
 axis(side=4, at = seq(2, 97, by=3), labels=colnames(gs8), las =1, cex.axis = 0.7)
 abline(h = seq(2, 97, 3), lty = 5, lwd = 0.5, col = "gray")
  abline(v = seq(-100, 100, 2), lty = 5, lwd = 0.5, col = "gray")
  legend(-6, 95, c( "age-bmi-covar", "include 21 latent var"), fill=c("blue", "orange"), cex = 0.7, inset = 0.05)

###
> t4 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/temp-fa-syn-mash.lfsr.left-ventricle-FvsM.noX.Y.weight0-FAO.GseaPreranked.1705100521041/gsea_report_for_na_pos_1705100521041.tsv")
 t5 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/temp-fa-syn-mash.lfsr.left-ventricle-FvsM.noX.Y.weight0-FAO.GseaPreranked.1705100521041/gsea_report_for_na_neg_1705100521041.tsv")
 t6 <- rbind(t4, t5)
####
> t1 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/left-ventricle-FvsM.Hdiseas-filt-268.noX.Y.age-bmi-covar-weight0-FAO.GseaPreranked.1705712974266/gsea_report_for_na_pos_1705712974266.tsv")
  t2 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/left-ventricle-FvsM.Hdiseas-filt-268.noX.Y.age-bmi-covar-weight0-FAO.GseaPreranked.1705712974266/gsea_report_for_na_neg_1705712974266.tsv")
  t3 <- rbind(t1,t2)
  t3.1 <- t3[, c(1,6,7,8)]


> t4 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/left-ventricle-FvsM.age-bmi-RIN-ischem-PC1-21-covar.Hdiseas-268-covar.noX.Y-weight0-FAO.GseaPreranked.1716151956816/gsea_report_for_na_pos_1716151956816.tsv")
 t5 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/left-ventricle-FvsM.age-bmi-RIN-ischem-PC1-21-covar.Hdiseas-268-covar.noX.Y-weight0-FAO.GseaPreranked.1716151956816/gsea_report_for_na_neg_1716151956816.tsv")
 t6 <- rbind(t4, t5)
  t6.1 <- t6[, c(1,6,7,8)]
####
> t4 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/Heart-Atrial-Appendage-FvsM.age-bmi-RIN-ischem-PC1-21-covar.noX.Y-weight0-FAO.GseaPreranked.1711387507076/gsea_report_for_na_pos_1711387507076.tsv")
 t5 <- read.delim("file:///Users/linyongmao/gsea_home/output/microgliaSex/Heart-Atrial-Appendage-FvsM.age-bmi-RIN-ischem-PC1-21-covar.noX.Y-weight0-FAO.GseaPreranked.1711387507076/gsea_report_for_na_neg_1711387507076.tsv")
  t6 <- rbind(t4, t5)
  t6.1 <- t6[, c(1,6,7,8)]
#######################################################################
 sp <- a.df[, c(1,2)]
 sp$rho=-999
 sp$p=-999

for(i in 1:dim(a.df)[1] ) {
t1 <- data.frame(y = t(a.df[i,]), sex = info.2$SEX )
t2 <- cor.test(t1[,1] , t1$sex, method="s")
sp$rho[i] = t2$estimate
sp$p[i]  = t2$p.value
}
head(sp)
 sp$id <- rownames(sp)
 t1 <- merge(df.sex1var.edger, sp, by.x="geneID", by.y="id")
> cor.test(t1$rho, t1$logFC, method="s")
      rho 
0.8921754 

t1$logP.x = -999
t1$logP.y = -999
for(i in 1:dim(t1)[1])
{
 if(t1$PValue[i] == 0 | t1$p[i] == 0)
 {
  print(t1[i,]);
  cat("\n")
 } 
 else 
 {
  a=1 
  b=1 
  if(t1$logFC[i] < 0)
    a = -1
  if(t1$rho[i] < 0)
    b = -1
  t1$logP.x[i] = a * (-log10(t1$PValue[i]))
  t1$logP.y[i] = b * (-log10(t1$p[i]))
 }
}

> t2 <- t1[ t1$chr != "chrY" & t1$name != "XIST",]

####
t3 from diff2-1-BrainCortex-FvsM.edger-spearman-PC8-agebmi.4models
> t4 <- data.frame( edger=t3$logP.x, spear=t3$logP.y, pc8 = t3$logP.PC8, agebmi=t3$logP.agebmi)

#######################################################################
linyong@fry /lab/page_human_data/linyong2$ ls gtex-dna-*/GTEX-*.gene.exon.depth | sort | uniq | wc
    788     788   47010
linyong@fry /lab/solexa_page/linyong$ ls /lab/solexa_page/linyong/gtex-dna-oct2023/*.gene.exon.depth | wc -l
50

 GTEX-11GSO-0003-SM-6WBTR.cram
151-bp single read
400-bp library size
GTEX-12WSK-0003-SM-6WSBW.cram  151M 433
GTEX-14A6H-0003-SM-7DROY.cram 151M 243
GTEX-1C6WA-0003-SM-7J39H.cram  	151M	161
GTEX-1MCYP-0003-SM-DJWXA.cram   	151M	250
GTEX-1QP28-0004-SM-DLIQJ.cram    	151M	155
GTEX-ZP4G-0002-SM-6WBSI.cram  	151M 188
linyong@fry /lab/solexa_page/linyong/gtex-dna$ ~/C++/reSeqPrintChrRegion.fq /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa  out chr6   31996429    31996600
C4B  exon chr6  32029167 32029338 

>chr6 exon 31996429-31996600 172-bp
GAAGCCTCCATCTCAAAGGCAAACTCATTTTTGGGGGAGAAAGCAAGTGCTGGGCTCCTGGGTGCCCACGCAGCTGCCATCACGGCCTATGCCCTGACACTGACCAAGGCGCCTGTGGACCTGCTCGGTGTTGCCCACAACAACCTCATGGCAATGGCCCAGGAGACTGGAG

linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools view GTEX-11GSO-0003-SM-6WBTR.cram chr6:31996429-31996829 | awk '$2 == 163 && $4 <= 31996700 && $5 < 20' |wc
      0       0       0
linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools view GTEX-11GSO-0003-SM-6WBTR.cram chr6:31996429-31996829 | awk '$2 == 163 && $4 <= 31996700 && $5 >= 20' |wc
     33     660   20559
linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools view GTEX-11GSO-0003-SM-6WBTR.cram chr6:31996429-31996829 | awk '$2 == 163 && $4 <= 31996800 && $5 < 20' | cut -f 1-9
H03CRALXX140919:7:1212:26588:8446	163	chr6	31996777	0	151M	=	31997046	420
H03CRALXX140919:7:2220:27806:64246	163	chr6	31996791	0	151M	=	31997069	429

172-bp
chr6_GL000254v2_alt	3371202	3371374	+	1000	172	0	0	0	0	0	0	0
chr6_GL000252v2_alt	3244202	3244374	+	1000	172	0	0	0	0	0	0	0
chr6	31996428	31996600	+	1000	172	0	0	0	0	0	0	0
chr6	32029166	32029338	+	941	167	5(mismatches)	0	0	0	0	0	0

401-bp
chr6_GL000252v2_alt	3244202	3244603	+	1000	401	0	0	0	0	0	0	0
chr6	31996428	31996829	+	1000	401	0	0	0	0	0	0	0
chr6_GL000254v2_alt	3371202	3371603	+	995	400	1	0	0	0	0	0	0
chr6	32029166	32029566	+	965	394	6	0	0	1	1	0	0


samtools view GTEX-11GSO-0003-SM-6WBTR.cram | grep ^H03CRALXX140919:7:2105:13048:72298 | wc -l
3

H03CRALXX140919:7:2105:13048:72298	163	chr6	31996513	60(mapQ)	151M	=	31996767	405	GCCTATGCCCTGACACTGACCAAGGCGCCTGTGGACCTGCTCGGTGTTGCCCACAACAACCTCATGGCAATGGCCCAGGAGACTGGAGGTGAGGGGTGAGGCGCTCCTGGCAGTAGGCCTGAAGCCCAGGTGACCTTAGAATCCCTGAATG (6 mismatches)
H03CRALXX140919:7:2105:13048:72298	83	chr6	31996767	40	151M	=	31996513	-405	GCCAGGGGACCAGGCTCTTCTCCCTGCCTTCCTGTTTACTTGTGGTCTCCCTTCACTTTCAGATAACCTGTACTGGGGCTCAGTCACTGGTTCTCAGAGCAATGCCGTGTCGCCCACCCCGGCTCCTCGCAACCCATCCGACCCCATGCCC (1 mismatch)

IGV blat mapping: chr6_GL000255v2_alt	3252484	3252635	+	920	145	6	0	0	0	0	0	0
H03CRALXX140919:7:2105:13048:72298	2131(supplementary alignment )	chr6_GL000255v2_alt	3252739	0	151M	chr6	31996513	-405	GCCAGGGGACCAGGCTCTTCTCCCTGCCTTCCTGTTTACTTGTGGTCTCCCTTCACTTTCAGATAACCTGTACTGGGGCTCAGTCACTGGTTCTCAGAGCAATGCCGTGTCGCCCACCCCGGCTCCTCGCAACCCATCCGACCCCATGCCC		SA:Z:chr6,31996767,-,151M,40,1;	MC:Z:151M		NM:i:0	
expr  3252739 -   3252484 = 255



##################################
linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools view -q 1 -b -o GTEX-11GSO-0003-SM-6WBTR.c4.bam GTEX-11GSO-0003-SM-6WBTR.cram     chr6:31982057-32002681 chr6:32014795-32035418
samtools index GTEX-11GSO-0003-SM-6WBTR.c4.bam

linyong@fry /lab/solexa_page/linyong/gtex-dna$  samtools coverage -r  chr6:31982057-32002681 -q 20 GTEX-11GSO-0003-SM-6WBTR.cram
#rname  startpos        endpos  numreads        covbases        coverage        meandepth       meanbaseq       meanmapq
chr6    31982057        32002681        656     3485    16.897  4.69105 255     36.9
linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools coverage -r chr6:32014795-32035418  -q 20 GTEX-11GSO-0003-SM-6WBTR.cram
#rname  startpos        endpos  numreads        covbases        coverage        meandepth       meanbaseq       meanmapq
chr6    32014795        32035418        635     3221    15.6177 4.62064 255     33.8

linyong@fry /lab/solexa_page/linyong/gtex-dna$  samtools coverage -r  chr6:31982057-32002681 -q 0 GTEX-11GSO-0003-SM-6WBTR.cram
#rname  startpos        endpos  numreads        covbases        coverage        meandepth       meanbaseq       meanmapq
chr6    31982057        32002681        6518    20625   100     46.6363 255     3.78
linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools coverage -r chr6:32014795-32035418  -q 0 GTEX-11GSO-0003-SM-6WBTR.cram
#rname  startpos        endpos  numreads        covbases        coverage        meandepth       meanbaseq       meanmapq
chr6    32014795        32035418        6403    20624   100     46.0028 255     3.42
GTEX-11GSO-0003-SM-6WBTR        C4-tot  5.85712 C4Aexon172bp    126     100     51.3    3.25719 C4Bexon172bp    71      100     47.6    2.57164
total 5.85copies; C4A 3.25, C4B 2.57
> new call: c4a 2.98, c4b 2.88

########################
linyong@fry /lab/solexa_page/linyong/gtex-dna$  samtools coverage -r  chr6:31982057-32002681 -q 20 GTEX-12WSK-0003-SM-6WSBW.cram
#rname  startpos        endpos  numreads        covbases        coverage        meandepth       meanbaseq       meanmapq
chr6    31982057        32002681        575     3710    17.9879 4.16533 255     36.5

linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools view -q 20 GTEX-12WSK-0003-SM-6WSBW.cram  chr6:31982057-32002681 | cut -f 2 | sort | uniq -c
     56 1107
     61 1123
     61 1171
     56 1187
      1 145
    149 147
    138 163
      2 81
    138 83
    147 99
numreads (not pairs)
149 + 138 + 138 + 147 = 572
meandepth
572 * 151 / (32002681 - 31982057) = 4.187936


linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools coverage -r chr6:32014795-32035418  -q 20 GTEX-12WSK-0003-SM-6WSBW.cram
#rname  startpos        endpos  numreads        covbases        coverage        meandepth       meanbaseq       meanmapq
chr6    32014795        32035418        471     3725    18.0615 3.43808 255     34.6
linyong@fry /lab/solexa_page/linyong/gtex-dna$ samtools view -q 20 GTEX-12WSK-0003-SM-6WSBW.cram chr6:32014795-32035418 |   awk 'BEGIN {FS = "\t";} !($2 != 99 && $2 != 147 && $2 != 83 && $2 != 163)' | wc
    468    
numreads 468
meandepth  468 * 151 / (32035418 - 32014795) =  3.42666
 
572 / 468 = 1.22
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat cnv.dna.depth.gtex.donors.txt  | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, "C4-tot", ($15 + $18) * 2 * 2/ ($3 + $5)}'  | grep GTEX-12WSK-0003-SM-6WSBW
GTEX-12WSK-0003-SM-6WSBW        C4-tot  5.71117
C4A 5.71117 * 572 / (572 + 468) = 3.14
C4B 5.71117 * 468 / (572 + 468) = 2.57
GTEX-12WSK-0003-SM-6WSBW	C4-tot	5.71117	C4Aexon172bp	101	100	47.4	2.52488	C4Bexon172bp	67	100	46.4	2.16944
##########
GTEX-14A6H-0003-SM-7DROY        C4-tot  3.86138 C4Aexon172bp    61      100     47.6    1.67108 C4Bexon172bp    120     100     51.2    3.38283
new call:
c4a
> 3.86138 * 410/(410 + 648)
[1] 1.496376
c4b
> 3.86138 * 648/(410 + 648)
[1] 2.365004

##################################################################################
-rw-r--r--@ 1 linyongmao  staff   477K Jul 12 15:17 gencode.v42.19385.protein_coding.geneID-name.txt
ENSG00000284662.2       OR4F16
ENSG00000187634.13      SAMD11

linyongmao@Linyong-Mao-MBP16-2019 autism % cat script-hallmark50-hallmark50-overlap-fisher  
#

ls ../microglia/HALLMARK*  | grep -v temp > temp-f1
wc -l temp-f1

cut -f 2 ../dir-GTExV8/gencode.v42.19385.protein_coding.geneID-name.txt | sort | uniq > temp-bg-genes
wc -l temp-bg-genes

cat temp-f1 | while read f
do
 bash   script-inputset-pathways-overlap-fisher-fdr "$f" "$f" temp-f1 temp-bg-genes
done
####################

linyongmao@Linyong-Mao-MBP16-2019 autism % bash script-hallmark50-hallmark50-overlap-fisher  > temp.txt &
P.value oddsratio       fdr
../microglia/HALLMARK_ADIPOGENESIS.genes        ../microglia/HALLMARK_ALLOGRAFT_REJECTION.genes 1       199     199     18982   0.72687584137068        0.479334996528802       0.886433952891073

linyongmao@Linyong-Mao-MBP16-2019 autism % cat temp.txt | awk '$1 > $2 && $7 < 0.05 /(50*49/2)' |wc
     161    

rm -f temp1   
cat temp.txt |head  | grep test.set > temp1
cat temp.txt | awk '$1 > $2 && $7 < 0.05 /(50*49/2) && $8 > 1' | sed 's#../microglia/HALLMARK#h#g' >> temp1

> t1 <- read.delim("temp1")
 summary(t1)
 t1$jacc <- t1$input.overlap / (t1$input.overlap + t1$input.notoverlap + t1$noninput.overlap)
 head(t1)
 summary(t1$jacc)
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
# 0.02174 0.03049 0.03746 0.05375 0.05820 0.33779
 t1$jacc.cater <- t1$jacc  %/% 0.025
 colnames(t1)
 t2 <- t1[, c(1,2,7,11)]
 plot(t2$jacc.cater, -log10(t2$P.value), col="red")
 write.table(t2, "temp3", quote=F, sep="\t")

linyongmao@Linyong-Mao-MBP16-2019 autism % vi temp3

> t3 <- (t1[ t1$jacc >= 0.025 * 2, c(1,2,7,11)])
 write.table(t3, "temp4", quote=F, sep="\t")
linyongmao@Linyong-Mao-MBP16-2019 autism %  vi temp4

################################################################################
error:    "file_name": "GTEX-WYVS-0002-SM-5URCN.cram",


linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$ ls -l *.bam | awk '{print $5/1e6}' |sort -n | head
64.5457
79.5114
96.1897
97.4519
98.2604
98.3616

########################################################################################
samtools sort -n -@ 6 -o "$f".name-sorted.bam "$f".1.bam

htseq-count  --mode=union --stranded=no --idattr=gene_id --format=bam --additional-attr=gene_name -a 10 --order=name --type=exon temp-13QJC.name.bam /lab/solexa_page/linyong/gencode/gencode.v42.primary_assembly.noPar.annotation.gtf   > temp-13QJC.coun.gene.2
   
-a 0
temp-13QJC.coun.gene.a0
Warning: 22357 reads with missing mate encountered.
__no_feature            404248
__ambiguous             30358
__too_low_aQual         0
__not_aligned           11065
__alignment_not_unique          0

ENSG00000224389.9       C4B     1652
ENSG00000229776.1       C4B-AS1 245
ENSG00000233627.2       C4A-AS1 245
ENSG00000244731.10      C4A     1572

-a 10 
Warning: 22357 reads with missing mate encountered.

__no_feature            396564
__ambiguous             29529
__too_low_aQual         14381
__not_aligned           11065
__alignment_not_unique          0

temp-13QJC.coun.gene.2:ENSG00000224389.9        C4B     283
temp-13QJC.coun.gene.2:ENSG00000229776.1        C4B-AS1 0
temp-13QJC.coun.gene.2:ENSG00000233627.2        C4A-AS1 0
temp-13QJC.coun.gene.2:ENSG00000244731.10       C4A     304

-a 20
temp-13QJC.coun.gene.3
Warning: 22357 reads with missing mate encountered.
__no_feature            395750
__ambiguous             29502
__too_low_aQual         15337
__not_aligned           11065
__alignment_not_unique          0

ENSG00000224389.9       C4B     278
ENSG00000229776.1       C4B-AS1 0
ENSG00000233627.2       C4A-AS1 0
ENSG00000244731.10      C4A     295

##################################################################
linyong@fry /lab/solexa_page/linyong$ cat */slurm-dna-bam-to-genecount
#!/bin/bash
# Configuration values for SLURM job submission.
# One leading hash ahead of the word SBATCH is not a comment, but two are.
#SBATCH --job-name="dna-bam-genecount" # friendly name for job.
#SBATCH --nodes=1                      # ensure cores are on one node
#SBATCH --ntasks=1                     # run a single task
#SBATCH --cpus-per-task=4              # number of cores/threads requested. sort bam according to read name
#SBATCH --mem=40gb                      # memory requested.
#SBATCH --partition=20                 # partition (queue) to use
#SBATCH --output out-dna-bam-genecount-9-4-2024
#SBATCH --mail-type=ALL               # send email on job start/finish.
#SBATCH --mail-user=linyong@wi.mit.edu

# This is the actual section for commands to run

# Uncomment the last line to email output file to specified address.
# Slurm doesn't do this automatically, regardless of the mail-type setting above.
#/usr/bin/mail -s "$SLURM_JOB_NAME $SLURM_JOB_ID" your_username@wi.mit.edu < friendlyname-${SLURM_JOB_ID}.out

ls GTEX*.bam | wc -l

ls GTEX*.bam | while read ll
do
 f=`echo "$ll" | sed 's/.bam$//' `
 echo "$f"
 samtools sort -n -@ 6 -o "$f".name-sorted.bam "$f".bam

 htseq-count  --mode=union --stranded=no --idattr=gene_id --format=bam --additional-attr=gene_name  --order=name --type=exon "$f".name-sorted.bam  /lab/solexa_page/linyong/gencode/gencode.v42.primary_assembly.noPar.annotation.gtf   > "$f".gene-count
 rm -f "$f".name-sorted.bam
done

###########################################################################
ls  /lab/solexa_page/linyong/temp-gtexv8-* | wc -l
834
-rw-r--r-- 1 linyong systemd-timesync 0 Sep  6 22:29 GTEX-NL3H-0009-SM-5JK37.gene-count
-rw-r--r-- 1 linyong systemd-timesync 0 Sep  7 03:02 GTEX-Q2AH-0004-SM-5JK52.gene-count
-rw-r--r-- 1 linyong systemd-timesync 0 Sep  7 07:44 GTEX-S7SE-0004-SM-5JK4E.gene-count
-rw-r--r-- 1 linyong systemd-timesync 0 Sep  7 13:27 GTEX-WOFM-0003-SM-5JK3H.gene-count
 100000 alignment record pairs processed.
200000 alignment record pairs processed.
300000 alignment record pairs processed.
Error occured when processing input (record #601424 in file GTEX-NL3H-0009-SM-5JK37.name-sorted.bam):
  'pair_alignments' needs a sequence of paired-end alignments
  [Exception type: ValueError, raised in __init__.py:463]
samtools view -bf 1 GTEX-NL3H-0009-SM-5JK37.name-sorted.bam > GTEX-NL3H-0009-SM-5JK37.paired-end.bam
samtools view -bF 1 GTEX-NL3H-0009-SM-5JK37.name-sorted.bam > GTEX-NL3H-0009-SM-5JK37.single-end.bam
samtools view GTEX-NL3H-0009-SM-5JK37.paired-end.bam | cut -f 2 | sort | uniq > temp3
samtools view GTEX-NL3H-0009-SM-5JK37.single-end.bam | cut -f 2 | sort | uniq > temp4
cat temp3 temp4 | sort | uniq -d |wc
      0       0       0
rm -f temp3 temp4
samtools view GTEX-NL3H-0009-SM-5JK37.paired-end.bam | cut -f 1 | uniq | wc
 656231
samtools view GTEX-NL3H-0009-SM-5JK37.paired-end.bam | cut -f 1 | uniq > temp1
sort temp1 | uniq -u | wc
 656231
###temp1: A B C D A E F A
###all uniq in temp1
###read name sorted
sort temp1 | uniq -d | wc
      0     
rm -f temp3 temp4
samtools view GTEX-NL3H-0009-SM-5JK37.paired-end.bam | cut -f 1 | uniq > temp3
samtools view GTEX-NL3H-0009-SM-5JK37.single-end.bam | cut -f 1 | uniq > temp4
cat temp3 temp4 | sort | uniq -d | wc
   0  

#######################################################################################
merge dna-bwa-htseq gene-count files

linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$ cat temp-s2
#
ls -lh GTEX*.gene-count | awk '$5 == 0 {print $9}' | while read ll
do
 ls -lh $ll
 p=`echo "$ll" | sed 's/.gene-count//' `
 ls -lh  "$p".gene-count.pair
 cp "$p".gene-count.pair "$p".gene-count
done

linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$ pwd  > dir-list
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$ bash script-genecount-merge-3
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$ cat  /lab/solexa_page/linyong/temp-error | grep -v "cannot access" |head |wc
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$ ls  /lab/solexa_page/linyong/temp-gtexv8-* | wc -l
838
cd /lab/solexa_page/linyong/
rm -f temp1
linyong@fry /lab/solexa_page/linyong$ sbatch slurm-paste-files
# bash script-paste-files-3
ls -lh s  f2 m
grep -n '__no_feature' s | cut -f 1-10
awk 'NR < 62705' s > temp1
linyong@fry /lab/solexa_page/linyong$ mv -i temp1 gtex-dna-c4a-c4b.gene.count.txt
chmod -w  gtex-dna-c4a-c4b.gene.count.txt
linyong@fry /lab/solexa_page/linyong$ awk '{print NF}' gtex-dna-c4a-c4b.gene.count.txt | uniq -c | head
  62704 840
rm -f s
linyong@fry /lab/solexa_page/linyong$ rmmmm -f  temp-gtexv8-*.gene-count

#################################################################"gtex-dna-c4a-c4b.gene.count.txt"
 t1 <- read.delim("gtex-dna-c4a-c4b.gene.count.txt")
 dim(t1)
# [1] 62703   840
 n = dim(t1)[2] - 2
 t2 <- t1[, 3:(n+2)]
 rownames(t2) <- t1$geneID
 t3 <- t2[,1:2]
 t3$logic <- TRUE
for(i in 1:dim(t2)[1]) {
 t3$logic[i] <- median( as.numeric( t2[i,])) >= 10
}

 t2 <- t2[ t3$logic,]
 dim(t2)
# [1] 285 838
 y <- DGEList(counts=t2)
 y <- calcNormFactors(y)
 summary(y$samples$lib.size/1e3)
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
#   62.53  141.03  155.46  156.24  167.19  351.34
 summary(y$samples$norm.factors)
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
#  0.8741  0.9957  1.0010  1.0001  1.0057  1.0337
 a.df <- as.data.frame(cpm(y))

                         group lib.size norm.factors
GTEX.NPJ8.0004.SM.CLTG5.     1    62533    0.8740897
GTEX.NPJ8.0004.SM.CLTG5.   39.3049 (($3 + $5)/2, median of seq depth)

                          group lib.size norm.factors
GTEX.1477Z.0003.SM.6WSBA.     1   178889    0.9907584
GTEX.1477Z.0003.SM.6WSBA   25.5466

                          group lib.size norm.factors
GTEX.131XH.0003.SM.7DRPA.     1   320650    0.9991137
GTEX.131XH.0003.SM.7DRPA   73.3575

                         group lib.size norm.factors
GTEX.T6MN.0003.SM.5URB7.     1   142033    0.9937414
GTEX.T6MN.0003.SM.5URB7   39.3312


res <- a.df[,1:6]
 for(i in 1:dim(a.df)[1]) {
  res[i,]  <- summary(2* as.numeric( a.df[i, ])/median(as.numeric( a.df[i, ])))
}
 colnames(res) <- c("min", "f.qu", "median", "mean", "t.qu", "max")
 res$geneID <- rownames(res)
gene.name <- t1[, 1:2]
df.gene <- merge(res, gene.name, by.x="geneID", by.y="geneID")
 df.gene[ df.gene$name == "C4A",]
#                 geneID      min     f.qu median     mean     t.qu      max name
# 229 ENSG00000244731.10 0.154408 1.640286      2 1.964057 2.315535 5.984964  C4A
 df.gene[ df.gene$name == "C4B",]
#                geneID       min     f.qu median     mean     t.qu      max name
# 150 ENSG00000224389.9 0.2507122 1.673204      2 1.987984 2.268299 4.832178  C4B
 df.gene[ df.gene$min > 1.5 & df.gene$max < 2.5,]
 t6 <- as.numeric( a.df[rownames(a.df) == "ENSG00000244731.10", ])
 boxplot(2 * t6 / median(t6), outcol="white", main="C4A")
 beeswarm(2 * t6 / median(t6), add=T, cex=0.7)
 abline(h = seq(0,10000,0.5), lty = 5, lwd = 0.5, col = "gray")

 t6 <- as.numeric( a.df[rownames(a.df) == "ENSG00000224389.9", ])
 boxplot(2 * t6 / median(t6), outcol="white", main="C4B")
 beeswarm(2 * t6 / median(t6), add=T, cex=0.7)
 abline(h = seq(0,10000,0.5), lty = 5, lwd = 0.5, col = "gray")

####################################################################
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$ cat slurm-gtexv8-bam-c4a-depth.q20
#!/bin/bash
# Configuration values for SLURM job submission.
# One leading hash ahead of the word SBATCH is not a comment, but two are.
#SBATCH --job-name="c4a-depth-q20" # friendly name for job.
#SBATCH --nodes=1                      # ensure cores are on one node
#SBATCH --ntasks=1                     # run a single task
#SBATCH --cpus-per-task=4              # number of cores/threads requested. sort bam according to read name
#SBATCH --mem=40gb                      # memory requested.
#SBATCH --partition=20                 # partition (queue) to use
#SBATCH --output out-c4a-depth-q20-sep-12-24
#SBATCH --mail-type=ALL               # send email on job start/finish.
#SBATCH --mail-user=linyong@wi.mit.edu

# This is the actual section for commands to run

# Uncomment the last line to email output file to specified address.
# Slurm doesn't do this automatically, regardless of the mail-type setting above.
#/usr/bin/mail -s "$SLURM_JOB_NAME $SLURM_JOB_ID" your_username@wi.mit.edu < friendlyname-${SLURM_JOB_ID}.out

ls GTEX*.bam > file1
wc -l file1

cat file1 | head -1000 |  while read ll 
do
 f2=`echo "$ll" | sed 's/.bam$//' `
 bash script-bam-c4a-depth "$ll" > "$f2".c4a.q20.depth 
done
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$ 


linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$ cat  script-bam-c4a-depth 
#
if [ $# -lt 1 ]
then
  echo $0 "	bam-file"
  echo $#
  exit 1
fi

cram="$1"
f=`echo "$cram" | sed 's/.bam$//' `
samtools index "$cram"
ls -lh "$f".bam*

prev="header	geneID	geneName	header	"
echo -n "$prev"
samtools coverage -r chr1:1-1000 -q 0   "$cram" | head -1

for g in `echo C4A C4B`
do
   ll=`cat /lab/solexa_page/linyong/gencode.v42.primary_assembly.noPar.protein.xist.exons.gtf | grep "	gene	.*	.*	.*	.* gene_name \"$g\";" | head -1`
  t1=`echo "$ll" |  awk 'BEGIN {FS = "\t";} {print NF}' `

  if [ "$t1" -gt 8 ]
  then
     geneid=`echo "$ll" | cut -f 9 | awk 'BEGIN {FS=";"} {print $1}' | sed 's/gene_id "//' | sed 's/"//' `
     prev="$f	$geneid	$g	geneIntv	"
     R=`echo "$ll" | awk 'BEGIN {FS="\t"} {print  $1 ":" $4 "-" $5 }' `
     echo -n "$prev"
     samtools coverage -r "$R" -q 20 -H "$cram" 

  fi 
done

rm "$f".bam.bai
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$  

######################################################################################################
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$ cat script-cnv-02
#

ls GTEX*.c4a.q20.depth > temp-gene.exon.depth-file
wc temp-gene.exon.depth-file

cat temp-gene.exon.depth-file | head -12345 | while read ll
do
 s=`echo "$ll" | sed 's/.*\///' | sed 's/.c4a.q20.depth//' `
 c4a=`cat "$ll" | grep "	C4A	" | grep -w geneIntv |head -1 | cut -f 5-20`
 c4b=`cat "$ll" | grep "	C4B	" | grep -w geneIntv |head -1 | cut -f 5-20`
 echo "$s	C4A	$c4a	C4B	$c4b"

done

linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$ 

linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$ bash script-cnv-02 > temp.txt
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % mv -i temp.txt gtex-dna-c4a-c4b.gene.depth.samtools.q20.txt
vi gtex-dna-c4a-c4b.gene.depth.samtools.q20.txt
> t1 <- read.delim("gtex-dna-c4a-c4b.gene.depth.samtools.q20.txt", header=T)
 head(t1)
 plot(t1$C4A.numreads, t1$C4A.meandepth, main="samtools coverage -q 20")
 abline(v = seq(0,10000,100), lty = 5, lwd = 0.5, col = "gray")
 abline(h = seq(0,10000,1/2), lty = 5, lwd = 0.5, col = "gray")
 abline(h = seq(0,10000,1), lty = 5, lwd = 0.5, col = "blue")

 plot(t1$C4B.numreads, t1$C4B.meandepth, main="samtools coverage -q 20")
 abline(v = seq(0,10000,100), lty = 5, lwd = 0.5, col = "gray")
 abline(h = seq(0,10000,1/2), lty = 5, lwd = 0.5, col = "gray")
 abline(h = seq(0,10000,1), lty = 5, lwd = 0.5, col = "blue")

 t2 <- read.delim("cnv.dna.depth.gtex.donors.txt", header=F)
 head(t2)
 t2$seq.dep <- (t2$V3 + t2$V5)/2
 t2$c4.tot <- (t2$V15 + t2$V18)/t2$seq.dep * 2
 colnames(t2)
 t3 <- t2[ , c(1,2,4,19,20)]
 t6 <- merge(t3, t1, by.x="V1", by.y="donor")
 dim(t6)
# [1] 838  25
 t6$c4a <- t6$C4A.meandepth / t6$seq.dep
 t6$c4b <- t6$C4B.meandepth / t6$seq.dep
 hist(t6$c4.tot, breaks=seq(0, 12, 0.5/2/2))
 abline(v = seq(0,10000,1), lty = 5, lwd = 0.7, col = "blue")
 t6$c4a.cn <- t6$c4a / median(t6$c4a)*2
 t6$c4b.cn <- t6$c4b / median(t6$c4b)*2
 summary(t6$c4a)
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.01066 0.09534 0.12161 0.12170 0.14729 0.30583 
 summary(t6$c4b)
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.01393 0.09250 0.11176 0.11238 0.13107 0.25703 
 hist(t6$c4a.cn,  breaks=seq(0, 6, 0.5/2/2))
 abline(v = seq(0,10000,1/2), lty = 5, lwd = 0.7, col = "blue")
 hist(t6$c4b.cn,  breaks=seq(0, 6, 0.5/2/2))
 abline(v = seq(0,10000,1/2), lty = 5, lwd = 0.7, col = "blue")

> t6.c4a.c4b.cn <- t6
 info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
 info$sid <-  gsub("-", ".", info$SAMPID)
 info$sid <-  paste( info$sid, ".", sep="")
 t3 <- merge(t6.c4a.c4b.cn, info, by.x="V1", by.y="SAMPID")
 dim(t3)
# [1] 838  35
 c4.cn <- t3
###cmds from script-gtexv8-tissue-sex-diff-age-bmi-covar
###Liver        226
diff <- as.data.frame(cpm(y))
gene.name <- raw[, 1:2]
 gene.name[ gene.name$name %in% c("C4A", "C4B"),]
#                   geneID name
# 25277  ENSG00000224389.9  C4B
# 37237 ENSG00000244731.10  C4A

 g1 <- gene.name[ gene.name$name %in% c("C4A", "C4B"),]$geneID
 g2 <- as.data.frame( t(diff[ rownames(diff) %in% g1,]))
 str(g2)
 g2$sample <- rownames(g2)
 g3 <- merge(g2, info, by.x="sample", by.y="sid")
 dim(g3)
# [1] 226   9
 g4 <- merge(g3, c4.cn, by.x="SUBJID", by.y="SUBJID")
 dim(g4)
# [1] 208  43
# > 208/226
# [1] 0.920354

> cor.test(log2(g4$ENSG00000244731.10), g4$c4a.cn, method="p")

        Pearson's product-moment correlation
data:  log2(g4$ENSG00000244731.10) and g4$c4a.cn
t = 5.187, df = 206, p-value = 5.097e-07
      cor
0.3398804
> cor.test(log2(g4$ENSG00000224389.9), g4$c4b.cn, method="p")

        Pearson's product-moment correlation
data:  log2(g4$ENSG00000224389.9) and g4$c4b.cn
t = 1.8578, df = 206, p-value = 0.06462
      cor
0.1283708

##############################################################
 identical(t6.c4a.c4b.cn , t6)
# 0.8917315 is the median of (t6$c4a.cn + t6$c4b.cn) / t6$c4.tot
 t10 <- (t6$c4a.cn + t6$c4b.cn)/ 0.8917315
 ss1 <- sum( (t6$c4.tot - t10)^2 )
 ss2 <- sum( (t6$c4.tot - mean(t6$c4.tot))^2 )
 r2 <- 1 - ss1/ss2
#R-squared, r^2, Rsquared
##############################################################
 raw2 <- raw[, 3:17352 ]
 rownames(raw2) <- raw$geneID
 head(raw2[, 1:11])
y <- DGEList(counts=raw2)
y <- calcNormFactors(y)
dim(y)
# [1] 62703 17350
##############################################################################################
c4a-c4b snv
linyong@fry /lab/solexa_page/linyong$ ~/C++/reSeqPrintChrRegion.fq /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa  out chr6 1 32008096 > temp-chr6.fa  
-rw-r--r-- 1 linyong systemd-timesync 31M Jan  1 12:04 temp-chr6.fa
linyong@fry /lab/solexa_page/linyong/dir-temp$ mv -i ../temp-chr6.fa ./
linyong@fry /lab/solexa_page/linyong/dir-temp$ bwa index temp-chr6.fa
~/C++/reSeqPrintChrRegion.fq /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa  out chr6 32012795 32037418 > temp.c4b.fa
bwa bwasw  -f temp.c4b.sam  -t 10   temp-chr6.fa  temp.c4b.fa
samtools view -b -S -o temp.c4b.bam temp.c4b.sam
samtools sort -@ 4 -o  temp.c4b.sort.bam  temp.c4b.bam
samtools mpileup -Q 0  -q 17 -d 1000000 -f  temp-chr6.fa  temp.c4b.sort.bam >  temp.c4b.pileup
wc -l temp.c4b.pileup   
24151 temp.c4b.pileup   
cat temp.c4b.pileup |awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 != "." '  > temp
28 lines -> 24 lines (del the following 4 lines)
chr6    31980532        C       1       ^~.     ~
chr6    31996617        T       1       .-1C    ~
chr6    32004591        A       1       .-1G    ~
chr6    32004682        G       1       .$      ~
 cat temp > c4a.c4b.snv
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat c4a.c4b.snv | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, $2-1, $2, $3 $5}' > temp.bed
cat  temp.bed | grep '*' > temp.del.bed
cat  temp.bed | grep -v '*' > temp.snp.bed
################################################
 hist(t6$c4.tot, breaks=seq(0, 12, 0.5/2/2), xlab="total C4 copy number", main="C4A+C4B copy number")
> abline(v = seq(-100, 1000, 1), lty = 5, lwd = 0.5, col = "grey")
> abline(v = seq(-100, 1000, 2), lty = 5, lwd = 0.5, col = "blue")
> ggplot(t6, aes(x=c4.tot)) + geom_freqpoly(binwidth = 1/6, center=0) + scale_x_continuous(breaks=seq(0, 12, 2), limits=c(0, 12))

> medi=median ((t6$c4a.cn + t6$c4b.cn)/t6$c4.tot)
> medi
[1] 0.8917315
> hist(t6$c4a.cn/medi, breaks=seq(0, 6, 0.5/2/2), xlab="C4A copy number")
 hist(t6$c4a.cn/medi, breaks=seq(0, 6, 0.5/2/2), xlab="C4A copy number", probability=T, main="")
  abline(v = seq(0, 1000, 1), lty = 5, lwd = 0.5, col = "blue")
  d <- density(t6$c4a.cn/medi)
  lines(d$x, d$y, col="red")
 df <- ""
 df1 <- data.frame(CN = t6$c4a.cn/medi, gene= "C4A")
 df2 <- data.frame(CN = t6$c4b.cn/medi, gene= "C4B")
 df <- rbind(df1, df2)
 dim(df)
#  [1] 1676    2
> ggplot(df, aes(x=CN, color = gene)) + geom_freqpoly(binwidth = 1/5, center=0)

> med1 <- median(t6$c4a + t6$c4b)
> med2 <- median(t6$c4.tot)
> med2/med1
[1] 19.77512
> t1 <- data.frame(C4.tot=t6$c4.tot, norm.c4a.plus.c4b.19.77 = (t6$c4a + t6$c4b)*med2/med1 )
> boxplot(t1)
> abline(h = seq(-100, 1000, 1), lty = 5, lwd = 0.5, col = "blue")

 plot(t1$norm.c4a.plus.c4b.19.77,t1$C4.tot)
 abline(h = seq(-100, 1000, 1), lty = 5, lwd = 0.5, col = "grey")
 abline(v = seq(-100, 1000, 1), lty = 5, lwd = 0.5, col = "grey")
 x1 = 1:5
 y1=x1
 abline(lm(y1 ~ x1), col="blue")
 t10 <- t1$norm.c4a.plus.c4b.19.77
 ss1 <- sum( (t1$C4.tot - t10)^2 )
 ss2 <- sum( (t1$C4.tot - mean(t1$C4.tot))^2 )
 r2 <- 1 - ss1/ss2
 r2
#  [1] 0.754645

> medi
[1] 0.8917315
> c4a.cn.medi <- t6$c4a.cn/medi
> c4b.cn.medi <- t6$c4b.cn/medi
> lm1 <- lm(t6$c4.tot ~ c4a.cn.medi + c4b.cn.medi  )
 plot(0.85547 + c4a.cn.medi * 1.06690 + c4b.cn.medi * 0.57072, t6$c4.tot, ylab="total C4 copy number"  )
 abline(v = seq(-100, 1000, 1), lty = 5, lwd = 0.5, col = "grey")
 abline(h = seq(-100, 1000, 1), lty = 5, lwd = 0.5, col = "grey")
 x1 = 1:5
  y1=x1
  abline(lm(y1 ~ x1), col="red")

 plot( c4a.cn.medi  + c4b.cn.medi , t6$c4.tot, ylab="total C4 copy number"  )
##############################################################################
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % Rscript c4a-c4b-cnv-q20-corr-express-batch-1 > temp-1
cat temp-1 | awk 'BEGIN {FS = "\t"; OFS = "\t"} NF > 9'  > temp-1.txt

##############################
pasted from c4a-only-copyNumber-exon-depth.xlsx
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % vi temp.txt
cat temp.txt |head -1 > temp1
cat temp.txt | awk 'NR > 1' | sort -t '  ' +5 -6n  >> temp1

 t1 <- read.delim("temp1")
 t2 <- data.frame( c4b.r = t1$c4b.cn.expr.corr, c4a.r = t1$c4a.cn.expr.corr)
 rownames(t2) <- t1$X
 t3 <- as.data.frame(t(t2))
 par( mar=c(6,2,2,12))
 barplot(as.matrix(t3), horiz=T, beside=T, yaxt="n", col=c("blue", "orange"), xlab="(gene expression ~ CN) correlation", xlim= c(-0.15, 0.45))
 axis(side=4, at = seq(2, 148, by=3), labels=colnames(t3), las =1, cex.axis = 0.6)
  abline(v = seq(-1000, 15, 0.1), lty = 5, lwd = 0.5, col = "gray")
 abline(h = seq(2, 148, by=3), lty = 5, lwd = 0.5, col = "gray")
  legend(-0.15, 2+3*45, c( "C4A", "C4B"), fill=c( "orange", "blue"), cex = 0.6, inset = 0.05)

> t1[ t1$c4a.cn.expr.corr.pval < 1e-15,]
                X X.samp X.samp.genotype X.samp.F X.samp.M c4a.cn.expr.corr c4a.cn.expr.corr.pval c4b.cn.expr.corr
45        Thyroid    653             574      196      378        0.3535121              9.34e-19        0.1959386
48 Nerve - Tibial    619             532      177      355        0.4067271              0.00e+00        0.2726965

rho= 0.4067271, p-value < 2.2e-16
lm(formula = log10(g4$ENSG00000244731.10 + 1) ~ g4$c4a.cn), Multiple R-squared:  0.2015, pVal= 9.685219e-28

 t1 <- read.delim("temp1")
 t2 <- data.frame(c4b.p = t1$c4b.cn.expr.corr.pval, c4a.p = t1$c4a.cn.expr.corr.pval)
 rownames(t2) <- t1$X
 t2[ t2$c4a.p == 0,]
 t2[ t2$c4a.p == 0,]$c4a.p = 1e-19
 t2$c4b.fdr <- p.adjust(t2$c4b.p, method="fdr")
 t2$c4a.fdr <- p.adjust(t2$c4a.p, method="fdr")
 t3 <- as.data.frame(t( t2[, c(3,4)]))
 par( mar=c(6,2,2,12))
 barplot(as.matrix(t3), horiz=T, beside=T, yaxt="n", col=c("blue", "orange"), xlab="(gene expression ~ CN) correlation", xlim= c(-0.15, 0.45))
 barplot(as.matrix(-log10(t3)), horiz=T, beside=T, yaxt="n", col=c("blue", "orange"), xlab="(gene expression ~ CN) corr. log10(FDR)", xlim=c(0, 20) )
  axis(side=4, at = seq(2, 148, by=3), labels=colnames(t3), las =1, cex.axis = 0.6)
  abline(v = seq(-1000, 15, 2.5), lty = 5, lwd = 0.5, col = "gray")
 abline(v=2, col="red")
  abline(h = seq(2, 148, by=3), lty = 5, lwd = 0.5, col = "gray")
   legend(10, 2+3*15, c( "C4A", "C4B"), fill=c( "orange", "blue"), cex = 0.6, inset = 0.05)
 text(2, 5, "FDR = 0.01", pos=4, col="red")

######################################################################################
linyong@fry /lab/solexa_page/linyong/gtex-dna-test$ cat temp.sex-chr.1.txt | awk '$5 < 0.5 && $5 > 0.3' |head
GTEX-1OKEX-0003-SM-DJWXH        chrX    0.948842        chrY    0.437715
GTEX-16XZY-0002-SM-6UH26        chrX    0.979822        chrY    0.413537
GTEX-1A3MX-0002-SM-7J38V        chrX    0.995194        chrY    0.425899
GTEX-SUCS-0001-SM-5URDQ chrX    0.998329        chrY    0.329816
linyong@fry /lab/solexa_page/linyong/gtex-dna-test$  cat temp-gene.exon.depth-file |grep GTEX-SUCS-0001-SM-5URDQ


header  geneID  geneName        header  #rname  startpos        endpos  numreads        covbases        coverage        meandepth       meanbaseq       meanmapq

GTEX-SUCS-0001-SM-5URDQ geneID  geneName        chrom   chrY    1       57227415        3061224 23433952        40.9488 6.50793 255     18.9
GTEX-SUCS-0001-SM-5URDQ chrX    0.998329        chrY    0.329816

GTEX-1AYD5-0003-SM-7J39P        chrX    0.97571 chrY    0.950914
GTEX-1AYD5-0003-SM-7J39P        geneID  geneName        chrom   chrY    1       57227415        7158588 23552203        41.1555 14.6993 255     16.9
Y       26,452,288 -bp , Ungapped lengths are calculated by summing the length of sequenced bases only. 'Ns' are excluded.

7158588*L / (57227415) = 14.6993
14.6993 * 57227415 / 7158588 = 117
6.50793 * 57227415 / 3061224 = 121.6
linyong@fry /lab/solexa_page/linyong/dir-temp-1$ ~/C++/reSeqPrintChrRegion.fq /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa  out chrY 12878801 17878801  > temp-chry.fa
5M bp no 'N' is the seq
linyong@fry /lab/solexa_page/linyong/dir-temp-1$ samtools coverage -q 0  temp-chry.bam | head
#rname  startpos        endpos  numreads        covbases        coverage        meandepth       meanbaseq       meanmapq
chrY    1       57227415        1       5000001 8.73707 0.0873707       255     250
5000001 / 57227415 = 0.08737
1*5000001 / 57227415 =

[bsw2_aln] read 3 sequences/pairs (15000003 bp) ...
#rname  startpos        endpos  numreads        covbases        coverage        meandepth       meanbaseq       meanmapq
chrY    1       57227415        3       5000001 8.73707 0.262112        255     250
3*5000001  / (57227415) = 0.2621122

######################################################################################
index=5
t1 <- read.delim("dir-gtex-website-data/sample-tissue.2colum", header=F)
file <- read.delim("gtex-54tiss.txt", header=F)
tissue = file[index,1]
 t2 <- t1[ t1$V2 == tissue, ]
 t2$id <- gsub("-", ".", t2$V1)
 t2$id <- paste(t2$id, ".", sep="")
 raw2 <- raw[, colnames(raw) %in% t2$id ]
 str1 <- paste(tissue, dim(raw2)[2], sep="\t")
 cat(str1)
 cat("\n")
 rownames(raw2) <- raw$geneID
y <- DGEList(counts=raw2)
y <- calcNormFactors(y)
med <- data.frame(y$counts[,1])
med$logic <- TRUE
d <- cpm(y)
for(i in 1:dim(y)[1]) {
 med$logic[i] <- median(d[i,]) >= 0.1
}
####median >= 1 for pathway genes
y<-y[med$logic,]
print(dim(y))

diff <- as.data.frame(cpm(y))
gene.name <- raw[, 1:2]
 gene.name[ gene.name$name %in% c("C4A", "C4B"),]
#                   geneID name
# 25277  ENSG00000224389.9  C4B
# 37237 ENSG00000244731.10  C4A

 g1 <- gene.name[ gene.name$name %in% c("C4A", "C4B"),]$geneID
 g2 <- as.data.frame( t(diff[ rownames(diff) %in% g1,]))
 str(g2)
 g2$sample <- rownames(g2)
 g3 <- merge(g2, info, by.x="sample", by.y="sid")
 dim(g3)
# [1] 226   9
 g4 <- merge(g3, c4.cn, by.x="SUBJID", by.y="SUBJID")
 dim(g4)
 cor <- cor.test((g4$ENSG00000244731.10), g4$c4a.cn, method="s")
 str2 <- paste(tissue, ", ", "rho=",  round(cor$estimate, digits = 4), ", ", "p=", format(cor$p.value, digits = 3), ", n=", dim(g4)[1], sep="")
ggplot(g4, aes(x=c4a.cn, y=ENSG00000244731.10)) + geom_point(shape=21) + geom_smooth() + labs(x="C4A copy number", y="C4A gene expression (CPM)", title=str2)

 cor <- cor.test(g4$ENSG00000224389.9, g4$c4b.cn, method="s")
 str2 <- paste(tissue, ", ", "rho=",  round(cor$estimate, digits = 4), ", ", "p=", format(cor$p.value, digits = 3), ", n=", dim(g4)[1], sep="")
ggplot(g4, aes(x=c4b.cn, y=ENSG00000224389.9)) + geom_point(shape=21) + geom_smooth() + labs(x="C4B copy number", y="C4B gene expression (CPM)", title=str2)

#######################################################
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % Rscript c4a-c4b-cnv-q20-corr-express-batch-multiVar-2 > temp-1
cat temp-1 | awk 'BEGIN {FS="\t"} NF > 12' > temp.txt 

c4a-only-copyNumber-exon-depth.xlsx
paste to "temp2"
> t1 <- read.delim("temp2")
 dim(t1)
#  [1] 44 32
 t2 <- data.frame(t1$X, t1$c4a.g6.c4a.cn.coeff, t1$c4a.g6.c4a.cn.pVal)
 dim(t2[ t2$t1.c4a.g6.c4a.cn.pVal < 0.005,])
#  [1] 43  3
t3 <- data.frame(t1$X, t1$c4b.g6.c4b.cn.coeff, t1$c4b.g6.c4b.cn.pVal)
 dim(t3[ t3$t1.c4b.g6.c4b.cn.pVal < 0.005,])
#  [1] 25  3
liver:
Multiple R-squared:  0.5662,    Adjusted R-squared:  0.5533

                (Intercept)                    g6$c4a.cn                   g6$t.SMRIN  log10(g6$t.SMTSISCH + 1300)
                 16.8939175                    0.8058212                    0.6071816                   -4.6715198
                   g6$SEX.x                 g6$age_value           g6$body_mass_index
                 -0.1674806                   -0.0005688                   -0.0100502

> df1 <- data.frame(x1 = 16.8939175 + 0.8058212*g6$c4a.cn + 0.6071816*g6$t.SMRIN -4.6715198 * log10(g6$t.SMTSISCH + 1300) -0.1674806 * g6$SEX.x -0.0005688 *g6$age_value -0.0100502 * g6$body_mass_index, y1 = log2(g6$ENSG00000244731.10+1))

############
using log2(g6$c4a.cn)   log2(g6$c4b.cn) in linear model
> 0.4769 /0.4448
[1] 1.072167
> 0.3845 / 0.3801
[1] 1.011576
>  t2 <- data.frame(t1$X, t1$c4a.g6.c4a.cn.coeff, t1$c4a.g6.c4a.cn.pVal)
>  dim(t2[ t2$t1.c4a.g6.c4a.cn.pVal < 0.005,])
[1] 43  3
43/44 with FDR < 0.01
> t1[ t1$c4a.g6.c4a.cn.coeff < 0,]
zero tissue
> t2 <- data.frame(t=t1$X, c=t1$c4a.g6.SEX.x.coeff, p= t1$c4a.g6.SEX.x.pVal)
> t2$fdr <- p.adjust(t2$p, method="fdr")
> t2[ t2$fdr < 0.01,]
                         t          c           p          fdr
1   Adipose - Subcutaneous -0.2254635 3.70939e-04 8.160658e-03
20 Breast - Mammary Tissue  0.8304923 3.64000e-13 1.601600e-11

                              X X.samp X.samp.genotype X.samp.F X.samp.M c4a.g6.c4a.cn.coeff c4a.g6.c4a.cn.pVal
21 Cells - Cultured fibroblasts    504             467      165      302          0.09299814          0.1621013

> t3 <- data.frame(t1$X, t1$c4b.g6.c4b.cn.coeff, t1$c4b.g6.c4b.cn.pVal)
>  dim(t3[ t3$t1.c4b.g6.c4b.cn.pVal < 0.005,])
[1] 26  3
26/44 with FDR < 0.01
> t1[ t1$c4b.g6.c4b.cn.coeff < 0,]
one tissue: Cells - Cultured fibroblasts, -0.1085284          0.1256329
 t2 <- data.frame(t=t1$X, c=t1$c4b.g6.SEX.x.coeff, p= t1$c4b.g6.SEX.x.pVal)
 t2$fdr <- p.adjust(t2$p, method="fdr")
 t2[ t2$fdr < 0.01,]
                         t       c       p       fdr
20 Breast - Mammary Tissue 1.04849 8.3e-17 3.652e-15

liver:
Multiple R-squared:  0.6564,    Adjusted R-squared:  0.6461 
> t2 <- data.frame(x=  18.497655468 + 1.182719595 * log2(g6$c4a.cn) + 0.586422459 * g6$t.SMRIN -4.972768905 * log10(g6$t.SMTSISCH + 1300) -0.123010658 * g6$SEX.x -0.001015806 * g6$age_value -0.008834635 * g6$body_mass_index , y= log2(g6$ENSG00000244731.10 + 1))
 gplot(t2, aes(x=x, y=y)) + geom_point(shape=21) + geom_smooth(method="lm") + labs(x="multiVarModel predicted value", y="log2(CPM+1)") #

###########################
t1 <- read.delim("temp1.c4a.R.sort")
 dim(t1)
#  [1] 44 32
 dim(t1[ t1$c4a.R > 0.50139 ,])
#  [1] 14 32
 summary(t1$c4a.R)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.1421  0.4220  0.4649  0.4770  0.5221  0.8102 
 summary(t1$c4b.R)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#0.09995 0.30946 0.39034 0.38454 0.43910 0.77011 

> t2 <- data.frame(t1$X, t1$c4b.g6.c4b.cn.coeff, t1$c4b.g6.c4b.cn.pVal)
 t2$fdr <- p.adjust(t2$t1.c4b.g6.c4b.cn.pVal, method="fdr")
t3 <- t2[ order(t2$fdr, decreasing=T),]
 t4 <- data.frame(t3$fdr)
rownames(t4) <- t3$t1.X
t5 <- as.data.frame(t(t4))
  par( mar=c(6,2,2,12))
 barplot(as.matrix(-log10(t5)), horiz=T, beside=T, col=c("blue"), xlab="-log10(FDR)", xlim=c(0,16), yaxt="n")
 axis(side=4, at = seq(1.5, 1.5 + 43*2, by=2), labels=colnames(t5), las =1, cex.axis = 0.6)
 abline(h = seq(1.5, 1.5 + 43*2, by=2), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100, 100, 5/2), lty = 5, lwd = 0.5, col = "gray")
  abline(v=2, col="red")
  text(2, 5, "FDR = 0.01", pos=4, col="red")
 legend(7.5, 1.5+20*2, c(  "C4B"), fill=c("blue"), cex = 0.6, inset = 0.05)

>  t2 <- data.frame(t1$X, t1$c4a.g6.c4a.cn.coeff, t1$c4a.g6.c4a.cn.pVal)
 t2$fdr <- p.adjust(t2$t1.c4a.g6.c4a.cn.pVal, method="fdr")
t3 <- t2[ order(t2$fdr, decreasing=T),]
 t4 <- data.frame(t3$fdr)
rownames(t4) <- t3$t1.X
t5 <- as.data.frame(t(t4))
  par( mar=c(6,2,2,12))
 barplot(as.matrix(-log10(t5)), horiz=T, beside=T, col=c("orange"), xlab="-log10(FDR)",  yaxt="n")
 axis(side=4, at = seq(1.5, 1.5 + 43*2, by=2), labels=colnames(t5), las =1, cex.axis = 0.6)
 abline(h = seq(1.5, 1.5 + 43*2, by=2), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100, 100, 5), lty = 5, lwd = 0.5, col = "gray")
 abline(v=2, col="red")
 text(2, 1, "FDR = 0.01", pos=4, col="red")
 legend(20, 1.5+20*2, c(  "C4A"), fill=c("orange"), cex = 0.6, inset = 0.05)

> t2 <- data.frame(t1$X, t1$c4b.g6.c4b.cn.coeff, t1$c4b.g6.c4b.cn.pVal, t1$c4a.g6.c4a.cn.coeff, t1$c4a.g6.c4a.cn.pVal)
  t2$fdr.c4b <- p.adjust(t2$t1.c4b.g6.c4b.cn.pVal, method="fdr")
  t2$fdr.c4a <- p.adjust(t2$t1.c4a.g6.c4a.cn.pVal, method="fdr")
 t2$log.fdr.c4b <- -log10( t2$fdr.c4b)
 t2$log.fdr.c4a <- -log10( t2$fdr.c4a)
 for(i in 1:dim(t2)[1]) {
if(t2$t1.c4b.g6.c4b.cn.coeff[i] < 0) {
 t2$log.fdr.c4b[i] <- -t2$log.fdr.c4b[i]
}
}

 for(i in 1:dim(t2)[1]) {
if(t2$t1.c4a.g6.c4a.cn.coeff[i] < 0) {
 t2$log.fdr.c4a[i] <- -t2$log.fdr.c4a[i]
}
}

 t3 <- t2[ grep("brain", t2$t1.X, ignore.case=T),]
 dim(t3)
#  [1] 13  9
 gplot(t2, aes(x=log.fdr.c4b, y=log.fdr.c4a, label=t1.X)) + geom_point(shape=21, col="red", size=2) + scale_x_continuous(breaks=seq(0, 16, 2), limits=c(-1,15)) + scale_y_continuous(breaks=seq(0, 42, 2), limits=c(0, 42)) + geom_smooth(method="lm") + labs(x="signed log10(FDR), C4B", y="signed log10(FDR), C4A") + geom_text_repel(show.legend=T, data=t3, size=2.2, max.overlaps=100, min.segment.length = 0.1)

gplot(t3, aes(x=log.fdr.c4b, y=log.fdr.c4a, label=t1.X)) + geom_point(shape=21, col="red", size=2) + labs(x="signed log10(FDR), C4B", y="signed log10(FDR), C4A") + geom_text_repel(show.legend=T, data=t3, size=2.2, max.overlaps=100, min.segment.length = 0.1)

##########################################################
>  t2 <- data.frame(t1$X, t1$X.samp.genotype, t1$c4b.g6.c4b.cn.coeff, t1$c4b.g6.c4b.cn.pVal, t1$c4a.g6.c4a.cn.coeff, t1$c4a.g6.c4a.cn.pVal)
> t2$tiss <- "non-brain"
> t2[ grepl("brain", t2$t1.X, ignore.case=T),]$tiss <- "brain"
> l1 <- lm(t2$t1.c4a.g6.c4a.cn.coeff ~ t2$t1.X.samp.genotype + t2$tiss)
> summary(l1)
> gplot(t2, aes(x=t1.X.samp.genotype, y= t1.c4a.g6.c4a.cn.coeff, group=tiss, color=tiss)) + geom_point(shape=21, size = 2) + geom_smooth(aes(fill = tiss)) + scale_y_continuous(breaks=seq(-42, 42, 0.4), )
> gplot(t2, aes(x=t1.X.samp.genotype, y= t1.c4b.g6.c4b.cn.coeff, group=tiss, color=tiss)) + geom_point(shape=21, size = 2) + geom_smooth(aes(fill = tiss)) + scale_y_continuous(breaks=seq(-42, 42, 0.4), )
> gplot(t2, aes(x=t1.X.samp.genotype, y= log.fdr.c4a, group=tiss, color=tiss)) + geom_point(shape=21, size = 2) + geom_smooth(aes(fill = log.fdr.c4a)) ##+ scale_y_continuous(breaks=seq(-42, 42, 0.4), )
> mid <- median(log2( t2$t1.X.samp.genotype))
 ggplot(t2, aes(x=t1.c4b.g6.c4b.cn.coeff, y= log.fdr.c4b,  color=log2(t1.X.samp.genotype))) + geom_point(shape=21, size = 2) + geom_smooth() +scale_color_gradient2(midpoint=mid, low="blue", mid="white",   high="red", space ="Lab" )

> l1 <- lm(t2$log.fdr.c4a ~ t2$t1.X.samp.genotype + t2$t1.c4a.g6.c4a.cn.coeff)
> l1 <- lm(t2$log.fdr.c4a ~ t2$t1.X.samp.genotype + t2$tiss)

######
> t2 <- data.frame(t1$X, t1$c4a.g6.age_value.coeff, t1$c4a.g6.age_value.pVal, t1$c4b.g6.age_value.coeff, t1$c4b.g6.age_value.pVal)
 t2$fdr.c4b <- p.adjust(t2$t1.c4b.g6.age_value.pVal, method="fdr")
 t2$fdr.c4a <- p.adjust(t2$t1.c4a.g6.age_value.pVal, method="fdr")
 t2$log.fdr.c4b <- -log10( t2$fdr.c4b)
 t2$log.fdr.c4a <- -log10( t2$fdr.c4a)
for(i in 1:dim(t2)[1]) {
if(t2$t1.c4b.g6.age_value.coeff[i] < 0) {
 t2$log.fdr.c4b[i] <- -t2$log.fdr.c4b[i]
}
}

for(i in 1:dim(t2)[1]) {
if(t2$t1.c4a.g6.age_value.coeff[i] < 0) {
 t2$log.fdr.c4a[i] <- -t2$log.fdr.c4a[i]
}
}

t3 <- t2[ grep("brain", t2$t1.X, ignore.case=T),]
 dim(t3)
#  [1] 13  9
 gplot(t2, aes(x=log.fdr.c4b, y=log.fdr.c4a, label=t1.X)) + geom_point(shape=21, col="red", size=2) + geom_smooth(method="lm") + labs(x="signed log10(FDR), C4B", y="signed log10(FDR), C4A") + geom_text_repel(show.legend=T, data=t3, size=2.2, max.overlaps=100, min.segment.length = 0.1)  + scale_x_continuous(breaks=seq(-10, 16, 2), limits=c(-2,7)) + scale_y_continuous(breaks=seq(-10, 16, 2), limits=c(-2,7))

 t2$tissue <- "other tissues"
for(i in 1:dim(t2)[1]) {
if(grepl("brain", t2$t1.X[i], ignore.case=T)) {
t2$tissue[i] <- "brain"
}
}

 par( mar=c(6,6,2,2))
 boxplot(abs( t2$log.fdr.c4a) ~ t2$tissue, ylab=paste( "-log10(FDR)", "\n", "C4A gene expression ~ age", sep=""))
 abline(h = seq(-10, 10, by=1), lty = 5, lwd = 0.5, col = "gray")

################
> t2 <- data.frame(t1$X, t1$c4a.g6.c4a.cn.pVal, t1$c4a.g6.t.SMRIN.pVal, t1$c4a.log10.g6.t.SMTSISCH.pVal, t1$c4a.g6.SEX.x.pVal, t1$c4a.g6.age_value.pVal, t1$c4a.g6.body_mass_index.pVal)
 dim(t2)
#  [1] 44  7
 t2$fdr.c4a.cn <- p.adjust(t2$t1.c4a.g6.c4a.cn.pVal, method="fdr")
 t2$fdr.c4a.RIN <- p.adjust(t2$t1.c4a.g6.t.SMRIN.pVal, method="fdr")
 t2$fdr.c4a.ISCH <- p.adjust(t2$t1.c4a.log10.g6.t.SMTSISCH.pVal, method="fdr")
 t2$fdr.c4a.sex <- p.adjust(t2$t1.c4a.g6.SEX.x.pVal, method="fdr")
 t2$fdr.c4a.age <- p.adjust(t2$t1.c4a.g6.age_value.pVal, method="fdr")
 t2$fdr.c4a.bmi <- p.adjust(t2$t1.c4a.g6.body_mass_index.pVal, method="fdr")
 t3 <- t2[, c(8:13)]
 t4 <- -log10(t3)
 boxplot(t4, xlab="variable", ylab="MultiVarModel regression -log10(FDR)", cex.axis=0.8, col=c("red", "blue"), outcol=c("red", "blue"))
  abline(v = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")
 abline(h = seq(-100, 100, 1), lty = 5, lwd = 0.5, col = "gray")

###########################
paste from:  c4a-only-copyNumber-exon-depth.xlsx
vi temp1
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp1 | head -1 | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print i, $i}'
head -1 temp1 > temp1.c4a.R.sort
awk 'NR > 1' temp1 | sort -t '   ' +17n -18 >> temp1.c4a.R.sort

> t1 <- read.delim("temp1.c4a.R.sort")
 dim(t1)
#  [1] 44 32
 dim(t1[ t1$c4a.R > 0.50139 ,])
#  [1] 14 32
t2 <- tail(t1, n=14)
t3 <- data.frame(t2$c4a.g6.body_mass_index.pVal, t2$c4a.g6.age_value.pVal, t2$c4a.g6.SEX.x.pVal, t2$c4a.log10.g6.t.SMTSISCH.pVal, t2$c4a.g6.t.SMRIN.pVal,t2$c4a.g6.c4a.cn.pVal)
 rownames(t3) <- t2$X
 t4 <- as.data.frame(t(-log10(t3)))
  par( mar=c(6,2,2,12))
 barplot(as.matrix(t4), horiz=T, beside=T, col=c("red", "orange","blue", "green", "yellow", "magenta"), xlab="-log10(pVal)", xlim=c(0, 45), yaxt="n")
 axis(side=4, at = seq(4, 99, by=7), labels=colnames(t4), las =1, cex.axis = 0.6)
 abline(h = seq(4, 99, by=7), lty = 5, lwd = 0.5, col = "gray")
  abline(v = seq(-100, 100, 5), lty = 5, lwd = 0.5, col = "gray")
 legend(25, 4+7*3, c("C4A CN", "RIN", "ISCH", "sex", "age", "bmi"), fill=c("magenta", "yellow", "green", "blue", "orange", "red"), cex=0.6, inset=0.05)

###
> t3 <- data.frame(t2$c4a.R)
 rownames(t3) <- t2$X
 t4 <- as.data.frame(t(t3))
  par( mar=c(6,2,2,12))
 barplot(as.matrix(t4), horiz=T, beside=T, xlab="multiVarModel R", xlim=c(0, 0.9), yaxt="n")
 axis(side=4, at = seq(1.5, 27.5, by=2), labels=colnames(t4), las =1, cex.axis = 0.6)
  abline(h = seq(1.5, 27.5, by=2), lty = 5, lwd = 0.5, col = "gray")
  abline(v = seq(-100, 100, 0.2), lty = 5, lwd = 0.5, col = "gray")

######
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % head -1 temp1.c4a.R.sort > temp1.c4b.R.sort
awk 'NR > 1' temp1.c4a.R.sort | sort -t '        ' +31n -32 >> temp1.c4b.R.sort

t1 <- read.delim("temp1.c4b.R.sort")
 dim(t1)
#  [1] 44 32
 dim(t1[ t1$c4b.R > 0.50139 ,])
t2 <- tail(t1, n=14)
t3 <- data.frame(t2$c4b.g6.body_mass_index.pVal, t2$c4b.g6.age_value.pVal, t2$c4b.g6.SEX.x.pVal, t2$c4b.log10.g6.t.SMTSISCH.pVal, t2$c4b.g6.t.SMRIN.pVal,t2$c4b.g6.c4b.cn.pVal)
 rownames(t3) <- t2$X
 t4 <- as.data.frame(t(-log10(t3)))
  par( mar=c(6,2,2,12))
 barplot(as.matrix(t4), horiz=T, beside=T, col=c("red", "orange","blue", "green", "yellow", "magenta"), xlab="-log10(pVal)", xlim=c(0, 18), yaxt="n")
 axis(side=4, at = seq(4, 99, by=7), labels=colnames(t4), las =1, cex.axis = 0.6)
 abline(h = seq(4, 99, by=7), lty = 5, lwd = 0.5, col = "gray")
  abline(v = seq(-100, 100, 2.5), lty = 5, lwd = 0.5, col = "gray")
 legend(10, 4+7*3, c("C4B CN", "RIN", "ISCH", "sex", "age", "bmi"), fill=c("magenta", "yellow", "green", "blue", "orange", "red"), cex=0.6, inset=0.05)

###
 t3 <- data.frame(t2$c4b.R)
 rownames(t3) <- t2$X
 t4 <- as.data.frame(t(t3))
  par( mar=c(6,2,2,12))
 barplot(as.matrix(t4), horiz=T, beside=T, xlab="multiVarModel R", xlim=c(0, 0.9), yaxt="n")
 axis(side=4, at = seq(1.5, 27.5, by=2), labels=colnames(t4), las =1, cex.axis = 0.6)
  abline(h = seq(1.5, 27.5, by=2), lty = 5, lwd = 0.5, col = "gray")
  abline(v = seq(-100, 100, 0.2), lty = 5, lwd = 0.5, col = "gray")

######################################
"c4a-c4b-cnv-q20-corr-express-batch-multiVar-2"
c4.cn
> summary( (c4.cn$c4a.cn + c4.cn$c4b.cn)/c4.cn$c4.tot)
#     Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
#   0.4765  0.8239  0.8917  0.8885  0.9593  1.3559

 med <- median((c4.cn$c4a.cn + c4.cn$c4b.cn)/c4.cn$c4.tot)
 boxplot(c4.cn$c4a.cn / med ~ c4.cn$SEX, xlab="", xaxt="n", ylab="C4A CN")
 axis(side = 1, at=seq(1,2,by=1), labels =c("male(n=557)", "female(n=281)"))
 abline(h = seq(0, 148, by=1), lty = 5, lwd = 0.5, col = "gray")
 wilcox.test( c4.cn[ c4.cn$SEX == 1,]$c4a.cn, c4.cn[ c4.cn$SEX == 2,]$c4a.cn)

 boxplot(c4.cn$c4b.cn / med ~ c4.cn$SEX, xlab="", xaxt="n", ylab="C4B CN")
 axis(side = 1, at=seq(1,2,by=1), labels =c("male(n=557)", "female(n=281)"))
 abline(h = seq(0, 148, by=1), lty = 5, lwd = 0.5, col = "gray")
 wilcox.test( c4.cn[ c4.cn$SEX == 1,]$c4b.cn, c4.cn[ c4.cn$SEX == 2,]$c4b.cn)

########################################
> raw2 <- raw[, 3: 17352]
 rownames(raw2) <- raw$geneID
y <- DGEList(counts=raw2)
y <- calcNormFactors(y)
med <- data.frame(y$counts[,1])
med$logic <- TRUE
d <- cpm(y)
for(i in 1:dim(y)[1]) {
 med$logic[i] <- median(d[i,]) >= 0.5 
}
 y<-y[med$logic,]
 dim(y)
#  [1] 16985 genes;  17350
 d <- cpm(y)
 a <- as.data.frame(log2(d+1))
gene.name <- raw[, 1:2]
 gene.name[ gene.name$name %in% c("C4A", "C4B"),]
 g1 <- gene.name[ gene.name$name %in% c("C4A", "C4B"),]$geneID
 e1 <- a[ rownames(a) == g1[1],]
 corr <- a[, c(1,2)]
 colnames(corr) <- c("geneID", g1[1])

for(i in 1:dim(a)[1]) {
 t1 <- cor.test(as.numeric( e1[1,]), as.numeric(a[i,]))
 corr[i,1] <- rownames(a)[i]
 corr[i,2] <- t1$estimate

}

 corr1 <- merge(corr, gene.name, by.x="geneID", by.y="geneID")
 dim(corr1)
#  [1] 16985     3
 corr1[ corr1$ENSG00000224389.9 > 0.5,]
# 22 genes

##################################################
"c4a-c4b-cnv-q20-corr-express-batch-multiVar-2"
> boxplot(log2(g6$ENSG00000224389.9 + 1) ~ g6$SEX.x, ylab="C4B gene expression, log2(CPM+1)", xlab="", xaxt="n")
  axis(side = 1, at=seq(1,2,by=1), labels =c("male(n=245)", "female(n= 149)"))
  abline(h = seq(0, 148, by=1), lty = 5, lwd = 0.5, col = "gray")
 g7 <- g6
 g7$SEX.y <- factor(g7$SEX.x, levels=c(1,2), labels=c( "male", "female"))
> gplot(g7, aes(x=log2(c4b.cn), y=  log2(ENSG00000224389.9 + 1), group= SEX.y, color=SEX.y)) + geom_point(shape=21, size = 1) + geom_smooth(aes(fill = SEX.y)) + labs(x="log2(C4B_CN)", y="C4B gene expression, log2(CPM+1)") + scale_color_manual(breaks=c("female", "male"), values=c("orange", "purple")) + scale_fill_manual(breaks=c("female", "male"), values=c("orange", "purple")) + scale_y_continuous(breaks=seq(0, 42, 2), limits=c(0, 7))

 boxplot(log2(g6$ENSG00000244731.10 + 1) ~ g6$SEX.x, ylab="C4A gene expression, log2(CPM+1)", xlab="", xaxt="n")
 axis(side = 1, at=seq(1,2,by=1), labels =c("male(n=245)", "female(n= 149)"))
 abline(h = seq(0, 148, by=1), lty = 5, lwd = 0.5, col = "gray")
 g7 <- g6
 g7$SEX.y <- factor(g7$SEX.x, levels=c(1,2), labels=c( "male", "female"))
 gplot(g7, aes(x=log2(c4a.cn), y=  log2(ENSG00000244731.10 + 1), group= SEX.y, color=SEX.y)) + geom_point(shape=21, size = 1) + geom_smooth(aes(fill = SEX.y)) + labs(x="log2(C4A_CN)", y="C4A gene expression, log2(CPM+1)") + scale_color_manual(breaks=c("female", "male"), values=c("orange", "purple")) + scale_fill_manual(breaks=c("female", "male"), values=c("orange", "purple")) + scale_y_continuous(breaks=seq(0, 42, 2), limits=c(0, 7))

 ggplot(g7, aes(x=log2(c4b.cn), y=  log2(ENSG00000224389.9 + 1), group= SEX.y, color=SEX.y, size=age_value)) + geom_point(shape=21) + geom_smooth(show.legend=F, aes(fill = SEX.y)) + labs(x="log2(C4B_CN)", y="C4B gene expression, log2(CPM+1)") + scale_color_manual(breaks=c("female", "male"), values=c("orange", "purple")) + scale_fill_manual(breaks=c("female", "male"), values=c("orange", "purple")) + scale_y_continuous(breaks=seq(0, 42, 2), limits=c(0, 6))

###################################################################
### script-gtexv8-tissue-sex-diff-PC1-PC21-covar
+  med$logic[i] <- median(d[i,]) >= 0.5
design <- model.matrix( ~ info.2$SEX + info.2$age_value + info.2$body_mass_index + info.2$t.SMRIN + log10(info.2$t.SMTSISCH + 1300))  
"diff2-1-breast-FvsM.age-bmi-RIN-ischemV2-covar.cpm0.5.txt"

###################################################################
> t1 <- read.delim("temp1.c4a.R.sort")
......
> t2 <- data.frame(t1$X, t1$c4b.g6.SEX.x.coeff, t1$c4b.g6.SEX.x.pVal, t1$c4a.g6.SEX.x.coeff, t1$c4a.g6.SEX.x.pVal)
 t2$fdr.c4a <- p.adjust(t2$t1.c4a.g6.SEX.x.pVal, method="fdr")
 t2$fdr.c4b <- p.adjust(t2$t1.c4b.g6.SEX.x.pVal, method="fdr")
 t3 <- t2[ abs( t2$t1.c4b.g6.SEX.x.coeff) > 0.2,]
> gplot(t2, aes(x=t1.c4b.g6.SEX.x.coeff, y= -log10(fdr.c4b), label=t1.X))  + geom_point(shape=21,size=2) + geom_text_repel(show.legend=F, data=t3, size=2, max.overlaps=100, min.segment.length = 0.1) + scale_y_continuous(breaks=seq(0, 40, 1), limits=c(0, 2.5)) + labs(x="log2 FC (F vs. M)", y="-log10(FDR), C4B") + geom_smooth(se=T)

######
> t2 <- data.frame(t1$X, t1$X.samp.genotype, t1$c4b.g6.SEX.x.coeff, t1$c4b.g6.SEX.x.pVal, t1$c4a.g6.SEX.x.coeff, t1$c4a.g6.SEX.x.pVal)
 t2$fdr.c4a <- p.adjust(t2$t1.c4a.g6.SEX.x.pVal, method="fdr")
 t2$fdr.c4b <- p.adjust(t2$t1.c4b.g6.SEX.x.pVal, method="fdr")
 t3 <- t2[ abs( t2$t1.c4b.g6.SEX.x.coeff) > 0.2,]
 t2.2 <- t2
 t2.2[ t2.2$fdr.c4b < 1e-10,]$fdr.c4b = 1e-4
 plot(-log10(t2.2$fdr.c4b) ~ abs( t2.2$t1.c4b.g6.SEX.x.coeff), xlab="abs(SEX.coeff)", ylab="abs(log10(FDR)), C4B" )
 text(x=1.04849 - 0.1, y=4, "breat, FDR=3.6e-15", col="blue", pos=1)

 plot(-log10(t2.2$fdr.c4b) ~ ( t2.2$t1.X.samp.genotype), xlab="# of samples per tissue", ylab="abs(log10(FDR)), C4B" )
 text(x=350, y=4, "breat, FDR=3.6e-15", col="blue", pos=1)

######
 t3 <- t2[ abs( t2$t1.c4a.g6.SEX.x.coeff) > 0.2 & abs( t2$t1.c4b.g6.SEX.x.coeff) > 0.2,]
 dim(t3)
#  [1] 15  7
> gplot(t3, aes(x=t1.c4b.g6.SEX.x.coeff, y=t1.c4a.g6.SEX.x.coeff, label=t1.X))  + geom_point(shape=21,size=2) + geom_text_repel(show.legend=F, data=t3, size=2, max.overlaps=100, min.segment.length = 0.1) + scale_y_continuous(breaks=seq(-2,2,0.2)) + labs(x="C4B, log2 FC (F vs. M)", y="C4A, log2 FC (F vs. M)") + geom_smooth(se=T, method="lm")

######################################
> d2 <- read.delim("dir-c4-c4b-comple-pathway/diff2-1.BrainFrontalCortex-FvsM.age-bmi-RIN-ischemplus1300-PC1-2-covar.cpm0.5.txt")
 d3 <- merge(d2, df.cpm.gene, by.x="geneID", by.y="geneID")
 dim(d3)
#  [1] 18067    19
 t1 <- read.delim("/Users/linyongmao/Documents/h.all.v7.4.symbols.gmt", header=F)
 dim(t1)
#  [1]  50 202
 t2 <- t1[ grepl("complement", t1$V1, ignore.case=T),3:202]
 d4 <- d3[ d3$name.x %in% as.character(t2),]
 dim(d4)
#  [1] 168  19
 d5 <- d4[ d4$logFC.x >= 0.5,]
 gplot(d4, aes(x=logFC.x, y=logFC.y, label=name.x)) + geom_point(shape=21, size=2, color="red") + geom_smooth(method="lm") + scale_x_continuous(breaks=seq(-2,2,0.2)) + geom_hline(yintercept=0) + geom_vline(xintercept=0) + labs(x="log2 FC (F vs. M), Frontal Cortex (BA9)", y="log2 FC (F vs. M), Cortex") + geom_text_repel(show.legend=T, data=d5, size=2.2, max.overlaps=100, min.segment.length = 0.1)
 d4 <- d3[ d3$chr.x == "chrX",]
 dim(d4)
#  [1] 599  19
  d5 <- d4[ d4$logFC.x >= 0.3,]
 dim(d5)
#  [1] 36 19
gplot(d4, aes(x=logFC.x, y=logFC.y, label=name.x)) + geom_point(shape=21, size=2, color="red") + geom_smooth(method="lm")  + geom_hline(yintercept=0) + geom_vline(xintercept=0) + labs(x="log2 FC (F vs. M), Frontal Cortex (BA9)", y="log2 FC (F vs. M), Cortex") + geom_text_repel(show.legend=T, data=d5, size=2.2, max.overlaps=100, min.segment.length = 0.1)

######################################
t1 <- read.delim("/Users/linyongmao/Documents/h.all.v7.4.symbols.gmt", header=F)
 dim(t1)
#  [1]  50 202 
 t2 <- t1[ grepl("complement", t1$V1, ignore.case=T),3:202]
 g1 <- read.delim("dir-c4-c4b-comple-pathway/diff2-1.BrainFrontalCortex-FvsM.age-bmi-RIN-ischemplus1300-PC1-2-covar.cpm0.5.txt")
 g2 <- g1[ g1$name %in% t2,]
 dim(g2)
#  [1] 168  10
 g3 <- g2[ abs(g2$logFC) > 0.5,]
 dim(g3)
#  [1] 28 10
> gplot(g2, aes(x=logFC, y=-log10(PValue), label=name)) +  geom_point(shape=21, size=2, color="red") + labs(x="log2 FC (F vs. M), Frontal Cortex (BA9)", ) + geom_text_repel(show.legend=T, data=g3, size=2.2, max.overlaps=100, min.segment.length = 0.1)

################################################

 se <- seq(200, dim(g6)[1], 1)
 res <- as.data.frame(matrix(nrow=length(se), ncol=10))
k=1

for(i in se) {
g7 <- g6[ sample(1:dim(g6)[1], i),]
lm1 <- lm(log2(g7$ENSG00000244731.10+1) ~ log2(g7$c4a.cn) + g7$t.SMRIN + log10(g7$t.SMTSISCH + 1300) + g7$SEX.x + g7$age_value + g7$body_mass_index )
s1 <- summary(lm1)
res[k, 2] <- i
res[k, 3] <- s1$coefficients[2,1]
res[k, 4] <- s1$coefficients[2,4]
res[k, 5] <- s1$r.squared^(1/2)
k = k+1

}

 colnames(res)[2] <- "NumOfSamp"
 colnames(res)[3] <- "c4a.cn.slope"
 colnames(res)[4] <- "c4a.cn.p.val"
 colnames(res)[5] <- "mulVarModel.R"
 
 cor1 <- cor.test(res[,2], res[,3])
 str <- paste("Pearson R= ", round(cor1$estimate, digits=6), ", pVal= ", format(cor1$p.value, digits=3), sep="")
> gplot(data=res, aes(x= NumOfSamp, y= c4a.cn.slope)) + geom_point() + geom_smooth() + labs(title=str) + theme(text=element_text(size=15))

################################################################
linyong@fry /lab/solexa_page/linyong/homer$ cat /lab/solexa_page/linyong/gencode.v42.primary_assembly.noPar.protein.xist.exons.gtf | grep -w C4A | head -1
chr6	HAVANA	gene	31982057	32002681	.	+	.	gene_id "ENSG00000244731.10"; gene_type "protein_coding"; gene_name "C4A"; level 2; hgnc_id "HGNC:1323"; tag "overlapping_locus"; havana_gene "OTTHUMG00000031186.6";
linyong@fry /lab/solexa_page/linyong/homer$ cat /lab/solexa_page/linyong/gencode.v42.primary_assembly.noPar.protein.xist.exons.gtf | grep -w C4B | head -1
chr6	HAVANA	gene	32014795	32035418	.	+	.	gene_id "ENSG00000224389.9"; gene_type "protein_coding"; gene_name "C4B"; level 2; hgnc_id "HGNC:1324"; havana_gene "OTTHUMG00000031187.6";

linyong@fry /lab/solexa_page/linyong/homer$ cat script
#

t=32002681

while [ $t -lt 32014795 ]
do
 echo $t > temp1
 cat temp1 | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print "chr6", $1, $1 + 100, "peak_" $1 "-100bp", 3.14, "+" }' 
 t=`expr $t + 1`
done

linyong@fry /lab/solexa_page/linyong/homer$ bash script > temp-peaks
linyong@fry /lab/solexa_page/linyong/homer$ homerTools extract temp-peaks hg38  -fa > temp-peaks.fa
linyong@fry /lab/solexa_page/linyong/homer$ cat temp-peaks-2
chr6	31002681	32002681	c4a.and.upstream1Mbp	3.14	+
chr6	32014795	33014795	c4b.and.downstream1Mbp	3.14	+
linyong@fry /lab/solexa_page/linyong/homer$ homerTools extract temp-peaks-2 hg38  -fa > temp-c4a-c4b.fa
linyong@fry /lab/solexa_page/linyong/homer/dir-output-temp$ mv -i ../temp-c4a-c4b.fa .
linyong@fry /lab/solexa_page/linyong/homer/dir-output-temp$ bwa index temp-c4a-c4b.fa 
linyong@fry /lab/solexa_page/linyong/homer/dir-output-temp$ bwa bwasw  -f temp-peaks.sam -t 10  temp-c4a-c4b.fa  ../temp-peaks.fa
[M::bwa_idx_load_from_disk] read 0 ALT contigs
[bsw2_aln] read 12114 sequences/pairs (1211400 bp) ...
[main] Version: 0.7.17-r1188

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp-peaks.sam  | awk 'BEGIN {FS = "\t"; OFS = "\t"} $3 == "c4b.and.downstream1Mbp" ' | cut -f 1-6 > temp1
> t1 <- read.delim("temp1", header=F)
 t1$pos <- gsub("peak_", "", t1$V1)
 t1$pos <- gsub("-100bp", "", t1$pos)
 t2 <- t1[ t1$V1 != "peak_32014794-100bp",]
 plot(t2$pos, t2$V4 -20623 , cex=0.01, pch=1, xlab="C4A-C4B intergenic region, chr6 genome pos", ylab="C4B.downstream1Mbp")
 t2$map.pos <- t2$V4 -20623

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp-peaks.sam  | awk 'BEGIN {FS = "\t"; OFS = "\t"} $3 == "c4a.and.upstream1Mbp" ' | cut -f 1-6 > temp2
t3 <- read.delim("temp2", header=F)
 t3$pos <- gsub("peak_", "", t3$V1)
 t3$pos <- gsub("-100bp", "", t3$pos)
 t4 <- t3[ t3$pos > 32013239,]
 t4$map.pos <- -(1e6 - t4$V4 - 20624 )

plot(t4$pos, t4$map.pos , cex=0.01, pch=1, xlab="C4A-C4B intergenic region, chr6 genome pos", ylab="C4A.downstream1Mbp")

#########################################
linyong@fry /lab/solexa_page/linyong/homer/dir-output-temp$ ~/C++/reSeqPrintChrRegion.fq /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa  out chr6 1  32013269 > temp-chr6.fa 
linyong@fry /lab/solexa_page/linyong/homer/dir-output-temp$ bwa index temp-chr6.fa
linyong@fry /lab/solexa_page/linyong/homer/dir-output-temp$ ~/C++/reSeqPrintChrRegion.fq /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa  out chr6  32013270 32046127 > temp.c4b.fa

#slurm
bwa bwasw  -f temp.c4b.sam  -t 10   temp-chr6.fa  temp.c4b.fa

####cmd lines on prompt
samtools view -b -S -o temp.c4b.bam temp.c4b.sam
samtools sort -@ 4 -o  temp.c4b.sort.bam  temp.c4b.bam
samtools mpileup -Q 0  -q 17 -d 1000000 -f  temp-chr6.fa  temp.c4b.sort.bam >  temp.c4b.pileup
wc -l temp.c4b.pileup   
# 32738 temp.c4b.pileup
linyong@fry /lab/solexa_page/linyong/homer/dir-output-temp$ cat  temp.c4b.sam | cut -f 1-6,11-20
@SQ	SN:chr6	LN:32013269
chr6	0	chr6	31980532	250	16086M1D7973M1D649M1D249M1D629M3D93M1D14M3D21M1I148M8I1042M1D2233M1D1306M2406S	*	AS:i:29952	XS:i:57	XF:i:0	XE:i:415	NM:i:120
chr6	0	chr6	32010985	250	30569S2285M4S	*	AS:i:2229	XS:i:0	XF:i:0	XE:i:31	NM:i:14

linyong@fry /lab/solexa_page/linyong/homer/dir-output-temp$ cat temp.c4b.pileup | head
chr6	31980532	C	1	^~.	~
chr6	31980533	A	1	.	~
chr6	31980534	A	1	.	~
linyong@fry /lab/solexa_page/linyong/homer/dir-output-temp$ cat temp.c4b.pileup | tail
chr6	32013260	A	1	C	~
......
chr6	32013267	G	1	.	~
chr6	32013268	C	1	.	~
chr6	32013269	A	1	.$	~

linyong@fry /lab/solexa_page/linyong/homer/dir-output-temp$ cat temp.c4b.pileup |awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 != "." '  > temp
cp -i temp temp-0
linyong@fry /lab/solexa_page/linyong/homer/dir-output-temp$ vi temp
linyong@fry /lab/solexa_page/linyong/homer/dir-output-temp$ diff temp temp-0
0a1
> chr6	31980532	C	1	^~.	~
17a19
> chr6	31996617	T	1	.-1C	~
23a26
> chr6	32004591	A	1	.-1G	~
29a33
> chr6	32005241	C	1	.-1A	~
37a42
> chr6	32005491	A	1	.-1T	~
45a51
> chr6	32006121	T	1	.-3TTG	~
56a63
> chr6	32006217	T	1	.-1C	~
59a67
> chr6	32006232	A	1	.-3TCC	~
94a103
> chr6	32007446	G	1	.-1T	~
109a119
> chr6	32009680	C	1	.-1T	~
113a124,126
> chr6	32010985	C	2	.^~.	~~
> chr6	32010986	C	2	..	~~
> chr6	32010987	T	2	.$.	~~
127a141
> chr6	32013269	A	1	.$	~
linyong@fry /lab/solexa_page/linyong/homer/dir-output-temp$ cat temp | cut -f 5 | sort | uniq -c
     13 *
      1 .+1G
      1 .+8GAGACTAC
     26 A
     27 C
     34 G
     25 T

linyong@fry /lab/solexa_page/linyong/homer/dir-output-temp$ cat temp  | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, $2-1, $2, $3 $5}' > temp.bed
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cp -i temp.bed  copyA.copyB.snv.bed
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat  copyA.copyB.snv.bed | grep '*' > copyA.copyB.indel.bed
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat  copyA.copyB.snv.bed | grep '+' >> copyA.copyB.indel.bed

######################################
c4a 1st exon dna
linyong@fry /lab/solexa_page/linyong/homer/dir-output-temp$  ~/C++/reSeqPrintChrRegion.fq /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa  out chr6  31982108 31982172
>chr6
ATGAGGCTGCTCTGGGGGCTGATCTGGGCATCCAGCTTCTTCACCTTATCTCTGCAGAAGCCCAG

no C4B
chr6_GL000255v2_alt     3238078 3238143 +       1000    65      0       0       0       0       0       0       0

############################################################################
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$ ls GTEX*.bam | head -100 | while read ll; do cp -i $ll temp-dir-bams/; ls -lh $ll; done
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/temp-dir-bams$  ls GTEX*.bam |while read ll
> do
> samtools index $ll
> ls -lh "$ll"*
> done
-r-------- 1 linyong systemd-timesync 131M Apr 16 15:36 GTEX-1117F-0003-SM-6WBT7.bam
-rw-r--r-- 1 linyong systemd-timesync  54K Apr 16 15:43 GTEX-1117F-0003-SM-6WBT7.bam.bai
-r-------- 1 linyong systemd-timesync 135M Apr 16 15:36 GTEX-111CU-0003-SM-6WBUD.bam
-rw-r--r-- 1 linyong systemd-timesync  53K Apr 16 15:43 GTEX-111CU-0003-SM-6WBUD.bam.bai

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % scp -r linyong@fry.wi.mit.edu:/lab/solexa_page/linyong/gtex-dna-aug2024/temp-dir-bams/ ./

c4a chr6:31982057-32002681 
bam file region: chr6:29982057-34035418
intron 9: chr6:31984408-31991192 (ritrovirus)
 samtools coverage -r "$R" -q 0 -H "$cram"

C4B      chr6     32014795   32035418  
intron 9: chr6 32017146 32023930

linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/temp-dir-bams$ cat script-1
#

file="GTEX-11DXX-0004-SM-6WBT9.bam"

ls GTEX*.bam | head -60000 | while read file
do
 
samtools index "$file"

echo -n "file	gene	region	"
samtools coverage -r chr6:29982057-30982057 -q 0   "$file" | head -1

## c4a upstream -2mbp - -1mbp
echo -n "$file	C4A	upstream-2mbp.-1mbp	"
samtools coverage -r chr6:29982057-30982057 -q 0  -H "$file"

## c4a start-exon#9
echo -n "$file	C4A	start-exon#9	"
samtools coverage -r chr6:31982057-31984408 -q 0  -H "$file"

## c4a exon#10-end
echo -n "$file	C4A	exon#10-end	"
samtools coverage -r chr6:31991192-32002681 -q 0   -H "$file"

##c4a start-end
echo -n "$file	C4A	start-end	"
samtools coverage -r chr6:31982057-32002681 -q 0  -H "$file"

## c4b downstream 1mbp-2mbp
echo -n "$file	C4B	downstream+1mbp-2mbp	"
samtools coverage -r chr6:33035418-34035418 -q 0  -H "$file"

## c4b start-exon#9
echo -n "$file	C4B	start-exon#9	"
samtools coverage -r chr6:32014795-32017146 -q 0  -H "$file"

## c4b exon#10-end
echo -n "$file	C4B	exon#10-end	"
samtools coverage -r chr6:32023930-32035418 -q 0  -H "$file"

##c4b  start-end
echo -n "$file	C4B	start-end	"
samtools coverage -r chr6:32014795-32035418  -q 0  -H "$file"

done
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/temp-dir-bams$ 

linyongmao@Linyong-Mao-MBP16-2019 temp-dir-bams % scp linyong@fry.wi.mit.edu:/lab/solexa_page/linyong/gtex-dna-aug2024/out-c4a-depth-no.intron9-01  ../
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat script-1
#

# file  gene    region  #rname  startpos        endpos  numreads        covbases        coverage        meandepth       meanbaseq       meanmapq
# GTEX-1117F-0003-SM-6WBT7.bam  C4A     upstream-2mbp.-1mbp     chr6    29982057        30982057        212228  999797  99.9796 31.2147 28.8    59.2

t1=`head -1 out-c4a-depth-no.intron9-01 | cut -f 2-12`
echo "file      $t1     $t1     $t1     $t1"

cat out-c4a-depth-no.intron9-01 | cut -f 1 | uniq | grep -vw file | head -10234 |  while read ll
do
  t1=`echo "$ll" | sed 's/.bam//' `
  t2=`grep -w "$ll" out-c4a-depth-no.intron9-01 | grep -w "C4A  start-exon#9" | head -1 | cut -f 2-12`
  t3=`grep -w "$ll" out-c4a-depth-no.intron9-01 | grep -w "C4A  exon#10-end" | head -1 | cut -f 2-12`
  t4=`grep -w "$ll" out-c4a-depth-no.intron9-01 | grep -w "C4B  start-exon#9" | head -1 | cut -f 2-12`
  t5=`grep -w "$ll" out-c4a-depth-no.intron9-01 | grep -w "C4B  exon#10-end" | head -1 | cut -f 2-12`
  echo "$t1     $t2     $t3     $t4     $t5"
done
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 %
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % bash script-1 > c4a-depth-no.intron9-01.txt
> t7 <- read.delim("c4a-depth-no.intron9-01.txt")
 t8 <- merge(t6, t7, by.x="V1", by.y="file")
 dim(t8)
#  [1] 838  73
 t8$c4.tot.no.intron9 <- (t8$meandepth * 2352 + t8$meandepth.1 * 11490 + t8$meandepth.2 *  2352 + t8$meandepth.3 * 11489) / (2352 + 11489.5) / t8$seq.dep * 2

> d <- density(t8$c4.tot.no.intron9, bw = 0.15)
>  plot(d$x, d$y, col="red")
> lines(d$x, d$y, col="red")
> abline(v = seq(0,10000,1), lty = 5, lwd = 0.5, col = "blue")

###############################################################
name: CYP21A1P
chr6:32005636-32008909

name: CYP21A2
chr6:32038415-32041644

linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$ cat temp-dir-bams/script-2
#

file="GTEX-11DXX-0004-SM-6WBT9.bam"

ls GTEX*.bam | head -6000 | while read file
do
 samtools index "$file"
 echo -n "file  gene    "
 samtools coverage -r chr6:32038415-32041644 -q 0  "$file" | head -1

 echo -n "$file CYP21A2 "
 samtools coverage -r chr6:32038415-32041644 -q 0 -H   "$file"
 echo -n "$file CYP21A1P        "
 samtools coverage -r chr6:32005636-32008909 -q 0 -H   "$file"
 echo -n "$file CYP21A2-q20     "
 samtools coverage -r chr6:32038415-32041644 -q 20 -H    "$file"
 echo -n "$file CYP21A1P-q20    "
 samtools coverage -r chr6:32005636-32008909 -q 20 -H    "$file"
done


linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$

#######################################################################
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % scp linyong@fry.wi.mit.edu:/lab/solexa_page/linyong/gtex-dna-aug2024/out-CN-CYP21A2-4.23.12.22 ./
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat script-2 
#
# out-CN-CYP21A2-4.23.12.22
# file  gene    #rname  startpos        endpos  numreads        covbases        coverage        meandepth       meanbaseq       meanmapq
# GTEX-11TUW-0004-SM-7FG6E.bam  CYP21A2 chr6    32038415        32041644        939     3230    100     41.487  26.6    43.1
# GTEX-11TUW-0004-SM-7FG6E.bam  CYP21A1P        chr6    32005636        32008909        417     3274    100     17.675  26.6    37.9
# GTEX-11TUW-0004-SM-7FG6E.bam  CYP21A2-q20     chr6    32038415        32041644        863     3230    100     38.1978 26.7    46.6
# GTEX-11TUW-0004-SM-7FG6E.bam  CYP21A1P-q20    chr6    32005636        32008909        331     3274    100     13.9236 26.8    47.5


t1=`head -1 out-CN-CYP21A2-4.23.12.22 | cut -f 2-12`
echo "file      $t1     $t1     $t1     $t1"

cat out-CN-CYP21A2-4.23.12.22 | cut -f 1 | uniq | grep -vw file | head -6234 |  while read ll
do
  t1=`echo "$ll" | sed 's/.bam//' `
  t2=`grep -w "$ll" out-CN-CYP21A2-4.23.12.22 | grep  "CYP21A1P " | head -1 | cut -f 2-12`
  t3=`grep -w "$ll" out-CN-CYP21A2-4.23.12.22 | grep  "CYP21A2  " | head -1 | cut -f 2-12`
  t4=`grep -w "$ll" out-CN-CYP21A2-4.23.12.22 | grep -w "CYP21A1P-q20" | head -1 | cut -f 2-12`
  t5=`grep -w "$ll" out-CN-CYP21A2-4.23.12.22 | grep -w "CYP21A2-q20" | head -1 | cut -f 2-12`
  echo "$t1     $t2     $t3     $t4     $t5"
done
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 %

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % bash script-2 > CYP21A2-depth.txt
> t9 <- read.delim("CYP21A2-depth.txt")
 dim(t9)
#  [1] 838  41
 t10 <- merge(t8, t9, by.x="V1", by.y="file")
 dim(t10)
#  [1] 838 114
 t10$cyp21.tot <- (t10$meandepth.y + t10$meandepth.1.y) / t10$seq.dep * 2
 t10$CYP21A2 <- t10$meandepth.3.y / t10$seq.dep * 2
 t10$CYP21A1P <- t10$meandepth.2.y / t10$seq.dep * 2


 plot(t10$cyp21.tot, t10$c4.tot.no.intron9)
 abline(v = seq(0,10000,1), lty = 5, lwd = 0.5, col = "grey")
 abline(h = seq(0,10000,1), lty = 5, lwd = 0.5, col = "grey")
 x=1:100
 y=x
 abline(lm(y~x))

> par(mar=c(5,6,4,2))
> plot(t10$cyp21.tot, t10$c4.tot.no.intron9, cex.lab=2, cex=1, ylab="total C4 copy number (no.intron9)", xlab="total CYP21A copy number")

 hist(t10$cyp21.tot, breaks = seq(0,13, 0.5/2/2))
 abline(v = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,2), lty = 5, lwd = 0.5, col = "blue")

 d <- density(t10$cyp21.tot, bw = 0.15)
 plot(d$x, d$y, col="red")
 lines(d$x, d$y, col="red")
 abline(v = seq(0,10000,1), lty = 5, lwd = 0.5, col = "blue")

#######################################################################

linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/temp-dir-bams$ cat script-3
#
t1=31990500

while [ $t1 -gt 29983000 ]
do
 file="../GTEX-1269C-1826-SM-DO3X2.bam"
 e=`expr $t1 - 3000`
 samtools coverage -r "chr6:$e-$t1" -q 0   "$file"
 t1=`expr $t1 - 3000`
done

t1=31990500

while [ $t1 -lt 34035000 ]
do
 file="../GTEX-1269C-1826-SM-DO3X2.bam"
 e=`expr $t1 + 3000`
 samtools coverage -r "chr6:$t1-$e" -q 0   "$file"
 t1=`expr $t1 + 3000`
done

linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/temp-dir-bams$ bash script-3 > out
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 %  cat out | head -1 > out1
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 %  cat out | grep -w chr6 | sort -t '      ' +1 -2n | uniq >> out1

> t1 <- read.delim("out1")
 summary(t1)
 t1$cn <- t1$meandepth / seq.dep * 2
 d <- density(t1$cn, bw=0.15)
 plot(d$x, d$y, col="red")
 lines(d$x, d$y, col="red")
 abline(v = seq(0,10000,1), lty = 5, lwd = 0.5, col = "blue")

 t2 <- t1[ t1$startpos > 32050000,]
 hist(t2$cn)
 abline(v = seq(0,10000,1), lty = 5, lwd = 0.5, col = "blue")
 dim(t2)
#  [1] 662  10
 t3 <- t2[ t2$meanmapq > 50,]
 dim(t3)
#  [1] 658  10
 t3 <- t2[ t2$meanmapq > 55,]
 dim(t3)
#  [1] 649  10
 t2 <- t1[ t1$endpos < 31980000,]
 dim(t2)
#  [1] 666  10
#######################################################################

name: C2
location: chr6:31927717-31945672 (+)
id: NM_001282458.2
https://www.ncbi.nlm.nih.gov/gene/?term=NM_001282458.2

linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$ cat temp-dir-bams/script-2.B
#
#name: C2
# location: chr6:31927717-31945672 (+)
# id: NM_001282458.2
# https://www.ncbi.nlm.nih.gov/gene/?term=NM_001282458.2


file="GTEX-11DXX-0004-SM-6WBT9.bam"

 echo -n "file  gene    "
 samtools coverage -r chr6:32038415-32041644 -q 0  "$file" | head -1

ls GTEX*.bam | head -60123 | while read file
do
# samtools index "$file"

 echo -n "$file C2      "
 samtools coverage -r chr6:31927717-31945672 -q 0 -H   "$file"
done


linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$ bash temp-dir-bams/script-2.B > out
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % scp linyong@fry.wi.mit.edu:/lab/solexa_page/linyong/gtex-dna-aug2024/out ./
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % mv -i out C2-depth.txt
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % vi C2-depth.txt
> t7 <- read.delim("C2-depth.txt")
 t8 <- merge(t6, t7, by.x="V1", by.y="file")
 dim(t8)
#  [1] 838  39
 t8$c2.CN <- t8$meandepth / t8$seq.dep * 2
 t8$C2.CN <- t8$c2.CN / median(t8$c2.CN) * 2
######################################
> C4A.CN <- t10$c4a    *  20.0916
 C4B.CN <- t10$c4b  *    19.2208 
 plot(C4A.CN, C4B.CN)
 abline(v = seq(0,10000,1), lty = 5, lwd = 0.5, col = "grey")
  abline(h = seq(0,10000,1), lty = 5, lwd = 0.5, col = "grey")
 x=-100:100
 y=2*x
 abline(lm(y~x), lty = 5, lwd = 1, col = "blue")
 y=1/2*x
 abline(lm(y~x), lty = 5, lwd = 1, col = "blue")
 text(5.5, 2.8, "y=0.5x", pos=4, col="blue")
  text(2, 4.5, "y=2x", pos=4, col="blue")
 
 boxplot(C4A.CN, C4B.CN, ylab="CN", xat="n")
 abline(h = seq(0,100,0.2), lty = 5, lwd = 0.5, col = "gray")
 axis(1, at=1:2, labels=c("C4A.CN", "C4B.CN"))

> plot(t10$c4.tot.no.intron9 ~ t10$cyp21.tot)
abline(h = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")
abline(v = seq(0,100,1), lty = 5, lwd = 0.5, col = "gray")
 x=t10$cyp21.tot * 1.005465 + 0.192301
 y=t10$c4.tot.no.intron9
 abline(lm(y~x))

> d <- density(t10$c4.tot.no.intron9 - 0.2, bw = 0.15)
  plot(d$x, d$y, col="red")
  lines(d$x, d$y, col="red")
  abline(v = seq(0,10000,1), lty = 5, lwd = 0.5, col = "blue")

#########
> f1 <- t10[ t10$c4.tot.no.intron9 - 0.2 > 4.5 & t10$c4.tot.no.intron9 - 0.2 < 6.5 & t10$cyp21.tot > 4.5 & t10$cyp21.tot < 6.5,]
> dim(f1)
[1] 363 117
> plot(f1$cyp21.tot, f1$c4.tot.no.intron9 - 0.2)
> abline(h = seq(0,100,1/2), lty = 5, lwd = 0.5, col = "blue")
> abline(v = seq(0,100,1/2), lty = 5, lwd = 0.5, col = "blue")
#######################################################################
> colnames(t10)
t11 <- t10[, c(1,26,27,117, 116)]
 t11$c4a <- t10$c4a    *  20.0916  + 0.2
 t11$c4b <- t10$c4b    *  19.2208  + 0.2
 t11$CYP21A1P <- t10$CYP21A1P * 1.23306
 t11$CYP21A2  <- t10$CYP21A2  * 1.08333
 head(t11)
 t12 <- round(t11[, c(2:5)])
 t12$donor <- t11[, 1]
 plot(t11$c4a, t12$c4a)
 abline(v = seq(0.5,10000,1), lty = 5, lwd = 0.5, col = "blue")
 plot(t11$CYP21A1P, t12$CYP21A1P)
 abline(v = seq(0.5,10000,1), lty = 5, lwd = 0.5, col = "blue")
> write.table(t12, "temp2", quote=F, sep="\t")
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % vi temp2
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp2 | awk 'NR > 1' |cut -f 1-4 |sort | uniq -c | sort -n | wc -l
      97
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp2 | awk 'NR > 1' |cut -f 1-4 |sort | uniq -c | sort -n | awk '$1 >= 3' |wc -l
      44
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp2 | awk 'NR > 1' |cut -f 1-4 |sort | uniq -c | sort -n | awk '$1 >= 6' |wc -l
      26
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp2 | awk 'NR > 1' |cut -f 1-4 |sort  | awk '$1 == $3 && $2==$4'  | wc -l
     275   32.81%
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % head temp2
c4a     c4b     CYP21A1P        CYP21A2 donor
2       3       2       3       GTEX-1117F-0003-SM-6WBT7
2       2       1       3       GTEX-111CU-0003-SM-6WBUD
1       3       1       3       GTEX-111FC-0001-SM-6WBTJ
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp2 | awk 'NR > 1' |cut -f 1-4 |sort  | awk '$1 == $3 '  | wc -l
     400
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp2 | awk 'NR > 1' |cut -f 1-4 |sort  | awk ' $2==$4'  | wc -l
     499
>  info <- read.delim("dir-gtex-website-data/GTEx_Analysis_v8_Annotations_SubjectPhenotypesDS.sampleID.txt")
> a11 <- merge(info, t11, by.x="SAMPID", by.y="V1")
> dim(a11)
[1] 838  10
> summary(a11)
> boxplot(a11$c4a ~ a11$SEX, xlab="", xaxt="n", ylab="C4A CN")
>  axis(side = 1, at=seq(1,2,by=1), labels =c("male(n=557)", "female(n=281)"))
>  abline(h = seq(0, 148, by=1), lty = 5, lwd = 0.5, col = "gray")
> t.test( a11[a11$SEX == 1,]$c4a, a11[a11$SEX == 2,]$c4a)

######
Hardy-Weinberg equilibrium

> d1 <- hist(t11$c4a, breaks=seq(-0.5, 6.5,1))
 d2 <- hist(t11$c4b, breaks=seq(-0.5, 6.5,1))
 res <- as.data.frame(matrix(nrow= length(d1$mids) * length(d2$mids), ncol=5))
 colnames(res) <- c("observed", "expected", "ratio", "cn.1", "cn.2")
 k = 0
 for(i in 1:length(d1$mids)) {
 for(j in 1:length(d2$mids)) {
 k = k+1
 res$cn.1[k] <- d1$mids[i]
 res$cn.2[k] <- d2$mids[j]
 res$observed[k] <- dim(t11[ t11$c4a <= res$cn.1[k] + 0.5 & t11$c4a > res$cn.1[k] - 0.5 & t11$c4b <=  res$cn.2[k] + 0.5 & t11$c4b > res$cn.2[k] - 0.5,])[1]
 res$expected[k] <- d1$counts[i] * d2$counts[j] / 838
 res$ratio[k] <- res$observed[k] / res$expected[k] 
 }
 }

 res$expected <- round(res$expected, digits=2)

> res[ res$expected == 0,]
> res[ res$ratio > 2 & res$expected != 0,]
> res[ res$ratio < 1/2 & res$expected != 0,]
> write.table(res, "temp1", quote=F, sep="\t")

######
> d1 <- hist(t11$CYP21A1P, breaks=seq(-0.5, 6.5,1))
 d2 <- hist(t11$CYP21A2, breaks=seq(-0.5, 6.5,1))
 res <- as.data.frame(matrix(nrow= length(d1$mids) * length(d2$mids), ncol=5))
 colnames(res) <- c("observed", "expected", "ratio", "cn.1", "cn.2")
 res$pval <- -1
 res$odds <- -1
 k = 0
 for(i in 1:length(d1$mids)) {
 for(j in 1:length(d2$mids)) {
 k = k+1
 res$cn.1[k] <- d1$mids[i]
 res$cn.2[k] <- d2$mids[j]
 res$observed[k] <- dim(t11[ t11$CYP21A1P <= res$cn.1[k] + 0.5 & t11$CYP21A1P > res$cn.1[k] - 0.5 & t11$CYP21A2 <=  res$cn.2[k] + 0.5 & t11$CYP21A2 > res$cn.2[k] - 0.5,])[1]
 res$expected[k] <- d1$counts[i] * d2$counts[j] / 838
 res$ratio[k] <- res$observed[k] / res$expected[k] 
 a <- res$observed[k]
 b <- 838 - a
 c <- round(res$expected[k], digits=0)
 d <- 838 - c
 m <- matrix(c(a,b,c,d), nrow=2, ncol=2, byrow=T)
 f <- fisher.test(m)
 res$pval[k] <- f$p.value
 res$odds[k] <- f$estimate
 }
 }

 res$expected <- round(res$expected, digits=2)
 res$compare <- "CYP21A1P-CYP21A2"

##################################
 STAR --runThreadN 8  --outFilterMultimapNmax 20  --genomeDir /lab/solexa_page/linyong/dir-star-genome-index-oh75 --readFilesIn  human_Microglia_RNA_polyA_P17_Temporal.fastq.gz  --readFilesCommand zcat   --outSAMtype BAM Unsorted --outSAMunmapped Within --outSAMattributes Standard

linyong@fry /lab/solexa_page/linyong/autism$ samtools sort  -@ 6 -o  human_Microglia_RNA_polyA_P17_Temporal.sorted.bam Aligned.out.bam
linyong@fry /lab/solexa_page/linyong/autism$ samtools index human_Microglia_RNA_polyA_P17_Temporal.sorted.bam
linyong@fry /lab/solexa_page/linyong/autism$ samtools view -q 0 -b -o human_Microglia_RNA_polyA_P17_Temporal.region1.bam human_Microglia_RNA_polyA_P17_Temporal.sorted.bam chr6:20123456-40123456
samtools index human_Microglia_RNA_polyA_P17_Temporal.region1.bam
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % scp linyong@fry.wi.mit.edu:/lab/solexa_page/linyong/autism/human_Microglia_RNA_polyA_P17_Temporal.region1.bam ./

#####################################
C4A     ENSG00000290788 C4B     CYP21A2
> sink("median-c4a-cyp21a2-expression.R.out")
 # all rna-seq samples in a tissue
 g2 <- as.data.frame( t(diff[ rownames(diff) %in% g1,]))
 str(g2)
 res <- paste(tissue, median(g2$ENSG00000244731.10), median(g2$ENSG00000290788.1), median(g2$ENSG00000224389.9), median(g2$ENSG00000231852.9), sep="\t")
 cat(res)
 cat("\n")
                  geneID            name
25277  ENSG00000224389.9             C4B
30323  ENSG00000231852.9         CYP21A2
37237 ENSG00000244731.10             C4A
62195  ENSG00000290788.1 ENSG00000290788

############################################
> identical(t10$V1, t11$V1)
[1] TRUE
> t11$c4a.int <- round(t11$c4a, digits=0)
> t11$c4b.int <- round(t11$c4b, digits=0)
> t11$c4.tot.no.intron9.int <- round(t10$c4.tot.no.intron9 - 0.2, digits=0)
> t12 <- t11[ t11$c4a.int + t11$c4b.int == t11$c4.tot.no.intron9.int,]
> dim(t12)
[1] 466 (55.60%)   8
> h1 <- hist(t12$c4.tot.no.intron9.int, breaks=seq(-0.5, 11.5, 1))
> h1
$counts
 [1]   0   0   6  43 133 128 113  33   8   1   0   1
$mids
 [1]  0  1  2  3  4  5  6  7  8  9 10 11
> hist(t10[ t10$V1 %in% t12$V1,] $c4.tot.no.intron9 - 0.2, breaks=seq(0, 12, 0.5/2/2))
> dim(t10[ t10$V1 %in% t12$V1,])
[1] 466 117
 d <- density(t10[ t10$V1 %in% t12$V1,] $c4.tot.no.intron9 - 0.2, bw = 0.15)
 plot(d$x, d$y, col="red")
 lines(d$x, d$y, col="red")
 abline(v = seq(0,10000,1), lty = 5, lwd = 0.5, col = "blue")

 abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "blue")
 abline(v = seq(-100,100,1), lty = 5, lwd = 0.5, col = "blue")
 abline(h = seq(-0.5,10.5,1), lty = 5, lwd = 0.5, col = "grey")
 abline(v = seq(-0.5,100,1), lty = 5, lwd = 0.5, col = "grey")
 x=0:10
 y=x
 abline(lm(y~x), col="red")

#############################################
# c4a-c4b-cyp21pa-cnv-expression

 sid <-  log2(g6$ENSG00000244731.10 + 1) - s3$coefficients[3,1] * g6$t.SMRIN  - s3$coefficients[4,1] * log10(g6$t.SMTSISCH + 1300) - s3$coefficients[5,1] * g6$SEX.x - s3$coefficients[6,1] * g6$age_value - s3$coefficients[7,1] * g6$body_mass_index - s3$coefficients[1,1] 
 lm1 <- lm(sid ~ log2(g6$c4a - 0.2))
 summary(lm1)

Call:
lm(formula = sid ~ log2(g6$c4a - 0.2))

Coefficients:
                     Estimate Std. Error t value Pr(>|t|)
(Intercept)        -1.478e-15  1.288e-01    0.00        1
log2(g6$c4a - 0.2)  1.183e+00  9.580e-02   12.35   <2e-16 ***

Multiple R-squared:  0.4253,    Adjusted R-squared:  0.4225
F-statistic: 152.4 on 1 and 206 DF,  p-value: < 2.2e-16

> g7 <- data.frame(resid = sid, C4A = g6$c4a , expr = g6$ENSG00000244731.10)

 g7$C4A.int <- round(g7$C4A, digits=0)
 g7$C4A.minus0.2.int <- round(g7$C4A - 0.2, digits=0)
 boxplot(g7$resid ~ g7$C4A.int, ylab="residual C4A expression (log2(cpm+1))")
 abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")

 wilcox.test(g7[ g7$C4A.int == 2,]$resid, g7[ g7$C4A.int == 3,]$resid)
 wilcox.test(g7[ g7$C4A.int == 3,]$resid, g7[ g7$C4A.int == 4,]$resid)
 wilcox.test(g7[ g7$C4A.int == 2,]$resid, g7[ g7$C4A.int == 4,]$resid)

 h1 <- hist(g7$C4A, breaks=seq(-0.5, 6.5,1))

###6-17-2025
>  h1 <- hist(g7$C4A, breaks=seq(-0.5, 6.5,1))
 g8 <- g7[ g7$C4A.int == 2,]
 dim(g8)
 lm1 <- lm(g8$resid ~ log2(g8$C4A - 0.2))
 summary(lm1)

#######################################################################
 t12$nat.c4a.int <- t12$c4a
 t1 <- dim(t12[ t12$c4a < 0.5,])[1]
 t1
#  [1] 5

#2016 nature figure 3A
#CN         1,2,3,4
 dis <- c(19,64,13,3)
 sum(dis)
#  [1] 99
 d1 <- dis / sum(dis)
 d1
#  [1] 0.19191919 0.64646465 0.13131313 0.03030303
 sum(d1)
#  [1] 1

 t2 <- 1:10
 t3 <- sort(t12$c4a)
 t4 <- round( (dim(t12)[1] - t1) * d1)
 t4
 t2[1] <- t3[ t4[1] + t1]
 t2[2] <- t3[ t4[1] + t4[2] + t1]
 t2[3] <- t3[ t4[1] + t4[2] + t4[3] + t1]
 t2

for(i in 1:dim(t12)[1]) {
 if(t12$c4a[i] < 0.5 ) {t12$nat.c4a.int[i] = t12$c4a[i]}
 if(t12$c4a[i] >= 0.5 & t12$c4a[i] < t2[1] ) {t12$nat.c4a.int[i] = 1}
 if(t12$c4a[i] >= t2[1] & t12$c4a[i] < t2[2] ) {t12$nat.c4a.int[i] = 2}
 if(t12$c4a[i] >= t2[2] & t12$c4a[i] < t2[3] ) {t12$nat.c4a.int[i] = 3}
 if(t12$c4a[i] >= t2[3] ) {t12$nat.c4a.int[i] = 4}
 }
 plot(t12$c4a, t12$nat.c4a.int)
 abline(v= seq(-100,100,1/2), lty = 5, lwd = 0.5, col = "blue")
 abline(h= seq(-100,100,1/2), lty = 5, lwd = 0.5, col = "blue")

 t5 <- hist(t12$nat.c4a.int, breaks=seq(-0.5, 6.5,1))
 t5
...
...
 lm3 <- lm(log2(g6$ENSG00000244731.10+1) ~ log2(g6$nat.c4a.int) + g6$t.SMRIN + log10(g6$t.SMTSISCH + 1300) + g6$SEX.x + g6$age_value + g6$body_mass_index )
 s3 <- summary(lm3)
 s3
 s3$coefficients
 g6$c4a.int <- round(g6$c4a, digits=0)
 for(i in 1:dim(g6)[1]) {
 if(g6$c4a.int[i] == 0) {
    g6$c4a.int[i] = g6$c4a[i]
}
}

 lm3 <- lm(log2(g6$ENSG00000244731.10+1) ~ log2(g6$c4a.int) + g6$t.SMRIN + log10(g6$t.SMTSISCH + 1300) + g6$SEX.x + g6$age_value + g6$body_mass_index )
 s3 <- summary(lm3)
 s3
 s3$coefficients

#######################################################################
> for( i in c(seq(1.1, 1.8, 0.1), 1)) {
cat(tissue)
cat("\t")
cat(dim(g6)[1])
cat("\t")

cat(i)
cat("\t")
g6$c4a.int <- round(g6$c4a / i, digits=0)
 for(i in 1:dim(g6)[1]) {
 if(g6$c4a.int[i] == 0) {
    g6$c4a.int[i] = g6$c4a[i]
}
}

 lm3 <- lm(log2(g6$ENSG00000244731.10+1) ~ log2(g6$c4a.int) + g6$t.SMRIN + log10(g6$t.SMTSISCH + 1300) + g6$SEX.x + g6$age_value + g6$body_mass_index )
 s3 <- summary(lm3)
 s3
 s3$coefficients
 cat(s3$coefficients[2,4])
 cat("\t")
 h1 <- hist(g6$c4a.int, breaks=seq(-0.5, 6.5,1))
 cat(round(h1$density, digits=2)[2:5])
 cat("\n")
 }

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat script
#

# Adipose - Subcutaneous        581     1       1.188315e-17    0.06 0.35 0.44 0.12
# Adipose - Visceral (Omentum)  469     1.1     3.426569e-09    0.09 0.41 0.42 0.07

cat temp| awk 'BEGIN {FS = "\t"; OFS = "\t"} NF == 5' | cut -f 1 | uniq > temp-tiss

cat temp-tiss | while read ll
do
  grep "^$ll    "  temp| awk 'BEGIN {FS = "\t"; OFS = "\t"} NF == 5' | sort -t '        ' +3 -4g | head -1
done
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 %
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % bash script > temp1
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp1 | cut -f 3 | sort -g | uniq -c
   9 1
   7 1.1
   6 1.2
  13 1.3
   2 1.4
   5 1.5
   1 1.6
   1 1.8
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp1 | wc -l
      44
cat temp| awk 'BEGIN {FS = "\t"; OFS = "\t"} NF == 5 && $3 == 1'  > temp2
paste temp1 temp2 | awk 'BEGIN {FS = "\t"; OFS = "\t"}  $1 == $6' > temp3

#######################################################################
sink("temp")
for( i in c(seq(0.5, 1.5, 0.1/2) )) {
cat(tissue)
cat("\t")
cat(dim(g6)[1])
cat("\t")

cat(round(i, digits=2))
cat("\t")
g6$c4a.int <- round(g6$c4a * i, digits=0)
 for(i in 1:dim(g6)[1]) {
 if(g6$c4a.int[i] == 0) {
    g6$c4a.int[i] = g6$c4a[i]
}
}

 lm3 <- lm(log2(g6$ENSG00000244731.10+1) ~ log2(g6$c4a.int) + g6$t.SMRIN + log10(g6$t.SMTSISCH + 1300) + g6$SEX.x + g6$age_value + g6$body_mass_index )
 s3 <- summary(lm3)
 s3
 s3$coefficients
 cat(s3$coefficients[2,4])
 cat("\t")
 h1 <- hist(g6$c4a.int, breaks=seq(-0.5, 16.5,1))
 cat(round(h1$density, digits=2)[2:5])
 cat("\n")
 }
sink()
 s1 <- read.delim("temp", header=F)
 plot(s1$V3, -log10(s1$V4), xlab="* scale factor", ylab="-log10 pVal", main=tissue)
 lines(s1$V3, -log10(s1$V4))
 abline(v = seq(0.5,10000,0.1), lty = 5, lwd = 0.5, col = "blue")
 abline(h=max(-log10(s1$V4)))
 abline(v = 1, col="red")

#######################################################################
# from temp-c4a-c4b-cyp21pa-cnv-expression
> dim(t13)
#  [1] 543  13
 t14 <- t13[ t13$cyp21a1p.int == 0,]
 dim(t14)
#  [1] 14 13
 summary(t14$CYP21A1P)
#     Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
#  0.00000 0.00000 0.00000 0.02054 0.02733 0.12171
 sort(t14$cyp21a2.int)
#   [1] 2 2 2 2 2 2 2 3 3 3 3 4 4 5
 t14[ t14$cyp21a2.int == 4,]
#                            V1      c4a      c4b   CYP21A1P  CYP21A2 c4.tot.no.intron9 c4.tot.no.intron9.int cyp21.tot cyp21.tot.int c4a.int c4b.int cyp21a1p.int cyp21a2.int
#  224 GTEX-14JFF-0002-SM-DLIOQ 1.770671 2.541950 0.00000000 3.725652          3.793055                     4  3.860895             4       2       3            0           4
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/temp-dir-bams$ samtools mpileup -Q 0  -q 0 -d 1000000 -f  /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa  ../GTEX-14JFF-0002-SM-DLIOQ.bam > GTEX-14JFF-0002-SM-DLIOQ.q0.pile
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % mv GTEX-14JFF-0002-SM-DLIOQ.q0.pile temp
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % vi temp

> p1 <- read.delim("temp", quote=NULL, header=F)
name: C2
 p2 <- p1[ p1$V2 > 31927717 & p1$V2 < 31945672,  ]
 dim(p2)
#  [1] 17954     6
 summary(p2$V4)
#     Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
#    25.00   41.00   46.00   46.41   52.00   79.00
 p3 <- p2[ seq(100, dim(p2)[1], 50),]
 dim(p3)
#  [1] 358   6
#  > name: CYP21A1P
 p2 <- p1[ p1$V2 > 32005636 & p1$V2 < 32008909,  ]
 dim(p2)
#  [1] 1891    6
#  > name: CYP21A2
 p2 <- p1[ p1$V2 > 32038415 & p1$V2 < 32041644,  ]
 dim(p2)
#  [1] 3228    6

linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/temp-dir-bams$  ~/C++/reSeqPrintChrRegion.fq /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa  out chr6 32038415 32038515
mapped to CYP21A1P locus
chr6    32005680        32005781        +       960     99      2       0       0       0       0       0       0
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/temp-dir-bams$ ~/C++/reSeqPrintChrRegion.fq /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa  out chr6     32041544  32041644
mapped to CYP21A1P locus
chr6    32008808        32008909        +       920     97      4       0       0       0       0       0       0
samtools view -b   ../GTEX-14JFF-0002-SM-DLIOQ.bam chr6:32005636-32008909 > temp.1.bam
samtools view -b   ../GTEX-14JFF-0002-SM-DLIOQ.bam chr6:32038415-32041644 > temp.2.bam
samtools merge temp.3.bam  temp.1.bam  temp.2.bam
samtools view temp.3.bam | wc -l
#  1844
samtools view temp.3.bam | awk 'BEGIN {FS = "\t"; OFS = "\t"}
{
 print ">" $1 "seq_" NR;
 print $10
}'  > temp.3.fasta
~/C++/reSeqPrintChrRegion.fq /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa  out chr6 32038415 32041644 > CYP21A2.dna
vi CYP21A2.dna
bwa index CYP21A2.dna
bwa mem -t 4 CYP21A2.dna  temp.3.fasta > temp.4.sam
cat temp.4.sam |  cut -f 2 | sort | uniq -c
cat temp.4.sam |  cut -f 5 | sort -g | uniq -c
samtools view -b   temp.4.sam > temp.4.bam
samtools sort -@ 4 -o  temp.4.sort.bam  temp.4.bam
rm -f temp.4.pile
samtools mpileup -Q 0  -q 0 -d 1000000 -f   CYP21A2.dna temp.4.sort.bam  > temp.4.pile
> p8 <- read.delim("temp.4.pile", quote=NULL, header=F)
 dim(p8)
#  [1] 3230    6

p9 <- p8[ 200: (dim(p8)[1] - 200),]
 dim(p9)
#  [1] 2831    6
#  name: C2
 p2 <- p1[ p1$V2 > 31927717 & p1$V2 < 31945672,  ]
 dim(p2)
#  [1] 17954     6
 p10 <- p2[sort( sample(1:dim(p2)[1], dim(p9)[1] )),]
 p10$V5 <- p10$V2
 p10$V2 <- p9$V2
 p9$V5 <- p9$V2
 p9$V6 <- "CYP21A2"
 p10$V6 <- "C2"
 p10$V7 <- p10$V4 / median(p10$V4) * 40.92485
 p9$V7 <- p9$V4
 summary(p10$V4)
 summary(p10$V7)

 p11 <- rbind(p9,p10)
> gplot(p11, aes(x=V2, y=V7, group=V6, color=V6)) + geom_point(shape=21, size=1) + geom_smooth(method="lm") + labs(x= "relative pos.", y="seq coverage")

> # t10$cyp21.tot <- (t10$meandepth.y + t10$meandepth.1.y) / t10$seq.dep * 2
> t10[ t10$V1 == "GTEX-14JFF-0002-SM-DLIOQ",]$meandepth.y
[1] 3.50947
> t10[ t10$V1 == "GTEX-14JFF-0002-SM-DLIOQ",]$meandepth.1.y
[1] 75.4938
> t10[ t10$V1 == "GTEX-14JFF-0002-SM-DLIOQ",]$seq.dep
[1] 40.92485
> (3.50947 + 75.4938) / 40.92485 * 2
[1] 3.860895

####
rm -f temp.1.bam temp.2.bam
samtools view -b   ../GTEX-1122O-0004-SM-6WBTE.bam chr6:32005636-32008909 > temp.1.bam
samtools view -b   ../GTEX-1122O-0004-SM-6WBTE.bam chr6:32038415-32041644 > temp.2.bam
samtools merge  -f temp.3.bam  temp.1.bam  temp.2.bam
# 1432 temp.3.bam
rm -f temp.3.fasta
samtools view temp.3.bam | awk 'BEGIN {FS = "\t"; OFS = "\t"}
{
 if($2 == 147 || $2 == 163 || $2 == 99 || $2 == 83)
 {
  print ">" $1 "seq_" NR;
  print $10
 }
}'  > temp.3.fasta
cat temp.3.fasta | grep "^>" | wc -l
1035
rm -f temp.4.sam temp.4.sort.bam  temp.4.bam temp.4.pile
bwa mem -t 4 CYP21A2.dna  temp.3.fasta > temp.4.sam
cat temp.4.sam |  cut -f 2 | sort | uniq -c
cat temp.4.sam |  cut -f 5 | sort -g | uniq -c
samtools view -b   temp.4.sam > temp.4.bam
samtools sort -@ 4 -o  temp.4.sort.bam  temp.4.bam
samtools mpileup -Q 0  -q 0 -d 1000000 -f   CYP21A2.dna temp.4.sort.bam  > temp.4.pile

#######################################################################

linyong@fry /lab/solexa_page/linyong/dir-temp$ cat /lab/solexa_page/linyong/dir-temp/slurm-sra-download-fastq
linyong@fry /lab/solexa_page/linyong/dir-temp$ cat biosample_result-accession-60samp.txt
SAMN07189912
SAMN07189911
SAMN07189859

SAMN07189858
SAMN07189857
SAMN07189830

linyong@fry /lab/solexa_page/linyong/dir-temp$
linyong@fry /lab/solexa_page/linyong/dir-temp$ cat biosample_result-accession-samp.txt
SRR33469140

linyong@fry /lab/solexa_page/linyong/dir-temp$

######################################
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ ~/C++/reSeqPrintChrRegion.fq /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa  out chr6 1 42041644 > chr6.42M.dna
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ grep "^>" chr6.42M.dna
>chr6 6
bwa index chr6.42M.dna
bwa bwasw  -f SRR33469140.sam -t 10  chr6.42M.dna /lab/solexa_page/linyong/dir-temp/SRR33469140.fastq
bwasw Failed: [vfprintf(stdout)] Value too large for defined data type

minimap2 -a -x map-ont -t 10 -o SRR33469140.sam   chr6.42M.dna /lab/solexa_page/linyong/dir-temp/SRR33469140.fastq

-rw-r--r-- 1 linyong systemd-timesync 268G Jun  7 22:23 SRR33469140.sam
31,158,725 SRR33469140.sam
-rw-r--r-- 1 linyong systemd-timesync  25G Jun  8 02:54 temp.q20.sam
-rw-r--r-- 1 linyong systemd-timesync 8.4G Jun  8 14:36 temp.q20.bam
-rw-r--r-- 1 linyong systemd-timesync 8.4G Jun  8 14:46 temp.q20.sort.bam
-rw-r--r-- 1 linyong systemd-timesync 659K Jun  8 15:00 temp.q20.sort.bam.bai
-rw-r--r-- 1 linyong systemd-timesync 406M Jun  8 15:23 temp.q20.sort.region.bam
-rw-r--r-- 1 linyong systemd-timesync  53K Jun  8 15:24 temp.q20.sort.region.bam.bai

rm -f temp.q20.sam temp.q20.bam

linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ srun -p 20 --cpus-per-task=12 --mem=64gb --pty bash -i
srun: job 7623598 queued and waiting for resources
srun: job 7623598 has been allocated resources

cat SRR33469140.sam | awk 'BEGIN {FS = "\t"; OFS = "\t"}
$4 > 20123456 && $5 >= 20
' > temp.q20.sam

cat SRR33469140.sam | head -2 > temp
srun -p 20 --cpus-per-task=12 --mem=64gb --pty bash -i
cat temp.q20.sam >> temp 
mv temp temp.q20.sam
samtools view -b -S -o temp.q20.bam temp.q20.sam &
samtools sort -@ 10 -o  temp.q20.sort.bam temp.q20.bam &
samtools index temp.q20.sort.bam &
samtools view -b  temp.q20.sort.bam chr6:31354242-32706773 > temp.q20.sort.region.bam &

samtools view -h temp.q20.sort.region.bam > temp.q20.sort.region.2.sam
-rw-r--r-- 1 linyong systemd-timesync 1.2G Jun  8 16:09 temp.q20.sort.region.2.sam
vi temp.q20.sort.region.2.sam
delete duplicate line @PG       ID:minimap2     PN:minimap2     VN:2.24-r1122   CL:minimap2 -a -x map-ont -t 10 -o SRR33469140.sam chr6.42M.dna /lab/solexa_page/linyong/dir-temp/SRR33469140.fastq
samtools view -b -S -o temp.q20.sort.region.2.bam temp.q20.sort.region.2.sam
samtools index temp.q20.sort.region.2.bam

linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ mv temp.q20.sort.region.2.bam SRR33469140.q20.sort.region.2.bam
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ mv temp.q20.sort.region.2.bam.bai  SRR33469140.q20.sort.region.2.bam.bai 
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ java -jar /usr/local/share/picard-tools/picard.jar SamToFastq I="SRR33469140.q20.sort.region.2.bam"  FASTQ=SRR33469140.q20.sort.region.2.fastq 
-rw-r--r-- 1 linyong systemd-timesync 931M Jun  9 13:34 SRR33469140.q20.sort.region.2.fastq
-rw-r--r-- 1 linyong systemd-timesync 406M Jun  8 16:14 SRR33469140.q20.sort.region.2.bam
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ cat SRR33469140.q20.sort.region.2.fastq | awk 'NR % 4 == 1' | wc -l
10195
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ cat SRR33469140.q20.sort.region.2.fastq | awk 'NR % 4 == 1' | sort | uniq -d | wc
      0       0       0
samtools view "SRR33469140.q20.sort.region.2.bam" | cut -f 1 | wc -l
75925
samtools view "SRR33469140.q20.sort.region.2.bam" | cut -f 1 | sort | uniq | wc -l
70019

linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ vi /home/linyong/C++/fastq2fa.longread.divide300pb.C
g++ -o /home/linyong/C++/fastq2fa.longread.divide300pb /home/linyong/C++/fastq2fa.longread.divide300pb.C

bwa mem -t 4 /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa   out > temp.sam

cat temp.sam | awk 'NF > 11' | cut -f 1-9,12
@SRR33469140.101-1	0	chr14	100089786	60	300M	*	0	0	NM:i:0
@SRR33469140.101-2	0	chr14	100090086	60	300M	*	0	0	NM:i:0
@SRR33469140.101-3	0	chr14	100090386	60	106M1I193M	*	0	0	NM:i:1
@SRR33469140.101-4	0	chr14	100090685	60	300M	*	0	0	NM:i:0
@SRR33469140.101-5	0	chr14	100090985	60	198M1D102M	*	0	0	NM:i:1

linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ cat /lab/solexa_page/linyong/dir-temp/SRR33469140.fastq | head -100 > temp
cat temp | awk 'NR % 4 == 1' | awk '{print $1}' | sed 's/@//' > temp-reads
/home/linyong/C++/fastq.selReads  temp out 300  temp-reads
g++ -o  /home/linyong/C++/fastq.selReads  /home/linyong/C++/fastq.selReads.C
/home/linyong/C++/fastq.selReads  temp out 300  temp-reads
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ diff  temp out  | wc
      0       0       0
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ samtools view "SRR33469140.q20.sort.region.2.bam" | cut -f 1 | sort | uniq > temp1 
70019 temp1

/home/linyong/C++/fastq.selReads  /lab/solexa_page/linyong/dir-temp/SRR33469140.fastq SRR33469140.q20.sort.region.2.fastq 300 temp1  
280076 SRR33469140.q20.sort.region.2.fastq

cat  SRR33469140.q20.sort.region.2.fastq | grep SRR33469140.2461042 -A 1 > temp1
 /home/linyong/C++/fastq2fa.longread.divide300pb temp1 temp2 300
bwa mem -t 14 /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa temp2 > temp2.sam 
samtools view -b -S -o temp2.bam temp2.sam
samtools sort -@ 10 -o  temp2.sort.bam temp2.bam
samtools index temp2.sort.bam 
samtools mpileup -Q 0  -q 0 -d 1000000 -f  /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa temp2.sort.bam > temp2.pile

cat temp2.sam | awk 'NF > 11' | cut -f 3 |uniq -c
     39 chr6
      1 chr11
      2 chr6
      1 chr5
    577 chr6

######
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ samtools view -b   temp2.sort.bam chr6:31354242-32706773 >  SRR33469140.sort.readL300.region.2.bam

# C4A exon #28 16-bp covering 4 SNPs between c4a and c4b
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ samtools view -q 20 SRR33469140.sort.readL300.region.2.bam  chr6:31996539-31996554 | cut -f 1-9,12 | cut -f 1 | sed 's/-[0-9]*$//' | sort | uniq -c | awk '$1 > 1'

# C4B exon #28 16-bp covering 4 SNPs between c4a and c4b
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ samtools view -q 20 SRR33469140.sort.readL300.region.2.bam  chr6:32029277-32029292 | cut -f 1-9,12 | cut -f 1 | sed 's/-[0-9]*$//' | sort | uniq -c | awk '$1 > 1'

rm -f temp1 temp2
samtools view -q 20 SRR33469140.sort.readL300.region.2.bam  chr6:31996539-31996554 | cut -f 1-9,12 | cut -f 1 | sed 's/-[0-9]*$//' | sort | uniq > temp1
samtools view -q 20 SRR33469140.sort.readL300.region.2.bam  chr6:32029277-32029292 | cut -f 1-9,12 | cut -f 1 | sed 's/-[0-9]*$//' | sort | uniq > temp2
cat temp1 temp2 | sort | uniq -d

rm -f out
samtools view -q 20 SRR33469140.sort.readL300.region.2.bam | grep "SRR33469140.1177264-" | cut -f  1-9,12 | sed 's/-/     /' | sort -t '  ' +1 -2n > out
> t1 <- read.delim("out", header=F)
g1 <- read.delim("gene.coord")

 plot(t1$V2, t1$V5, xlab="order of 300-bp unit within long read\nmapQ >= 20 ", ylab="chr pos.", main="Read ID SRR33469140.1177264")
 lines(t1$V2, t1$V5, col="red")
 abline(h = seq(0,1e8,10000/2), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(0, 10000, 25), lty = 5, lwd = 0.5, col = "gray")

 lines(g1$x[1:2], g1$y[1:2], lwd = 2)
 text(g1$x[1] + 1, g1$y[1] + 10, g1$gene[1], pos=4)
 lines(g1$x[3:4], g1$y[3:4], lwd = 2)
 text(g1$x[3] + 1, g1$y[3] + 10, g1$gene[3], pos=4)
 lines(g1$x[5:6], g1$y[5:6], lwd = 2)
 text(g1$x[5] + 1, g1$y[5] + 10, g1$gene[5], pos=4)
 lines(g1$x[7:8], g1$y[7:8], lwd = 2)
 text(g1$x[7] + 1, g1$y[7] + 10, g1$gene[7], pos=4)

> g1
      gene x        y
1      c4a 1 31982057
2      c4a 1 32002681
3      c4b 1 32014795
4      c4b 1 32035418
5 cyp21a1p 1 32005636
6 cyp21a1p 1 32008909
7  cyp21a2 1 32038415
8  cyp21a2 1 32041644

######
## get one long read, minimap2 ref genome, 
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ cat temp-scr
#
cat  SRR33469140.q20.sort.region.2.fastq | grep "SRR33469140.1177264 " -A 1 > temp1
wc -l temp1
minimap2 -a -x map-ont -t 4  -o temp2.sam /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa temp1
samtools view -b -S -o temp2.bam temp2.sam
samtools sort -@ 10 -o  SRR33469140.1177264.sort.bam temp2.bam
samtools index SRR33469140.1177264.sort.bam
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ bash -x temp-scr

samtools view -q 20 SRR33469140.sort.readL300.region.2.bam  chr6:32029277-32029292 | cut -f 1-9,12 | cut -f 1 | sed 's/-[0-9]*$//' | sort | uniq | while read ll
do
 echo "$ll"
 samtools view -q 20 SRR33469140.sort.readL300.region.2.bam | grep "${ll}-" | cut -f  1-9,12 | head -6 | grep "${ll}"  
done

SRR33469140.1533065
SRR33469140.1533065-1   0       chr6    31941729        60      86M2D214M       *       0       0       NM:i:2
SRR33469140.1533065-2   0       chr6    31942031        60      94M10I196M      *       0       0       NM:i:11
SRR33469140.1533065-3   0       chr6    31942321        60      300M    *       0       0       NM:i:0
SRR33469140.1533065-4   0       chr6    31942621        60      300M    *       0       0       NM:i:0

linyong@c1b3 /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ cat slurm-6

/home/linyong/C++/fastq2fa.longread.divide300pb   /lab/solexa_page/linyong/dir-temp/SRR33469140.fastq  temp2 300
bwa mem -t 14 /lab/solexa_page/linyong/gencode/GRCh38.primary_assembly.genome.fa temp2 > temp2.sam
samtools view -b -S -o temp2.bam temp2.sam

samtools sort -@ 14 -o  temp2.sort.bam temp2.bam
samtools index temp2.sort.bam

###
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ samtools coverage -q 0 temp2.sort.bam
#rname	startpos	endpos	numreads	covbases	coverage	meandepth	meanbaseq	meanmapq
chr1	1	248956422	33376707	229583152	92.2182	39.0282	255	52.5
chr2	1	242193529	35144170	239943160	99.0708	41.4551	255	54.8

linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ cat script-call-CN-2
# bam already indexed
#


file="temp2.sort.bam"

# chr6 1 170,805,979 

t=10000000
while [ $t -lt 170123456 ]
do
 t1=`expr $t + 5000`
 r=`echo "chr6:${t}-${t1}"`
 echo  "\|${r}\|"
 samtools coverage -r "$r" -q 0  "$file" 
 t=`expr $t + 1000000`
done

linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ 
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ bash script-call-CN-2 > temp
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat  temp | awk 'NR % 3 == 2' | head -1 > out
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat  temp | awk 'NR % 3 == 0' >> out         
> t1 <- read.delim("out")
 t2 <- t1[, c(2,7)]
 t3 <- t1[, c(3,7)]
 colnames(t3)[1] <- colnames(t2)[1]
 t4 <- rbind(t2, t3)
 t5 <- t4[ order(t4$startpos),]
 head(t5)

 plot(t5$startpos, t5$meandepth, xlab="chr6 pos. (samtools coverage -r $r -q 0)")
 lines(t5$startpos, t5$meandepth, col="red")
 abline(h = seq(0,100,10), lty = 5, lwd = 0.5, col = "gray")
 abline(lm(t5$meandepth ~ t5$startpos), lwd = 1, col = "blue")
g1 <- read.delim("gene.coord")
 lines( g1$y[1:2], c(10,10),lwd = 10)
 text(g1$y[1] ,  10, g1$gene[1], pos=1)
 mid=mean(g1$y[1:2])
 abline(v=mid, lty=5)

Median two chr seq depths
chr1  1 248956422 33376707 229583152 92.2182 39.0282 255 52.5
chr21 1  46709983 6518383 39541213 84.6526 39.1048 255 44.3

linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ bash script-bam-c4a-depth SRR33469140.sort.readL300.allchr.sort.bam
# samtools coverage -r "$R" -q 20 -H "$cram" 
header	geneID	geneName	header	#rname	startpos	endpos	numreads	covbases	coverage	meandepth	meanbaseq	meanmapq
SRR33469140.sort.readL300.allchr.sort	ENSG00000244731.10	C4A	geneIntv	chr6	31982057	32002681	56	1077	5.22182	0.7936	255	42.6
SRR33469140.sort.readL300.allchr.sort	ENSG00000224389.9	C4B	geneIntv	chr6	32014795	32035418	33	1026	4.97479	0.47949	255	46.2

linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024/Nanopore$ bash  script-call-CN  SRR33469140.sort.readL300.allchr.sort.bam
SRR33469140.sort.readL300.allchr.sort.bam	C4A	start-exon#9	chr6	31982057	31984408	192	2352	100	21.1416	255	0
SRR33469140.sort.readL300.allchr.sort.bam	C4A	exon#10-end	chr6	31991192	32002681	874	11477	99.8869	21.3498	255	3.22
SRR33469140.sort.readL300.allchr.sort.bam	C4B	start-exon#9	chr6	32014795	32017146	190	2352	100	20.5247	255	0
SRR33469140.sort.readL300.allchr.sort.bam	C4B	exon#10-end	chr6	32023930	32035418	868	11489	100	21.3209	255	2.56
SRR33469140.sort.readL300.allchr.sort.bam	CYP21A2	allgene	chr6	32038415	32041644	366	3230	100	30.5604	255	27.2
SRR33469140.sort.readL300.allchr.sort.bam	CYP21A1P	allgene	chr6	32005636	32008909	120	3139	95.8766	9.68632	255	30.4
SRR33469140.sort.readL300.allchr.sort.bam	CYP21A2-q20	allgene	chr6	32038415	32041644	173	2417	74.8297	13.4907	255	46.8
SRR33469140.sort.readL300.allchr.sort.bam	CYP21A1P-q20	allgene	chr6	32005636	32008909	75	2365	72.2358	5.93677	255	45.4

med <- (39.0282 + 39.1048) / 2
c4.tot.no.intron9 <- (21.1416 * 2352 + 21.3498 * 11490 + 20.5247 * 2352 + 21.3209 * 11489 ) / (2352 + 11489.5) / med * 2
cyp21.tot <- (30.5604 + 9.68632 ) / med * 2
c4a <- c4.tot.no.intron9 * 0.7936 / (0.7936 + 0.47949)
c4b <-  c4.tot.no.intron9 * 0.47949/(0.7936 + 0.47949)
CYP21A1P <-  cyp21.tot * 5.93677 / (5.93677 + 13.4907)
CYP21A2 <-  cyp21.tot * 13.4907 / (5.93677 + 13.4907)
c4a 
c4b
CYP21A1P
CYP21A2

#######################################
###permute CN assignment
###randomnize CN 
 g6$resid <-  log2(g6$ENSG00000244731.10 + 1) - s3$coefficients[3,1] * g6$t.SMRIN  - s3$coefficients[4,1] * log10(g6$t.SMTSISCH + 1300) - s3$coefficients[5,1] * g6$SEX.x - s3$coefficients[6,1] * g6$age_value - s3$coefficients[7,1] * g6$body_mass_index - s3$coefficients[1,1] 
 g6$c4a.int <- round(g6$c4a, digits=0)
for(i in 1:dim(g6)[1]) {
 if(g6$c4a.int[i] == 0) {
    g6$c4a.int[i] = g6$c4a[i]
}
}
 g6$random.C4A.int <- g6[ sample(1:dim(g6)[1], dim(g6)[1]),]$c4a.int
cor.test(g6$random.C4A.int, g6$c4a.int)
#       Pearson's product-moment correlation
#  t = -0.55707, df = 572, p-value = 0.5777

 lm3 <- lm(log2(g6$ENSG00000244731.10+1) ~ log2(g6$c4a.int) + g6$t.SMRIN + log10(g6$t.SMTSISCH + 1300) + g6$SEX.x + g6$age_value + g6$body_mass_index )
 s3 <- summary(lm3)
 s3
 s3$coefficients

 lm3 <- lm(log2(g6$ENSG00000244731.10+1) ~ log2(g6$random.C4A.int) + g6$t.SMRIN + log10(g6$t.SMTSISCH + 1300) + g6$SEX.x + g6$age_value + g6$body_mass_index )
 s3 <- summary(lm3)
 s3
 s3$coefficients
 g6$resid <-  log2(g6$ENSG00000244731.10 + 1) - s3$coefficients[3,1] * g6$t.SMRIN  - s3$coefficients[4,1] * log10(g6$t.SMTSISCH + 1300) - s3$coefficients[5,1] * g6$SEX.x - s3$coefficients[6,1] * g6$age_value - s3$coefficients[7,1] * g6$body_mass_index - s3$coefficients[1,1]

## 0.11 round to zero
 g6$random.C4A.int <- round(g6$random.C4A.int, digits=0)
  boxplot(g6$resid ~ g6$random.C4A.int, ylab="residual C4A expression (log2(cpm+1))")
  abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
 h1 <- hist(g6$random.C4A.int, breaks=seq(-0.5, 6.5,1))
 h1

#######################################
### Thyroid 574 1.070459364 1.08E-43
>  g6$c4a.int <- round(g6$c4a, digits=0)
 g6$c4a.int.2 <- round(g6$c4a / 1.4, digits=0)
 g7 <- g6[ order(g6$c4a),]
 plot(1:dim(g7)[1], g7$c4a.int, pch=19, col="red", cex=0.5, xlab="donor")
 points(1:dim(g7)[1], g7$c4a.int.2 - 0.2, pch=0, col="black", cex=1)
 abline(v = seq(0, 10000, 50), lty = 5, lwd = 0.5, col = "gray")
 text(350, 3, "distrib. of C4A CN (Page lab)", pos=3, col="red")
 text(350, 1.8, "distrib. of C4A CN (McCarroll lab)", pos=1, col="black")

 g8 <- g7[ g7$c4a.int == 2 & g7$c4a.int.2 == 2,]
 dim(g8)
#  [1] 103  29
# 2.100356 2.102898 2.106168 ...  2.486642 2.498249 2.499057
 g8$group <- "2C4A / 2C4A"

 g9 <- g7[ g7$c4a.int == 3 & g7$c4a.int.2 == 2,]
 dim(g9)
# 
# 261  29
# 2.500026 2.502617 2.503988 2.505258 2.505993 ...  3.457456 3.459950 3.482443 3.490646 3.490730
# 3.490730 / 1.4 = 2.493379
 g9$group <- "3C4A / 2C4A"
 g10 <- rbind(g8, g9)
 dim(g10)
#  [1] 364  30
 l1 <- lm(log2(g10$ENSG00000244731.10 + 1) ~ g10$group)
 summary(l1)

#                       Estimate Std. Error t value Pr(>|t|)    
#  (Intercept)           4.92644    0.09481  51.963  < 2e-16 ***
#  g10$group3C4A / 2C4A  0.40061    0.11196   3.578 0.000393 ***
# Multiple R-squared:  0.03416,	Adjusted R-squared:  0.03149 
# F-statistic:  12.8 on 1 and 362 DF,  p-value: 0.0003932

 lm3 <- lm(log2(g10$ENSG00000244731.10+1) ~ log2(g10$c4a.int) + g10$t.SMRIN + log10(g10$t.SMTSISCH + 1300) + g10$SEX.x + g10$age_value + g10$body_mass_index )
 s3 <- summary(lm3)
 s3
#                                Estimate Std. Error t value Pr(>|t|)    
# (Intercept)                  13.672396   2.085374   6.556 1.93e-10 ***
# log2(g10$c4a.int)             0.771322   0.180594   4.271 2.50e-05 ***
# g10$t.SMRIN                   0.173334   0.074065   2.340   0.0198 *  
# log10(g10$t.SMTSISCH + 1300) -3.051237   0.568001  -5.372 1.41e-07 ***
# g10$SEX.x                    -0.051463   0.104612  -0.492   0.6231    
# g10$age_value                -0.003706   0.003942  -0.940   0.3477    
# g10$body_mass_index          -0.017602   0.012183  -1.445   0.1494    
# ---
# Multiple R-squared:  0.1616,	Adjusted R-squared:  0.1475 
# F-statistic: 11.47 on 6 and 357 DF,  p-value: 9.779e-12

 sid <-  log2(g10$ENSG00000244731.10 + 1) - s3$coefficients[3,1] * g10$t.SMRIN  - s3$coefficients[4,1] * log10(g10$t.SMTSISCH + 1300) - s3$coefficients[5,1] * g10$SEX.x - s3$coefficients[6,1] * g10$age_value - s3$coefficients[7,1] * g10$body_mass_index - s3$coefficients[1,1] 
 lm1 <- lm(sid ~ log2(g10$c4a.int))
 summary(lm1)
 boxplot(sid ~ g10$group, xlab="C4A typing by two models", ylab="residual C4A expression (log2(cpm+1))")

 g11 <- g7[ g7$c4a.int == 2 & g7$c4a.int.2 == 1,] 
 dim(g11)
# 94
# 1.516157 1.530824 1.538152 ... 2.066928 2.070889 2.071528 2.082740
 g11$group <- "2C4A / 1C4A"
 g12 <- rbind(g11, g8)
 dim(g12)
# 197 = 94 + 103
 lm3 <- lm(log2(g12$ENSG00000244731.10+1) ~ log2(g12$c4a.int.2) + g12$t.SMRIN + log10(g12$t.SMTSISCH + 1300) + g12$SEX.x + g12$age_value + g12$body_mass_index )
 s3 <- summary(lm3)
 s3
#                               Estimate Std. Error t value Pr(>|t|)    
# (Intercept)                  13.003125   2.940056   4.423 1.64e-05 ***
# log2(g12$c4a.int.2)           0.028966   0.137239   0.211 0.833064    
# g12$t.SMRIN                   0.101317   0.102463   0.989 0.324010    
# log10(g12$t.SMTSISCH + 1300) -2.801176   0.819935  -3.416 0.000776 ***
# g12$SEX.x                    -0.118143   0.140689  -0.840 0.402104    
# g12$age_value                 0.005638   0.005441   1.036 0.301383    
# g12$body_mass_index           0.007553   0.016865   0.448 0.654790    
# Multiple R-squared:  0.0771,	Adjusted R-squared:  0.04795 
# F-statistic: 2.645 on 6 and 190 DF,  p-value: 0.01735
 sid <-  log2(g12$ENSG00000244731.10 + 1) - s3$coefficients[3,1] * g12$t.SMRIN  - s3$coefficients[4,1] * log10(g12$t.SMTSISCH + 1300) - s3$coefficients[5,1] * g12$SEX.x - s3$coefficients[6,1] * g12$age_value - s3$coefficients[7,1] * g12$body_mass_index - s3$coefficients[1,1] 
 lm1 <- lm(sid ~ log2(g12$c4a.int.2))
 summary(lm1)
 boxplot(sid ~ g12$group, xlab="C4A typing by two models", ylab="residual C4A expression (log2(cpm+1))")

>  l1 <- lm(log2(g12$ENSG00000244731.10 + 1) ~ g12$group)
>  summary(l1)

Coefficients:
                     Estimate Std. Error t value Pr(>|t|)
(Intercept)           4.95772    0.09938  49.888   <2e-16 ***
g12$group2C4A / 2C4A -0.03129    0.13744  -0.228     0.82
Residual standard error: 0.9635 on 195 degrees of freedom
Multiple R-squared:  0.0002657, Adjusted R-squared:  -0.004861
F-statistic: 0.05182 on 1 and 195 DF,  p-value: 0.8202
###
######
> t12 <- t11[ t11$c4.tot.no.intron9.int == t11$c4a.int + t11$c4b.int & t11$cyp21.tot.int == t11$cyp21a1p.int + t11$cyp21a2.int,]
> dim(t12)
[1] 313  13
> write.table(t12[, c(1,7, 9:13)], "temp-313don-c4a-cyp21a2.CN.txt", quote=F, sep="\t")
> system("date")
Wed Jun 18 12:51:49 EDT 2025

#######################################
65 individual long read sequencing and assembly
Glennis A. Logsdon, nature2025

linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % wc -l temp
     130 temp
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % head temp
HG01890.hap1    STK19_C4AL_CYP21A1P_TNXA_STK19B_C4BS_CYP21A2_TNXB
HG01890.hap2    STK19_C4AL_CYP21A1P_TNXA_STK19B_C4BS_CYP21A2_TNXB

cat temp | cut -f 1 | sed 's/.hap.*//' | uniq -d | while read ll
do
 c4a=`grep "${ll}.hap" temp | cut -f 2 | grep -oi C4A | wc -l | awk '{print $1}'`
 c4b=`grep "${ll}.hap" temp | cut -f 2 | grep -oi C4B | wc -l | awk '{print $1}'`
 cyp1=`grep "${ll}.hap" temp | cut -f 2 | grep -oi CYP21A1 | wc -l | awk '{print $1}'`
 cyp2=`grep "${ll}.hap" temp | cut -f 2 | grep -oi CYP21A2 | wc -l | awk '{print $1}'`
 echo "${ll}${tab}${c4a}${tab}${c4b}${tab}${cyp1}${tab}$cyp2"

done > out

> t1 <- read.delim("out", header=F)
 dim(t1)
#  [1] 65  5
 colnames(t1) <- c("id", "c4a", "c4b", "cyp1", "cyp2")
 t2 <- t1[, c(2:5)]
 cor(t2)
 t1$c4.tot <- t1$c4a + t1$c4b
 t1$cyp.tot <- t1$cyp1 + t1$cyp2
 head(t1)
 cor.test(t1$c4.tot, t1$cyp.tot)
#  t = 376647565, df = 63, p-value < 2.2e-16
#  cor
#    1

##############################################
"temp1.c4a.R.sort"
## signed log10(pVal)
> t2 <- data.frame(t1$X, t1$c4a.g6.c4a.cn.pVal, t1$c4b.g6.c4b.cn.pVal, t1$c4a.g6.c4a.cn.coeff, t1$c4b.g6.c4b.cn.coeff)

 t2$fdr.c4a.cn <- p.adjust(t2$t1.c4a.g6.c4a.cn.pVal, method="fdr")
 t2$fdr.c4b.cn <- p.adjust(t2$t1.c4b.g6.c4b.cn.pVal, method="fdr")
 head(t2)
 t2[ t2$t1.c4a.g6.c4a.cn.coeff < 0,]
#  <0 rows>
 t2[ t2$t1.c4b.g6.c4b.cn.coeff < 0,]
#                            t1.X t1.c4a.g6.c4a.cn.pVal t1.c4b.g6.c4b.cn.pVal t1.c4a.g6.c4a.cn.coeff t1.c4b.g6.c4b.cn.coeff fdr.c4a.cn fdr.c4b.cn
#  1 Cells - Cultured fibroblasts             0.1621013             0.1256329             0.09299814             -0.1085284  0.1621013  0.1454697
 t2$signed.log10.fdr.c4a.cn <- -log10(t2$fdr.c4a.cn)
 t2$signed.log10.fdr.c4b.cn <- -log10(t2$fdr.c4b.cn)
 t2[ rownames(t2) %in% rownames(t2[ t2$t1.c4b.g6.c4b.cn.coeff < 0,]),]$signed.log10.fdr.c4b.cn <- -t2[ rownames(t2) %in% rownames(t2[ t2$t1.c4b.g6.c4b.cn.coeff < 0,]),]$signed.log10.fdr.c4b.cn

 cor.test(t2$signed.log10.fdr.c4a.cn, t2$signed.log10.fdr.c4b.cn)
#  t = 7.3747, df = 42, p-value = 4.253e-09
#        cor
#  0.7511659

 colnames(t2)
 t3 <- t2[ , c(9,8)]
 rownames(t3) <- t2$t1.X
 t4 <- t3[ order(t3$signed.log10.fdr.c4a.cn),]
 t5 <- as.data.frame(t(t4))
 par( mar=c(6,2,2,12))
 barplot(as.matrix(t5), horiz=T, beside=T, yaxt="n", col=c("blue", "orange"), xlab="signed log10(FDR) wrt CN")#, xlim= c(-0.15, 0.45))
 axis(side=4, at = seq(2, 132, by=3), labels=colnames(t5), las =1, cex.axis = 0.6)
 abline(v = seq(-100, 100, 10), lty = 5, lwd = 0.5, col = "gray")
 abline(h = seq(2, 132, by=3), lty = 5, lwd = 0.5, col = "gray")
 legend(20, 2+3*30, c( "C4A", "C4B"), fill=c( "orange", "blue"), cex = 0.6, inset = 0.05)

###
 dim(t2)
 t3 <- t2[ t2$fdr.c4b.cn < 0.01 & t2$fdr.c4a.cn < 0.01,]
 dim(t3)
#  [1] 26  9
 colnames(t3)
 t4 <- t3[ , c(5, 4)]
 rownames(t4) <- t3$t1.X
 head(t4)
 t5 <- t4[ order(t4$t1.c4a.g6.c4a.cn.coeff),]
 cor.test(t5$t1.c4b.g6.c4b.cn.coeff, t5$t1.c4a.g6.c4a.cn.coeff)
#  t = 4.422, df = 24, p-value = 0.0001806
#        cor
#  0.6700448
 t6 <- as.data.frame(t(t5))
 par( mar=c(6,2,2,12))
 barplot(as.matrix(t6), horiz=T, beside=T, yaxt="n", col=c("blue", "orange"), xlab="expression~CN coeff", xlim= c(0, 1.2))
 axis(side=4, at = seq(2, 78, by=3), labels=colnames(t6), las =1, cex.axis = 0.6)
 abline(v = seq(-100, 100, 0.2), lty = 5, lwd = 0.5, col = "gray")
 abline(h = seq(2, 132, by=3), lty = 5, lwd = 0.5, col = "gray")
 legend(0.8, 2+3*5, c( "C4A", "C4B"), fill=c( "orange", "blue"), cex = 0.6, inset = 0.05)

######
"temp1.c4a.R.sort"
## c4a CN coeff, brain vs non-brain tissues
 t2 <- data.frame(t1$X, t1$c4a.g6.c4a.cn.pVal, t1$c4b.g6.c4b.cn.pVal, t1$c4a.g6.c4a.cn.coeff, t1$c4b.g6.c4b.cn.coeff)

 t2$fdr.c4a.cn <- p.adjust(t2$t1.c4a.g6.c4a.cn.pVal, method="fdr")
 t2$fdr.c4b.cn <- p.adjust(t2$t1.c4b.g6.c4b.cn.pVal, method="fdr")
 head(t2)
 t3 <- t2[ t2$fdr.c4a.cn < 0.01,]
 dim(t3)
#  [1] 43  7
 t4 <- t3[ grep("brain", t3$t1.X, ignore.case=T),]
 dim(t4)
#  [1] 13  7
 t4.ord <- t4[ order(t4$t1.c4a.g6.c4a.cn.coeff),]
 t5 <- t3[ !grepl("brain", t3$t1.X, ignore.case=T),]
 dim(t5)
#  [1] 30  7
 t5.ord <- t5[ order(t5$t1.c4a.g6.c4a.cn.coeff),]
 t4.ord$group <- "brain tissues"
 t5.ord$group <- "non-brain tissues"
 t6 <- rbind(t4.ord, t5.ord)
 colnames(t6)
 t7 <- data.frame(t6$t1.c4a.g6.c4a.cn.coeff)
 rownames(t7) <- t6$t1.X
 t8  <- as.data.frame(t(t7))
 par( mar=c(12,5,2,2))
 barplot(as.matrix(t8), horiz=F, beside=T, xaxt="n", col=c(rep( "blue", 13), rep("black",30 )), ylab="expr~C4A.CN coeff")#, xlim= c(-0.15, 0.45))
 axis(side=1, at = seq(1.5, 1.5+2*42, by=2), labels=colnames(t8), las =2, cex.axis = 0.6)
 abline(h = seq(-2, 132, by=0.2), lty = 5, lwd = 0.5, col = "gray")

#################################################
>  g6$resid <-  log2(g6$ENSG00000244731.10 + 1) - s3$coefficients[3,1] * g6$t.SMRIN  - s3$coefficients[4,1] * log10(g6$t.SMTSISCH + 1300) - s3$coefficients[5,1] * g6$SEX.x - s3$coefficients[6,1] * g6$age_value - s3$coefficients[7,1] * g6$body_mass_index - s3$coefficients[1,1]
 l1 <- lm(g6$resid ~ log2(g6$c4a.int))
 l2 <- summary(l1)
 l2$coefficients
 g7 <- g6[ g6$c4a.int == 1 | g6$c4a.int == 2,]
 dim(g7)
 l1 <- lm(g7$resid ~ log2(g7$c4a.int))
 l2 <- summary(l1)
 l2$coefficients
 g7 <- g6[ g6$c4a.int == 2 | g6$c4a.int == 3,]
 dim(g7)
 l1 <- lm(g7$resid ~ log2(g7$c4a.int))
 l2 <- summary(l1)
 l2$coefficients
 g7 <- g6[ g6$c4a.int == 3 | g6$c4a.int == 4,]
 dim(g7)
 l1 <- lm(g7$resid ~ log2(g7$c4a.int))
 l2 <- summary(l1)
 l2$coefficients
 g7 <- g6[ g6$c4a.int == 4 | g6$c4a.int == 5,]
 dim(g7)
 l1 <- lm(g7$resid ~ log2(g7$c4a.int))
 l2 <- summary(l1)
 l2$coefficients
#############################################################
> i=1
> g6$c4a.int <- round(g6$c4a * i, digits=0)
 g6$c4a.int.2 <- round(g6$c4a * 0.8, digits=0)
 g7 <- g6[ order(g6$c4a),]
 plot(1:dim(g7)[1], g7$c4a.int, pch=19, col="red", cex=0.5, xlab="donor")
 points(1:dim(g7)[1], g7$c4a.int.2 - 0.2, pch=0, col="black", cex=1)
 abline(v = seq(0, 10000, 50), lty = 5, lwd = 0.5, col = "gray")
 text(350, 3, "distrib. of C4A CN (Page lab)", pos=3, col="red")
 text(350, 1.8, "distrib. of C4A CN (x 0.8 scale.F)", pos=1, col="black")
  g8 <- g7[ g7$c4a.int == 2 & g7$c4a.int.2 == 2,]
  dim(g8)
#  [1] 139  29
 g8$group <- "2C4A / 2C4A"
  g9 <- g7[ g7$c4a.int == 3 & g7$c4a.int.2 == 2,]
  dim(g9)
#  [1] 186  29
 g9$group <- "3C4A / 2C4A"
 g10 <- rbind(g8, g9)
 dim(g10)
 lm3 <- lm(log2(g10$ENSG00000244731.10+1) ~ log2(g10$c4a.int) + g10$t.SMRIN + log10(g10$t.SMTSISCH + 1300) + g10$SEX.x + g10$age_value + g10$body_mass_index )
 s3 <- summary(lm3)
 s3
  sid <-  log2(g10$ENSG00000244731.10 + 1) - s3$coefficients[3,1] * g10$t.SMRIN  - s3$coefficients[4,1] * log10(g10$t.SMTSISCH + 1300) - s3$coefficients[5,1] * g10$SEX.x - s3$coefficients[6,1] * g10$age_value - s3$coefficients[7,1] * g10$body_mass_index - s3$coefficients[1,1] 
  lm1 <- lm(sid ~ log2(g10$c4a.int))
  summary(lm1)
  boxplot(sid ~ g10$group, xlab="C4A typing by two distrib", ylab="residual C4A expression (log2(cpm+1))")
 unique((g10$c4a.int))
#  [1] 2 3
 unique((g10$c4a.int.2))
#  [1] 2

######
  g8 <- g7[ g7$c4a.int == 3 & g7$c4a.int.2 == 3,]
  dim(g8)
#  [1] 139  29
 g8$group <- "3C4A / 3C4A"
  g9 <- g7[ g7$c4a.int == 3 & g7$c4a.int.2 == 2,]
  dim(g9)
#  [1] 186  29
 g9$group <- "3C4A / 2C4A"
 g10 <- rbind(g8, g9)
 dim(g10)
 lm3 <- lm(log2(g10$ENSG00000244731.10+1) ~ log2(g10$c4a.int.2) + g10$t.SMRIN + log10(g10$t.SMTSISCH + 1300) + g10$SEX.x + g10$age_value + g10$body_mass_index )
 s3 <- summary(lm3)
 s3
  sid <-  log2(g10$ENSG00000244731.10 + 1) - s3$coefficients[3,1] * g10$t.SMRIN  - s3$coefficients[4,1] * log10(g10$t.SMTSISCH + 1300) - s3$coefficients[5,1] * g10$SEX.x - s3$coefficients[6,1] * g10$age_value - s3$coefficients[7,1] * g10$body_mass_index - s3$coefficients[1,1]  
  lm1 <- lm(sid ~ log2(g10$c4a.int.2))
  summary(lm1)
  boxplot(sid ~ g10$group, xlab="C4A typing by two distrib", ylab="residual C4A expression (log2(cpm+1))")
 unique((g10$c4a.int))
#  [1] 2 3
 unique((g10$c4a.int.2))
#  [1] 2
############################################################
log2(g6$c4a - 0.2)           1.070459364 0.070747250 15.1307559 1.083739e-43
 sid <-  log2(g6$ENSG00000244731.10 + 1) - s3$coefficients[3,1] * g6$t.SMRIN  - s3$coefficients[4,1] * log10(g6$t.SMTSISCH + 1300) - s3$coefficients[5,1] * g6$SEX.x - s3$coefficients[6,1] * g6$age_value - s3$coefficients[7,1] * g6$body_mass_index - s3$coefficients[1,1]
......
> g8 <- g7[ g7$C4A.int >= 2 & g7$C4A.int <= 4,]
> dim(g8)
[1] 526   5
> unique(g8$C4A.int)
[1] 2 3 4

 g8$sub <- 999999
for(i in 1:dim(g8)[1]) {
 f1 <- g8[i,]
 f2 <- floor( (f1$C4A - f1$C4A.int) / 0.25)
 g8[i,]$sub = f2[1]

}
 unique(g8$sub)
 head(g8[ g8$sub == 0,])
 head(g8[ g8$sub == 2,])
 g8$C4A.int.4groups <- paste(g8$C4A.int, ".g", g8$sub + 3, sep="")

  boxplot(g8$resid ~ g8$C4A.int, ylab="residual C4A expression (log2(cpm+1))")
 boxplot(g8$resid ~ g8$C4A.int.4groups, ylab="residual C4A expression (log2(cpm+1))", col=c(rep("grey", 4), rep("red", 4)))
 abline(h = seq(-100,100,1/2), lty = 5, lwd = 0.5, col = "grey")

 g9 <- g7[ g7$C4A.int == 1,]
 dim(g9)
#  [1] 34  5
 g9$sub <- -2
 g9$C4A.int.4groups <- "1.g"
 g10 <- rbind(g8, g9)
 dim(g10)
#  [1] 560   7
 boxplot(g10$resid ~ g10$C4A.int.4groups, ylab="residual C4A expression (log2(cpm+1))", col=c("blue", rep("grey", 4), rep("red", 4), rep("grey", 4)))
  abline(h = seq(-100,100,1/2), lty = 5, lwd = 0.5, col = "grey")
 l2 <- lm(g10$resid ~ g10$C4A.int.4groups)
 summary(l2)
 l2.s <- summary(l2)
######average +/- error bar
  t1 <- as.data.frame( matrix(nrow=20, ncol=4))
  colnames(t1) <- c("CN", "c4a.mean", "c4a.sd", "c4a.N" )
j=1
 sub.g <- sort( unique(g10$C4A.int.4groups))
 sub.g
#   [1] "1.g"  "2.g1" "2.g2" "2.g3" "2.g4" "3.g1" "3.g2" "3.g3" "3.g4" "4.g1" "4.g2" "4.g3" "4.g4"
 length(sub.g)
#  [1] 13
for(i in 1:length(sub.g)) {
t2 <- g10[ g10$C4A.int.4groups == sub.g[i],]
  t1$CN[j] = sub.g[i]
  t1$c4a.mean[j] = mean(t2$resid)
  ###t1$c4a.sd[j] = sd(t2$resid)
  t1$c4a.sd[j] = sd(t2$resid) / sqrt(dim(t2)[1])
  t1$c4a.N[j] = dim(t2)[1]
 j=j+1

}

 t3 <- t1[ 1:13, ]$c4a.mean
 t4 <- data.frame(c4a.mean = t3)
 rownames(t4) <-  t1[ 1:13, ]$CN
  t5 <- as.data.frame(t(t4))
# par( mar=c(6,2,2,12))
 barplot(as.matrix(t5), horiz=T, beside=T, ylab="copy number sub-groups", xlab="residual C4A expression (log2(cpm+1))",  col=c("blue", rep("grey", 4), rep("red", 4), rep("grey", 4)) ,  yaxt = "n", xlim=c(0, 3.5))
 axis(side=2, at = seq(1.5, 1.5+2*12, by=2), labels=rownames(t4),  las =1, cex.axis = 0.8)
col1 <- c("blue", rep("black", 4), rep("red", 4), rep("black", 4))

for(i in 1:length(sub.g)) {
  t6 <- as.data.frame(matrix(,nrow=2, ncol=2))
# x-coord of two points
  t6$V1[1] <- t1[t1$CN == sub.g[i],]$c4a.mean[1]
  t6$V1[2] <- t1[t1$CN == sub.g[i],]$c4a.mean[1] + t1[t1$CN == sub.g[i],]$c4a.sd[1]
# y-coord of two points
  t6$V2 <- 1 + (i-1)*2  + 0.5
  lines(t6$V1, t6$V2, col=col1[i])
  if(i > 1)
  {
  text(3, t6$V2[1], paste("P=", format(l2.s$coefficients[i,4] , digits=2), sep=""), col=col1[i], pos=4, cex=0.8)
  }

#vert bar of error, x-coord of two points identical, equal to prev t6$V1
 t6$V1 <- t6$V1[2]
 a <- t6$V2[2]
 t6$V2[1] <- a - 0.5/2
 t6$V2[2] <- a + 0.5/2
 lines(t6$V1, t6$V2, col=col1[i])
}
 abline(v = seq(-100,100,1/2/2), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,1/2), lty = 5, lwd = 0.8, col = "gray")

> t15 <- paste("[", seq(1.5, 4.5, 0.25), ",",  seq(1.5+0.25, 4.5+0.25, 0.25), ")", sep="")
> data.frame(a=t15)


############################################################
> t1 <- read.delim("cyp21.multiVar.R")
 dim(t1)
#  [1] 44 32
 t2 <- data.frame(t1$X, t1$cyp21a1p.g6.cyp21a1p.cn.pVal, t1$cyp21a2.g6.cyp21a2.cn.pVal, t1$cyp21a1p.g6.cyp21a1p.cn.coeff, t1$cyp21a2.g6.cyp21a2.cn.coeff)
 t2$fdr.cyp21a1p.cn <- p.adjust(t2$t1.cyp21a1p.g6.cyp21a1p.cn.pVal, method="fdr")
 t2$fdr.cyp21a2.cn <-  p.adjust(t2$t1.cyp21a2.g6.cyp21a2.cn.pVal, method="fdr")
 head(t2)
 t2[ t2$t1.cyp21a1p.g6.cyp21a1p.cn.coeff < 0,]
#  <0 rows> (or 0-length row.names)
 dim(t2[ t2$t1.cyp21a2.g6.cyp21a2.cn.coeff < 0,])
#  [1] 15  7
 t2$signed.log10.fdr.cyp21a1p.cn <- -log10(t2$fdr.cyp21a1p.cn)
 t2$signed.log10.fdr.cyp21a2.cn <- -log10(t2$fdr.cyp21a2.cn)
 t2[ rownames(t2) %in% rownames(t2[ t2$t1.cyp21a2.g6.cyp21a2.cn.coeff < 0,]),]$signed.log10.fdr.cyp21a2.cn <- -t2[ rownames(t2) %in% rownames(t2[ t2$t1.cyp21a2.g6.cyp21a2.cn.coeff < 0,]),]$signed.log10.fdr.cyp21a2.cn

 cor.test(t2$signed.log10.fdr.cyp21a1p.cn, t2$signed.log10.fdr.cyp21a2.cn)
#  t = 2.727, df = 42, p-value = 0.009285
#        cor
#  0.3878526

 colnames(t2)
 t3 <- t2[ , c(9,8)]
 rownames(t3) <- t2$t1.X
 t4 <- t3[ order(t3$signed.log10.fdr.cyp21a1p.cn),]
 t5 <- as.data.frame(t(t4))
 par( mar=c(6,2,2,12))
 barplot(as.matrix(t5), horiz=T, beside=T, yaxt="n", col=c("blue", "orange"), xlab="expr ~ CN, signed log10(FDR)", xlim= c(-5, 20))
 axis(side=4, at = seq(2, 132, by=3), labels=colnames(t5), las =1, cex.axis = 0.6)
 abline(v = seq(-100, 100, 5), lty = 5, lwd = 0.5, col = "gray")
 abline(v = 0)
 abline(h = seq(2, 132, by=6), lty = 5, lwd = 0.5, col = "gray")
 legend(10, 2+3*20, c( "CYP21A1P", "CYP21A2"), fill=c( "orange", "blue"), cex = 0.6, inset = 0.05)
 abline(v=2, col="red")

 t2.1 <- t2[ order(t2$signed.log10.fdr.cyp21a1p.cn),]
 t3 <- t2.1[, c(5,4)]
 rownames(t3) <- t2.1$t1.X
 t5 <- as.data.frame(t(t3))
 par( mar=c(6,2,2,12))
 barplot(as.matrix(t5), horiz=T, beside=T, yaxt="n", col=c("blue", "orange"), xlab="expr ~ CN coeff", xlim= c(-0.4, 0.8))
 axis(side=4, at = seq(2, 132, by=3), labels=colnames(t5), las =1, cex.axis = 0.6)
 abline(v = seq(-100, 100, 0.2), lty = 5, lwd = 0.5, col = "gray")
 abline(v = 0)
 abline(h = seq(2, 132, by=6), lty = 5, lwd = 0.5, col = "gray")
 legend(0.4, 2+3*30, c( "CYP21A1P", "CYP21A2"), fill=c( "orange", "blue"), cex = 0.6, inset = 0.05)


#########################################################
temp-c4a-c4b-cyp21pa-cnv-expression
c4a-c4b-cyp21pa-cnv-expression
 t12.f <- t12[ t12$SEX == 2,]
 dim(t12.f)
#  [1] 281  19
 t12.m <- t12[ t12$SEX == 1,]
 dim(t12.m)
#  [1] 557  19
 t13.m <- hist(t12.m$c4.tot.no.intron9.int, breaks=seq(1.5, 11.5, 1))
 t13.f <- hist(t12.f$c4.tot.no.intron9.int, breaks=seq(1.5, 11.5, 1))
 sum(t13.f$density)
#  [1] 1
 sum(t13.m$density)
#  [1] 1
 t14 <- data.frame(F.density = t13.f$density, M.density= t13.m$density)
 t15 <- as.data.frame(t(t14))
> par( mar=c(6,6,2,2))
 barplot(as.matrix(t15), horiz=F, beside=T, xaxt="n", col=c("red", "blue"), xlab="total C4 CN (C4A+C4B)", ylab="freq", ylim=c(0, 0.35))
 axis(side=1, at = seq(2, 2+9*3, by=3), labels=t13.f$mids, las =1, cex.axis = 1)
 abline(h = seq(-100, 100, 0.01), lty = 5, lwd = 0.5, col = "grey")
 abline(h = seq(-100, 100, 0.05), lty = 5, lwd = 1, col = "black")
 legend(2+6*3, 0.25, c( "F (n=281)", "M (n=557)"), fill=c( "red", "blue"), cex = 1, inset = 0.05)

> a=5
 b=557 - a
 c=4
 d=281 - c
 fis <- matrix(c(c,d, a,b), nrow=2, ncol=2, byrow=T )
 fis

######
  contingency_table <- table(t12$SEX, t12$c4.tot.no.intron9.int)
  contingency_table
   
#        2   3   4   5   6   7   8   9  11
#    1   5  49 167 132 136  48  14   6   0
#    2   4  30  79  74  62  21   7   3   1

# column CN
# row 1=Male, 2=Female

 chi_square_result <- chisq.test(contingency_table)
 chi_square_result

	Pearson's Chi-squared test

data:  contingency_table
X-squared = 4.6476, df = 8, p-value = 0.7945

>     chisq.test(contingency_table, simulate.p.value = TRUE, B = 10000)

	Pearson's Chi-squared test with simulated p-value (based on 10000 replicates)

data:  contingency_table
X-squared = 4.6476, df = NA, p-value = 0.8198

> fisher.test(contingency_table, simulate.p.value=T, B=10000)

	Fisher's Exact Test for Count Data with simulated p-value (based on 10000 replicates)

data:  contingency_table
p-value = 0.805
alternative hypothesis: two.sided

#########
> # Create a data frame (example data)
    data <- data.frame(
      Gender = c(rep("Male", 30), rep("Female", 35), rep("Male", 20), rep("Female", 15)),
      Genre = c(rep("Action", 20), rep("Action", 10), rep("Comedy", 10), rep("Comedy", 25), rep("Drama", 20), rep("Drama", 15))
    )

    # Create a contingency table
    contingency_table <- table(data$Gender, data$Genre)
    print(contingency_table)


         Action Comedy Drama
  Female      0     35    15
  Male       30      0    20

 chi_square_result <- chisq.test(contingency_table)
 print(chi_square_result)

	Pearson's Chi-squared test

data:  contingency_table
X-squared = 65.714, df = 2, p-value = 5.374e-15

df (Degrees of Freedom): This is calculated as (number of rows - 1) * (number of columns - 1)
suggest a significant association between gender and preferred movie genre.

######
> t13.m <- hist(t12.m$c4a.int, breaks=seq(-0.5, 6.5, 1))
> t13.f <- hist(t12.f$c4a.int, breaks=seq(-0.5, 6.5, 1))
  t14 <- data.frame(F.density = t13.f$density, M.density= t13.m$density)
 t15 <- as.data.frame(t(t14))
 par( mar=c(6,6,2,2))
 barplot(as.matrix(t15), horiz=F, beside=T, xaxt="n", col=c("red", "blue"), xlab="C4A CN", ylab="freq", ylim=c(0, 0.5))
 axis(side=1, at = seq(2, 2+6*3, by=3), labels=t13.f$mids, las =1, cex.axis = 1)
 abline(h = seq(-100, 100, 0.01), lty = 5, lwd = 0.5, col = "grey")
 abline(h = seq(-100, 100, 0.05), lty = 5, lwd = 1, col = "black")
 legend(2+5*3, 0.3, c( "F (n=281)", "M (n=557)"), fill=c( "red", "blue"), cex = 0.8, inset = 0.05)

 f1 <- dim(t12[ t12$c4a.int <= 1 & t12$SEX == 2,])[1]
 f2 <- dim(t12[ t12$c4a.int > 1 & t12$SEX == 2,])[1]
 m1 <- dim(t12[ t12$c4a.int <= 1 & t12$SEX == 1,])[1]
 m2 <- dim(t12[ t12$c4a.int > 1 & t12$SEX == 1,])[1]
 f1 + f2
#  [1] 281
 m1 + m2
#  [1] 557
 (matrix(c(f1,f2,m1,m2), nrow=2, ncol=2, byrow=T))
 fisher.test(matrix(c(f1,f2,m1,m2), nrow=2, ncol=2, byrow=T))
######
t12.f <- t12[ t12$SEX == 2,] 
 dim(t12.f)
#  [1] 281  19  
 t12.m <- t12[ t12$SEX == 1,] 
 dim(t12.m)
#  [1] 557  19  
c4.tot.no.intron9.int
 t13.m <- hist(t12.m$c4.tot.no.intron9.int, breaks=seq(1.5, 13.5, 1))
 t13.f <- hist(t12.f$c4.tot.no.intron9.int, breaks=seq(1.5, 13.5, 1))

  t14 <- data.frame(F.density = t13.f$density, M.density= t13.m$density)

t14$or <- -12345
t14$p <- -9
 j=1 

for(cn in t13.f$mids) {
 f1 <- dim(t12[ t12$c4.tot.no.intron9.int == cn & t12$SEX == 2,])[1]
 f2 <- dim(t12[ t12$c4.tot.no.intron9.int != cn & t12$SEX == 2,])[1]
 m1 <- dim(t12[ t12$c4.tot.no.intron9.int == cn & t12$SEX == 1,])[1]
 m2 <- dim(t12[ t12$c4.tot.no.intron9.int != cn & t12$SEX == 1,])[1]
 f1 + f2
#  [1] 281 
 m1 + m2
#  [1] 557 
 (matrix(c(f1,f2,m1,m2), nrow=2, ncol=2, byrow=T))
 fish <-  fisher.test(matrix(c(f1,f2,m1,m2), nrow=2, ncol=2, byrow=T))
 t14$or[j] <- fish$estimate
 t14$p[j] <- fish$p.value
 j <- j+1 
 }

t14$CYP21A1P.CN <- t13.f$mids
t14

######
t12.f <- t12[ t12$SEX == 2,]
 dim(t12.f)
#  [1] 281  19
 t12.m <- t12[ t12$SEX == 1,]
 dim(t12.m)
#  [1] 557  19  
 da.f <- hist(t12.f$c4a.int, breaks=seq(-0.5, 6.5,1))
 db.f <- hist(t12.f$c4b.int, breaks=seq(-0.5, 6.5,1))
 da.m <- hist(t12.m$c4a.int, breaks=seq(-0.5, 6.5,1))
 db.m <- hist(t12.m$c4b.int, breaks=seq(-0.5, 6.5,1))
 res <- as.data.frame(matrix(nrow= length(da.f$mids) * length(db.f$mids), ncol=7))
 colnames(res) <- c("observed", "or", "p", "C4A.cn", "C4B.cn", "F", "M")

k = 0
 for(i in 1:length(da.f$mids)) {
 for(j in 1:length(db.f$mids)) {
 k = k+1
 res$C4A.cn[k] <- da.f$mids[i]
 res$C4B.cn[k] <- db.f$mids[j]
 f1 <- dim(t12.f[ t12.f$c4a.int == res$C4A.cn[k] & t12.f$c4b.int == res$C4B.cn[k],])[1]
 f2 <- dim(t12.f)[1] - f1
 m1 <- dim(t12.m[ t12.m$c4a.int == res$C4A.cn[k] & t12.m$c4b.int == res$C4B.cn[k],])[1]
 m2 <- dim(t12.m)[1] - m1
 (matrix(c(f1,f2,m1,m2), nrow=2, ncol=2, byrow=T))
 fish <-  fisher.test(matrix(c(f1,f2,m1,m2), nrow=2, ncol=2, byrow=T))
 res$or[k] <- fish$estimate
 res$p[k]  <- fish$p.value
 res$F[k]  <- f1
 res$M[k]  <- m1
}
}
 r2 <- res[ res$F > 0 | res$M > 0,]
 r2$A <- r2$F + r2$M
> gplot(r2, aes(x=C4A.cn, y=C4B.cn, size=A, label=A)) + geom_point(col="black") + geom_text_repel(show.legend=F, data=r2 , size=2.2, max.overlaps=100, min.segment.length = 0.1, col="red") + labs(x="C4A CN", y="C4B CN") + scale_x_continuous(breaks=seq(0, 6, 1)) + scale_y_continuous(breaks=seq(0, 6, 1))

######
t12.f <- t12[ t12$SEX == 2,]
 dim(t12.f)
#  [1] 281  19
 t12.m <- t12[ t12$SEX == 1,]
 dim(t12.m)
#  [1] 557  19 
c4.tot.no.intron9.int
 t13.m <- hist(t12.m$c4.tot.no.intron9.int, breaks=c(seq(1.5,5.5, 1), 20))
 t13.f <- hist(t12.f$c4.tot.no.intron9.int, breaks=c(seq(1.5,5.5, 1), 20))

 sum(t13.f$density)
#  0.6885507
 sum(t13.m$density)
#  0.6590107

 t12$c4.tot.int <- t12$c4.tot.no.intron9.int
 t12[ t12$c4.tot.no.intron9.int > 5,]$c4.tot.int <- "gt5"

  contingency_table <- table(t12$SEX, t12$c4.tot.int)
  contingency_table
chisq.test(contingency_table)
chisq.test(contingency_table, simulate.p.value = TRUE, B = 10000)

#############################################################
c4a primer & probe seq
CCTTTGTGTTGAAGGTCCTGAGTT
TCCTGTCTAACACTGGACAGGGGT
CCAGGAGCAGGTAGGAGGCTCGC

TGCAGGAGACATCTAACTGGCTTCT
CATGCTCCTATGTATCACTGGAGAGA
AGCAGGCTGACGGC

RPP30 primer
GATTTGGACCTGCGAGCG
GCGGCTGTCTCCACAAGT
CTGACCTGAAGGCTCT

#############################################
> boxplot(t11$c4.tot.no.intron9 - 0.2 ~ t11$c4.c4a.and.c4b, xlab="C4A CN + C4B CN", ylab="total C4 CN", col=c("red", "grey", "red", rep("grey", 3), "red", rep("grey",10)))
> abline(h = seq(0,100, by=1), lty = 5, lwd = 0.5, col = "gray")
> abline(h = seq(0,100, by=2), lty = 5, lwd = 0.5, col = "blue")

> boxplot( t11$cyp21.tot ~ t11$cyp21.add.two, xlab="CYP21A1P CN + CYP21A2 CN", ylab="total CYP21 CN", col=c("red", "grey", "red", rep("grey", 3), "red", rep("grey",10)))
> abline(h = seq(0,100, by=1), lty = 5, lwd = 0.5, col = "gray")
> abline(h = seq(0,100, by=2), lty = 5, lwd = 0.5, col = "blue")

y <- t11$c4.tot.no.intron9 - 0.2 
x <- t11$c4a + t11$c4b
Call:
lm(formula = y ~ x)
Coefficients:
            Estimate Std. Error t value Pr(>|t|)
(Intercept) 0.003231   0.071148   0.045    0.964
x           0.999999   0.013816  72.378   <2e-16 ***
Residual standard error: 0.4841 on 836 degrees of freedom
Multiple R-squared:  0.8624,    Adjusted R-squared:  0.8622 

t11$cyp21.tot ~ t11$CYP21A1P + t11$CYP21A2
y <- t11$cyp21.tot
x <- t11$CYP21A1P + t11$CYP21A2
Call:
lm(formula = y ~ x)
Coefficients:
            Estimate Std. Error t value Pr(>|t|)
(Intercept)  0.19209    0.03066   6.265 5.95e-10 ***
x            1.00000    0.00619 161.554  < 2e-16 ***
Residual standard error: 0.2212 on 836 degrees of freedom
Multiple R-squared:  0.969,     Adjusted R-squared:  0.9689
 plot(y ~ x, xlab="CYP21A1P CN + CYP21A2 CN", ylab="total CYP21 CN")
 abline(h = seq(0,100, by=2), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(0,100, by=2), lty = 5, lwd = 0.5, col = "gray")
 abline(lm(y ~ x))

######
> y <- t11$c4.tot.no.intron9 - 0.2
> dim(t11[ t11$cyp21.tot.int == t11$cyp21a1p.int + t11$cyp21a2.int,])
[1] 543  15
> #  [1] 543  13
x <- t11$cyp21.tot.int

Call:
lm(formula = y ~ x)

Coefficients:
            Estimate Std. Error t value Pr(>|t|)
(Intercept)  0.30696    0.05740   5.347 1.15e-07 ***
x            0.94573    0.01117  84.676  < 2e-16 ***

Residual standard error: 0.4217 on 836 degrees of freedom
Multiple R-squared:  0.8956,    Adjusted R-squared:  0.8955
> boxplot(y ~ x, xlab="total CYP21 CN", ylab="total C4 CN", col=c("red", "grey", "red", rep("grey", 3), "red", rep("grey",10)))
 abline(h = seq(0,100, by=1/2), lty = 5, lwd = 0.25, col = "gray")
  abline(h = seq(0,100, by=1), lty = 5, lwd = 0.5, col = "blue")

############
# c4a-c4b-cyp21pa-cnv-expression
 sid <-  log2(g6$ENSG00000224389.9 + 1) - s4$coefficients[3,1] * g6$t.SMRIN  - s4$coefficients[4,1] * log10(g6$t.SMTSISCH + 1300) - s4$coefficients[5,1] * g6$SEX.x - s4$coefficients[6,1] * g6$age_value - s4$coefficients[7,1] * g6$body_mass_index - s4$coefficients[1,1]  
 lm1 <- lm(sid ~ log2(g6$c4b - 0.2))
 summary(lm1)
g7 <- data.frame(resid = sid, C4B = g6$c4b , expr = g6$ENSG00000224389.9)

 g7$C4B.int <- round(g7$C4B, digits=0)
 g7$C4B.minus0.2.int <- round(g7$C4B - 0.2, digits=0)
 boxplot(g7$resid ~ g7$C4B.int, ylab="residual C4B expression (log2(cpm+1))")
 abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")

######average +/- error bar
# c4a-c4b-cyp21pa-cnv-expression

 sid <-  log2(g6$ENSG00000244731.10 + 1) - s3$coefficients[3,1] * g6$t.SMRIN  - s3$coefficients[4,1] * log10(g6$t.SMTSISCH + 1300) - s3$coefficients[5,1] * g6$SEX.x - s3$coefficients[6,1] * g6$age_value - s3$coefficients[7,1] * g6$body_mass_index - s3$coefficients[1,1] 
 lm1 <- lm(sid ~ log2(g6$c4a - 0.2))
 summary(lm1)
 g7 <- data.frame(resid = sid, C4A = g6$c4a , expr = g6$ENSG00000244731.10)

 g7$C4A.int <- round(g7$C4A, digits=0)
 g8 <- g7

 t1 <- as.data.frame( matrix(nrow=5, ncol=4))
 colnames(t1) <- c("CN", "c4a.mean", "c4a.sd", "c4a.N" )

j=1
 for(i in 1:5) {
t2 <- g7[ g7$C4A.int == i,]
 t1$CN[j] = i
 t1$c4a.mean[j] = mean(log2(t2$expr + 1))
 t1$c4a.sd[j] = sd(log2(t2$expr + 1))
 t1$c4a.N[j] = dim(t2)[1]
j=j+1
}

#...C4B....
sid <-  log2(g6$ENSG00000224389.9 + 1) - s4$coefficients[3,1] * g6$t.SMRIN  - s4$coefficients[4,1] * log10(g6$t.SMTSISCH + 1300) - s4$coefficients[5,1] * g6$SEX.x - s4$coefficients[6,1] * g6$age_value - s4$coefficients[7,1] * g6$body_mass_index - s4$coefficients[1,1]  
 lm1 <- lm(sid ~ log2(g6$c4b - 0.2))
 summary(lm1)
g7 <- data.frame(resid = sid, C4B = g6$c4b , expr = g6$ENSG00000224389.9)

 g7$C4B.int <- round(g7$C4B, digits=0)

t3 <- as.data.frame( matrix(nrow=5, ncol=4))
 colnames(t3) <- c("CN", "c4b.mean", "c4b.sd", "c4b.N" )

j=1
 for(i in 1:5) {
t2 <- g7[ g7$C4B.int == i,]
 t3$CN[j] = i
 t3$c4b.mean[j] = mean(log2(t2$expr + 1))
 t3$c4b.sd[j] = sd(log2(t2$expr + 1))
 t3$c4b.N[j] = dim(t2)[1]
j=j+1
}

 identical(t3$CN, t1$CN)
 res <- cbind(t1, t3)
res$p = 10
for(i in 1:5) {
 a <- log2(g7[ g7$C4B.int == i,]$expr + 1)
 b <- log2(g8[ g8$C4A.int == i,]$expr + 1)
c <- t.test(a,b)
res[ res$CN == i,]$p <- c$p.value

}

 r2 <- res[, c(2,6)]
 rownames(r2) <- res$CN
  t3 <- as.data.frame(t(r2))
# par( mar=c(6,2,2,12))
 barplot(as.matrix(t3), horiz=F, beside=T, xlab="copy number", ylab="gene expression (log2(cpm+1))", col=c("red", "blue"), ylim=c(0,10))

 for(i in 1:5) {
 t4 <- as.data.frame(matrix(,nrow=2, ncol=2))
# x-coord of two points
 t4$V1 <- 1 + (i-1) *3 + 0.5
# y-coord of two points
 t4$V2[1] <- res[ res$CN == i,]$c4a.mean
 t4$V2[2] <- res[ res$CN == i,]$c4a.mean + res[ res$CN == i,]$c4a.sd
lines(t4$V1, t4$V2, col="red")
#horiz bar of error, y-coord of two points
 t4$V2 <- t4$V2[2]
 a <- t4$V1[1]
 t4$V1[1] <- a - 0.5/2
 t4$V1[2] <- a + 0.5/2
lines(t4$V1, t4$V2, col="red")

####c4b....
 t4 <- as.data.frame(matrix(,nrow=2, ncol=2))
# x-coord of two points
 t4$V1 <- 1 + (i-1) *3 + 1 + 0.5
 # y-coord of two points
 t4$V2[1] <- res[ res$CN == i,]$c4b.mean
 t4$V2[2] <- res[ res$CN == i,]$c4b.mean + res[ res$CN == i,]$c4b.sd
lines(t4$V1, t4$V2, col="blue")
 #horiz bar of error, y-coord of two points
 t4$V2 <- t4$V2[2]
 a <- t4$V1[1]
 t4$V1[1] <- a - 0.5/2
 t4$V1[2] <- a + 0.5/2
lines(t4$V1, t4$V2, col="blue")
}
  abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
 abline(h=0)
 legend(4, 10, c( "C4A", "C4B"), fill=c( "red", "blue"), cex = 1, inset = 0.05)

####################################
######
> sink("median-c4a-cyp21a2-expression.R.out")

> sink("temp2")
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp2 | awk 'BEGIN {FS = "\t"; OFS = "\t"} NF == 5' > temp3
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp2 | grep 'data.frame' | awk '{print $2}' > temp4
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % wc -l temp3 temp4
      54 temp3
      54 temp4
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % paste temp3 temp4 > median-c4a-cyp21a2-expression.R.out.oct3.2025
### add header
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % vi median-c4a-cyp21a2-expression.R.out.oct3.2025

> t1 <- read.delim("median-c4a-cyp21a2-expression.R.out.oct3.2025")
 summary(t1)
### $Nsamp: 4   9   9  10  21  85 139 142 152 156 159 162 174 176 180 187 197
 t2 <- t1[ t1$Nsamp > 21,]
 dim(t2)
#  [1] 49  6
 t3 <- t2[, c(2,4,5)]
 rownames(t3) <- t2[, 1]
 head(t3)
#                                     C4A        C4B      CYP21A2
#  Adipose - Subcutaneous        3.215713   2.201968    0.4085480
#  Adipose - Visceral (Omentum) 17.235059  16.314238    1.2656753
#  Adrenal Gland                82.803835 147.885320 1578.0085731
   t4 <- as.data.frame(t(t3))
 par( mar=c(12,6,2,2))
> barplot(as.matrix(log2(t4+1)), horiz=F, beside=T, ylab="log2(cpm+1)", col=c("green", "blue", "red"), xaxt="n")
 axis(side=1, at = seq(2, 2+4*48, by=4), labels=rownames(t3), las =2, cex.axis = 0.7)
 abline(h = seq(0, 100, 1), lty = 5, lwd = 0.5, col = "gray")
 legend(2+4*8, 10, c( "C4A", "C4B", "CYP21A2"), fill=c("green", "blue", "red"), cex = 0.8, inset = 0.05)

#########
# c4a-c4b-cyp21pa-cnv-expression
> g6$c4a.resid.expr <- log2(g6$ENSG00000244731.10 + 1) - s3$coefficients[2,1] * log2(g6$c4a - 0.2)
 g6$c4b.resid.expr <- log2(g6$ENSG00000224389.9 + 1)  - s4$coefficients[2,1] * log2(g6$c4b - 0.2)
 cor.test(g6$c4a.resid.expr, g6$c4b.resid.expr)
# t = 54.613, df = 572, p-value < 2.2e-16
#       cor
#  0.916014
cor.test(log2(g6$ENSG00000244731.10 + 1), log2(g6$ENSG00000224389.9 + 1))
#        cor
#  0.7801029
> plot(log2(g6$ENSG00000244731.10 + 1), log2(g6$ENSG00000224389.9 + 1), xlab="C4A expression (log2(CPM+1))", ylab="C4B expression (log2(CPM+1))", main="Thyroid (N= 574)")
 abline(lm(log2(g6$ENSG00000224389.9 + 1) ~ log2(g6$ENSG00000244731.10 + 1)), col="blue")
  abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")

plot(g6$c4a.resid.expr, g6$c4b.resid.expr, xlab="CN-adjusted C4A expression (log2(CPM+1))", ylab="CN-adjusted C4B expression (log2(CPM+1))", main="Thyroid (N= 574)")
 abline(lm(g6$c4b.resid.expr ~ g6$c4a.resid.expr), col="blue")
  abline(h = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
 abline(v = seq(-100,100,1), lty = 5, lwd = 0.5, col = "gray")
> g6[ g6$c4a - 0.2 < 0.5, c(2,6,4, 7, 5, 13,14,15,16)]
> g6[ g6$c4a - 0.2 < 0.5, c(2,27,28)]

##########
linyong@c3b1 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra$ vdb-config --prefetch-to-cwd

linyong@c3b1 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra$ prefetch --ngc /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/prj_6177_D12900.ngc  SAMN04597568

2025-10-06T21:50:26 prefetch.3.0.7: Current preference is set to retrieve SRA Normalized Format files with full base quality scores.
2025-10-06T21:50:26 prefetch.3.0.7 warn: Maximum file size download limit is 20GB
2025-10-06T21:50:26 prefetch.3.0.7: 1) 'SRR3478691' (21GB) is larger than maximum allowed: skipped
2025-10-06T21:50:26 prefetch.3.0.7: 1) Downloading 'SRR3478691.vdbcache'...
2025-10-06T21:50:26 prefetch.3.0.7:  Downloading via HTTPS...
2025-10-06T21:50:56 prefetch.3.0.7:  HTTPS download succeed
2025-10-06T21:51:01 prefetch.3.0.7:  'SRR3478691.vdbcache' is valid
2025-10-06T21:51:01 prefetch.3.0.7: 1) 'SRR3478691.vdbcache' was downloaded successfully

Download of some files was skipped because they are too large
You can change size download limit by setting
--min-size and --max-size command line arguments
linyong@it-bigboy /lab/solexa_page/linyong/gtex-dna/dir-dna-sra$ fasterq-dump --ngc /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/prj_6177_D12900.ngc SAMN04597568
###cram file type for the raw data
-rw-r--r-- 1 linyong systemd-timesync 168G Oct  7 14:37 SAMN04597568_1.fastq
-rw-r--r-- 1 linyong systemd-timesync 108G Oct  7 14:31 SAMN04597568_2.fastq

linyong@fry /lab/solexa_page/linyong/gtex-dna/dir-dna-sra$ fasterq-dump SRR5642491
spots read      : 1,521,848
reads read      : 1,521,848
reads written   : 1,521,848

SRR5642491:
total 92M
-rw-r--r-- 1 linyong systemd-timesync 92M Oct  6 17:47 SRR5642491.sra

-rw-r--r-- 1 linyong systemd-timesync 505M Oct  7 12:18 SRR5642491.fastq

#########
######
> t1 <- read.csv("/Users/linyongmao/Downloads/SraRunTable.24455samp.GTEx.csv")
> dim(t1)
[1] 24455    82
> write.table(t1, "SraRunTable.24455samp.GTEx.tab.txt", quote=F, sep="\t")
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % vi SraRunTable.24455samp.GTEx.tab.txt 
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat SraRunTable.24455samp.GTEx.tab.txt| cut -f 1 | sort | uniq -d | wc -l
       0
Run header
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat SraRunTable.24455samp.GTEx.tab.txt| cut -f 8 | head                  
BioSample
SAMN04596666
SAMN02787786
SAMN02793034
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat SraRunTable.24455samp.GTEx.tab.txt| cut -f 8 | sort | uniq  | wc -l
   14117
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat SraRunTable.24455samp.GTEx.tab.txt| cut -f 19 | sort | uniq  | head
Experiment
SRX1142720
SRX1142756
SRX1142759
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat SraRunTable.24455samp.GTEx.tab.txt| cut -f 19 | sort | uniq  | wc -l
   24456
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat SraRunTable.24455samp.GTEx.tab.txt| cut -f 3 | sort | uniq -c      
   1 Assay.Type
22544 RNA-Seq
1302 WGS
 609 WXS

> t1 <- read.delim("gtex-dna-c4a-c4b.gene.depth.samtools.q20.txt", header=T)
  head(t1)
 t2 <- read.delim("SraRunTable.24455samp.GTEx.tab.txt")
 dim(t2)
#  [1] 24455    82
 t3 <- t2[ t2$biospecimen_repository_sample_id %in% t1$donor,]
 dim(t3)
#  [1] 1202   82
 head(t3, n=10)
 unique(t3$Assay.Type)
#  [1] "WGS"

 length(unique( t3$biospecimen_repository_sample_id))
#  [1] 602  donors 

 t4 <- t2[ t2$Assay.Type == "WGS",]
 dim(t4)
#  [1] 1302   82
 unique(t4$AssemblyName)
#  [1] "GCF_000001405.25" "GRCh38"           "GCA_000001405.13"
 write.table(t4[ t4$AssemblyName == "GCF_000001405.25", ]$biospecimen_repository_sample_id, "temp1", quote=F, sep="\t")
 write.table(t4[ t4$AssemblyName == "GRCh38", ]$biospecimen_repository_sample_id, "temp2", quote=F, sep="\t")
 write.table(t4[ t4$AssemblyName == "GCA_000001405.13", ]$biospecimen_repository_sample_id, "temp3", quote=F, sep="\t")
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % wc -l temp[1-3]
     567 temp1
     652 temp2
      83 temp3
    1302 total
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp2 | sed 's/-/@/'  | sed 's/-/    /' |cut -f 1 |sort | uniq  | head 
GTEX@1117F
GTEX@111CU
GTEX@111FC
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % cat temp2 | sed 's/-/@/'  | sed 's/-/    /' |cut -f 1 |sort | uniq  | wc -l   
     652

>  write.table(t4[ t4$AssemblyName == "GRCh38", ]$Experiment, "SraRunTable.652samp.wgs.GRCh38.exper.access", quote=F, sep="\t")
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % vi SraRunTable.652samp.wgs.GRCh38.exper.access

linyong@c4b8 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra$ vdb-config --prefetch-to-cwd
linyong@c4b8 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra$ prefetch --ngc /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/prj_6177_D12900.ngc  --max-size u SAMN04595635

2025-10-08T19:10:19 prefetch.3.0.7: Current preference is set to retrieve SRA Normalized Format files with full base quality scores.
2025-10-08T19:10:19 prefetch.3.0.7: 1) Downloading 'SRR3481676'...
2025-10-08T19:10:19 prefetch.3.0.7: SRA Normalized Format file is being retrieved, if this is different from your preference, it may be due to current file availability.
2025-10-08T19:10:19 prefetch.3.0.7:  Downloading via HTTPS...
2025-10-08T19:28:41 prefetch.3.0.7:  HTTPS download succeed
2025-10-08T19:28:41 prefetch.3.0.7: 1.2) Downloading 'SRR3481676.vdbcache'...
2025-10-08T19:28:41 prefetch.3.0.7:  Downloading via HTTPS...
2025-10-08T19:29:24 prefetch.3.0.7:  HTTPS download succeed
2025-10-08T19:29:31 prefetch.3.0.7:  'SRR3481676.vdbcache' is valid
2025-10-08T19:29:31 prefetch.3.0.7: 1.2) 'SRR3481676.vdbcache' was downloaded successfully
2025-10-08T19:29:31 prefetch.3.0.7:   verifying 'SRR3481676'...
2025-10-08T19:34:13 prefetch.3.0.7:  'SRR3481676' is valid
2025-10-08T19:34:13 prefetch.3.0.7: 1) 'SRR3481676' was downloaded successfully
2025-10-08T19:34:22 prefetch.3.0.7: 'SAMN04595635' has 85 unresolved dependencies
2025-10-08T19:34:22 prefetch.3.0.7: 2) Downloading 'ncbi-acc:GL000191.1?vdb-ctx=refseq'...
2025-10-08T19:34:22 prefetch.3.0.7:  Downloading via HTTPS...
2025-10-08T19:34:22 prefetch.3.0.7:  HTTPS download succeed
2025-10-08T19:34:22 prefetch.3.0.7: 2) 'ncbi-acc:GL000191.1?vdb-ctx=refseq' was downloaded successfully
......
2025-10-08T19:34:42 prefetch.3.0.7: 86) Downloading 'ncbi-acc:NC_012920.1?vdb-ctx=refseq'...
2025-10-08T19:34:42 prefetch.3.0.7:  Downloading via HTTPS...
2025-10-08T19:34:42 prefetch.3.0.7:  HTTPS download succeed
2025-10-08T19:34:42 prefetch.3.0.7: 86) 'ncbi-acc:NC_012920.1?vdb-ctx=refseq' was downloaded successfully
2025-10-08T19:34:42 prefetch.3.0.7: 1) Downloading 'SRR3481676.vdbcache'...
2025-10-08T19:34:42 prefetch.3.0.7: 1) 'SRR3481676.vdbcache' was downloaded successfully
linyong@c4b8 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra$ fasterq-dump --ngc /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/prj_6177_D12900.ngc SAMN04595635

spots read      : 432,535,722 read pairs, 151x151bp
reads read      : 865,071,444
reads written   : 865,071,444
-rw-r--r-- 1 linyong systemd-timesync 159G Oct  8 19:07 SAMN04595635_1.fastq
-rw-r--r-- 1 linyong systemd-timesync 159G Oct  8 19:07 SAMN04595635_2.fastq


linyong@fry /lab/solexa_page/linyong/gtex-dna/dir-dna-sra$ vdb-dump --info SRR3481676
2025-10-08T21:15:08 vdb-dump.3.0.7 err: query unauthorized while resolving query within virtual file system module - failed to resolve accession 'SRR3481676' - Access denied - please request permission to access phs000424 / GRU in dbGaP. ( 403 )
acc    : SRR3481676
path   : /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/SRR3481676/SRR3481676.sra
size   : 39,798,410,464
type   : Database
platf  : SRA_PLATFORM_ILLUMINA
SEQ    : 432,535,722
40G x 7 = 280G for tmp files and 280G for output

#########
linyong@c4b5 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra$ ls -lh
-rw-r--r-- 1 linyong systemd-timesync  767 Oct 10 14:13 script-download-fastq-GTEx-control-acc
-rw-r--r-- 1 linyong systemd-timesync 1.1K Oct 10 14:30 slurm-sra-download-fastq-GTEx-control-acc

#########
spots read      : 436,599,073
reads read      : 873,198,146
reads written   : 873,198,146
Oct 10 14:57 40G     .
Oct 10 18:07 361G    . two fq files
Oct 11 12:29 705G    . sam alignment file

GTEX-1122O-0004-SM-6WBTE chr2 32.0554 chr8 32.1101 chrX 31.5644 chrY 2.34224  C3 chr19 37.4325 C4A chr6 14.915 C4B chr6 18.9709

SAMN04595896, Downloading 'SRR3478746', GTEX-1122O-0004-SM-6WBTE
downloaded data
mao GTEX-1122O-0004-SM-6WBTE chr5 41.4977 chr12 41.5534 chrX 40.0482 chrY 4.08164 C3 chr19 49.1235 C4A chr6 17.3353 C4B chr6 23.1135
CYP21A2 59.2948 TNFSF14 50.7238 GPR108 48.959 C4A-C4B   18.5905
linyong@c1b8 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04595896$ samtools index SAMN04595896.sorted.bam &
[1] 741433

Thyroid.574samp.dnaseq.429inSRA.
-rw-r--r--  1 linyongmao  staff   5.4K Oct 13 14:26 Thyroid.574samp.dnaseq.429inSRA.BioSample.txt
     429 Thyroid.574samp.dnaseq.429inSRA.BioSample.txt
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % head Thyroid.574samp.dnaseq.429inSRA.BioSample.txt
SAMN04596666
SAMN04596530
SAMN04596771
SAMN04598707
SAMN04598120
SAMN04598744

 cat ~/Thyroid.574samp.dnaseq.429inSRA.BioSample.txt | head -10 | while read ll
do
 echo "bash script-download-fastq-GTEx-control-acc  $ll"
done

#########
linyong@c4b8 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04596666$ grep geneIntv  /lab/page_human_data/linyong2/gtex-dna-oct102023/GTEX-14PJM-0003-SM-7DLG8.gene.exon.depth  | cut -f 5-7 | sed 's/    /:/' | sed 's/  /-/' | while read ll
> do
> samtools coverage -r "$ll" -q 0  SAMN04596666.sorted.bam
> done

# chromosome-wide meandepth
samtools coverage  -q 0  SAMN04596666.sorted.bam
chr5    38.4444
chr7    38.7678
(38.4444 + 38.7678) / 2 = 38.6061

#########

linyong@c4b3 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04596666$ cat /lab/solexa_page/linyong/gtex-dna-aug2024/script-bam-c4a-depth 
samtools coverage -r "$R" -q 20 C4A     C4B     CYP21A1P        CYP21A2 
-q 0 CYP21A1P-q0        CYP21A2-q0
linyong@fry /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04596666$ bash /lab/solexa_page/linyong/gtex-dna-aug2024/script-bam-c4a-depth SAMN04596666.sorted.bam > temp-c4a-q20
linyong@fry /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04596666$ bash script-cnv-02-fq-downloaded > temp-c4a-q20-1line
> t1 <- read.delim("temp-c4a-q20-1line", header=F)
 t1$c4a <- t1$V9 / dep
 t1$c4b <- t1$V19 / dep
 t1$CYP21A1P <- t1$V29 / dep * 2
 t1$CYP21A2 <- t1$V39 / dep * 2
 t1$cyp21.tot <- (t1$V49 + t1$V59) / dep *2
 t1$c4a.cn <- t1$c4a  *  20.0916  + 0.2 
 t1$c4b.cn <- t1$c4b    *  19.2208  + 0.2 
 t1$cyp1.cn <- t1$CYP21A1P * 1.23306
 t1$cyp2.cn <- t1$CYP21A2  * 1.08333
 t1[, 66:70]
linyong@fry /lab/solexa_page/linyong/gtex-dna-aug2024$ bash script-cnv-02 > temp.txt
linyongmao@Linyong-Mao-MBP16-2019 dir-GTExV8 % mv -i temp.txt gtex-dna-c4a-c4b.gene.depth.samtools.q20.txt

linyong@c2b15 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04595896$ bash /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04596666/script-bam-C4A-start-exon9-q0 > temp-start-exon9.q0
linyongmao@Linyong-Mao-MBP16-2019 Whitehead-main % grep  start-exon#9 *
linyong@c2b15 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04595896$ vi /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04596666/scr1
linyong@c2b15 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04595896$ bash /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04596666/scr1 > temp-start-exon9.q0-1line
> t8 <- read.delim("temp-start-exon9.q0-1line")
 t8$seq.dep <- dep
 t8[,46:47]

linyong@c1b8 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04596666$ bash /lab/solexa_page/linyong/gtex-dna/script-cram-genecount-03-download-fq SAMN04596666.sorted.bam > temp-chr-dep &
-q 0 c2, c3, actb
-q 0 chr1, chr2, chr3,..

script-cnv-01

#######################################
linyong@c4b8 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04597091$ cat /lab/solexa_page/linyong/gtex-dna-aug2024/script-bam-c4a-depth 
#
if [ $# -lt 1 ]
then
  echo $0 "	bam-file"
  echo $#
  exit 1
fi

cram="$1"
f=`echo "$cram" | sed 's/.bam$//' `
# samtools index "$cram"
ls -lh "$f".bam*

prev="header	geneID	geneName	header	"
echo -n "$prev"
samtools coverage -r chr1:1-1000 -q 0   "$cram" | head -1

for g in `echo C4A C4B `
do
   ll=`cat /lab/solexa_page/linyong/gencode.v42.primary_assembly.annotation.gtf | grep "	gene	.*	.*	.*	.* gene_name \"$g\";" | head -1`
  t1=`echo "$ll" |  awk 'BEGIN {FS = "\t";} {print NF}' `

  if [ "$t1" -gt 8 ]
  then
     geneid=`echo "$ll" | cut -f 9 | awk 'BEGIN {FS=";"} {print $1}' | sed 's/gene_id "//' | sed 's/"//' `
     prev="$f	$geneid	$g	geneIntv	"
     R=`echo "$ll" | awk 'BEGIN {FS="\t"} {print  $1 ":" $4 "-" $5 }' `
     echo -n "$prev"
     samtools coverage -r "$R" -q 20 -H "$cram" 

  fi 
done

echo -n "$f	geneid	CYP21A1P-q20	geneIntv	"
samtools coverage -r chr6:32005636-32008909 -q 20 -H   "$cram"
echo -n "$f	geneid	CYP21A2-q20	geneIntv	"
samtools coverage -r chr6:32038415-32041644 -q 20 -H   "$cram"

echo -n "$f	geneid	CYP21A1P-q0	geneIntv	"
samtools coverage -r chr6:32005636-32008909 -q 0 -H   "$cram"
echo -n "$f	geneid	CYP21A2-q0	geneIntv	"
samtools coverage -r chr6:32038415-32041644 -q 0 -H   "$cram"

# rm "$f".bam.bai
linyong@c4b8 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04597091$ 
######
linyong@c4b8 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04597091$ cat /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04596666/script-cnv-02-fq-downloaded
#

ll="temp-c4a-q20"
s=`echo "$ll" | sed 's/.*\///' | sed 's/.c4a.q20.depth//' `
 c4a=`cat "$ll" | grep "	C4A	" | grep -w geneIntv |head -1 | cut -f 5-20`
 c4b=`cat "$ll" | grep "	C4B	" | grep -w geneIntv |head -1 | cut -f 5-20`
 cyp1q20=`cat "$ll" | grep "	CYP21A1P-q20	" | grep -w geneIntv |head -1 | cut -f 5-20`
 cyp2q20=`cat "$ll" | grep "	CYP21A2-q20	" | grep -w geneIntv |head -1 | cut -f 5-20`
 cyp1q0=`cat "$ll" | grep "	CYP21A1P-q0	" | grep -w geneIntv |head -1 | cut -f 5-20`
 cyp2q0=`cat "$ll" | grep "	CYP21A2-q0	" | grep -w geneIntv |head -1 | cut -f 5-20`

 echo "$s	C4A	$c4a	C4B	$c4b	cyp1.q20	$cyp1q20	cyp2.q20	$cyp2q20	cyp1.q0	$cyp1q0	cyp2.q0	$cyp2q0"


linyong@c4b8 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04597091$ 
#########
linyong@c4b8 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04597091$ cat /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04596666/script-bam-C4A-start-exon9-q0 
#

file="GTEX-11DXX-0004-SM-6WBT9.bam"

ls *.sorted.bam | head -60000 | while read file
do
 
# samtools index "$file"

echo -n "file	gene	region	"
samtools coverage -r chr6:29982057-30982057 -q 0   "$file" | head -1

## c4a upstream -2mbp - -1mbp
echo -n "$file	C4A	upstream-2mbp.-1mbp	"
samtools coverage -r chr6:29982057-30982057 -q 0  -H "$file"

## c4a start-exon#9
echo -n "$file	C4A	start-exon#9	"
samtools coverage -r chr6:31982057-31984408 -q 0  -H "$file"

## c4a exon#10-end
echo -n "$file	C4A	exon#10-end	"
samtools coverage -r chr6:31991192-32002681 -q 0   -H "$file"

##c4a start-end
echo -n "$file	C4A	start-end	"
samtools coverage -r chr6:31982057-32002681 -q 0  -H "$file"

## c4b downstream 1mbp-2mbp
echo -n "$file	C4B	downstream+1mbp-2mbp	"
samtools coverage -r chr6:33035418-34035418 -q 0  -H "$file"

## c4b start-exon#9
echo -n "$file	C4B	start-exon#9	"
samtools coverage -r chr6:32014795-32017146 -q 0  -H "$file"

## c4b exon#10-end
echo -n "$file	C4B	exon#10-end	"
samtools coverage -r chr6:32023930-32035418 -q 0  -H "$file"

##c4b  start-end
echo -n "$file	C4B	start-end	"
samtools coverage -r chr6:32014795-32035418  -q 0  -H "$file"

done
linyong@c4b8 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04597091$ cat /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04596666/scr1
#
#
#file	gene	region	#rname	startpos	endpos	numreads	covbases	coverage	meandepth	meanbaseq	meanmapq
#SAMN04596666.sorted.bam	C4A	upstream-2mbp.-1mbp	chr6	29982057	30982057	307136	999881	99.988	45.3586	37.7	59.1
#SAMN04596666.sorted.bam	C4A	start-exon#9	chr6	31982057	31984408	1015	2352	100	60.6641	37.8	0

t1=`head -1 temp-start-exon9.q0 | cut -f 2-12`
echo "file	$t1	$t1	$t1	$t1"

ll="SAMN04598707.sorted.bam"
t1=`echo "$ll" | sed 's/.bam//' `
  t2=`grep -w "$ll" temp-start-exon9.q0 | grep -w "C4A	start-exon#9" | head -1 | cut -f 2-12`
  t3=`grep -w "$ll" temp-start-exon9.q0 | grep -w "C4A	exon#10-end" | head -1 | cut -f 2-12`
  t4=`grep -w "$ll" temp-start-exon9.q0 | grep -w "C4B	start-exon#9" | head -1 | cut -f 2-12`
  t5=`grep -w "$ll" temp-start-exon9.q0 | grep -w "C4B	exon#10-end" | head -1 | cut -f 2-12`
  echo "$t1	$t2	$t3	$t4	$t5"





linyong@c4b8 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04597091$ cat /lab/solexa_page/linyong/gtex-dna/script-cram-genecount-03-download-fq
#
if [ $# -lt 1 ]
then
  echo $0 "	bam-file"
  echo $#
  exit 1
fi

cram="$1"
f=`echo "$cram" | sed 's/.bam$//' `
# samtools index "$cram"
ls -lh "$f".bam*

prev="header	geneID	geneName	header	"
echo -n "$prev"
samtools coverage -r chr1:1-1000 -q 0   "$cram" | head -1

for g in `echo C2  C3 ACTB`
do
  ll=`cat /lab/solexa_page/linyong/gencode.v42.primary_assembly.noPar.protein.xist.exons.gtf | grep "	gene	.*	.*	.*	.* gene_name \"$g\";" | head -1`
  t1=`echo "$ll" |  awk 'BEGIN {FS = "\t";} {print NF}' `

  if [ "$t1" -gt 8 ]
  then
     geneid=`echo "$ll" | cut -f 9 | awk 'BEGIN {FS=";"} {print $1}' | sed 's/gene_id "//' | sed 's/"//' `
     prev="$f	$geneid	$g	geneIntv	"
     R=`echo "$ll" | awk 'BEGIN {FS="\t"} {print  $1 ":" $4 "-" $5 }' `
     echo -n "$prev"
     samtools coverage -r "$R" -q 0 -H "$cram" 
  fi 
done


samtools coverage -q 0 -H "$cram" | while read t2
do
   prev="$f	geneID	geneName	chrom	"
   echo -n "$prev"
   echo "$t2"
done

linyong@c4b8 /lab/solexa_page/linyong/gtex-dna/dir-dna-sra/dir-SAMN04597091$ 

#######################################
> for( index in 1:dim(file)[1]) {
 t1 <- read.delim("dir-gtex-website-data/sample-tissue.2colum", header=F)
 tissue = file[index,1]
 t2 <- t1[ t1$V2 == tissue, ]


#############################################################
> t1 <- read.delim("../autism/mouse-mg-rnaseq-Thion.txt")
                    geneID name SRR6366221 SRR6366222 SRR6366223 SRR6366226 SRR6366227 SRR6366228 SRR6366231 SRR6366232 SRR6366236 SRR6366237
1601 ENSMUSG00000015451.17  C4a         24          9         14         12         15         22         34         38         29         58
20211 ENSMUSG00000073418.5  C4b         39         38         43         49         35         42         80        111        243        142


######################################
> summary(c4.cn$c4a.cn)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
 0.1754  1.5679  2.0000  2.0016  2.4224  5.0299
> summary(c4.cn$c4b.cn)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
 0.2493  1.6553  2.0000  2.0111  2.3456  4.5997
#  > summary(t2)
#     t.SAMPID            t.SMRIN         t.SMTSISCH
#   Length:19745       Min.   : 3.100   Min.   :-1287
#   Class :character   1st Qu.: 6.500   1st Qu.:  234
#   Mode  :character   Median : 7.200   Median :  530
#                      Mean   : 7.272   Mean   :  579
#                      3rd Qu.: 7.900   3rd Qu.:  870
#                      Max.   :10.000   Max.   : 2076
